<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"www.liuvv.com",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1,dimmer:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.json"}</script><meta name="description" content="1. TCPTCP 是面向连接的、可靠的、基于字节流的传输层通信协议。  面向连接：一定是「一对一」才能连接，不能像 UDP 协议可以一个主机同时向多个主机发送消息，也就是一对多是无法做到的；  可靠的：无论的网络链路中出现了怎样的链路变化，TCP 都可以保证一个报文一定能够到达接收端；  字节流：用户消息通过 TCP 协议传输时，消息可能会被操作系统「分组」成多个的 TCP 报文，如果接收方的程"><meta property="og:type" content="article"><meta property="og:title" content="tcp原理和三次握手四次挥手"><meta property="og:url" content="https://www.liuvv.com/p/289c4599.html"><meta property="og:site_name" content="Levon&#39;s Blog"><meta property="og:description" content="1. TCPTCP 是面向连接的、可靠的、基于字节流的传输层通信协议。  面向连接：一定是「一对一」才能连接，不能像 UDP 协议可以一个主机同时向多个主机发送消息，也就是一对多是无法做到的；  可靠的：无论的网络链路中出现了怎样的链路变化，TCP 都可以保证一个报文一定能够到达接收端；  字节流：用户消息通过 TCP 协议传输时，消息可能会被操作系统「分组」成多个的 TCP 报文，如果接收方的程"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.liuvv.com/p/289c4599/4.png"><meta property="og:image" content="https://www.liuvv.com/p/289c4599/format,png-20230309230433082.png"><meta property="og:image" content="https://www.liuvv.com/p/289c4599/12-TCP%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B-20230906163252432.png"><meta property="og:image" content="https://www.liuvv.com/p/289c4599/13-UDP%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B-20230906163308157.png"><meta property="og:image" content="https://www.liuvv.com/p/289c4599/2.png"><meta property="og:image" content="https://www.liuvv.com/p/289c4599/3.png"><meta property="article:published_time" content="2021-06-07T00:00:01.000Z"><meta property="article:modified_time" content="2024-05-29T12:59:20.090Z"><meta property="article:author" content="levon"><meta property="article:tag" content="tcp"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.liuvv.com/p/289c4599/4.png"><link rel="canonical" href="https://www.liuvv.com/p/289c4599.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>tcp原理和三次握手四次挥手 | Levon's Blog</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?521e5dbc31dd12bb9431823008da3dfc";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Levon's Blog</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">微信: L6241425</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>日志</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><a href="https://github.com/unix2dos" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.liuvv.com/p/289c4599.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="levon"><meta itemprop="description" content="Keep it simple, stupid."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Levon's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">tcp原理和三次握手四次挥手</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-06-07 00:00:01" itemprop="dateCreated datePublished" datetime="2021-06-07T00:00:01+00:00">2021-06-07</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-05-29 12:59:20" itemprop="dateModified" datetime="2024-05-29T12:59:20+00:00">2024-05-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/3-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">3-计算机系统</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/3-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a> </span></span><span id="/p/289c4599.html" class="post-meta-item leancloud_visitors" data-flag-title="tcp原理和三次握手四次挥手" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/p/289c4599.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/p/289c4599.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>4.6k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="1-TCP"><a href="#1-TCP" class="headerlink" title="1. TCP"></a>1. TCP</h1><p>TCP 是面向连接的、可靠的、基于字节流的传输层通信协议。</p><ul><li><p><strong>面向连接</strong>：一定是「一对一」才能连接，不能像 UDP 协议可以一个主机同时向多个主机发送消息，也就是一对多是无法做到的；</p></li><li><p><strong>可靠的</strong>：无论的网络链路中出现了怎样的链路变化，TCP 都可以保证一个报文一定能够到达接收端；</p></li><li><p><strong>字节流</strong>：用户消息通过 TCP 协议传输时，消息可能会被操作系统「分组」成多个的 TCP 报文，如果接收方的程序如果不知道「消息的边界」，是无法读出一个有效的用户消息的。</p><p>并且 TCP 报文是「有序的」，当「前一个」TCP 报文没有收到的时候，即使它先收到了后面的 TCP 报文，那么也不能扔给应用层去处理，同时对「重复」的 TCP 报文会自动丢弃。</p></li></ul><h3 id="1-1-TCP-头部字段"><a href="#1-1-TCP-头部字段" class="headerlink" title="1.1 TCP 头部字段"></a>1.1 TCP 头部字段</h3><p><img src="/p/289c4599/4.png" alt="1"></p><p><strong>1. 头部格式</strong></p><p>20字节固定 + 最大40字节扩展</p><p><strong>2. 固定20字节详情</strong></p><ul><li>源端口 2字节, 目的端口 2字节</li><li>序号 4字节 , 我发送的是以 n 开始的序号</li><li>确认号 4字节, 之前的都已经接收,下次希望给我传递 n, ACK位置必须&#x3D;1</li><li>数据偏移(说明头部字节是20还是到60) + 保留 + URG(紧急指针有效) + ACK + PSH(推送,尽快交给应用层) + RST(复位,重新建立连接) + SYN(tcp建立标志) + FIN(tcp释放标志) 一共2字节, 窗口2字节, 我的接收窗口大小 (例如rwnd&#x3D;20)</li><li>检验和2字节(检错算法), 紧急指针2字节(帮忙取出紧急数据)</li></ul><p><strong>3. 最大40字节扩展字段</strong></p><span id="more"></span><h3 id="1-2-TCP-连接"><a href="#1-2-TCP-连接" class="headerlink" title="1.2 TCP 连接"></a>1.2 TCP 连接</h3><blockquote><p>Connections: The reliability and flow control mechanisms described above require that TCPs initialize and maintain certain status information for each data stream. The combination of this information, including sockets, sequence numbers, and window sizes, is called a connection.</p></blockquote><p>用于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括 Socket、序列号和窗口大小称为连接。</p><p>所以我们可以知道，建立一个 TCP 连接是需要客户端与服务端达成上述三个信息的共识。</p><ul><li>Socket：由 IP 地址和端口号组成</li><li>序列号：用来解决乱序问题等</li><li>窗口大小：用来做流量控制</li></ul><h3 id="1-3-唯一确定一个-TCP-连接"><a href="#1-3-唯一确定一个-TCP-连接" class="headerlink" title="1.3 唯一确定一个 TCP 连接"></a>1.3 唯一确定一个 TCP 连接</h3><img src="/p/289c4599/format,png-20230309230433082.png" alt="TCP 四元组" style="zoom:50%"><p>TCP 四元组可以唯一的确定一个连接，服务端理论上可以接受多少链接呢？</p><p>服务端通常固定在某个本地端口上监听，等待客户端的连接请求。对 IPv4，客户端的 IP 数最多为 2 的 32 次方，客户端的端口数最多为 2 的 16 次方，也就是服务端单机最大 TCP 连接数，约为 2 的 48 次方。</p><p>当然，服务端最大并发 TCP 连接数远不能达到理论上限，会受以下因素影响：</p><ul><li><p>文件描述符限制</p><p>每个 TCP 连接都是一个文件，如果文件描述符被占满了，会发生 Too many open files。Linux 对可打开的文件描述符的数量分别作了三个方面的限制：</p><ul><li>系统级：当前系统可打开的最大数量，通过 <code>cat /proc/sys/fs/file-max</code> 查看； &#x2F;&#x2F; 9223372036854775807</li><li>用户级：指定用户可打开的最大数量，通过 <code>cat /etc/security/limits.conf</code> 查看；&#x2F;&#x2F; 100000</li><li>进程级：单个进程可打开的最大数量，通过 <code>cat /proc/sys/fs/nr_open</code> 查看； &#x2F;&#x2F; 1048576</li></ul></li><li><p>内存限制，每个 TCP 连接都要占用一定内存，操作系统的内存是有限的，如果内存资源被占满后，会发生 OOM。</p></li></ul><h1 id="2-TCP-和-UDP"><a href="#2-TCP-和-UDP" class="headerlink" title="2. TCP 和 UDP"></a>2. TCP 和 UDP</h1><h3 id="2-1-区别"><a href="#2-1-区别" class="headerlink" title="2.1 区别"></a>2.1 区别</h3><table><thead><tr><th></th><th>UDP</th><th>TCP</th></tr></thead><tbody><tr><td>数据传输</td><td>数据传输</td><td>3报文握手+数据传输+4报文挥手</td></tr><tr><td>连接方式</td><td>单播(一对一), 多播(一对多), 广播 (一对全)</td><td>单播(一对一)</td></tr><tr><td>应用报文</td><td>每个报文添加个UDP首部</td><td>一系列字节流放到缓存中, 通过滑动窗口策略发送<br>发送方加个 TCP 头部<br>接收方取出字节流,组合送给接收方进程</td></tr><tr><td>首部</td><td>8字节</td><td>最小20字节, 最大60字节</td></tr></tbody></table><p><em>1. 连接</em></p><ul><li>TCP 是面向连接的传输层协议，传输数据前先要建立连接。</li><li>UDP 是不需要连接，即刻传输数据。</li></ul><p><em>2. 服务对象</em></p><ul><li>TCP 是一对一的两点服务，即一条连接只有两个端点。</li><li>UDP 支持一对一、一对多、多对多的交互通信</li></ul><p><em>3. 可靠性</em></p><ul><li>TCP 是可靠交付数据的，数据可以无差错、不丢失、不重复、按序到达。</li><li>UDP 是尽最大努力交付，不保证可靠交付数据。但是我们可以基于 UDP 传输协议实现一个可靠的传输协议，比如 QUIC 协议</li></ul><p><em>4. 拥塞控制、流量控制</em></p><ul><li>TCP 有拥塞控制和流量控制机制，保证数据传输的安全性。</li><li>UDP 则没有，即使网络非常拥堵了，也不会影响 UDP 的发送速率。</li></ul><p><em>5. 首部开销</em></p><ul><li>TCP 首部长度较长，会有一定的开销，首部在没有使用「选项」字段时是 <code>20</code> 个字节，如果使用了「选项」字段则会变长的。</li><li>UDP 首部只有 8 个字节，并且是固定不变的，开销较小。</li></ul><p><em>6. 传输方式</em></p><ul><li>TCP 是流式传输，没有边界，但保证顺序和可靠。</li><li>UDP 是一个包一个包的发送，是有边界的，但可能会丢包和乱序。</li></ul><p><em>7. 分片不同</em></p><ul><li>TCP 的数据大小如果大于 MSS 大小，则会在传输层进行分片，目标主机收到后，也同样在传输层组装 TCP 数据包，如果中途丢失了一个分片，只需要传输丢失的这个分片。</li><li>UDP 的数据大小如果大于 MTU 大小，则会在 IP 层进行分片，目标主机收到后，在 IP 层组装完数据，接着再传给传输层。</li></ul><h3 id="2-2-Socket-模型"><a href="#2-2-Socket-模型" class="headerlink" title="2.2  Socket 模型"></a>2.2 Socket 模型</h3><ul><li>TCP</li></ul><img src="/p/289c4599/12-TCP编程模型-20230906163252432.png" alt="img" style="zoom:50%"><ul><li>UDP</li></ul><img src="/p/289c4599/13-UDP编程模型-20230906163308157.png" alt="img" style="zoom:50%"><h1 id="3-连接"><a href="#3-连接" class="headerlink" title="3. 连接"></a>3. 连接</h1><h3 id="3-1-建立连接"><a href="#3-1-建立连接" class="headerlink" title="3.1 建立连接"></a>3.1 建立连接</h3><p><img src="/p/289c4599/2.png" alt="1"></p><table><thead><tr><th>客户端</th><th>服务器</th></tr></thead><tbody><tr><td>首先处于 closed 状态</td><td>首先处于 closed 状态</td></tr><tr><td></td><td>listen 监听</td></tr><tr><td>1️⃣ 发送握手①SYN&#x3D;1 seq&#x3D;x <strong>进入SYN-SENT(同步已发送状态)</strong></td><td></td></tr><tr><td></td><td>2️⃣ 发送握手② SYN&#x3D;1 ACK&#x3D;1 seq&#x3D;y ack&#x3D;x+1 进入<strong>SYN-REVD (同步已接收状态)</strong></td></tr><tr><td>3️⃣ 发送握手③ACK&#x3D;1 seq&#x3D;x+1 ack&#x3D;y+1 进入 <strong>ESTABLISHED(连接已建立状态)</strong></td><td></td></tr><tr><td></td><td><strong>进入ESTABLISHED(连接已建立状态)</strong></td></tr><tr><td>开始数据传输</td><td>开始数据传输</td></tr></tbody></table><h3 id="3-2-释放连接"><a href="#3-2-释放连接" class="headerlink" title="3.2 释放连接"></a>3.2 释放连接</h3><p><img src="/p/289c4599/3.png" alt="1"></p><table><thead><tr><th>客户端</th><th>服务器</th></tr></thead><tbody><tr><td>双方建立连接状态</td><td>双方建立连接状态</td></tr><tr><td></td><td></td></tr><tr><td>1️⃣ 发送挥手① FIN&#x3D;1 ACK&#x3D;1 seq&#x3D;u ack&#x3D;v 进入 <strong>FIN_WAIT_1</strong>(终止等待1状态)</td><td></td></tr><tr><td></td><td>2️⃣ 发送挥手② ACK&#x3D;1 seq&#x3D;v ack&#x3D;u+1 并进入<strong>CLOSE_WAIT</strong>(关闭等待状态)</td></tr><tr><td>收到挥手②进入 <strong>FIN_WAIT_2</strong>(终止等待2状态)</td><td>通知应用进程断开连接，客户端到服务器方向连接关闭，属于半关闭状态。</td></tr><tr><td>接受数据</td><td>发送未发完的数据</td></tr><tr><td></td><td>3️⃣ 发送挥手③ FIN&#x3D;1 ACK&#x3D;1 seq&#x3D;w ack&#x3D;u+1 进入 <strong>LAST-ACK</strong>(最后确认状态)</td></tr><tr><td>4️⃣ 发送挥手④ ACK&#x3D;1 seq&#x3D;u+1 ack&#x3D;w+1 进入 <strong>TIME_WAIT</strong>(时间等待状态)</td><td></td></tr><tr><td></td><td>收到挥手④后进入 <strong>CLOSED</strong>(关闭状态)</td></tr><tr><td>经过2MSL后, 进入 <strong>CLOSED</strong>(关闭状态)</td><td></td></tr></tbody></table><h1 id="4-可靠性"><a href="#4-可靠性" class="headerlink" title="4. 可靠性"></a>4. 可靠性</h1><h3 id="4-1-如何保证可靠性"><a href="#4-1-如何保证可靠性" class="headerlink" title="4.1 如何保证可靠性"></a>4.1 如何保证可靠性</h3><ol><li>基于数据块传输：应用数据被分割成 TCP 认为最适合发送的数据块，再传输给网络层，数据块被称为报文段或段。</li><li>对失序数据包重新排序以及去重：TCP 为了保证不发生丢包，就给每个包一个序列号，有了序列号能够将接收到的数据根据序列号排序，并且去掉重复序列号的数据就可以实现数据包去重。</li><li>校验和 : TCP 将保持它首部和数据的检验和。这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP 将丢弃这个报文段和不确认收到此报文段。</li><li>超时重传 : 当发送方发送数据之后，它启动一个定时器，等待目的端确认收到这个报文段。接收端实体对已成功收到的包发回一个相应的确认信息（ACK）。如果发送端实体在合理的往返时延（RTT）内未收到确认消息，那么对应的数据包就被假设为<a href="https://zh.wikipedia.org/wiki/%E4%B8%A2%E5%8C%85">已丢失</a>并进行重传。（重传只针对SYN和SYN+ACK，也就是第一次和第二次握手，ACK 报文是不会重传的）</li><li>流量控制 : TCP 连接的每一方都有固定大小的缓冲空间，TCP 的接收端只允许发送端发送接收端缓冲区能接纳的数据。当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。TCP 使用的流量控制协议是可变大小的滑动窗口协议（TCP 利用滑动窗口实现流量控制）。</li><li>拥塞控制 : 当网络拥塞时，减少数据的发送。</li></ol><h3 id="4-2-为什么不两次握手"><a href="#4-2-为什么不两次握手" class="headerlink" title="4.2 为什么不两次握手"></a>4.2 为什么不两次握手</h3><p>主要是为了避免历史连接。</p><p>假如第一个连接发送失败，重传后过了好久好久，到达了。</p><p>服务器对失败后的连接又建立了一次请求， 但客户端可能处于关闭了都无法理会，服务器就无法释放这个连接。</p><h3 id="4-3-为什么-TIME-WAIT"><a href="#4-3-为什么-TIME-WAIT" class="headerlink" title="4.3 为什么 TIME_WAIT"></a>4.3 为什么 TIME_WAIT</h3><p>参考：<a href="https://www.liuvv.com/p/7b71ec65.html">https://www.liuvv.com/p/7b71ec65.html</a></p><p>因为客户端发送挥手④的时候，有可能失败。</p><p>如果客户端直接关闭，服务器重发挥手③，客户端处于关闭不响应，服务器无法释放资源。</p><h3 id="4-4-保活计时器"><a href="#4-4-保活计时器" class="headerlink" title="4.4 保活计时器"></a>4.4 保活计时器</h3><p>假如建立连接后, 客户端出现了故障</p><ul><li>服务器每次收到请求后， 重新启动定时器(2小时)。</li><li>服务器2小时后没收到客户端请求，发送探测报文段。</li><li>服务器75秒间隔发送一个，达到 9 个无响应，关闭连接。</li></ul><p>也就是说在 Linux 系统中，最少需要经过 2 小时 11 分 15 秒才可以发现一个「死亡」连接。</p><h3 id="4-5-流量控制和拥塞控制"><a href="#4-5-流量控制和拥塞控制" class="headerlink" title="4.5 流量控制和拥塞控制"></a>4.5 流量控制和拥塞控制</h3><p>参考：<a href="https://www.liuvv.com/p/7eb83068.html">https://www.liuvv.com/p/7eb83068.html</a></p><h3 id="4-6-如何避免-SYN-攻击"><a href="#4-6-如何避免-SYN-攻击" class="headerlink" title="4.6 如何避免 SYN 攻击"></a>4.6 如何避免 SYN 攻击</h3><p>服务端每接收到一个 <code>SYN</code> 报文，就进入<code>SYN_RCVD</code> 状态，但服务端发送出去的 <code>ACK + SYN</code> 报文，无法得到未知 IP 主机的 <code>ACK</code> 应答，久而久之就会占满服务端的半连接队列，使得服务端不能为正常用户服务。</p><ol><li><p>调大 netdev_max_backlog</p><p>当网卡接收数据包的速度大于内核处理的速度时，会有一个队列保存这些数据包。控制该队列的最大值如下参数，默认值是 1000，我们要适当调大该参数的值，比如设置为 10000</p></li><li><p>增大 TCP 半连接队列</p></li><li><p>开启 net.ipv4.tcp_syncookies</p><p>开启 syncookies 功能就可以在不使用 SYN 半连接队列的情况下成功建立连接，相当于绕过了 SYN 半连接来建立连接。</p></li><li><p>减少 SYN+ACK 重传次数</p><p>SYN-ACK 报文的最大重传次数由 <code>tcp_synack_retries</code>内核参数决定（默认值是 5 次），比如将 tcp_synack_retries 减少到 2 次：</p></li></ol><h1 id="5-头脑风暴"><a href="#5-头脑风暴" class="headerlink" title="5. 头脑风暴"></a>5. 头脑风暴</h1><ul><li>socket 过程：服务器 bind+listen+for(accept)，客户端 connect，相互 read+write。</li><li>三次握手：SYN+ 序列号，SYN+ACK+ 序列号增加，ACK+ 序列号增加，最后进入 ESTABLISHED。</li><li>四次挥手：客户端 FIN，服务器 ACK 进入 CLOSE_WAIT，服务器继续发消息，服务器 FIN，客户端 ACK 进入 TIME_WAIT。</li><li>TIME_WAIT: 只是主动端特有的状态。如果不等待直接close，万一第四次挥手失败，服务器重发得不到响应，无法释放。</li></ul><h1 id="6-参考资料"><a href="#6-参考资料" class="headerlink" title="6. 参考资料"></a>6. 参考资料</h1><ul><li><a href="https://my.oschina.net/xinxingegeya/blog/485643">https://my.oschina.net/xinxingegeya/blog/485643</a></li><li><a href="https://blog.oldboyedu.com/tcp-wait/">https://blog.oldboyedu.com/tcp-wait/</a></li></ul></div><div class="reward-container"><div>可以加首页作者微信，咨询相关问题！</div><button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'>打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/wechatpay.jpg" alt="levon 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/alipay.jpg" alt="levon 支付宝"><p>支付宝</p></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/tcp/" rel="tag"># tcp</a></div><div class="post-nav"><div class="post-nav-item"><a href="/p/7eb83068.html" rel="prev" title="tcp流量控制和拥塞控制的窗口"><i class="fa fa-chevron-left"></i> tcp流量控制和拥塞控制的窗口</a></div><div class="post-nav-item"><a href="/p/f03714cc.html" rel="next" title="kafka安装和golang实战">kafka安装和golang实战 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-TCP"><span class="nav-text">1. TCP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-TCP-%E5%A4%B4%E9%83%A8%E5%AD%97%E6%AE%B5"><span class="nav-text">1.1 TCP 头部字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-TCP-%E8%BF%9E%E6%8E%A5"><span class="nav-text">1.2 TCP 连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%94%AF%E4%B8%80%E7%A1%AE%E5%AE%9A%E4%B8%80%E4%B8%AA-TCP-%E8%BF%9E%E6%8E%A5"><span class="nav-text">1.3 唯一确定一个 TCP 连接</span></a></li></ol></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#2-TCP-%E5%92%8C-UDP"><span class="nav-text">2. TCP 和 UDP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%8C%BA%E5%88%AB"><span class="nav-text">2.1 区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Socket-%E6%A8%A1%E5%9E%8B"><span class="nav-text">2.2 Socket 模型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E8%BF%9E%E6%8E%A5"><span class="nav-text">3. 连接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="nav-text">3.1 建立连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E9%87%8A%E6%94%BE%E8%BF%9E%E6%8E%A5"><span class="nav-text">3.2 释放连接</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="nav-text">4. 可靠性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="nav-text">4.1 如何保证可靠性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E4%B8%A4%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="nav-text">4.2 为什么不两次握手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E4%B8%BA%E4%BB%80%E4%B9%88-TIME-WAIT"><span class="nav-text">4.3 为什么 TIME_WAIT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E4%BF%9D%E6%B4%BB%E8%AE%A1%E6%97%B6%E5%99%A8"><span class="nav-text">4.4 保活计时器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E5%92%8C%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6"><span class="nav-text">4.5 流量控制和拥塞控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D-SYN-%E6%94%BB%E5%87%BB"><span class="nav-text">4.6 如何避免 SYN 攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E5%A4%B4%E8%84%91%E9%A3%8E%E6%9A%B4"><span class="nav-text">5. 头脑风暴</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">6. 参考资料</span></a></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="levon" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">levon</p><div class="site-description" itemprop="description">Keep it simple, stupid.</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">361</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">77</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">154</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/unix2dos" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;unix2dos" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:levonfly@gmail.com" title="E-Mail → mailto:levonfly@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://coolshell.cn/" title="https:&#x2F;&#x2F;coolshell.cn&#x2F;" rel="noopener" target="_blank">酷壳</a></li><li class="links-of-blogroll-item"><a href="https://catcoding.me/" title="https:&#x2F;&#x2F;catcoding.me&#x2F;" rel="noopener" target="_blank">程序员的喵</a></li><li class="links-of-blogroll-item"><a href="https://www.zsythink.net/" title="https:&#x2F;&#x2F;www.zsythink.net&#x2F;" rel="noopener" target="_blank">朱双印</a></li><li class="links-of-blogroll-item"><a href="https://eurychen.me/" title="https:&#x2F;&#x2F;eurychen.me&#x2F;" rel="noopener" target="_blank">东泽煮粥</a></li><li class="links-of-blogroll-item"><a href="https://luanruisong.com/" title="https:&#x2F;&#x2F;luanruisong.com&#x2F;" rel="noopener" target="_blank">anwu</a></li><li class="links-of-blogroll-item"><a href="https://io-oi.me/" title="https:&#x2F;&#x2F;io-oi.me&#x2F;" rel="noopener" target="_blank">一休儿</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备20000727号 </a><img src="/images/beian.png" style="display:inline-block"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502039978" rel="noopener" target="_blank">京公网安备11010502039978号</a></div><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">levon</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var e,t,o,n,r,a=document.getElementsByTagName("link");if(0<a.length)for(i=0;i<a.length;i++)"canonical"==a[i].rel.toLowerCase()&&a[i].href&&(e=a[i].href);t=e?e.split(":")[0]:window.location.protocol.split(":")[0],e=e||window.location.href,window,n=e,r=document.referrer,/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(n)||(o="https"===String(t).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif",r?(o+="?r="+encodeURIComponent(document.referrer),n&&(o+="&l="+n)):n&&(o+="?l="+n),(new Image).src=o)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}</script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'Y4ry1QHkYxVXKLQBrx6LJXld-gzGzoHsz',
      appKey     : 'TXITOypSvI7JO61NI8EG5exk',
      placeholder: "留下您的小脚丫吧~",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script></body></html>